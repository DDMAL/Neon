!function(e){var t={};function n(r){if(t[r])return t[r].exports;var i=t[r]={i:r,l:!1,exports:{}};return e[r].call(i.exports,i,i.exports,n),i.l=!0,i.exports}n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)n.d(r,i,function(t){return e[t]}.bind(null,i));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=38)}([function(e,t,n){"use strict";var r,i="object"==typeof Reflect?Reflect:null,s=i&&"function"==typeof i.apply?i.apply:function(e,t,n){return Function.prototype.apply.call(e,t,n)};r=i&&"function"==typeof i.ownKeys?i.ownKeys:Object.getOwnPropertySymbols?function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:function(e){return Object.getOwnPropertyNames(e)};var o=Number.isNaN||function(e){return e!=e};function a(){a.init.call(this)}e.exports=a,a.EventEmitter=a,a.prototype._events=void 0,a.prototype._eventsCount=0,a.prototype._maxListeners=void 0;var c=10;function l(e){if("function"!=typeof e)throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof e)}function u(e){return void 0===e._maxListeners?a.defaultMaxListeners:e._maxListeners}function d(e,t,n,r){var i,s,o,a;if(l(n),void 0===(s=e._events)?(s=e._events=Object.create(null),e._eventsCount=0):(void 0!==s.newListener&&(e.emit("newListener",t,n.listener?n.listener:n),s=e._events),o=s[t]),void 0===o)o=s[t]=n,++e._eventsCount;else if("function"==typeof o?o=s[t]=r?[n,o]:[o,n]:r?o.unshift(n):o.push(n),(i=u(e))>0&&o.length>i&&!o.warned){o.warned=!0;var c=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(t)+" listeners added. Use emitter.setMaxListeners() to increase limit");c.name="MaxListenersExceededWarning",c.emitter=e,c.type=t,c.count=o.length,a=c,console&&console.warn&&console.warn(a)}return e}function f(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,0===arguments.length?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function h(e,t,n){var r={fired:!1,wrapFn:void 0,target:e,type:t,listener:n},i=f.bind(r);return i.listener=n,r.wrapFn=i,i}function p(e,t,n){var r=e._events;if(void 0===r)return[];var i=r[t];return void 0===i?[]:"function"==typeof i?n?[i.listener||i]:[i]:n?function(e){for(var t=new Array(e.length),n=0;n<t.length;++n)t[n]=e[n].listener||e[n];return t}(i):g(i,i.length)}function m(e){var t=this._events;if(void 0!==t){var n=t[e];if("function"==typeof n)return 1;if(void 0!==n)return n.length}return 0}function g(e,t){for(var n=new Array(t),r=0;r<t;++r)n[r]=e[r];return n}Object.defineProperty(a,"defaultMaxListeners",{enumerable:!0,get:function(){return c},set:function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+e+".");c=e}}),a.init=function(){void 0!==this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},a.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||o(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this},a.prototype.getMaxListeners=function(){return u(this)},a.prototype.emit=function(e){for(var t=[],n=1;n<arguments.length;n++)t.push(arguments[n]);var r="error"===e,i=this._events;if(void 0!==i)r=r&&void 0===i.error;else if(!r)return!1;if(r){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var c=i[e];if(void 0===c)return!1;if("function"==typeof c)s(c,this,t);else{var l=c.length,u=g(c,l);for(n=0;n<l;++n)s(u[n],this,t)}return!0},a.prototype.addListener=function(e,t){return d(this,e,t,!1)},a.prototype.on=a.prototype.addListener,a.prototype.prependListener=function(e,t){return d(this,e,t,!0)},a.prototype.once=function(e,t){return l(t),this.on(e,h(this,e,t)),this},a.prototype.prependOnceListener=function(e,t){return l(t),this.prependListener(e,h(this,e,t)),this},a.prototype.removeListener=function(e,t){var n,r,i,s,o;if(l(t),void 0===(r=this._events))return this;if(void 0===(n=r[e]))return this;if(n===t||n.listener===t)0==--this._eventsCount?this._events=Object.create(null):(delete r[e],r.removeListener&&this.emit("removeListener",e,n.listener||t));else if("function"!=typeof n){for(i=-1,s=n.length-1;s>=0;s--)if(n[s]===t||n[s].listener===t){o=n[s].listener,i=s;break}if(i<0)return this;0===i?n.shift():function(e,t){for(;t+1<e.length;t++)e[t]=e[t+1];e.pop()}(n,i),1===n.length&&(r[e]=n[0]),void 0!==r.removeListener&&this.emit("removeListener",e,o||t)}return this},a.prototype.off=a.prototype.removeListener,a.prototype.removeAllListeners=function(e){var t,n,r;if(void 0===(n=this._events))return this;if(void 0===n.removeListener)return 0===arguments.length?(this._events=Object.create(null),this._eventsCount=0):void 0!==n[e]&&(0==--this._eventsCount?this._events=Object.create(null):delete n[e]),this;if(0===arguments.length){var i,s=Object.keys(n);for(r=0;r<s.length;++r)"removeListener"!==(i=s[r])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if("function"==typeof(t=n[e]))this.removeListener(e,t);else if(void 0!==t)for(r=t.length-1;r>=0;r--)this.removeListener(e,t[r]);return this},a.prototype.listeners=function(e){return p(this,e,!0)},a.prototype.rawListeners=function(e){return p(this,e,!1)},a.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):m.call(e,t)},a.prototype.listenerCount=m,a.prototype.eventNames=function(){return this._eventsCount>0?r(this._events):[]}},function(e,t){"function"==typeof Object.create?e.exports=function(e,t){t&&(e.super_=t,e.prototype=Object.create(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}))}:e.exports=function(e,t){if(t){e.super_=t;var n=function(){};n.prototype=t.prototype,e.prototype=new n,e.prototype.constructor=e}}},function(e,t,n){"use strict";(function(t){var n,r,i=t.MutationObserver||t.WebKitMutationObserver;if(i){var s=0,o=new i(u),a=t.document.createTextNode("");o.observe(a,{characterData:!0}),n=function(){a.data=s=++s%2}}else if(t.setImmediate||void 0===t.MessageChannel)n="document"in t&&"onreadystatechange"in t.document.createElement("script")?function(){var e=t.document.createElement("script");e.onreadystatechange=function(){u(),e.onreadystatechange=null,e.parentNode.removeChild(e),e=null},t.document.documentElement.appendChild(e)}:function(){setTimeout(u,0)};else{var c=new t.MessageChannel;c.port1.onmessage=u,n=function(){c.port2.postMessage(0)}}var l=[];function u(){var e,t;r=!0;for(var n=l.length;n;){for(t=l,l=[],e=-1;++e<n;)t[e]();n=l.length}r=!1}e.exports=function(e){1!==l.push(e)||r||n()}}).call(this,n(14))},function(e,t){e.exports=d3},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9),i=n(7),s=n(35),o=n(36),a=n(10),c=n(3);function l(){const e=document.getElementsByClassName("sel-by is-active");return 0!==e.length?e[0].id:null}function u(){document.querySelectorAll(".selected").forEach(e=>{e.classList.remove("selected"),e.classList.contains("staff")?(e.removeAttribute("style"),r.unhighlight(e)):(e.removeAttribute("style"),e.style.fill="")}),Array.from(document.getElementsByClassName("text-select")).forEach(e=>{e.style.color="",e.style.fontWeight="",e.classList.remove("text-select")}),Array.from(document.getElementsByClassName("sylTextRect-display")).forEach(e=>{e.style.fill="blue"}),Array.from(document.getElementsByClassName("syllable-highlighted")).forEach(e=>{e.style.fill="",e.classList.add("syllable"),e.classList.remove("syllable-highlighted")}),c.selectAll("#resizeRect").remove(),c.selectAll(".resizePoint").remove(),c.selectAll(".rotatePoint").remove(),document.getElementById("selByStaff").classList.contains("is-active")?a.endOptionsSelection():s.endGroupingSelection(),document.getElementById("extraEdit").innerHTML="",document.getElementById("extraEdit").classList.add("is-invisible"),i.updateHighlight()}function d(e,t){if(e.classList.contains("staff"))return m(e,t);if(!e.classList.contains("selected")&&!e.classList.contains("sylTextRect")&&!e.classList.contains("sylTextRect-display")){let t;if(e.classList.add("selected"),e.style.fill="#d00",e.querySelectorAll(".sylTextRect-display").length&&e.querySelectorAll(".sylTextRect-display").forEach(e=>{e.style.fill="red"}),e.classList.contains("syllable")?t=e.id:null!==e.closest(".syllable")&&(t=e.closest(".syllable").id),void 0!==t){document.querySelectorAll("span."+t).forEach(e=>{e.style.color="#d00",e.style.fontWeight="bold",e.classList.add("text-select")})}}i.updateHighlight()}async function f(e,t){return(await t.getElementAttr(e.id,t.view.getCurrentPageURI())).ligated}function h(e){const t=Array.from(e),n=t.pop().parentElement.parentElement;for(const e of t){if(e.parentElement.parentElement.id!==n.id)return!1}return!0}function p(e,t,n){const r=e,i=r.closest(".syl");if(!i.classList.contains("selected")){i.classList.add("selected"),r.style.fill="#d00";const s=e.closest(".syllable");s.style.fill="red",s.classList.add("syllable-highlighted"),void 0!==n&&o.resize(i,n,t),void 0!==t&&t.dragInit();const a=e.closest(".syllable").id;if(void 0!==a){const e=document.querySelector("span."+a);e&&(e.style.color="#d00",e.style.fontWeight="bold",e.classList.add("text-select"))}}}function m(e,t){e.classList.contains("selected")||(e.classList.add("selected"),r.unhighlight(e),r.highlight(e,"#d00"),t.dragInit())}t.getSelectionType=l,t.unselect=u,t.select=d,t.selectNcs=async function(e,t,n){if(!e.parentElement.classList.contains("selected")){const r=e.parentElement;if(u(),d(r),await f(r,t)){const e=r.previousSibling;if(await f(e,t))d(e);else{const e=r.nextSibling;await f(e,t)?d(e):console.warn("Error: Neither prev or next nc are ligatures")}s.triggerGrouping("ligature")}else r.classList.contains("nc")?a.triggerNcActions(r):console.warn("No action triggered!");n.dragInit()}},t.isLigature=f,t.sharedSecondLevelParent=h,t.getStaffBBox=function(e){let t,n,r,i,s;return e.querySelectorAll("path").forEach(e=>{const o=e.getAttribute("d").match(/\d+/g).map(e=>Number(e));void 0===s&&(s=Math.atan((o[3]-o[1])/(o[2]-o[0]))),(void 0===n||Math.min(o[1],o[3])<n)&&(n=Math.min(o[1],o[3])),(void 0===t||o[0]<t)&&(t=o[0]),(void 0===i||Math.max(o[1],o[3])>i)&&(i=Math.max(o[1],o[3])),(void 0===r||o[2]>r)&&(r=o[2])}),{ulx:t,uly:n,lrx:r,lry:i,rotate:s}},t.selectBBox=p,t.selectNn=function(e){return!(e.length>0)||(e.forEach(e=>{d(e)}),!1)},t.selectStaff=m,t.selectAll=async function(e,t,n){const r=l();if(u(),0===e.length)return;let i,c=!1;switch(r){case"selBySyl":i=".syllable";break;case"selByNeume":i=".neume";break;case"selByNc":i=".nc";break;case"selByStaff":i=".staff";break;case"selByBBox":i=".sylTextRect-display";break;default:return void console.error("Unknown selection type "+r)}const m=new Set;for(const t of e){let e=t.closest(i);if(null===e){if(e=t.closest(".clef, .custos"),null===e){console.warn("Element "+t.id+" is not part of specified group and is not a clef or custos.");continue}c=c||!0}m.add(e);const n=e.getAttribute("mei:follows");n&&m.add(document.getElementById(n.slice(1)));const r=e.getAttribute("mei:precedes");r&&m.add(document.getElementById(r.slice(1)))}m.forEach(e=>{d(e,n)});const g=Array.from(m.values());if(c)1===m.size&&g[0].classList.contains("clef")?a.triggerClefActions(g[0]):1===m.size&&g[0].classList.contains("custos")?a.triggerCustosActions():"selBySyl"==r?a.triggerDefaultSylActions():a.triggerDefaultActions();else switch(r){case"selByStaff":switch(g.length){case 1:a.triggerSplitActions(),o.resize(g[0],t,n);break;default:a.triggerStaffActions()}break;case"selBySyl":switch(g.length){case 1:a.triggerSylActions();break;case 2:if(g[0].getAttribute("mei:follows")==="#"+g[1].id||g[0].getAttribute("mei:precedes")==="#"+g[1].id)s.triggerGrouping("splitSyllable");else if(h(g))s.triggerGrouping("syl");else{const e=g[0].closest(".staff"),t=g[1].closest(".staff"),n=Array.from(e.parentElement.children);if(1===Math.abs(n.indexOf(e)-n.indexOf(t))){const r=n.indexOf(e)<n.indexOf(t)?e:t,i=r.id===e.id?t:e,o=r.querySelector(".layer"),a=i.querySelector(".layer"),c=Array.from(o.children).filter(e=>e.classList.contains("syllable")),l=Array.from(a.children).filter(e=>e.classList.contains("syllable")),u=c[c.length-1],d=l[0];if(u.id===g[0].id&&d.id===g[1].id){s.triggerGrouping("splitSyllable");break}if(u.id===g[1].id&&d.id===g[0].id){s.triggerGrouping("splitSyllable");break}}a.triggerDefaultSylActions()}break;default:h(g)?s.triggerGrouping("syl"):a.triggerDefaultSylActions()}break;case"selByNeume":switch(g.length){case 1:a.triggerNeumeActions();break;default:h(g)?s.triggerGrouping("neume"):a.triggerDefaultActions()}break;case"selByNc":switch(g.length){case 1:a.triggerNcActions(g[0]);break;case 2:if(h(g)){if(g[0].parentElement===g[1].parentElement){const e=Array.from(g[0].parentElement.children);if(1===Math.abs(e.indexOf(g[0])-e.indexOf(g[1]))){let e,n;g[0].children[0].x.baseVal.value<g[1].children[0].x.baseVal.value?(e=g[0].children[0].y.baseVal.value,n=g[1].children[0].y.baseVal.value):(e=g[1].children[0].y.baseVal.value,n=g[0].children[0].y.baseVal.value);const r=await f(g[0],t),i=await f(g[1],t);if(n>e&&r===i){s.triggerGrouping("ligature");break}}}s.triggerGrouping("nc")}else a.triggerDefaultActions();break;default:h(g)?s.triggerGrouping("nc"):a.triggerDefaultActions()}break;case"selByBBox":switch(g.length){case 1:p(g[0],n,t);break;default:g.forEach(e=>p(e,n,void 0))}break;default:console.error("Unknown selection type. This should not have occurred.")}}},function(e,t,n){"use strict";e.exports=function(e){return function(){var t=arguments.length;if(t){for(var n=[],r=-1;++r<t;)n[r]=arguments[r];return e.call(this,n)}return e.call(this,[])}}},function(e,t,n){"use strict";var r=n(15),i=t.ValidationError=function(e,t,n,r,i,s){r&&(this.property=r),e&&(this.message=e),n&&(n.id?this.schema=n.id:this.schema=n),t&&(this.instance=t),this.name=i,this.argument=s,this.stack=this.toString()};i.prototype.toString=function(){return this.property+" "+this.message};var s=t.ValidatorResult=function(e,t,n,r){this.instance=e,this.schema=t,this.propertyPath=r.propertyPath,this.errors=[],this.throwError=n&&n.throwError,this.disableFormat=n&&!0===n.disableFormat};function o(e,t){return t+": "+e.toString()+"\n"}s.prototype.addError=function(e){var t;if("string"==typeof e)t=new i(e,this.instance,this.schema,this.propertyPath);else{if(!e)throw new Error("Missing error detail");if(!e.message)throw new Error("Missing error message");if(!e.name)throw new Error("Missing validator type");t=new i(e.message,this.instance,this.schema,this.propertyPath,e.name,e.argument)}if(this.throwError)throw t;return this.errors.push(t),t},s.prototype.importErrors=function(e){"string"==typeof e||e&&e.validatorType?this.addError(e):e&&e.errors&&Array.prototype.push.apply(this.errors,e.errors)},s.prototype.toString=function(e){return this.errors.map(o).join("")},Object.defineProperty(s.prototype,"valid",{get:function(){return!this.errors.length}});var a=t.SchemaError=function e(t,n){this.message=t,this.schema=n,Error.call(this,t),Error.captureStackTrace(this,e)};a.prototype=Object.create(Error.prototype,{constructor:{value:a,enumerable:!1},name:{value:"SchemaError",enumerable:!1}});var c=t.SchemaContext=function(e,t,n,r,i){this.schema=e,this.options=t,this.propertyPath=n,this.base=r,this.schemas=i};c.prototype.resolve=function(e){return r.resolve(this.base,e)},c.prototype.makeChild=function(e,t){var n=void 0===t?this.propertyPath:this.propertyPath+u(t),i=r.resolve(this.base,e.id||""),s=new c(e,this.options,n,i,Object.create(this.schemas));return e.id&&!s.schemas[i]&&(s.schemas[i]=e),s};var l=t.FORMAT_REGEXPS={"date-time":/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])[tT ](2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])(\.\d+)?([zZ]|[+-]([0-5][0-9]):(60|[0-5][0-9]))$/,date:/^\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])$/,time:/^(2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])$/,email:/^(?:[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+\.)*[\w\!\#\$\%\&\'\*\+\-\/\=\?\^\`\{\|\}\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!\.)){0,61}[a-zA-Z0-9]?\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\[(?:(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\.){3}(?:[01]?\d{1,2}|2[0-4]\d|25[0-5])\]))$/,"ip-address":/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,ipv6:/^\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)(\.(25[0-5]|2[0-4]\d|1\d\d|[1-9]?\d)){3}))|:)))(%.+)?\s*$/,uri:/^[a-zA-Z][a-zA-Z0-9+-.]*:[^\s]*$/,color:/^(#?([0-9A-Fa-f]{3}){1,2}\b|aqua|black|blue|fuchsia|gray|green|lime|maroon|navy|olive|orange|purple|red|silver|teal|white|yellow|(rgb\(\s*\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\b\s*,\s*\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\b\s*,\s*\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\b\s*\))|(rgb\(\s*(\d?\d%|100%)+\s*,\s*(\d?\d%|100%)+\s*,\s*(\d?\d%|100%)+\s*\)))$/,hostname:/^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\.?$/,"host-name":/^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\.?$/,alpha:/^[a-zA-Z]+$/,alphanumeric:/^[a-zA-Z0-9]+$/,"utc-millisec":function(e){return"string"==typeof e&&parseFloat(e)===parseInt(e,10)&&!isNaN(e)},regex:function(e){var t=!0;try{new RegExp(e)}catch(e){t=!1}return t},style:/\s*(.+?):\s*([^;]+);?/,phone:/^\+(?:[0-9] ?){6,14}[0-9]$/};l.regexp=l.regex,l.pattern=l.regex,l.ipv4=l["ip-address"],t.isFormat=function(e,t,n){if("string"==typeof e&&void 0!==l[t]){if(l[t]instanceof RegExp)return l[t].test(e);if("function"==typeof l[t])return l[t](e)}else if(n&&n.customFormats&&"function"==typeof n.customFormats[t])return n.customFormats[t](e);return!0};var u=t.makeSuffix=function(e){return(e=e.toString()).match(/[.\s\[\]]/)||e.match(/^[\d]/)?e.match(/^\d+$/)?"["+e+"]":"["+JSON.stringify(e)+"]":"."+e};function d(e,t,n,r){"object"==typeof n?t[r]=p(e[r],n):-1===e.indexOf(n)&&t.push(n)}function f(e,t,n){t[n]=e[n]}function h(e,t,n,r){"object"==typeof t[r]&&t[r]&&e[r]?n[r]=p(e[r],t[r]):n[r]=t[r]}function p(e,t){var n=Array.isArray(t),r=n&&[]||{};return n?(e=e||[],r=r.concat(e),t.forEach(d.bind(null,e,r))):(e&&"object"==typeof e&&Object.keys(e).forEach(f.bind(null,e,r)),Object.keys(t).forEach(h.bind(null,e,t,r))),r}function m(e){return"/"+encodeURIComponent(e).replace(/~/g,"%7E")}t.deepCompareStrict=function e(t,n){if(typeof t!=typeof n)return!1;if(t instanceof Array)return n instanceof Array&&(t.length===n.length&&t.every((function(r,i){return e(t[i],n[i])})));if("object"==typeof t){if(!t||!n)return t===n;var r=Object.keys(t),i=Object.keys(n);return r.length===i.length&&r.every((function(r){return e(t[r],n[r])}))}return t===n},e.exports.deepMerge=p,t.objectGetPath=function(e,t){for(var n,r=t.split("/").slice(1);"string"==typeof(n=r.shift());){var i=decodeURIComponent(n.replace(/~0/,"~").replace(/~1/g,"/"));if(!(i in e))return;e=e[i]}return e},t.encodePath=function(e){return e.map(m).join("")},t.getDecimalPlaces=function(e){var t=0;if(isNaN(e))return t;"number"!=typeof e&&(e=Number(e));var n=e.toString().split("e");if(2===n.length){if("-"!==n[1][0])return t;t=Number(n[1].slice(1))}var r=n[0].split(".");return 2===r.length&&(t+=r[1].length),t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(9);let i,s;function o(){const e=document.getElementById("highlight-dropdown"),t=document.getElementById("highlight-staff"),n=document.getElementById("highlight-syllable"),i=document.getElementById("highlight-neume"),s=document.getElementById("highlight-none"),o=document.getElementById("highlight-type");document.getElementById("highlight-button").addEventListener("click",c=>{c.stopPropagation(),e.classList.toggle("is-active"),e.classList.contains("is-active")?(document.body.addEventListener("click",a),t.addEventListener("click",()=>{e.classList.remove("is-active"),document.querySelectorAll(".highlight-selected").forEach(e=>{e.classList.remove("highlight-selected")}),t.classList.add("highlight-selected"),o.textContent=" - Staff",r.setGroupingHighlight("staff")}),n.addEventListener("click",()=>{e.classList.remove("is-active"),document.querySelectorAll(".highlight-selected").forEach(e=>{e.classList.remove("highlight-selected")}),n.classList.add("highlight-selected"),o.textContent=" - Syllable",r.setGroupingHighlight("syllable")}),i.addEventListener("click",()=>{e.classList.remove("is-active"),document.querySelectorAll(".highlight-selected").forEach(e=>{e.classList.remove("highlight-selected")}),i.classList.add("highlight-selected"),o.textContent=" - Neume",r.setGroupingHighlight("neume")}),s.addEventListener("click",()=>{e.classList.remove("is-active"),document.querySelectorAll(".highlight-selected").forEach(e=>{e.classList.remove("highlight-selected")}),o.textContent=" - Off",r.unsetGroupingHighlight()})):document.body.removeEventListener("click",a)})}function a(){document.body.removeEventListener("click",a),document.getElementById("highlight-dropdown").classList.remove("is-active")}t.initDisplayControls=function(e,t){!function(e){i=100;const t=document.getElementById("opacitySlider"),n=document.getElementById("opacityOutput");function r(){n.value=t.value,i=Number(t.value),document.querySelector("."+e).style.opacity=(Number(n.value)/100).toString()}t.value="100",document.getElementById("reset-opacity").addEventListener("click",()=>{const r=i<95?i/100:0,s="100"===t.value?r:1;document.querySelectorAll("."+e).forEach(e=>{e.style.opacity=s.toString()}),i=Number(t.value),t.value=String(100*s),n.value=String(Math.round(100*s))}),t.addEventListener("input",r),t.addEventListener("change",r)}(e),function(e){s=100;const t=document.getElementById("bgOpacitySlider"),n=document.getElementById("bgOpacityOutput");function r(){n.value=t.value,s=Number(t.value),document.getElementsByClassName(e)[0].style.opacity=(Number(n.value)/100).toString()}t.value="100",document.getElementById("reset-bg-opacity").addEventListener("click",()=>{const r=s<95?s/100:0,i="100"===t.value?r:1;document.getElementsByClassName(e)[0].style.opacity=i.toString(),s=Number(t.value),t.value=String(100*i),n.value=String(Math.round(100*i))}),t.addEventListener("input",r),t.addEventListener("change",r)}(t),o(),document.getElementById("burgerMenu").addEventListener("click",()=>{document.getElementById("burgerMenu").classList.toggle("is-active"),document.getElementById("navMenu").classList.toggle("is-active")});const n=document.getElementById("displayContents"),r=document.getElementById("toggleDisplay");r.parentElement.addEventListener("click",()=>{"none"===n.style.display?(n.style.display="",r.setAttribute("xlink:href","/Neon/Neon-gh/assets/img/icons.svg#dropdown-down")):(n.style.display="none",r.setAttribute("xlink:href","/Neon/Neon-gh/assets/img/icons.svg#dropdown-side"))})},t.setZoomControls=function(e){if(void 0===e)return;const t=document.getElementById("zoomSlider"),n=document.getElementById("zoomOutput");function r(){n.value=t.value,e.zoomTo(Number(n.value)/100)}t.value="100",document.getElementById("reset-zoom").addEventListener("click",()=>{n.value="100",t.value="100",e.resetZoomAndPan()}),t.addEventListener("input",r),t.addEventListener("change",r),document.body.addEventListener("keydown",r=>{const i=parseInt(n.value);if("+"===r.key){const r=Math.min(i+20,parseInt(t.getAttribute("max")));e.zoomTo(r/100),n.value=String(r),t.value=String(r)}else if("-"===r.key){const r=Math.max(i-20,parseInt(t.getAttribute("min")));e.zoomTo(r/100),n.value=String(Math.round(r)),t.value=String(r)}else"0"===r.key&&(n.value="100",t.value="100",e.resetZoomAndPan())})},t.setOpacityFromSlider=function(e){const t=document.getElementById("opacityOutput");t.value=document.getElementById("opacitySlider").value;try{document.querySelectorAll("."+e).forEach(e=>{e.style.opacity=(Number(t.value)/100).toString()})}catch(e){}},t.setHighlightControls=o,t.setHighlightSelectionControls=function(){const e=document.getElementById("highlight-selection");e.addEventListener("click",()=>{document.getElementById("highlight-dropdown").classList.remove("is-active"),document.querySelectorAll(".highlight-selected").forEach(e=>{e.classList.remove("highlight-selected")}),e.classList.add("highlight-selected"),document.getElementById("highlight-type").textContent=" - Selection",r.setGroupingHighlight("selection")})},t.updateHighlight=function(){let e;try{e=document.querySelector(".highlight-selected").id}catch(t){e=""}switch(e){case"highlight-staff":r.setGroupingHighlight("staff");break;case"highlight-syllable":r.setGroupingHighlight("syllable");break;case"highlight-neume":r.setGroupingHighlight("neume");break;case"highlight-selection":r.setGroupingHighlight("selection");break;default:r.unsetGroupingHighlight()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(13),i=new Array(0);let s=null,o=!1;function a(){if(i.length>0){o=!0;const e=i.pop();!function(e){if(e.isModeMessage){if(null!==s)return window.clearTimeout(s.timeoutID),i.push(e),void c(s.getId());s=e}const t=document.getElementById("notification-content");t.innerHTML+="<div class='neon-notification' id='"+e.getId()+"'>"+e.message+"</div> ",t.style.display="",e.display()}(e),e.setTimeoutId(window.setTimeout(c,5e3,e.getId())),document.getElementById(e.getId()).addEventListener("click",()=>{window.clearTimeout(e.timeoutID),c(e.getId())})}}function c(e){document.getElementById(e).remove(),null!==s&&s.getId()===e&&(s=null),i.length>0?a():0===document.querySelectorAll(".neon-notification").length&&(document.getElementById("notification-content").style.display="none",o=!1)}t.queueNotification=function(e){const t=new l(e);i.push(t),(!o||document.getElementById("notification-content").querySelectorAll(".neon-notification").length<3)&&a()};class l{constructor(e){this.message=e,this.displayed=!1,this.id=r.uuidv4(),this.isModeMessage=-1!==e.search("Mode"),this.timeoutID=-1}setTimeoutId(e){this.timeoutID=Math.max(e,-1)}display(){this.displayed=!0}getId(){return this.id}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=["rgb(230, 159, 0)","rgb(86, 180, 233)","rgb(0, 158, 115)","rgb(240, 228, 66)","rgb(0, 114, 178)","rgb(213, 94, 0)","rgb(204, 121, 167)"];function i(e){let t;t=e?e.querySelectorAll(":not(.selected) .highlighted"):document.querySelectorAll(":not(.selected) .highlighted"),t.forEach(e=>{if("path"!==e.tagName||e.closest(".staff").classList.contains("selected")){e.removeAttribute("fill");let t=e.querySelectorAll(".sylTextRect-display");if(!t.length)try{t=e.closest(".syllable").querySelectorAll(".sylTextRect-display")}catch(e){t=[]}t.forEach((function(e){e.closest(".syllable").classList.contains("selected")||e.closest(".staff").classList.contains("selected")||e.closest(".syl").classList.contains("selected")?e.style.fill="red":e.style.fill="blue",e.classList.remove("highlighted")}))}else e.setAttribute("stroke","#000000");e.classList.remove("highlighted")})}function s(){i()}function o(){s(),Array.from(document.getElementsByClassName("highlighted")).filter(e=>!e.parentElement.classList.contains("selected")).forEach(e=>{e.setAttribute("fill",null);let t=e.querySelectorAll(".sylTextRect-display");t.length||null!==e.closest(".syllable")&&(t=e.closest(".syllable").querySelectorAll("sylTextRect-display")),t.forEach((function(e){e.closest(".syllable").classList.contains("selected")||e.closest(".syl").classList.contains("selected")?e.style.fill="red":e.style.fill="blue",e.classList.remove("highlighted")})),e.classList.remove("highlighted"),e.querySelectorAll("sylTextRect-display").forEach(e=>{e.classList.remove("highlighted")})}),Array.from(document.getElementsByClassName("selected")).forEach(e=>{e.setAttribute("fill","")})}function a(e,t){const n=Array.from(e.children);for(let e=0;e<n.length;e++){const r=n[e];if("path"===r.tagName)r.setAttribute("stroke",t);else{if(r.classList.contains("resizePoint")||"resizeRect"===r.id||r.classList.contains("rotatePoint"))return;if(r.classList.contains("layer"))Array.from(r.children).forEach(e=>{n.push(e)});else if(document.getElementsByClassName("highlight-selected").length&&"highlight-neume"===document.getElementsByClassName("highlight-selected")[0].id&&r.classList.contains("syllable"))Array.from(r.children).filter(e=>e.classList.contains("neume")).forEach(e=>{n.push(e)});else{r.setAttribute("fill",t);let e=r.querySelectorAll(".sylTextRect-display");if(!e.length)try{e=r.closest(".syllable").querySelectorAll(".sylTextRect-display")}catch(t){e=[]}e.forEach((function(e){e.closest(".syllable").classList.contains("selected")||e.closest(".syl").classList.contains("selected")||e.closest(".staff").classList.contains("selected")||(e.style.fill=t,e.classList.add("highlighted"))}))}}r.classList.add("highlighted")}let r;r="30px",e.querySelectorAll(".nc, .custos, .clef").forEach(e=>{e.setAttribute("stroke","black"),e.setAttribute("stroke-width",r)})}function c(){const e=Array.from(document.getElementsByClassName("staff"));for(let t=0;t<e.length;t++){const n=r[t%r.length];a(e[t],n)}}t.unhighlight=i,t.unsetStaffHighlight=s,t.unsetGroupingHighlight=o,t.highlight=a,t.setStaffHighlight=c,t.setGroupingHighlight=function e(t){if(o(),"staff"===t)return void c();if("selection"===t){switch(document.querySelector(".sel-by.is-active").id){case"selBySyl":case"selByBBox":t="syllable";break;case"selByStaff":t="staff";break;default:t="neume"}return void e(t)}const n=document.getElementsByClassName(t);for(let e=0;e<n.length;e++){const t=r[e%r.length];if(null!==n[e].closest(".selected")||n[e].classList.contains("selected"))n[e].classList.contains("selected")?n[e].setAttribute("fill","#d00"):n[e].setAttribute("fill",null),n[e].classList.remove("highlighted");else{n[e].setAttribute("fill",t),n[e].querySelectorAll(".sylTextRect-display").forEach((function(e){e.closest(".syl").classList.contains("selected")||e.closest(".syllable").classList.contains("selected")||e.closest(".staff").classList.contains("selected")||(e.style.fill=t)})),n[e].classList.add("highlighted"),n[e].querySelectorAll(".sylTextRect-display").forEach(e=>{e.classList.add("highlighted")})}}document.querySelectorAll(".nc, .custos, .clef").forEach(e=>{e.setAttribute("stroke","black"),e.setAttribute("stroke-width","30px")})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(17),i=n(35),s=n(8),o=n(62),a=n(4);let c;function l(e){return{action:"set",param:{elementId:e,attrType:"tilt",attrValue:""}}}function u(e){return{action:"set",param:{elementId:e,attrType:"tilt",attrValue:""}}}function d(){const e=[];Array.from(document.getElementsByClassName("selected")).forEach(t=>{e.push({action:"remove",param:{elementId:t.id}})});const t={action:"chain",param:e};h(),c.edit(t,c.view.getCurrentPageURI()).then(()=>{c.updateForCurrentPage()})}function f(){const e=[];Array.from(document.getElementsByClassName("selected")).forEach(t=>{e.push({action:"changeStaff",param:{elementId:t.id}})});const t={action:"chain",param:e};h(),c.edit(t,c.view.getCurrentPageURI()).then(()=>{c.updateForCurrentPage()})}function h(){try{const e=document.getElementById("moreEdit");e.innerHTML="",e.classList.add("is-invisible")}catch(e){}document.body.removeEventListener("keydown",m)}function p(){document.getElementById("drop_select").addEventListener("click",(function(){this.classList.toggle("is-active")}))}function m(e){"d"!==e.key&&"Backspace"!==e.key||(d(),e.preventDefault())}t.initNeonView=function(e){c=e,i.initNeonView(e)},t.unsetInclinatumAction=l,t.unsetVirgaAction=u,t.removeHandler=d,t.changeStaffHandler=f,t.triggerNcActions=function(e){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.custosActionContents}catch(e){}try{const e=document.getElementById("extraEdit");e.classList.remove("is-invisible"),e.innerHTML=r.ncActionContents}catch(e){}document.querySelector("#Punctum.dropdown-item").addEventListener("click",()=>{const t=l(e.id),n=u(e.id);c.edit({action:"chain",param:[t,n]},c.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Shape Changed"):s.queueNotification("Shape Change Failed"),h(),c.updateForCurrentPage()})}),document.querySelector("#Inclinatum.dropdown-item").addEventListener("click",()=>{const t={action:"set",param:{elementId:e.id,attrType:"tilt",attrValue:"se"}};c.edit(t,c.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Shape Changed"):s.queueNotification("Shape Change Failed"),h(),c.updateForCurrentPage()})}),document.querySelector("#Virga.dropdown-item").addEventListener("click",()=>{const t=l(e.id),n={action:"set",param:{elementId:e.id,attrType:"tilt",attrValue:"n"}};c.edit({action:"chain",param:[t,n]},c.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Shape Changed"):s.queueNotification("Shape Change Failed"),h(),c.updateForCurrentPage()})});try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m),p()},t.triggerNeumeActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.custosActionContents}catch(e){}try{const e=document.getElementById("extraEdit");e.classList.remove("is-invisible"),e.innerHTML=r.neumeActionContents}catch(e){}const e=document.querySelectorAll(".selected");if(1===e.length){document.querySelector(".grouping").addEventListener("click",t=>{!function(t){const n={action:"changeGroup",param:{elementId:e[0].id,contour:t}};c.edit(n,c.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Grouping Changed"):s.queueNotification("Grouping Failed"),h(),c.updateForCurrentPage()})}(c.info.getContourByValue(t.target.id))});try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m),p(),i.initGroupingListeners()}else console.warn("More than one neume selected! Cannot trigger Neume ClickSelect actions.")},t.triggerSylActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML="<div><p class='control'><button class='button' id='ungroupNeumes'>Ungroup</button></p></div><div><p class='control'><button class='button' id='delete'>Delete</button></p></div><div><p class='control'><button class='button' id='changeStaff'>Re-associate to nearest staff</button></p></div>",document.getElementById("changeStaff").addEventListener("click",f)}catch(e){}try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m),i.initGroupingListeners()},t.triggerClefActions=function(e){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.custosActionContents}catch(e){}try{const e=document.getElementById("extraEdit");e.classList.remove("is-invisible"),e.innerHTML=r.clefActionContents}catch(e){}document.querySelector("#CClef.dropdown-item").addEventListener("click",()=>{const t={action:"setClef",param:{elementId:e.id,shape:"C"}};c.edit(t,c.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Shape Changed"):s.queueNotification("Shape Change Failed"),h(),c.updateForCurrentPage()})}),document.querySelector("#FClef.dropdown-item").addEventListener("click",()=>{const t={action:"setClef",param:{elementId:e.id,shape:"F"}};c.edit(t,c.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Shape Changed"):s.queueNotification("Shape Change Failed"),h(),c.updateForCurrentPage()})});try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d),document.getElementById("changeStaff").addEventListener("click",f)}catch(e){}document.body.addEventListener("keydown",m),p()},t.triggerCustosActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML+=r.custosActionContents}catch(e){}try{document.getElementById("changeStaff").addEventListener("click",f)}catch(e){}try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d),document.body.addEventListener("keydown",m)}catch(e){}},t.triggerStaffActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.staffActionContents}catch(e){}document.getElementById("merge-systems").addEventListener("click",()=>{const e=document.querySelectorAll(".staff.selected"),t=[];e.forEach(e=>{t.push(e.id)});const n={action:"merge",param:{elementIds:t}};c.edit(n,c.view.getCurrentPageURI()).then(e=>{e?(s.queueNotification("Staff Merged"),h(),c.updateForCurrentPage()):s.queueNotification("Merge Failed")})});try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m)},t.triggerSplitActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.splitActionContents}catch(e){}document.getElementById("split-system").addEventListener("click",()=>{const e=document.querySelector(".staff.selected");if(null!==e){new o.SplitHandler(c,e).startSplit(),h()}else console.error("No staff was selected!"),h()}),document.getElementById("reset-rotate").addEventListener("click",()=>{const e=document.querySelector(".staff.selected"),t=e.querySelector("#resizeRect").getAttribute("points").split(" ");parseInt(t[0].split(",")[1]),parseInt(t[1].split(",")[1]);let n=a.getStaffBBox(e),r=Math.tan(n.rotate)*(n.lrx-n.ulx);if(null!==e){const t={action:"resizeRotate",param:{elementId:e.id,ulx:n.ulx,uly:n.rotate>0?n.uly+r/2:n.uly-r/2,lrx:n.lrx,lry:n.rotate>0?n.lry-r/2:n.lry+r/2,rotate:0}};c.edit(t,c.view.getCurrentPageURI()).then(async e=>{e&&await c.updateForCurrentPage()}),h()}else console.error("No staff was selected"),h()});try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m)},t.triggerDefaultSylActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.defaultSylActionContents}catch(e){}try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m);try{const e=document.getElementById("changeStaff");e.removeEventListener("click",f),e.addEventListener("click",f)}catch(e){}},t.triggerDefaultActions=function(){h();try{const e=document.getElementById("moreEdit");e.classList.remove("is-invisible"),e.innerHTML=r.defaultActionContents}catch(e){}try{const e=document.getElementById("delete");e.removeEventListener("click",d),e.addEventListener("click",d)}catch(e){}document.body.addEventListener("keydown",m)},t.endOptionsSelection=h,t.deleteButtonHandler=m},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(3);t.default=class{constructor(e,t){this.neonView=e,this.selector=t}dragInit(){const e=r.drag().on("start",function(){this.dragStartCoords=[r.event.x,r.event.y],this.dx=0,this.dy=0,r.event.sourceEvent.target.classList.contains("staff")&&r.select(this.selector).call(e)}.bind(this)).on("drag",this.dragging.bind(this)).on("end",this.dragEnded.bind(this)),t=r.selectAll(".selected"),n=Array.from(document.getElementsByClassName("selected"));this.selection=n.concat(Array.from(document.getElementsByClassName("resizePoint"))),this.dragStartCoords=new Array(t.size()),t.call(e)}dragging(){const e=r.event.y-this.dragStartCoords[1],t=r.event.x-this.dragStartCoords[0];this.dx=r.event.x-this.dragStartCoords[0],this.dy=r.event.y-this.dragStartCoords[1],this.selection.forEach(n=>{r.select(n).attr("transform",(function(){return"translate("+[t,e]+")"}))}),0===this.selection.filter(e=>e.classList.contains("syl")).length&&r.selectAll(".syllable.selected").selectAll(".sylTextRect-display").attr("transform",(function(){return"translate("+[-1*t,-1*e]+")"}))}dragEnded(){const e=[];this.selection.filter(e=>!e.classList.contains("resizePoint")).forEach(t=>{const n={action:"drag",param:{elementId:"rect"===t.tagName?t.closest(".syl").id:t.id,x:this.dx,y:-1*this.dy}};e.push(n)});const t={action:"chain",param:e},n=Math.abs(this.dx),r=Math.abs(this.dy);n>5||r>5?this.neonView.edit(t,this.neonView.view.getCurrentPageURI()).then(()=>{this.neonView.updateForCurrentPage(),this.endOptionsSelection(),this.reset(),this.dragInit()}):(this.reset(),this.dragInit())}resetTo(e){this.resetToAction=e}reset(){void 0!==this.resetToAction&&r.select(this.selector).call(this.resetToAction)}endOptionsSelection(){try{document.getElementById("moreEdit").innerHTML="",document.getElementById("moreEdit").classList.add("is-invisible")}catch(e){}}}},function(e,t,n){e.exports=function(e){"use strict";var t=["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"];function n(e,t){var n=e[0],r=e[1],i=e[2],s=e[3];r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&i|~r&s)+t[0]-680876936|0)<<7|n>>>25)+r|0)&r|~n&i)+t[1]-389564586|0)<<12|s>>>20)+n|0)&n|~s&r)+t[2]+606105819|0)<<17|i>>>15)+s|0)&s|~i&n)+t[3]-1044525330|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&i|~r&s)+t[4]-176418897|0)<<7|n>>>25)+r|0)&r|~n&i)+t[5]+1200080426|0)<<12|s>>>20)+n|0)&n|~s&r)+t[6]-1473231341|0)<<17|i>>>15)+s|0)&s|~i&n)+t[7]-45705983|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&i|~r&s)+t[8]+1770035416|0)<<7|n>>>25)+r|0)&r|~n&i)+t[9]-1958414417|0)<<12|s>>>20)+n|0)&n|~s&r)+t[10]-42063|0)<<17|i>>>15)+s|0)&s|~i&n)+t[11]-1990404162|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&i|~r&s)+t[12]+1804603682|0)<<7|n>>>25)+r|0)&r|~n&i)+t[13]-40341101|0)<<12|s>>>20)+n|0)&n|~s&r)+t[14]-1502002290|0)<<17|i>>>15)+s|0)&s|~i&n)+t[15]+1236535329|0)<<22|r>>>10)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&s|i&~s)+t[1]-165796510|0)<<5|n>>>27)+r|0)&i|r&~i)+t[6]-1069501632|0)<<9|s>>>23)+n|0)&r|n&~r)+t[11]+643717713|0)<<14|i>>>18)+s|0)&n|s&~n)+t[0]-373897302|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&s|i&~s)+t[5]-701558691|0)<<5|n>>>27)+r|0)&i|r&~i)+t[10]+38016083|0)<<9|s>>>23)+n|0)&r|n&~r)+t[15]-660478335|0)<<14|i>>>18)+s|0)&n|s&~n)+t[4]-405537848|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&s|i&~s)+t[9]+568446438|0)<<5|n>>>27)+r|0)&i|r&~i)+t[14]-1019803690|0)<<9|s>>>23)+n|0)&r|n&~r)+t[3]-187363961|0)<<14|i>>>18)+s|0)&n|s&~n)+t[8]+1163531501|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r&s|i&~s)+t[13]-1444681467|0)<<5|n>>>27)+r|0)&i|r&~i)+t[2]-51403784|0)<<9|s>>>23)+n|0)&r|n&~r)+t[7]+1735328473|0)<<14|i>>>18)+s|0)&n|s&~n)+t[12]-1926607734|0)<<20|r>>>12)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r^i^s)+t[5]-378558|0)<<4|n>>>28)+r|0)^r^i)+t[8]-2022574463|0)<<11|s>>>21)+n|0)^n^r)+t[11]+1839030562|0)<<16|i>>>16)+s|0)^s^n)+t[14]-35309556|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r^i^s)+t[1]-1530992060|0)<<4|n>>>28)+r|0)^r^i)+t[4]+1272893353|0)<<11|s>>>21)+n|0)^n^r)+t[7]-155497632|0)<<16|i>>>16)+s|0)^s^n)+t[10]-1094730640|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r^i^s)+t[13]+681279174|0)<<4|n>>>28)+r|0)^r^i)+t[0]-358537222|0)<<11|s>>>21)+n|0)^n^r)+t[3]-722521979|0)<<16|i>>>16)+s|0)^s^n)+t[6]+76029189|0)<<23|r>>>9)+i|0,r=((r+=((i=((i+=((s=((s+=((n=((n+=(r^i^s)+t[9]-640364487|0)<<4|n>>>28)+r|0)^r^i)+t[12]-421815835|0)<<11|s>>>21)+n|0)^n^r)+t[15]+530742520|0)<<16|i>>>16)+s|0)^s^n)+t[2]-995338651|0)<<23|r>>>9)+i|0,r=((r+=((s=((s+=(r^((n=((n+=(i^(r|~s))+t[0]-198630844|0)<<6|n>>>26)+r|0)|~i))+t[7]+1126891415|0)<<10|s>>>22)+n|0)^((i=((i+=(n^(s|~r))+t[14]-1416354905|0)<<15|i>>>17)+s|0)|~n))+t[5]-57434055|0)<<21|r>>>11)+i|0,r=((r+=((s=((s+=(r^((n=((n+=(i^(r|~s))+t[12]+1700485571|0)<<6|n>>>26)+r|0)|~i))+t[3]-1894986606|0)<<10|s>>>22)+n|0)^((i=((i+=(n^(s|~r))+t[10]-1051523|0)<<15|i>>>17)+s|0)|~n))+t[1]-2054922799|0)<<21|r>>>11)+i|0,r=((r+=((s=((s+=(r^((n=((n+=(i^(r|~s))+t[8]+1873313359|0)<<6|n>>>26)+r|0)|~i))+t[15]-30611744|0)<<10|s>>>22)+n|0)^((i=((i+=(n^(s|~r))+t[6]-1560198380|0)<<15|i>>>17)+s|0)|~n))+t[13]+1309151649|0)<<21|r>>>11)+i|0,r=((r+=((s=((s+=(r^((n=((n+=(i^(r|~s))+t[4]-145523070|0)<<6|n>>>26)+r|0)|~i))+t[11]-1120210379|0)<<10|s>>>22)+n|0)^((i=((i+=(n^(s|~r))+t[2]+718787259|0)<<15|i>>>17)+s|0)|~n))+t[9]-343485551|0)<<21|r>>>11)+i|0,e[0]=n+e[0]|0,e[1]=r+e[1]|0,e[2]=i+e[2]|0,e[3]=s+e[3]|0}function r(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e.charCodeAt(t)+(e.charCodeAt(t+1)<<8)+(e.charCodeAt(t+2)<<16)+(e.charCodeAt(t+3)<<24);return n}function i(e){var t,n=[];for(t=0;t<64;t+=4)n[t>>2]=e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24);return n}function s(e){var t,i,s,o,a,c,l=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=l;t+=64)n(u,r(e.substring(t-64,t)));for(i=(e=e.substring(t-64)).length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<i;t+=1)s[t>>2]|=e.charCodeAt(t)<<(t%4<<3);if(s[t>>2]|=128<<(t%4<<3),t>55)for(n(u,s),t=0;t<16;t+=1)s[t]=0;return o=(o=8*l).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(o[2],16),c=parseInt(o[1],16)||0,s[14]=a,s[15]=c,n(u,s),u}function o(e){var n,r="";for(n=0;n<4;n+=1)r+=t[e>>8*n+4&15]+t[e>>8*n&15];return r}function a(e){var t;for(t=0;t<e.length;t+=1)e[t]=o(e[t]);return e.join("")}function c(e){return/[\u0080-\uFFFF]/.test(e)&&(e=unescape(encodeURIComponent(e))),e}function l(e){var t,n=[],r=e.length;for(t=0;t<r-1;t+=2)n.push(parseInt(e.substr(t,2),16));return String.fromCharCode.apply(String,n)}function u(){this.reset()}return a(s("hello")),"undefined"==typeof ArrayBuffer||ArrayBuffer.prototype.slice||function(){function t(e,t){return(e=0|e||0)<0?Math.max(e+t,0):Math.min(e,t)}ArrayBuffer.prototype.slice=function(n,r){var i,s,o,a,c=this.byteLength,l=t(n,c),u=c;return r!==e&&(u=t(r,c)),l>u?new ArrayBuffer(0):(i=u-l,s=new ArrayBuffer(i),o=new Uint8Array(s),a=new Uint8Array(this,l,i),o.set(a),s)}}(),u.prototype.append=function(e){return this.appendBinary(c(e)),this},u.prototype.appendBinary=function(e){this._buff+=e,this._length+=e.length;var t,i=this._buff.length;for(t=64;t<=i;t+=64)n(this._hash,r(this._buff.substring(t-64,t)));return this._buff=this._buff.substring(t-64),this},u.prototype.end=function(e){var t,n,r=this._buff,i=r.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)s[t>>2]|=r.charCodeAt(t)<<(t%4<<3);return this._finish(s,i),n=a(this._hash),e&&(n=l(n)),this.reset(),n},u.prototype.reset=function(){return this._buff="",this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},u.prototype.getState=function(){return{buff:this._buff,length:this._length,hash:this._hash}},u.prototype.setState=function(e){return this._buff=e.buff,this._length=e.length,this._hash=e.hash,this},u.prototype.destroy=function(){delete this._hash,delete this._buff,delete this._length},u.prototype._finish=function(e,t){var r,i,s,o=t;if(e[o>>2]|=128<<(o%4<<3),o>55)for(n(this._hash,e),o=0;o<16;o+=1)e[o]=0;r=(r=8*this._length).toString(16).match(/(.*?)(.{0,8})$/),i=parseInt(r[2],16),s=parseInt(r[1],16)||0,e[14]=i,e[15]=s,n(this._hash,e)},u.hash=function(e,t){return u.hashBinary(c(e),t)},u.hashBinary=function(e,t){var n=a(s(e));return t?l(n):n},u.ArrayBuffer=function(){this.reset()},u.ArrayBuffer.prototype.append=function(e){var t,r,s,o,a,c=(r=this._buff.buffer,s=e,o=!0,(a=new Uint8Array(r.byteLength+s.byteLength)).set(new Uint8Array(r)),a.set(new Uint8Array(s),r.byteLength),o?a:a.buffer),l=c.length;for(this._length+=e.byteLength,t=64;t<=l;t+=64)n(this._hash,i(c.subarray(t-64,t)));return this._buff=t-64<l?new Uint8Array(c.buffer.slice(t-64)):new Uint8Array(0),this},u.ArrayBuffer.prototype.end=function(e){var t,n,r=this._buff,i=r.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0];for(t=0;t<i;t+=1)s[t>>2]|=r[t]<<(t%4<<3);return this._finish(s,i),n=a(this._hash),e&&(n=l(n)),this.reset(),n},u.ArrayBuffer.prototype.reset=function(){return this._buff=new Uint8Array(0),this._length=0,this._hash=[1732584193,-271733879,-1732584194,271733878],this},u.ArrayBuffer.prototype.getState=function(){var e,t=u.prototype.getState.call(this);return t.buff=(e=t.buff,String.fromCharCode.apply(null,new Uint8Array(e))),t},u.ArrayBuffer.prototype.setState=function(e){return e.buff=function(e,t){var n,r=e.length,i=new ArrayBuffer(r),s=new Uint8Array(i);for(n=0;n<r;n+=1)s[n]=e.charCodeAt(n);return t?s:i}(e.buff,!0),u.prototype.setState.call(this,e)},u.ArrayBuffer.prototype.destroy=u.prototype.destroy,u.ArrayBuffer.prototype._finish=u.prototype._finish,u.ArrayBuffer.hash=function(e,t){var r=a(function(e){var t,r,s,o,a,c,l=e.length,u=[1732584193,-271733879,-1732584194,271733878];for(t=64;t<=l;t+=64)n(u,i(e.subarray(t-64,t)));for(e=t-64<l?e.subarray(t-64):new Uint8Array(0),r=e.length,s=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],t=0;t<r;t+=1)s[t>>2]|=e[t]<<(t%4<<3);if(s[t>>2]|=128<<(t%4<<3),t>55)for(n(u,s),t=0;t<16;t+=1)s[t]=0;return o=(o=8*l).toString(16).match(/(.*?)(.{0,8})$/),a=parseInt(o[2],16),c=parseInt(o[1],16)||0,s[14]=a,s[15]=c,n(u,s),u}(new Uint8Array(e)));return t?l(r):r},u}()},function(e,t,n){"use strict";function r(e){if(16!==e.length)return"";function t(e,t){return e+t.toString(16).padStart(2,"0")}return e.slice(0,4).reduce(t,"")+"-"+e.slice(4,6).reduce(t,"")+"-"+e.slice(6,8).reduce(t,"")+"-"+e.slice(8,10).reduce(t,"")+"-"+e.slice(10).reduce(t,"")}Object.defineProperty(t,"__esModule",{value:!0}),t.uuidv4=function(){if(void 0===window.crypto)return r(new Uint8Array(16));const e=new Uint8Array(16),t=Uint8Array.from([parseInt("01000000",2),parseInt("10000000",2),parseInt("00001111",2),parseInt("00111111",2)]);return window.crypto.getRandomValues(e),e[6]=e[6]&t[2]|t[0],e[8]=e[8]&t[3]|t[1],r(e)}},function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t,n){"use strict";var r=n(50),i=n(52);function s(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}t.parse=b,t.resolve=function(e,t){return b(e,!1,!0).resolve(t)},t.resolveObject=function(e,t){return e?b(e,!1,!0).resolveObject(t):t},t.format=function(e){i.isString(e)&&(e=b(e));return e instanceof s?e.format():s.prototype.format.call(e)},t.Url=s;var o=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,c=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,l=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),u=["'"].concat(l),d=["%","/","?",";","#"].concat(u),f=["/","?","#"],h=/^[+a-z0-9A-Z_-]{0,63}$/,p=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,m={javascript:!0,"javascript:":!0},g={javascript:!0,"javascript:":!0},v={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},y=n(53);function b(e,t,n){if(e&&i.isObject(e)&&e instanceof s)return e;var r=new s;return r.parse(e,t,n),r}s.prototype.parse=function(e,t,n){if(!i.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var s=e.indexOf("?"),a=-1!==s&&s<e.indexOf("#")?"?":"#",l=e.split(a);l[0]=l[0].replace(/\\/g,"/");var b=e=l.join(a);if(b=b.trim(),!n&&1===e.split("#").length){var w=c.exec(b);if(w)return this.path=b,this.href=b,this.pathname=w[1],w[2]?(this.search=w[2],this.query=t?y.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var _=o.exec(b);if(_){var E=(_=_[0]).toLowerCase();this.protocol=E,b=b.substr(_.length)}if(n||_||b.match(/^\/\/[^@\/]+@[^@\/]+/)){var k="//"===b.substr(0,2);!k||_&&g[_]||(b=b.substr(2),this.slashes=!0)}if(!g[_]&&(k||_&&!v[_])){for(var x,S,A=-1,L=0;L<f.length;L++){-1!==(B=b.indexOf(f[L]))&&(-1===A||B<A)&&(A=B)}-1!==(S=-1===A?b.lastIndexOf("@"):b.lastIndexOf("@",A))&&(x=b.slice(0,S),b=b.slice(S+1),this.auth=decodeURIComponent(x)),A=-1;for(L=0;L<d.length;L++){var B;-1!==(B=b.indexOf(d[L]))&&(-1===A||B<A)&&(A=B)}-1===A&&(A=b.length),this.host=b.slice(0,A),b=b.slice(A),this.parseHost(),this.hostname=this.hostname||"";var C="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!C)for(var I=this.hostname.split(/\./),P=(L=0,I.length);L<P;L++){var O=I[L];if(O&&!O.match(h)){for(var N="",q=0,j=O.length;q<j;q++)O.charCodeAt(q)>127?N+="x":N+=O[q];if(!N.match(h)){var T=I.slice(0,L),M=I.slice(L+1),R=O.match(p);R&&(T.push(R[1]),M.unshift(R[2])),M.length&&(b="/"+M.join(".")+b),this.hostname=T.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),C||(this.hostname=r.toASCII(this.hostname));var D=this.port?":"+this.port:"",V=this.hostname||"";this.host=V+D,this.href+=this.host,C&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==b[0]&&(b="/"+b))}if(!m[E])for(L=0,P=u.length;L<P;L++){var H=u[L];if(-1!==b.indexOf(H)){var F=encodeURIComponent(H);F===H&&(F=escape(H)),b=b.split(H).join(F)}}var $=b.indexOf("#");-1!==$&&(this.hash=b.substr($),b=b.slice(0,$));var U=b.indexOf("?");if(-1!==U?(this.search=b.substr(U),this.query=b.substr(U+1),t&&(this.query=y.parse(this.query)),b=b.slice(0,U)):t&&(this.search="",this.query={}),b&&(this.pathname=b),v[E]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){D=this.pathname||"";var z=this.search||"";this.path=D+z}return this.href=this.format(),this},s.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",n=this.pathname||"",r=this.hash||"",s=!1,o="";this.host?s=e+this.host:this.hostname&&(s=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(s+=":"+this.port)),this.query&&i.isObject(this.query)&&Object.keys(this.query).length&&(o=y.stringify(this.query));var a=this.search||o&&"?"+o||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||v[t])&&!1!==s?(s="//"+(s||""),n&&"/"!==n.charAt(0)&&(n="/"+n)):s||(s=""),r&&"#"!==r.charAt(0)&&(r="#"+r),a&&"?"!==a.charAt(0)&&(a="?"+a),t+s+(n=n.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+r},s.prototype.resolve=function(e){return this.resolveObject(b(e,!1,!0)).format()},s.prototype.resolveObject=function(e){if(i.isString(e)){var t=new s;t.parse(e,!1,!0),e=t}for(var n=new s,r=Object.keys(this),o=0;o<r.length;o++){var a=r[o];n[a]=this[a]}if(n.hash=e.hash,""===e.href)return n.href=n.format(),n;if(e.slashes&&!e.protocol){for(var c=Object.keys(e),l=0;l<c.length;l++){var u=c[l];"protocol"!==u&&(n[u]=e[u])}return v[n.protocol]&&n.hostname&&!n.pathname&&(n.path=n.pathname="/"),n.href=n.format(),n}if(e.protocol&&e.protocol!==n.protocol){if(!v[e.protocol]){for(var d=Object.keys(e),f=0;f<d.length;f++){var h=d[f];n[h]=e[h]}return n.href=n.format(),n}if(n.protocol=e.protocol,e.host||g[e.protocol])n.pathname=e.pathname;else{for(var p=(e.pathname||"").split("/");p.length&&!(e.host=p.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==p[0]&&p.unshift(""),p.length<2&&p.unshift(""),n.pathname=p.join("/")}if(n.search=e.search,n.query=e.query,n.host=e.host||"",n.auth=e.auth,n.hostname=e.hostname||e.host,n.port=e.port,n.pathname||n.search){var m=n.pathname||"",y=n.search||"";n.path=m+y}return n.slashes=n.slashes||e.slashes,n.href=n.format(),n}var b=n.pathname&&"/"===n.pathname.charAt(0),w=e.host||e.pathname&&"/"===e.pathname.charAt(0),_=w||b||n.host&&e.pathname,E=_,k=n.pathname&&n.pathname.split("/")||[],x=(p=e.pathname&&e.pathname.split("/")||[],n.protocol&&!v[n.protocol]);if(x&&(n.hostname="",n.port=null,n.host&&(""===k[0]?k[0]=n.host:k.unshift(n.host)),n.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===p[0]?p[0]=e.host:p.unshift(e.host)),e.host=null),_=_&&(""===p[0]||""===k[0])),w)n.host=e.host||""===e.host?e.host:n.host,n.hostname=e.hostname||""===e.hostname?e.hostname:n.hostname,n.search=e.search,n.query=e.query,k=p;else if(p.length)k||(k=[]),k.pop(),k=k.concat(p),n.search=e.search,n.query=e.query;else if(!i.isNullOrUndefined(e.search)){if(x)n.hostname=n.host=k.shift(),(C=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=C.shift(),n.host=n.hostname=C.shift());return n.search=e.search,n.query=e.query,i.isNull(n.pathname)&&i.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.href=n.format(),n}if(!k.length)return n.pathname=null,n.search?n.path="/"+n.search:n.path=null,n.href=n.format(),n;for(var S=k.slice(-1)[0],A=(n.host||e.host||k.length>1)&&("."===S||".."===S)||""===S,L=0,B=k.length;B>=0;B--)"."===(S=k[B])?k.splice(B,1):".."===S?(k.splice(B,1),L++):L&&(k.splice(B,1),L--);if(!_&&!E)for(;L--;L)k.unshift("..");!_||""===k[0]||k[0]&&"/"===k[0].charAt(0)||k.unshift(""),A&&"/"!==k.join("/").substr(-1)&&k.push("");var C,I=""===k[0]||k[0]&&"/"===k[0].charAt(0);x&&(n.hostname=n.host=I?"":k.length?k.shift():"",(C=!!(n.host&&n.host.indexOf("@")>0)&&n.host.split("@"))&&(n.auth=C.shift(),n.host=n.hostname=C.shift()));return(_=_||n.host&&k.length)&&!I&&k.unshift(""),k.length?n.pathname=k.join("/"):(n.pathname=null,n.path=null),i.isNull(n.pathname)&&i.isNull(n.search)||(n.path=(n.pathname?n.pathname:"")+(n.search?n.search:"")),n.auth=e.auth||n.auth,n.slashes=n.slashes||e.slashes,n.href=n.format(),n},s.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},function(e,t,n){var r=n(15),i=n(6);function s(e,t){this.id=e,this.ref=t}e.exports.SchemaScanResult=s,e.exports.scan=function(e,t){function n(e,t){if(t&&"object"==typeof t)if(t.$ref){var s=r.resolve(e,t.$ref);l[s]=l[s]?l[s]+1:0}else{var u=t.id?r.resolve(e,t.id):e;if(u){if(u.indexOf("#")<0&&(u+="#"),c[u]){if(!i.deepCompareStrict(c[u],t))throw new Error("Schema <"+t+"> already exists with different definition");return c[u]}c[u]=t,"#"==u[u.length-1]&&(c[u.substring(0,u.length-1)]=t)}o(u+"/items",t.items instanceof Array?t.items:[t.items]),o(u+"/extends",t.extends instanceof Array?t.extends:[t.extends]),n(u+"/additionalItems",t.additionalItems),a(u+"/properties",t.properties),n(u+"/additionalProperties",t.additionalProperties),a(u+"/definitions",t.definitions),a(u+"/patternProperties",t.patternProperties),a(u+"/dependencies",t.dependencies),o(u+"/disallow",t.disallow),o(u+"/allOf",t.allOf),o(u+"/anyOf",t.anyOf),o(u+"/oneOf",t.oneOf),n(u+"/not",t.not)}}function o(e,t){if(t instanceof Array)for(var r=0;r<t.length;r++)n(e+"/"+r,t[r])}function a(e,t){if(t&&"object"==typeof t)for(var r in t)n(e+"/"+r,t[r])}var c={},l={};return n(e,t),new s(c,l)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.insertTabHtml={primitiveTab:"<p class='control'><button id='punctum' class='button insertel smallel' title='punctum'><img src='/Neon/Neon-gh/assets/img/punctum.png' class='image'/></button></p><p class='control'><button id='virga' class='button insertel smallel' title='virga'><img src='/Neon/Neon-gh/assets/img/virga.png' class='image'/></button></p><p class='control'><button id='diamond' class='button insertel smallel' title='inclinatum'><img src='/Neon/Neon-gh/assets/img/diamond.png' class='image'/></button></p><p class='control'><button id='custos' class='button insertel smallel' title='custos'><img src='/Neon/Neon-gh/assets/img/custos.png' class='image'/></button></p><p class='control'><button id='cClef' class='button insertel smallel' title=' C Clef'><img src='/Neon/Neon-gh/assets/img/cClef.png' class='image' /></button></p><p class='control'><button id='fClef' class='button insertel smallel' title='F Clef'><img src='/Neon/Neon-gh/assets/img/fClef.png' class='image'/></button></p>",groupingTab:"<p class='control'><button id='pes' class='button insertel smallel' title='pes'><img src='/Neon/Neon-gh/assets/img/pes.png' class='image'/></button></p><p class='control'><button id='clivis' class='button insertel smallel' title='clivis'><img src='/Neon/Neon-gh/assets/img/clivis.png' class='image'/></button></p><p class='control'><button id='scandicus' class='button insertel smallel' title='scandicus'><img src='/Neon/Neon-gh/assets/img/scandicus.png' class='image'/></button></p><p class='control'><button id='climacus' class='button insertel smallel' title='climacus'><img src='/Neon/Neon-gh/assets/img/climacus.png' class='image'/></button></p><p class='control'><button id='torculus' class='button insertel smallel' title='toculus'><img src='/Neon/Neon-gh/assets/img/torculus.png' class='image'/></button></p><p class='control'><button id='porrectus' class='button insertel smallel' title='porrectus'><img src='/Neon/Neon-gh/assets/img/porrectus.png' class='image'/></button></p><p class='control'><button id='pressus' class='button insertel smallel' title='pressus'><img src='/Neon/Neon-gh/assets/img/pressus.png' class='image'/></button></p>",systemTab:"<p class='control'><button id='staff' class='button insertel longel' title='system'><img src='/Neon/Neon-gh/assets/img/staff.png' class='image' /></button></p><p>Click upper left and lower right corners of new staff.</p>"},t.insertControlsPanel="<p class='panel-heading' id='insertMenu'>Insert<svg class='icon is-pulled-right'><use id='toggleInsert' xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></p><div id='insertContents' style='overflow-y: hidden;'><p class='panel-tabs'><a id='primitiveTab' class='insertTab'>Primitive Elements</a><a id='groupingTab' class='insertTab'>Grouping</a><a id='systemTab' class='insertTab'>System</a></p><a class='panel-block has-text-centered'><div id='insert_data' class='field is-grouped buttons'></div></a></div>",t.editControlsPanel="<p class='panel-heading' id='editMenu'>Edit<svg class='icon is-pulled-right'><use id='toggleEdit' xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></p><div id='editContents'><a class='panel-block'><label>Select By:&nbsp;</label><div class='field has-addons buttons' style='overflow-x: auto;'><p class='control'><button class='button sel-by is-active' id='selBySyl'>Syllable</button></p><p class='control'><button class='button sel-by' id='selByNeume'>Neume</button></p><p class='control'><button class='button sel-by' id='selByNc'>Neume Component</button></p><p class='control'><button class='button sel-by' id='selByStaff'>Staff</button></p></div></a><div class='field is-grouped buttons'><p class='control'><a id='moreEdit' class='panel-block is-invisible'><a id='extraEdit' class='panel-block is-invisible'><a id='neumeEdit' class='panel-block is-invisible'></div>",t.ncActionContents="<label>Change Head Shape:&nbsp;</label><div id='drop_select' class='dropdown'><div class='dropdown-trigger'><button id='select-options' class='button' aria-haspopup='true' aria-controls='dropdown-menu'><span>Head Shapes</span><svg class='icon'><use xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></button></div><div class='dropdown-menu' id='dropdown-menu' role='menu'><div class='dropdown-content'><a id='Punctum' class='dropdown-item'>Punctum</a><a id='Virga' class='dropdown-item'>Virga</a><a id='Inclinatum' class='dropdown-item'>Inclinatum</a></div></div></div><p class='control'></p></div>",t.neumeActionContents="<label>Change Grouping:&nbsp;</label><div id='drop_select' class='dropdown'><div class='dropdown-trigger'><button id='select-options' class='button' aria-haspopup='true' aria-controls='dropdown-menu'><span>Groupings</span><svg class='icon'><use xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></button></div><div class='dropdown-menu' id='dropdown-menu' role='menu'><div class='dropdown-content scrollable-dropdown'><a id='Pes' class='dropdown-item grouping'>Pes</a><a id='Pes subpunctis' class='dropdown-item grouping'>Pes Subpunctis</a><a id='Clivis' class='dropdown-item grouping'>Clivis</a><a id='Scandicus' class='dropdown-item grouping'>Scandicus</a><a id='Scandicus flexus' class='dropdown-item grouping'>Scandicus Flexus</a><a id='Scandicus subpunctis' class='dropdown-item grouping'>Scandicus Subpunctis</a><a id='Climacus' class='dropdown-item grouping'>Climacus</a><a id='Climacus resupinus' class='dropdown-item grouping'>Climacus Resupinus</a><a id='Torculus' class='dropdown-item grouping'>Torculus</a><a id='Torculus resupinus' class='dropdown-item grouping'>Torculus Resupinus</a><a id='Porrectus' class='dropdown-item grouping'>Porrectus</a><a id='Porrectus flexus' class='dropdown-item grouping'>Porrectus Flexus</a><a id='Porrectus subpunctis' class='dropdown-item grouping'>Porrectus Subpunctis</a><a id='Pressus' class='dropdown-item grouping'>Pressus</a></div></div></div><div><p class='control'><button class='button' id='ungroupNcs'>Ungroup</button></p></div>",t.staffActionContents="<label>Merge Systems:&nbsp;</label><div><p class='control'><button id='merge-systems' class='button'>Merge</button><button class='button' id='delete'>Delete</button></p></div>",t.defaultActionContents="<div><p class='control'><button class='button' id='delete'>Delete</button></p></div>",t.defaultSylActionContents="<div><p class='control'><button class='button' id='delete'>Delete</button><button class='button' id='changeStaff'>Re-associate to nearest staff</button></p></div>",t.custosActionContents="<div><p class='control'><button class='button' id='delete'>Delete</button><button class='button' id='changeStaff'>Re-associate to nearest staff</button></p></div>",t.splitActionContents="<label>Split System:&nbsp;</label><div><p class='control'><button id='split-system' class='button'>Split</button><button id='reset-rotate' class='button'>Reset Rotate</button><button class='button' id='delete'>Delete</button></p></div>",t.clefActionContents="<label>Change Clef Shape:&nbsp;</label><div id='drop_select' class='dropdown'><div class='dropdown-trigger'overflow='auto'><button id='select-options' class='button' aria-haspopup='true' aria-controls='dropdown-menu'><span>Clef Shapes</span><svg class='icon'><use xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></button></div><div class='dropdown-menu' id='dropdown-menu' role='menu'><div class='dropdown-content'><a id='CClef' class='dropdown-item'>C Clef</a><a id='FClef' class='dropdown-item'>F Clef</a></div></div></div></div>",t.groupingMenu={nc:"<div class='field is-grouped'><div><p class='control'><button class='button' id='groupNcs'>Group Neume Components</button><button class='button' id='delete'>Delete</button></p></div>",neume:"<div class='field is-grouped'><div><p class='control'><button class='button' id='groupNeumes'>Group Neumes</button><button class='button' id='delete'>Delete</button></p></div>",syl:"<div class='field is-grouped'><div><p class='control'><button class='button' id='mergeSyls'>Merge Syllables</button><button class='button' id='delete'>Delete</button><button class='button' id='changeStaff'>Re-associate to nearest staff</button></p></div>",ligatureNc:"<div class='field is-grouped'><div><p class='control'><button class='button' id='groupNcs'>Group Neume Components</button></p></div><div><p class='control'><button class='button' id='toggle-ligature'>Toggle Ligature</button><button class='button' id='delete'>Delete</button></p></div></div>",ligature:"<div class='field is-grouped'><div><p class='control'><button class='button' id='toggle-ligature'>Toggle Ligature</button><button class='button' id='delete'>Delete</button></p></div></div>",splitSyllable:"<div class='field is-grouped'><div><p class='control'><button class='button' id='toggle-link'>Toggle Linked Syllables</button><button class='button' id='delete'>Delete</button></p></div></div>"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(4),i=n(36),s=n(3);let o,a,c,l,u=7;function d(e){"Escape"===e.key&&(document.getElementsByClassName("selected").length>0&&c.infoListeners(),r.unselect())}function f(){const e=document.getElementById("selByBBox");return!!e&&e.classList.contains("is-active")}function h(e){e.stopPropagation()}function p(e){if(!a)return;if("insert"!==a.getUserMode()&&!e.shiftKey)if("use"===this.tagName&&"selByBBox"!==r.getSelectionType())if(null===this.closest(".selected")){let t=[this];const n=/E9B[45678]/,i=/E9B[9ABC]/;if(this.getAttribute("xlink:href").match(i)){const e=this.closest(".nc"),r=this.closest(".neume"),i=Array.from(r.children).indexOf(e),s=r.children[i-1].children[0];console.assert(s.getAttribute("xlink:href").match(n),"First glyph of ligature unexpected!"),null===s.closest(".selected")&&t.unshift(s)}else if(this.getAttribute("xlink:href").match(n)){const e=this.closest(".nc"),n=this.closest(".neume"),r=Array.from(n.children).indexOf(e),s=n.children[r+1].children[0];console.assert(s.getAttribute("xlink:href").match(i),"Second glyph of ligature unexpected!"),null===s.closest(".selected")&&t.push(s)}(window.navigator.userAgent.match(/Mac/)?e.metaKey:e.ctrlKey)&&(t=t.concat(Array.from(document.getElementsByClassName("selected")))),r.selectAll(t,a,o),o&&o.dragInit()}else{let t=[];if(window.navigator.userAgent.match(/Mac/)?e.metaKey:e.ctrlKey){let e="";switch(document.querySelector(".sel-by.is-active").id){case"selByStaff":e=".staff";break;case"selByNeume":e=".neume";break;case"selByNc":e=".nc";break;default:e=".syllable"}const n=[this.closest(e)];t=Array.from(document.getElementsByClassName("selected")),t=t.filter(e=>!n.includes(e)),r.selectAll(t,a,o),o&&o.dragInit()}}else if("rect"===e.target.tagName&&"selByBBox"===r.getSelectionType())if(null===this.closest(".selected")){let t=[e.target];(window.navigator.userAgent.match(/Mac/)?e.metaKey:e.ctrlKey)&&(t=t.concat(Array.from(document.getElementsByClassName("selected"))),t=t.map(e=>"rect"==e.tagName?e:e.querySelector(".sylTextRect-Display"))),r.selectAll(t,a,o),o&&o.dragInit()}else{let t=[];if(window.navigator.userAgent.match(/Mac/)?e.metaKey:e.ctrlKey){const e=[this];t=Array.from(document.getElementsByClassName("selected")),t=t.map(e=>"rect"==e.tagName?e:e.querySelector(".sylTextRect-Display")),t=t.filter(t=>!e.includes(t)),r.selectAll(t,a,o),o&&o.dragInit()}}else{if("selByStaff"!==r.getSelectionType())return void c.infoListeners();const t=document.getElementsByClassName("active-page")[0].getElementsByClassName("definition-scale")[0];let n=t.createSVGPoint();n.x=e.clientX,n.y=e.clientY;const s=t.getElementsByClassName("system")[0].getScreenCTM();n=n.matrixTransform(s.inverse());const l=Array.from(document.getElementsByClassName("staff")).filter(e=>{const t=r.getStaffBBox(e),i=t.ulx,s=t.uly,o=t.lrx,a=t.lry,c=t.rotate;return n.x>i&&n.x<o&&n.y>s+(n.x-i)*Math.tan(c)&&n.y<a-(o-n.x)*Math.tan(c)});if(r.unselect(),0==l.length)return;const u=l[0];u.classList.contains("selected")||(r.selectStaff(u,o),i.resize(u,a,o),o&&o.dragInit()),u.dispatchEvent(new MouseEvent("mousedown",{screenX:e.screenX,screenY:e.screenY,clientX:e.clientX,clientY:e.clientY,ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey,view:e.view}))}}t.setSelectStrokeWidth=function(e){u=e},t.setSelectHelperObjects=function(e,t){o=t,a=e,c=a.info,l=a.view.zoomHandler},t.clickSelect=function(e){document.querySelectorAll(e).forEach(e=>{e.removeEventListener("mousedown",p),e.addEventListener("mousedown",p)}),document.body.removeEventListener("keydown",d),document.body.addEventListener("keydown",d),document.getElementById("container").addEventListener("contextmenu",e=>{e.preventDefault()}),document.querySelectorAll("use,rect,#moreEdit").forEach(e=>{e.removeEventListener("click",h),e.addEventListener("click",h)})},t.dragSelect=function(e){let t=0,n=0,i=!1,c=!1;s.selectAll(e.replace(".active-page","").trim()).on(".drag",null);const d=s.select(e),h=s.drag().on("start",(function(){if(!a)return;const e=a.getUserMode();if("use"!==s.event.sourceEvent.target.nodeName&&"insert"!==e&&"rect"!==s.event.sourceEvent.target.nodeName){if(s.event.sourceEvent.shiftKey)i=!0,void 0!==l&&l.startDrag();else if(!document.getElementById("selByStaff").classList.contains("is-active")||(h=s.mouse(this),0===Array.from(document.getElementsByClassName("staff")).filter(e=>{const t=r.getStaffBBox(e),n=t.ulx,i=t.uly,s=t.lrx,o=t.lry,a=t.rotate;return h[0]>n&&h[0]<s&&h[1]>i+(h[0]-n)*Math.tan(a)&&h[1]<o-(s-h[0])*Math.tan(a)}).length)){r.unselect(),c=!0;const e=s.mouse(this);t=e[0],n=e[1],o=t,f=n,d.append("rect").attr("x",o).attr("y",f).attr("width",0).attr("height",0).attr("id","selectRect").attr("stroke","black").attr("stroke-width",u).attr("fill","none")}}else s.event.sourceEvent.shiftKey&&(i=!0,void 0!==l&&l.startDrag());var o,f;var h})).on("drag",(function(){if(!i&&c){const e=s.mouse(this),r=e[0],i=e[1];!function(e,t,n,r){s.select("#selectRect").attr("x",e).attr("y",t).attr("width",n).attr("height",r)}(r<t?r:t,i<n?i:n,r<t?t-r:r-t,i<n?n-i:i-n)}else i&&void 0!==l&&l.dragging()})).on("end",(function(){if(!i&&c){const t=parseInt(document.getElementById("selectRect").getAttribute("x")),n=parseInt(document.getElementById("selectRect").getAttribute("y")),i=parseInt(document.getElementById("selectRect").getAttribute("x"))+parseInt(document.getElementById("selectRect").getAttribute("width")),l=parseInt(document.getElementById("selectRect").getAttribute("y"))+parseInt(document.getElementById("selectRect").getAttribute("height")),u=d.node();let h=u.createSVGPoint();h.x=t,h.y=n;let p=u.createSVGPoint();p.x=i,p.y=l;const m=u.getScreenCTM().inverse().multiply(d.select(".system").node().getScreenCTM()).inverse();let g;h=h.matrixTransform(m),p=p.matrixTransform(m),g=document.getElementById("selByStaff").classList.contains("is-active")?document.querySelectorAll(e+" use, "+e+" .staff"):f()?document.querySelectorAll(e+" .sylTextRect-display"):document.querySelectorAll(e+" use");const v=Array.from(g).filter((function(e){let t,n,i,s;if(f())return t=Number(e.getAttribute("x")),n=Number(e.getAttribute("y")),i=+t+ +e.getAttribute("width").slice(0,-2),s=+n+ +e.getAttribute("height").slice(0,-2),!(h.x<t&&p.x<t||h.x>i&&p.x>i||h.y<n&&p.y<n||h.y>s&&p.y>s);if("use"===e.tagName){const r=e.parentNode.getBBox();return t=r.x,n=r.y,i=r.x+r.width,s=r.y+r.height,!(h.x<t&&p.x<t||h.x>i&&p.x>i||h.y<n&&p.y<n||h.y>s&&p.y>s)}{const t=r.getStaffBBox(e);return!(h.x<t.ulx&&p.x<t.ulx||h.x>t.lrx&&p.x>t.lrx||h.y<t.uly+Math.abs(t.ulx-h.x)*Math.tan(t.rotate)&&p.y<t.uly+Math.abs(t.ulx-h.x)*Math.tan(t.rotate)||h.y>t.lry+Math.abs(t.lry-p.y)*Math.tan(t.rotate)&&p.y>t.lry+Math.abs(t.lry-p.y)*Math.tan(t.rotate))}}));v.forEach(e=>{if("use"===e.tagName&&e.getAttribute("xlink:href").match(/E9B[456789ABC]/)){const t=e.closest(".neume"),n=Array.from(t.children).indexOf(e.closest(".nc"));if(e.getAttribute("xlink:href").match(/E9B[45678]/)){const e=t.children[n+1].querySelector("use");v.indexOf(e)<0&&v.push(e)}else{const e=t.children[n-1].querySelector("use");v.indexOf(e)<0&&v.push(e)}}}),r.selectAll(v,a,o),o&&o.dragInit(),s.selectAll("#selectRect").remove(),c=!1}i=!1}));d.call(h),o&&o.resetTo(h)}},function(e,t,n){"use strict";n.r(t),function(e,r){var i,s,o=n(2),a=n.n(o),c=n(21),l=n.n(c),u=n(12),d=n.n(u),f=n(22),h=n.n(f),p=n(5),m=n.n(p),g=n(1),v=n.n(g),y=n(0);function b(e){return"$"+e}function w(e){return e.substring(1)}function _(){this._store={}}function E(e){if(this._store=new _,e&&Array.isArray(e))for(var t=0,n=e.length;t<n;t++)this.add(e[t])}function k(e){if(e instanceof ArrayBuffer)return function(e){if("function"==typeof e.slice)return e.slice(0);var t=new ArrayBuffer(e.byteLength),n=new Uint8Array(t),r=new Uint8Array(e);return n.set(r),t}(e);var t=e.size,n=e.type;return"function"==typeof e.slice?e.slice(0,t,n):e.webkitSlice(0,t,n)}_.prototype.get=function(e){var t=b(e);return this._store[t]},_.prototype.set=function(e,t){var n=b(e);return this._store[n]=t,!0},_.prototype.has=function(e){return b(e)in this._store},_.prototype.delete=function(e){var t=b(e),n=t in this._store;return delete this._store[t],n},_.prototype.forEach=function(e){for(var t=Object.keys(this._store),n=0,r=t.length;n<r;n++){var i=t[n];e(this._store[i],i=w(i))}},Object.defineProperty(_.prototype,"size",{get:function(){return Object.keys(this._store).length}}),E.prototype.add=function(e){return this._store.set(e,!0)},E.prototype.has=function(e){return this._store.has(e)},E.prototype.forEach=function(e){this._store.forEach((function(t,n){e(n)}))},Object.defineProperty(E.prototype,"size",{get:function(){return this._store.size}}),!function(){if("undefined"==typeof Symbol||"undefined"==typeof Map||"undefined"==typeof Set)return!1;var e=Object.getOwnPropertyDescriptor(Map,Symbol.species);return e&&"get"in e&&Map[Symbol.species]===Map}()?(i=E,s=_):(i=Set,s=Map);var x=Function.prototype.toString,S=x.call(Object);function A(e){var t,n,r;if(!e||"object"!=typeof e)return e;if(Array.isArray(e)){for(t=[],n=0,r=e.length;n<r;n++)t[n]=A(e[n]);return t}if(e instanceof Date)return e.toISOString();if(function(e){return"undefined"!=typeof ArrayBuffer&&e instanceof ArrayBuffer||"undefined"!=typeof Blob&&e instanceof Blob}(e))return k(e);if(!function(e){var t=Object.getPrototypeOf(e);if(null===t)return!0;var n=t.constructor;return"function"==typeof n&&n instanceof n&&x.call(n)==S}(e))return e;for(n in t={},e)if(Object.prototype.hasOwnProperty.call(e,n)){var i=A(e[n]);void 0!==i&&(t[n]=i)}return t}function L(e){var t=!1;return m()((function(n){if(t)throw new Error("once called more than once");t=!0,e.apply(this,n)}))}function B(e){return m()((function(t){t=A(t);var n=this,r="function"==typeof t[t.length-1]&&t.pop(),i=new Promise((function(r,i){var s;try{var o=L((function(e,t){e?i(e):r(t)}));t.push(o),(s=e.apply(n,t))&&"function"==typeof s.then&&r(s)}catch(e){i(e)}}));return r&&i.then((function(e){r(null,e)}),r),i}))}function C(e,t){return B(m()((function(n){if(this._closed)return Promise.reject(new Error("database is closed"));if(this._destroyed)return Promise.reject(new Error("database is destroyed"));var r=this;return function(e,t,n){if(e.constructor.listeners("debug").length){for(var r=["api",e.name,t],i=0;i<n.length-1;i++)r.push(n[i]);e.constructor.emit("debug",r);var s=n[n.length-1];n[n.length-1]=function(n,r){var i=["api",e.name,t];i=i.concat(n?["error",n]:["success",r]),e.constructor.emit("debug",i),s(n,r)}}}(r,e,n),this.taskqueue.isReady?t.apply(this,n):new Promise((function(t,i){r.taskqueue.addTask((function(s){s?i(s):t(r[e].apply(r,n))}))}))})))}function I(e,t){for(var n={},r=0,i=t.length;r<i;r++){var s=t[r];s in e&&(n[s]=e[s])}return n}var P;function O(e){return e}function N(e){return[{ok:e}]}function q(e,t,n){var r=t.docs,i=new s;r.forEach((function(e){i.has(e.id)?i.get(e.id).push(e):i.set(e.id,[e])}));var o=i.size,a=0,c=new Array(o);function l(){var e;++a===o&&(e=[],c.forEach((function(t){t.docs.forEach((function(n){e.push({id:t.id,docs:[n]})}))})),n(null,{results:e}))}var u=[];i.forEach((function(e,t){u.push(t)}));var d=0;function f(){if(!(d>=u.length)){var n=Math.min(d+6,u.length),r=u.slice(d,n);!function(n,r){n.forEach((function(n,s){var o=r+s,a=i.get(n),u=I(a[0],["atts_since","attachments"]);u.open_revs=a.map((function(e){return e.rev})),u.open_revs=u.open_revs.filter(O);var d=O;0===u.open_revs.length&&(delete u.open_revs,d=N),["revs","attachments","binary","ajax","latest"].forEach((function(e){e in t&&(u[e]=t[e])})),e.get(n,u,(function(e,t){var r,i,s;r=e?[{error:e}]:d(t),i=n,s=r,c[o]={id:i,docs:s},l(),f()}))}))}(r,d),d+=r.length}}f()}try{localStorage.setItem("_pouch_check_localstorage",1),P=!!localStorage.getItem("_pouch_check_localstorage")}catch(e){P=!1}function j(){return P}function T(){var e;y.EventEmitter.call(this),this._listeners={},e=this,j()&&addEventListener("storage",(function(t){e.emit(t.key)}))}function M(e){if("undefined"!=typeof console&&"function"==typeof console[e]){var t=Array.prototype.slice.call(arguments,1);console[e].apply(console,t)}}function R(e){var t=0;return e||(t=2e3),function(e,t){return e=parseInt(e,10)||0,(t=parseInt(t,10))!=t||t<=e?t=(e||1)<<1:t+=1,t>6e5&&(e=3e5,t=6e5),~~((t-e)*Math.random()+e)}(e,t)}function D(e,t){M("info","The above "+e+" is totally normal. "+t)}v()(T,y.EventEmitter),T.prototype.addListener=function(e,t,n,r){if(!this._listeners[t]){var i=this,s=!1;this._listeners[t]=o,this.on(e,o)}function o(){if(i._listeners[t])if(s)s="waiting";else{s=!0;var e=I(r,["style","include_docs","attachments","conflicts","filter","doc_ids","view","since","query_params","binary","return_docs"]);n.changes(e).on("change",(function(e){e.seq>r.since&&!r.cancelled&&(r.since=e.seq,r.onChange(e))})).on("complete",(function(){"waiting"===s&&a()(o),s=!1})).on("error",(function(){s=!1}))}}},T.prototype.removeListener=function(e,t){t in this._listeners&&(y.EventEmitter.prototype.removeListener.call(this,e,this._listeners[t]),delete this._listeners[t])},T.prototype.notifyLocalWindows=function(e){j()&&(localStorage[e]="a"===localStorage[e]?"b":"a")},T.prototype.notify=function(e){this.emit(e),this.notifyLocalWindows(e)};var V="function"==typeof Object.assign?Object.assign:function(e){for(var t=Object(e),n=1;n<arguments.length;n++){var r=arguments[n];if(null!=r)for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(t[i]=r[i])}return t};function H(e,t,n){Error.call(this,n),this.status=e,this.name=t,this.message=n,this.error=!0}v()(H,Error),H.prototype.toString=function(){return JSON.stringify({status:this.status,name:this.name,message:this.message,reason:this.reason})};new H(401,"unauthorized","Name or password is incorrect.");var F=new H(400,"bad_request","Missing JSON list of 'docs'"),$=new H(404,"not_found","missing"),U=new H(409,"conflict","Document update conflict"),z=new H(400,"bad_request","_id field must contain a string"),G=new H(412,"missing_id","_id is required for puts"),K=new H(400,"bad_request","Only reserved document ids may start with underscore."),J=(new H(412,"precondition_failed","Database not open"),new H(500,"unknown_error","Database encountered an unknown error")),W=new H(500,"badarg","Some query argument is invalid"),Z=(new H(400,"invalid_request","Request was invalid"),new H(400,"query_parse_error","Some query parameter is invalid")),X=new H(500,"doc_validation","Bad special document member"),Y=new H(400,"bad_request","Something wrong with the request"),Q=new H(400,"bad_request","Document must be a JSON object"),ee=(new H(404,"not_found","Database not found"),new H(500,"indexed_db_went_bad","unknown")),te=(new H(500,"web_sql_went_bad","unknown"),new H(500,"levelDB_went_went_bad","unknown"),new H(403,"forbidden","Forbidden by design doc validate_doc_update function"),new H(400,"bad_request","Invalid rev format")),ne=(new H(412,"file_exists","The database could not be created, the file already exists."),new H(412,"missing_stub","A pre-existing attachment stub wasn't found"));new H(413,"invalid_url","Provided URL is invalid");function re(e,t){function n(t){for(var n in e)"function"!=typeof e[n]&&(this[n]=e[n]);void 0!==t&&(this.reason=t)}return n.prototype=H.prototype,new n(t)}function ie(e){if("object"!=typeof e){var t=e;(e=J).data=t}return"error"in e&&"conflict"===e.error&&(e.name="conflict",e.status=409),"name"in e||(e.name=e.error||"unknown"),"status"in e||(e.status=500),"message"in e||(e.message=e.message||e.reason),e}function se(e){var t={},n=e.filter&&"function"==typeof e.filter;return t.query=e.query_params,function(r){r.doc||(r.doc={});var i=n&&function(e,t,n){try{return!e(t,n)}catch(e){var r="Filter function threw: "+e.toString();return re(Y,r)}}(e.filter,r.doc,t);if("object"==typeof i)return i;if(i)return!1;if(e.include_docs){if(!e.attachments)for(var s in r.doc._attachments)r.doc._attachments.hasOwnProperty(s)&&(r.doc._attachments[s].stub=!0)}else delete r.doc;return!0}}function oe(e){for(var t=[],n=0,r=e.length;n<r;n++)t=t.concat(e[n]);return t}function ae(e){var t;if(e?"string"!=typeof e?t=re(z):/^_/.test(e)&&!/^_(design|local)/.test(e)&&(t=re(K)):t=re(G),t)throw t}function ce(e){return"boolean"==typeof e._remote?e._remote:"function"==typeof e.type&&(M("warn","db.type() is deprecated and will be removed in a future version of PouchDB"),"http"===e.type())}function le(e){if(!e)return null;var t=e.split("/");return 2===t.length?t:1===t.length?[e,e]:null}function ue(e){var t=le(e);return t?t.join("/"):null}var de=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],fe=/(?:^|&)([^&=]*)=?([^&]*)/g,he=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/;function pe(e){for(var t=he.exec(e),n={},r=14;r--;){var i=de[r],s=t[r]||"",o=-1!==["user","password"].indexOf(i);n[i]=o?decodeURIComponent(s):s}return n.queryKey={},n[de[12]].replace(fe,(function(e,t,r){t&&(n.queryKey[t]=r)})),n}function me(e,t){var n=[],r=[];for(var i in t)t.hasOwnProperty(i)&&(n.push(i),r.push(t[i]));return n.push(e),Function.apply(null,n).apply(null,r)}function ge(e,t,n){return new Promise((function(r,i){e.get(t,(function(s,o){if(s){if(404!==s.status)return i(s);o={}}var a=o._rev,c=n(o);if(!c)return r({updated:!1,rev:a});c._id=t,c._rev=a,r(function(e,t,n){return e.put(t).then((function(e){return{updated:!0,rev:e.rev}}),(function(r){if(409!==r.status)throw r;return ge(e,t._id,n)}))}(e,c,n))}))}))}var ve=function(e){return atob(e)},ye=function(e){return btoa(e)};function be(e,t){e=e||[],t=t||{};try{return new Blob(e,t)}catch(i){if("TypeError"!==i.name)throw i;for(var n=new("undefined"!=typeof BlobBuilder?BlobBuilder:"undefined"!=typeof MSBlobBuilder?MSBlobBuilder:"undefined"!=typeof MozBlobBuilder?MozBlobBuilder:WebKitBlobBuilder),r=0;r<e.length;r+=1)n.append(e[r]);return n.getBlob(t.type)}}function we(e){for(var t=e.length,n=new ArrayBuffer(t),r=new Uint8Array(n),i=0;i<t;i++)r[i]=e.charCodeAt(i);return n}function _e(e,t){return be([we(e)],{type:t})}function Ee(e,t){return _e(ve(e),t)}function ke(e,t){var n=new FileReader,r="function"==typeof n.readAsBinaryString;n.onloadend=function(e){var n=e.target.result||"";if(r)return t(n);t(function(e){for(var t="",n=new Uint8Array(e),r=n.byteLength,i=0;i<r;i++)t+=String.fromCharCode(n[i]);return t}(n))},r?n.readAsBinaryString(e):n.readAsArrayBuffer(e)}function xe(e,t){ke(e,(function(e){t(e)}))}function Se(e,t){xe(e,(function(e){t(ye(e))}))}var Ae=e.setImmediate||e.setTimeout;function Le(e,t,n,r,i){(n>0||r<t.size)&&(t=function(e,t,n){return e.webkitSlice?e.webkitSlice(t,n):e.slice(t,n)}(t,n,r)),function(e,t){var n=new FileReader;n.onloadend=function(e){var n=e.target.result||new ArrayBuffer(0);t(n)},n.readAsArrayBuffer(e)}(t,(function(t){e.append(t),i()}))}function Be(e,t,n,r,i){(n>0||r<t.length)&&(t=t.substring(n,r)),e.appendBinary(t),i()}function Ce(e,t){var n="string"==typeof e,r=n?e.length:e.size,i=Math.min(32768,r),s=Math.ceil(r/i),o=0,a=n?new d.a:new d.a.ArrayBuffer,c=n?Be:Le;function l(){Ae(f)}function u(){var e=function(e){return ye(e)}(a.end(!0));t(e),a.destroy()}function f(){var t=o*i,n=t+i;o++,c(a,e,t,n,o<s?l:u)}f()}function Ie(e){return d.a.hash(e)}function Pe(e,t){var n=A(e);return t?(delete n._rev_tree,Ie(JSON.stringify(n))):l.a.v4().replace(/-/g,"").toLowerCase()}var Oe=l.a.v4;function Ne(e){for(var t,n,r,i,s=e.rev_tree.slice();i=s.pop();){var o=i.ids,a=o[2],c=i.pos;if(a.length)for(var l=0,u=a.length;l<u;l++)s.push({pos:c+1,ids:a[l]});else{var d=!!o[1].deleted,f=o[0];t&&!(r!==d?r:n!==c?n<c:t<f)||(t=f,n=c,r=d)}}return n+"-"+t}function qe(e,t){for(var n,r=e.slice();n=r.pop();)for(var i=n.pos,s=n.ids,o=s[2],a=t(0===o.length,i,s[0],n.ctx,s[1]),c=0,l=o.length;c<l;c++)r.push({pos:i+1,ids:o[c],ctx:a})}function je(e,t){return e.pos-t.pos}function Te(e){var t=[];qe(e,(function(e,n,r,i,s){e&&t.push({rev:n+"-"+r,pos:n,opts:s})})),t.sort(je).reverse();for(var n=0,r=t.length;n<r;n++)delete t[n].pos;return t}function Me(e){for(var t=Ne(e),n=Te(e.rev_tree),r=[],i=0,s=n.length;i<s;i++){var o=n[i];o.rev===t||o.opts.deleted||r.push(o.rev)}return r}function Re(e){for(var t,n=[],r=e.slice();t=r.pop();){var i=t.pos,s=t.ids,o=s[0],a=s[1],c=s[2],l=0===c.length,u=t.history?t.history.slice():[];u.push({id:o,opts:a}),l&&n.push({pos:i+1-u.length,ids:u});for(var d=0,f=c.length;d<f;d++)r.push({pos:i+1,ids:c[d],history:u})}return n.reverse()}function De(e,t){return e.pos-t.pos}function Ve(e,t,n){var r=function(e,t,n){for(var r,i=0,s=e.length;i<s;)n(e[r=i+s>>>1],t)<0?i=r+1:s=r;return i}(e,t,n);e.splice(r,0,t)}function He(e,t){for(var n,r,i=t,s=e.length;i<s;i++){var o=e[i],a=[o.id,o.opts,[]];r?(r[2].push(a),r=a):n=r=a}return n}function Fe(e,t){return e[0]<t[0]?-1:1}function $e(e,t){for(var n=[{tree1:e,tree2:t}],r=!1;n.length>0;){var i=n.pop(),s=i.tree1,o=i.tree2;(s[1].status||o[1].status)&&(s[1].status="available"===s[1].status||"available"===o[1].status?"available":"missing");for(var a=0;a<o[2].length;a++)if(s[2][0]){for(var c=!1,l=0;l<s[2].length;l++)s[2][l][0]===o[2][a][0]&&(n.push({tree1:s[2][l],tree2:o[2][a]}),c=!0);c||(r="new_branch",Ve(s[2],o[2][a],Fe))}else r="new_leaf",s[2][0]=o[2][a]}return{conflicts:r,tree:e}}function Ue(e,t,n){var r,i=[],s=!1,o=!1;if(!e.length)return{tree:[t],conflicts:"new_leaf"};for(var a=0,c=e.length;a<c;a++){var l=e[a];if(l.pos===t.pos&&l.ids[0]===t.ids[0])r=$e(l.ids,t.ids),i.push({pos:l.pos,ids:r.tree}),s=s||r.conflicts,o=!0;else if(!0!==n){var u=l.pos<t.pos?l:t,d=l.pos<t.pos?t:l,f=d.pos-u.pos,h=[],p=[];for(p.push({ids:u.ids,diff:f,parent:null,parentIdx:null});p.length>0;){var m=p.pop();if(0!==m.diff)for(var g=m.ids[2],v=0,y=g.length;v<y;v++)p.push({ids:g[v],diff:m.diff-1,parent:m.ids,parentIdx:v});else m.ids[0]===d.ids[0]&&h.push(m)}var b=h[0];b?(r=$e(b.ids,d.ids),b.parent[2][b.parentIdx]=r.tree,i.push({pos:u.pos,ids:u.ids}),s=s||r.conflicts,o=!0):i.push(l)}else i.push(l)}return o||i.push(t),i.sort(De),{tree:i,conflicts:s||"internal_node"}}function ze(e,t,n){var r=Ue(e,t),i=function(e,t){for(var n,r,i=Re(e),s=0,o=i.length;s<o;s++){var a,c=i[s],l=c.ids;if(l.length>t){n||(n={});var u=l.length-t;a={pos:c.pos+u,ids:He(l,u)};for(var d=0;d<u;d++){var f=c.pos+d+"-"+l[d].id;n[f]=!0}}else a={pos:c.pos,ids:He(l,0)};r=r?Ue(r,a,!0).tree:[a]}return n&&qe(r,(function(e,t,r){delete n[t+"-"+r]})),{tree:r,revs:n?Object.keys(n):[]}}(r.tree,n);return{tree:i.tree,stemmedRevs:i.revs,conflicts:r.conflicts}}function Ge(e){return e.ids}function Ke(e,t){t||(t=Ne(e));for(var n,r=t.substring(t.indexOf("-")+1),i=e.rev_tree.map(Ge);n=i.pop();){if(n[0]===r)return!!n[1].deleted;i=i.concat(n[2])}}function Je(e){return/^_local/.test(e)}function We(e,t,n){y.EventEmitter.call(this);var r=this;this.db=e;var i=(t=t?A(t):{}).complete=L((function(t,n){var i,o;t?(o="error",("listenerCount"in(i=r)?i.listenerCount(o):y.EventEmitter.listenerCount(i,o))>0&&r.emit("error",t)):r.emit("complete",n),r.removeAllListeners(),e.removeListener("destroyed",s)}));function s(){r.cancel()}n&&(r.on("complete",(function(e){n(null,e)})),r.on("error",n)),e.once("destroyed",s),t.onChange=function(e,t,n){r.isCancelled||function(e,t,n,r){try{e.emit("change",t,n,r)}catch(e){M("error",'Error in .on("change", function):',e)}}(r,e,t,n)};var o=new Promise((function(e,n){t.complete=function(t,r){t?n(t):e(r)}}));r.once("cancel",(function(){e.removeListener("destroyed",s),t.complete(null,{status:"cancelled"})})),this.then=o.then.bind(o),this.catch=o.catch.bind(o),this.then((function(e){i(null,e)}),i),e.taskqueue.isReady?r.validateChanges(t):e.taskqueue.addTask((function(e){e?t.complete(e):r.isCancelled?r.emit("cancel"):r.validateChanges(t)}))}function Ze(e,t,n){var r=[{rev:e._rev}];"all_docs"===n.style&&(r=Te(t.rev_tree).map((function(e){return{rev:e.rev}})));var i={id:t.id,changes:r,doc:e};return Ke(t,e._rev)&&(i.deleted=!0),n.conflicts&&(i.doc._conflicts=Me(t),i.doc._conflicts.length||delete i.doc._conflicts),i}function Xe(e,t){return e<t?-1:e>t?1:0}function Ye(e,t){return function(n,r){n||r[0]&&r[0].error?((n=n||r[0]).docId=t,e(n)):e(null,r.length?r[0]:r)}}function Qe(e,t){var n=Xe(e._id,t._id);return 0!==n?n:Xe(e._revisions?e._revisions.start:0,t._revisions?t._revisions.start:0)}function et(){for(var e in y.EventEmitter.call(this),et.prototype)"function"==typeof this[e]&&(this[e]=this[e].bind(this))}function tt(){this.isReady=!1,this.failed=!1,this.queue=[]}function nt(e,t){if(!(this instanceof nt))return new nt(e,t);var n=this;if(t=t||{},e&&"object"==typeof e&&(e=(t=e).name,delete t.name),void 0===t.deterministic_revs&&(t.deterministic_revs=!0),this.__opts=t=A(t),n.auto_compaction=t.auto_compaction,n.prefix=nt.prefix,"string"!=typeof e)throw new Error("Missing/invalid DB name");var r=function(e,t){var n=e.match(/([a-z-]*):\/\/(.*)/);if(n)return{name:/https?/.test(n[1])?n[1]+"://"+n[2]:n[2],adapter:n[1]};var r=nt.adapters,i=nt.preferredAdapters,s=nt.prefix,o=t.adapter;if(!o)for(var a=0;a<i.length&&("idb"===(o=i[a])&&"websql"in r&&j()&&localStorage["_pouch__websqldb_"+s+e]);++a)M("log",'PouchDB is downgrading "'+e+'" to WebSQL to avoid data loss, because it was already opened with WebSQL.');var c=r[o];return{name:!(c&&"use_prefix"in c)||c.use_prefix?s+e:e,adapter:o}}((t.prefix||"")+e,t);if(t.name=r.name,t.adapter=t.adapter||r.adapter,n.name=e,n._adapter=t.adapter,nt.emit("debug",["adapter","Picked adapter: ",t.adapter]),!nt.adapters[t.adapter]||!nt.adapters[t.adapter].valid())throw new Error("Invalid Adapter: "+t.adapter);et.call(n),n.taskqueue=new tt,n.adapter=t.adapter,nt.adapters[t.adapter].call(n,t,(function(e){if(e)return n.taskqueue.fail(e);!function(e){function t(t){e.removeListener("closed",n),t||e.constructor.emit("destroyed",e.name)}function n(){e.removeListener("destroyed",t),e.constructor.emit("unref",e)}e.once("destroyed",t),e.once("closed",n),e.constructor.emit("ref",e)}(n),n.emit("created",n),nt.emit("created",n.name),n.taskqueue.ready(n)}))}v()(We,y.EventEmitter),We.prototype.cancel=function(){this.isCancelled=!0,this.db.taskqueue.isReady&&this.emit("cancel")},We.prototype.validateChanges=function(e){var t=e.complete,n=this;nt._changesFilterPlugin?nt._changesFilterPlugin.validate(e,(function(r){if(r)return t(r);n.doChanges(e)})):n.doChanges(e)},We.prototype.doChanges=function(e){var t=this,n=e.complete;if("live"in(e=A(e))&&!("continuous"in e)&&(e.continuous=e.live),e.processChange=Ze,"latest"===e.since&&(e.since="now"),e.since||(e.since=0),"now"!==e.since){if(nt._changesFilterPlugin){if(nt._changesFilterPlugin.normalize(e),nt._changesFilterPlugin.shouldFilter(this,e))return nt._changesFilterPlugin.filter(this,e)}else["doc_ids","filter","selector","view"].forEach((function(t){t in e&&M("warn",'The "'+t+'" option was passed in to changes/replicate, but pouchdb-changes-filter plugin is not installed, so it was ignored. Please install the plugin to enable filtering.')}));"descending"in e||(e.descending=!1),e.limit=0===e.limit?1:e.limit,e.complete=n;var r=this.db._changes(e);if(r&&"function"==typeof r.cancel){var i=t.cancel;t.cancel=m()((function(e){r.cancel(),i.apply(this,e)}))}}else this.db.info().then((function(r){t.isCancelled?n(null,{status:"cancelled"}):(e.since=r.update_seq,t.doChanges(e))}),n)},v()(et,y.EventEmitter),et.prototype.post=C("post",(function(e,t,n){if("function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e))return n(re(Q));this.bulkDocs({docs:[e]},t,Ye(n,e._id))})),et.prototype.put=C("put",(function(e,t,n){if("function"==typeof t&&(n=t,t={}),"object"!=typeof e||Array.isArray(e))return n(re(Q));if(ae(e._id),Je(e._id)&&"function"==typeof this._putLocal)return e._deleted?this._removeLocal(e,n):this._putLocal(e,n);var r,i,s,o,a=this;function c(n){"function"==typeof a._put&&!1!==t.new_edits?a._put(e,t,n):a.bulkDocs({docs:[e]},t,Ye(n,e._id))}t.force&&e._rev?(r=e._rev.split("-"),i=r[1],s=parseInt(r[0],10)+1,o=Pe(),e._revisions={start:s,ids:[o,i]},e._rev=s+"-"+o,t.new_edits=!1,c((function(t){var r=t?null:{ok:!0,id:e._id,rev:e._rev};n(t,r)}))):c(n)})),et.prototype.putAttachment=C("putAttachment",(function(e,t,n,r,i){var s=this;function o(e){var n="_rev"in e?parseInt(e._rev,10):0;return e._attachments=e._attachments||{},e._attachments[t]={content_type:i,data:r,revpos:++n},s.put(e)}return"function"==typeof i&&(i=r,r=n,n=null),void 0===i&&(i=r,r=n,n=null),i||M("warn","Attachment",t,"on document",e,"is missing content_type"),s.get(e).then((function(e){if(e._rev!==n)throw re(U);return o(e)}),(function(t){if(t.reason===$.message)return o({_id:e});throw t}))})),et.prototype.removeAttachment=C("removeAttachment",(function(e,t,n,r){var i=this;i.get(e,(function(e,s){if(e)r(e);else if(s._rev===n){if(!s._attachments)return r();delete s._attachments[t],0===Object.keys(s._attachments).length&&delete s._attachments,i.put(s,r)}else r(re(U))}))})),et.prototype.remove=C("remove",(function(e,t,n,r){var i;"string"==typeof t?(i={_id:e,_rev:t},"function"==typeof n&&(r=n,n={})):(i=e,"function"==typeof t?(r=t,n={}):(r=n,n=t)),(n=n||{}).was_delete=!0;var s={_id:i._id,_rev:i._rev||n.rev,_deleted:!0};if(Je(s._id)&&"function"==typeof this._removeLocal)return this._removeLocal(i,r);this.bulkDocs({docs:[s]},n,Ye(r,s._id))})),et.prototype.revsDiff=C("revsDiff",(function(e,t,n){"function"==typeof t&&(n=t,t={});var r=Object.keys(e);if(!r.length)return n(null,{});var i=0,o=new s;function a(e,t){o.has(e)||o.set(e,{missing:[]}),o.get(e).missing.push(t)}r.map((function(t){this._getRevisionTree(t,(function(s,c){if(s&&404===s.status&&"missing"===s.message)o.set(t,{missing:e[t]});else{if(s)return n(s);!function(t,n){var r=e[t].slice(0);qe(n,(function(e,n,i,s,o){var c=n+"-"+i,l=r.indexOf(c);-1!==l&&(r.splice(l,1),"available"!==o.status&&a(t,c))})),r.forEach((function(e){a(t,e)}))}(t,c)}if(++i===r.length){var l={};return o.forEach((function(e,t){l[t]=e})),n(null,l)}}))}),this)})),et.prototype.bulkGet=C("bulkGet",(function(e,t){q(this,e,t)})),et.prototype.compactDocument=C("compactDocument",(function(e,t,n){var r=this;this._getRevisionTree(e,(function(i,s){if(i)return n(i);var o=function(e){var t={},n=[];return qe(e,(function(e,r,i,s){var o=r+"-"+i;return e&&(t[o]=0),void 0!==s&&n.push({from:s,to:o}),o})),n.reverse(),n.forEach((function(e){void 0===t[e.from]?t[e.from]=1+t[e.to]:t[e.from]=Math.min(t[e.from],1+t[e.to])})),t}(s),a=[],c=[];Object.keys(o).forEach((function(e){o[e]>t&&a.push(e)})),qe(s,(function(e,t,n,r,i){var s=t+"-"+n;"available"===i.status&&-1!==a.indexOf(s)&&c.push(s)})),r._doCompaction(e,c,n)}))})),et.prototype.compact=C("compact",(function(e,t){"function"==typeof e&&(t=e,e={});e=e||{},this._compactionQueue=this._compactionQueue||[],this._compactionQueue.push({opts:e,callback:t}),1===this._compactionQueue.length&&function e(t){var n=t._compactionQueue[0],r=n.opts,i=n.callback;t.get("_local/compaction").catch((function(){return!1})).then((function(n){n&&n.last_seq&&(r.last_seq=n.last_seq),t._compact(r,(function(n,r){n?i(n):i(null,r),a()((function(){t._compactionQueue.shift(),t._compactionQueue.length&&e(t)}))}))}))}(this)})),et.prototype._compact=function(e,t){var n=this,r={return_docs:!1,last_seq:e.last_seq||0},i=[];n.changes(r).on("change",(function(e){i.push(n.compactDocument(e.id,0))})).on("complete",(function(e){var r=e.last_seq;Promise.all(i).then((function(){return ge(n,"_local/compaction",(function(e){return(!e.last_seq||e.last_seq<r)&&(e.last_seq=r,e)}))})).then((function(){t(null,{ok:!0})})).catch(t)})).on("error",t)},et.prototype.get=C("get",(function(e,t,n){if("function"==typeof t&&(n=t,t={}),"string"!=typeof e)return n(re(z));if(Je(e)&&"function"==typeof this._getLocal)return this._getLocal(e,n);var r=[],i=this;function s(){var s=[],o=r.length;if(!o)return n(null,s);r.forEach((function(r){i.get(e,{rev:r,revs:t.revs,latest:t.latest,attachments:t.attachments,binary:t.binary},(function(e,t){if(e)s.push({missing:r});else{for(var i,a=0,c=s.length;a<c;a++)if(s[a].ok&&s[a].ok._rev===t._rev){i=!0;break}i||s.push({ok:t})}--o||n(null,s)}))}))}if(!t.open_revs)return this._get(e,t,(function(r,s){if(r)return r.docId=e,n(r);var o=s.doc,a=s.metadata,c=s.ctx;if(t.conflicts){var l=Me(a);l.length&&(o._conflicts=l)}if(Ke(a,o._rev)&&(o._deleted=!0),t.revs||t.revs_info){for(var u=o._rev.split("-"),d=parseInt(u[0],10),f=u[1],h=Re(a.rev_tree),p=null,m=0;m<h.length;m++){var g=h[m],v=g.ids.map((function(e){return e.id})).indexOf(f);(v===d-1||!p&&-1!==v)&&(p=g)}if(!p)return(r=new Error("invalid rev tree")).docId=e,n(r);var y=p.ids.map((function(e){return e.id})).indexOf(o._rev.split("-")[1])+1,b=p.ids.length-y;if(p.ids.splice(y,b),p.ids.reverse(),t.revs&&(o._revisions={start:p.pos+p.ids.length-1,ids:p.ids.map((function(e){return e.id}))}),t.revs_info){var w=p.pos+p.ids.length;o._revs_info=p.ids.map((function(e){return{rev:--w+"-"+e.id,status:e.opts.status}}))}}if(t.attachments&&o._attachments){var _=o._attachments,E=Object.keys(_).length;if(0===E)return n(null,o);Object.keys(_).forEach((function(e){this._getAttachment(o._id,e,_[e],{rev:o._rev,binary:t.binary,ctx:c},(function(t,r){var i=o._attachments[e];i.data=r,delete i.stub,delete i.length,--E||n(null,o)}))}),i)}else{if(o._attachments)for(var k in o._attachments)o._attachments.hasOwnProperty(k)&&(o._attachments[k].stub=!0);n(null,o)}}));if("all"===t.open_revs)this._getRevisionTree(e,(function(e,t){if(e)return n(e);r=Te(t).map((function(e){return e.rev})),s()}));else{if(!Array.isArray(t.open_revs))return n(re(J,"function_clause"));r=t.open_revs;for(var o=0;o<r.length;o++){var a=r[o];if("string"!=typeof a||!/^\d+-/.test(a))return n(re(te))}s()}})),et.prototype.getAttachment=C("getAttachment",(function(e,t,n,r){var i=this;n instanceof Function&&(r=n,n={}),this._get(e,n,(function(s,o){return s?r(s):o.doc._attachments&&o.doc._attachments[t]?(n.ctx=o.ctx,n.binary=!0,void i._getAttachment(e,t,o.doc._attachments[t],n,r)):r(re($))}))})),et.prototype.allDocs=C("allDocs",(function(e,t){if("function"==typeof e&&(t=e,e={}),e.skip=void 0!==e.skip?e.skip:0,e.start_key&&(e.startkey=e.start_key),e.end_key&&(e.endkey=e.end_key),"keys"in e){if(!Array.isArray(e.keys))return t(new TypeError("options.keys must be an array"));var n=["startkey","endkey","key"].filter((function(t){return t in e}))[0];if(n)return void t(re(Z,"Query parameter `"+n+"` is not compatible with multi-get"));if(!ce(this)&&(function(e){var t="limit"in e?e.keys.slice(e.skip,e.limit+e.skip):e.skip>0?e.keys.slice(e.skip):e.keys;e.keys=t,e.skip=0,delete e.limit,e.descending&&(t.reverse(),e.descending=!1)}(e),0===e.keys.length))return this._allDocs({limit:0},t)}return this._allDocs(e,t)})),et.prototype.changes=function(e,t){return"function"==typeof e&&(t=e,e={}),(e=e||{}).return_docs="return_docs"in e?e.return_docs:!e.live,new We(this,e,t)},et.prototype.close=C("close",(function(e){return this._closed=!0,this.emit("closed"),this._close(e)})),et.prototype.info=C("info",(function(e){var t=this;this._info((function(n,r){if(n)return e(n);r.db_name=r.db_name||t.name,r.auto_compaction=!(!t.auto_compaction||ce(t)),r.adapter=t.adapter,e(null,r)}))})),et.prototype.id=C("id",(function(e){return this._id(e)})),et.prototype.type=function(){return"function"==typeof this._type?this._type():this.adapter},et.prototype.bulkDocs=C("bulkDocs",(function(e,t,n){if("function"==typeof t&&(n=t,t={}),t=t||{},Array.isArray(e)&&(e={docs:e}),!e||!e.docs||!Array.isArray(e.docs))return n(re(F));for(var r=0;r<e.docs.length;++r)if("object"!=typeof e.docs[r]||Array.isArray(e.docs[r]))return n(re(Q));var i;if(e.docs.forEach((function(e){e._attachments&&Object.keys(e._attachments).forEach((function(t){i=i||function(e){return"_"===e.charAt(0)&&e+" is not a valid attachment name, attachment names cannot start with '_'"}(t),e._attachments[t].content_type||M("warn","Attachment",t,"on document",e._id,"is missing content_type")}))})),i)return n(re(Y,i));"new_edits"in t||(t.new_edits=!("new_edits"in e)||e.new_edits);var s=this;t.new_edits||ce(s)||e.docs.sort(Qe),function(e){for(var t=0;t<e.length;t++){var n=e[t];if(n._deleted)delete n._attachments;else if(n._attachments)for(var r=Object.keys(n._attachments),i=0;i<r.length;i++){var s=r[i];n._attachments[s]=I(n._attachments[s],["data","digest","content_type","length","revpos","stub"])}}}(e.docs);var o=e.docs.map((function(e){return e._id}));return this._bulkDocs(e,t,(function(e,r){if(e)return n(e);if(t.new_edits||(r=r.filter((function(e){return e.error}))),!ce(s))for(var i=0,a=r.length;i<a;i++)r[i].id=r[i].id||o[i];n(null,r)}))})),et.prototype.registerDependentDatabase=C("registerDependentDatabase",(function(e,t){var n=new this.constructor(e,this.__opts);ge(this,"_local/_pouch_dependentDbs",(function(t){return t.dependentDbs=t.dependentDbs||{},!t.dependentDbs[e]&&(t.dependentDbs[e]=!0,t)})).then((function(){t(null,{db:n})})).catch(t)})),et.prototype.destroy=C("destroy",(function(e,t){"function"==typeof e&&(t=e,e={});var n=this,r=!("use_prefix"in n)||n.use_prefix;function i(){n._destroy(e,(function(e,r){if(e)return t(e);n._destroyed=!0,n.emit("destroyed"),t(null,r||{ok:!0})}))}if(ce(n))return i();n.get("_local/_pouch_dependentDbs",(function(e,s){if(e)return 404!==e.status?t(e):i();var o=s.dependentDbs,a=n.constructor,c=Object.keys(o).map((function(e){var t=r?e.replace(new RegExp("^"+a.prefix),""):e;return new a(t,n.__opts).destroy()}));Promise.all(c).then(i,t)}))})),tt.prototype.execute=function(){var e;if(this.failed)for(;e=this.queue.shift();)e(this.failed);else for(;e=this.queue.shift();)e()},tt.prototype.fail=function(e){this.failed=e,this.execute()},tt.prototype.ready=function(e){this.isReady=!0,this.db=e,this.execute()},tt.prototype.addTask=function(e){this.queue.push(e),this.failed&&this.execute()},v()(nt,et);var rt="undefined"!=typeof AbortController?AbortController:function(){return{abort:function(){}}},it=fetch,st=Headers;nt.adapters={},nt.preferredAdapters=[],nt.prefix="_pouch_";var ot=new y.EventEmitter;!function(e){Object.keys(y.EventEmitter.prototype).forEach((function(t){"function"==typeof y.EventEmitter.prototype[t]&&(e[t]=ot[t].bind(ot))}));var t=e._destructionListeners=new s;e.on("ref",(function(e){t.has(e.name)||t.set(e.name,[]),t.get(e.name).push(e)})),e.on("unref",(function(e){if(t.has(e.name)){var n=t.get(e.name),r=n.indexOf(e);r<0||(n.splice(r,1),n.length>1?t.set(e.name,n):t.delete(e.name))}})),e.on("destroyed",(function(e){if(t.has(e)){var n=t.get(e);t.delete(e),n.forEach((function(e){e.emit("destroyed",!0)}))}}))}(nt),nt.adapter=function(e,t,n){t.valid()&&(nt.adapters[e]=t,n&&nt.preferredAdapters.push(e))},nt.plugin=function(e){if("function"==typeof e)e(nt);else{if("object"!=typeof e||0===Object.keys(e).length)throw new Error('Invalid plugin: got "'+e+'", expected an object or a function');Object.keys(e).forEach((function(t){nt.prototype[t]=e[t]}))}return this.__defaults&&(nt.__defaults=V({},this.__defaults)),nt},nt.defaults=function(e){function t(e,n){if(!(this instanceof t))return new t(e,n);n=n||{},e&&"object"==typeof e&&(e=(n=e).name,delete n.name),n=V({},t.__defaults,n),nt.call(this,e,n)}return v()(t,nt),t.preferredAdapters=nt.preferredAdapters.slice(),Object.keys(nt).forEach((function(e){e in t||(t[e]=nt[e])})),t.__defaults=V({},this.__defaults,e),t},nt.fetch=function(e,t){return it(e,t)};function at(e,t){for(var n=e,r=0,i=t.length;r<i;r++){if(!(n=n[t[r]]))break}return n}function ct(e){for(var t=[],n="",r=0,i=e.length;r<i;r++){var s=e[r];"."===s?r>0&&"\\"===e[r-1]?n=n.substring(0,n.length-1)+".":(t.push(n),n=""):n+=s}return t.push(n),t}var lt=["$or","$nor","$not"];function ut(e){return lt.indexOf(e)>-1}function dt(e){return Object.keys(e)[0]}function ft(e){var t={};return e.forEach((function(e){Object.keys(e).forEach((function(n){var r=e[n];if("object"!=typeof r&&(r={$eq:r}),ut(n))t[n]=r instanceof Array?r.map((function(e){return ft([e])})):ft([r]);else{var i=t[n]=t[n]||{};Object.keys(r).forEach((function(e){var t=r[e];return"$gt"===e||"$gte"===e?function(e,t,n){if(void 0!==n.$eq)return;void 0!==n.$gte?"$gte"===e?t>n.$gte&&(n.$gte=t):t>=n.$gte&&(delete n.$gte,n.$gt=t):void 0!==n.$gt?"$gte"===e?t>n.$gt&&(delete n.$gt,n.$gte=t):t>n.$gt&&(n.$gt=t):n[e]=t}(e,t,i):"$lt"===e||"$lte"===e?function(e,t,n){if(void 0!==n.$eq)return;void 0!==n.$lte?"$lte"===e?t<n.$lte&&(n.$lte=t):t<=n.$lte&&(delete n.$lte,n.$lt=t):void 0!==n.$lt?"$lte"===e?t<n.$lt&&(delete n.$lt,n.$lte=t):t<n.$lt&&(n.$lt=t):n[e]=t}(e,t,i):"$ne"===e?function(e,t){"$ne"in t?t.$ne.push(e):t.$ne=[e]}(t,i):"$eq"===e?function(e,t){delete t.$gt,delete t.$gte,delete t.$lt,delete t.$lte,delete t.$ne,t.$eq=e}(t,i):void(i[e]=t)}))}}))})),t}function ht(e){var t=A(e),n=!1;(function e(t,n){for(var r in t){"$and"===r&&(n=!0);var i=t[r];"object"==typeof i&&(n=e(i,n))}return n})(t,!1)&&("$and"in(t=function e(t){for(var n in t){if(Array.isArray(t))for(var r in t)t[r].$and&&(t[r]=ft(t[r].$and));var i=t[n];"object"==typeof i&&e(i)}return t}(t))&&(t=ft(t.$and)),n=!0),["$or","$nor"].forEach((function(e){e in t&&t[e].forEach((function(e){for(var t=Object.keys(e),n=0;n<t.length;n++){var r=t[n],i=e[r];"object"==typeof i&&null!==i||(e[r]={$eq:i})}}))})),"$not"in t&&(t.$not=ft([t.$not]));for(var r=Object.keys(t),i=0;i<r.length;i++){var s=r[i],o=t[s];"object"!=typeof o||null===o?o={$eq:o}:"$ne"in o&&!n&&(o.$ne=[o.$ne]),t[s]=o}return t}function pt(e,t){if(e===t)return 0;e=mt(e),t=mt(t);var n=wt(e),r=wt(t);if(n-r!=0)return n-r;switch(typeof e){case"number":return e-t;case"boolean":return e<t?-1:1;case"string":return function(e,t){return e===t?0:e>t?1:-1}(e,t)}return Array.isArray(e)?function(e,t){for(var n=Math.min(e.length,t.length),r=0;r<n;r++){var i=pt(e[r],t[r]);if(0!==i)return i}return e.length===t.length?0:e.length>t.length?1:-1}(e,t):function(e,t){for(var n=Object.keys(e),r=Object.keys(t),i=Math.min(n.length,r.length),s=0;s<i;s++){var o=pt(n[s],r[s]);if(0!==o)return o;if(0!==(o=pt(e[n[s]],t[r[s]])))return o}return n.length===r.length?0:n.length>r.length?1:-1}(e,t)}function mt(e){switch(typeof e){case"undefined":return null;case"number":return e===1/0||e===-1/0||isNaN(e)?null:e;case"object":var t=e;if(Array.isArray(e)){var n=e.length;e=new Array(n);for(var r=0;r<n;r++)e[r]=mt(t[r])}else{if(e instanceof Date)return e.toJSON();if(null!==e)for(var i in e={},t)if(t.hasOwnProperty(i)){var s=t[i];void 0!==s&&(e[i]=mt(s))}}}return e}function gt(e){if(null!==e)switch(typeof e){case"boolean":return e?1:0;case"number":return function(e){if(0===e)return"1";var t=e.toExponential().split(/e\+?/),n=parseInt(t[1],10),r=e<0,i=r?"0":"2",s=(o=((r?-n:n)- -324).toString(),a="0",c=3,function(e,t,n){for(var r="",i=n-e.length;r.length<i;)r+=t;return r}(o,a,c)+o);var o,a,c;i+=""+s;var l=Math.abs(parseFloat(t[0]));r&&(l=10-l);var u=l.toFixed(20);return u=u.replace(/\.?0+$/,""),i+=""+u}(e);case"string":return e.replace(/\u0002/g,"").replace(/\u0001/g,"").replace(/\u0000/g,"");case"object":var t=Array.isArray(e),n=t?e:Object.keys(e),r=-1,i=n.length,s="";if(t)for(;++r<i;)s+=vt(n[r]);else for(;++r<i;){var o=n[r];s+=vt(o)+vt(e[o])}return s}return""}function vt(e){return wt(e=mt(e))+""+gt(e)+"\0"}function yt(e,t){var n,r=t;if("1"===e[t])n=0,t++;else{var i="0"===e[t];t++;var s="",o=e.substring(t,t+3),a=parseInt(o,10)+-324;for(i&&(a=-a),t+=3;;){var c=e[t];if("\0"===c)break;s+=c,t++}n=1===(s=s.split(".")).length?parseInt(s,10):parseFloat(s[0]+"."+s[1]),i&&(n-=10),0!==a&&(n=parseFloat(n+"e"+a))}return{num:n,length:t-r}}function bt(e,t){var n=e.pop();if(t.length){var r=t[t.length-1];n===r.element&&(t.pop(),r=t[t.length-1]);var i=r.element,s=r.index;if(Array.isArray(i))i.push(n);else if(s===e.length-2){i[e.pop()]=n}else e.push(n)}}function wt(e){var t=["boolean","number","string","object"].indexOf(typeof e);return~t?null===e?1:Array.isArray(e)?5:t<3?t+2:t+3:Array.isArray(e)?5:void 0}function _t(e,t,n){if(e=e.filter((function(e){return Et(e.doc,t.selector,n)})),t.sort){var r=function(e){function t(t){return e.map((function(e){var n=ct(dt(e));return at(t,n)}))}return function(e,n){var r,i,s=pt(t(e.doc),t(n.doc));return 0!==s?s:(r=e.doc._id,i=n.doc._id,r<i?-1:r>i?1:0)}}(t.sort);e=e.sort(r),"string"!=typeof t.sort[0]&&"desc"===(i=t.sort[0])[dt(i)]&&(e=e.reverse())}var i;if("limit"in t||"skip"in t){var s=t.skip||0,o=("limit"in t?t.limit:e.length)+s;e=e.slice(s,o)}return e}function Et(e,t,n){return n.every((function(n){var r=t[n],i=ct(n),s=at(e,i);return ut(n)?function(e,t,n){if("$or"===e)return t.some((function(e){return Et(n,e,Object.keys(e))}));if("$not"===e)return!Et(n,t,Object.keys(t));return!t.find((function(e){return Et(n,e,Object.keys(e))}))}(n,r,e):kt(r,e,i,s)}))}function kt(e,t,n,r){return!e||("object"==typeof e?Object.keys(e).every((function(i){var s=e[i];return function(e,t,n,r,i){if(!Lt[e])throw new Error('unknown operator "'+e+'" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, $nin, $size, $mod, $regex, $elemMatch, $type, $allMatch or $all');return Lt[e](t,n,r,i)}(i,t,s,n,r)})):e===r)}function xt(e){return null!=e}function St(e){return void 0!==e}function At(e,t){return t.some((function(t){return e instanceof Array?e.indexOf(t)>-1:e===t}))}var Lt={$elemMatch:function(e,t,n,r){return!!Array.isArray(r)&&(0!==r.length&&("object"==typeof r[0]?r.some((function(e){return Et(e,t,Object.keys(t))})):r.some((function(r){return kt(t,e,n,r)}))))},$allMatch:function(e,t,n,r){return!!Array.isArray(r)&&(0!==r.length&&("object"==typeof r[0]?r.every((function(e){return Et(e,t,Object.keys(t))})):r.every((function(r){return kt(t,e,n,r)}))))},$eq:function(e,t,n,r){return St(r)&&0===pt(r,t)},$gte:function(e,t,n,r){return St(r)&&pt(r,t)>=0},$gt:function(e,t,n,r){return St(r)&&pt(r,t)>0},$lte:function(e,t,n,r){return St(r)&&pt(r,t)<=0},$lt:function(e,t,n,r){return St(r)&&pt(r,t)<0},$exists:function(e,t,n,r){return t?St(r):!St(r)},$mod:function(e,t,n,r){return xt(r)&&function(e,t){var n=t[0],r=t[1];if(0===n)throw new Error("Bad divisor, cannot divide by zero");if(parseInt(n,10)!==n)throw new Error("Divisor is not an integer");if(parseInt(r,10)!==r)throw new Error("Modulus is not an integer");return parseInt(e,10)===e&&e%n===r}(r,t)},$ne:function(e,t,n,r){return t.every((function(e){return 0!==pt(r,e)}))},$in:function(e,t,n,r){return xt(r)&&At(r,t)},$nin:function(e,t,n,r){return xt(r)&&!At(r,t)},$size:function(e,t,n,r){return xt(r)&&function(e,t){return e.length===t}(r,t)},$all:function(e,t,n,r){return Array.isArray(r)&&function(e,t){return t.every((function(t){return e.indexOf(t)>-1}))}(r,t)},$regex:function(e,t,n,r){return xt(r)&&function(e,t){return new RegExp(t).test(e)}(r,t)},$type:function(e,t,n,r){return function(e,t){switch(t){case"null":return null===e;case"boolean":return"boolean"==typeof e;case"number":return"number"==typeof e;case"string":return"string"==typeof e;case"array":return e instanceof Array;case"object":return"[object Object]"==={}.toString.call(e)}throw new Error(t+" not supported as a type.Please use one of object, string, array, number, boolean or null.")}(r,t)}};function Bt(e,t){if(e.selector&&e.filter&&"_selector"!==e.filter){var n="string"==typeof e.filter?e.filter:"function";return t(new Error('selector invalid for filter "'+n+'"'))}t()}function Ct(e){e.view&&!e.filter&&(e.filter="_view"),e.selector&&!e.filter&&(e.filter="_selector"),e.filter&&"string"==typeof e.filter&&("_view"===e.filter?e.view=ue(e.view):e.filter=ue(e.filter))}function It(e,t){return t.filter&&"string"==typeof t.filter&&!t.doc_ids&&!ce(e.db)}function Pt(e,t){var n=t.complete;if("_view"===t.filter){if(!t.view||"string"!=typeof t.view){var r=re(Y,"`view` filter parameter not found or invalid.");return n(r)}var i=le(t.view);e.db.get("_design/"+i[0],(function(r,s){if(e.isCancelled)return n(null,{status:"cancelled"});if(r)return n(ie(r));var o=s&&s.views&&s.views[i[1]]&&s.views[i[1]].map;if(!o)return n(re($,s.views?"missing json key: "+i[1]:"missing json key: views"));t.filter=me(["return function(doc) {",'  "use strict";',"  var emitted = false;","  var emit = function (a, b) {","    emitted = true;","  };","  var view = "+o+";","  view(doc);","  if (emitted) {","    return true;","  }","};"].join("\n"),{}),e.doChanges(t)}))}else if(t.selector)t.filter=function(e){return function(e,t){if("object"!=typeof t)throw new Error("Selector error: expected a JSON object");var n=_t([{doc:e}],{selector:t=ht(t)},Object.keys(t));return n&&1===n.length}(e,t.selector)},e.doChanges(t);else{var s=le(t.filter);e.db.get("_design/"+s[0],(function(r,i){if(e.isCancelled)return n(null,{status:"cancelled"});if(r)return n(ie(r));var o=i&&i.filters&&i.filters[s[1]];if(!o)return n(re($,i&&i.filters?"missing json key: "+s[1]:"missing json key: filters"));t.filter=me('"use strict";\nreturn '+o+";",{}),e.doChanges(t)}))}}function Ot(e){return e.reduce((function(e,t){return e[t]=!0,e}),{})}nt.plugin((function(e){e._changesFilterPlugin={validate:Bt,normalize:Ct,shouldFilter:It,filter:Pt}})),nt.version="7.2.1";var Nt=Ot(["_id","_rev","_attachments","_deleted","_revisions","_revs_info","_conflicts","_deleted_conflicts","_local_seq","_rev_tree","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats","_removed"]),qt=Ot(["_attachments","_replication_id","_replication_state","_replication_state_time","_replication_state_reason","_replication_stats"]);function jt(e){if(!/^\d+-/.test(e))return re(te);var t=e.indexOf("-"),n=e.substring(0,t),r=e.substring(t+1);return{prefix:parseInt(n,10),id:r}}function Tt(e,t,n){var r,i,s;n||(n={deterministic_revs:!0});var o={status:"available"};if(e._deleted&&(o.deleted=!0),t)if(e._id||(e._id=Oe()),i=Pe(e,n.deterministic_revs),e._rev){if((s=jt(e._rev)).error)return s;e._rev_tree=[{pos:s.prefix,ids:[s.id,{status:"missing"},[[i,o,[]]]]}],r=s.prefix+1}else e._rev_tree=[{pos:1,ids:[i,o,[]]}],r=1;else if(e._revisions&&(e._rev_tree=function(e,t){for(var n=e.start-e.ids.length+1,r=e.ids,i=[r[0],t,[]],s=1,o=r.length;s<o;s++)i=[r[s],{status:"missing"},[i]];return[{pos:n,ids:i}]}(e._revisions,o),r=e._revisions.start,i=e._revisions.ids[0]),!e._rev_tree){if((s=jt(e._rev)).error)return s;r=s.prefix,i=s.id,e._rev_tree=[{pos:r,ids:[i,o,[]]}]}ae(e._id),e._rev=r+"-"+i;var a={metadata:{},data:{}};for(var c in e)if(Object.prototype.hasOwnProperty.call(e,c)){var l="_"===c[0];if(l&&!Nt[c]){var u=re(X,c);throw u.message=X.message+": "+c,u}l&&!qt[c]?a.metadata[c.slice(1)]=e[c]:a.data[c]=e[c]}return a}function Mt(e,t,n){var r=function(e){try{return ve(e)}catch(e){return{error:re(W,"Attachment is not a valid base64 string")}}}(e.data);if(r.error)return n(r.error);e.length=r.length,e.data="blob"===t?_e(r,e.content_type):"base64"===t?ye(r):r,Ce(r,(function(t){e.digest="md5-"+t,n()}))}function Rt(e,t,n){if(e.stub)return n();"string"==typeof e.data?Mt(e,t,n):function(e,t,n){Ce(e.data,(function(r){e.digest="md5-"+r,e.length=e.data.size||e.data.length||0,"binary"===t?xe(e.data,(function(t){e.data=t,n()})):"base64"===t?Se(e.data,(function(t){e.data=t,n()})):n()}))}(e,t,n)}function Dt(e,t,n,r,i,s,o,a){if(function(e,t){for(var n,r=e.slice(),i=t.split("-"),s=parseInt(i[0],10),o=i[1];n=r.pop();){if(n.pos===s&&n.ids[0]===o)return!0;for(var a=n.ids[2],c=0,l=a.length;c<l;c++)r.push({pos:n.pos+1,ids:a[c]})}return!1}(t.rev_tree,n.metadata.rev)&&!a)return r[i]=n,s();var c=t.winningRev||Ne(t),l="deleted"in t?t.deleted:Ke(t,c),u="deleted"in n.metadata?n.metadata.deleted:Ke(n.metadata),d=/^1-/.test(n.metadata.rev);if(l&&!u&&a&&d){var f=n.data;f._rev=c,f._id=n.metadata.id,n=Tt(f,a)}var h=ze(t.rev_tree,n.metadata.rev_tree[0],e);if(a&&(l&&u&&"new_leaf"!==h.conflicts||!l&&"new_leaf"!==h.conflicts||l&&!u&&"new_branch"===h.conflicts)){var p=re(U);return r[i]=p,s()}var m=n.metadata.rev;n.metadata.rev_tree=h.tree,n.stemmedRevs=h.stemmedRevs||[],t.rev_map&&(n.metadata.rev_map=t.rev_map);var g=Ne(n.metadata),v=Ke(n.metadata,g),y=l===v?0:l<v?-1:1;o(n,g,v,m===g?v:Ke(n.metadata,m),!0,y,i,s)}function Vt(e,t,n,r,i,o,a,c,l){e=e||1e3;var u=c.new_edits,d=new s,f=0,h=t.length;function p(){++f===h&&l&&l()}t.forEach((function(e,t){if(e._id&&Je(e._id)){var r=e._deleted?"_removeLocal":"_putLocal";n[r](e,{ctx:i},(function(e,n){o[t]=e||n,p()}))}else{var s=e.metadata.id;d.has(s)?(h--,d.get(s).push([e,t])):d.set(s,[[e,t]])}})),d.forEach((function(t,n){var i=0;function s(){++i<t.length?l():p()}function l(){var l=t[i],d=l[0],f=l[1];if(r.has(n))Dt(e,r.get(n),d,o,f,s,a,u);else{var h=ze([],d.metadata.rev_tree[0],e);d.metadata.rev_tree=h.tree,d.stemmedRevs=h.stemmedRevs||[],function(e,t,n){var r=Ne(e.metadata),i=Ke(e.metadata,r);if("was_delete"in c&&i)return o[t]=re($,"deleted"),n();if(u&&function(e){return"missing"===e.metadata.rev_tree[0].ids[1].status}(e)){var s=re(U);return o[t]=s,n()}a(e,r,i,i,!1,i?0:1,t,n)}(d,f,s)}}l()}))}var Ht="document-store",Ft="meta-store";function $t(e){try{return JSON.stringify(e)}catch(t){return h.a.stringify(e)}}function Ut(e){return function(t){var n="unknown_error";t.target&&t.target.error&&(n=t.target.error.name||t.target.error.message),e(re(ee,n,t.type))}}function zt(e,t,n){return{data:$t(e),winningRev:t,deletedOrLocal:n?"1":"0",seq:e.seq,id:e.id}}function Gt(e){if(!e)return null;var t=function(e){try{return JSON.parse(e)}catch(t){return h.a.parse(e)}}(e.data);return t.winningRev=e.winningRev,t.deleted="1"===e.deletedOrLocal,t.seq=e.seq,t}function Kt(e){if(!e)return e;var t=e._doc_id_rev.lastIndexOf(":");return e._id=e._doc_id_rev.substring(0,t-1),e._rev=e._doc_id_rev.substring(t+1),delete e._doc_id_rev,e}function Jt(e,t,n,r){n?r(e?"string"!=typeof e?e:Ee(e,t):be([""],{type:t})):e?"string"!=typeof e?ke(e,(function(e){r(ye(e))})):r(e):r("")}function Wt(e,t,n,r){var i=Object.keys(e._attachments||{});if(!i.length)return r&&r();var s=0;function o(){++s===i.length&&r&&r()}i.forEach((function(r){t.attachments&&t.include_docs?function(e,t){var r=e._attachments[t],i=r.digest;n.objectStore("attach-store").get(i).onsuccess=function(e){r.body=e.target.result.body,o()}}(e,r):(e._attachments[r].stub=!0,o())}))}function Zt(e,t){return Promise.all(e.map((function(e){if(e.doc&&e.doc._attachments){var n=Object.keys(e.doc._attachments);return Promise.all(n.map((function(n){var r=e.doc._attachments[n];if("body"in r){var i=r.body,s=r.content_type;return new Promise((function(o){Jt(i,s,t,(function(t){e.doc._attachments[n]=V(I(r,["digest","content_type"]),{data:t}),o()}))}))}})))}})))}function Xt(e,t,n){var r=[],i=n.objectStore("by-sequence"),s=n.objectStore("attach-store"),o=n.objectStore("attach-seq-store"),a=e.length;function c(){--a||function(){if(!r.length)return;r.forEach((function(e){o.index("digestSeq").count(IDBKeyRange.bound(e+"::",e+"::",!1,!1)).onsuccess=function(t){t.target.result||s.delete(e)}}))}()}e.forEach((function(e){var n=i.index("_doc_id_rev"),s=t+"::"+e;n.getKey(s).onsuccess=function(e){var t=e.target.result;if("number"!=typeof t)return c();i.delete(t),o.index("seq").openCursor(IDBKeyRange.only(t)).onsuccess=function(e){var t=e.target.result;if(t){var n=t.value.digestSeq.split("::")[0];r.push(n),o.delete(t.primaryKey),t.continue()}else c()}}}))}function Yt(e,t,n){try{return{txn:e.transaction(t,n)}}catch(e){return{error:e}}}var Qt=new T;function en(e,t,n,r,i,o){for(var a,c,l,u,d,f,h,p,m=t.docs,g=0,v=m.length;g<v;g++){var y=m[g];y._id&&Je(y._id)||(y=m[g]=Tt(y,n.new_edits,e)).error&&!h&&(h=y)}if(h)return o(h);var b=!1,w=0,_=new Array(m.length),E=new s,k=!1,x=r._meta.blobSupport?"blob":"base64";function S(){b=!0,A()}function A(){p&&b&&(p.docCount+=w,f.put(p))}function L(){k||(Qt.notify(r._meta.name),o(null,_))}function B(e,t,n,r,i,s,o,a){e.metadata.winningRev=t,e.metadata.deleted=n;var c=e.data;if(c._id=e.metadata.id,c._rev=e.metadata.rev,r&&(c._deleted=!0),c._attachments&&Object.keys(c._attachments).length)return function(e,t,n,r,i,s){var o=e.data,a=0,c=Object.keys(o._attachments);function l(){a===c.length&&C(e,t,n,r,i,s)}function d(){a++,l()}c.forEach((function(n){var r=e.data._attachments[n];if(r.stub)a++,l();else{var i=r.data;delete r.data,r.revpos=parseInt(t,10),function(e,t,n){u.count(e).onsuccess=function(r){if(r.target.result)return n();var i={digest:e,body:t};u.put(i).onsuccess=n}}(r.digest,i,d)}}))}(e,t,n,i,o,a);w+=s,A(),C(e,t,n,i,o,a)}function C(e,t,n,i,s,o){var u=e.data,f=e.metadata;function h(s){var o=e.stemmedRevs||[];i&&r.auto_compaction&&(o=o.concat(function(e){var t=[];return qe(e.rev_tree,(function(e,n,r,i,s){"available"!==s.status||e||(t.push(n+"-"+r),s.status="missing")})),t}(e.metadata))),o&&o.length&&Xt(o,e.metadata.id,a),f.seq=s.target.result;var l=zt(f,t,n);c.put(l).onsuccess=p}function p(){_[s]={ok:!0,id:f.id,rev:f.rev},E.set(e.metadata.id,e.metadata),function(e,t,n){var r=0,i=Object.keys(e.data._attachments||{});if(!i.length)return n();function s(){++r===i.length&&n()}function o(n){var r=e.data._attachments[n].digest,i=d.put({seq:t,digestSeq:r+"::"+t});i.onsuccess=s,i.onerror=function(e){e.preventDefault(),e.stopPropagation(),s()}}for(var a=0;a<i.length;a++)o(i[a])}(e,f.seq,o)}u._doc_id_rev=f.id+"::"+f.rev,delete u._id,delete u._rev;var m=l.put(u);m.onsuccess=h,m.onerror=function(e){e.preventDefault(),e.stopPropagation(),l.index("_doc_id_rev").getKey(u._doc_id_rev).onsuccess=function(e){l.put(u,e.target.result).onsuccess=h}}}!function(e,t,n){if(!e.length)return n();var r,i=0;function s(){i++,e.length===i&&(r?n(r):n())}e.forEach((function(e){var n=e.data&&e.data._attachments?Object.keys(e.data._attachments):[],i=0;if(!n.length)return s();function o(e){r=e,++i===n.length&&s()}for(var a in e.data._attachments)e.data._attachments.hasOwnProperty(a)&&Rt(e.data._attachments[a],t,o)}))}(m,x,(function(t){if(t)return o(t);!function(){var t=Yt(i,[Ht,"by-sequence","attach-store","local-store","attach-seq-store",Ft],"readwrite");if(t.error)return o(t.error);(a=t.txn).onabort=Ut(o),a.ontimeout=Ut(o),a.oncomplete=L,c=a.objectStore(Ht),l=a.objectStore("by-sequence"),u=a.objectStore("attach-store"),d=a.objectStore("attach-seq-store"),(f=a.objectStore(Ft)).get(Ft).onsuccess=function(e){p=e.target.result,A()},function(e){var t=[];if(m.forEach((function(e){e.data&&e.data._attachments&&Object.keys(e.data._attachments).forEach((function(n){var r=e.data._attachments[n];r.stub&&t.push(r.digest)}))})),!t.length)return e();var n,r=0;t.forEach((function(i){!function(e,t){u.get(e).onsuccess=function(n){if(n.target.result)t();else{var r=re(ne,"unknown stub attachment with digest "+e);r.status=412,t(r)}}}(i,(function(i){i&&!n&&(n=i),++r===t.length&&e(n)}))}))}((function(t){if(t)return k=!0,o(t);!function(){if(!m.length)return;var t=0;function i(){++t===m.length&&Vt(e.revs_limit,m,r,E,a,_,B,n,S)}function s(e){var t=Gt(e.target.result);t&&E.set(t.id,t),i()}for(var o=0,l=m.length;o<l;o++){var u=m[o];if(u._id&&Je(u._id))i();else c.get(u.metadata.id).onsuccess=s}}()}))}()}))}function tn(e,t,n,r,i){var s,o,a;function c(e){o=e.target.result,s&&i(s,o,a)}function l(e){s=e.target.result,o&&i(s,o,a)}function u(e){var t=e.target.result;if(!t)return i();i([t.key],[t.value],t)}-1===r&&(r=1e3),"function"==typeof e.getAll&&"function"==typeof e.getAllKeys&&r>1&&!n?(a={continue:function(){if(!s.length)return i();var n,a=s[s.length-1];if(t&&t.upper)try{n=IDBKeyRange.bound(a,t.upper,!0,t.upperOpen)}catch(e){if("DataError"===e.name&&0===e.code)return i()}else n=IDBKeyRange.lowerBound(a,!0);t=n,s=null,o=null,e.getAll(t,r).onsuccess=c,e.getAllKeys(t,r).onsuccess=l}},e.getAll(t,r).onsuccess=c,e.getAllKeys(t,r).onsuccess=l):n?e.openCursor(t,"prev").onsuccess=u:e.openCursor(t).onsuccess=u}function nn(e,t,n){var r,i,s="startkey"in e&&e.startkey,o="endkey"in e&&e.endkey,a="key"in e&&e.key,c="keys"in e&&e.keys,l=e.skip||0,u="number"==typeof e.limit?e.limit:-1,d=!1!==e.inclusive_end;if(!c&&(i=(r=function(e,t,n,r,i){try{if(e&&t)return i?IDBKeyRange.bound(t,e,!n,!1):IDBKeyRange.bound(e,t,!1,!n);if(e)return i?IDBKeyRange.upperBound(e):IDBKeyRange.lowerBound(e);if(t)return i?IDBKeyRange.lowerBound(t,!n):IDBKeyRange.upperBound(t,!n);if(r)return IDBKeyRange.only(r)}catch(e){return{error:e}}return null}(s,o,d,a,e.descending))&&r.error)&&("DataError"!==i.name||0!==i.code))return n(re(ee,i.name,i.message));var f=[Ht,"by-sequence",Ft];e.attachments&&f.push("attach-store");var h=Yt(t,f,"readonly");if(h.error)return n(h.error);var p=h.txn;p.oncomplete=function(){e.attachments?Zt(E,e.binary).then(A):A()},p.onabort=Ut(n);var m,g,v,y=p.objectStore(Ht),b=p.objectStore("by-sequence"),w=p.objectStore(Ft),_=b.index("_doc_id_rev"),E=[];function k(t,n){var r={id:n.id,key:n.id,value:{rev:t}};n.deleted?c&&(E.push(r),r.value.deleted=!0,r.doc=null):l--<=0&&(E.push(r),e.include_docs&&function(t,n,r){var i=t.id+"::"+r;_.get(i).onsuccess=function(r){if(n.doc=Kt(r.target.result)||{},e.conflicts){var i=Me(t);i.length&&(n.doc._conflicts=i)}Wt(n.doc,e,p)}}(n,r,t))}function x(e){for(var t=0,n=e.length;t<n&&E.length!==u;t++){var r=e[t];if(r.error&&c)E.push(r);else{var i=Gt(r);k(i.winningRev,i)}}}function S(e,t,n){n&&(x(t),E.length<u&&n.continue())}function A(){var t={total_rows:m,offset:e.skip,rows:E};e.update_seq&&void 0!==g&&(t.update_seq=g),n(null,t)}return w.get(Ft).onsuccess=function(e){m=e.target.result.docCount},e.update_seq&&(v=function(e){e.target.result&&e.target.result.length>0&&(g=e.target.result[0])},b.openCursor(null,"prev").onsuccess=function(e){var t=e.target.result,n=void 0;return t&&t.key&&(n=t.key),v({target:{result:[n]}})}),i||0===u?void 0:c?function(e,t,n){var r=new Array(e.length),i=0;e.forEach((function(s,o){t.get(s).onsuccess=function(t){t.target.result?r[o]=t.target.result:r[o]={key:s,error:"not_found"},++i===e.length&&n(e,r,{})}}))}(e.keys,y,S):-1===u?function(e,t,n){if("function"!=typeof e.getAll){var r=[];e.openCursor(t).onsuccess=function(e){var t=e.target.result;t?(r.push(t.value),t.continue()):n({target:{result:r}})}}else e.getAll(t).onsuccess=n}(y,r,(function(t){var n=t.target.result;e.descending&&(n=n.reverse()),x(n)})):void tn(y,r,e.descending,u+l,S)}var rn=!1,sn=[];function on(){!rn&&sn.length&&(rn=!0,sn.shift()())}function an(e,t,n,r){if((e=A(e)).continuous){var o=n+":"+Oe();return Qt.addListener(n,o,t,e),Qt.notify(n),{cancel:function(){Qt.removeListener(n,o)}}}var a=e.doc_ids&&new i(e.doc_ids);e.since=e.since||0;var c=e.since,l="limit"in e?e.limit:-1;0===l&&(l=1);var u,d,f,h,p=[],m=0,g=se(e),v=new s;function y(e,t,n,r){if(n.seq!==t)return r();if(n.winningRev===e._rev)return r(n,e);var i=e._id+"::"+n.winningRev;h.get(i).onsuccess=function(e){r(n,Kt(e.target.result))}}function b(){e.complete(null,{results:p,last_seq:c})}var w=[Ht,"by-sequence"];e.attachments&&w.push("attach-store");var _=Yt(r,w,"readonly");if(_.error)return e.complete(_.error);(u=_.txn).onabort=Ut(e.complete),u.oncomplete=function(){!e.continuous&&e.attachments?Zt(p).then(b):b()},d=u.objectStore("by-sequence"),f=u.objectStore(Ht),h=d.index("_doc_id_rev"),tn(d,e.since&&!e.descending?IDBKeyRange.lowerBound(e.since,!0):null,e.descending,l,(function(t,n,r){if(r&&t.length){var i=new Array(t.length),s=new Array(t.length),o=0;n.forEach((function(n,c){!function(e,t,n){if(a&&!a.has(e._id))return n();var r=v.get(e._id);if(r)return y(e,t,r,n);f.get(e._id).onsuccess=function(i){r=Gt(i.target.result),v.set(e._id,r),y(e,t,r,n)}}(Kt(n),t[c],(function(n,a){s[c]=n,i[c]=a,++o===t.length&&function(){for(var t=[],n=0,o=i.length;n<o&&m!==l;n++){var a=i[n];if(a){var c=s[n];t.push(d(c,a))}}Promise.all(t).then((function(t){for(var n=0,r=t.length;n<r;n++)t[n]&&e.onChange(t[n])})).catch(e.complete),m!==l&&r.continue()}()}))}))}function d(t,n){var r=e.processChange(n,t,e);c=r.seq=t.seq;var i=g(r);return"object"==typeof i?Promise.reject(i):i?(m++,e.return_docs&&p.push(r),e.attachments&&e.include_docs?new Promise((function(t){Wt(n,e,u,(function(){Zt([r],e.binary).then((function(){t(r)}))}))})):Promise.resolve(r)):Promise.resolve()}}))}var cn,ln=new s,un=new s;function dn(e,t){var n=this;!function(e,t,n){sn.push((function(){e((function(e,r){!function(e,t,n,r){try{e(t,n)}catch(t){r.emit("error",t)}}(t,e,r,n),rn=!1,a()((function(){on()}))}))})),on()}((function(t){!function(e,t,n){var r=t.name,i=null;function s(e,t){var n=e.objectStore(Ht);n.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),n.openCursor().onsuccess=function(e){var r=e.target.result;if(r){var i=r.value,s=Ke(i);i.deletedOrLocal=s?"1":"0",n.put(i),r.continue()}else t()}}function o(e,t){var n=e.objectStore("local-store"),r=e.objectStore(Ht),i=e.objectStore("by-sequence");r.openCursor().onsuccess=function(e){var s=e.target.result;if(s){var o=s.value,a=o.id,c=Je(a),l=Ne(o);if(c){var u=a+"::"+l,d=a+"::",f=a+"::~",h=i.index("_doc_id_rev"),p=IDBKeyRange.bound(d,f,!1,!1),m=h.openCursor(p);m.onsuccess=function(e){if(m=e.target.result){var t=m.value;t._doc_id_rev===u&&n.put(t),i.delete(m.primaryKey),m.continue()}else r.delete(s.primaryKey),s.continue()}}else s.continue()}else t&&t()}}function c(e,t){var n=e.objectStore("by-sequence"),r=e.objectStore("attach-store"),i=e.objectStore("attach-seq-store");r.count().onsuccess=function(e){if(!e.target.result)return t();n.openCursor().onsuccess=function(e){var n=e.target.result;if(!n)return t();for(var r=n.value,s=n.primaryKey,o=Object.keys(r._attachments||{}),a={},c=0;c<o.length;c++){a[r._attachments[o[c]].digest]=!0}var l=Object.keys(a);for(c=0;c<l.length;c++){var u=l[c];i.put({seq:s,digestSeq:u+"::"+s})}n.continue()}}}function l(e){var t=e.objectStore("by-sequence"),n=e.objectStore(Ht);n.openCursor().onsuccess=function(e){var r=e.target.result;if(r){var i,s=(i=r.value).data?Gt(i):(i.deleted="1"===i.deletedOrLocal,i);if(s.winningRev=s.winningRev||Ne(s),s.seq)return o();!function(){var e=s.id+"::",n=s.id+"::",r=t.index("_doc_id_rev").openCursor(IDBKeyRange.bound(e,n)),i=0;r.onsuccess=function(e){var t=e.target.result;if(!t)return s.seq=i,o();var n=t.primaryKey;n>i&&(i=n),t.continue()}}()}function o(){var e=zt(s,s.winningRev,s.deleted);n.put(e).onsuccess=function(){r.continue()}}}}e._meta=null,e._remote=!1,e.type=function(){return"idb"},e._id=B((function(t){t(null,e._meta.instanceId)})),e._bulkDocs=function(n,r,s){en(t,n,r,e,i,s)},e._get=function(e,t,n){var r,s,o,a=t.ctx;if(!a){var c=Yt(i,[Ht,"by-sequence","attach-store"],"readonly");if(c.error)return n(c.error);a=c.txn}function l(){n(o,{doc:r,metadata:s,ctx:a})}a.objectStore(Ht).get(e).onsuccess=function(e){if(!(s=Gt(e.target.result)))return o=re($,"missing"),l();var n;if(t.rev)n=t.latest?function(e,t){for(var n,r=t.rev_tree.slice();n=r.pop();){var i=n.pos,s=n.ids,o=s[0],a=s[1],c=s[2],l=0===c.length,u=n.history?n.history.slice():[];if(u.push({id:o,pos:i,opts:a}),l)for(var d=0,f=u.length;d<f;d++){var h=u[d];if(h.pos+"-"+h.id===e)return i+"-"+o}for(var p=0,m=c.length;p<m;p++)r.push({pos:i+1,ids:c[p],history:u})}throw new Error("Unable to resolve latest revision for id "+t.id+", rev "+e)}(t.rev,s):t.rev;else if(n=s.winningRev,Ke(s))return o=re($,"deleted"),l();var i=a.objectStore("by-sequence"),c=s.id+"::"+n;i.index("_doc_id_rev").get(c).onsuccess=function(e){if((r=e.target.result)&&(r=Kt(r)),!r)return o=re($,"missing"),l();l()}}},e._getAttachment=function(e,t,n,r,s){var o;if(r.ctx)o=r.ctx;else{var a=Yt(i,[Ht,"by-sequence","attach-store"],"readonly");if(a.error)return s(a.error);o=a.txn}var c=n.digest,l=n.content_type;o.objectStore("attach-store").get(c).onsuccess=function(e){Jt(e.target.result.body,l,r.binary,(function(e){s(null,e)}))}},e._info=function(t){var n,r,s=Yt(i,[Ft,"by-sequence"],"readonly");if(s.error)return t(s.error);var o=s.txn;o.objectStore(Ft).get(Ft).onsuccess=function(e){r=e.target.result.docCount},o.objectStore("by-sequence").openCursor(null,"prev").onsuccess=function(e){var t=e.target.result;n=t?t.key:0},o.oncomplete=function(){t(null,{doc_count:r,update_seq:n,idb_attachment_format:e._meta.blobSupport?"binary":"base64"})}},e._allDocs=function(e,t){nn(e,i,t)},e._changes=function(t){return an(t,e,r,i)},e._close=function(e){i.close(),ln.delete(r),e()},e._getRevisionTree=function(e,t){var n=Yt(i,[Ht],"readonly");if(n.error)return t(n.error);n.txn.objectStore(Ht).get(e).onsuccess=function(e){var n=Gt(e.target.result);n?t(null,n.rev_tree):t(re($))}},e._doCompaction=function(e,t,n){var r=Yt(i,[Ht,"by-sequence","attach-store","attach-seq-store"],"readwrite");if(r.error)return n(r.error);var s=r.txn;s.objectStore(Ht).get(e).onsuccess=function(n){var r=Gt(n.target.result);qe(r.rev_tree,(function(e,n,r,i,s){var o=n+"-"+r;-1!==t.indexOf(o)&&(s.status="missing")})),Xt(t,e,s);var i=r.winningRev,o=r.deleted;s.objectStore(Ht).put(zt(r,i,o))},s.onabort=Ut(n),s.oncomplete=function(){n()}},e._getLocal=function(e,t){var n=Yt(i,["local-store"],"readonly");if(n.error)return t(n.error);var r=n.txn.objectStore("local-store").get(e);r.onerror=Ut(t),r.onsuccess=function(e){var n=e.target.result;n?(delete n._doc_id_rev,t(null,n)):t(re($))}},e._putLocal=function(e,t,n){"function"==typeof t&&(n=t,t={}),delete e._revisions;var r=e._rev,s=e._id;e._rev=r?"0-"+(parseInt(r.split("-")[1],10)+1):"0-1";var o,a=t.ctx;if(!a){var c=Yt(i,["local-store"],"readwrite");if(c.error)return n(c.error);(a=c.txn).onerror=Ut(n),a.oncomplete=function(){o&&n(null,o)}}var l,u=a.objectStore("local-store");r?(l=u.get(s)).onsuccess=function(i){var s=i.target.result;s&&s._rev===r?u.put(e).onsuccess=function(){o={ok:!0,id:e._id,rev:e._rev},t.ctx&&n(null,o)}:n(re(U))}:((l=u.add(e)).onerror=function(e){n(re(U)),e.preventDefault(),e.stopPropagation()},l.onsuccess=function(){o={ok:!0,id:e._id,rev:e._rev},t.ctx&&n(null,o)})},e._removeLocal=function(e,t,n){"function"==typeof t&&(n=t,t={});var r,s=t.ctx;if(!s){var o=Yt(i,["local-store"],"readwrite");if(o.error)return n(o.error);(s=o.txn).oncomplete=function(){r&&n(null,r)}}var a=e._id,c=s.objectStore("local-store"),l=c.get(a);l.onerror=Ut(n),l.onsuccess=function(i){var s=i.target.result;s&&s._rev===e._rev?(c.delete(a),r={ok:!0,id:a,rev:"0-0"},t.ctx&&n(null,r)):n(re($))}},e._destroy=function(e,t){Qt.removeAllListeners(r);var n=un.get(r);n&&n.result&&(n.result.close(),ln.delete(r));var i=indexedDB.deleteDatabase(r);i.onsuccess=function(){un.delete(r),j()&&r in localStorage&&delete localStorage[r],t(null,{ok:!0})},i.onerror=Ut(t)};var u=ln.get(r);if(u)return i=u.idb,e._meta=u.global,a()((function(){n(null,e)}));var d=indexedDB.open(r,5);un.set(r,d),d.onupgradeneeded=function(e){var t=e.target.result;if(e.oldVersion<1)return function(e){var t=e.createObjectStore(Ht,{keyPath:"id"});e.createObjectStore("by-sequence",{autoIncrement:!0}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0}),e.createObjectStore("attach-store",{keyPath:"digest"}),e.createObjectStore(Ft,{keyPath:"id",autoIncrement:!1}),e.createObjectStore("detect-blob-support"),t.createIndex("deletedOrLocal","deletedOrLocal",{unique:!1}),e.createObjectStore("local-store",{keyPath:"_id"});var n=e.createObjectStore("attach-seq-store",{autoIncrement:!0});n.createIndex("seq","seq"),n.createIndex("digestSeq","digestSeq",{unique:!0})}(t);var n=e.currentTarget.transaction;e.oldVersion<3&&function(e){e.createObjectStore("local-store",{keyPath:"_id"}).createIndex("_doc_id_rev","_doc_id_rev",{unique:!0})}(t),e.oldVersion<4&&function(e){var t=e.createObjectStore("attach-seq-store",{autoIncrement:!0});t.createIndex("seq","seq"),t.createIndex("digestSeq","digestSeq",{unique:!0})}(t);var r=[s,o,c,l],i=e.oldVersion;!function e(){var t=r[i-1];i++,t&&t(n,e)}()},d.onsuccess=function(t){(i=t.target.result).onversionchange=function(){i.close(),ln.delete(r)},i.onabort=function(e){M("error","Database has a global failure",e.target.error),i.close(),ln.delete(r)};var s,o,a,c,l=i.transaction([Ft,"detect-blob-support",Ht],"readwrite"),u=!1;function d(){void 0!==a&&u&&(e._meta={name:r,instanceId:c,blobSupport:a},ln.set(r,{idb:i,global:e._meta}),n(null,e))}function f(){if(void 0!==o&&void 0!==s){var e=r+"_id";e in s?c=s[e]:s[e]=c=Oe(),s.docCount=o,l.objectStore(Ft).put(s)}}l.objectStore(Ft).get(Ft).onsuccess=function(e){s=e.target.result||{id:Ft},f()},function(e,t){e.objectStore(Ht).index("deletedOrLocal").count(IDBKeyRange.only("0")).onsuccess=function(e){t(e.target.result)}}(l,(function(e){o=e,f()})),cn||(cn=function(e){return new Promise((function(t){var n=be([""]),r=e.objectStore("detect-blob-support").put(n,"key");r.onsuccess=function(){var e=navigator.userAgent.match(/Chrome\/(\d+)/),n=navigator.userAgent.match(/Edge\//);t(n||!e||parseInt(e[1],10)>=43)},r.onerror=e.onabort=function(e){e.preventDefault(),e.stopPropagation(),t(!1)}})).catch((function(){return!1}))}(l)),cn.then((function(e){a=e,d()})),l.oncomplete=function(){u=!0,d()},l.onabort=Ut(n)},d.onerror=function(e){var t=e.target.error&&e.target.error.message;t?-1!==t.indexOf("stored database is a higher version")&&(t=new Error('This DB was created with the newer "indexeddb" adapter, but you are trying to open it with the older "idb" adapter')):t="Failed to open indexedDB, are you in private browsing mode?",M("error",t),n(re(ee,t))}}(n,e,t)}),t,n.constructor)}dn.valid=function(){try{return"undefined"!=typeof indexedDB&&"undefined"!=typeof IDBKeyRange}catch(e){return!1}};var fn={};function hn(e){var t=e.doc||e.ok,n=t&&t._attachments;n&&Object.keys(n).forEach((function(e){var t=n[e];t.data=Ee(t.data,t.content_type)}))}function pn(e){return/^_design/.test(e)?"_design/"+encodeURIComponent(e.slice(8)):/^_local/.test(e)?"_local/"+encodeURIComponent(e.slice(7)):encodeURIComponent(e)}function mn(e){return e._attachments&&Object.keys(e._attachments)?Promise.all(Object.keys(e._attachments).map((function(t){var n=e._attachments[t];if(n.data&&"string"!=typeof n.data)return new Promise((function(e){Se(n.data,e)})).then((function(e){n.data=e}))}))):Promise.resolve()}function gn(e,t){if(function(e){if(!e.prefix)return!1;var t=pe(e.prefix).protocol;return"http"===t||"https"===t}(t)){var n=t.name.substr(t.prefix.length);e=t.prefix.replace(/\/?$/,"/")+encodeURIComponent(n)}var r=pe(e);(r.user||r.password)&&(r.auth={username:r.user,password:r.password});var i=r.path.replace(/(^\/|\/$)/g,"").split("/");return r.db=i.pop(),-1===r.db.indexOf("%")&&(r.db=encodeURIComponent(r.db)),r.path=i.join("/"),r}function vn(e,t){return yn(e,e.db+"/"+t)}function yn(e,t){var n=e.path?"/":"";return e.protocol+"://"+e.host+(e.port?":"+e.port:"")+"/"+e.path+n+t}function bn(e){return"?"+Object.keys(e).map((function(t){return t+"="+encodeURIComponent(e[t])})).join("&")}function wn(e,t){var n=this,i=gn(e.name,e),s=vn(i,"");e=A(e);var o,c=function(t,n){if((n=n||{}).headers=n.headers||new st,n.credentials="include",e.auth||i.auth){var r=e.auth||i.auth,s=r.username+":"+r.password,o=ye(unescape(encodeURIComponent(s)));n.headers.set("Authorization","Basic "+o)}var a=e.headers||{};return Object.keys(a).forEach((function(e){n.headers.append(e,a[e])})),function(e){var t="undefined"!=typeof navigator&&navigator.userAgent?navigator.userAgent.toLowerCase():"",n=-1!==t.indexOf("msie"),r=-1!==t.indexOf("trident"),i=-1!==t.indexOf("edge"),s=!("method"in e)||"GET"===e.method;return(n||r||i)&&s}(n)&&(t+=(-1===t.indexOf("?")?"?":"&")+"_nonce="+Date.now()),(e.fetch||it)(t,n)};function l(e,t){return C(e,m()((function(e){d().then((function(){return t.apply(this,e)})).catch((function(t){e.pop()(t)}))}))).bind(n)}function u(e,t,n){var r={};return(t=t||{}).headers=t.headers||new st,t.headers.get("Content-Type")||t.headers.set("Content-Type","application/json"),t.headers.get("Accept")||t.headers.set("Accept","application/json"),c(e,t).then((function(e){return r.ok=e.ok,r.status=e.status,e.json()})).then((function(e){if(r.data=e,!r.ok){r.data.status=r.status;var t=ie(r.data);if(n)return n(t);throw t}if(Array.isArray(r.data)&&(r.data=r.data.map((function(e){return e.error||e.missing?ie(e):e}))),!n)return r;n(null,r.data)}))}function d(){return e.skip_setup?Promise.resolve():o||((o=u(s).catch((function(e){return e&&e.status&&404===e.status?(D(404,"PouchDB is just detecting if the remote exists."),u(s,{method:"PUT"})):Promise.reject(e)})).catch((function(e){return!(!e||!e.status||412!==e.status)||Promise.reject(e)}))).catch((function(){o=null})),o)}function f(e){return e.split("/").map(encodeURIComponent).join("/")}a()((function(){t(null,n)})),n._remote=!0,n.type=function(){return"http"},n.id=l("id",(function(e){c(yn(i,"")).then((function(e){return e.json()})).catch((function(){return{}})).then((function(t){var n=t&&t.uuid?t.uuid+i.db:vn(i,"");e(null,n)}))})),n.compact=l("compact",(function(e,t){"function"==typeof e&&(t=e,e={}),e=A(e),u(vn(i,"_compact"),{method:"POST"}).then((function(){!function r(){n.info((function(n,i){i&&!i.compact_running?t(null,{ok:!0}):setTimeout(r,e.interval||200)}))}()}))})),n.bulkGet=C("bulkGet",(function(e,t){var n=this;function r(t){var n={};e.revs&&(n.revs=!0),e.attachments&&(n.attachments=!0),e.latest&&(n.latest=!0),u(vn(i,"_bulk_get"+bn(n)),{method:"POST",body:JSON.stringify({docs:e.docs})}).then((function(n){e.attachments&&e.binary&&n.data.results.forEach((function(e){e.docs.forEach(hn)})),t(null,n.data)})).catch(t)}function s(){var r=Math.ceil(e.docs.length/50),i=0,s=new Array(r);function o(e){return function(n,o){s[e]=o.results,++i===r&&t(null,{results:oe(s)})}}for(var a=0;a<r;a++){var c=I(e,["revs","attachments","binary","latest"]);c.docs=e.docs.slice(50*a,Math.min(e.docs.length,50*(a+1))),q(n,c,o(a))}}var o=yn(i,""),a=fn[o];"boolean"!=typeof a?r((function(e,n){e?(fn[o]=!1,D(e.status,"PouchDB is just detecting if the remote supports the _bulk_get API."),s()):(fn[o]=!0,t(null,n))})):a?r(t):s()})),n._info=function(e){d().then((function(){return c(vn(i,""))})).then((function(e){return e.json()})).then((function(t){t.host=vn(i,""),e(null,t)})).catch(e)},n.fetch=function(e,t){return d().then((function(){var n="/"===e.substring(0,1)?yn(i,e.substring(1)):vn(i,e);return c(n,t)}))},n.get=l("get",(function(e,t,n){"function"==typeof t&&(n=t,t={});var r={};function s(e){var n=e._attachments,r=n&&Object.keys(n);if(n&&r.length)return function(e,t){return new Promise((function(n,r){var i,s=0,o=0,a=0,c=e.length;function l(){++a===c?i?r(i):n():f()}function u(){s--,l()}function d(e){s--,i=i||e,l()}function f(){for(;s<t&&o<c;)s++,e[o++]().then(u,d)}f()}))}(r.map((function(r){return function(){return function(r){var s=n[r],o=pn(e._id)+"/"+f(r)+"?rev="+e._rev;return c(vn(i,o)).then((function(e){return"buffer"in e?e.buffer():e.blob()})).then((function(e){if(t.binary){var n=Object.getOwnPropertyDescriptor(e.__proto__,"type");return n&&!n.set||(e.type=s.content_type),e}return new Promise((function(t){Se(e,t)}))})).then((function(e){delete s.stub,delete s.length,s.data=e}))}(r)}})),5)}(t=A(t)).revs&&(r.revs=!0),t.revs_info&&(r.revs_info=!0),t.latest&&(r.latest=!0),t.open_revs&&("all"!==t.open_revs&&(t.open_revs=JSON.stringify(t.open_revs)),r.open_revs=t.open_revs),t.rev&&(r.rev=t.rev),t.conflicts&&(r.conflicts=t.conflicts),t.update_seq&&(r.update_seq=t.update_seq),e=pn(e),u(vn(i,e+bn(r))).then((function(e){return Promise.resolve().then((function(){if(t.attachments)return n=e.data,Array.isArray(n)?Promise.all(n.map((function(e){if(e.ok)return s(e.ok)}))):s(n);var n})).then((function(){n(null,e.data)}))})).catch((function(t){t.docId=e,n(t)}))})),n.remove=l("remove",(function(e,t,n,r){var s;"string"==typeof t?(s={_id:e,_rev:t},"function"==typeof n&&(r=n,n={})):(s=e,"function"==typeof t?(r=t,n={}):(r=n,n=t));var o=s._rev||n.rev;u(vn(i,pn(s._id))+"?rev="+o,{method:"DELETE"},r).catch(r)})),n.getAttachment=l("getAttachment",(function(e,t,n,s){"function"==typeof n&&(s=n,n={});var o,a=n.rev?"?rev="+n.rev:"",l=vn(i,pn(e))+"/"+f(t)+a;c(l,{method:"GET"}).then((function(e){if(o=e.headers.get("content-type"),e.ok)return void 0===r||r.browser||"function"!=typeof e.buffer?e.blob():e.buffer();throw e})).then((function(e){void 0===r||r.browser||(e.type=o),s(null,e)})).catch((function(e){s(e)}))})),n.removeAttachment=l("removeAttachment",(function(e,t,n,r){u(vn(i,pn(e)+"/"+f(t))+"?rev="+n,{method:"DELETE"},r).catch(r)})),n.putAttachment=l("putAttachment",(function(e,t,n,r,s,o){"function"==typeof s&&(o=s,s=r,r=n,n=null);var a=pn(e)+"/"+f(t),c=vn(i,a);if(n&&(c+="?rev="+n),"string"==typeof r){var l;try{l=ve(r)}catch(e){return o(re(W,"Attachment is not a valid base64 string"))}r=l?_e(l,s):""}u(c,{headers:new st({"Content-Type":s}),method:"PUT",body:r},o).catch(o)})),n._bulkDocs=function(e,t,n){e.new_edits=t.new_edits,d().then((function(){return Promise.all(e.docs.map(mn))})).then((function(){return u(vn(i,"_bulk_docs"),{method:"POST",body:JSON.stringify(e)},n)})).catch(n)},n._put=function(e,t,n){d().then((function(){return mn(e)})).then((function(){return u(vn(i,pn(e._id)),{method:"PUT",body:JSON.stringify(e)})})).then((function(e){n(null,e.data)})).catch((function(t){t.docId=e&&e._id,n(t)}))},n.allDocs=l("allDocs",(function(e,t){"function"==typeof e&&(t=e,e={});var n,r={},s="GET";(e=A(e)).conflicts&&(r.conflicts=!0),e.update_seq&&(r.update_seq=!0),e.descending&&(r.descending=!0),e.include_docs&&(r.include_docs=!0),e.attachments&&(r.attachments=!0),e.key&&(r.key=JSON.stringify(e.key)),e.start_key&&(e.startkey=e.start_key),e.startkey&&(r.startkey=JSON.stringify(e.startkey)),e.end_key&&(e.endkey=e.end_key),e.endkey&&(r.endkey=JSON.stringify(e.endkey)),void 0!==e.inclusive_end&&(r.inclusive_end=!!e.inclusive_end),void 0!==e.limit&&(r.limit=e.limit),void 0!==e.skip&&(r.skip=e.skip);var o=bn(r);void 0!==e.keys&&(s="POST",n={keys:e.keys}),u(vn(i,"_all_docs"+o),{method:s,body:JSON.stringify(n)}).then((function(n){e.include_docs&&e.attachments&&e.binary&&n.data.rows.forEach(hn),t(null,n.data)})).catch(t)})),n._changes=function(e){var t="batch_size"in e?e.batch_size:25;!(e=A(e)).continuous||"heartbeat"in e||(e.heartbeat=1e4);var n="timeout"in e?e.timeout:3e4;"timeout"in e&&e.timeout&&n-e.timeout<5e3&&(n=e.timeout+5e3),"heartbeat"in e&&e.heartbeat&&n-e.heartbeat<5e3&&(n=e.heartbeat+5e3);var r={};"timeout"in e&&e.timeout&&(r.timeout=e.timeout);var s=void 0!==e.limit&&e.limit,o=s;if(e.style&&(r.style=e.style),(e.include_docs||e.filter&&"function"==typeof e.filter)&&(r.include_docs=!0),e.attachments&&(r.attachments=!0),e.continuous&&(r.feed="longpoll"),e.seq_interval&&(r.seq_interval=e.seq_interval),e.conflicts&&(r.conflicts=!0),e.descending&&(r.descending=!0),e.update_seq&&(r.update_seq=!0),"heartbeat"in e&&e.heartbeat&&(r.heartbeat=e.heartbeat),e.filter&&"string"==typeof e.filter&&(r.filter=e.filter),e.view&&"string"==typeof e.view&&(r.filter="_view",r.view=e.view),e.query_params&&"object"==typeof e.query_params)for(var c in e.query_params)e.query_params.hasOwnProperty(c)&&(r[c]=e.query_params[c]);var l,f="GET";e.doc_ids?(r.filter="_doc_ids",f="POST",l={doc_ids:e.doc_ids}):e.selector&&(r.filter="_selector",f="POST",l={selector:e.selector});var h,p=new rt,m=function(n,a){if(!e.aborted){r.since=n,"object"==typeof r.since&&(r.since=JSON.stringify(r.since)),e.descending?s&&(r.limit=o):r.limit=!s||o>t?t:o;var c=vn(i,"_changes"+bn(r)),m={signal:p.signal,method:f,body:JSON.stringify(l)};h=n,e.aborted||d().then((function(){return u(c,m,a)})).catch(a)}},g={results:[]},v=function(n,r){if(!e.aborted){var i=0;if(r&&r.results){i=r.results.length,g.last_seq=r.last_seq;var c=null,l=null;"number"==typeof r.pending&&(c=r.pending),"string"!=typeof g.last_seq&&"number"!=typeof g.last_seq||(l=g.last_seq);e.query_params,r.results=r.results.filter((function(t){o--;var n=se(e)(t);return n&&(e.include_docs&&e.attachments&&e.binary&&hn(t),e.return_docs&&g.results.push(t),e.onChange(t,c,l)),n}))}else if(n)return e.aborted=!0,void e.complete(n);r&&r.last_seq&&(h=r.last_seq);var u=s&&o<=0||r&&i<t||e.descending;(!e.continuous||s&&o<=0)&&u?e.complete(null,g):a()((function(){m(h,v)}))}};return m(e.since||0,v),{cancel:function(){e.aborted=!0,p.abort()}}},n.revsDiff=l("revsDiff",(function(e,t,n){"function"==typeof t&&(n=t,t={}),u(vn(i,"_revs_diff"),{method:"POST",body:JSON.stringify(e)},n).catch(n)})),n._close=function(e){e()},n._destroy=function(e,t){u(vn(i,""),{method:"DELETE"}).then((function(e){t(null,e)})).catch((function(e){404===e.status?t(null,{ok:!0}):t(e)}))}}function _n(e){this.status=400,this.name="query_parse_error",this.message=e,this.error=!0;try{Error.captureStackTrace(this,_n)}catch(e){}}function En(e){this.status=404,this.name="not_found",this.message=e,this.error=!0;try{Error.captureStackTrace(this,En)}catch(e){}}function kn(e){this.status=500,this.name="invalid_value",this.message=e,this.error=!0;try{Error.captureStackTrace(this,kn)}catch(e){}}function xn(e,t){return t&&e.then((function(e){a()((function(){t(null,e)}))}),(function(e){a()((function(){t(e)}))})),e}function Sn(e,t){return function(){var n=arguments,r=this;return e.add((function(){return t.apply(r,n)}))}}function An(e){var t=new i(e),n=new Array(t.size),r=-1;return t.forEach((function(e){n[++r]=e})),n}function Ln(e){var t=new Array(e.size),n=-1;return e.forEach((function(e,r){t[++n]=r})),t}function Bn(e){return new kn("builtin "+e+" function requires map values to be numbers or number arrays")}function Cn(e){for(var t=0,n=0,r=e.length;n<r;n++){var i=e[n];if("number"!=typeof i){if(!Array.isArray(i))throw Bn("_sum");t="number"==typeof t?[t]:t;for(var s=0,o=i.length;s<o;s++){var a=i[s];if("number"!=typeof a)throw Bn("_sum");void 0===t[s]?t.push(a):t[s]+=a}}else"number"==typeof t?t+=i:t[0]+=i}return t}wn.valid=function(){return!0},v()(_n,Error),v()(En,Error),v()(kn,Error);var In=M.bind(null,"log"),Pn=Array.isArray,On=JSON.parse;function Nn(e,t){return me("return ("+e.replace(/;\s*$/,"")+");",{emit:t,sum:Cn,log:In,isArray:Pn,toJSON:On})}function qn(){this.promise=new Promise((function(e){e()}))}function jn(e){if(!e)return"undefined";switch(typeof e){case"function":case"string":return e.toString();default:return JSON.stringify(e)}}function Tn(e,t,n,r,i,s){var o,a=function(e,t){return jn(e)+jn(t)+"undefined"}(n,r);if(!i&&(o=e._cachedViews=e._cachedViews||{})[a])return o[a];var c=e.info().then((function(c){var l=c.db_name+"-mrview-"+(i?"temp":Ie(a));return ge(e,"_local/"+s,(function(e){e.views=e.views||{};var n=t;-1===n.indexOf("/")&&(n=t+"/"+t);var r=e.views[n]=e.views[n]||{};if(!r[l])return r[l]=!0,e})).then((function(){return e.registerDependentDatabase(l).then((function(t){var i=t.db;i.auto_compaction=!0;var s={name:l,db:i,sourceDB:e,adapter:e.adapter,mapFun:n,reduceFun:r};return s.db.get("_local/lastSeq").catch((function(e){if(404!==e.status)throw e})).then((function(e){return s.seq=e?e.seq:0,o&&s.db.once("destroyed",(function(){delete o[a]})),s}))}))}))}));return o&&(o[a]=c),c}qn.prototype.add=function(e){return this.promise=this.promise.catch((function(){})).then((function(){return e()})),this.promise},qn.prototype.finish=function(){return this.promise};var Mn={},Rn=new qn;function Dn(e){return-1===e.indexOf("/")?[e,e]:e.split("/")}function Vn(e,t){try{e.emit("error",t)}catch(e){M("error","The user's map/reduce function threw an uncaught error.\nYou can debug this error by doing:\nmyDatabase.on('error', function (err) { debugger; });\nPlease double-check your map/reduce function."),M("error",t)}}var Hn=function(e,t){return Cn(t)},Fn=function(e,t){return t.length},$n=function(e,t){return{sum:Cn(t),min:Math.min.apply(null,t),max:Math.max.apply(null,t),count:t.length,sumsqr:function(e){for(var t=0,n=0,r=e.length;n<r;n++){var i=e[n];t+=i*i}return t}(t)}};var Un=function(e,t,n,r){function o(e,t,n){try{t(n)}catch(t){Vn(e,t)}}function c(e,t,n,r,i){try{return{output:t(n,r,i)}}catch(t){return Vn(e,t),{error:t}}}function l(e,t){var n=pt(e.key,t.key);return 0!==n?n:pt(e.value,t.value)}function u(e,t,n){return n=n||0,"number"==typeof t?e.slice(n,t+n):n>0?e.slice(n):e}function d(e){var t=e.value;return t&&"object"==typeof t&&t._id||e.id}function f(e){return function(t){return e.include_docs&&e.attachments&&e.binary&&function(e){e.rows.forEach((function(e){var t=e.doc&&e.doc._attachments;t&&Object.keys(t).forEach((function(e){var n=t[e];t[e].data=Ee(n.data,n.content_type)}))}))}(t),t}}function h(e,t,n,r){var i=t[e];void 0!==i&&(r&&(i=encodeURIComponent(JSON.stringify(i))),n.push(e+"="+i))}function p(e){if(void 0!==e){var t=Number(e);return isNaN(t)||t!==parseInt(e,10)?e:t}}function g(e,t){var n=e.descending?"endkey":"startkey",r=e.descending?"startkey":"endkey";if(void 0!==e[n]&&void 0!==e[r]&&pt(e[n],e[r])>0)throw new _n("No rows can match your key range, reverse your start_key and end_key or set {descending : true}");if(t.reduce&&!1!==e.reduce){if(e.include_docs)throw new _n("{include_docs:true} is invalid for reduce");if(e.keys&&e.keys.length>1&&!e.group&&!e.group_level)throw new _n("Multi-key fetches for reduce views must use {group: true}")}["group_level","limit","skip"].forEach((function(t){var n=function(e){if(e){if("number"!=typeof e)return new _n('Invalid value for integer: "'+e+'"');if(e<0)return new _n('Invalid value for positive integer: "'+e+'"')}}(e[t]);if(n)throw n}))}function v(e){return function(t){if(404===t.status)return e;throw t}}function y(e,t,n){var r="_local/doc_"+e,s={_id:r,keys:[]},o=n.get(e),a=o[0];return(function(e){return 1===e.length&&/^1-/.test(e[0].rev)}(o[1])?Promise.resolve(s):t.db.get(r).catch(v(s))).then((function(e){return function(e){return e.keys.length?t.db.allDocs({keys:e.keys,include_docs:!0}):Promise.resolve({rows:[]})}(e).then((function(t){return function(e,t){for(var n=[],r=new i,s=0,o=t.rows.length;s<o;s++){var c=t.rows[s].doc;if(c&&(n.push(c),r.add(c._id),c._deleted=!a.has(c._id),!c._deleted)){var l=a.get(c._id);"value"in l&&(c.value=l.value)}}var u=Ln(a);return u.forEach((function(e){if(!r.has(e)){var t={_id:e},i=a.get(e);"value"in i&&(t.value=i.value),n.push(t)}})),e.keys=An(u.concat(e.keys)),n.push(e),n}(e,t)}))}))}function b(e){var t="string"==typeof e?e:e.name,n=Mn[t];return n||(n=Mn[t]=new qn),n}function w(e){return Sn(b(e),(function(){return function(e){var n,r;var i=t(e.mapFun,(function(e,t){var i={id:r._id,key:mt(e)};null!=t&&(i.value=mt(t)),n.push(i)})),a=e.seq||0;function c(t,n){return function(){return function(e,t,n){return e.db.get("_local/lastSeq").catch(v({_id:"_local/lastSeq",seq:0})).then((function(r){var i=Ln(t);return Promise.all(i.map((function(n){return y(n,e,t)}))).then((function(t){var i=oe(t);return r.seq=n,i.push(r),e.db.bulkDocs({docs:i})}))}))}(e,t,n)}}var u=new qn;function d(){return e.sourceDB.changes({return_docs:!0,conflicts:!0,include_docs:!0,style:"all_docs",since:a,limit:50}).then(f)}function f(t){var f=t.results;if(f.length){var p=function(t){for(var c=new s,u=0,d=t.length;u<d;u++){var f=t[u];if("_"!==f.doc._id[0]){n=[],(r=f.doc)._deleted||o(e.sourceDB,i,r),n.sort(l);var p=h(n);c.set(f.doc._id,[p,f.changes])}a=f.seq}return c}(f);if(u.add(c(p,a)),!(f.length<50))return d()}}function h(e){for(var t,n=new s,r=0,i=e.length;r<i;r++){var o=e[r],a=[o.key,o.id];r>0&&0===pt(o.key,t)&&a.push(r),n.set(vt(a),o),t=o.key}return n}return d().then((function(){return u.finish()})).then((function(){e.seq=a}))}(e)}))()}function _(e,t){return Sn(b(e),(function(){return function(e,t){var r,i=e.reduceFun&&!1!==t.reduce,o=t.skip||0;void 0===t.keys||t.keys.length||(t.limit=0,delete t.keys);function a(t){return t.include_docs=!0,e.db.allDocs(t).then((function(e){return r=e.total_rows,e.rows.map((function(e){if("value"in e.doc&&"object"==typeof e.doc.value&&null!==e.doc.value){var t=Object.keys(e.doc.value).sort(),n=["id","key","value"];if(!(t<n||t>n))return e.doc.value}var r=function(e){for(var t=[],n=[],r=0;;){var i=e[r++];if("\0"!==i)switch(i){case"1":t.push(null);break;case"2":t.push("1"===e[r]),r++;break;case"3":var s=yt(e,r);t.push(s.num),r+=s.length;break;case"4":for(var o="";;){var a=e[r];if("\0"===a)break;o+=a,r++}o=o.replace(/\u0001\u0001/g,"\0").replace(/\u0001\u0002/g,"").replace(/\u0002\u0002/g,""),t.push(o);break;case"5":var c={element:[],index:t.length};t.push(c.element),n.push(c);break;case"6":var l={element:{},index:t.length};t.push(l.element),n.push(l);break;default:throw new Error("bad collationIndex or unexpectedly reached end of input: "+i)}else{if(1===t.length)return t.pop();bt(t,n)}}}(e.doc._id);return{key:r[0],id:r[1],value:"value"in e.doc?e.doc.value:null}}))}))}function l(a){var l;if(l=i?function(e,t,r){0===r.group_level&&delete r.group_level;var i=r.group||r.group_level,s=n(e.reduceFun),o=[],a=isNaN(r.group_level)?Number.POSITIVE_INFINITY:r.group_level;t.forEach((function(e){var t=o[o.length-1],n=i?e.key:null;if(i&&Array.isArray(n)&&(n=n.slice(0,a)),t&&0===pt(t.groupKey,n))return t.keys.push([e.key,e.id]),void t.values.push(e.value);o.push({keys:[[e.key,e.id]],values:[e.value],groupKey:n})})),t=[];for(var l=0,d=o.length;l<d;l++){var f=o[l],h=c(e.sourceDB,s,f.keys,f.values,!1);if(h.error&&h.error instanceof kn)throw h.error;t.push({value:h.error?null:h.output,key:f.groupKey})}return{rows:u(t,r.limit,r.skip)}}(e,a,t):{total_rows:r,offset:o,rows:a},t.update_seq&&(l.update_seq=e.seq),t.include_docs){var f=An(a.map(d));return e.sourceDB.allDocs({keys:f,include_docs:!0,conflicts:t.conflicts,attachments:t.attachments,binary:t.binary}).then((function(e){var t=new s;return e.rows.forEach((function(e){t.set(e.id,e.doc)})),a.forEach((function(e){var n=d(e),r=t.get(n);r&&(e.doc=r)})),l}))}return l}if(void 0!==t.keys){var f=t.keys.map((function(e){var n={startkey:vt([e]),endkey:vt([e,{}])};return t.update_seq&&(n.update_seq=!0),a(n)}));return Promise.all(f).then(oe).then(l)}var h,p,m={descending:t.descending};if(t.update_seq&&(m.update_seq=!0),"start_key"in t&&(h=t.start_key),"startkey"in t&&(h=t.startkey),"end_key"in t&&(p=t.end_key),"endkey"in t&&(p=t.endkey),void 0!==h&&(m.startkey=t.descending?vt([h,{}]):vt([h])),void 0!==p){var g=!1!==t.inclusive_end;t.descending&&(g=!g),m.endkey=vt(g?[p,{}]:[p])}if(void 0!==t.key){var v=vt([t.key]),y=vt([t.key,{}]);m.descending?(m.endkey=v,m.startkey=y):(m.startkey=v,m.endkey=y)}return i||("number"==typeof t.limit&&(m.limit=t.limit),m.skip=o),a(m).then(l)}(e,t)}))()}function E(t,n,i){if("function"==typeof t._query)return function(e,t,n){return new Promise((function(r,i){e._query(t,n,(function(e,t){if(e)return i(e);r(t)}))}))}(t,n,i);if(ce(t))return function(e,t,n){var r,i,s,o=[],a="GET";if(h("reduce",n,o),h("include_docs",n,o),h("attachments",n,o),h("limit",n,o),h("descending",n,o),h("group",n,o),h("group_level",n,o),h("skip",n,o),h("stale",n,o),h("conflicts",n,o),h("startkey",n,o,!0),h("start_key",n,o,!0),h("endkey",n,o,!0),h("end_key",n,o,!0),h("inclusive_end",n,o),h("key",n,o,!0),h("update_seq",n,o),o=""===(o=o.join("&"))?"":"?"+o,void 0!==n.keys){var c="keys="+encodeURIComponent(JSON.stringify(n.keys));c.length+o.length+1<=2e3?o+=("?"===o[0]?"&":"?")+c:(a="POST","string"==typeof t?r={keys:n.keys}:t.keys=n.keys)}if("string"==typeof t){var l=Dn(t);return e.fetch("_design/"+l[0]+"/_view/"+l[1]+o,{headers:new st({"Content-Type":"application/json"}),method:a,body:JSON.stringify(r)}).then((function(e){return i=e.ok,s=e.status,e.json()})).then((function(e){if(!i)throw e.status=s,ie(e);return e.rows.forEach((function(e){if(e.value&&e.value.error&&"builtin_reduce_error"===e.value.error)throw new Error(e.reason)})),e})).then(f(n))}return r=r||{},Object.keys(t).forEach((function(e){Array.isArray(t[e])?r[e]=t[e]:r[e]=t[e].toString()})),e.fetch("_temp_view"+o,{headers:new st({"Content-Type":"application/json"}),method:"POST",body:JSON.stringify(r)}).then((function(e){return i=e.ok,s=e.status,e.json()})).then((function(e){if(!i)throw e.status=s,ie(e);return e})).then(f(n))}(t,n,i);if("string"!=typeof n)return g(i,n),Rn.add((function(){return Tn(t,"temp_view/temp_view",n.map,n.reduce,!0,e).then((function(e){return t=w(e).then((function(){return _(e,i)})),n=function(){return e.db.destroy()},t.then((function(e){return n().then((function(){return e}))}),(function(e){return n().then((function(){throw e}))}));var t,n}))})),Rn.finish();var s=n,o=Dn(s),c=o[0],l=o[1];return t.get("_design/"+c).then((function(n){var o=n.views&&n.views[l];if(!o)throw new En("ddoc "+n._id+" has no view named "+l);return r(n,l),g(i,o),Tn(t,s,o.map,o.reduce,!1,e).then((function(e){return"ok"===i.stale||"update_after"===i.stale?("update_after"===i.stale&&a()((function(){w(e)})),_(e,i)):w(e).then((function(){return _(e,i)}))}))}))}var k;return{query:function(e,t,n){var r=this;"function"==typeof t&&(n=t,t={}),t=t?function(e){return e.group_level=p(e.group_level),e.limit=p(e.limit),e.skip=p(e.skip),e}(t):{},"function"==typeof e&&(e={map:e});var i=Promise.resolve().then((function(){return E(r,e,t)}));return xn(i,n),i},viewCleanup:(k=function(){var t=this;return"function"==typeof t._viewCleanup?function(e){return new Promise((function(t,n){e._viewCleanup((function(e,r){if(e)return n(e);t(r)}))}))}(t):ce(t)?function(e){return e.fetch("_view_cleanup",{headers:new st({"Content-Type":"application/json"}),method:"POST"}).then((function(e){return e.json()}))}(t):function(t){return t.get("_local/"+e).then((function(e){var n=new s;Object.keys(e.views).forEach((function(e){var t=Dn(e),r="_design/"+t[0],s=t[1],o=n.get(r);o||(o=new i,n.set(r,o)),o.add(s)}));var r={keys:Ln(n),include_docs:!0};return t.allDocs(r).then((function(r){var i={};r.rows.forEach((function(t){var r=t.key.substring(8);n.get(t.key).forEach((function(n){var s=r+"/"+n;e.views[s]||(s=n);var o=Object.keys(e.views[s]),a=t.doc&&t.doc.views&&t.doc.views[n];o.forEach((function(e){i[e]=i[e]||a}))}))}));var s=Object.keys(i).filter((function(e){return!i[e]})).map((function(e){return Sn(b(e),(function(){return new t.constructor(e,t.__opts).destroy()}))()}));return Promise.all(s).then((function(){return{ok:!0}}))}))}),v({ok:!0}))}(t)},m()((function(e){var t=e.pop(),n=k.apply(this,e);return"function"==typeof t&&xn(n,t),n})))}}("mrviews",(function(e,t){if("function"==typeof e&&2===e.length){var n=e;return function(e){return n(e,t)}}return Nn(e.toString(),t)}),(function(e){var t=e.toString(),n=function(e){if(/^_sum/.test(e))return Hn;if(/^_count/.test(e))return Fn;if(/^_stats/.test(e))return $n;if(/^_/.test(e))throw new Error(e+" is not a supported reduce function.")}(t);return n||Nn(t)}),(function(e,t){var n=e.views&&e.views[t];if("string"!=typeof n.map)throw new En("ddoc "+e._id+" has no string view named "+t+", instead found object of type: "+typeof n.map)}));var zn={query:function(e,t,n){return Un.query.call(this,e,t,n)},viewCleanup:function(e){return Un.viewCleanup.call(this,e)}};function Gn(e){return/^1-/.test(e)}function Kn(e,t){var n=Object.keys(t._attachments);return Promise.all(n.map((function(n){return e.getAttachment(t._id,n,{rev:t._rev})})))}function Jn(e,t,n,r){n=A(n);var i=[],s=!0;function o(t){return e.allDocs({keys:t,include_docs:!0,conflicts:!0}).then((function(e){if(r.cancelled)throw new Error("cancelled");e.rows.forEach((function(e){var t;e.deleted||!e.doc||!Gn(e.value.rev)||(t=e.doc,t._attachments&&Object.keys(t._attachments).length>0)||function(e){return e._conflicts&&e._conflicts.length>0}(e.doc)||(e.doc._conflicts&&delete e.doc._conflicts,i.push(e.doc),delete n[e.id])}))}))}return Promise.resolve().then((function(){var e=Object.keys(n).filter((function(e){var t=n[e].missing;return 1===t.length&&Gn(t[0])}));if(e.length>0)return o(e)})).then((function(){var o=function(e){var t=[];return Object.keys(e).forEach((function(n){e[n].missing.forEach((function(e){t.push({id:n,rev:e})}))})),{docs:t,revs:!0,latest:!0}}(n);if(o.docs.length)return e.bulkGet(o).then((function(n){if(r.cancelled)throw new Error("cancelled");return Promise.all(n.results.map((function(n){return Promise.all(n.docs.map((function(n){var r=n.ok;return n.error&&(s=!1),r&&r._attachments?function(e,t,n){var r=ce(t)&&!ce(e),i=Object.keys(n._attachments);return r?e.get(n._id).then((function(r){return Promise.all(i.map((function(i){return function(e,t,n){return!e._attachments||!e._attachments[n]||e._attachments[n].digest!==t._attachments[n].digest}(r,n,i)?t.getAttachment(n._id,i):e.getAttachment(r._id,i)})))})).catch((function(e){if(404!==e.status)throw e;return Kn(t,n)})):Kn(t,n)}(t,e,r).then((function(e){var t=Object.keys(r._attachments);return e.forEach((function(e,n){var i=r._attachments[t[n]];delete i.stub,delete i.length,i.data=e})),r})):r})))}))).then((function(e){i=i.concat(oe(e).filter(Boolean))}))}))})).then((function(){return{ok:s,docs:i}}))}function Wn(e,t,n,r,i){return e.get(t).catch((function(n){if(404===n.status)return"http"!==e.adapter&&"https"!==e.adapter||D(404,"PouchDB is just checking if a remote checkpoint exists."),{session_id:r,_id:t,history:[],replicator:"pouchdb",version:1};throw n})).then((function(s){if(!i.cancelled&&s.last_seq!==n)return s.history=(s.history||[]).filter((function(e){return e.session_id!==r})),s.history.unshift({last_seq:n,session_id:r}),s.history=s.history.slice(0,5),s.version=1,s.replicator="pouchdb",s.session_id=r,s.last_seq=n,e.put(s).catch((function(s){if(409===s.status)return Wn(e,t,n,r,i);throw s}))}))}function Zn(e,t,n,r,i){this.src=e,this.target=t,this.id=n,this.returnValue=r,this.opts=i||{}}Zn.prototype.writeCheckpoint=function(e,t){var n=this;return this.updateTarget(e,t).then((function(){return n.updateSource(e,t)}))},Zn.prototype.updateTarget=function(e,t){return this.opts.writeTargetCheckpoint?Wn(this.target,this.id,e,t,this.returnValue):Promise.resolve(!0)},Zn.prototype.updateSource=function(e,t){if(this.opts.writeSourceCheckpoint){var n=this;return Wn(this.src,this.id,e,t,this.returnValue).catch((function(e){if(Qn(e))return n.opts.writeSourceCheckpoint=!1,!0;throw e}))}return Promise.resolve(!0)};var Xn={undefined:function(e,t){return 0===pt(e.last_seq,t.last_seq)?t.last_seq:0},1:function(e,t){return function(e,t){if(e.session_id===t.session_id)return{last_seq:e.last_seq,history:e.history};return function e(t,n){var r=t[0],i=t.slice(1),s=n[0],o=n.slice(1);if(!r||0===n.length)return{last_seq:0,history:[]};if(Yn(r.session_id,n))return{last_seq:r.last_seq,history:t};if(Yn(s.session_id,i))return{last_seq:s.last_seq,history:o};return e(i,o)}(e.history,t.history)}(t,e).last_seq}};function Yn(e,t){var n=t[0],r=t.slice(1);return!(!e||0===t.length)&&(e===n.session_id||Yn(e,r))}function Qn(e){return"number"==typeof e.status&&4===Math.floor(e.status/100)}Zn.prototype.getCheckpoint=function(){var e=this;return e.opts&&e.opts.writeSourceCheckpoint&&!e.opts.writeTargetCheckpoint?e.src.get(e.id).then((function(e){return e.last_seq||0})).catch((function(e){if(404!==e.status)throw e;return 0})):e.target.get(e.id).then((function(t){return e.opts&&e.opts.writeTargetCheckpoint&&!e.opts.writeSourceCheckpoint?t.last_seq||0:e.src.get(e.id).then((function(e){return t.version!==e.version?0:(n=t.version?t.version.toString():"undefined")in Xn?Xn[n](t,e):0;var n}),(function(n){if(404===n.status&&t.last_seq)return e.src.put({_id:e.id,last_seq:0}).then((function(){return 0}),(function(n){return Qn(n)?(e.opts.writeSourceCheckpoint=!1,t.last_seq):0}));throw n}))})).catch((function(e){if(404!==e.status)throw e;return 0}))};function er(e,t,n){var r=n.doc_ids?n.doc_ids.sort(pt):"",i=n.filter?n.filter.toString():"",s="",o="",a="";return n.selector&&(a=JSON.stringify(n.selector)),n.filter&&n.query_params&&(s=JSON.stringify(function(e){return Object.keys(e).sort(pt).reduce((function(t,n){return t[n]=e[n],t}),{})}(n.query_params))),n.filter&&"_view"===n.filter&&(o=n.view.toString()),Promise.all([e.id(),t.id()]).then((function(e){var t=e[0]+e[1]+i+o+s+r+a;return new Promise((function(e){Ce(t,e)}))})).then((function(e){return"_local/"+(e=e.replace(/\//g,".").replace(/\+/g,"_"))}))}function tr(e,t,n,r,i){var s,o,c,l=[],u={seq:0,changes:[],docs:[]},d=!1,f=!1,h=!1,p=0,m=n.continuous||n.live||!1,g=n.batch_size||100,v=n.batches_limit||10,y=!1,b=n.doc_ids,w=n.selector,_=[],E=Oe();i=i||{ok:!0,start_time:(new Date).toISOString(),docs_read:0,docs_written:0,doc_write_failures:0,errors:[]};var k={};function x(){return c?Promise.resolve():er(e,t,n).then((function(i){o=i;var s={};s=!1===n.checkpoint?{writeSourceCheckpoint:!1,writeTargetCheckpoint:!1}:"source"===n.checkpoint?{writeSourceCheckpoint:!0,writeTargetCheckpoint:!1}:"target"===n.checkpoint?{writeSourceCheckpoint:!1,writeTargetCheckpoint:!0}:{writeSourceCheckpoint:!0,writeTargetCheckpoint:!0},c=new Zn(e,t,o,r,s)}))}function S(){if(_=[],0!==s.docs.length){var e=s.docs,o={timeout:n.timeout};return t.bulkDocs({docs:e,new_edits:!1},o).then((function(t){if(r.cancelled)throw O(),new Error("cancelled");var n=Object.create(null);t.forEach((function(e){e.error&&(n[e.id]=e)}));var s=Object.keys(n).length;i.doc_write_failures+=s,i.docs_written+=e.length-s,e.forEach((function(e){var t=n[e._id];if(t){i.errors.push(t);var s=(t.name||"").toLowerCase();if("unauthorized"!==s&&"forbidden"!==s)throw t;r.emit("denied",A(t))}else _.push(e)}))}),(function(t){throw i.doc_write_failures+=e.length,t}))}}function L(){if(s.error)throw new Error("There was a problem getting docs.");i.last_seq=p=s.seq;var e=A(i);return _.length&&(e.docs=_,"number"==typeof s.pending&&(e.pending=s.pending,delete s.pending),r.emit("change",e)),d=!0,c.writeCheckpoint(s.seq,E).then((function(){if(d=!1,r.cancelled)throw O(),new Error("cancelled");s=void 0,T()})).catch((function(e){throw D(e),e}))}function B(){return Jn(e,t,s.diffs,r).then((function(e){s.error=!e.ok,e.docs.forEach((function(e){delete s.diffs[e._id],i.docs_read++,s.docs.push(e)}))}))}function C(){var e;r.cancelled||s||(0!==l.length?(s=l.shift(),(e={},s.changes.forEach((function(t){"_user/"!==t.id&&(e[t.id]=t.changes.map((function(e){return e.rev})))})),t.revsDiff(e).then((function(e){if(r.cancelled)throw O(),new Error("cancelled");s.diffs=e}))).then(B).then(S).then(L).then(C).catch((function(e){P("batch processing terminated with error",e)}))):I(!0))}function I(e){0!==u.changes.length?(e||f||u.changes.length>=g)&&(l.push(u),u={seq:0,changes:[],docs:[]},"pending"!==r.state&&"stopped"!==r.state||(r.state="active",r.emit("active")),C()):0!==l.length||s||((m&&k.live||f)&&(r.state="pending",r.emit("paused")),f&&O())}function P(e,t){h||(t.message||(t.message=e),i.ok=!1,i.status="aborting",l=[],u={seq:0,changes:[],docs:[]},O(t))}function O(s){if(!(h||r.cancelled&&(i.status="cancelled",d)))if(i.status=i.status||"complete",i.end_time=(new Date).toISOString(),i.last_seq=p,h=!0,s){(s=re(s)).result=i;var o=(s.name||"").toLowerCase();"unauthorized"===o||"forbidden"===o?(r.emit("error",s),r.removeAllListeners()):function(e,t,n,r){if(!1===e.retry)return t.emit("error",n),void t.removeAllListeners();if("function"!=typeof e.back_off_function&&(e.back_off_function=R),t.emit("requestError",n),"active"===t.state||"pending"===t.state){t.emit("paused",n),t.state="stopped";var i=function(){e.current_back_off=0};t.once("paused",(function(){t.removeListener("active",i)})),t.once("active",i)}e.current_back_off=e.current_back_off||0,e.current_back_off=e.back_off_function(e.current_back_off),setTimeout(r,e.current_back_off)}(n,r,s,(function(){tr(e,t,n,r)}))}else r.emit("complete",i),r.removeAllListeners()}function N(e,t,i){if(r.cancelled)return O();"number"==typeof t&&(u.pending=t),se(n)(e)&&(u.seq=e.seq||i,u.changes.push(e),a()((function(){I(0===l.length&&k.live)})))}function q(e){if(y=!1,r.cancelled)return O();if(e.results.length>0)k.since=e.results[e.results.length-1].seq,T(),I(!0);else{var t=function(){m?(k.live=!0,T()):f=!0,I(!0)};s||0!==e.results.length?t():(d=!0,c.writeCheckpoint(e.last_seq,E).then((function(){d=!1,i.last_seq=p=e.last_seq,t()})).catch(D))}}function j(e){if(y=!1,r.cancelled)return O();P("changes rejected",e)}function T(){if(!y&&!f&&l.length<v){y=!0,r._changes&&(r.removeListener("cancel",r._abortChanges),r._changes.cancel()),r.once("cancel",i);var t=e.changes(k).on("change",N);t.then(s,s),t.then(q).catch(j),n.retry&&(r._changes=t,r._abortChanges=i)}function i(){t.cancel()}function s(){r.removeListener("cancel",i)}}function M(){x().then((function(){if(!r.cancelled)return c.getCheckpoint().then((function(e){k={since:p=e,limit:g,batch_size:g,style:"all_docs",doc_ids:b,selector:w,return_docs:!0},n.filter&&("string"!=typeof n.filter?k.include_docs=!0:k.filter=n.filter),"heartbeat"in n&&(k.heartbeat=n.heartbeat),"timeout"in n&&(k.timeout=n.timeout),n.query_params&&(k.query_params=n.query_params),n.view&&(k.view=n.view),T()}));O()})).catch((function(e){P("getCheckpoint rejected with ",e)}))}function D(e){d=!1,P("writeCheckpoint completed with error",e)}r.ready(e,t),r.cancelled?O():(r._addedListeners||(r.once("cancel",O),"function"==typeof n.complete&&(r.once("error",n.complete),r.once("complete",(function(e){n.complete(null,e)}))),r._addedListeners=!0),void 0===n.since?M():x().then((function(){return d=!0,c.writeCheckpoint(n.since,E)})).then((function(){d=!1,r.cancelled?O():(p=n.since,M())})).catch(D))}function nr(){y.EventEmitter.call(this),this.cancelled=!1,this.state="pending";var e=this,t=new Promise((function(t,n){e.once("complete",t),e.once("error",n)}));e.then=function(e,n){return t.then(e,n)},e.catch=function(e){return t.catch(e)},e.catch((function(){}))}function rr(e,t){var n=t.PouchConstructor;return"string"==typeof e?new n(e,t):e}function ir(e,t,n,r){if("function"==typeof n&&(r=n,n={}),void 0===n&&(n={}),n.doc_ids&&!Array.isArray(n.doc_ids))throw re(Y,"`doc_ids` filter parameter is not a list.");n.complete=r,(n=A(n)).continuous=n.continuous||n.live,n.retry="retry"in n&&n.retry,n.PouchConstructor=n.PouchConstructor||this;var i=new nr(n);return tr(rr(e,n),rr(t,n),n,i),i}function sr(e,t,n,r){return"function"==typeof n&&(r=n,n={}),void 0===n&&(n={}),(n=A(n)).PouchConstructor=n.PouchConstructor||this,new or(e=rr(e,n),t=rr(t,n),n,r)}function or(e,t,n,r){var i=this;this.canceled=!1;var s=n.push?V({},n,n.push):n,o=n.pull?V({},n,n.pull):n;function a(e){i.emit("change",{direction:"pull",change:e})}function c(e){i.emit("change",{direction:"push",change:e})}function l(e){i.emit("denied",{direction:"push",doc:e})}function u(e){i.emit("denied",{direction:"pull",doc:e})}function d(){i.pushPaused=!0,i.pullPaused&&i.emit("paused")}function f(){i.pullPaused=!0,i.pushPaused&&i.emit("paused")}function h(){i.pushPaused=!1,i.pullPaused&&i.emit("active",{direction:"push"})}function p(){i.pullPaused=!1,i.pushPaused&&i.emit("active",{direction:"pull"})}this.push=ir(e,t,s),this.pull=ir(t,e,o),this.pushPaused=!0,this.pullPaused=!0;var m={};function g(e){return function(t,n){("change"===t&&(n===a||n===c)||"denied"===t&&(n===u||n===l)||"paused"===t&&(n===f||n===d)||"active"===t&&(n===p||n===h))&&(t in m||(m[t]={}),m[t][e]=!0,2===Object.keys(m[t]).length&&i.removeAllListeners(t))}}function v(e,t,n){-1==e.listeners(t).indexOf(n)&&e.on(t,n)}n.live&&(this.push.on("complete",i.pull.cancel.bind(i.pull)),this.pull.on("complete",i.push.cancel.bind(i.push))),this.on("newListener",(function(e){"change"===e?(v(i.pull,"change",a),v(i.push,"change",c)):"denied"===e?(v(i.pull,"denied",u),v(i.push,"denied",l)):"active"===e?(v(i.pull,"active",p),v(i.push,"active",h)):"paused"===e&&(v(i.pull,"paused",f),v(i.push,"paused",d))})),this.on("removeListener",(function(e){"change"===e?(i.pull.removeListener("change",a),i.push.removeListener("change",c)):"denied"===e?(i.pull.removeListener("denied",u),i.push.removeListener("denied",l)):"active"===e?(i.pull.removeListener("active",p),i.push.removeListener("active",h)):"paused"===e&&(i.pull.removeListener("paused",f),i.push.removeListener("paused",d))})),this.pull.on("removeListener",g("pull")),this.push.on("removeListener",g("push"));var y=Promise.all([this.push,this.pull]).then((function(e){var t={push:e[0],pull:e[1]};return i.emit("complete",t),r&&r(null,t),i.removeAllListeners(),t}),(function(e){if(i.cancel(),r?r(e):i.emit("error",e),i.removeAllListeners(),r)throw e}));this.then=function(e,t){return y.then(e,t)},this.catch=function(e){return y.catch(e)}}v()(nr,y.EventEmitter),nr.prototype.cancel=function(){this.cancelled=!0,this.state="cancelled",this.emit("cancel")},nr.prototype.ready=function(e,t){var n=this;function r(){n.cancel()}n._readyCalled||(n._readyCalled=!0,e.once("destroyed",r),t.once("destroyed",r),n.once("complete",(function(){e.removeListener("destroyed",r),t.removeListener("destroyed",r)})))},v()(or,y.EventEmitter),or.prototype.cancel=function(){this.canceled||(this.canceled=!0,this.push.cancel(),this.pull.cancel())},nt.plugin((function(e){e.adapter("idb",dn,!0)})).plugin((function(e){e.adapter("http",wn,!1),e.adapter("https",wn,!1)})).plugin(zn).plugin((function(e){e.replicate=ir,e.sync=sr,Object.defineProperty(e.prototype,"replicate",{get:function(){var e=this;return void 0===this.replicateMethods&&(this.replicateMethods={from:function(t,n,r){return e.constructor.replicate(t,e,n,r)},to:function(t,n,r){return e.constructor.replicate(e,t,n,r)}}),this.replicateMethods}}),e.prototype.sync=function(e,t,n){return this.constructor.sync(this,e,t,n)}})),t.default=nt}.call(this,n(14),n(42))},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(39),i=n(45),s=n(57),o=n(59);t.default=class{constructor(e){i.parseManifest(e.manifest)||console.error("Unable to parse the manifest"),this.params=e,this.manifest=e.manifest}setupEdit(e){(void 0!==e.NeumeEdit||void 0!==e.TextEdit&&void 0!==e.TextView)&&s.prepareEditMode(this),void 0!==e.NeumeEdit&&(this.NeumeEdit=new e.NeumeEdit(this)),void 0!==e.TextView&&(this.textView=new e.TextView(this),void 0!==e.TextEdit&&(this.TextEdit=new e.TextEdit(this)))}start(){o.default().then(()=>(this.view=new this.params.View(this,this.params.Display,this.manifest.image),this.name=this.manifest.title,this.core=new r.default(this.manifest),this.info=new this.params.Info(this),window.setTimeout(this.setupEdit.bind(this),2e3,this.params),this.core.initDb())).then(()=>{this.updateForCurrentPage(!0)})}updateForCurrentPage(e=!1){const t=this.view.getCurrentPage();return this.view.changePage(t,e)}redo(){return this.core.redo(this.view.getCurrentPageURI())}undo(){return this.core.undo(this.view.getCurrentPageURI())}getUserMode(){return void 0!==this.NeumeEdit?this.NeumeEdit.getUserMode():void 0!==this.TextEdit?"edit":"viewer"}edit(e,t){return this.core.edit(e,t)}getElementAttr(e,t){return this.core.getElementAttr(e,t)}export(){return new Promise((e,t)=>{this.core.updateDatabase().then(()=>{this.manifest.mei_annotations=this.core.getAnnotations(),this.manifest.timestamp=(new Date).toISOString();const t=new window.Blob([JSON.stringify(this.manifest,null,2)],{type:"application/ld+json"}),n=new FileReader;n.addEventListener("load",()=>{e(n.result)}),n.readAsDataURL(t)}).catch(e=>{t(e)})})}save(){return this.core.updateDatabase()}deleteDb(){return this.core.deleteDb()}getPageURI(e){return void 0===e&&(e=this.view.getCurrentPageURI()),new Promise(t=>{this.core.getMEI(e).then(e=>{t("data:application/mei+xml;charset=utf-8,"+encodeURIComponent(e))})})}getPageMEI(e){return this.core.getMEI(e)}getPageSVG(e){return this.core.getSVG(e)}}},function(e,t,n){var r=n(43),i=n(44),s=i;s.v1=r,s.v4=i,e.exports=s},function(e,t,n){"use strict";function r(e,t,n){var r=n[n.length-1];e===r.element&&(n.pop(),r=n[n.length-1]);var i=r.element,s=r.index;if(Array.isArray(i))i.push(e);else if(s===t.length-2){i[t.pop()]=e}else t.push(e)}t.stringify=function(e){var t=[];t.push({obj:e});for(var n,r,i,s,o,a,c,l,u,d,f="";n=t.pop();)if(r=n.obj,f+=n.prefix||"",i=n.val||"")f+=i;else if("object"!=typeof r)f+=void 0===r?null:JSON.stringify(r);else if(null===r)f+="null";else if(Array.isArray(r)){for(t.push({val:"]"}),s=r.length-1;s>=0;s--)o=0===s?"":",",t.push({obj:r[s],prefix:o});t.push({val:"["})}else{for(c in a=[],r)r.hasOwnProperty(c)&&a.push(c);for(t.push({val:"}"}),s=a.length-1;s>=0;s--)u=r[l=a[s]],d=s>0?",":"",d+=JSON.stringify(l)+":",t.push({obj:u,prefix:d});t.push({val:"{"})}return f},t.parse=function(e){for(var t,n,i,s,o,a,c,l,u,d=[],f=[],h=0;;)if("}"!==(t=e[h++])&&"]"!==t&&void 0!==t)switch(t){case" ":case"\t":case"\n":case":":case",":break;case"n":h+=3,r(null,d,f);break;case"t":h+=3,r(!0,d,f);break;case"f":h+=4,r(!1,d,f);break;case"0":case"1":case"2":case"3":case"4":case"5":case"6":case"7":case"8":case"9":case"-":for(n="",h--;;){if(i=e[h++],!/[\d\.\-e\+]/.test(i)){h--;break}n+=i}r(parseFloat(n),d,f);break;case'"':for(s="",o=void 0,a=0;'"'!==(c=e[h++])||"\\"===o&&a%2==1;)s+=c,"\\"===(o=c)?a++:a=0;r(JSON.parse('"'+s+'"'),d,f);break;case"[":l={element:[],index:d.length},d.push(l.element),f.push(l);break;case"{":u={element:{},index:d.length},d.push(u.element),f.push(u);break;default:throw new Error("unexpectedly reached end of input: "+t)}else{if(1===d.length)return d.pop();r(d.pop(),d,f)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(7);t.default=class{constructor(e,t,n,r){this.view=e,this.className=t,this.background=n,this.zoomHandler=r,document.getElementById("display_controls").innerHTML=function(e){let t="<p class='panel-heading' id='displayHeader'>Display<svg class='icon is-pulled-right'><use id='toggleDisplay' xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></p><div id='displayContents'>";return void 0!==e&&(t+="<a class='panel-block has-text-centered'><button class='button' id='reset-zoom'>Zoom</button><input class='slider is-fullwidth' id='zoomSlider' step='5' min='25' max='400' value='100' type='range'/><output id='zoomOutput' for='zoomSlider'>100</output></a>"),t+="<a class='panel-block has-text-centered'><button class='button' id='reset-opacity'>Glyph Opacity</button><input class='slider is-fullwidth' id='opacitySlider' step='5' min='0' max='100' value='100' type='range'/><output id='opacityOutput' for='opacitySlider'>100</output></a><a class='panel-block has-text-centered'><button class='button' id='reset-bg-opacity'>Image Opacity</button><input class='slider is-fullwidth' id='bgOpacitySlider' step='5' min='0' max='100' value='100' type='range'/><output id='bgOpacityOutput' for='bgOpacitySlider'>100</output></a><div class='panel-block' id='extensible-block'><div class='dropdown' id='highlight-dropdown'><div class='dropdown-trigger'><button class='button' id='highlight-button' aria-haspopup='true' aria-controls='highlight-menu' style='width: auto'><span>Highlight</span><span id='highlight-type'>&nbsp;- Off</span><svg class='icon'><use id='toggleDisplay' xlink:href='/Neon/Neon-gh/assets/img/icons.svg#dropdown-down'></use></svg></button></div><div class='dropdown-menu' id='highlight-menu' role='menu'><div class='dropdown-content'><a class='dropdown-item' id='highlight-staff'>Staff</a><a class='dropdown-item' id='highlight-syllable'>Syllable</a><a class='dropdown-item' id='highlight-neume'>Neume</a><hr class='dropdown-divider'/><a class='dropdown-item' id='highlight-none'>None</a></div></div></div></div></div>",t}(this.zoomHandler),this.view.addUpdateCallback(this.updateVisualization.bind(this))}setDisplayListeners(){this.zoomHandler&&r.setZoomControls(this.zoomHandler),r.initDisplayControls(this.className,this.background)}updateVisualization(){r.setOpacityFromSlider(this.className),r.updateHighlight()}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(e,t,n){this.neonView=e,this.updateCallbacks=[],this.divaReady=!1,this.diva=new Diva("container",{objectData:n}),document.getElementById("container").style.minHeight="100%",this.indexMap=new Map,this.diva.disableDragScrollable(),this.displayPanel=new t(this,"neon-container","diva-viewer-canvas"),this.loadDelay=500,this.initDivaEvents(),this.setViewEventHandlers(),window.onresize=()=>{const e=window.innerHeight,t=window.innerWidth;window.setTimeout(()=>{e===window.innerHeight&&t===window.innerWidth&&this.changePage(this.getCurrentPage(),!1)},this.loadDelay)}}initDivaEvents(){Diva.Events.subscribe("ManifestDidLoad",this.parseManifest.bind(this),this.diva.settings.ID),Diva.Events.subscribe("ObjectDidLoad",this.didLoad.bind(this),this.diva.settings.ID),Diva.Events.subscribe("ActivePageDidChange",this.changePage.bind(this),this.diva.settings.ID),Diva.Events.subscribe("ZoomLevelDidChange",this.adjustZoom.bind(this),this.diva.settings.ID)}async changePage(e,t=!0){function n(e){if(e===this.getCurrentPage()){const t=this.indexMap.get(e);this.neonView.getPageSVG(t).then(t=>{this.updateSVG(t,e);const n="neon-container-"+e,r=document.getElementById(n);null!==r&&r.classList.add("active-page"),this.updateCallbacks.forEach(e=>e())}).catch(e=>{"not_found"!==e.name&&"missing_mei"!==e.name&&console.error(e)})}}const r=[e];Array.from(document.getElementsByClassName("active-page")).forEach(e=>{e.classList.remove("active-page")});for(const e of r)t?window.setTimeout(n.bind(this),this.loadDelay,e):n.bind(this)(e)}getCurrentPage(){return this.diva.getActivePageIndex()}getCurrentPageURI(){return this.indexMap.get(this.getCurrentPage())}adjustZoom(){new Promise(e=>{Array.from(document.getElementsByClassName("neon-container")).forEach(e=>{e.style.display="none"}),setTimeout(e,this.diva.settings.zoomDuration+100)}).then(()=>{this.changePage(this.diva.getActivePageIndex(),!0),Array.from(document.getElementsByClassName("neon-container")).forEach(e=>{const t=e.firstChild,n=parseInt(e.id.match(/\d+/)[0]);this.updateSVG(t,n),e.style.display=""})})}updateSVG(e,t){const n=document.getElementById("diva-1-inner"),r=this.diva.getPageDimensionsAtCurrentZoomLevel(t),i=this.diva.settings.viewHandler._viewerCore.getPageRegion(t,{includePadding:!0,incorporateViewport:!0}),s=window.getComputedStyle(n,null).getPropertyValue("margin-left"),o="neon-container-"+t.toString();let a=document.getElementById(o);for(null===a&&(a=document.createElement("div"),a.id=o,a.classList.add("neon-container"),n.appendChild(a));a.firstChild;)a.removeChild(a.firstChild);e.setAttribute("width",r.width),e.setAttribute("height",r.height),a.style.position="absolute",a.style.top=`${i.top}px`,a.style.left=`${i.left-parseInt(s)}px`,a.appendChild(e)}didLoad(){this.divaReady=!0,this.displayPanel.setDisplayListeners(),document.getElementById("loading").style.display="none",console.log(this.diva)}addUpdateCallback(e){this.updateCallbacks.push(e)}removeUpdateCallback(e){const t=this.updateCallbacks.findIndex(t=>t===e);-1!==t&&this.updateCallbacks.splice(t,1)}setViewEventHandlers(){document.body.addEventListener("keydown",e=>{switch(e.key){case"h":for(const e of document.getElementsByClassName("neon-container"))e.style.visibility="hidden"}}),document.body.addEventListener("keyup",e=>{switch(e.key){case"h":for(const e of document.getElementsByClassName("neon-container"))e.style.visibility=""}})}parseManifest(e){this.indexMap.clear();for(const t of e.sequences)for(const e of t.canvases)this.indexMap.set(t.canvases.indexOf(e),e["@id"])}getPageName(){return this.diva.settings.manifest.itemTitle+"  "+this.diva.settings.manifest.pages[this.getCurrentPage()].l}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(7),i=n(60),s=n(3);t.default=class{constructor(e,t,n){this.neonView=e,this.container=document.getElementById("container"),this.updateCallbacks=new Array(0),this.group=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.group.id="svg_group",this.group.setAttribute("height",window.innerHeight.toString()),this.group.setAttribute("width","100%"),this.bg=document.createElementNS("http://www.w3.org/2000/svg","image"),this.bg.id="bgimg",this.bg.classList.add("background"),this.bg.setAttribute("x","0"),this.bg.setAttribute("y","0");const r=new FileReader;fetch(n).then(e=>{if(e.ok)return r.addEventListener("load",()=>{this.bg.setAttributeNS("http://www.w3.org/1999/xlink","href",r.result.toString());const e=this.bg.getBBox();this.group.hasAttribute("viewBox")||this.group.setAttribute("viewBox","0 0 "+e.width.toString()+" "+e.height.toString())}),e.blob()}).then(e=>{r.readAsDataURL(e)}),this.mei=document.createElementNS("http://www.w3.org/svg","svg"),this.mei.id="mei_output",this.mei.classList.add("neon-container","active-page"),this.group.appendChild(this.bg),this.group.appendChild(this.mei),this.container.appendChild(this.group),this.zoomHandler=new i.default,this.displayPanel=new t(this,"neon-container","background",this.zoomHandler),this.setViewEventHandlers(),this.displayPanel.setDisplayListeners(),this.pageURI=n,document.getElementById("loading").style.display="none"}updateSVG(e){this.group.replaceChild(e,this.mei),this.mei=e,this.mei.id="mei_output",this.mei.classList.add("neon-container","active-page");const t=parseInt(this.mei.getAttribute("height")),n=parseInt(this.mei.getAttribute("width"));this.bg.setAttribute("height",t.toString()),this.bg.setAttribute("width",n.toString()),this.group.setAttribute("viewBox","0 0 "+n+" "+t),r.updateHighlight(),this.resetTransformations(),this.updateCallbacks.forEach(e=>e())}async changePage(e,t){const n=await this.neonView.getPageSVG(this.getCurrentPageURI());this.updateSVG(n)}addUpdateCallback(e){this.updateCallbacks.push(e)}removeUpdateCallback(e){const t=this.updateCallbacks.findIndex(t=>t===e);-1!==t&&this.updateCallbacks.splice(t,1)}resetTransformations(){this.displayPanel.zoomHandler.restoreTransformation(),r.setOpacityFromSlider()}getCurrentPage(){return 0}getCurrentPageURI(){return this.pageURI}setViewEventHandlers(){document.body.addEventListener("keydown",e=>{switch(e.key){case"Shift":s.select("#svg_group").on(".drag",null),s.select("#svg_group").call(s.drag().on("start",this.displayPanel.zoomHandler.startDrag.bind(this.displayPanel.zoomHandler)).on("drag",this.displayPanel.zoomHandler.dragging.bind(this.displayPanel.zoomHandler)));break;case"h":document.getElementById("mei_output").setAttribute("visibility","hidden")}}),document.body.addEventListener("keyup",e=>{switch(e.key){case"Shift":s.select("#svg_group").on(".drag",null),"viewer"!==this.neonView.getUserMode()&&this.neonView.NeumeEdit.setSelectListeners();break;case"h":document.getElementById("mei_output").setAttribute("visibility","visible")}}),s.select("#container").on("touchstart",()=>{2===s.event.touches.length&&(this.displayPanel.zoomHandler.startDrag(),s.select("#container").on("touchmove",this.displayPanel.zoomHandler.dragging.bind(this.displayPanel.zoomHandler)),s.select("#container").on("touchend",()=>{s.select("#container").on("touchmove",null)}))}),s.select("#container").on("wheel",this.displayPanel.zoomHandler.scrollZoom.bind(this.displayPanel.zoomHandler),!1),window.onresize=()=>{const e=window.innerHeight,t=document.getElementById("container");e>Number(t.getAttribute("height"))&&t.setAttribute("height",e.toString())}}getPageName(){return this.neonView.name}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(34),i=n(18),s=n(37),o=n(10),a=n(7),c=n(11);t.default=class{constructor(e){this.neonView=e,r.initEditModeControls(this)}initEditMode(){this.dragHandler=new c.default(this.neonView,".active-page > svg"),this.insertHandler=new s.default(this.neonView,".active-page > svg"),r.bindInsertTabs(this.insertHandler),document.getElementById("primitiveTab").click(),i.setSelectHelperObjects(this.neonView,this.dragHandler),this.setSelectListeners(),o.initNeonView(this.neonView),r.initInsertEditControls();const e=document.getElementById("editMenu");e.style.backgroundColor="#ffc7c7",e.style.fontWeight="bold",i.setSelectStrokeWidth(1),r.initSelectionButtons(),a.setHighlightSelectionControls(),this.neonView.view.addUpdateCallback(this.setSelectListeners.bind(this))}getUserMode(){return void 0!==this.insertHandler?this.insertHandler.isInsertMode()?"insert":"edit":"viewer"}setSelectListeners(){i.clickSelect(".active-page > svg > svg, .active-page > svg > svg use, .active-page > svg > svg rect"),i.dragSelect(".active-page svg")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(34),i=n(7),s=n(18),o=n(37),a=n(10),c=n(11);t.default=class{constructor(e){this.neonView=e,r.initEditModeControls(this)}initEditMode(){this.dragHandler=new c.default(this.neonView,"#svg_group"),this.insertHandler=new o.default(this.neonView,"#svg_group"),r.bindInsertTabs(this.insertHandler),document.getElementById("primitiveTab").click(),s.setSelectHelperObjects(this.neonView,this.dragHandler),this.setSelectListeners(),a.initNeonView(this.neonView),r.initInsertEditControls();const e=document.getElementById("editMenu");e.style.backgroundColor="#ffc7c7",e.style.fontWeight="bold",r.initSelectionButtons(),i.setHighlightSelectionControls(),this.neonView.view.addUpdateCallback(this.setSelectListeners.bind(this))}getUserMode(){return void 0!==this.insertHandler?this.insertHandler.isInsertMode()?"insert":"edit":"viewer"}setSelectListeners(){s.clickSelect("#svg_group, #svg_group use, #svg_group rect"),s.dragSelect("#svg_group")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=new Map([["","Punctum"],["u","Pes"],["d","Clivis"],["uu","Scandicus"],["ud","Torculus"],["du","Porrectus"],["s","Distropha"],["ss","Tristopha"],["sd","Pressus"],["dd","Climacus"],["ddu","Climacus resupinus"],["udu","Torculus resupinus"],["dud","Porrectus flexus"],["udd","Pes subpunctis"],["uud","Scandicus flexus"],["uudd","Scandicus subpunctis"],["dudd","Porrectus subpunctis"]]);function i(){const e=document.getElementById("neume_info");document.getElementById("displayInfo").checked?e.setAttribute("style",""):e.setAttribute("style","display: none")}function s(){document.getElementById("neume_info").innerHTML="<article class='message'><div class='message-header'><p></p></div><div class='message-body'></div>",document.getElementById("neume_info").setAttribute("style","display: none"),i(),document.getElementById("displayInfo").addEventListener("click",i)}t.default=class{constructor(e){this.neonView=e;const t=document.getElementById("extensible-block"),n=document.createElement("label");n.classList.add("checkbox"),n.textContent="Display Info: ";const r=document.createElement("input");r.classList.add("checkbox"),r.id="displayInfo",r.type="checkbox",r.checked=!1,n.appendChild(r),t.prepend(n),this.neonView.view.addUpdateCallback(this.resetInfoListeners.bind(this)),s(),this.resetInfoListeners()}infoListeners(){try{document.getElementsByClassName("active-page")[0].querySelectorAll(".neume,.custos,.clef").forEach(e=>{e.addEventListener("mouseover",this.updateInfo.bind(this))})}catch(e){}}stopListeners(){document.querySelectorAll(".neume,.custos,.clef").forEach(e=>{e.removeEventListener("mouseover",this.updateInfo.bind(this))})}resetInfoListeners(){this.stopListeners(),this.infoListeners()}async updateInfo(e){const t=e.currentTarget.id;if(""===t)return Array.from(document.getElementById("neume_info").children).forEach(e=>{e.remove()}),void console.log("No id!");const n=document.getElementById(t),r=n.getAttribute("class").match(/neume|nc|clef|custos|staff/)[0];let i,s="";switch(r){case"neume":const e=n.querySelectorAll(".nc");let r=await this.getContour(e);if("Clivis"===r){(await this.neonView.getElementAttr(e[0].id,this.neonView.view.getCurrentPageURI())).ligated&&(r="Ligature")}let o=await this.getPitches(e);o=o.trim().toUpperCase(),s="Shape: "+(void 0===r?"Compound":r)+"\r\nPitch(es): "+o;break;case"custos":i=await this.neonView.getElementAttr(t,this.neonView.view.getCurrentPageURI()),s+="Pitch: "+i.pname.toUpperCase()+i.oct;break;case"clef":i=await this.neonView.getElementAttr(t,this.neonView.view.getCurrentPageURI()),s+="Shape: "+i.shape+"\r\nLine: "+i.line;break;default:s+="nothing"}this.updateInfoModule(r,s)}async getPitches(e){let t="";for(const n of e){const e=await this.neonView.getElementAttr(n.id,this.neonView.view.getCurrentPageURI());t+=e.pname+e.oct+" "}return t}async getContour(e){let t="",n=null;for(const r of e){const e=await this.neonView.getElementAttr(r.id,this.neonView.view.getCurrentPageURI());null!==n&&(n.oct>e.oct?t+="d":n.oct<e.oct?t+="u":this.pitchNameToNum(n.pname)<this.pitchNameToNum(e.pname)?t+="u":this.pitchNameToNum(n.pname)>this.pitchNameToNum(e.pname)?t+="d":t+="s"),n=e}return void 0===r.get(t)&&console.warn("Unknown contour: "+t),r.get(t)}updateInfoModule(e,t){document.getElementsByClassName("message-header")[0].querySelector("p").textContent=e,document.getElementsByClassName("message-body")[0].innerText=t,document.getElementById("displayInfo").checked&&(document.getElementsByClassName("message")[0].style.display="")}pitchNameToNum(e){switch(e){case"c":return 1;case"d":return 2;case"e":return 3;case"f":return 4;case"g":return 5;case"a":return 6;case"b":return 7;default:console.log("Unknown pitch name")}}getContourByValue(e){for(const[t,n]of r.entries())if(n===e)return t}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),i=n(4),s=n(7);t.default=class{constructor(e){this.neonView=e,this.notificationSent=!1;const t=document.getElementById("extensible-block"),n=document.createElement("label"),r=document.createElement("label"),i=document.createElement("input"),s=document.createElement("input");n.classList.add("checkbox"),r.classList.add("checkbox"),n.textContent="Display Text: ",r.textContent="Display Text BBoxes: ",i.classList.add("checkbox"),s.classList.add("checkbox"),i.id="displayText",i.type="checkbox",s.id="displayBBox",s.type="checkbox",i.checked=!1,s.checked=!1,n.appendChild(i),r.appendChild(s),t.prepend(r),t.prepend(n),this.setTextViewControls(),this.neonView.view.addUpdateCallback(this.updateTextViewVisibility.bind(this)),this.neonView.view.addUpdateCallback(this.updateBBoxViewVisibility.bind(this))}setTextViewControls(){this.updateTextViewVisibility(),this.updateBBoxViewVisibility(),document.getElementById("displayText").addEventListener("click",function(){this.updateTextViewVisibility()}.bind(this)),document.getElementById("displayBBox").addEventListener("click",function(){this.updateBBoxViewVisibility()}.bind(this))}updateBBoxViewVisibility(){if(document.getElementById("displayBBox").checked)document.querySelectorAll(".sylTextRect").forEach(e=>{e.classList.add("sylTextRect-display"),e.classList.remove("sylTextRect")}),document.querySelectorAll(".syl.selected .sylTextRect-display").forEach(e=>{e.style.fill="red"}),"viewer"!==this.neonView.getUserMode()&&void 0!==this.neonView.TextEdit&&this.neonView.TextEdit.initSelectByBBoxButton();else{null!==document.getElementById("selByBBox")&&document.getElementById("selByBBox").classList.contains("is-active")&&(i.unselect(),document.getElementById("selByBBox").classList.remove("is-active"),document.getElementById("selBySyl").classList.add("is-active")),document.querySelectorAll(".sylTextRect-display").forEach(e=>{e.classList.add("sylTextRect"),e.classList.remove("sylTextRect-display")}),document.querySelectorAll(".syl.selected .sylTextRect").forEach(e=>{e.style.fill="none"});try{document.getElementById("selByBBox").style.display="none"}catch(e){}}s.updateHighlight()}updateTextViewVisibility(){if(document.getElementById("displayText").checked){const e=document.getElementById("syl_text");e.style.display="",e.innerHTML="<p>"+this.getSylText()+"</p>",e.querySelectorAll("p > span").forEach(e=>{const t=document.getElementById(e.className),n=t.querySelector(".syl"),r=n.querySelector("text"),i=n.querySelector("rect");0===r.classList.length&&r.classList.add("text"),e.addEventListener("mouseover",()=>{t.classList.add("selected"),t.querySelectorAll(".neume").forEach(e=>{e.classList.add("selected")}),null!==i&&(i.style.fill="#d00")}),e.addEventListener("mouseleave",()=>{t.classList.remove("selected"),t.querySelectorAll(".neume").forEach(e=>{e.classList.remove("selected")}),null!==i&&("rgb(0, 0, 0)"!==t.style.fill?i.style.fill=t.getAttribute("fill"):i.style.fill="blue")})}),"viewer"!==this.neonView.getUserMode()&&void 0!==this.neonView.TextEdit&&this.neonView.TextEdit.initTextEdit()}else document.getElementById("syl_text").style.display="none"}getSylText(){let e="";return document.querySelectorAll(".active-page .syllable").forEach(t=>{if(null!==t.querySelector(".syl")){const n=t.querySelector(".syl");e+="<span class='"+t.id+"'>",""===n.textContent.trim()?e+="&#x25CA; ":Array.from(n.children[0].children[0].children).forEach(t=>{e+=""!==t.textContent?t.textContent:"&#x25CA; "}),e+=" </span>"}}),this.notificationSent||(r.queueNotification("Blank syllables are represented by &#x25CA;!"),this.notificationSent=!0),e.replace(/\ue551/g,"-")}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(4),i=n(11),s=n(18),o=n(9);function a(){if(!document.getElementById("selByBBox").classList.contains("is-active")){r.unselect();try{document.getElementById("moreEdit").innerHTML="",document.getElementById("extraEdit").innerHTML="",document.getElementById("extraEdit").classList.add("is-invisible")}catch(e){}document.getElementById("selByBBox").classList.add("is-active");try{document.getElementById("selByNc").classList.remove("is-active"),document.getElementById("selByNeume").classList.remove("is-active"),document.getElementById("selByStaff").classList.remove("is-active"),document.getElementById("selBySyl").classList.remove("is-active")}catch(e){}try{"highlight-selection"===document.querySelector(".highlight-selected").id&&o.setGroupingHighlight("syllable")}catch(e){}}this.addBBoxListeners()}t.default=class{constructor(e){this.neonView=e,this.initEditModeControls()}initEditModeControls(){document.getElementById("edit_mode").addEventListener("click",()=>{this.initTextEdit(),document.getElementById("displayBBox").checked&&this.initSelectByBBoxButton()})}initTextEdit(){document.getElementById("syl_text").querySelectorAll("p > span").forEach(e=>{function t(){this.updateSylText(e)}e.removeEventListener("click",t.bind(this)),e.addEventListener("click",t.bind(this))})}initSelectByBBoxButton(){if(void 0!==this.neonView.NeumeEdit){const e=document.getElementById("selByBBox");if(e)return void(e.style.display="");const t=document.getElementById("selBySyl").closest(".control").closest(".field"),n=document.createElement("p");n.classList.add("control");const r=document.createElement("button");r.classList.add("button","sel-by"),r.id="selByBBox",r.textContent="BBox",n.appendChild(r),t.appendChild(n),r.addEventListener("click",a.bind(this)),document.body.addEventListener("keydown",e=>{"5"===e.key&&""===document.getElementById("selByBBox").style.display&&a.bind(this)()}),this.neonView.view.addUpdateCallback(this.addBBoxListeners.bind(this))}else{const e=document.getElementById("undo").closest(".control"),t=document.createElement("p");t.classList.add("control");const n=document.createElement("button");n.classList.add("button","sel-by"),n.id="selByBBox",n.textContent="BBox",t.appendChild(n),e.appendChild(t),n.classList.add("is-active"),n.style.display="none",this.addBBoxListeners(),this.neonView.view.addUpdateCallback(this.addBBoxListeners.bind(this))}}addBBoxListeners(){document.getElementById("selByBBox").classList.contains("is-active")&&(r.unselect(),void 0===this.neonView.NeumeEdit&&(this.dragHandler=new i.default(this.neonView,".sylTextRect-display"),s.setSelectHelperObjects(this.neonView,this.dragHandler),"SingleView"===this.neonView.view.constructor.name?(s.clickSelect("#mei_output, #mei_output rect"),s.dragSelect("#svg_group")):(s.clickSelect(".active-page > svg > svg, .active-page > svg > svg rect"),s.dragSelect(".active-page svg"))))}updateSylText(e){const t=e.textContent.replace(/\u{25CA}/u,"").trim();const n=window.prompt("",t);if(null!==n&&n!==t){const t={action:"setText",param:{elementId:[...e.classList.entries()].filter(e=>"text-select"!==e[1])[0][1],text:n}};this.neonView.edit(t,this.neonView.view.getCurrentPageURI()).then(e=>{e&&this.neonView.updateForCurrentPage()})}}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(13);function i(e,t){for(const n of e.attributes)t.setAttribute(n.name,n.value)}t.zip=function(e,t){const n=[];for(let r=0;r<(e.length>t.length?t.length:e.length);r++)n.push([e[r],t[r]]);return n},t.convertStaffToSb=function(e){const t=new DOMParser,n=new XMLSerializer,r=t.parseFromString(e,"text/xml"),i=r.documentElement,s=new Set;for(const e of i.getElementsByTagName("section")){const t=r.createElementNS("http://www.music-encoding.org/ns/mei","staff"),n=r.createElementNS("http://www.music-encoding.org/ns/mei","layer");t.setAttribute("n","1"),n.setAttribute("n","1"),t.appendChild(n);const i=Array.from(e.getElementsByTagName("staff"));for(const e of i){const t=e.getElementsByTagName("layer")[0],i=r.createElementNS("http://www.music-encoding.org/ns/mei","sb");i.setAttribute("n",e.getAttribute("n")),i.setAttribute("facs",e.getAttribute("facs")),i.setAttribute("xml:id",e.getAttribute("xml:id"));let o=void 0;null!==n.lastElementChild&&"custos"===n.lastElementChild.tagName&&(o=n.removeChild(n.lastElementChild));const a=n.lastElementChild;null!==a&&"syllable"===a.tagName&&a.hasAttribute("precedes")?(void 0!==o&&a.appendChild(o),a.appendChild(i)):(void 0!==o&&n.appendChild(o),n.appendChild(i));for(const e of s){const n=e.getAttribute("precedes"),r=Array.from(t.getElementsByTagName("syllable")).filter(e=>"#"+e.getAttribute("xml:id")===n).pop();if(void 0!==r){for(null!==r.previousElementSibling&&"clef"===r.previousElementSibling.tagName&&e.append(r.previousElementSibling);null!==r.firstChild;)e.append(r.firstChild);r.remove(),e.removeAttribute("precedes"),s.delete(e)}}for(;null!==t.firstElementChild;)t.firstElementChild.hasAttribute("precedes")&&s.add(t.firstElementChild),n.appendChild(t.firstElementChild);e.remove()}e.appendChild(t)}return n.serializeToString(r)},t.convertSbToStaff=function(e){const t=(new DOMParser).parseFromString(e,"text/xml"),n=t.documentElement;for(const e of n.getElementsByTagName("section")){const n=Array.from(e.getElementsByTagName("staff"));for(const s of n){const n=s.getElementsByTagName("layer")[0],o=Array.from(n.getElementsByTagName("sb"));for(const e of o)if("layer"!==e.parentElement.tagName){const n=e.parentElement;let i=!1,s=!1;const o=Array.from(n.children),a=o.indexOf(e);for(const e of n.getElementsByTagName("neume")){const t=o.indexOf(e);t<a?i=!0:t>a&&(s=!0)}if(!i&&s)n.insertAdjacentElement("beforebegin",e);else if(i&&!s)n.insertAdjacentElement("afterend",e);else if(i&&s){const i=t.createElementNS("http://www.music-encoding.org/ns/mei","syllable");i.setAttribute("xml:id","m-"+r.uuidv4()),i.setAttribute("follows","#"+n.getAttribute("xml:id")),n.setAttribute("precedes","#"+i.getAttribute("xml:id"));const s=o.indexOf(e);for(const e of o){o.indexOf(e)>s&&i.appendChild(e)}n.insertAdjacentElement("afterend",e),e.insertAdjacentElement("afterend",i);for(const e of n.getElementsByTagName("custos"))n.insertAdjacentElement("afterend",e);for(const e of i.getElementsByTagName("clef"))i.insertAdjacentElement("beforebegin",e)}else console.warn("NONE BEHIND NONE AHEAD"),console.debug(n)}const a=Array.from(n.getElementsByTagName("sb"));for(let o=0;o<a.length;o++){const c=a[o],l=a.length>o+1?a[o+1]:void 0,u=t.createElementNS("http://www.music-encoding.org/ns/mei","staff");i(c,u);const d=t.createElementNS("http://www.music-encoding.org/ns/mei","layer");d.setAttribute("n","1"),d.setAttribute("xml:id","m-"+r.uuidv4()),u.appendChild(d);const f=Array.from(n.children),h=f.slice(f.indexOf(c)+1,f.indexOf(l));for(const e of h)d.appendChild(e);e.insertBefore(u,s)}s.remove()}}for(const e of n.querySelectorAll("syllable")){for(const t of e.querySelectorAll("clef"))e.insertAdjacentElement("beforebegin",t);for(const t of e.querySelectorAll("custos"))e.insertAdjacentElement("afterend",t)}return(new XMLSerializer).serializeToString(t)}},function(e,t){var n="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(n){var r=new Uint8Array(16);e.exports=function(){return n(r),r}}else{var i=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),i[t]=e>>>((3&t)<<3)&255;return i}}},function(e,t){for(var n=[],r=0;r<256;++r)n[r]=(r+256).toString(16).substr(1);e.exports=function(e,t){var r=t||0,i=n;return[i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],"-",i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]],i[e[r++]]].join("")}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(17),i=n(9),s=n(4);function o(e,t){document.getElementById(e).classList.add("is-active"),document.getElementById(e).classList.contains("insertel")&&t.insertActive(e)}function a(e){document.querySelectorAll(e).forEach(e=>{e.classList.remove("is-active")})}t.initEditModeControls=function(e){document.getElementById("edit_mode").addEventListener("click",(function(){document.getElementById("insert_controls").innerHTML+=r.insertControlsPanel,document.getElementById("edit_controls").innerHTML+=r.editControlsPanel,e.initEditMode()}))},t.bindInsertTabs=function(e){const t=Array.from(document.getElementsByClassName("insertTab")).map(e=>e.id);document.body.addEventListener("keydown",t=>{if(t.code.match(/^Digit\d$/)&&t.shiftKey)try{const n=Number(t.code[t.code.length-1])-1,r=document.getElementsByClassName("insertel")[n];a(".insertel"),e.insertDisabled(),o(r.id,e)}catch(e){console.debug(e)}}),t.forEach(t=>{document.getElementById(t).addEventListener("click",()=>{a(".insertTab"),o(t,e),document.getElementById("insert_data").innerHTML=r.insertTabHtml[t],function(e){Array.from(document.getElementsByClassName("insertel")).map(e=>e.id).forEach(t=>{document.getElementById(t).addEventListener("click",()=>{a(".insertel"),o(t,e)})})}(e),a(".insertel"),o(document.getElementsByClassName("insertel")[0].id,e)})})},t.initInsertEditControls=function(){const e=document.getElementById("toggleInsert"),t=document.getElementById("toggleEdit"),n=document.getElementById("insertContents"),r=document.getElementById("editContents");e.parentElement.addEventListener("click",()=>{"none"===n.style.display?(n.style.display="",e.setAttribute("xlink:href","/Neon/Neon-gh/assets/img/icons.svg#dropdown-down")):(n.style.display="none",e.setAttribute("xlink:href","/Neon/Neon-gh/assets/img/icons.svg#dropdown-side"))}),t.parentElement.addEventListener("click",()=>{"none"===r.style.display?(r.style.display="",t.setAttribute("xlink:href","/Neon/Neon-gh/assets/img/icons.svg#dropdown-down")):(r.style.display="none",t.setAttribute("xlink:href","/Neon/Neon-gh/assets/img/icons.svg#dropdown-side"))})},t.initSelectionButtons=function(){const e=document.getElementById("selBySyl"),t=document.getElementById("selByNeume"),n=document.getElementById("selByNc"),r=document.getElementById("selByStaff");function o(){if(!e.classList.contains("is-active")){s.unselect(),document.getElementById("moreEdit").innerHTML="",document.getElementById("extraEdit").innerHTML="",document.getElementById("extraEdit").classList.add("is-invisible"),e.classList.add("is-active"),t.classList.remove("is-active"),n.classList.remove("is-active"),r.classList.remove("is-active");try{document.getElementById("selByBBox").classList.remove("is-active")}catch(e){}try{"highlight-selection"===document.querySelector(".highlight-selected").id&&i.setGroupingHighlight("syllable")}catch(e){}}}function a(){if(!t.classList.contains("is-active")){s.unselect(),document.getElementById("moreEdit").innerHTML="",document.getElementById("extraEdit").innerHTML="",document.getElementById("extraEdit").classList.add("is-invisible"),t.classList.add("is-active"),n.classList.remove("is-active"),e.classList.remove("is-active"),r.classList.remove("is-active");try{document.getElementById("selByBBox").classList.remove("is-active")}catch(e){}try{"highlight-selection"===document.querySelector(".highlight-selected").id&&i.setGroupingHighlight("neume")}catch(e){}}}function c(){if(!n.classList.contains("is-active")){s.unselect(),document.getElementById("moreEdit").innerHTML="",document.getElementById("extraEdit").innerHTML="",document.getElementById("extraEdit").classList.add("is-invisible"),n.classList.add("is-active"),t.classList.remove("is-active"),e.classList.remove("is-active"),r.classList.remove("is-active");try{document.getElementById("selByBBox").classList.remove("is-active")}catch(e){}try{"highlight-selection"===document.querySelector(".highlight-selected").id&&i.setGroupingHighlight("neume")}catch(e){}}}function l(){if(!r.classList.contains("is-active")){s.unselect(),document.getElementById("moreEdit").innerHTML="",document.getElementById("extraEdit").innerHTML="",document.getElementById("extraEdit").classList.add("is-invisible"),r.classList.add("is-active"),t.classList.remove("is-active"),n.classList.remove("is-active"),e.classList.remove("is-active");try{document.getElementById("selByBBox").classList.remove("is-active")}catch(e){}try{"highlight-selection"===document.querySelector(".highlight-selected").id&&i.setGroupingHighlight("staff")}catch(e){}}}e.addEventListener("click",o),document.body.addEventListener("keydown",e=>{"1"===e.key&&o()}),t.addEventListener("click",a),document.body.addEventListener("keydown",e=>{"2"===e.key&&a()}),n.addEventListener("click",c),document.body.addEventListener("keydown",e=>{"3"===e.key&&c()}),r.addEventListener("click",l),document.body.addEventListener("keydown",e=>{"4"===e.key&&l()})}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(17),i=n(61),s=n(8),o=n(10);let a;function c(){const e=document.getElementById("moreEdit");e.innerHTML="",e.classList.add("is-invisible"),document.body.removeEventListener("keydown",o.deleteButtonHandler)}function l(){const e=document.getElementById("delete");e.removeEventListener("click",o.removeHandler),e.addEventListener("click",o.removeHandler),document.body.addEventListener("keydown",o.deleteButtonHandler);try{document.getElementById("mergeSyls").addEventListener("click",()=>{u("group","neume",f().filter(e=>document.getElementById(e).classList.contains("neume")))})}catch(e){}try{document.getElementById("groupNeumes").addEventListener("click",()=>{u("group","neume",d())})}catch(e){}try{document.getElementById("groupNcs").addEventListener("click",()=>{u("group","nc",d())})}catch(e){}try{document.getElementById("ungroupNeumes").addEventListener("click",()=>{u("ungroup","neume",f())})}catch(e){}try{document.getElementById("ungroupNcs").addEventListener("click",()=>{u("ungroup","nc",f())})}catch(e){}try{document.getElementById("toggle-ligature").addEventListener("click",async()=>{const e=d();let t;if(/#E99[016]/.test(document.getElementById(e[0]).children[0].getAttribute("xlink:href"))){t=!1;const n={action:"chain",param:[o.unsetInclinatumAction(e[0]),o.unsetVirgaAction(e[0]),o.unsetInclinatumAction(e[1]),o.unsetVirgaAction(e[1])]};await a.edit(n,a.view.getCurrentPageURI())}else t=!0;const n={action:"toggleLigature",param:{elementIds:e,isLigature:t.toString()}};a.edit(n,a.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Ligature Toggled"):s.queueNotification("Ligature Toggle Failed"),c(),a.updateForCurrentPage()})})}catch(e){}try{document.getElementById("toggle-link").addEventListener("click",()=>{const e=d(),t={action:"chain",param:[]},n=new Array;if(document.getElementById(e[0]).getAttribute("mei:precedes"))n.push({action:"set",param:{elementId:e[0],attrType:"precedes",attrValue:""}}),n.push({action:"set",param:{elementId:e[1],attrType:"follows",attrValue:""}}),n.push({action:"setText",param:{elementId:e[1],text:""}});else if(document.getElementById(e[0]).getAttribute("mei:follows"))n.push({action:"set",param:{elementId:e[0],attrType:"follows",attrValue:""}}),n.push({action:"set",param:{elementId:e[1],attrType:"precedes",attrValue:""}}),n.push({action:"setText",param:{elementId:e[0],text:""}});else{const t=document.getElementById(e[0]),r=document.getElementById(e[1]),i=t.closest(".staff"),s=r.closest(".staff"),o=Array.from(i.parentElement.children).filter(e=>e.classList.contains("staff"));let a,c;o.indexOf(i)<o.indexOf(s)?(a=t,c=r):(a=r,c=t),n.push({action:"set",param:{elementId:a.id,attrType:"precedes",attrValue:"#"+c.id}}),n.push({action:"set",param:{elementId:c.id,attrType:"follows",attrValue:"#"+a.id}});const l=c.querySelector(".syl");null!==l&&n.push({action:"remove",param:{elementId:l.id}})}t.param=n,a.edit(t,a.view.getCurrentPageURI()).then(e=>{e?s.queueNotification("Toggled Syllable Link"):s.queueNotification("Failed to Toggle Syllable Link"),c(),a.updateForCurrentPage()})})}catch(e){}}function u(e,t,n){const r={action:e,param:{groupType:t,elementIds:n}};a.edit(r,a.view.getCurrentPageURI()).then(r=>{if(r?"group"===e?s.queueNotification("Grouping Success"):s.queueNotification("Ungrouping Success"):"group"===e?s.queueNotification("Grouping Failed"):s.queueNotification("Ungrouping Failed"),a.updateForCurrentPage(),"nc"===t){const e=document.getElementById(n[0]).parentElement,t=Array.from(e.children);void 0===a.info.getContour(t)&&i.groupingNotRecognized()}c()})}function d(){const e=[];return Array.from(document.getElementsByClassName("selected")).forEach(t=>{e.push(t.id)}),e}function f(){const e=[];return Array.from(document.getElementsByClassName("selected")).forEach(t=>{Array.from(t.children).forEach(t=>{e.push(t.id)})}),e}t.initNeonView=function(e){a=e},t.triggerGrouping=function(e){const t=document.getElementById("moreEdit");t.classList.remove("is-invisible"),t.innerHTML+=r.groupingMenu[e],l()},t.endGroupingSelection=c,t.initGroupingListeners=l},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(4),i=n(3),s={TopLeft:0,Top:1,TopRight:2,Right:3,BottomRight:4,Bottom:5,BottomLeft:6,Left:7};function o(e,t,n,r,i){let o;if(i>=0)o=[{x:e,y:t,name:s.TopLeft},{x:(e+n)/2,y:t+(n-e)/2*Math.sin(i),name:s.Top},{x:n,y:t+(n-e)*Math.sin(i),name:s.TopRight},{x:n,y:(t+r+(n-e)*Math.sin(i))/2,name:s.Right},{x:n,y:r,name:s.BottomRight},{x:(e+n)/2,y:r-(n-e)/2*Math.sin(i),name:s.Bottom},{x:e,y:r-(n-e)*Math.sin(i),name:s.BottomLeft},{x:e,y:(t+r-(n-e)*Math.sin(i))/2,name:s.Left}];else{const a=(n-e)*Math.tan(Math.abs(i)),c=r-t-a;o=[{x:e,y:t+a,name:s.TopLeft},{x:(e+n)/2,y:t+a/2,name:s.Top},{x:n,y:t,name:s.TopRight},{x:n,y:t+c/2,name:s.Right},{x:n,y:t+c,name:s.BottomRight},{x:(e+n)/2,y:r-a/2,name:s.Bottom},{x:e,y:r,name:s.BottomLeft},{x:e,y:r-c/2,name:s.Left}]}return o}t.resize=function(e,t,n){let a,c,l,u,d,f,h,p,m,g,v,y,b;function w(){const e=o(a,c,l,u,d),t=e.filter((e,t)=>t%2==0).map(e=>e.x+","+e.y).join(" ");i.select("#resizeRect").attr("points",t);for(const t in s){const n=e[s[t]];i.select("#p-"+t).filter(".resizePoint").attr("cx",n.x).attr("cy",n.y)}let n=e[3].x,r=e[3].y;const f=n+100+","+(r+85)+" "+(n+70)+","+(r+50)+" "+(n+100)+","+(r+15)+" "+(n+130)+","+(r+50);n=e[7].x,r=e[7].y;const h=n-100+","+(r-15)+" "+(n-130)+","+(r-50)+" "+(n-100)+","+(r-85)+" "+(n-70)+","+(r-50);i.select("#rotateLeft").attr("points",h),i.select("#rotateRight").attr("points",f)}!function _(){if(null===e)return;if(e.classList.contains("syl")){const t=e.querySelector(".sylTextRect-display");if(null===t)return void console.warn("Tried to draw resize rect for a sylTextRect that doesn't exist (or isn't displaying)");a=Number(t.getAttribute("x")),c=Number(t.getAttribute("y")),l=+a+ +t.getAttribute("width"),u=+c+ +t.getAttribute("height"),d=0}if(e.classList.contains("staff")){const t=r.getStaffBBox(e);a=t.ulx,c=t.uly,l=t.lrx,u=t.lry;const n=e.querySelector("path").getAttribute("d").match(/\d+/g).map(e=>Number(e));d=Math.atan((n[3]-n[1])/(n[2]-n[0]))}let E;const k=o(a,c,l,u,d);v=k[2].x-k[0].x;const x=k.filter((e,t)=>t%2==0).map(e=>e.x+","+e.y).join(" ");i.select("#"+e.id).append("polygon").attr("points",x).attr("id","resizeRect").attr("stroke","black").attr("stroke-width",10).attr("fill","none").style("cursor","move").style("stroke-dasharray","20 10");for(const t in s){const n=k[s[t]];i.select(e.viewportElement).append("circle").attr("cx",n.x).attr("cy",n.y).attr("r",25).attr("stroke","black").attr("stroke-width",4).attr("fill","#0099ff").attr("class","resizePoint").attr("id","p-"+t)}for(const e in s)i.select("#p-"+e).filter(".resizePoint").call(i.drag().on("start",()=>{L(e)}).on("drag",B).on("end",C.bind(this)));if(e.classList.contains("staff")){let t=k[3].x,n=k[3].y;const r=t+100+","+(n+85)+" "+(t+70)+","+(n+50)+" "+(t+100)+","+(n+15)+" "+(t+130)+","+(n+50);t=k[7].x,n=k[7].y;const o=t-100+","+(n-15)+" "+(t-130)+","+(n-50)+" "+(t-100)+","+(n-85)+" "+(t-70)+","+(n-50);i.select("#"+e.id).append("polygon").attr("points",r).attr("id","rotateRight").attr("stroke","black").attr("stroke-width",7).attr("fill","#0099ff").attr("class","rotatePoint"),i.select("#"+e.id).append("polygon").attr("points",o).attr("id","rotateLeft").attr("stroke","black").attr("stroke-width",7).attr("fill","#0099ff").attr("class","rotatePoint"),i.select("#rotateLeft").call(i.drag().on("start",S).on("drag",(function(){const e=i.mouse(this)[1]-m,t=b-Math.atan(e/v);t>-.2&&t<.2&&(y=e,c=g+y,d=t,d>=0?(c=y+k.filter(e=>e.name===s.TopLeft)[0].y,u=k.filter(e=>e.name===s.BottomRight)[0].y):(c=k.filter(e=>e.name===s.TopRight)[0].y,u=y+k.filter(e=>e.name===s.BottomLeft)[0].y));w()})).on("end",A)),i.select("#rotateRight").call(i.drag().on("start",S).on("drag",(function(){const e=i.mouse(this)[1]-m,t=b+Math.atan(e/v);t>-.2&&t<.2&&(y=e,d=t,d>=0?(u=y+k.filter(e=>e.name===s.BottomRight)[0].y,c=k.filter(e=>e.name===s.TopLeft)[0].y):(c=y+k.filter(e=>e.name===s.TopRight)[0].y,u=k.filter(e=>e.name===s.BottomLeft)[0].y));w()})).on("end",A))}function S(){const e=i.event.sourceEvent.target.id;m=i.mouse(this)[1],p=u,h=c,g="rotateRight"===e?u:c,b=d}function A(){void 0===y&&(y=0);const i={action:"resizeRotate",param:{elementId:e.id,ulx:a,uly:c,lrx:l,lry:u,rotate:180*d/Math.PI}};t.edit(i,t.view.getCurrentPageURI()).then(async i=>{i&&await t.updateForCurrentPage(),e=document.getElementById(e.id),a=void 0,c=void 0,l=void 0,u=void 0,y=void 0,_(),e.classList.contains("syl")?r.selectBBox(e.querySelector(".sylTextRect-display"),n,this):r.selectStaff(e,n)})}function L(e){E=e;const t=k.find(t=>t.name===s[e]);f=[t.x,t.y],h=c,p=u}function B(){const e=i.mouse(this);switch(s[E]){case s.TopLeft:a=e[0],c=e[1];break;case s.Top:c=e[1]-(l-a)*Math.tan(d)/2;break;case s.TopRight:l=e[0],c=e[1]-(l-a)*Math.tan(d);break;case s.Right:l=e[0],u=p+(e[0]-f[0])*Math.tan(d);break;case s.BottomRight:l=e[0],u=e[1];break;case s.Bottom:u=e[1]+(l-a)*Math.tan(d)/2;break;case s.BottomLeft:a=e[0],u=e[1]+(l-a)*Math.tan(d);break;case s.Left:a=e[0],c=h+(e[0]-f[0])*Math.tan(d);break;default:console.error("Something that wasn't a side of the rectangle was dragged. This shouldn't happen.")}w()}function C(){const s={action:"resize",param:{elementId:e.id,ulx:a,uly:c,lrx:l,lry:u}};t.edit(s,t.view.getCurrentPageURI()).then(async s=>{if(s&&await t.updateForCurrentPage(),e=document.getElementById(e.id),a=void 0,c=void 0,l=void 0,u=void 0,i.selectAll(".resizePoint").remove(),i.selectAll("#resizeRect").remove(),i.selectAll(".rotatePoint").remove(),_(),e.classList.contains("syl"))r.selectBBox(e.querySelector(".sylTextRect-display"),n,this);else try{document.getElementById("moreEdit").innerHTML="",document.getElementById("moreEdit").classList.add("is-invisible")}catch(e){}})}}()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(3);t.default=class{constructor(e,t){this.firstClick=!0,this.insertDisabled=function(){this.type="",this.removeInsertClickHandlers(),document.body.removeEventListener("keydown",this.keydownListener),document.body.removeEventListener("keyup",this.resetInsertHandler),document.body.removeEventListener("click",this.clickawayHandler);const e=document.querySelector(".insertel.is-active");null!==e&&e.classList.remove("is-active"),this.firstClick=!0;try{document.getElementById("returnToEditMode").remove()}catch(e){}const t=document.getElementById("editMenu"),n=document.getElementById("insertMenu");t.style.backgroundColor="#ffc7c7",t.style.fontWeight="bold",n.style.backgroundColor="whitesmoke",n.style.fontWeight=""}.bind(this),this.clickawayHandler=function(e){const t=e.target;null===t.closest(".active-page")&&null===t.closest("#insert_controls")&&null===t.closest("#svg_group")&&(this.insertDisabled(),document.body.removeEventListener("keydown",this.staffHandler),document.body.removeEventListener("keydown",this.handler))}.bind(this),this.resetInsertHandler=function(e){"Shift"===e.key&&document.querySelector(this.selector).addEventListener("click","staff"===this.type?this.staffHandler:this.handler)}.bind(this),this.keydownListener=function(e){"Escape"===e.key?(this.insertDisabled(),document.body.removeEventListener("keydown",this.staffHandler),document.body.removeEventListener("keydown",this.handler)):"Shift"===e.key&&this.removeInsertClickHandlers()}.bind(this),this.handler=function(e){e.stopPropagation();const t=document.getElementsByClassName("active-page")[0].getElementsByClassName("definition-scale")[0],n=t.createSVGPoint();n.x=e.clientX,n.y=e.clientY;const r=t.getElementsByClassName("system")[0].getScreenCTM(),i=n.matrixTransform(r.inverse()),s={action:"insert",param:{elementType:this.type,staffId:"auto",ulx:i.x,uly:i.y}};null!==this.attributes&&(s.param.attributes=this.attributes,"F"===this.attributes.shape&&(s.param.ulx-=50)),this.neonView.edit(s,this.neonView.view.getCurrentPageURI()).then(()=>this.neonView.updateForCurrentPage()).then(()=>{document.querySelector(this.selector).addEventListener("click",this.handler)})}.bind(this),this.staffHandler=function(e){const t=document.getElementsByClassName("active-page")[0].getElementsByClassName("definition-scale")[0],n=t.createSVGPoint();n.x=e.clientX,n.y=e.clientY;const i=t.getElementsByClassName("system")[0].getScreenCTM(),s=n.matrixTransform(i.inverse());if(this.firstClick)this.coord=s,r.select(t).append("circle").attr("cx",s.x).attr("cy",s.y).attr("r",10).attr("id","staff-circle").attr("fill","green"),this.firstClick=!1;else{let e,t;s.x<this.coord.x||s.y<this.coord.y?(e=s,t=this.coord):(e=this.coord,t=s),document.getElementById("staff-circle").remove();const n={action:"insert",param:{elementType:"staff",staffId:"auto",ulx:e.x,uly:e.y,lrx:t.x,lry:t.y}};this.neonView.edit(n,this.neonView.view.getCurrentPageURI()).then(()=>{this.neonView.updateForCurrentPage(),this.firstClick=!0})}}.bind(this),this.removeInsertClickHandlers=function(){document.querySelector(this.selector).removeEventListener("click",this.staffHandler),document.querySelector(this.selector).removeEventListener("click",this.handler)}.bind(this),this.neonView=e,this.selector=t}insertActive(e){const t=this.isInsertMode();switch(e){case"punctum":this.type="nc",this.attributes=null;break;case"diamond":this.type="nc",this.attributes={tilt:"se"};break;case"virga":this.type="nc",this.attributes={tilt:"n"};break;case"pes":case"clivis":case"scandicus":case"climacus":case"torculus":case"porrectus":case"pressus":const t=this.neonView.info.getContourByValue(e.charAt(0).toUpperCase()+e.slice(1));this.type="grouping",this.attributes={contour:t};break;case"cClef":case"fClef":this.type="clef",this.attributes={shape:e.charAt(0).toUpperCase()};break;case"custos":this.type="custos",this.attributes=null;break;case"staff":this.type="staff",this.attributes=null;break;default:return this.type="",this.attributes=null,void console.error("Invalid button for insertion: "+e+".")}if(this.removeInsertClickHandlers(),"staff"===this.type?document.querySelector(this.selector).addEventListener("click",this.staffHandler):document.querySelector(this.selector).addEventListener("click",this.handler),document.body.addEventListener("keydown",this.keydownListener),document.body.addEventListener("keyup",this.resetInsertHandler),document.body.addEventListener("click",this.clickawayHandler),!t){const e=document.createElement("button");e.id="returnToEditMode",e.classList.add("button"),e.innerHTML="Return to Edit Mode",document.getElementById("redo").parentNode.appendChild(e),e.addEventListener("click",this.insertDisabled)}const n=document.getElementById("editMenu");n.style.backgroundColor="whitesmoke",n.style.fontWeight="";const r=document.getElementById("insertMenu");r.style.backgroundColor="#ffc7c7",r.style.fontWeight="bold"}isInsertMode(){return""!==this.type}}},function(e,t,n){"use strict";n.r(t);var r=n(20),i=n.n(r),s=n(23),o=n.n(s),a=n(24),c=n.n(a),l=n(25),u=n.n(l),d=n(26),f=n.n(d),h=n(27),p=n.n(h),m=n(28),g=n.n(m),v=n(29),y=n.n(v),b=n(30),w=n.n(b),_=n(19);let E=S("manifest"),k="manifests/"+E+".jsonld",x=S("storage");if(E)window.fetch(k).then(e=>{if(e.ok)return e.text();throw new Error(e.statusText)}).then(async e=>{let t;try{t=JSON.parse(e)}catch(t){return console.error(t),void console.debug(e)}let n={manifest:t,Display:o.a,Info:g.a,TextView:y.a,TextEdit:w.a};(await new Promise((e,n)=>{window.fetch(t.image).then(t=>{e(t.headers.get("Content-Type"))}).catch(e=>{n(e)})})).match(/image\/*/)?(n.View=u.a,n.NeumeEdit=p.a):(n.View=c.a,n.NeumeEdit=f.a),new i.a(n).start()});else{new _.default("Neon-User-Storage").getAttachment(x,"manifest").then(e=>new window.Response(e).json()).then(async e=>{console.log(e);let t={manifest:e,Display:o.a,Info:g.a,TextView:y.a,TextEdit:w.a};(await new Promise((t,n)=>{window.fetch(e.image).then(e=>{t(e.headers.get("Content-Type"))}).catch(e=>{n(e)})})).match(/image\/*/)?(t.View=u.a,t.NeumeEdit=p.a):(t.View=c.a,t.NeumeEdit=f.a),new i.a(t).start()})}function S(e){let t=null,n=[];return window.location.search.substr(1).split("&").forEach(r=>{n=r.split("="),n[0]===e&&(t=decodeURIComponent(n[1]))}),t}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(31),i=n(40),s=n(41),o=n(13),a=n(19);t.default=class{constructor(e){this.verovioWrapper=new s.default,i.init(),this.undoStacks=new Map,this.redoStacks=new Map,this.neonCache=new Map,this.parser=new DOMParser,this.db=new a.default("Neon"),this.blankPages=[],this.manifest=e,this.annotations=e.mei_annotations,this.lastPageLoaded=""}getAnnotations(){return this.annotations}async initDb(e=!1){return await new Promise((t,n)=>{this.db.get(this.manifest["@id"]).catch(e=>{if("not_found"===e.name){const e={_id:this.manifest["@id"],timestamp:this.manifest.timestamp,image:this.manifest.image,title:this.manifest.title,annotations:[]};return this.annotations.forEach(t=>{e.annotations.push(t.id)}),e}return console.error(e),n(e)}).then(async r=>{const i=/(.+[-+\u2212]\d\d)(\d\d)$/;if(new Date(r.timestamp).getTime()>(i.test(this.manifest.timestamp)?new Date(this.manifest.timestamp.replace(i,"$1:$2")).getTime():new Date(this.manifest.timestamp).getTime())&&!e){this.annotations=[];const e=r.annotations.map(e=>new Promise(t=>{this.db.get(e).then(e=>{this.annotations.push({id:e._id,type:"Annotation",body:e.body,target:e.target}),t()}).catch(e=>{console.error(e),t()})}));return await Promise.all(e),t(!1)}for(const e of this.annotations)await this.db.get(e.id).catch(t=>"not_found"===t.name?{_id:e.id}:(console.error(t),n(t))).then(t=>(t.body=e.body,t.target=e.target,this.db.put(t))).catch(e=>{n(e),console.error(e)});return this.db.put(r)}).then(()=>t(!0)).catch(e=>{n(e),console.error(e)})})}loadPage(e){return new Promise((t,n)=>{if(this.lastPageLoaded===e&&this.neonCache.has(e))t(this.neonCache.get(e));else if(this.neonCache.has(e))this.loadData(e,this.neonCache.get(e).mei).then(()=>{t(this.neonCache.get(e))});else if(this.blankPages.includes(e)){i.blankPage();const t=new Error("No MEI file for page "+e);t.name="missing_mei",n(t)}else{const s=this.annotations.find(t=>t.target===e);s?window.fetch(s.body).then(e=>{if(e.ok)return e.text();throw new Error(e.statusText)}).then(n=>{n.match(/<sb .+>/)&&(n=r.convertSbToStaff(n)),this.loadData(e,n).then(()=>{t(this.neonCache.get(e))})}).catch(e=>{n(e)}):(i.blankPage(),this.blankPages.push(e))}})}loadData(e,t,n=!1){return i.sendForValidation(t),this.lastPageLoaded=e,new Promise(r=>{const i={id:o.uuidv4(),action:"renderData",mei:t};this.verovioWrapper.addEventListener("message",function s(o){if(o.data.id===i.id){const i=this.parser.parseFromString(o.data.svg,"image/svg+xml").documentElement;this.neonCache.set(e,{svg:i,mei:t,dirty:n}),o.target.removeEventListener("message",s),r()}}.bind(this)),this.verovioWrapper.postMessage(i)})}getSVG(e){return new Promise((t,n)=>{this.loadPage(e).then(e=>{t(e.svg)}).catch(e=>{n(e)})})}getMEI(e){return new Promise((t,n)=>{this.loadPage(e).then(e=>{t(e.mei)}).catch(e=>{n(e)})})}getElementAttr(e,t){return new Promise(n=>{this.loadPage(t).then(()=>{const t={id:o.uuidv4(),action:"getElementAttr",elementId:e};this.verovioWrapper.addEventListener("message",(function e(r){r.data.id===t.id&&(r.target.removeEventListener("message",e),n(r.data.attributes))})),this.verovioWrapper.postMessage(t)})})}edit(e,t){let n;return n=this.lastPageLoaded===t?Promise.resolve(this.neonCache.get(t)):this.loadPage(t),new Promise(r=>{n.then(n=>{const i=n.mei,s={id:o.uuidv4(),action:"edit",editorAction:e};this.verovioWrapper.addEventListener("message",function e(n){n.data.id===s.id&&(n.data.result&&(this.undoStacks.has(t)||this.undoStacks.set(t,[]),this.undoStacks.get(t).push(i),this.redoStacks.set(t,[])),n.target.removeEventListener("message",e),this.updateCache(t,!0).then(()=>{r(n.data.result)}))}.bind(this)),this.verovioWrapper.postMessage(s)})})}updateCache(e,t){return new Promise(n=>{let r,i;const s=new Promise(e=>{const t={id:o.uuidv4(),action:"getMEI"};this.verovioWrapper.addEventListener("message",(function n(i){i.data.id===t.id&&(r=i.data.mei,i.target.removeEventListener("message",n),e())})),this.verovioWrapper.postMessage(t)}),a=new Promise(e=>{const t={id:o.uuidv4(),action:"renderToSVG"};this.verovioWrapper.addEventListener("message",(function n(r){r.data.id===t.id&&(i=r.data.svg,r.target.removeEventListener("message",n),e())})),this.verovioWrapper.postMessage(t)});s.then(()=>a).then(()=>{const s=this.parser.parseFromString(i,"image/svg+xml").documentElement;this.neonCache.set(e,{mei:r,svg:s,dirty:t}),n()})})}info(e){let t;return t=this.lastPageLoaded===e?Promise.resolve():this.loadPage(e),new Promise(e=>{t.then(()=>{const t={id:o.uuidv4(),action:"editInfo"};this.verovioWrapper.addEventListener("message",(function n(r){r.data.id===t.id&&(r.target.removeEventListener("message",n),e(JSON.parse(r.data.info)))})),this.verovioWrapper.postMessage(t)})})}undo(e){return new Promise(t=>{if(this.undoStacks.has(e)){const n=this.undoStacks.get(e).pop();if(void 0!==n)return void this.getMEI(e).then(t=>(this.redoStacks.get(e).push(t),this.loadData(e,n,!0))).then(()=>{t(!0)})}t(!1)})}redo(e){return new Promise(t=>{if(this.redoStacks.has(e)){const n=this.redoStacks.get(e).pop();if(void 0!==n)return void this.getMEI(e).then(t=>(this.undoStacks.get(e).push(t),this.loadData(e,n,!0))).then(()=>{t(!0)})}t(!1)})}async updateDatabase(){let e=!1;for(const t of this.neonCache){const n=t[0],r=t[1];if(r.dirty){e=!0;const t=this.annotations.findIndex(e=>e.target===n);let i;this.annotations[t].body.match(/^data:/)?i="data:application/mei+xml;base64,"+window.btoa(r.mei):await window.fetch(this.annotations[t].body,{method:"PUT",headers:{"Content-Type":"application/mei+xml"},body:r.mei}).then(e=>{i=e.ok?this.annotations[t].body:"data:application/mei+xml;base64,"+window.btoa(r.mei)}).catch(e=>{console.error(e),console.warn("Falling back to data URI"),i="data:application/mei+xml;base64,"+window.btoa(r.mei)}),this.annotations[t].body=i,await this.db.get(this.annotations[t].id).then(e=>(e.body=i,this.db.put(e))).then(()=>{r.dirty=!1}).catch(e=>{console.error(e)})}}e&&await this.db.get(this.manifest["@id"]).then(e=>(e.timestamp=(new Date).toISOString(),this.db.put(e))).catch(e=>{console.error(e)})}async deleteDb(){const e=await this.db.get(this.manifest["@id"]).then(e=>e.annotations);e.push(this.manifest["@id"]);const t=e.map(e=>new Promise(t=>{this.db.get(e).then(e=>this.db.remove(e)).then(()=>t())}));return Promise.all(t)}}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=fetch("/Neon/Neon-gh/assets/mei-all.rng");let i,s,o;function a(e){const t=e.data;if(null===t){o.textContent="VALID",o.style.color="green";for(const e of o.children)e.remove()}else{let e="";t.forEach(t=>{e+=t+"\n"}),o.textContent="",o.style.color="red";const n=document.createElement("a");n.setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(e)),n.setAttribute("download","validation.log"),n.textContent="INVALID",o.appendChild(n)}}t.init=async function(){const e=document.getElementById("displayContents");if(null!==e){const t=document.createElement("div");t.classList.add("panel-block");const n=document.createElement("p");n.textContent="MEI Status: ";const r=document.createElement("span");r.id="validation_status",r.textContent="unknown",n.appendChild(r),t.appendChild(n),e.appendChild(t),o=document.getElementById("validation_status"),i=new Worker("/Neon/Neon-gh/workers/Worker.js"),i.onmessage=a}},t.sendForValidation=async function(e){if(void 0!==o){if(void 0===s){const e=await r;s=await e.text()}o.textContent="checking...",o.style.color="gray",i.postMessage({mei:e,schema:s})}},t.blankPage=function(){for(const e of o.children)e.remove();o.textContent="No MEI",o.style.color="color:gray"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});t.default=class{constructor(){this.verovioWorker=new Worker("/Neon/Neon-gh/workers/VerovioWorker.js")}addEventListener(e,t){return this.verovioWorker.addEventListener(e,t)}postMessage(e){return this.verovioWorker.postMessage(e)}}},function(e,t){var n,r,i=e.exports={};function s(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function a(e){if(n===setTimeout)return setTimeout(e,0);if((n===s||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:s}catch(e){n=s}try{r="function"==typeof clearTimeout?clearTimeout:o}catch(e){r=o}}();var c,l=[],u=!1,d=-1;function f(){u&&c&&(u=!1,c.length?l=c.concat(l):d=-1,l.length&&h())}function h(){if(!u){var e=a(f);u=!0;for(var t=l.length;t;){for(c=l,l=[];++d<t;)c&&c[d].run();d=-1,t=l.length}c=null,u=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];l.push(new p(e,t)),1!==l.length||u||a(h)},p.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},function(e,t,n){var r,i,s=n(32),o=n(33),a=0,c=0;e.exports=function(e,t,n){var l=t&&n||0,u=t||[],d=(e=e||{}).node||r,f=void 0!==e.clockseq?e.clockseq:i;if(null==d||null==f){var h=s();null==d&&(d=r=[1|h[0],h[1],h[2],h[3],h[4],h[5]]),null==f&&(f=i=16383&(h[6]<<8|h[7]))}var p=void 0!==e.msecs?e.msecs:(new Date).getTime(),m=void 0!==e.nsecs?e.nsecs:c+1,g=p-a+(m-c)/1e4;if(g<0&&void 0===e.clockseq&&(f=f+1&16383),(g<0||p>a)&&void 0===e.nsecs&&(m=0),m>=1e4)throw new Error("uuid.v1(): Can't create more than 10M uuids/sec");a=p,c=m,i=f;var v=(1e4*(268435455&(p+=122192928e5))+m)%4294967296;u[l++]=v>>>24&255,u[l++]=v>>>16&255,u[l++]=v>>>8&255,u[l++]=255&v;var y=p/4294967296*1e4&268435455;u[l++]=y>>>8&255,u[l++]=255&y,u[l++]=y>>>24&15|16,u[l++]=y>>>16&255,u[l++]=f>>>8|128,u[l++]=255&f;for(var b=0;b<6;++b)u[l+b]=d[b];return t||o(u)}},function(e,t,n){var r=n(32),i=n(33);e.exports=function(e,t,n){var s=t&&n||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var o=(e=e||{}).random||(e.rng||r)();if(o[6]=15&o[6]|64,o[8]=63&o[8]|128,t)for(var a=0;a<16;++a)t[s+a]=o[a];return t||i(o)}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(46),i=n(47),s=n(48);t.parseManifest=function(e){const t=s.validate(e,r),n=t.instance;if(t.errors.length>0)return console.error(t.errors),!1;const o=n["@context"];return"https://ddmal.music.mcgill.ca/Neon/contexts/1/manifest.jsonld"===o||(o[0]===i[0]&&o[1].schema===i[1].schema&&o[1].title===i[1].title&&o[1].timestamp===i[1].timestamp&&o[1].image["@id"]===i[1].image["@id"]&&o[1].image["@type"]===i[1].image["@type"]&&o[1].mei_annotations["@id"]===i[1].mei_annotations["@id"]&&o[1].mei_annotations["@type"]===i[1].mei_annotations["@type"]&&o[1].mei_annotations["@container"]===i[1].mei_annotations["@container"]||(console.error("Context mismatch"),console.error(o),console.error(i),!1))}},function(e){e.exports=JSON.parse('{"type":"object","required":["@context","title","timestamp","image","mei_annotations"],"properties":{"@context":{"type":["array","string"]},"title":{"type":"string"},"timestamp":{"type":"string"},"image":{"type":"string"},"mei_annotations":{"type":"array","items":{"type":"object","required":["id","type","body","target"],"properties":{"id":{"type":"string"},"type":{"type":"string"},"body":{"type":"string"},"target":{"type":"string"}}}}}}')},function(e){e.exports=JSON.parse('["http://www.w3.org/ns/anno.jsonld",{"schema":"http://schema.org/","title":"schema:name","timestamp":"schema:dateModified","image":{"@id":"schema:image","@type":"@id"},"mei_annotations":{"@id":"Annotation","@type":"@id","@container":"@list"}}]')},function(e,t,n){"use strict";var r=e.exports.Validator=n(49);e.exports.ValidatorResult=n(6).ValidatorResult,e.exports.ValidationError=n(6).ValidationError,e.exports.SchemaError=n(6).SchemaError,e.exports.SchemaScanResult=n(16).SchemaScanResult,e.exports.scan=n(16).scan,e.exports.validate=function(e,t,n){return(new r).validate(e,t,n)}},function(e,t,n){"use strict";var r=n(15),i=n(56),s=n(6),o=n(16).scan,a=s.ValidatorResult,c=s.SchemaError,l=s.SchemaContext,u=function e(){this.customFormats=Object.create(e.prototype.customFormats),this.schemas={},this.unresolvedRefs=[],this.types=Object.create(f),this.attributes=Object.create(i.validators)};function d(e){var t="string"==typeof e?e:e.$ref;return"string"==typeof t&&t}u.prototype.customFormats={},u.prototype.schemas=null,u.prototype.types=null,u.prototype.attributes=null,u.prototype.unresolvedRefs=null,u.prototype.addSchema=function(e,t){var n=this;if(!e)return null;var r=o(t||"/",e),i=t||e.id;for(var s in r.id)this.schemas[s]=r.id[s];for(var s in r.ref)this.unresolvedRefs.push(s);return this.unresolvedRefs=this.unresolvedRefs.filter((function(e){return void 0===n.schemas[e]})),this.schemas[i]},u.prototype.addSubSchemaArray=function(e,t){if(t instanceof Array)for(var n=0;n<t.length;n++)this.addSubSchema(e,t[n])},u.prototype.addSubSchemaObject=function(e,t){if(t&&"object"==typeof t)for(var n in t)this.addSubSchema(e,t[n])},u.prototype.setSchemas=function(e){this.schemas=e},u.prototype.getSchema=function(e){return this.schemas[e]},u.prototype.validate=function(e,t,n,i){n||(n={});var s=n.propertyName||"instance",a=r.resolve(n.base||"/",t.id||"");if(!i){(i=new l(t,n,s,a,Object.create(this.schemas))).schemas[a]||(i.schemas[a]=t);var u=o(a,t);for(var d in u.id){var f=u.id[d];i.schemas[d]=f}}if(t){var h=this.validateSchema(e,t,n,i);if(!h)throw new Error("Result undefined");return h}throw new c("no schema specified",t)},u.prototype.validateSchema=function(e,t,n,r){var o,u=new a(e,t,n,r);if("boolean"==typeof t)!0===t?t={}:!1===t&&(t={type:[]});else if(!t)throw new Error("schema is undefined");if(t.extends)if(t.extends instanceof Array){var f={schema:t,ctx:r};t.extends.forEach(this.schemaTraverser.bind(this,f)),t=f.schema,f.schema=null,f.ctx=null,f=null}else t=s.deepMerge(t,this.superResolve(t.extends,r));if(o=d(t)){var h=this.resolve(t,o,r),p=new l(h.subschema,n,r.propertyPath,h.switchSchema,r.schemas);return this.validateSchema(e,h.subschema,n,p)}var m=n&&n.skipAttributes||[];for(var g in t)if(!i.ignoreProperties[g]&&m.indexOf(g)<0){var v=null,y=this.attributes[g];if(y)v=y.call(this,e,t,n,r);else if(!1===n.allowUnknownAttributes)throw new c("Unsupported attribute: "+g,t);v&&u.importErrors(v)}if("function"==typeof n.rewrite){var b=n.rewrite.call(this,e,t,n,r);u.instance=b}return u},u.prototype.schemaTraverser=function(e,t){e.schema=s.deepMerge(e.schema,this.superResolve(t,e.ctx))},u.prototype.superResolve=function(e,t){var n;return(n=d(e))?this.resolve(e,n,t).subschema:e},u.prototype.resolve=function(e,t,n){if(t=n.resolve(t),n.schemas[t])return{subschema:n.schemas[t],switchSchema:t};var i=r.parse(t),o=i&&i.hash,a=o&&o.length&&t.substr(0,t.length-o.length);if(!a||!n.schemas[a])throw new c("no such schema <"+t+">",e);var l=s.objectGetPath(n.schemas[a],o.substr(1));if(void 0===l)throw new c("no such schema "+o+" located in <"+a+">",e);return{subschema:l,switchSchema:t}},u.prototype.testType=function(e,t,n,r,i){if("function"==typeof this.types[i])return this.types[i].call(this,e);if(i&&"object"==typeof i){var s=this.validateSchema(e,i,n,r);return void 0===s||!(s&&s.errors.length)}return!0};var f=u.prototype.types={};f.string=function(e){return"string"==typeof e},f.number=function(e){return"number"==typeof e&&isFinite(e)},f.integer=function(e){return"number"==typeof e&&e%1==0},f.boolean=function(e){return"boolean"==typeof e},f.array=function(e){return Array.isArray(e)},f.null=function(e){return null===e},f.date=function(e){return e instanceof Date},f.any=function(e){return!0},f.object=function(e){return e&&"object"==typeof e&&!(e instanceof Array)&&!(e instanceof Date)},e.exports=u},function(e,t,n){(function(e,r){var i;/*! https://mths.be/punycode v1.4.1 by @mathias */!function(s){t&&t.nodeType,e&&e.nodeType;var o="object"==typeof r&&r;o.global!==o&&o.window!==o&&o.self;var a,c=2147483647,l=/^xn--/,u=/[^\x20-\x7E]/,d=/[\x2E\u3002\uFF0E\uFF61]/g,f={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},h=Math.floor,p=String.fromCharCode;function m(e){throw new RangeError(f[e])}function g(e,t){for(var n=e.length,r=[];n--;)r[n]=t(e[n]);return r}function v(e,t){var n=e.split("@"),r="";return n.length>1&&(r=n[0]+"@",e=n[1]),r+g((e=e.replace(d,".")).split("."),t).join(".")}function y(e){for(var t,n,r=[],i=0,s=e.length;i<s;)(t=e.charCodeAt(i++))>=55296&&t<=56319&&i<s?56320==(64512&(n=e.charCodeAt(i++)))?r.push(((1023&t)<<10)+(1023&n)+65536):(r.push(t),i--):r.push(t);return r}function b(e){return g(e,(function(e){var t="";return e>65535&&(t+=p((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=p(e)})).join("")}function w(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function _(e,t,n){var r=0;for(e=n?h(e/700):e>>1,e+=h(e/t);e>455;r+=36)e=h(e/35);return h(r+36*e/(e+38))}function E(e){var t,n,r,i,s,o,a,l,u,d,f,p=[],g=e.length,v=0,y=128,w=72;for((n=e.lastIndexOf("-"))<0&&(n=0),r=0;r<n;++r)e.charCodeAt(r)>=128&&m("not-basic"),p.push(e.charCodeAt(r));for(i=n>0?n+1:0;i<g;){for(s=v,o=1,a=36;i>=g&&m("invalid-input"),((l=(f=e.charCodeAt(i++))-48<10?f-22:f-65<26?f-65:f-97<26?f-97:36)>=36||l>h((c-v)/o))&&m("overflow"),v+=l*o,!(l<(u=a<=w?1:a>=w+26?26:a-w));a+=36)o>h(c/(d=36-u))&&m("overflow"),o*=d;w=_(v-s,t=p.length+1,0==s),h(v/t)>c-y&&m("overflow"),y+=h(v/t),v%=t,p.splice(v++,0,y)}return b(p)}function k(e){var t,n,r,i,s,o,a,l,u,d,f,g,v,b,E,k=[];for(g=(e=y(e)).length,t=128,n=0,s=72,o=0;o<g;++o)(f=e[o])<128&&k.push(p(f));for(r=i=k.length,i&&k.push("-");r<g;){for(a=c,o=0;o<g;++o)(f=e[o])>=t&&f<a&&(a=f);for(a-t>h((c-n)/(v=r+1))&&m("overflow"),n+=(a-t)*v,t=a,o=0;o<g;++o)if((f=e[o])<t&&++n>c&&m("overflow"),f==t){for(l=n,u=36;!(l<(d=u<=s?1:u>=s+26?26:u-s));u+=36)E=l-d,b=36-d,k.push(p(w(d+E%b,0))),l=h(E/b);k.push(p(w(l,0))),s=_(n,v,r==i),n=0,++r}++n,++t}return k.join("")}a={version:"1.4.1",ucs2:{decode:y,encode:b},decode:E,encode:k,toASCII:function(e){return v(e,(function(e){return u.test(e)?"xn--"+k(e):e}))},toUnicode:function(e){return v(e,(function(e){return l.test(e)?E(e.slice(4).toLowerCase()):e}))}},void 0===(i=function(){return a}.call(t,n,t,e))||(e.exports=i)}()}).call(this,n(51)(e),n(14))},function(e,t){e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";e.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},function(e,t,n){"use strict";t.decode=t.parse=n(54),t.encode=t.stringify=n(55)},function(e,t,n){"use strict";function r(e,t){return Object.prototype.hasOwnProperty.call(e,t)}e.exports=function(e,t,n,s){t=t||"&",n=n||"=";var o={};if("string"!=typeof e||0===e.length)return o;var a=/\+/g;e=e.split(t);var c=1e3;s&&"number"==typeof s.maxKeys&&(c=s.maxKeys);var l=e.length;c>0&&l>c&&(l=c);for(var u=0;u<l;++u){var d,f,h,p,m=e[u].replace(a,"%20"),g=m.indexOf(n);g>=0?(d=m.substr(0,g),f=m.substr(g+1)):(d=m,f=""),h=decodeURIComponent(d),p=decodeURIComponent(f),r(o,h)?i(o[h])?o[h].push(p):o[h]=[o[h],p]:o[h]=p}return o};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},function(e,t,n){"use strict";var r=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};e.exports=function(e,t,n,a){return t=t||"&",n=n||"=",null===e&&(e=void 0),"object"==typeof e?s(o(e),(function(o){var a=encodeURIComponent(r(o))+n;return i(e[o])?s(e[o],(function(e){return a+encodeURIComponent(r(e))})).join(t):a+encodeURIComponent(r(e[o]))})).join(t):a?encodeURIComponent(r(a))+n+encodeURIComponent(r(e)):""};var i=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function s(e,t){if(e.map)return e.map(t);for(var n=[],r=0;r<e.length;r++)n.push(t(e[r],r));return n}var o=Object.keys||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(n);return t}},function(e,t,n){"use strict";var r=n(6),i=r.ValidatorResult,s=r.SchemaError,o={ignoreProperties:{id:!0,default:!0,description:!0,title:!0,exclusiveMinimum:!0,exclusiveMaximum:!0,additionalItems:!0,$schema:!0,$ref:!0,extends:!0}},a=o.validators={};function c(e,t,n,r,i){var s=t.throwError;t.throwError=!1;var o=this.validateSchema(e,i,t,n);return t.throwError=s,!o.valid&&r instanceof Function&&r(o),o.valid}function l(e,t,n,r,i,s){if(this.types.object(e)&&(!t.properties||void 0===t.properties[i]))if(!1===t.additionalProperties)s.addError({name:"additionalProperties",argument:i,message:"additionalProperty "+JSON.stringify(i)+" exists in instance when not allowed"});else{var o=t.additionalProperties||{};"function"==typeof n.preValidateProperty&&n.preValidateProperty(e,i,o,n,r);var a=this.validateSchema(e[i],o,n,r.makeChild(o,i));a.instance!==s.instance[i]&&(s.instance[i]=a.instance),s.importErrors(a)}}a.type=function(e,t,n,r){if(void 0===e)return null;var s=new i(e,t,n,r),o=Array.isArray(t.type)?t.type:[t.type];if(!o.some(this.testType.bind(this,e,t,n,r))){var a=o.map((function(e){return e.id&&"<"+e.id+">"||e+""}));s.addError({name:"type",argument:a,message:"is not of a type(s) "+a})}return s},a.anyOf=function(e,t,n,r){if(void 0===e)return null;var o=new i(e,t,n,r),a=new i(e,t,n,r);if(!Array.isArray(t.anyOf))throw new s("anyOf must be an array");if(!t.anyOf.some(c.bind(this,e,n,r,(function(e){a.importErrors(e)})))){var l=t.anyOf.map((function(e,t){return e.id&&"<"+e.id+">"||e.title&&JSON.stringify(e.title)||e.$ref&&"<"+e.$ref+">"||"[subschema "+t+"]"}));n.nestedErrors&&o.importErrors(a),o.addError({name:"anyOf",argument:l,message:"is not any of "+l.join(",")})}return o},a.allOf=function(e,t,n,r){if(void 0===e)return null;if(!Array.isArray(t.allOf))throw new s("allOf must be an array");var o=new i(e,t,n,r),a=this;return t.allOf.forEach((function(t,i){var s=a.validateSchema(e,t,n,r);if(!s.valid){var c=t.id&&"<"+t.id+">"||t.title&&JSON.stringify(t.title)||t.$ref&&"<"+t.$ref+">"||"[subschema "+i+"]";o.addError({name:"allOf",argument:{id:c,length:s.errors.length,valid:s},message:"does not match allOf schema "+c+" with "+s.errors.length+" error[s]:"}),o.importErrors(s)}})),o},a.oneOf=function(e,t,n,r){if(void 0===e)return null;if(!Array.isArray(t.oneOf))throw new s("oneOf must be an array");var o=new i(e,t,n,r),a=new i(e,t,n,r),l=t.oneOf.filter(c.bind(this,e,n,r,(function(e){a.importErrors(e)}))).length,u=t.oneOf.map((function(e,t){return e.id&&"<"+e.id+">"||e.title&&JSON.stringify(e.title)||e.$ref&&"<"+e.$ref+">"||"[subschema "+t+"]"}));return 1!==l&&(n.nestedErrors&&o.importErrors(a),o.addError({name:"oneOf",argument:u,message:"is not exactly one from "+u.join(",")})),o},a.properties=function(e,t,n,r){if(this.types.object(e)){var s=new i(e,t,n,r),o=t.properties||{};for(var a in o){"function"==typeof n.preValidateProperty&&n.preValidateProperty(e,a,o[a],n,r);var c=Object.hasOwnProperty.call(e,a)?e[a]:void 0,l=this.validateSchema(c,o[a],n,r.makeChild(o[a],a));l.instance!==s.instance[a]&&(s.instance[a]=l.instance),s.importErrors(l)}return s}},a.patternProperties=function(e,t,n,r){if(this.types.object(e)){var s=new i(e,t,n,r),o=t.patternProperties||{};for(var a in e){var c=!0;for(var u in o){if(new RegExp(u).test(a)){c=!1,"function"==typeof n.preValidateProperty&&n.preValidateProperty(e,a,o[u],n,r);var d=this.validateSchema(e[a],o[u],n,r.makeChild(o[u],a));d.instance!==s.instance[a]&&(s.instance[a]=d.instance),s.importErrors(d)}}c&&l.call(this,e,t,n,r,a,s)}return s}},a.additionalProperties=function(e,t,n,r){if(this.types.object(e)){if(t.patternProperties)return null;var s=new i(e,t,n,r);for(var o in e)l.call(this,e,t,n,r,o,s);return s}},a.minProperties=function(e,t,n,r){if(this.types.object(e)){var s=new i(e,t,n,r);return Object.keys(e).length>=t.minProperties||s.addError({name:"minProperties",argument:t.minProperties,message:"does not meet minimum property length of "+t.minProperties}),s}},a.maxProperties=function(e,t,n,r){if(this.types.object(e)){var s=new i(e,t,n,r);return Object.keys(e).length<=t.maxProperties||s.addError({name:"maxProperties",argument:t.maxProperties,message:"does not meet maximum property length of "+t.maxProperties}),s}},a.items=function(e,t,n,r){var s=this;if(this.types.array(e)&&t.items){var o=new i(e,t,n,r);return e.every((function(e,i){var a=Array.isArray(t.items)?t.items[i]||t.additionalItems:t.items;if(void 0===a)return!0;if(!1===a)return o.addError({name:"items",message:"additionalItems not permitted"}),!1;var c=s.validateSchema(e,a,n,r.makeChild(a,i));return c.instance!==o.instance[i]&&(o.instance[i]=c.instance),o.importErrors(c),!0})),o}},a.minimum=function(e,t,n,r){if(this.types.number(e)){var s=new i(e,t,n,r);return(t.exclusiveMinimum&&!0===t.exclusiveMinimum?e>t.minimum:e>=t.minimum)||s.addError({name:"minimum",argument:t.minimum,message:"must have a minimum value of "+t.minimum}),s}},a.maximum=function(e,t,n,r){if(this.types.number(e)){var s=new i(e,t,n,r);return(t.exclusiveMaximum&&!0===t.exclusiveMaximum?e<t.maximum:e<=t.maximum)||s.addError({name:"maximum",argument:t.maximum,message:"must have a maximum value of "+t.maximum}),s}};var u=function(e,t,n,o,a,c){if(this.types.number(e)){var l=t[a];if(0==l)throw new s(a+" cannot be zero");var u=new i(e,t,n,o),d=r.getDecimalPlaces(e),f=r.getDecimalPlaces(l),h=Math.max(d,f),p=Math.pow(10,h);return Math.round(e*p)%Math.round(l*p)!=0&&u.addError({name:a,argument:l,message:c+JSON.stringify(l)}),u}};function d(e,t,n){var i,s=n.length;for(i=t+1;i<s;i++)if(r.deepCompareStrict(e,n[i]))return!1;return!0}a.multipleOf=function(e,t,n,r){return u.call(this,e,t,n,r,"multipleOf","is not a multiple of (divisible by) ")},a.divisibleBy=function(e,t,n,r){return u.call(this,e,t,n,r,"divisibleBy","is not divisible by (multiple of) ")},a.required=function(e,t,n,r){var s=new i(e,t,n,r);return void 0===e&&!0===t.required?s.addError({name:"required",message:"is required"}):this.types.object(e)&&Array.isArray(t.required)&&t.required.forEach((function(t){void 0===e[t]&&s.addError({name:"required",argument:t,message:"requires property "+JSON.stringify(t)})})),s},a.pattern=function(e,t,n,r){if(this.types.string(e)){var s=new i(e,t,n,r);return e.match(t.pattern)||s.addError({name:"pattern",argument:t.pattern,message:"does not match pattern "+JSON.stringify(t.pattern.toString())}),s}},a.format=function(e,t,n,s){if(void 0!==e){var o=new i(e,t,n,s);return o.disableFormat||r.isFormat(e,t.format,this)||o.addError({name:"format",argument:t.format,message:"does not conform to the "+JSON.stringify(t.format)+" format"}),o}},a.minLength=function(e,t,n,r){if(this.types.string(e)){var s=new i(e,t,n,r),o=e.match(/[\uDC00-\uDFFF]/g);return e.length-(o?o.length:0)>=t.minLength||s.addError({name:"minLength",argument:t.minLength,message:"does not meet minimum length of "+t.minLength}),s}},a.maxLength=function(e,t,n,r){if(this.types.string(e)){var s=new i(e,t,n,r),o=e.match(/[\uDC00-\uDFFF]/g);return e.length-(o?o.length:0)<=t.maxLength||s.addError({name:"maxLength",argument:t.maxLength,message:"does not meet maximum length of "+t.maxLength}),s}},a.minItems=function(e,t,n,r){if(this.types.array(e)){var s=new i(e,t,n,r);return e.length>=t.minItems||s.addError({name:"minItems",argument:t.minItems,message:"does not meet minimum length of "+t.minItems}),s}},a.maxItems=function(e,t,n,r){if(this.types.array(e)){var s=new i(e,t,n,r);return e.length<=t.maxItems||s.addError({name:"maxItems",argument:t.maxItems,message:"does not meet maximum length of "+t.maxItems}),s}},a.uniqueItems=function(e,t,n,s){if(this.types.array(e)){var o=new i(e,t,n,s);return e.every((function(e,t,n){for(var i=t+1;i<n.length;i++)if(r.deepCompareStrict(e,n[i]))return!1;return!0}))||o.addError({name:"uniqueItems",message:"contains duplicate item"}),o}},a.uniqueItems=function(e,t,n,r){if(this.types.array(e)){var s=new i(e,t,n,r);return e.every(d)||s.addError({name:"uniqueItems",message:"contains duplicate item"}),s}},a.dependencies=function(e,t,n,r){if(this.types.object(e)){var s=new i(e,t,n,r);for(var o in t.dependencies)if(void 0!==e[o]){var a=t.dependencies[o],c=r.makeChild(a,o);if("string"==typeof a&&(a=[a]),Array.isArray(a))a.forEach((function(t){void 0===e[t]&&s.addError({name:"dependencies",argument:c.propertyPath,message:"property "+t+" not found, required by "+c.propertyPath})}));else{var l=this.validateSchema(e,a,n,c);s.instance!==l.instance&&(s.instance=l.instance),l&&l.errors.length&&(s.addError({name:"dependencies",argument:c.propertyPath,message:"does not meet dependency required by "+c.propertyPath}),s.importErrors(l))}}return s}},a.enum=function(e,t,n,o){if(void 0===e)return null;if(!Array.isArray(t.enum))throw new s("enum expects an array",t);var a=new i(e,t,n,o);return t.enum.some(r.deepCompareStrict.bind(null,e))||a.addError({name:"enum",argument:t.enum,message:"is not one of enum values: "+t.enum.map(String).join(",")}),a},a.const=function(e,t,n,s){if(void 0===e)return null;var o=new i(e,t,n,s);return r.deepCompareStrict(t.const,e)||o.addError({name:"const",argument:t.const,message:"does not exactly match expected constant: "+t.const}),o},a.not=a.disallow=function(e,t,n,r){var s=this;if(void 0===e)return null;var o=new i(e,t,n,r),a=t.not||t.disallow;return a?(Array.isArray(a)||(a=[a]),a.forEach((function(i){if(s.testType(e,t,n,r,i)){var a=i&&i.id&&"<"+i.id+">"||i;o.addError({name:"not",argument:a,message:"is of prohibited type "+a})}})),o):null},e.exports=o},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),i=n(58),s=n(31);function o(e){const t=document.getElementById("dropdown_toggle").parentElement;document.getElementById("dropdown_toggle").remove(),t.prepend(i.navbarDropdownMenu),document.getElementById("undoRedo_controls").innerHTML=i.undoRedoPanel,a(e),c(e);const n=document.createElement("a"),r=document.createElement("hr");r.classList.add("dropdown-divider"),n.classList.add("dropdown-item"),n.id="highlight-selection",n.textContent="By Selection Mode",document.getElementsByClassName("dropdown-content")[0].appendChild(r),document.getElementsByClassName("dropdown-content")[0].appendChild(n)}function a(e){document.getElementById("save").addEventListener("click",()=>{e.save().then(()=>{r.queueNotification("Saved")})}),document.body.addEventListener("keydown",t=>{"s"===t.key&&e.save().then(()=>{r.queueNotification("Saved")})}),document.getElementById("export").addEventListener("click",()=>{e.export().then(t=>{const n=document.createElement("a");n.href=t,n.download=e.name+".jsonld",document.body.appendChild(n),n.click(),n.remove(),r.queueNotification("Saved")})}),document.getElementById("revert").addEventListener("click",(function(){window.confirm("Reverting will cause all changes to be lost. Press OK to continue.")&&e.deleteDb().then(()=>{window.location.reload()})})),document.getElementById("getmei").addEventListener("click",()=>{const t=e.view.getCurrentPageURI();e.getPageMEI(t).then(t=>{const n="data:application/mei+xml;base64,"+window.btoa(s.convertStaffToSb(t));document.getElementById("getmei").setAttribute("href",n),document.getElementById("getmei").setAttribute("download",e.view.getPageName()+".mei")})})}function c(e){function t(){e.undo().then(t=>{t?e.updateForCurrentPage():console.error("Failed to undo action")})}function n(){e.redo().then(t=>{t?e.updateForCurrentPage():console.error("Failed to redo action")})}document.getElementById("undo").addEventListener("click",t),document.body.addEventListener("keydown",e=>{"z"===e.key&&(e.ctrlKey||e.metaKey)&&t()}),document.getElementById("redo").addEventListener("click",n),document.body.addEventListener("keydown",e=>{("Z"===e.key||"z"===e.key&&e.shiftKey)&&(e.ctrlKey||e.metaKey)&&n()})}t.prepareEditMode=function(e){const t=document.getElementById("dropdown_toggle"),n=document.createElement("a");n.classList.add("navbar-item");const r=document.createElement("button");r.classList.add("button"),r.id="edit_mode",r.textContent="Edit MEI",n.appendChild(r),t.appendChild(n),r.addEventListener("click",()=>{o(e)})},t.startEditMode=o,t.initNavbar=a,t.initUndoRedoPanel=c},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.navbarDropdownMenu=document.createElement("div"),t.navbarDropdownMenu.classList.add("navbar-item","has-dropdown","is-hoverable");const r=document.createElement("a");r.classList.add("navbar-link"),r.textContent="File";const i=document.createElement("div");i.classList.add("navbar-dropdown"),i.id="navbar-dropdown-options";[["save","Save"],["export","Save and Export to File"],["getmei","Download MEI"],["revert","Revert"]].forEach(e=>{const t=document.createElement("a");t.id=e[0],t.classList.add("navbar-item"),t.textContent=e[1],i.appendChild(t)}),t.navbarDropdownMenu.appendChild(r),t.navbarDropdownMenu.appendChild(i),t.navbarFinalize="<a id='finalize' class='navbar-item'> Finalize MEI </a>",t.undoRedoPanel="<div class='field has-addons buttons' style='overflow-x: auto;'><p class='control'><button class='button' id='undo'>Undo</button><button class='button' id='redo'>Redo</button></p></a></div>"},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=async function(){const e=await fetch("/Neon/Neon-gh/assets/template.html");document.body.innerHTML=await e.text(),document.getElementById("home-link").href="https://ddmal.music.mcgill.ca/Neon",document.getElementById("neon-version").textContent="ab15595\n"}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(3);class i{constructor(e,t){this.a=0,this.b=0,this.c=e,this.d=t,this.imageWidth=e,this.imageHeight=t}set(e,t,n,r){this.a=e,this.b=t,this.c=n,this.d=r}get(){return this.a.toString()+" "+this.b.toString()+" "+this.c+" "+this.d}zoomTo(e){const t=this.imageHeight/e,n=this.imageWidth/e;this.c=n,this.d=t}getZoom(){return this.imageWidth/this.c}translate(e,t){this.a+=e,this.b+=t}}t.ViewBox=i;class s{resetZoomAndPan(){const e=document.getElementById("bgimg");this.viewBox=new i(parseInt(e.getAttribute("width")),parseInt(e.getAttribute("height"))),this.updateViewBox()}zoomTo(e){this.getViewBox(),this.viewBox.zoomTo(e),this.updateViewBox()}translate(e,t){this.getViewBox(),this.viewBox.translate(e,t),this.updateViewBox()}restoreTransformation(){void 0===this.viewBox?this.resetZoomAndPan():this.updateViewBox()}getViewBox(){if(void 0===this.viewBox){const e=document.getElementById("bgimg");this.viewBox=new i(parseInt(e.getAttribute("width")),parseInt(e.getAttribute("height")))}const e=document.getElementById("svg_group").getAttribute("viewBox").split(" ");this.viewBox.set(parseInt(e[0]),parseInt(e[1]),parseInt(e[2]),parseInt(e[3]))}updateViewBox(){document.getElementById("svg_group").setAttribute("viewBox",this.viewBox.get())}startDrag(){const e=document.getElementById("svg_group");this.dragCoordinates=e.createSVGPoint(),"touchstart"===r.event.type?(this.dragCoordinates.x=r.event.touches[0].screenX,this.dragCoordinates.y=r.event.touches[0].screenY):(this.dragCoordinates.x=r.event.x,this.dragCoordinates.y=r.event.y),this.matrix=e.getScreenCTM().inverse()}dragging(){const e=document.getElementById("svg_group"),t=e.createSVGPoint();"touchmove"===r.event.type?(t.x=r.event.touches[0].screenX,t.y=r.event.touches[0].screenY):"wheel"===r.event.type&&!1===r.event.shiftKey?(void 0===this.matrix&&(this.matrix=e.getScreenCTM().inverse()),void 0===this.dragCoordinates&&(this.dragCoordinates=e.createSVGPoint()),this.dragCoordinates.x=r.event.x,this.dragCoordinates.y=r.event.y,t.x=this.dragCoordinates.x-r.event.deltaX,t.y=this.dragCoordinates.y-r.event.deltaY,r.event.preventDefault()):(t.x=r.event.x,t.y=r.event.y);const n=t.matrixTransform(this.matrix),i=this.dragCoordinates.matrixTransform(this.matrix);this.translate(-n.x+i.x,-n.y+i.y),this.dragCoordinates=t}scrollZoom(){if("wheel"!==r.event.type)return;if(!r.event.shiftKey)return void this.dragging();const e=document.getElementById("zoomSlider");this.getViewBox();let t=this.viewBox.getZoom()-r.event.deltaX/100;t<parseInt(e.getAttribute("min"))/100&&(t=.25),t>parseInt(e.getAttribute("max"))/100&&(t=4),this.zoomTo(t),e.value=(100*t).toString(),document.getElementById("zoomOutput").value=String(Math.round(100*t))}}t.ZoomHandler=s,t.default=s},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.groupingNotRecognized=function(){window.confirm("Neon does not recognize this neume grouping. Would you like to create a compound neume?")||document.getElementById("undo").click()}},function(e,t,n){"use strict";Object.defineProperty(t,"__esModule",{value:!0});const r=n(8),i=n(4),s=n(11);t.SplitHandler=class{constructor(e,t){this.handler=(e=>{const t=this.staff.id,n=this.staff.closest(".definition-scale"),o=n.createSVGPoint();o.x=e.clientX,o.y=e.clientY;const a=n.getElementsByClassName("system")[0].getScreenCTM().inverse(),c=o.matrixTransform(a),l={action:"split",param:{elementId:t,x:c.x}};this.neonView.edit(l,this.neonView.view.getCurrentPageURI()).then(async e=>{e&&(await this.neonView.updateForCurrentPage(),r.queueNotification("Split action successful"));const n=new s.default(this.neonView,".staff");this.splitDisable(),i.selectAll([document.querySelector("#"+t)],this.neonView,n);try{document.getElementById("moreEdit").innerHTML="",document.getElementById("moreEdit").classList.add("is-invisible")}catch(e){}})}).bind(this),this.keydownListener=(e=>{"Escape"===e.key?this.splitDisable():"Shift"===e.key&&document.body.removeEventListener("click",this.handler,{capture:!0})}).bind(this),this.clickawayHandler=(e=>{null===e.target.closest(".active-page")&&(this.splitDisable(),document.body.removeEventListener("click",this.handler,{capture:!0}))}).bind(this),this.resetHandler=(e=>{"Shift"===e.key&&document.body.addEventListener("click",this.handler,{capture:!0})}).bind(this),this.neonView=e,this.staff=t}startSplit(){this.splitDisable(),document.body.addEventListener("click",this.handler,{capture:!0}),document.body.addEventListener("keydown",this.keydownListener),document.body.addEventListener("keyup",this.resetHandler),document.body.addEventListener("click",this.clickawayHandler),r.queueNotification("Click Where to Split")}splitDisable(){document.body.removeEventListener("keydown",this.keydownListener),document.body.removeEventListener("keyup",this.resetHandler),document.body.removeEventListener("click",this.clickawayHandler),document.body.removeEventListener("click",this.handler,{capture:!0})}}}]);
//# sourceMappingURL=editor.js.map