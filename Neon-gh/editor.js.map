{"version":3,"sources":["webpack:///webpack/bootstrap","webpack:///./node_modules/events/events.js","webpack:///./node_modules/pouchdb/node_modules/inherits/inherits_browser.js","webpack:///./node_modules/immediate/lib/browser.js","webpack:///external \"d3\"","webpack:///./node_modules/argsarray/index.js","webpack:///./node_modules/jsonschema/lib/helpers.js","webpack:///./src/DisplayPanel/DisplayControls.ts","webpack:///./src/utils/SelectTools.ts","webpack:///./src/utils/Notification.ts","webpack:///./src/utils/Color.ts","webpack:///./src/SquareEdit/SelectOptions.ts","webpack:///./src/utils/DragHandler.ts","webpack:///./node_modules/spark-md5/spark-md5.js","webpack:///./src/utils/random.ts","webpack:///(webpack)/buildin/global.js","webpack:///./node_modules/url/url.js","webpack:///./node_modules/jsonschema/lib/scan.js","webpack:///./src/SquareEdit/Contents.ts","webpack:///./src/utils/Select.ts","webpack:///./node_modules/pouchdb/lib/index-browser.es.js","webpack:///./src/NeonView.ts","webpack:///./node_modules/pouchdb/node_modules/uuid/index.js","webpack:///./node_modules/vuvuzela/index.js","webpack:///./src/DisplayPanel/DisplayPanel.ts","webpack:///./src/DivaView.ts","webpack:///./src/SingleView/SingleView.ts","webpack:///./src/SquareEdit/DivaEditMode.ts","webpack:///./src/SquareEdit/SingleEditMode.ts","webpack:///./src/InfoModule.ts","webpack:///./src/TextView.ts","webpack:///./src/TextEditMode.ts","webpack:///./src/utils/ConvertMei.ts","webpack:///./node_modules/pouchdb/node_modules/uuid/lib/rng-browser.js","webpack:///./node_modules/pouchdb/node_modules/uuid/lib/bytesToUuid.js","webpack:///./src/SquareEdit/Controls.ts","webpack:///./src/SquareEdit/Grouping.ts","webpack:///./src/utils/Resize.ts","webpack:///./src/SquareEdit/InsertHandler.ts","webpack:///./deployment/pages/editor.js","webpack:///./src/NeonCore.ts","webpack:///./src/Validation.ts","webpack:///./src/VerovioWrapper.ts","webpack:///./node_modules/process/browser.js","webpack:///./node_modules/pouchdb/node_modules/uuid/v1.js","webpack:///./node_modules/pouchdb/node_modules/uuid/v4.js","webpack:///./src/utils/NeonManifest.ts","webpack:///./node_modules/jsonschema/lib/index.js","webpack:///./node_modules/jsonschema/lib/validator.js","webpack:///./node_modules/punycode/punycode.js","webpack:///(webpack)/buildin/module.js","webpack:///./node_modules/url/util.js","webpack:///./node_modules/querystring-es3/index.js","webpack:///./node_modules/querystring-es3/decode.js","webpack:///./node_modules/querystring-es3/encode.js","webpack:///./node_modules/jsonschema/lib/attribute.js","webpack:///./src/utils/EditControls.ts","webpack:///./src/utils/EditContents.ts","webpack:///./src/utils/template/Template.ts","webpack:///./src/SingleView/Zoom.ts","webpack:///./src/Warnings.ts","webpack:///./src/SquareEdit/StaffTools.ts"],"names":["installedModules","__webpack_require__","moduleId","exports","module","i","l","modules","call","m","c","d","name","getter","o","Object","defineProperty","enumerable","get","r","Symbol","toStringTag","value","t","mode","__esModule","ns","create","key","bind","n","object","property","prototype","hasOwnProperty","p","s","ReflectOwnKeys","R","Reflect","ReflectApply","apply","target","receiver","args","Function","ownKeys","getOwnPropertySymbols","getOwnPropertyNames","concat","NumberIsNaN","Number","isNaN","EventEmitter","init","this","_events","undefined","_eventsCount","_maxListeners","defaultMaxListeners","checkListener","listener","TypeError","_getMaxListeners","that","_addListener","type","prepend","events","existing","warning","newListener","emit","unshift","push","length","warned","w","Error","String","emitter","count","console","warn","onceWrapper","fired","removeListener","wrapFn","arguments","_onceWrap","state","wrapped","_listeners","unwrap","evlistener","arr","ret","Array","unwrapListeners","arrayClone","listenerCount","copy","set","arg","RangeError","getPrototypeOf","setMaxListeners","getMaxListeners","doError","error","er","err","message","context","handler","len","listeners","addListener","on","prependListener","once","prependOnceListener","list","position","originalListener","shift","index","pop","spliceOne","off","removeAllListeners","keys","rawListeners","eventNames","ctor","superCtor","super_","constructor","writable","configurable","TempCtor","scheduleDrain","draining","Mutation","global","MutationObserver","WebKitMutationObserver","called","observer","nextTick","element","document","createTextNode","observe","characterData","data","setImmediate","MessageChannel","createElement","scriptEl","onreadystatechange","parentNode","removeChild","documentElement","appendChild","setTimeout","channel","port1","onmessage","port2","postMessage","queue","oldQueue","task","d3","fun","uri","ValidationError","instance","schema","propertyPath","argument","id","stack","toString","ValidatorResult","options","ctx","errors","throwError","disableFormat","stringizer","v","addError","detail","importErrors","res","validatorType","map","join","SchemaError","msg","captureStackTrace","SchemaContext","base","schemas","resolve","makeChild","propertyName","makeSuffix","FORMAT_REGEXPS","input","parseFloat","parseInt","result","RegExp","e","regexp","regex","pattern","ipv4","isFormat","format","validator","test","customFormats","match","JSON","stringify","deepMerger","dst","deepMerge","indexOf","copyist","src","copyistWithDeepMerge","array","isArray","forEach","pathEncoder","encodeURIComponent","replace","deepCompareStrict","a","b","every","aKeys","bKeys","objectGetPath","k","parts","split","slice","decodeURIComponent","encodePath","getDecimalPlaces","number","decimalPlaces","decimalParts","lastGlyphOpacity","lastImageOpacity","setHighlightControls","highlightDropdown","getElementById","highlightStaff","highlightSyllable","highlightNeume","highlightNone","highlightType","addEventListener","evt","stopPropagation","classList","toggle","contains","body","highlightClickaway","remove","querySelectorAll","elem","add","textContent","Color","setGroupingHighlight","unsetGroupingHighlight","removeEventListener","meiClassName","background","opacitySlider","opacityOutput","inputChangeOpacity","querySelector","style","opacity","lowerOpacity","newOpacity","g","Math","round","setOpacityControls","bgOpacitySlider","bgOpacityOutput","bgInputChangeHandler","getElementsByClassName","setBackgroundOpacityControls","displayContents","toggleDisplay","parentElement","display","setAttribute","zoomHandler","zoomSlider","zoomOutput","inputChangeHandler","zoomTo","resetZoomAndPan","currentZoom","newZoom","min","getAttribute","max","highlightSelection","highlightId","getSelectionType","unselect","selected","removeAttribute","unhighlight","fill","from","el","color","fontWeight","sylRect","syllable","selectAll","SelectOptions","endOptionsSelection","Grouping","endGroupingSelection","innerHTML","updateHighlight","select","dragHandler","selectStaff","sylId","closest","span","async","isLigature","nc","neonView","getElementAttr","view","getCurrentPageURI","sharedSecondLevelParent","elements","tempElements","secondParent","selectBBox","bbox","syl","resize","dragInit","staff","highlight","parent","prevNc","previousSibling","nextNc","nextSibling","triggerGrouping","triggerNcActions","ulx","uly","lrx","lry","rotate","path","coordinates","atan","notNeumes","nn","selectionType","selectionClass","containsClefOrCustos","groupsToSelect","Set","grouping","follows","precedes","group","groups","values","size","triggerClefActions","triggerCustosActions","triggerDefaultSylActions","triggerDefaultActions","triggerSplitActions","triggerStaffActions","triggerSylActions","staff0","staff1","staffChildren","children","abs","firstStaff","secondStaff","firstLayer","secondLayer","firstSyllableChildren","filter","secondSyllableChildren","lastSyllable","firstSyllable","triggerNeumeActions","posFirstY","posSecondY","x","baseVal","y","isFirstLigature","isSecondLigature","notifications","currentModeMessage","notifying","startNotification","currentNotification","notification","isModeMessage","window","clearTimeout","timeoutID","clearOrShowNextNotification","getId","notificationContent","displayNotification","setTimeoutId","currentId","notif","Notification","displayed","uuidv4","search","ColorPalette","tagName","rects","rect","unsetStaffHighlight","child","cchild","width","height","stroke","debug","setStaffHighlight","staves","staffColor","groupColor","unsetInclinatumAction","unsetVirgaAction","removeHandler","toRemove","chainAction","edit","then","updateForCurrentPage","changeStaffHandler","toChange","moreEdit","deleteButtonHandler","initOptionsListeners","preventDefault","initNeonView","Contents","custosActionContents","extraEdit","ncActionContents","unsetInclinatum","unsetVirga","queueNotification","setInclinatum","setVirga","del","neumeActionContents","neume","contour","changeGroupingAction","triggerChangeGroup","info","getContourByValue","initGroupingListeners","clef","clefActionContents","setCClef","setFClef","staffActionContents","systems","elementIds","editorAction","splitActionContents","SplitHandler","startSplit","co","dy","defaultSylActionContents","changeStaff","defaultActionContents","default","selector","dragBehaviour","drag","dragStartCoords","event","dx","sourceEvent","dragging","dragEnded","activeNc","selection","relativeY","relativeX","attr","paramArray","singleAction","action","param","elementId","xDiff","yDiff","reset","resetToAction","hex_chr","md5cycle","md5blk","md5blks","charCodeAt","md5blk_array","md51","tail","tmp","lo","hi","substring","rhex","j","hex","toUtf8","str","unescape","hexToBinaryString","bytes","substr","fromCharCode","SparkMD5","ArrayBuffer","clamp","val","to","num","targetArray","sourceArray","byteLength","begin","end","Uint8Array","append","appendBinary","contents","_buff","_length","_hash","raw","buff","_finish","getState","hash","setState","destroy","hashBinary","content","first","second","returnUInt8Array","buffer","subarray","utf8Str2ArrayBuffer","md51_array","factory","uint8ToUuid","cb","previous","current","padStart","reduce","crypto","octets","modifiers","getRandomValues","punycode","util","Url","protocol","slashes","auth","host","port","hostname","query","pathname","href","parse","urlParse","source","relative","resolveObject","obj","isString","protocolPattern","portPattern","simplePathPattern","unwise","autoEscape","nonHostChars","hostEndingChars","hostnamePartPattern","hostnamePartStart","unsafeProtocol","hostlessProtocol","slashedProtocol","querystring","url","parseQueryString","slashesDenoteHost","isObject","u","queryIndex","splitter","uSplit","rest","trim","simplePath","exec","proto","lowerProto","toLowerCase","atSign","hostEnd","hec","lastIndexOf","parseHost","ipv6Hostname","hostparts","part","newpart","validParts","notHost","bit","toASCII","h","ae","esc","escape","qm","charAt","rel","tkeys","tk","tkey","rkeys","rk","rkey","relPath","isSourceAbs","isRelAbs","mustEndAbs","removeAllDots","srcPath","psychotic","isNullOrUndefined","authInHost","isNull","last","hasTrailingSlash","up","splice","isAbsolute","urilib","helpers","SchemaScanResult","found","ref","scan","scanSchema","baseuri","$ref","resolvedUri","ourBase","scanArray","items","extends","additionalItems","scanObject","properties","additionalProperties","definitions","patternProperties","dependencies","disallow","allOf","anyOf","oneOf","not","insertTabHtml","primitiveTab","groupingTab","systemTab","insertControlsPanel","editControlsPanel","groupingMenu","strokeWidth","escapeKeyListener","infoListeners","isSelByBBox","selByBBox","stopPropHandler","clickHandler","getUserMode","shiftKey","firstLigatureHalf","secondLigatureHalf","ncIndex","firstUse","assert","secondUse","navigator","userAgent","metaKey","ctrlKey","includes","container","pt","createSVGPoint","clientX","clientY","transformMatrix","getScreenCTM","matrixTransform","inverse","selectedStaves","getStaffBBox","tan","dispatchEvent","MouseEvent","screenX","screenY","altKey","nv","dh","sel","initialX","initialY","panning","dragSelecting","canvas","dragSelectAction","userMode","nodeName","startDrag","mouse","initialP","currentPt","curX","curY","newX","newY","currentWidth","currentHeight","updateRect","rx","ry","lx","ly","node","ul","lr","transform","multiply","box","getBBox","resetTo","ExportedSet","ExportedMap","mangle","unmangle","Map$1","_store","Set$1","cloneBinaryObject","cloneArrayBuffer","webkitSlice","mangled","has","delete","Map","prop","getOwnPropertyDescriptor","species","supportsMapAndSet","funcToString","objectCtorString","clone","newObject","Date","toISOString","Blob","isBinaryObject","Ctor","isPlainObject","toPromise","func","self","usedCB","promise","Promise","fulfill","reject","resp","callback","mesg","adapterFun","_closed","_destroyed","logArgs","origCallback","responseArgs","logApiCall","taskqueue","isReady","addTask","failed","pick","hasLocal","identityFunction","formatResultForOpenRevsGet","ok","bulkGet","db","opts","requests","docs","requestsById","request","numDocs","numDone","perDocResults","checkDone","results","allRequests","nextBatch","upTo","batch","offset","docId","docIdx","docRequests","docOpts","open_revs","rev","formatResult","processBatch","localStorage","setItem","getItem","hasLocalStorage","Changes","guardedConsole","method","defaultBackOff","maxTimeout","random","randomNumber","explainError","status","dbName","inprogress","eventFunction","changesOpts","changes","seq","since","cancelled","onChange","notifyLocalWindows","notify","$inject_Object_assign","assign","nextSource","nextKey","PouchError","reason","MISSING_BULK_DOCS","MISSING_DOC","REV_CONFLICT","INVALID_ID","MISSING_ID","RESERVED_ID","UNKNOWN_ERROR","BAD_ARG","QUERY_PARSE_ERROR","DOC_VALIDATION","BAD_REQUEST","NOT_AN_OBJECT","IDB_ERROR","INVALID_REV","MISSING_STUB","createError","CustomPouchError","generateErrorFromResponse","filterChange","req","hasFilter","query_params","change","doc","filterReturn","tryFilter","include_docs","attachments","att","_attachments","stub","flatten","arrs","invalidIdError","isRemote","_remote","parseDesignDocFunctionName","normalizeDesignDocFunctionName","normalized","qParser","parser","parseUri","encoded","$0","$1","$2","scopeEval","scope","upsert","diffFun","docRev","_rev","newDoc","updated","_id","put","tryAndPut","thisAtob","atob","thisBtoa","btoa","createBlob","builder","BlobBuilder","MSBlobBuilder","MozBlobBuilder","WebKitBlobBuilder","getBlob","binaryStringToArrayBuffer","bin","buf","binStringToBluffer","binString","b64ToBluffer","b64","readAsBinaryString","blob","reader","FileReader","hasBinaryString","onloadend","binary","arrayBufferToBinaryString","readAsArrayBuffer","blobToBinaryString","blobOrBuffer","blobToBase64","base64","setImmediateShim","appendBlob","start","sliceBlob","arrayBuffer","appendString","string","binaryMd5","inputIsString","chunkSize","chunks","ceil","currentChunk","next","loadNextChunk","done","rawToBase64","stringMd5","deterministic_revs","clonedDoc","_rev_tree","v4","uuid","winningRev","metadata","winningId","winningPos","winningDeleted","toVisit","rev_tree","tree","ids","branches","pos","deleted","traverseRevTree","revs","newCtx","sortByPos","collectLeaves","leaves","isLeaf","acc","sort","reverse","collectConflicts","win","conflicts","leaf","rootToLeaf","paths","history","sortByPos$1","insertSorted","item","comparator","idx","mid","low","high","binarySearch","pathToTree","numStemmed","root","currentLeaf","compareTree","mergeTree","in_tree1","in_tree2","tree1","tree2","merged","doMerge","dontExpand","restree","branch","t1","t2","diff","candidateParents","trees","parentIdx","elementsLen","merge","depth","newTree","stemmed","stemmedRevs","revHash","stem","getTrees","isDeleted","isLocalId","Changes$1","complete","ee","onDestroy","cancel","pending","lastSeq","isCancelled","tryCatchInChangeListener","validateChanges","processChange","changeList","_conflicts","compare","left","right","yankError","compareByIdThenRev","idCompare","_revisions","AbstractPouchDB","TaskQueue","PouchDB","__opts","auto_compaction","prefix","backend","adapter","adapters","preferredAdapters","adapterName","use_prefix","parseAdapter","_adapter","valid","fail","onDestroyed","from_constructor","onClosed","prepareForDestruction","ready","_changesFilterPlugin","validate","doChanges","continuous","live","normalize","shouldFilter","descending","limit","newPromise","_changes","update_seq","post","bulkDocs","_putLocal","_deleted","_removeLocal","oldRevId","newRevNum","newRevId","putDoc","_put","new_edits","force","putAttachment","attachmentId","rev$$1","api","createAttachment","prevrevpos","content_type","revpos","removeAttachment","docOrId","optsOrRev","was_delete","revsDiff","missing","addToMissing","revId","_getRevisionTree","missingForId","processDoc","missingObj","compactDocument","maxHeight","revTree","edges","prnt","edge","computeHeight","candidates","_doCompaction","compact","_compactionQueue","doNextCompaction","catch","last_seq","_compact","return_docs","promises","row","all","_getLocal","finishOpenRevs","latest","_get","revs_info","splittedRev","revNo","currentPath","hashIndex","indexOfRev","howMany","_revs_info","_getAttachment","getAttachment","allDocs","skip","start_key","startkey","end_key","endkey","incompatibleOpt","allDocsKeysParse","_allDocs","close","_close","_info","db_name","_type","attachmentError","attachmentNameError","atts","cleanDocs","_bulkDocs","registerDependentDatabase","dependentDb","depDB","dependentDbs","usePrefix","destroyDb","_destroy","localDoc","deletedMap","trueName","execute","AbortController","abort","f$1","fetch","Headers","eventEmitter","Pouch","destructListeners","_destructionListeners","dbList","setUpEventEmitter","addToPreferredAdapters","plugin","__defaults","defaults","defaultOpts","PouchAlt","getFieldFromDoc","parsedField","parseField","fieldName","fields","ch","combinationFields","isCombinationalField","field","getKey","mergeAndedSelectors","selectors","matcher","$eq","fieldMatchers","operator","$gte","$gt","mergeGtGte","$lte","$lt","mergeLtLte","$ne","mergeNe","mergeEq","massageSelector","wasAnded","isAndInSelector","isAnd","mergeAndedSelectorsNested","orOrNor","subSelector","collate","normalizeKey","ai","collationIndex","bi","stringCollate","arrayCollate","ak","bk","objectCollate","Infinity","origKey","toJSON","indexify","expFormat","toExponential","magnitude","neg","magString","padWith","upToLength","padding","targetLength","pad","factor","factorStr","toFixed","numToIndexableString","toIndexableString","objKey","parseNumber","originalIdx","numAsString","magAsString","metaStack","lastMetaElement","lastElementIndex","filterInMemoryFields","rows","requestDef","inMemoryFields","rowFilter","fieldSorter","getFieldValuesAsArray","sorting","aRow","bRow","collation","createFieldSorter","docFieldValue","some","orMatchers","find","matchCominationalSelector","matchSelector","userOperator","userValue","matchers","fieldExists","fieldIsNotUndefined","arrayContainsValue","divisor","mod","modField","neValue","arraySize","arrayContainsAllValues","regexMatch","typeMatch","filterName","changesHandler","doc_ids","viewName","ddoc","mapFun","views","rowsMatched","matchesSelector","filterFun","filters","toObject","version","reservedWords","dataWords","parseRevisionInfo","parseDoc","newEdits","dbOpts","nRevNum","revInfo","revisions","revisionIds","makeRevTreeFromRevisions","specialKey","preprocessString","blobType","asBinary","parseBase64","digest","preprocessAttachment","md5","preprocessBlob","updateDoc","revLimit","prev","docInfo","writeDoc","splitRev","targetPos","targetId","revExists","previousWinningRev","previouslyDeleted","isRoot","newRev","rev_map","winningRev$$1","winningRevIsDeleted","delta","processDocs","docInfos","fetchedDocs","tx","overallCallback","idsToDocs","docsDone","docsToDo","checkAllDocsDone","currentDoc","resultsIdx","docWritten","nextDoc","rootIsMissing","insertDoc","DOC_STORE","META_STORE","safeJsonStringify","json","idbError","encodeMetadata","deletedOrLocal","decodeMetadata","storedObject","safeJsonParse","decodeDoc","_doc_id_rev","readBlobData","asBlob","fetchAttachmentsIfNecessary","txn","attObj","objectStore","onsuccess","fetchAttachment","postProcessAttachments","attNames","compactRevs","possiblyOrphanedDigests","seqStore","attStore","attAndSeqStore","IDBKeyRange","bound","deleteOrphanedAttachments","openCursor","only","cursor","digestSeq","primaryKey","continue","openTransactionSafely","idb","stores","transaction","idbBulkDocs","docStore","bySeqStore","attachStore","attachAndSeqStore","metaStore","docInfoError","metaDoc","allDocsProcessed","docCountDelta","preconditionErrored","_meta","blobSupport","onAllDocsProcessed","updateDocCountIfReady","docCount","newRevIsDeleted","isUpdate","collectResults","finishDoc","attachmentSaved","newAtt","saveAttachment","writeAttachments","afterPutDoc","revsToDelete","compactTree","metadataToStore","afterPutMetadata","attsAdded","attsToAdd","onerror","insertAttachmentMappings","putReq","overallErr","docv","recv","processedAttachment","preprocessAttachments","txnResult","onabort","ontimeout","oncomplete","finish","digests","filename","verifyAttachment","attErr","verifyAttachments","numFetched","revs_limit","readMetadata","fetchExistingDocs","startTransaction","runBatchedCursor","keyRange","batchSize","onBatch","keysBatch","valuesBatch","pseudoCursor","onGetAll","onGetAllKeys","onCursor","getAll","getAllKeys","newKeyRange","lastKey","upper","upperOpen","code","lowerBound","idbAllDocs","keyRangeError","inclusiveEnd","inclusive_end","upperBound","createKeyRange","onResultsReady","updateSeq","onSuccess","docIdRevIndex","allDocsInner","fetchDocAsynchronously","batchValues","batchValue","batchKeys","returnVal","total_rows","maxKey","allDocsKeys","running","applyNext","docIds","numResults","docIdsToMetadata","onGetMetadata","docIdRev","objectStores","winningDocs","metadatas","fetchWinningDocAndMetadata","winningDoc","processMetadataAndWinningDoc","onBatchDone","filtered","blobSupportPromise","cachedDBs","openReqList","IdbPouch","tryCode","enqueueTask","thisCallback","addDeletedOrLocalIndex","createIndex","unique","migrateLocalStore","localStore","local","range","seqCursor","migrateAttsAndSeqs","digestMap","migrateMetadata","onGetMetadataSeq","metadataSeq","fetchMetadataSeq","instanceId","reqOpts","historyNode","attachId","attachment","blobData","doc_count","idb_attachment_format","oldRev","oStore","oldDoc","openReq","indexedDB","deleteDatabase","cached","open","onupgradeneeded","oldVersion","createObjectStore","keyPath","autoIncrement","createSchema","currentTarget","createLocalStoreSchema","addAttachAndSeqStore","migrations","migration","onversionchange","storedMetaDoc","completeSetup","storeMetaDocIfReady","instanceKey","countDocs","blob$$1","matchedChrome","matchedEdge","checkBlobSupport","supportsBulkGetMap","readAttachmentsAsBlobOrBuffer","encodeDocId","preprocessAttachments$1","getHost","hasUrlPrefix","user","password","username","genDBUrl","genUrl","pathDel","paramsToStr","params","HttpPouch","dbUrl","setupPromise","ourFetch","headers","credentials","nAuth","token","ua","isIE","isTrident","isEdge","isGET","shouldCacheBust","now","adapterFun$$1","setup","fetchJSON","response","skip_setup","encodeAttachmentId","uuid$$1","ping","compact_running","interval","doBulkGet","doBulkGetShim","numBatches","onResult","batchNum","subOpts","supportsBulkGet","fetchAttachments","filenames","promiseFactories","doNext","runNextBatch","onError","thisErr","pool","process","browser","fetchData","docOrDocs","contentType","paramStr","batch_size","heartbeat","requestTimeout","timeout","leftToFetch","feed","seq_interval","param_name","lastFetchedSeq","controller","aborted","fetchOpts","signal","fetched","raw_results_length","finished","QueryParseError","NotFoundError","BuiltInError","promisedCallback","sequentialize","promiseFactory","uniq","theSet","mapToKeysArray","createBuiltInError","sum","jLen","jNum","log","evalFunctionWithEval","TaskQueue$1","createView","sourceDB","reduceFun","temporary","localDocName","cachedViews","viewSignature","createViewSignature","_cachedViews","promiseForView","depDbName","fullViewName","depDbs","lastSeqDoc","persistentQueues","tempViewQueue","parseViewName","emitError","builtInReduce","sumsqr","_sumsqr","abstract","mapper","reducer","ddocValidator","tryMap","tryReduce","rereduce","output","sortByKeyThenValue","keyCompare","sliceResults","rowToDocId","postprocessAttachments","addHttpParam","paramName","asJson","coerceInteger","integerCandidate","asNumber","checkQueryParseError","startkeyName","endkeyName","group_level","optionName","checkPositiveInteger","defaultsTo","getDocsToPersist","docIdsToChangesAndEmits","metaDocId","defaultMetaDoc","docData","indexableKeysToKeyValues","isGenOne","getKeyValueDocs","kvDocsRes","kvDocs","oldKeys","keyValue","newKeys","kvDoc","processKeyValueDocs","getQueue","updateView","mapResults","currentSeq","listOfDocsToPersist","docsToPersist","saveKeyValues","processNextBatch","createIndexableKeysToKeyValues","createDocIdsToChangesAndEmits","emittedKeyValue","complexKey","updateViewInQueue","queryView","totalRows","shouldReduce","fetchFromView","viewOpts","expectedKeys","parsedKeyAndDocId","parsedNum","parsedStr","arrayElement","objElement","parseIndexableString","onMapResultsReady","finalResults","shouldGroup","lvl","POSITIVE_INFINITY","groupKey","reduceTry","reduceView","allDocsRes","docIdsToDocs","fetchPromises","keyStart","keyEnd","queryViewInQueue","queryPromised","_query","customQuery","keysAsString","httpQuery","finalPromiseFactory","designDocName","stale","coerceOptions","viewCleanup","_viewCleanup","customViewCleanup","httpViewCleanup","docsToViews","viewsToStatus","ddocName","viewDBNames","statusIsGood","viewDBName","destroyPromises","localViewCleanup","createAbstractMapReduce","origMap","reduceFunString","builtIn","getBuiltIn","mapreduce","isGenOne$1","getDocAttachments","getDocs","diffs","resultDocs","fetchRevisionOneDocs","hasConflicts","bulkGetOpts","missingRev","createBulkGetOpts","bulkGetResponse","bulkGetInfo","remoteDoc","doCheckForLocalAttachments","fileHasChanged","getDocAttachmentsFromTargetOrSource","Boolean","updateCheckpoint","checkpoint","session","returnValue","session_id","replicator","Checkpointer","writeCheckpoint","updateTarget","updateSource","writeTargetCheckpoint","writeSourceCheckpoint","isForbiddenError","comparisons","targetDoc","sourceDoc","srcDoc","tgtDoc","compareReplicationHistory","sourceHistory","targetHistory","S","sourceRest","T","targetRest","hasSessionId","compareReplicationLogs","sessionId","props","floor","getCheckpoint","generateReplicationId","queryParams","filterViewName","sortObjectPropertiesByKey","queryData","md5sum","replicate","currentBatch","repId","checkpointer","batches","pendingBatch","writingCheckpoint","changesCompleted","replicationCompleted","batches_limit","changesPending","changedDocs","start_time","docs_read","docs_written","doc_write_failures","initCheckpointer","checkpointOpts","writeDocs","bulkOpts","completeReplication","errorsById","errorsNo","errorName","finishBatch","outResult","getChanges","onCheckpointError","getBatchDocs","got","startNextBatch","abortReplication","processPendingBatch","immediate$$1","fatalError","end_time","retry","back_off_function","backOffSet","current_back_off","backOff","onChangesComplete","onChangesError","_abortChanges","abortChanges","startChanges","_addedListeners","Replication","toPouch","PouchConstructor","replicateWrapper","replicateRet","sync","Sync","canceled","optsPush","optsPull","pull","pullChange","direction","pushChange","pushDenied","pullDenied","pushPaused","pullPaused","pushActive","pullActive","removed","removeAll","addOneListener","out","success","_readyCalled","replicateMethods","other","parseManifest","manifest","NeumeEdit","TextEdit","TextView","prepareEditMode","textView","View","Display","image","title","core","Info","setupEdit","initDb","delay","pageNo","getCurrentPage","changePage","redo","undo","pageURI","elementID","updateDatabase","getAnnotations","timestamp","readAsDataURL","deleteDb","getMEI","mei","getSVG","v1","arrayPrefix","objPrefix","numChar","parsedString","lastCh","numConsecutiveSlashes","className","handleZoom","displayControlsPanel","addUpdateCallback","updateVisualization","DisplayControls","setZoomControls","initDisplayControls","setOpacityFromSlider","updateCallbacks","divaReady","diva","Diva","objectData","minHeight","indexMap","disableDragScrollable","displayPanel","loadDelay","initDivaEvents","setViewEventHandlers","onresize","innerHeight","innerWidth","Events","subscribe","settings","ID","didLoad","adjustZoom","pageIndex","checkAndLoad","page","getPageSVG","svg","updateSVG","containerId","pageIndexes","getActivePageIndex","zoomDuration","firstChild","inner","dimensions","getPageDimensionsAtCurrentZoomLevel","viewHandler","_viewerCore","getPageRegion","includePadding","incorporateViewport","marginLeft","getComputedStyle","getPropertyValue","top","setDisplayListeners","findIndex","visibility","clear","sequence","sequences","canvases","itemTitle","pages","panel","createElementNS","bg","setAttributeNS","hasAttribute","replaceChild","resetTransformations","_page","_delay","restoreTransformation","setSelectListeners","touches","scrollZoom","newHeight","initEditModeControls","insertHandler","bindInsertTabs","click","Select","setSelectHelperObjects","initInsertEditControls","editMenu","backgroundColor","setSelectStrokeWidth","initSelectionButtons","setHighlightSelectionControls","isInsertMode","clickSelect","dragSelect","neumeGroups","updateInfoVisibility","neumeInfo","checked","setInfoControls","block","label","resetInfoListeners","updateInfo","stopListeners","elementClass","attributes","ncs","getContour","ligated","pitches","getPitches","toUpperCase","updateInfoModule","pitchNameToNum","innerText","pname","cont","entries","notificationSent","textLabel","bboxLabel","textButton","bboxButton","setTextViewControls","updateTextViewVisibility","updateBBoxViewVisibility","initSelectByBBoxButton","sylText","getSylText","text","initTextEdit","lyrics","selBySylListener","addBBoxListeners","updateSylText","button","orig","corrected","prompt","copyAttributes","array1","array2","staffBasedMei","DOMParser","serializer","XMLSerializer","meiDoc","parseFromString","precedesSyllables","section","getElementsByTagName","newStaff","newLayer","layer","sb","custos","lastElementChild","lastElement","followsId","followsSyllable","previousElementSibling","firstElementChild","serializeToString","sbBasedMei","originalStaves","origSyllable","isEqualNode","insertBefore","lastChild","insertAdjacentElement","newSyllable","childArray","sbIndex","sbInfo","currentSb","nextSb","childrenArray","copyArray","msCrypto","rnds8","rnds","byteToHex","bth","activate","insertActive","deactivate","editMode","initEditMode","tabIds","tab","selectedOption","insertDisabled","bindElements","toggleInsert","toggleEdit","insertContents","editContents","selBySyl","selByNeume","selByNc","selByStaff","selectBySylHandler","selectByNeumeHandler","selectByNcHandler","selectByStaffHandler","groupingAction","getChildrenIds","getIds","syllable0","syllable1","secondSyllable","groupType","neumeParent","Warnings","groupingNotRecognized","childrenIds","PointNames","TopLeft","Top","TopRight","Right","BottomRight","Bottom","BottomLeft","Left","GetPoints","points","sin","initialPoint","initialUly","initialLry","whichRotatePoint","initialRectY","polyLen","initialRotate","redraw","pointString","_elem","pointName","point","pointStringRight","pointStringLeft","drawInitialRect","whichPoint","viewportElement","resizeStart","resizeDrag","resizeEnd","rotateStart","temp","tempRotate","rotateEnd","which","PI","currentPoint","firstClick","removeInsertClickHandlers","keydownListener","resetInsertHandler","clickawayHandler","insertMenu","staffHandler","cursorpt","coord","buttonId","alreadyInInsertMode","editModeButton","getGetParam","manifestLocation","storage","statusText","Response","location","verovioWrapper","Validation","undoStacks","redoStacks","neonCache","blankPages","annotations","mei_annotations","lastPageLoaded","annotation","getTime","newAnnotation","loadData","blankPage","convertSbToStaff","dirty","sendForValidation","handle","loadPage","entry","currentMEI","updateCache","svgText","meiPromise","svgPromise","updateTimestamp","pair","schemaResponse","worker","statusField","updateUI","line","link","panelBlock","pNotif","Worker","meiData","verovioWorker","cachedSetTimeout","cachedClearTimeout","defaultSetTimout","defaultClearTimeout","runTimeout","currentQueue","queueIndex","cleanUpNextTick","drainQueue","run","marker","runClearTimeout","Item","noop","env","argv","versions","binding","cwd","chdir","dir","umask","_nodeId","_clockseq","rng","bytesToUuid","_lastMSecs","_lastNSecs","clockseq","seedBytes","msecs","nsecs","dt","tl","tmh","ii","NeonSchema","NeonContext","manifestString","Validator","attribute","unresolvedRefs","types","validators","shouldResolve","addSchema","ourUri","addSubSchemaArray","addSubSchema","addSubSchemaObject","setSchemas","getSchema","urn","sch","validateSchema","switchSchema","schemaobj","schemaTraverser","superResolve","resolved","subctx","subschema","skipAttributes","ignoreProperties","validatorErr","allowUnknownAttributes","rewrite","parsed","fragment","testType","isFinite","integer","boolean","date","any","nodeType","freeGlobal","maxInt","regexPunycode","regexNonASCII","regexSeparators","stringFromCharCode","fn","mapDomain","ucs2decode","extra","counter","ucs2encode","digitToBasic","digit","flag","adapt","numPoints","firstTime","baseMinusTMin","decode","basic","oldi","baseMinusT","codePoint","inputLength","bias","encode","handledCPCount","basicLength","q","currentValue","handledCPCountPlusOne","qMinusT","webpackPolyfill","deprecate","qs","sep","eq","maxKeys","kstr","vstr","xs","stringifyPrimitive","objectKeys","ks","f","testSchemaNoThrow","testAdditionalProperty","preValidateProperty","nestedErrors","minProperties","maxProperties","minimum","exclusiveMinimum","maximum","exclusiveMaximum","validateMultipleOfOrDivisbleBy","validationType","errorMessage","validationArgument","instanceDecimals","divisorDecimals","maxDecimals","multiplier","pow","testArrays","multipleOf","divisibleBy","required","minLength","hsp","maxLength","minItems","maxItems","uniqueItems","dep","childContext","notTypes","schemaId","startEditMode","navbarDropdownMenu","undoRedoPanel","initNavbar","initUndoRedoPanel","selectionHighlight","divider","save","export","download","confirm","reload","getPageMEI","convertStaffToSb","getPageName","undoHandler","redoHandler","editItem","editButton","fileLink","navbarContents","navbarFinalize","ViewBox","imageWidth","imageHeight","z","zoomHeight","zoomWidth","ZoomHandler","bgimg","viewBox","updateViewBox","getViewBox","translate","rawViewBox","dragCoordinates","matrix","newCoordinates","deltaX","deltaY","newTransform","dragTransform","slider","newK","getZoom","cursorPt","splitDisable","capture","resetHandler"],"mappings":"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","file":"editor.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, { enumerable: true, get: getter });\n \t\t}\n \t};\n\n \t// define __esModule on exports\n \t__webpack_require__.r = function(exports) {\n \t\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n \t\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n \t\t}\n \t\tObject.defineProperty(exports, '__esModule', { value: true });\n \t};\n\n \t// create a fake namespace object\n \t// mode & 1: value is a module id, require it\n \t// mode & 2: merge all properties of value into the ns\n \t// mode & 4: return value when already ns object\n \t// mode & 8|1: behave like require\n \t__webpack_require__.t = function(value, mode) {\n \t\tif(mode & 1) value = __webpack_require__(value);\n \t\tif(mode & 8) return value;\n \t\tif((mode & 4) && typeof value === 'object' && value && value.__esModule) return value;\n \t\tvar ns = Object.create(null);\n \t\t__webpack_require__.r(ns);\n \t\tObject.defineProperty(ns, 'default', { enumerable: true, value: value });\n \t\tif(mode & 2 && typeof value != 'string') for(var key in value) __webpack_require__.d(ns, key, function(key) { return value[key]; }.bind(null, key));\n \t\treturn ns;\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"\";\n\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 38);\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\nvar R = typeof Reflect === 'object' ? Reflect : null\nvar ReflectApply = R && typeof R.apply === 'function'\n  ? R.apply\n  : function ReflectApply(target, receiver, args) {\n    return Function.prototype.apply.call(target, receiver, args);\n  }\n\nvar ReflectOwnKeys\nif (R && typeof R.ownKeys === 'function') {\n  ReflectOwnKeys = R.ownKeys\n} else if (Object.getOwnPropertySymbols) {\n  ReflectOwnKeys = function ReflectOwnKeys(target) {\n    return Object.getOwnPropertyNames(target)\n      .concat(Object.getOwnPropertySymbols(target));\n  };\n} else {\n  ReflectOwnKeys = function ReflectOwnKeys(target) {\n    return Object.getOwnPropertyNames(target);\n  };\n}\n\nfunction ProcessEmitWarning(warning) {\n  if (console && console.warn) console.warn(warning);\n}\n\nvar NumberIsNaN = Number.isNaN || function NumberIsNaN(value) {\n  return value !== value;\n}\n\nfunction EventEmitter() {\n  EventEmitter.init.call(this);\n}\nmodule.exports = EventEmitter;\n\n// Backwards-compat with node 0.10.x\nEventEmitter.EventEmitter = EventEmitter;\n\nEventEmitter.prototype._events = undefined;\nEventEmitter.prototype._eventsCount = 0;\nEventEmitter.prototype._maxListeners = undefined;\n\n// By default EventEmitters will print a warning if more than 10 listeners are\n// added to it. This is a useful default which helps finding memory leaks.\nvar defaultMaxListeners = 10;\n\nfunction checkListener(listener) {\n  if (typeof listener !== 'function') {\n    throw new TypeError('The \"listener\" argument must be of type Function. Received type ' + typeof listener);\n  }\n}\n\nObject.defineProperty(EventEmitter, 'defaultMaxListeners', {\n  enumerable: true,\n  get: function() {\n    return defaultMaxListeners;\n  },\n  set: function(arg) {\n    if (typeof arg !== 'number' || arg < 0 || NumberIsNaN(arg)) {\n      throw new RangeError('The value of \"defaultMaxListeners\" is out of range. It must be a non-negative number. Received ' + arg + '.');\n    }\n    defaultMaxListeners = arg;\n  }\n});\n\nEventEmitter.init = function() {\n\n  if (this._events === undefined ||\n      this._events === Object.getPrototypeOf(this)._events) {\n    this._events = Object.create(null);\n    this._eventsCount = 0;\n  }\n\n  this._maxListeners = this._maxListeners || undefined;\n};\n\n// Obviously not all Emitters should be limited to 10. This function allows\n// that to be increased. Set to zero for unlimited.\nEventEmitter.prototype.setMaxListeners = function setMaxListeners(n) {\n  if (typeof n !== 'number' || n < 0 || NumberIsNaN(n)) {\n    throw new RangeError('The value of \"n\" is out of range. It must be a non-negative number. Received ' + n + '.');\n  }\n  this._maxListeners = n;\n  return this;\n};\n\nfunction _getMaxListeners(that) {\n  if (that._maxListeners === undefined)\n    return EventEmitter.defaultMaxListeners;\n  return that._maxListeners;\n}\n\nEventEmitter.prototype.getMaxListeners = function getMaxListeners() {\n  return _getMaxListeners(this);\n};\n\nEventEmitter.prototype.emit = function emit(type) {\n  var args = [];\n  for (var i = 1; i < arguments.length; i++) args.push(arguments[i]);\n  var doError = (type === 'error');\n\n  var events = this._events;\n  if (events !== undefined)\n    doError = (doError && events.error === undefined);\n  else if (!doError)\n    return false;\n\n  // If there is no 'error' event listener then throw.\n  if (doError) {\n    var er;\n    if (args.length > 0)\n      er = args[0];\n    if (er instanceof Error) {\n      // Note: The comments on the `throw` lines are intentional, they show\n      // up in Node's output if this results in an unhandled exception.\n      throw er; // Unhandled 'error' event\n    }\n    // At least give some kind of context to the user\n    var err = new Error('Unhandled error.' + (er ? ' (' + er.message + ')' : ''));\n    err.context = er;\n    throw err; // Unhandled 'error' event\n  }\n\n  var handler = events[type];\n\n  if (handler === undefined)\n    return false;\n\n  if (typeof handler === 'function') {\n    ReflectApply(handler, this, args);\n  } else {\n    var len = handler.length;\n    var listeners = arrayClone(handler, len);\n    for (var i = 0; i < len; ++i)\n      ReflectApply(listeners[i], this, args);\n  }\n\n  return true;\n};\n\nfunction _addListener(target, type, listener, prepend) {\n  var m;\n  var events;\n  var existing;\n\n  checkListener(listener);\n\n  events = target._events;\n  if (events === undefined) {\n    events = target._events = Object.create(null);\n    target._eventsCount = 0;\n  } else {\n    // To avoid recursion in the case that type === \"newListener\"! Before\n    // adding it to the listeners, first emit \"newListener\".\n    if (events.newListener !== undefined) {\n      target.emit('newListener', type,\n                  listener.listener ? listener.listener : listener);\n\n      // Re-assign `events` because a newListener handler could have caused the\n      // this._events to be assigned to a new object\n      events = target._events;\n    }\n    existing = events[type];\n  }\n\n  if (existing === undefined) {\n    // Optimize the case of one listener. Don't need the extra array object.\n    existing = events[type] = listener;\n    ++target._eventsCount;\n  } else {\n    if (typeof existing === 'function') {\n      // Adding the second element, need to change to array.\n      existing = events[type] =\n        prepend ? [listener, existing] : [existing, listener];\n      // If we've already got an array, just append.\n    } else if (prepend) {\n      existing.unshift(listener);\n    } else {\n      existing.push(listener);\n    }\n\n    // Check for listener leak\n    m = _getMaxListeners(target);\n    if (m > 0 && existing.length > m && !existing.warned) {\n      existing.warned = true;\n      // No error code for this since it is a Warning\n      // eslint-disable-next-line no-restricted-syntax\n      var w = new Error('Possible EventEmitter memory leak detected. ' +\n                          existing.length + ' ' + String(type) + ' listeners ' +\n                          'added. Use emitter.setMaxListeners() to ' +\n                          'increase limit');\n      w.name = 'MaxListenersExceededWarning';\n      w.emitter = target;\n      w.type = type;\n      w.count = existing.length;\n      ProcessEmitWarning(w);\n    }\n  }\n\n  return target;\n}\n\nEventEmitter.prototype.addListener = function addListener(type, listener) {\n  return _addListener(this, type, listener, false);\n};\n\nEventEmitter.prototype.on = EventEmitter.prototype.addListener;\n\nEventEmitter.prototype.prependListener =\n    function prependListener(type, listener) {\n      return _addListener(this, type, listener, true);\n    };\n\nfunction onceWrapper() {\n  if (!this.fired) {\n    this.target.removeListener(this.type, this.wrapFn);\n    this.fired = true;\n    if (arguments.length === 0)\n      return this.listener.call(this.target);\n    return this.listener.apply(this.target, arguments);\n  }\n}\n\nfunction _onceWrap(target, type, listener) {\n  var state = { fired: false, wrapFn: undefined, target: target, type: type, listener: listener };\n  var wrapped = onceWrapper.bind(state);\n  wrapped.listener = listener;\n  state.wrapFn = wrapped;\n  return wrapped;\n}\n\nEventEmitter.prototype.once = function once(type, listener) {\n  checkListener(listener);\n  this.on(type, _onceWrap(this, type, listener));\n  return this;\n};\n\nEventEmitter.prototype.prependOnceListener =\n    function prependOnceListener(type, listener) {\n      checkListener(listener);\n      this.prependListener(type, _onceWrap(this, type, listener));\n      return this;\n    };\n\n// Emits a 'removeListener' event if and only if the listener was removed.\nEventEmitter.prototype.removeListener =\n    function removeListener(type, listener) {\n      var list, events, position, i, originalListener;\n\n      checkListener(listener);\n\n      events = this._events;\n      if (events === undefined)\n        return this;\n\n      list = events[type];\n      if (list === undefined)\n        return this;\n\n      if (list === listener || list.listener === listener) {\n        if (--this._eventsCount === 0)\n          this._events = Object.create(null);\n        else {\n          delete events[type];\n          if (events.removeListener)\n            this.emit('removeListener', type, list.listener || listener);\n        }\n      } else if (typeof list !== 'function') {\n        position = -1;\n\n        for (i = list.length - 1; i >= 0; i--) {\n          if (list[i] === listener || list[i].listener === listener) {\n            originalListener = list[i].listener;\n            position = i;\n            break;\n          }\n        }\n\n        if (position < 0)\n          return this;\n\n        if (position === 0)\n          list.shift();\n        else {\n          spliceOne(list, position);\n        }\n\n        if (list.length === 1)\n          events[type] = list[0];\n\n        if (events.removeListener !== undefined)\n          this.emit('removeListener', type, originalListener || listener);\n      }\n\n      return this;\n    };\n\nEventEmitter.prototype.off = EventEmitter.prototype.removeListener;\n\nEventEmitter.prototype.removeAllListeners =\n    function removeAllListeners(type) {\n      var listeners, events, i;\n\n      events = this._events;\n      if (events === undefined)\n        return this;\n\n      // not listening for removeListener, no need to emit\n      if (events.removeListener === undefined) {\n        if (arguments.length === 0) {\n          this._events = Object.create(null);\n          this._eventsCount = 0;\n        } else if (events[type] !== undefined) {\n          if (--this._eventsCount === 0)\n            this._events = Object.create(null);\n          else\n            delete events[type];\n        }\n        return this;\n      }\n\n      // emit removeListener for all listeners on all events\n      if (arguments.length === 0) {\n        var keys = Object.keys(events);\n        var key;\n        for (i = 0; i < keys.length; ++i) {\n          key = keys[i];\n          if (key === 'removeListener') continue;\n          this.removeAllListeners(key);\n        }\n        this.removeAllListeners('removeListener');\n        this._events = Object.create(null);\n        this._eventsCount = 0;\n        return this;\n      }\n\n      listeners = events[type];\n\n      if (typeof listeners === 'function') {\n        this.removeListener(type, listeners);\n      } else if (listeners !== undefined) {\n        // LIFO order\n        for (i = listeners.length - 1; i >= 0; i--) {\n          this.removeListener(type, listeners[i]);\n        }\n      }\n\n      return this;\n    };\n\nfunction _listeners(target, type, unwrap) {\n  var events = target._events;\n\n  if (events === undefined)\n    return [];\n\n  var evlistener = events[type];\n  if (evlistener === undefined)\n    return [];\n\n  if (typeof evlistener === 'function')\n    return unwrap ? [evlistener.listener || evlistener] : [evlistener];\n\n  return unwrap ?\n    unwrapListeners(evlistener) : arrayClone(evlistener, evlistener.length);\n}\n\nEventEmitter.prototype.listeners = function listeners(type) {\n  return _listeners(this, type, true);\n};\n\nEventEmitter.prototype.rawListeners = function rawListeners(type) {\n  return _listeners(this, type, false);\n};\n\nEventEmitter.listenerCount = function(emitter, type) {\n  if (typeof emitter.listenerCount === 'function') {\n    return emitter.listenerCount(type);\n  } else {\n    return listenerCount.call(emitter, type);\n  }\n};\n\nEventEmitter.prototype.listenerCount = listenerCount;\nfunction listenerCount(type) {\n  var events = this._events;\n\n  if (events !== undefined) {\n    var evlistener = events[type];\n\n    if (typeof evlistener === 'function') {\n      return 1;\n    } else if (evlistener !== undefined) {\n      return evlistener.length;\n    }\n  }\n\n  return 0;\n}\n\nEventEmitter.prototype.eventNames = function eventNames() {\n  return this._eventsCount > 0 ? ReflectOwnKeys(this._events) : [];\n};\n\nfunction arrayClone(arr, n) {\n  var copy = new Array(n);\n  for (var i = 0; i < n; ++i)\n    copy[i] = arr[i];\n  return copy;\n}\n\nfunction spliceOne(list, index) {\n  for (; index + 1 < list.length; index++)\n    list[index] = list[index + 1];\n  list.pop();\n}\n\nfunction unwrapListeners(arr) {\n  var ret = new Array(arr.length);\n  for (var i = 0; i < ret.length; ++i) {\n    ret[i] = arr[i].listener || arr[i];\n  }\n  return ret;\n}\n","if (typeof Object.create === 'function') {\n  // implementation from standard node.js 'util' module\n  module.exports = function inherits(ctor, superCtor) {\n    ctor.super_ = superCtor\n    ctor.prototype = Object.create(superCtor.prototype, {\n      constructor: {\n        value: ctor,\n        enumerable: false,\n        writable: true,\n        configurable: true\n      }\n    });\n  };\n} else {\n  // old school shim for old browsers\n  module.exports = function inherits(ctor, superCtor) {\n    ctor.super_ = superCtor\n    var TempCtor = function () {}\n    TempCtor.prototype = superCtor.prototype\n    ctor.prototype = new TempCtor()\n    ctor.prototype.constructor = ctor\n  }\n}\n","'use strict';\nvar Mutation = global.MutationObserver || global.WebKitMutationObserver;\n\nvar scheduleDrain;\n\n{\n  if (Mutation) {\n    var called = 0;\n    var observer = new Mutation(nextTick);\n    var element = global.document.createTextNode('');\n    observer.observe(element, {\n      characterData: true\n    });\n    scheduleDrain = function () {\n      element.data = (called = ++called % 2);\n    };\n  } else if (!global.setImmediate && typeof global.MessageChannel !== 'undefined') {\n    var channel = new global.MessageChannel();\n    channel.port1.onmessage = nextTick;\n    scheduleDrain = function () {\n      channel.port2.postMessage(0);\n    };\n  } else if ('document' in global && 'onreadystatechange' in global.document.createElement('script')) {\n    scheduleDrain = function () {\n\n      // Create a <script> element; its readystatechange event will be fired asynchronously once it is inserted\n      // into the document. Do so, thus queuing up the task. Remember to clean up once it's been called.\n      var scriptEl = global.document.createElement('script');\n      scriptEl.onreadystatechange = function () {\n        nextTick();\n\n        scriptEl.onreadystatechange = null;\n        scriptEl.parentNode.removeChild(scriptEl);\n        scriptEl = null;\n      };\n      global.document.documentElement.appendChild(scriptEl);\n    };\n  } else {\n    scheduleDrain = function () {\n      setTimeout(nextTick, 0);\n    };\n  }\n}\n\nvar draining;\nvar queue = [];\n//named nextTick for less confusing stack traces\nfunction nextTick() {\n  draining = true;\n  var i, oldQueue;\n  var len = queue.length;\n  while (len) {\n    oldQueue = queue;\n    queue = [];\n    i = -1;\n    while (++i < len) {\n      oldQueue[i]();\n    }\n    len = queue.length;\n  }\n  draining = false;\n}\n\nmodule.exports = immediate;\nfunction immediate(task) {\n  if (queue.push(task) === 1 && !draining) {\n    scheduleDrain();\n  }\n}\n","module.exports = d3;","'use strict';\n\nmodule.exports = argsArray;\n\nfunction argsArray(fun) {\n  return function () {\n    var len = arguments.length;\n    if (len) {\n      var args = [];\n      var i = -1;\n      while (++i < len) {\n        args[i] = arguments[i];\n      }\n      return fun.call(this, args);\n    } else {\n      return fun.call(this, []);\n    }\n  };\n}","'use strict';\n\nvar uri = require('url');\n\nvar ValidationError = exports.ValidationError = function ValidationError (message, instance, schema, propertyPath, name, argument) {\n  if (propertyPath) {\n    this.property = propertyPath;\n  }\n  if (message) {\n    this.message = message;\n  }\n  if (schema) {\n    if (schema.id) {\n      this.schema = schema.id;\n    } else {\n      this.schema = schema;\n    }\n  }\n  if (instance) {\n    this.instance = instance;\n  }\n  this.name = name;\n  this.argument = argument;\n  this.stack = this.toString();\n};\n\nValidationError.prototype.toString = function toString() {\n  return this.property + ' ' + this.message;\n};\n\nvar ValidatorResult = exports.ValidatorResult = function ValidatorResult(instance, schema, options, ctx) {\n  this.instance = instance;\n  this.schema = schema;\n  this.propertyPath = ctx.propertyPath;\n  this.errors = [];\n  this.throwError = options && options.throwError;\n  this.disableFormat = options && options.disableFormat === true;\n};\n\nValidatorResult.prototype.addError = function addError(detail) {\n  var err;\n  if (typeof detail == 'string') {\n    err = new ValidationError(detail, this.instance, this.schema, this.propertyPath);\n  } else {\n    if (!detail) throw new Error('Missing error detail');\n    if (!detail.message) throw new Error('Missing error message');\n    if (!detail.name) throw new Error('Missing validator type');\n    err = new ValidationError(detail.message, this.instance, this.schema, this.propertyPath, detail.name, detail.argument);\n  }\n\n  if (this.throwError) {\n    throw err;\n  }\n  this.errors.push(err);\n  return err;\n};\n\nValidatorResult.prototype.importErrors = function importErrors(res) {\n  if (typeof res == 'string' || (res && res.validatorType)) {\n    this.addError(res);\n  } else if (res && res.errors) {\n    Array.prototype.push.apply(this.errors, res.errors);\n  }\n};\n\nfunction stringizer (v,i){\n  return i+': '+v.toString()+'\\n';\n}\nValidatorResult.prototype.toString = function toString(res) {\n  return this.errors.map(stringizer).join('');\n};\n\nObject.defineProperty(ValidatorResult.prototype, \"valid\", { get: function() {\n  return !this.errors.length;\n} });\n\n/**\n * Describes a problem with a Schema which prevents validation of an instance\n * @name SchemaError\n * @constructor\n */\nvar SchemaError = exports.SchemaError = function SchemaError (msg, schema) {\n  this.message = msg;\n  this.schema = schema;\n  Error.call(this, msg);\n  Error.captureStackTrace(this, SchemaError);\n};\nSchemaError.prototype = Object.create(Error.prototype,\n  { constructor: {value: SchemaError, enumerable: false}\n  , name: {value: 'SchemaError', enumerable: false}\n  });\n\nvar SchemaContext = exports.SchemaContext = function SchemaContext (schema, options, propertyPath, base, schemas) {\n  this.schema = schema;\n  this.options = options;\n  this.propertyPath = propertyPath;\n  this.base = base;\n  this.schemas = schemas;\n};\n\nSchemaContext.prototype.resolve = function resolve (target) {\n  return uri.resolve(this.base, target);\n};\n\nSchemaContext.prototype.makeChild = function makeChild(schema, propertyName){\n  var propertyPath = (propertyName===undefined) ? this.propertyPath : this.propertyPath+makeSuffix(propertyName);\n  var base = uri.resolve(this.base, schema.id||'');\n  var ctx = new SchemaContext(schema, this.options, propertyPath, base, Object.create(this.schemas));\n  if(schema.id && !ctx.schemas[base]){\n    ctx.schemas[base] = schema;\n  }\n  return ctx;\n}\n\nvar FORMAT_REGEXPS = exports.FORMAT_REGEXPS = {\n  'date-time': /^\\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])[tT ](2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])(\\.\\d+)?([zZ]|[+-]([0-5][0-9]):(60|[0-5][0-9]))$/,\n  'date': /^\\d{4}-(?:0[0-9]{1}|1[0-2]{1})-(3[01]|0[1-9]|[12][0-9])$/,\n  'time': /^(2[0-4]|[01][0-9]):([0-5][0-9]):(60|[0-5][0-9])$/,\n\n  'email': /^(?:[\\w\\!\\#\\$\\%\\&\\'\\*\\+\\-\\/\\=\\?\\^\\`\\{\\|\\}\\~]+\\.)*[\\w\\!\\#\\$\\%\\&\\'\\*\\+\\-\\/\\=\\?\\^\\`\\{\\|\\}\\~]+@(?:(?:(?:[a-zA-Z0-9](?:[a-zA-Z0-9\\-](?!\\.)){0,61}[a-zA-Z0-9]?\\.)+[a-zA-Z0-9](?:[a-zA-Z0-9\\-](?!$)){0,61}[a-zA-Z0-9]?)|(?:\\[(?:(?:[01]?\\d{1,2}|2[0-4]\\d|25[0-5])\\.){3}(?:[01]?\\d{1,2}|2[0-4]\\d|25[0-5])\\]))$/,\n  'ip-address': /^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,\n  'ipv6': /^\\s*((([0-9A-Fa-f]{1,4}:){7}([0-9A-Fa-f]{1,4}|:))|(([0-9A-Fa-f]{1,4}:){6}(:[0-9A-Fa-f]{1,4}|((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){5}(((:[0-9A-Fa-f]{1,4}){1,2})|:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3})|:))|(([0-9A-Fa-f]{1,4}:){4}(((:[0-9A-Fa-f]{1,4}){1,3})|((:[0-9A-Fa-f]{1,4})?:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){3}(((:[0-9A-Fa-f]{1,4}){1,4})|((:[0-9A-Fa-f]{1,4}){0,2}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){2}(((:[0-9A-Fa-f]{1,4}){1,5})|((:[0-9A-Fa-f]{1,4}){0,3}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(([0-9A-Fa-f]{1,4}:){1}(((:[0-9A-Fa-f]{1,4}){1,6})|((:[0-9A-Fa-f]{1,4}){0,4}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:))|(:(((:[0-9A-Fa-f]{1,4}){1,7})|((:[0-9A-Fa-f]{1,4}){0,5}:((25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)(\\.(25[0-5]|2[0-4]\\d|1\\d\\d|[1-9]?\\d)){3}))|:)))(%.+)?\\s*$/,\n  'uri': /^[a-zA-Z][a-zA-Z0-9+-.]*:[^\\s]*$/,\n\n  'color': /^(#?([0-9A-Fa-f]{3}){1,2}\\b|aqua|black|blue|fuchsia|gray|green|lime|maroon|navy|olive|orange|purple|red|silver|teal|white|yellow|(rgb\\(\\s*\\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\b\\s*,\\s*\\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\b\\s*,\\s*\\b([0-9]|[1-9][0-9]|1[0-9][0-9]|2[0-4][0-9]|25[0-5])\\b\\s*\\))|(rgb\\(\\s*(\\d?\\d%|100%)+\\s*,\\s*(\\d?\\d%|100%)+\\s*,\\s*(\\d?\\d%|100%)+\\s*\\)))$/,\n\n  // hostname regex from: http://stackoverflow.com/a/1420225/5628\n  'hostname': /^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\\.?$/,\n  'host-name': /^(?=.{1,255}$)[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?(?:\\.[0-9A-Za-z](?:(?:[0-9A-Za-z]|-){0,61}[0-9A-Za-z])?)*\\.?$/,\n\n  'alpha': /^[a-zA-Z]+$/,\n  'alphanumeric': /^[a-zA-Z0-9]+$/,\n  'utc-millisec': function (input) {\n    return (typeof input === 'string') && parseFloat(input) === parseInt(input, 10) && !isNaN(input);\n  },\n  'regex': function (input) {\n    var result = true;\n    try {\n      new RegExp(input);\n    } catch (e) {\n      result = false;\n    }\n    return result;\n  },\n  'style': /\\s*(.+?):\\s*([^;]+);?/g,\n  'phone': /^\\+(?:[0-9] ?){6,14}[0-9]$/\n};\n\nFORMAT_REGEXPS.regexp = FORMAT_REGEXPS.regex;\nFORMAT_REGEXPS.pattern = FORMAT_REGEXPS.regex;\nFORMAT_REGEXPS.ipv4 = FORMAT_REGEXPS['ip-address'];\n\nexports.isFormat = function isFormat (input, format, validator) {\n  if (typeof input === 'string' && FORMAT_REGEXPS[format] !== undefined) {\n    if (FORMAT_REGEXPS[format] instanceof RegExp) {\n      return FORMAT_REGEXPS[format].test(input);\n    }\n    if (typeof FORMAT_REGEXPS[format] === 'function') {\n      return FORMAT_REGEXPS[format](input);\n    }\n  } else if (validator && validator.customFormats &&\n      typeof validator.customFormats[format] === 'function') {\n    return validator.customFormats[format](input);\n  }\n  return true;\n};\n\nvar makeSuffix = exports.makeSuffix = function makeSuffix (key) {\n  key = key.toString();\n  // This function could be capable of outputting valid a ECMAScript string, but the\n  // resulting code for testing which form to use would be tens of thousands of characters long\n  // That means this will use the name form for some illegal forms\n  if (!key.match(/[.\\s\\[\\]]/) && !key.match(/^[\\d]/)) {\n    return '.' + key;\n  }\n  if (key.match(/^\\d+$/)) {\n    return '[' + key + ']';\n  }\n  return '[' + JSON.stringify(key) + ']';\n};\n\nexports.deepCompareStrict = function deepCompareStrict (a, b) {\n  if (typeof a !== typeof b) {\n    return false;\n  }\n  if (a instanceof Array) {\n    if (!(b instanceof Array)) {\n      return false;\n    }\n    if (a.length !== b.length) {\n      return false;\n    }\n    return a.every(function (v, i) {\n      return deepCompareStrict(a[i], b[i]);\n    });\n  }\n  if (typeof a === 'object') {\n    if (!a || !b) {\n      return a === b;\n    }\n    var aKeys = Object.keys(a);\n    var bKeys = Object.keys(b);\n    if (aKeys.length !== bKeys.length) {\n      return false;\n    }\n    return aKeys.every(function (v) {\n      return deepCompareStrict(a[v], b[v]);\n    });\n  }\n  return a === b;\n};\n\nfunction deepMerger (target, dst, e, i) {\n  if (typeof e === 'object') {\n    dst[i] = deepMerge(target[i], e)\n  } else {\n    if (target.indexOf(e) === -1) {\n      dst.push(e)\n    }\n  }\n}\n\nfunction copyist (src, dst, key) {\n  dst[key] = src[key];\n}\n\nfunction copyistWithDeepMerge (target, src, dst, key) {\n  if (typeof src[key] !== 'object' || !src[key]) {\n    dst[key] = src[key];\n  }\n  else {\n    if (!target[key]) {\n      dst[key] = src[key];\n    } else {\n      dst[key] = deepMerge(target[key], src[key])\n    }\n  }\n}\n\nfunction deepMerge (target, src) {\n  var array = Array.isArray(src);\n  var dst = array && [] || {};\n\n  if (array) {\n    target = target || [];\n    dst = dst.concat(target);\n    src.forEach(deepMerger.bind(null, target, dst));\n  } else {\n    if (target && typeof target === 'object') {\n      Object.keys(target).forEach(copyist.bind(null, target, dst));\n    }\n    Object.keys(src).forEach(copyistWithDeepMerge.bind(null, target, src, dst));\n  }\n\n  return dst;\n};\n\nmodule.exports.deepMerge = deepMerge;\n\n/**\n * Validates instance against the provided schema\n * Implements URI+JSON Pointer encoding, e.g. \"%7e\"=\"~0\"=>\"~\", \"~1\"=\"%2f\"=>\"/\"\n * @param o\n * @param s The path to walk o along\n * @return any\n */\nexports.objectGetPath = function objectGetPath(o, s) {\n  var parts = s.split('/').slice(1);\n  var k;\n  while (typeof (k=parts.shift()) == 'string') {\n    var n = decodeURIComponent(k.replace(/~0/,'~').replace(/~1/g,'/'));\n    if (!(n in o)) return;\n    o = o[n];\n  }\n  return o;\n};\n\nfunction pathEncoder (v) {\n  return '/'+encodeURIComponent(v).replace(/~/g,'%7E');\n}\n/**\n * Accept an Array of property names and return a JSON Pointer URI fragment\n * @param Array a\n * @return {String}\n */\nexports.encodePath = function encodePointer(a){\n\t// ~ must be encoded explicitly because hacks\n\t// the slash is encoded by encodeURIComponent\n\treturn a.map(pathEncoder).join('');\n};\n\n\n/**\n * Calculate the number of decimal places a number uses\n * We need this to get correct results out of multipleOf and divisibleBy\n * when either figure is has decimal places, due to IEEE-754 float issues.\n * @param number\n * @returns {number}\n */\nexports.getDecimalPlaces = function getDecimalPlaces(number) {\n\n  var decimalPlaces = 0;\n  if (isNaN(number)) return decimalPlaces;\n\n  if (typeof number !== 'number') {\n    number = Number(number);\n  }\n\n  var parts = number.toString().split('e');\n  if (parts.length === 2) {\n    if (parts[1][0] !== '-') {\n      return decimalPlaces;\n    } else {\n      decimalPlaces = Number(parts[1].slice(1));\n    }\n  }\n\n  var decimalParts = parts[0].split('.');\n  if (decimalParts.length === 2) {\n    decimalPlaces += decimalParts[1].length;\n  }\n\n  return decimalPlaces;\n};\n\n","/** @module DisplayPanel/DisplayControls */\n\nimport * as Color from '../utils/Color';\nimport ZoomHandler from '../SingleView/Zoom';\n\nlet lastGlyphOpacity: number, lastImageOpacity: number;\n\n/**\n * Initialize listeners and controls for display panel.\n * @param {string} meiClassName - The class used to signifiy the MEI element(s).\n * @param {string} background - The class used to signify the background.\n */\nexport function initDisplayControls (meiClassName: string, background: string): void {\n  setOpacityControls(meiClassName);\n  setBackgroundOpacityControls(background);\n  setHighlightControls();\n  setBurgerControls();\n\n  const displayContents = document.getElementById('displayContents');\n  const toggleDisplay = document.getElementById('toggleDisplay');\n\n  toggleDisplay.parentElement.addEventListener('click', () => {\n    if (displayContents.style.display === 'none') {\n      displayContents.style.display = '';\n      toggleDisplay.setAttribute('xlink:href', __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down');\n    } else {\n      displayContents.style.display = 'none';\n      toggleDisplay.setAttribute('xlink:href', __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-side');\n    }\n  });\n}\n\n/**\n * Set zoom control listener for button and slider\n */\nexport function setZoomControls (zoomHandler?: ZoomHandler): void {\n  if (zoomHandler === undefined) {\n    return;\n  }\n  const zoomSlider = document.getElementById('zoomSlider') as HTMLInputElement;\n  const zoomOutput = document.getElementById('zoomOutput') as HTMLOutputElement;\n\n  zoomSlider.value = '100';\n  document.getElementById('reset-zoom').addEventListener('click', () => {\n    zoomOutput.value = '100';\n    zoomSlider.value = '100';\n    zoomHandler.resetZoomAndPan();\n  });\n\n  zoomSlider.addEventListener('input', inputChangeHandler);\n  zoomSlider.addEventListener('change', inputChangeHandler);\n\n  function inputChangeHandler (): void {\n    zoomOutput.value = zoomSlider.value;\n    zoomHandler.zoomTo(Number(zoomOutput.value) / 100.0);\n  }\n\n  document.body.addEventListener('keydown', (evt) => {\n    const currentZoom = parseInt(zoomOutput.value);\n    if (evt.key === '+') { // increase zoom by 20\n      const newZoom = Math.min(currentZoom + 20, parseInt(zoomSlider.getAttribute('max')));\n      zoomHandler.zoomTo(newZoom / 100.0);\n      zoomOutput.value = String(newZoom);\n      zoomSlider.value = String(newZoom);\n    } else if (evt.key === '-') { // decrease zoom by 20\n      const newZoom = Math.max(currentZoom - 20, parseInt(zoomSlider.getAttribute('min')));\n      zoomHandler.zoomTo(newZoom / 100.0);\n      zoomOutput.value = String(Math.round(newZoom));\n      zoomSlider.value = String(newZoom);\n    } else if (evt.key === '0') {\n      zoomOutput.value = '100';\n      zoomSlider.value = '100';\n      zoomHandler.resetZoomAndPan();\n    }\n  });\n}\n\n/**\n * Set rendered MEI opacity button and slider listeners.\n */\nfunction setOpacityControls (meiClassName: string): void {\n  lastGlyphOpacity = 100;\n  const opacitySlider = document.getElementById('opacitySlider') as HTMLInputElement;\n  const opacityOutput = document.getElementById('opacityOutput') as HTMLOutputElement;\n\n  opacitySlider.value = '100';\n\n  document.getElementById('reset-opacity').addEventListener('click', () => {\n    // Definition scale is the root element of what is generated by verovio\n    const lowerOpacity = lastGlyphOpacity < 95 ? lastGlyphOpacity / 100.0 : 0;\n    const newOpacity = opacitySlider.value === '100' ? lowerOpacity : 1;\n    (document.querySelectorAll('.' + meiClassName) as NodeListOf<HTMLElement>).forEach(g => {\n      g.style.opacity = newOpacity.toString();\n    });\n\n    lastGlyphOpacity = Number(opacitySlider.value);\n    opacitySlider.value = String(newOpacity * 100);\n    opacityOutput.value = String(Math.round(newOpacity * 100));\n  });\n\n  opacitySlider.addEventListener('input', inputChangeOpacity);\n  opacitySlider.addEventListener('change', inputChangeOpacity);\n\n  function inputChangeOpacity (): void {\n    opacityOutput.value = opacitySlider.value;\n    lastGlyphOpacity = Number(opacitySlider.value);\n    (document.querySelector('.' + meiClassName) as HTMLElement)\n      .style.opacity = (Number(opacityOutput.value) / 100.0).toString();\n  }\n}\n\n/**\n * Update MEI opacity to value from the slider.\n */\nexport function setOpacityFromSlider (meiClassName?: string): void {\n  const opacityOutput = document.getElementById('opacityOutput') as HTMLOutputElement;\n  opacityOutput.value = (document.getElementById('opacitySlider') as HTMLInputElement).value;\n  try {\n    ((document.querySelectorAll('.' + meiClassName)) as NodeListOf<HTMLElement>).forEach(g => {\n      g.style.opacity = (Number(opacityOutput.value) / 100.0).toString();\n    });\n  } catch (e) {}\n}\n\n/**\n * Set background image opacity button and slider listeners.\n */\nfunction setBackgroundOpacityControls (background: string): void {\n  lastImageOpacity = 100;\n  const bgOpacitySlider = document.getElementById('bgOpacitySlider') as HTMLInputElement;\n  const bgOpacityOutput = document.getElementById('bgOpacityOutput') as HTMLOutputElement;\n\n  bgOpacitySlider.value = '100';\n  document.getElementById('reset-bg-opacity').addEventListener('click', () => {\n    const lowerOpacity = lastImageOpacity < 95 ? lastImageOpacity / 100.0 : 0;\n    const newOpacity = bgOpacitySlider.value === '100' ? lowerOpacity : 1;\n    (document.getElementsByClassName(background)[0] as HTMLElement)\n      .style.opacity = newOpacity.toString();\n\n    lastImageOpacity = Number(bgOpacitySlider.value);\n    bgOpacitySlider.value = String(newOpacity * 100);\n    bgOpacityOutput.value = String(Math.round(newOpacity * 100));\n  });\n\n  bgOpacitySlider.addEventListener('input', bgInputChangeHandler);\n  bgOpacitySlider.addEventListener('change', bgInputChangeHandler);\n\n  function bgInputChangeHandler (): void {\n    bgOpacityOutput.value = bgOpacitySlider.value;\n    lastImageOpacity = Number(bgOpacitySlider.value);\n    (document.getElementsByClassName(background)[0] as HTMLElement)\n      .style.opacity = (Number(bgOpacityOutput.value) / 100.0).toString();\n  }\n}\n\n/**\n * Set listener on staff highlighting checkbox.\n */\nexport function setHighlightControls (): void {\n  const highlightDropdown = document.getElementById('highlight-dropdown');\n  const highlightStaff = document.getElementById('highlight-staff');\n  const highlightSyllable = document.getElementById('highlight-syllable');\n  const highlightNeume = document.getElementById('highlight-neume');\n  const highlightNone = document.getElementById('highlight-none');\n  const highlightType = document.getElementById('highlight-type');\n\n  document.getElementById('highlight-button').addEventListener('click', (evt) => {\n    evt.stopPropagation();\n    highlightDropdown.classList.toggle('is-active');\n    if (highlightDropdown.classList.contains('is-active')) {\n      document.body.addEventListener('click', highlightClickaway);\n      highlightStaff.addEventListener('click', () => {\n        highlightDropdown.classList.remove('is-active');\n        document.querySelectorAll('.highlight-selected').forEach(elem => {\n          elem.classList.remove('highlight-selected');\n        });\n        highlightStaff.classList.add('highlight-selected');\n        highlightType.textContent = ' - Staff';\n        Color.setGroupingHighlight('staff');\n      });\n      highlightSyllable.addEventListener('click', () => {\n        highlightDropdown.classList.remove('is-active');\n        document.querySelectorAll('.highlight-selected').forEach(elem => {\n          elem.classList.remove('highlight-selected');\n        });\n        highlightSyllable.classList.add('highlight-selected');\n        highlightType.textContent = ' - Syllable';\n        Color.setGroupingHighlight('syllable');\n      });\n      highlightNeume.addEventListener('click', () => {\n        highlightDropdown.classList.remove('is-active');\n        document.querySelectorAll('.highlight-selected').forEach(elem => {\n          elem.classList.remove('highlight-selected');\n        });\n        highlightNeume.classList.add('highlight-selected');\n        highlightType.textContent = ' - Neume';\n        Color.setGroupingHighlight('neume');\n      });\n      highlightNone.addEventListener('click', () => {\n        highlightDropdown.classList.remove('is-active');\n        document.querySelectorAll('.highlight-selected').forEach(elem => {\n          elem.classList.remove('highlight-selected');\n        });\n        highlightType.textContent = ' - Off';\n        Color.unsetGroupingHighlight();\n      });\n    } else {\n      document.body.removeEventListener('click', highlightClickaway);\n    }\n  });\n}\n\nexport function setHighlightSelectionControls (): void {\n  const highlightSelection = document.getElementById('highlight-selection');\n  highlightSelection.addEventListener('click', () => {\n    document.getElementById('highlight-dropdown').classList.remove('is-active');\n    document.querySelectorAll('.highlight-selected').forEach(elem => {\n      elem.classList.remove('highlight-selected');\n    });\n    highlightSelection.classList.add('highlight-selected');\n    document.getElementById('highlight-type').textContent = ' - Selection';\n    Color.setGroupingHighlight('selection');\n  });\n}\n\n/**\n * Reset the highlight for different types based on the 'highlight-selected' class in the DOM.\n */\nexport function updateHighlight (): void {\n  let highlightId: string;\n  try {\n    highlightId = document.querySelector('.highlight-selected').id;\n  } catch (e) {\n    highlightId = '';\n  }\n  switch (highlightId) {\n    case 'highlight-staff':\n      Color.setGroupingHighlight('staff');\n      break;\n    case 'highlight-syllable':\n      Color.setGroupingHighlight('syllable');\n      break;\n    case 'highlight-neume':\n      Color.setGroupingHighlight('neume');\n      break;\n    case 'highlight-selection':\n      Color.setGroupingHighlight('selection');\n      break;\n    default:\n      Color.unsetGroupingHighlight();\n  }\n}\n\n/**\n * Set listener on burger menu for smaller screens.\n */\nfunction setBurgerControls () {\n  document.getElementById('burgerMenu').addEventListener('click', () => {\n    document.getElementById('burgerMenu').classList.toggle('is-active');\n    document.getElementById('navMenu').classList.toggle('is-active');\n  });\n}\n\n/**\n * Clickaway listener for the highlight dropdown.\n */\nfunction highlightClickaway () {\n  document.body.removeEventListener('click', highlightClickaway);\n  document.getElementById('highlight-dropdown').classList.remove('is-active');\n}\n","import * as Color from './Color';\nimport { updateHighlight } from '../DisplayPanel/DisplayControls';\nimport * as Grouping from '../SquareEdit/Grouping';\nimport { resize } from './Resize';\nimport { Attributes } from '../Types';\nimport NeonView from '../NeonView';\nimport DragHandler from './DragHandler';\nimport * as SelectOptions from '../SquareEdit/SelectOptions';\n\nimport * as d3 from 'd3';\n/**\n * Get the selection mode chosen by the user.\n */\nexport function getSelectionType (): string {\n  const element = document.getElementsByClassName('sel-by is-active');\n  if (element.length !== 0) {\n    return element[0].id;\n  } else {\n    return null;\n  }\n}\n\n/**\n * Unselect all selected elements and run undo any extra\n * actions.\n */\nexport function unselect (): void {\n  document.querySelectorAll('.selected').forEach((selected: SVGGElement) => {\n    selected.classList.remove('selected');\n    if (selected.classList.contains('staff')) {\n      selected.removeAttribute('style');\n      Color.unhighlight(selected);\n    } else {\n      selected.removeAttribute('style');\n      selected.style.fill = '';\n    }\n  });\n  Array.from(document.getElementsByClassName('text-select')).forEach((el: SVGElement) => {\n    el.style.color = '';\n    el.style.fontWeight = '';\n    el.classList.remove('text-select');\n  });\n  Array.from(document.getElementsByClassName('sylTextRect-display')).forEach((sylRect: HTMLElement) => {\n    sylRect.style.fill = 'blue';\n  });\n\n  Array.from(document.getElementsByClassName('syllable-highlighted')).forEach((syllable: HTMLElement) => {\n    syllable.style.fill = '';\n    syllable.classList.add('syllable');\n    syllable.classList.remove('syllable-highlighted');\n  });\n\n  d3.selectAll('#resizeRect').remove();\n  d3.selectAll('.resizePoint').remove();\n  d3.selectAll('.rotatePoint').remove();\n\n  if (!document.getElementById('selByStaff').classList.contains('is-active')) {\n    Grouping.endGroupingSelection();\n  } else {\n    SelectOptions.endOptionsSelection();\n  }\n  document.getElementById('extraEdit').innerHTML = '';\n  document.getElementById('extraEdit').classList.add('is-invisible');\n  updateHighlight();\n}\n\n/**\n * Generic select function.\n */\nexport function select (el: SVGGraphicsElement, dragHandler?: DragHandler): void {\n  if (el.classList.contains('staff')) {\n    return selectStaff(el, dragHandler);\n  }\n  if (!el.classList.contains('selected') && !el.classList.contains('sylTextRect') &&\n      !el.classList.contains('sylTextRect-display')) {\n    el.classList.add('selected');\n    el.style.fill = '#d00';\n    if (el.querySelectorAll('.sylTextRect-display').length) {\n      el.querySelectorAll('.sylTextRect-display').forEach((elem: HTMLElement) => {\n        elem.style.fill = 'red';\n      });\n    }\n    let sylId;\n    if (el.classList.contains('syllable')) {\n      sylId = el.id;\n    } else if (el.closest('.syllable') !== null) {\n      sylId = el.closest('.syllable').id;\n    }\n    if (sylId !== undefined) {\n      const spans = document.querySelectorAll('span.' + sylId);\n      spans.forEach((span: HTMLElement) => {\n        span.style.color = '#d00';\n        span.style.fontWeight = 'bold';\n        span.classList.add('text-select');\n      });\n    }\n  }\n  updateHighlight();\n}\n\n/**\n * Select an nc.\n */\nexport async function selectNcs (el: SVGGraphicsElement, neonView: NeonView, dragHandler: DragHandler): Promise<void> {\n  if (!el.parentElement.classList.contains('selected')) {\n    const parent = el.parentElement as unknown as SVGGraphicsElement;\n    unselect();\n    select(parent);\n    if (await isLigature(parent, neonView)) {\n      const prevNc = parent.previousSibling as unknown as SVGGraphicsElement;\n      if (await isLigature(prevNc, neonView)) {\n        select(prevNc);\n      } else {\n        const nextNc = parent.nextSibling as unknown as SVGGraphicsElement;\n        if (await isLigature(nextNc, neonView)) {\n          select(nextNc);\n        } else {\n          console.warn('Error: Neither prev or next nc are ligatures');\n        }\n      }\n      Grouping.triggerGrouping('ligature');\n    } else if (parent.classList.contains('nc')) {\n      SelectOptions.triggerNcActions(parent);\n    } else {\n      console.warn('No action triggered!');\n    }\n    dragHandler.dragInit();\n  }\n}\n\n/**\n * Check if neume component is part of a ligature\n */\nexport async function isLigature (nc: SVGGraphicsElement, neonView: NeonView): Promise<boolean> {\n  const attributes: Attributes = await neonView.getElementAttr(nc.id, neonView.view.getCurrentPageURI());\n  return (attributes.ligated);\n}\n\n/**\n * Check if the elements have the same parent up two levels.\n */\nexport function sharedSecondLevelParent (elements: SVGElement[]): boolean {\n  const tempElements = Array.from(elements);\n  const firstElement = tempElements.pop();\n  const secondParent = firstElement.parentElement.parentElement;\n  for (const element of tempElements) {\n    const secPar = element.parentElement.parentElement;\n    if (secPar.id !== secondParent.id) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Get the bounding box of a staff based on its staff lines.\n * Rotate is included in radians.\n */\nexport function getStaffBBox (staff: SVGGElement): {ulx: number; uly: number; lrx: number; lry: number; rotate: number} {\n  let ulx, uly, lrx, lry, rotate;\n  staff.querySelectorAll('path').forEach(path => {\n    const coordinates: number[] = path.getAttribute('d')\n      .match(/\\d+/g)\n      .map(element => Number(element));\n    if (rotate === undefined) {\n      rotate = Math.atan((coordinates[3] - coordinates[1]) /\n        (coordinates[2] - coordinates[0]));\n    }\n\n    if (uly === undefined || Math.min(coordinates[1], coordinates[3]) < uly) {\n      uly = Math.min(coordinates[1], coordinates[3]);\n    }\n    if (ulx === undefined || coordinates[0] < ulx) {\n      ulx = coordinates[0];\n    }\n    if (lry === undefined || Math.max(coordinates[1], coordinates[3]) > lry) {\n      lry = Math.max(coordinates[1], coordinates[3]);\n    }\n    if (lrx === undefined || coordinates[2] > lrx) {\n      lrx = coordinates[2];\n    }\n  });\n  return { 'ulx': ulx, 'uly': uly, 'lrx': lrx, 'lry': lry, 'rotate': rotate };\n}\n\n/**\n * select a boundingbox element\n * @param el - the bbox (sylTextRect) element in the DOM\n * @param dragHandler - the drag handler in use\n */\nexport function selectBBox (el: SVGGraphicsElement, dragHandler: DragHandler, neonView: NeonView): void {\n  const bbox = el;\n  const syl = bbox.closest('.syl');\n  if (!syl.classList.contains('selected')) {\n    syl.classList.add('selected');\n    bbox.style.fill = '#d00';\n    const closest = el.closest('.syllable') as HTMLElement;\n    closest.style.fill = 'red';\n    closest.classList.add('syllable-highlighted');\n    if (neonView !== undefined ){\n      resize(syl as SVGGraphicsElement, neonView, dragHandler);\n    }\n    if (dragHandler !== undefined) {\n      dragHandler.dragInit();\n    }\n    const sylId = el.closest('.syllable').id;\n    if (sylId !== undefined) {\n      const span: HTMLSpanElement = document.querySelector('span.' + sylId);\n      if (span) {\n        span.style.color = '#d00';\n        span.style.fontWeight = 'bold';\n        span.classList.add('text-select');\n      }\n    }\n  }\n}\n\n/**\n * Select not neume elements.\n * @param notNeumes - An array of not neumes elements.\n */\nexport function selectNn (notNeumes: SVGGraphicsElement[]): boolean {\n  if (notNeumes.length > 0) {\n    notNeumes.forEach(nn => { select(nn); });\n    return false;\n  } else {\n    return true;\n  }\n}\n\n/**\n * Select a staff element.\n * @param staff - The staff element in the DOM.\n * @param dragHandler - The drag handler in use.\n */\nexport function selectStaff (staff: SVGGElement, dragHandler: DragHandler): void {\n  if (!staff.classList.contains('selected')) {\n    staff.classList.add('selected');\n    Color.unhighlight(staff);\n    Color.highlight(staff, '#d00');\n    dragHandler.dragInit();\n  }\n}\n\n/**\n * Handle selecting an array of elements based on the selection type.\n */\nexport async function selectAll (elements: Array<SVGGraphicsElement>, neonView: NeonView, dragHandler: DragHandler): Promise<void> {\n  const selectionType = getSelectionType();\n  unselect();\n  if (elements.length === 0) {\n    return;\n  }\n\n  let selectionClass;\n  let containsClefOrCustos = false;\n\n  switch (selectionType) {\n    case 'selBySyl':\n      selectionClass = '.syllable';\n      break;\n    case 'selByNeume':\n      selectionClass = '.neume';\n      break;\n    case 'selByNc':\n      selectionClass = '.nc';\n      break;\n    case 'selByStaff':\n      selectionClass = '.staff';\n      break;\n    case 'selByBBox':\n      selectionClass = '.sylTextRect-display';\n      break;\n    default:\n      console.error('Unknown selection type ' + selectionType);\n      return;\n  }\n\n  // Get the groupings specified by selectionClass\n  // that contain the provided elements to select.\n  const groupsToSelect = new Set();\n  for (const element of elements) {\n    let grouping = element.closest(selectionClass);\n    if (grouping === null) {\n      // Check if we click-selected a clef or a custos\n      grouping = element.closest('.clef, .custos');\n      if (grouping === null) {\n        console.warn('Element ' + element.id + ' is not part of specified group and is not a clef or custos.');\n        continue;\n      }\n      containsClefOrCustos = containsClefOrCustos || true;\n    }\n    groupsToSelect.add(grouping);\n\n    // Check for precedes/follows\n    const follows = grouping.getAttribute('mei:follows');\n    if (follows) {\n      groupsToSelect.add(document.getElementById(follows.slice(1)));\n    }\n    const precedes = grouping.getAttribute('mei:precedes');\n    if (precedes) {\n      groupsToSelect.add(document.getElementById(precedes.slice(1)));\n    }\n  }\n\n  // Select the elements\n  groupsToSelect.forEach((group: SVGGraphicsElement) => { select(group, dragHandler); });\n\n  /* Determine the context menu to display (if any) */\n\n  const groups = Array.from(groupsToSelect.values()) as SVGGraphicsElement[];\n\n  // Handle occurance of clef or custos\n  if (containsClefOrCustos) {\n    // A context menu will only be displayed if there is a single clef\n    if (groupsToSelect.size === 1 && groups[0].classList.contains('clef')) {\n      SelectOptions.triggerClefActions(groups[0]);\n    } else if (groupsToSelect.size === 1 && groups[0].classList.contains('custos')) {\n      SelectOptions.triggerCustosActions();\n    } else {\n      if (selectionType == 'selBySyl') {\n        SelectOptions.triggerDefaultSylActions();\n      } else {\n        SelectOptions.triggerDefaultActions();\n      }\n    }\n    return;\n  }\n\n  switch (selectionType) {\n    case 'selByStaff':\n      switch (groups.length) {\n        case 1:\n          SelectOptions.triggerSplitActions();\n          resize(groups[0], neonView, dragHandler);\n          break;\n        default:\n          SelectOptions.triggerStaffActions();\n      }\n      break;\n\n    case 'selBySyl':\n      switch (groups.length) {\n        case 1:\n          // TODO change context if it is only a neume/nc.\n          SelectOptions.triggerSylActions();\n          break;\n        case 2:\n          // Check if this is a linked syllable split by a staff break\n          if ((groups[0].getAttribute('mei:follows') === '#' + groups[1].id) ||\n          (groups[0].getAttribute('mei:precedes') === '#' + groups[1].id)) {\n            Grouping.triggerGrouping('splitSyllable');\n          } else if (sharedSecondLevelParent(groups)) {\n            Grouping.triggerGrouping('syl');\n          } else {\n            // Check if this *could* be a selection with a single logical syllable split by a staff break.\n            const staff0 = groups[0].closest('.staff');\n            const staff1 = groups[1].closest('.staff');\n            const staffChildren = Array.from(staff0.parentElement.children);\n            // Check if these are adjacent staves (logically)\n            if (Math.abs(staffChildren.indexOf(staff0) - staffChildren.indexOf(staff1)) === 1) {\n              // Check if one syllable is the last in the first staff and the other is the first in the second.\n              // Determine which staff is first.\n              const firstStaff = (staffChildren.indexOf(staff0) < staffChildren.indexOf(staff1)) ? staff0 : staff1;\n              const secondStaff = (firstStaff.id === staff0.id) ? staff1 : staff0;\n              const firstLayer = firstStaff.querySelector('.layer');\n              const secondLayer = secondStaff.querySelector('.layer');\n\n              // Check that the first staff has either syllable as the last syllable\n              const firstSyllableChildren = Array.from(firstLayer.children)\n                .filter((elem: HTMLElement) => elem.classList.contains('syllable')) as HTMLElement[];\n              const secondSyllableChildren = Array.from(secondLayer.children)\n                .filter((elem: HTMLElement) => elem.classList.contains('syllable')) as HTMLElement[];\n              const lastSyllable = firstSyllableChildren[firstSyllableChildren.length - 1];\n              const firstSyllable = secondSyllableChildren[0];\n              if (lastSyllable.id === groups[0].id && firstSyllable.id === groups[1].id) {\n                Grouping.triggerGrouping('splitSyllable');\n                break;\n              } else if (lastSyllable.id === groups[1].id && firstSyllable.id === groups[0].id) {\n                Grouping.triggerGrouping('splitSyllable');\n                break;\n              }\n            }\n            SelectOptions.triggerDefaultSylActions();\n          }\n          break;\n        default:\n          if (sharedSecondLevelParent(groups)) {\n            Grouping.triggerGrouping('syl');\n          } else {\n            SelectOptions.triggerDefaultSylActions();\n          }\n      }\n      break;\n\n    case 'selByNeume':\n      switch (groups.length) {\n        case 1:\n          // TODO change context if it is only a nc.\n          SelectOptions.triggerNeumeActions();\n          break;\n        default:\n          if (sharedSecondLevelParent(groups)) {\n            Grouping.triggerGrouping('neume');\n          } else {\n            SelectOptions.triggerDefaultActions();\n          }\n      }\n      break;\n\n    case 'selByNc':\n      switch (groups.length) {\n        case 1:\n          SelectOptions.triggerNcActions(groups[0]);\n          break;\n        case 2:\n          if (sharedSecondLevelParent(groups)) {\n            // Check if this selection is a ligature or can be a ligature\n            // Check if these neume components are part of the same neume\n            if (groups[0].parentElement === groups[1].parentElement) {\n              const children = Array.from(groups[0].parentElement.children);\n              // Check that neume components are adjacent\n              if (Math.abs(children.indexOf(groups[0]) - children.indexOf(groups[1])) === 1) {\n                // Check that second neume component is lower than first.\n                // Note that the order in the list may not be the same as the\n                // order by x-position.\n                const orderFirstX = (groups[0].children[0] as SVGUseElement)\n                  .x.baseVal.value;\n                const orderSecondX = (groups[1].children[0] as SVGUseElement)\n                  .x.baseVal.value;\n                let posFirstY, posSecondY;\n\n                if (orderFirstX < orderSecondX) {\n                  posFirstY = (groups[0].children[0] as SVGUseElement)\n                    .y.baseVal.value;\n                  posSecondY = (groups[1].children[0] as SVGUseElement)\n                    .y.baseVal.value;\n                } else {\n                  posFirstY = (groups[1].children[0] as SVGUseElement)\n                    .y.baseVal.value;\n                  posSecondY = (groups[0].children[0] as SVGUseElement)\n                    .y.baseVal.value;\n                }\n\n                // Also ensure both components are marked or not marked as ligatures.\n                const isFirstLigature = await isLigature(groups[0], neonView);\n                const isSecondLigature = await isLigature(groups[1], neonView);\n                if ((posSecondY > posFirstY) && !(isFirstLigature !== isSecondLigature)) {\n                  Grouping.triggerGrouping('ligature');\n                  break;\n                }\n              }\n            }\n            Grouping.triggerGrouping('nc');\n          } else {\n            SelectOptions.triggerDefaultActions();\n          }\n          break;\n        default:\n          if (sharedSecondLevelParent(groups)) {\n            Grouping.triggerGrouping('nc');\n          } else {\n            SelectOptions.triggerDefaultActions();\n          }\n      }\n      break;\n    case 'selByBBox':\n      switch (groups.length) {\n        case 1:\n          selectBBox(groups[0], dragHandler, neonView);\n          break;\n        default:\n          groups.forEach(g => selectBBox(g, dragHandler, undefined));\n          break;\n      }\n      break;\n    default:\n      console.error('Unknown selection type. This should not have occurred.');\n  }\n}\n","import { uuidv4 } from './random';\n\nconst notifications: Notification[] = new Array(0);\nlet currentModeMessage: Notification = null;\nlet notifying = false;\n\n/**\n * Number of notifications to display at a time.\n */\nconst NUMBER_TO_DISPLAY = 3;\n\n/**\n * Add a notification to the queue.\n */\nexport function queueNotification (notification: string): void {\n  const notif = new Notification(notification);\n  notifications.push(notif);\n  if (!notifying || document.getElementById('notification-content').querySelectorAll('.neon-notification').length < NUMBER_TO_DISPLAY) {\n    startNotification();\n  }\n}\n\n/**\n * Start displaying notifications. Called automatically.\n */\nfunction startNotification (): void {\n  if (notifications.length > 0) {\n    notifying = true;\n    const currentNotification = notifications.pop();\n    displayNotification(currentNotification);\n    currentNotification.setTimeoutId(window.setTimeout(clearOrShowNextNotification, 5000, currentNotification.getId()));\n    document.getElementById(currentNotification.getId()).addEventListener('click', () => {\n      window.clearTimeout(currentNotification.timeoutID);\n      clearOrShowNextNotification(currentNotification.getId());\n    });\n  }\n}\n\n/**\n * Display a notification.\n */\nfunction displayNotification (notification: Notification): void {\n  if (notification.isModeMessage) {\n    if (currentModeMessage === null) {\n      currentModeMessage = notification;\n    } else {\n      window.clearTimeout(currentModeMessage.timeoutID);\n      notifications.push(notification);\n      clearOrShowNextNotification(currentModeMessage.getId());\n      return;\n    }\n  }\n  const notificationContent = document.getElementById('notification-content');\n  notificationContent.innerHTML += '<div class=\\'neon-notification\\' id=\\'' + notification.getId() + '\\'>' + notification.message + '</div> ';\n  notificationContent.style.display = '';\n  notification.display();\n}\n\n/**\n * Clear the notifications if no more exist or display another from the queue.\n * @param currentId - The ID of the notification to be cleared.\n */\nfunction clearOrShowNextNotification (currentId: string): void {\n  document.getElementById(currentId).remove();\n  if (currentModeMessage !== null && currentModeMessage.getId() === currentId) {\n    currentModeMessage = null;\n  }\n  if (notifications.length > 0) {\n    startNotification();\n  } else if (document.querySelectorAll('.neon-notification').length === 0) {\n    document.getElementById('notification-content').style.display = 'none';\n    notifying = false;\n  }\n}\n\n/**\n * A class to manage Neon notifications.\n */\nclass Notification {\n  message: string;\n  displayed: boolean;\n  id: string;\n  isModeMessage: boolean;\n  timeoutID: number;\n  /**\n   * Create a new notification.\n   */\n  constructor (message: string) {\n    this.message = message;\n    this.displayed = false;\n    this.id = uuidv4();\n    this.isModeMessage = message.search('Mode') !== -1;\n    this.timeoutID = -1;\n  }\n\n  /** Set the ID from setTimeout. */\n  setTimeoutId (id: number): void {\n    this.timeoutID = Math.max(id, -1);\n  }\n\n  /** Display the Notification. */\n  display (): void {\n    this.displayed = true;\n  }\n\n  /**\n   * Get the UUID for this notification\n   */\n  getId (): string {\n    return this.id;\n  }\n}\n","/**\n * Adapted from color palette from Figure 2 (Colors optimized for color-blind\n * individuals) from\n * [\"Points of view: Color blindness\" by Bang Wong published in Nature Methods volume 8 on 27 May 2011](https://www.nature.com/articles/nmeth.1618?WT.ec_id=NMETH-201106)\n */\nconst ColorPalette: string[] = [\n  'rgb(230, 159, 0)',\n  'rgb(86, 180, 233)',\n  'rgb(0, 158, 115)',\n  'rgb(240, 228, 66)',\n  'rgb(0, 114, 178)',\n  'rgb(213, 94, 0)',\n  'rgb(204, 121, 167)'\n];\n\n/**\n * Remove the highlight from a staff.\n * @param staff If undefined, the all staves are unhighlighted.\n */\nexport function unhighlight (staff?: SVGGElement): void {\n  let children: NodeListOf<Element>;\n  if (staff) {\n    children = staff.querySelectorAll(':not(.selected) .highlighted');\n  } else {\n    children = document.querySelectorAll(':not(.selected) .highlighted');\n  }\n  children.forEach(elem => {\n    if (elem.tagName === 'path' && !elem.closest('.staff').classList.contains('selected')) {\n      elem.setAttribute('stroke', '#000000');\n    } else {\n      elem.removeAttribute('fill');\n      let rects = elem.querySelectorAll('.sylTextRect-display');\n      if (!rects.length) {\n        try {\n          rects = elem.closest('.syllable').querySelectorAll('.sylTextRect-display');\n        } catch (e) {\n          rects = [] as unknown as NodeListOf<Element>;\n        }\n      }\n      rects.forEach(function (rect: HTMLElement) {\n        if (rect.closest('.syllable').classList.contains('selected') || \n            rect.closest('.staff').classList.contains('selected') ||\n            rect.closest('.syl').classList.contains('selected')) {\n          rect.style.fill = 'red';\n        } else {\n          rect.style.fill = 'blue';\n        }\n        rect.classList.remove('highlighted');\n      });\n    }\n    elem.classList.remove('highlighted');\n  });\n}\n\n/**\n * Remove the highlight from each staff.\n */\nexport function unsetStaffHighlight (): void {\n  unhighlight();\n}\n\n/**\n * Unset highlight for all grouping types\n */\nexport function unsetGroupingHighlight (): void {\n  unsetStaffHighlight();\n  const highlighted = Array.from(document.getElementsByClassName('highlighted'))\n    .filter((elem: HTMLElement) => !elem.parentElement.classList.contains('selected'));\n  highlighted.forEach((elem: HTMLElement) => {\n    elem.setAttribute('fill', null);\n    let rects = elem.querySelectorAll('.sylTextRect-display');\n    if (!rects.length) {\n      if (elem.closest('.syllable') !== null) {\n        rects = elem.closest('.syllable').querySelectorAll('sylTextRect-display');\n      }\n    }\n    rects.forEach(function (rect: HTMLElement) {\n      if (rect.closest('.syllable').classList.contains('selected') || rect.closest('.syl').classList.contains('selected')) {\n        rect.style.fill = 'red';\n      } else {\n        rect.style.fill = 'blue';\n      }\n      rect.classList.remove('highlighted');\n    });\n    elem.classList.remove('highlighted');\n    elem.querySelectorAll('sylTextRect-display').forEach(rect => {\n      rect.classList.remove('highlighted');\n    });\n  });\n  Array.from(document.getElementsByClassName('selected')).forEach((el) => {el.setAttribute('fill', '');});\n}\n\n/**\n * Highlight a staff a certain color.\n */\nexport function highlight (staff: SVGGElement, color: string): void {\n  const children = Array.from(staff.children);\n  for (var i = 0; i < children.length; i++) {\n    let child = children[i];\n    if (child.tagName === 'path') {\n      child.setAttribute('stroke', color);\n    } else if (child.classList.contains('resizePoint') || child.id === 'resizeRect' || child.classList.contains('rotatePoint')) {\n      return;\n    } else if (child.classList.contains('layer')) {\n      Array.from(child.children).forEach(cchild => { children.push(cchild); });\n    } else if (document.getElementsByClassName('highlight-selected').length && \n      document.getElementsByClassName('highlight-selected')[0].id === 'highlight-neume'\n      && child.classList.contains('syllable')) {\n      Array.from(child.children).filter(el => el.classList.contains('neume')).forEach(cchild => { children.push(cchild); });\n    } else {\n      child.setAttribute('fill', color);\n      let rects = child.querySelectorAll('.sylTextRect-display');\n      if (!rects.length) {\n        try {\n          rects = child.closest('.syllable').querySelectorAll('.sylTextRect-display');\n        } catch (e) {\n          rects = [] as unknown as NodeListOf<Element>;\n        }\n      }\n      rects.forEach(function (rect: HTMLElement) {\n        if (!(rect.closest('.syllable').classList.contains('selected') ||\n              rect.closest('.syl').classList.contains('selected') ||\n              rect.closest('.staff').classList.contains('selected'))) {\n          rect.style.fill = color;\n          rect.classList.add('highlighted');\n        }\n      });\n    }\n    child.classList.add('highlighted');\n  }\n  let width, height;\n  try {\n    width = Number(document.querySelector('#mei_output').getAttribute('width').split('px')[0]);\n    height = Number(document.querySelector('#mei_output').getAttribute('height').split('px')[0]);\n  } catch (e) {\n    console.debug(e);\n  }\n  let stroke: string;\n  if (width !== undefined && height !== undefined) {\n    // idk looks good :')\n    stroke = (width*height/1000000).toString();\n  }\n  else {\n    stroke = '30px';\n  }\n  staff.querySelectorAll('.nc, .custos, .clef').forEach(el => { \n    el.setAttribute('stroke', 'black'); \n    el.setAttribute('stroke-width', '30px'); \n  });\n}\n\n/**\n * Highlight each staff a different color.\n */\nexport function setStaffHighlight (): void {\n  const staves = Array.from(document.getElementsByClassName('staff')) as SVGGElement[];\n  for (let i = 0; i < staves.length; i++) {\n    const staffColor = ColorPalette[i % ColorPalette.length];\n    highlight(staves[i], staffColor);\n  }\n}\n\n/**\n * Set a highlight by a different grouping.\n * @param grouping - Either \"staff\", \"syllable\", or \"neume\".\n */\nexport function setGroupingHighlight (grouping: string): void {\n  unsetGroupingHighlight();\n  if (grouping === 'staff') {\n    setStaffHighlight();\n    return;\n  } else if (grouping === 'selection') {\n    const temp = document.querySelector('.sel-by.is-active').id;\n    switch (temp) {\n      case 'selBySyl':\n      case 'selByBBox':\n        grouping = 'syllable';\n        break;\n      case 'selByStaff':\n        grouping = 'staff';\n        break;\n      default:\n        grouping = 'neume';\n        break;\n    }\n    setGroupingHighlight(grouping);\n    return;\n  }\n\n  const groups = document.getElementsByClassName(grouping) as HTMLCollectionOf<HTMLElement>;\n  for (let i = 0; i < groups.length; i++) {\n    const groupColor = ColorPalette[i % ColorPalette.length];\n    if ((groups[i].closest('.selected') === null) && !groups[i].classList.contains('selected')) {\n      groups[i].setAttribute('fill', groupColor);\n      const rects = groups[i].querySelectorAll('.sylTextRect-display') as NodeListOf<HTMLElement>;\n      rects.forEach(function (rect) {\n        if (rect.closest('.syl').classList.contains('selected') || \n            rect.closest('.syllable').classList.contains('selected') ||\n            rect.closest('.staff').classList.contains('selected')) {\n          return;\n        }\n        rect.style.fill = groupColor;\n      });\n      groups[i].classList.add('highlighted');\n      groups[i].querySelectorAll('.sylTextRect-display').forEach(rect => {\n        rect.classList.add('highlighted');\n      });\n    } else {\n      if (!groups[i].classList.contains('selected')) {\n        groups[i].setAttribute('fill', null);\n      } else {\n        groups[i].setAttribute('fill', '#d00');\n      }\n      groups[i].classList.remove('highlighted');\n    }\n  }\n  document.querySelectorAll('.nc, .custos, .clef').forEach(el => {\n    el.setAttribute('stroke', 'black'); \n    el.setAttribute('stroke-width', '30px'); \n  });\n}\n","import * as Contents from './Contents';\nimport * as Grouping from './Grouping';\nimport * as Notification from '../utils/Notification';\nimport NeonView from '../NeonView';\nimport { SplitHandler } from './StaffTools';\nimport { EditorAction } from '../Types';\n\n/**\n * The NeonView parent to call editor actions.\n */\nlet neonView: NeonView;\n\n/**\n * Initialize NeonView.\n */\nexport function initNeonView (view: NeonView): void {\n  neonView = view;\n  Grouping.initNeonView(view);\n}\n\n/**\n * Return an action that unsets the inclinatum parameter of an nc.\n * @param id - The id of the neume component.\n */\nexport function unsetInclinatumAction (id: string): object {\n  return {\n    'action': 'set',\n    'param': {\n      'elementId': id,\n      'attrType': 'tilt',\n      'attrValue': ''\n    }\n  };\n}\n\n/**\n * Return an action that unsets the virga parameter of an nc.\n * @param id - The id of the neume component.\n */\nexport function unsetVirgaAction (id: string): object {\n  return {\n    'action': 'set',\n    'param': {\n      'elementId': id,\n      'attrType': 'tilt',\n      'attrValue': ''\n    }\n  };\n}\n\n/**\n * Function to handle removing elements\n */\nexport function removeHandler (): void {\n  const toRemove = [];\n  const selected = Array.from(document.getElementsByClassName('selected'));\n  selected.forEach(elem => {\n    toRemove.push(\n      {\n        'action': 'remove',\n        'param': {\n          'elementId': elem.id\n        }\n      }\n    );\n  });\n  const chainAction: EditorAction = {\n    'action': 'chain',\n    'param': toRemove\n  };\n  endOptionsSelection();\n  neonView.edit(chainAction, neonView.view.getCurrentPageURI()).then(() => { neonView.updateForCurrentPage(); });\n}\n\n/**\n * Function to handle re-associating elements to the nearest staff\n */\nexport function changeStaffHandler(): void {\n  const toChange: EditorAction[] = [];\n  const selected = Array.from(document.getElementsByClassName('selected'));\n  selected.forEach(elem => {\n    toChange.push(\n      {\n        'action': 'changeStaff',\n        'param': {\n          'elementId': elem.id\n        }\n      }\n    );\n  });\n  const chainAction: EditorAction = {\n    'action': 'chain',\n    'param': toChange\n  };\n  endOptionsSelection();\n  neonView.edit(chainAction, neonView.view.getCurrentPageURI()).then(() => { neonView.updateForCurrentPage(); });\n}\n\n/**\n * Trigger the extra nc action menu for a selection.\n */\nexport function triggerNcActions (nc: SVGGraphicsElement): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML = Contents.custosActionContents;\n  } catch (e) {}\n  try {\n    const extraEdit = document.getElementById('extraEdit');\n    extraEdit.classList.remove('is-invisible');\n    extraEdit.innerHTML = Contents.ncActionContents;\n  } catch (e) {}\n  document.querySelector('#Punctum.dropdown-item')\n    .addEventListener('click', () => {\n      const unsetInclinatum = unsetInclinatumAction(nc.id);\n      const unsetVirga = unsetVirgaAction(nc.id);\n      neonView.edit({ 'action': 'chain', 'param': [ unsetInclinatum, unsetVirga ] }, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Shape Changed');\n        } else {\n          Notification.queueNotification('Shape Change Failed');\n        }\n        endOptionsSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n\n  document.querySelector('#Inclinatum.dropdown-item')\n    .addEventListener('click', () => {\n      const setInclinatum = {\n        'action': 'set',\n        'param': {\n          'elementId': nc.id,\n          'attrType': 'tilt',\n          'attrValue': 'se'\n        }\n      };\n      neonView.edit(setInclinatum, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Shape Changed');\n        } else {\n          Notification.queueNotification('Shape Change Failed');\n        }\n        endOptionsSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n\n  document.querySelector('#Virga.dropdown-item')\n    .addEventListener('click', () => {\n      const unsetInclinatum = unsetInclinatumAction(nc.id);\n      const setVirga = {\n        'action': 'set',\n        'param': {\n          'elementId': nc.id,\n          'attrType': 'tilt',\n          'attrValue': 'n'\n        }\n      };\n      neonView.edit({ 'action': 'chain', 'param': [ unsetInclinatum, setVirga ] }, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Shape Changed');\n        } else {\n          Notification.queueNotification('Shape Change Failed');\n        }\n        endOptionsSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n\n  initOptionsListeners();\n}\n\n/**\n * Trigger extra neume actions.\n */\nexport function triggerNeumeActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML = Contents.custosActionContents;\n  } catch (e) {}\n  try {\n    const extraEdit = document.getElementById('extraEdit');\n    extraEdit.classList.remove('is-invisible');\n    extraEdit.innerHTML = Contents.neumeActionContents;\n  } catch (e) {}\n  const neume = document.querySelectorAll('.selected');\n  if (neume.length !== 1) {\n    console.warn('More than one neume selected! Cannot trigger Neume ClickSelect actions.');\n    return;\n  }\n\n  document.querySelector('.grouping')\n    .addEventListener('click', (e) => {\n      const contour = neonView.info.getContourByValue((e.target as HTMLElement).id);\n      triggerChangeGroup(contour);\n    });\n\n  function triggerChangeGroup (contour): void {\n    const changeGroupingAction: EditorAction = {\n      'action': 'changeGroup',\n      'param': {\n        'elementId': neume[0].id,\n        'contour': contour\n      }\n    };\n    neonView.edit(changeGroupingAction, neonView.view.getCurrentPageURI()).then((result) => {\n      if (result) {\n        Notification.queueNotification('Grouping Changed');\n      } else {\n        Notification.queueNotification('Grouping Failed');\n      }\n      endOptionsSelection();\n      neonView.updateForCurrentPage();\n    });\n  }\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n\n  initOptionsListeners();\n  Grouping.initGroupingListeners();\n}\n\n/**\n * Trigger extra syllable actions.\n */\nexport function triggerSylActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML =\n      '<div><p class=\\'control\\'>' +\n          '<button class=\\'button\\' id=\\'ungroupNeumes\\'>Ungroup</button></p></div>' +\n      '<div><p class=\\'control\\'>' +\n          '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div>' +\n      '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'changeStaff\\'>Re-associate to nearest staff</button></p></div>';\n    document.getElementById('changeStaff').addEventListener('click', changeStaffHandler);\n  } catch (e) {}\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n\n  Grouping.initGroupingListeners();\n}\n\n/**\n * Trigger extra clef actions for a specific clef.\n */\nexport function triggerClefActions (clef: SVGGraphicsElement): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    // custos contents is just the delete button\n    moreEdit.innerHTML = Contents.custosActionContents;\n  } catch (e) {}\n  try {\n    const extraEdit = document.getElementById('extraEdit');\n    extraEdit.classList.remove('is-invisible');\n    extraEdit.innerHTML = Contents.clefActionContents;\n  } catch (e) {}\n  document.querySelector('#CClef.dropdown-item')\n    .addEventListener('click', () => {\n      const setCClef: EditorAction = {\n        'action': 'setClef',\n        'param': {\n          'elementId': clef.id,\n          'shape': 'C'\n        }\n      };\n      neonView.edit(setCClef, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Shape Changed');\n        } else {\n          Notification.queueNotification('Shape Change Failed');\n        }\n        endOptionsSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n  document.querySelector('#FClef.dropdown-item')\n    .addEventListener('click', () => {\n      const setFClef: EditorAction = {\n        'action': 'setClef',\n        'param': {\n          'elementId': clef.id,\n          'shape': 'F'\n        }\n      };\n      neonView.edit(setFClef, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Shape Changed');\n        } else {\n          Notification.queueNotification('Shape Change Failed');\n        }\n        endOptionsSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n    document.getElementById('changeStaff').addEventListener('click', changeStaffHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n\n\n  initOptionsListeners();\n}\n\n/**\n * trigger extra custos actions.\n */\nexport function triggerCustosActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML += Contents.custosActionContents;\n  } catch (e) {}\n\n  try {\n    document.getElementById('changeStaff')\n      .addEventListener('click', changeStaffHandler);\n  } catch (e) {}\n\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n    document.body.addEventListener('keydown', deleteButtonHandler);\n  } catch (e) {}\n}\n\n/**\n * Trigger extra staff actions.\n */\nexport function triggerStaffActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML = Contents.staffActionContents;\n  } catch (e) {}\n\n  document.getElementById('merge-systems')\n    .addEventListener('click', () => {\n      const systems = document.querySelectorAll('.staff.selected');\n      const elementIds = [];\n      systems.forEach(staff => {\n        elementIds.push(staff.id);\n      });\n      const editorAction: EditorAction = {\n        'action': 'merge',\n        'param': {\n          'elementIds': elementIds\n        }\n      };\n      neonView.edit(editorAction, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Staff Merged');\n          endOptionsSelection();\n          neonView.updateForCurrentPage();\n        } else {\n          Notification.queueNotification('Merge Failed');\n        }\n      });\n    });\n\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n}\n\n/**\n * Trigger split staff option\n */\nexport function triggerSplitActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML = Contents.splitActionContents;\n  } catch (e) {}\n\n  // TODO add trigger for split action\n  document.getElementById('split-system')\n    .addEventListener('click', () => {\n      const staff = document.querySelector('.staff.selected') as SVGGElement;\n      if (staff !== null) {\n        const split = new SplitHandler(neonView, staff);\n        split.startSplit();\n        endOptionsSelection();\n      } else {\n        console.error('No staff was selected!');\n        endOptionsSelection();\n      }\n    });\n\n  document.getElementById('reset-rotate')\n    .addEventListener('click', () => {\n      const staff = document.querySelector('.staff.selected') as SVGElement;\n      const rect = staff.querySelector('#resizeRect');\n      const co = rect.getAttribute('points').split(' ');\n      let dy = parseInt(co[0].split(',')[1]) - parseInt(co[1].split(',')[1]);\n      if (staff !== null) {\n        const editorAction: EditorAction = {\n          'action': 'changeRotate',\n          'param': {\n            'elementId': staff.id,\n            'dy': dy,\n            'rightSide': true\n          }\n        };\n        neonView.edit(editorAction, neonView.view.getCurrentPageURI()).then(async (result) => {\n          if (result) {\n            await neonView.updateForCurrentPage();\n          }\n        });\n        endOptionsSelection();\n      } else {\n        console.error('No staff was selected');\n        endOptionsSelection();\n      }\n    });\n\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n}\n\n/**\n * trigger default actions when selecting by syl\n */\nexport function triggerDefaultSylActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML = Contents.defaultSylActionContents;\n  } catch (e) {}\n\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n  try {\n    const changeStaff = document.getElementById('changeStaff');\n    changeStaff.removeEventListener('click', changeStaffHandler);\n    changeStaff.addEventListener('click', changeStaffHandler);\n  } catch(e) {}\n}\n\n/**\n * Trigger default selection option.\n */\nexport function triggerDefaultActions (): void {\n  endOptionsSelection();\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.classList.remove('is-invisible');\n    moreEdit.innerHTML = Contents.defaultActionContents;\n  } catch (e) {}\n\n  try {\n    const del = document.getElementById('delete');\n    del.removeEventListener('click', removeHandler);\n    del.addEventListener('click', removeHandler);\n  } catch (e) {}\n  document.body.addEventListener('keydown', deleteButtonHandler);\n}\n\n/**\n * End the extra options menu.\n */\nexport function endOptionsSelection (): void {\n  try {\n    const moreEdit = document.getElementById('moreEdit');\n    moreEdit.innerHTML = '';\n    moreEdit.classList.add('is-invisible');\n  } catch (e) {}\n  document.body.removeEventListener('keydown', deleteButtonHandler);\n}\n\n/**\n * Initialize extra dropdown options.\n */\nfunction initOptionsListeners (): void {\n  document.getElementById('drop_select').addEventListener('click', function () {\n    this.classList.toggle('is-active');\n  });\n}\n\n/** Event handler for delete button press. */\nexport function deleteButtonHandler (evt: KeyboardEvent): void {\n  if (evt.key === 'd' || evt.key === 'Backspace') { removeHandler(); evt.preventDefault(); }\n}\n","import NeonView from '../NeonView';\nimport { EditorAction } from '../Types';\nimport * as d3 from 'd3';\n\nclass DragHandler {\n  private dragStartCoords: Array<number>;\n  private resetToAction: (selection: d3.Selection<d3.BaseType, {}, HTMLElement, any>, args: any[]) => void;\n  readonly neonView: NeonView;\n  private selector: string;\n  private selection: Element[];\n  private dx: number;\n  private dy: number;\n\n  constructor (neonView: NeonView, selector: string) {\n    this.neonView = neonView;\n    this.selector = selector;\n  }\n\n  /**\n   * Initialize the dragging action and handler for selected elements.\n   */\n  dragInit (): void {\n    // Adding listeners\n    const dragBehaviour = d3.drag()\n      .on('start', dragStarted.bind(this))\n      .on('drag', this.dragging.bind(this))\n      .on('end', this.dragEnded.bind(this));\n\n    const activeNc = d3.selectAll('.selected');\n    const selection = Array.from(document.getElementsByClassName('selected'));\n    this.selection = selection.concat(Array.from(document.getElementsByClassName('resizePoint')));\n\n    this.dragStartCoords = new Array(activeNc.size());\n\n    activeNc.call(dragBehaviour);\n\n    // Drag effects\n    function dragStarted (): void {\n      this.dragStartCoords = [d3.event.x, d3.event.y];\n      this.dx = 0;\n      this.dy = 0;\n      const target = d3.event.sourceEvent.target;\n      if (target.classList.contains('staff')) {\n        d3.select(this.selector).call(dragBehaviour);\n      }\n    }\n  }\n\n  dragging (): void {\n    const relativeY = d3.event.y - this.dragStartCoords[1];\n    const relativeX = d3.event.x - this.dragStartCoords[0];\n    this.dx = d3.event.x - this.dragStartCoords[0];\n    this.dy = d3.event.y - this.dragStartCoords[1];\n    this.selection.forEach((el) => {\n      d3.select(el).attr('transform', function () {\n        return 'translate(' + [relativeX, relativeY] + ')';\n      });\n    });\n    /*\n     * if we're dragging a syllable (or neume etc) then there won't be a syl selected\n     * then we don't want the bounding box (if it is displayed) to move when dragging the neumes\n     * it will be a child of the element in selection, so it will get moved in the above loop\n     * so we cancel that movement out here\n     */\n    if (this.selection.filter((element: HTMLElement) => element.classList.contains('syl')).length === 0) {\n      d3.selectAll('.syllable.selected').selectAll('.sylTextRect-display').attr('transform', function () {\n        return 'translate(' + [-1 * relativeX, -1 * relativeY] + ')';\n      });\n    }\n  }\n\n  dragEnded (): void {\n    const paramArray = [];\n    this.selection.filter((el: SVGElement) => !el.classList.contains('resizePoint')).forEach((el: SVGElement) => {\n      const id = (el.tagName === 'rect') ? el.closest('.syl').id : el.id;\n      const singleAction = { action: 'drag',\n        param: { elementId: id,\n          x: this.dx,\n          y: (this.dy) * -1 }\n      };\n      paramArray.push(singleAction);\n    });\n    const editorAction: EditorAction = {\n      'action': 'chain',\n      'param': paramArray\n    };\n\n    const xDiff = Math.abs(this.dx);\n    const yDiff = Math.abs(this.dy);\n\n    if (xDiff > 5 || yDiff > 5) {\n      this.neonView.edit(editorAction, this.neonView.view.getCurrentPageURI()).then(() => {\n        this.neonView.updateForCurrentPage();\n        this.endOptionsSelection();\n        this.reset();\n        this.dragInit();\n      });\n    } else {\n      this.reset();\n      this.dragInit();\n    }\n  }\n\n  /** Set the d3 action to use for [[reset]]. */\n  resetTo (reset: (selection: d3.Selection<d3.BaseType, {}, HTMLElement, any>, args: any[]) => void): void {\n    this.resetToAction = reset;\n  }\n\n  /** Reset to a previous d3 action for [[this.selector]]. */\n  reset (): void {\n    if (this.resetToAction !== undefined) {\n      d3.select(this.selector).call(this.resetToAction);\n    }\n  }\n\n  endOptionsSelection (): void {\n    try {\n      document.getElementById('moreEdit').innerHTML = '';\n      document.getElementById('moreEdit').classList.add('is-invisible');\n    } catch (e) {}\n  }\n}\n\nexport { DragHandler as default };\n","(function (factory) {\n    if (typeof exports === 'object') {\n        // Node/CommonJS\n        module.exports = factory();\n    } else if (typeof define === 'function' && define.amd) {\n        // AMD\n        define(factory);\n    } else {\n        // Browser globals (with support for web workers)\n        var glob;\n\n        try {\n            glob = window;\n        } catch (e) {\n            glob = self;\n        }\n\n        glob.SparkMD5 = factory();\n    }\n}(function (undefined) {\n\n    'use strict';\n\n    /*\n     * Fastest md5 implementation around (JKM md5).\n     * Credits: Joseph Myers\n     *\n     * @see http://www.myersdaily.org/joseph/javascript/md5-text.html\n     * @see http://jsperf.com/md5-shootout/7\n     */\n\n    /* this function is much faster,\n      so if possible we use it. Some IEs\n      are the only ones I know of that\n      need the idiotic second function,\n      generated by an if clause.  */\n    var add32 = function (a, b) {\n        return (a + b) & 0xFFFFFFFF;\n    },\n        hex_chr = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'a', 'b', 'c', 'd', 'e', 'f'];\n\n\n    function cmn(q, a, b, x, s, t) {\n        a = add32(add32(a, q), add32(x, t));\n        return add32((a << s) | (a >>> (32 - s)), b);\n    }\n\n    function md5cycle(x, k) {\n        var a = x[0],\n            b = x[1],\n            c = x[2],\n            d = x[3];\n\n        a += (b & c | ~b & d) + k[0] - 680876936 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[1] - 389564586 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[2] + 606105819 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[3] - 1044525330 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[4] - 176418897 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[5] + 1200080426 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[6] - 1473231341 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[7] - 45705983 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[8] + 1770035416 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[9] - 1958414417 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[10] - 42063 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[11] - 1990404162 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n        a += (b & c | ~b & d) + k[12] + 1804603682 | 0;\n        a  = (a << 7 | a >>> 25) + b | 0;\n        d += (a & b | ~a & c) + k[13] - 40341101 | 0;\n        d  = (d << 12 | d >>> 20) + a | 0;\n        c += (d & a | ~d & b) + k[14] - 1502002290 | 0;\n        c  = (c << 17 | c >>> 15) + d | 0;\n        b += (c & d | ~c & a) + k[15] + 1236535329 | 0;\n        b  = (b << 22 | b >>> 10) + c | 0;\n\n        a += (b & d | c & ~d) + k[1] - 165796510 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[6] - 1069501632 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[11] + 643717713 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[0] - 373897302 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[5] - 701558691 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[10] + 38016083 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[15] - 660478335 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[4] - 405537848 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[9] + 568446438 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[14] - 1019803690 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[3] - 187363961 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[8] + 1163531501 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n        a += (b & d | c & ~d) + k[13] - 1444681467 | 0;\n        a  = (a << 5 | a >>> 27) + b | 0;\n        d += (a & c | b & ~c) + k[2] - 51403784 | 0;\n        d  = (d << 9 | d >>> 23) + a | 0;\n        c += (d & b | a & ~b) + k[7] + 1735328473 | 0;\n        c  = (c << 14 | c >>> 18) + d | 0;\n        b += (c & a | d & ~a) + k[12] - 1926607734 | 0;\n        b  = (b << 20 | b >>> 12) + c | 0;\n\n        a += (b ^ c ^ d) + k[5] - 378558 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[8] - 2022574463 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[11] + 1839030562 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[14] - 35309556 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[1] - 1530992060 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[4] + 1272893353 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[7] - 155497632 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[10] - 1094730640 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[13] + 681279174 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[0] - 358537222 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[3] - 722521979 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[6] + 76029189 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n        a += (b ^ c ^ d) + k[9] - 640364487 | 0;\n        a  = (a << 4 | a >>> 28) + b | 0;\n        d += (a ^ b ^ c) + k[12] - 421815835 | 0;\n        d  = (d << 11 | d >>> 21) + a | 0;\n        c += (d ^ a ^ b) + k[15] + 530742520 | 0;\n        c  = (c << 16 | c >>> 16) + d | 0;\n        b += (c ^ d ^ a) + k[2] - 995338651 | 0;\n        b  = (b << 23 | b >>> 9) + c | 0;\n\n        a += (c ^ (b | ~d)) + k[0] - 198630844 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[7] + 1126891415 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[14] - 1416354905 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[5] - 57434055 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[12] + 1700485571 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[3] - 1894986606 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[10] - 1051523 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[1] - 2054922799 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[8] + 1873313359 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[15] - 30611744 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[6] - 1560198380 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[13] + 1309151649 | 0;\n        b  = (b << 21 |b >>> 11) + c | 0;\n        a += (c ^ (b | ~d)) + k[4] - 145523070 | 0;\n        a  = (a << 6 | a >>> 26) + b | 0;\n        d += (b ^ (a | ~c)) + k[11] - 1120210379 | 0;\n        d  = (d << 10 | d >>> 22) + a | 0;\n        c += (a ^ (d | ~b)) + k[2] + 718787259 | 0;\n        c  = (c << 15 | c >>> 17) + d | 0;\n        b += (d ^ (c | ~a)) + k[9] - 343485551 | 0;\n        b  = (b << 21 | b >>> 11) + c | 0;\n\n        x[0] = a + x[0] | 0;\n        x[1] = b + x[1] | 0;\n        x[2] = c + x[2] | 0;\n        x[3] = d + x[3] | 0;\n    }\n\n    function md5blk(s) {\n        var md5blks = [],\n            i; /* Andy King said do it this way. */\n\n        for (i = 0; i < 64; i += 4) {\n            md5blks[i >> 2] = s.charCodeAt(i) + (s.charCodeAt(i + 1) << 8) + (s.charCodeAt(i + 2) << 16) + (s.charCodeAt(i + 3) << 24);\n        }\n        return md5blks;\n    }\n\n    function md5blk_array(a) {\n        var md5blks = [],\n            i; /* Andy King said do it this way. */\n\n        for (i = 0; i < 64; i += 4) {\n            md5blks[i >> 2] = a[i] + (a[i + 1] << 8) + (a[i + 2] << 16) + (a[i + 3] << 24);\n        }\n        return md5blks;\n    }\n\n    function md51(s) {\n        var n = s.length,\n            state = [1732584193, -271733879, -1732584194, 271733878],\n            i,\n            length,\n            tail,\n            tmp,\n            lo,\n            hi;\n\n        for (i = 64; i <= n; i += 64) {\n            md5cycle(state, md5blk(s.substring(i - 64, i)));\n        }\n        s = s.substring(i - 64);\n        length = s.length;\n        tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= s.charCodeAt(i) << ((i % 4) << 3);\n        }\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(state, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Beware that the final length might not fit in 32 bits so we take care of that\n        tmp = n * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n\n        md5cycle(state, tail);\n        return state;\n    }\n\n    function md51_array(a) {\n        var n = a.length,\n            state = [1732584193, -271733879, -1732584194, 271733878],\n            i,\n            length,\n            tail,\n            tmp,\n            lo,\n            hi;\n\n        for (i = 64; i <= n; i += 64) {\n            md5cycle(state, md5blk_array(a.subarray(i - 64, i)));\n        }\n\n        // Not sure if it is a bug, however IE10 will always produce a sub array of length 1\n        // containing the last element of the parent array if the sub array specified starts\n        // beyond the length of the parent array - weird.\n        // https://connect.microsoft.com/IE/feedback/details/771452/typed-array-subarray-issue\n        a = (i - 64) < n ? a.subarray(i - 64) : new Uint8Array(0);\n\n        length = a.length;\n        tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= a[i] << ((i % 4) << 3);\n        }\n\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(state, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Beware that the final length might not fit in 32 bits so we take care of that\n        tmp = n * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n\n        md5cycle(state, tail);\n\n        return state;\n    }\n\n    function rhex(n) {\n        var s = '',\n            j;\n        for (j = 0; j < 4; j += 1) {\n            s += hex_chr[(n >> (j * 8 + 4)) & 0x0F] + hex_chr[(n >> (j * 8)) & 0x0F];\n        }\n        return s;\n    }\n\n    function hex(x) {\n        var i;\n        for (i = 0; i < x.length; i += 1) {\n            x[i] = rhex(x[i]);\n        }\n        return x.join('');\n    }\n\n    // In some cases the fast add32 function cannot be used..\n    if (hex(md51('hello')) !== '5d41402abc4b2a76b9719d911017c592') {\n        add32 = function (x, y) {\n            var lsw = (x & 0xFFFF) + (y & 0xFFFF),\n                msw = (x >> 16) + (y >> 16) + (lsw >> 16);\n            return (msw << 16) | (lsw & 0xFFFF);\n        };\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * ArrayBuffer slice polyfill.\n     *\n     * @see https://github.com/ttaubert/node-arraybuffer-slice\n     */\n\n    if (typeof ArrayBuffer !== 'undefined' && !ArrayBuffer.prototype.slice) {\n        (function () {\n            function clamp(val, length) {\n                val = (val | 0) || 0;\n\n                if (val < 0) {\n                    return Math.max(val + length, 0);\n                }\n\n                return Math.min(val, length);\n            }\n\n            ArrayBuffer.prototype.slice = function (from, to) {\n                var length = this.byteLength,\n                    begin = clamp(from, length),\n                    end = length,\n                    num,\n                    target,\n                    targetArray,\n                    sourceArray;\n\n                if (to !== undefined) {\n                    end = clamp(to, length);\n                }\n\n                if (begin > end) {\n                    return new ArrayBuffer(0);\n                }\n\n                num = end - begin;\n                target = new ArrayBuffer(num);\n                targetArray = new Uint8Array(target);\n\n                sourceArray = new Uint8Array(this, begin, num);\n                targetArray.set(sourceArray);\n\n                return target;\n            };\n        })();\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * Helpers.\n     */\n\n    function toUtf8(str) {\n        if (/[\\u0080-\\uFFFF]/.test(str)) {\n            str = unescape(encodeURIComponent(str));\n        }\n\n        return str;\n    }\n\n    function utf8Str2ArrayBuffer(str, returnUInt8Array) {\n        var length = str.length,\n           buff = new ArrayBuffer(length),\n           arr = new Uint8Array(buff),\n           i;\n\n        for (i = 0; i < length; i += 1) {\n            arr[i] = str.charCodeAt(i);\n        }\n\n        return returnUInt8Array ? arr : buff;\n    }\n\n    function arrayBuffer2Utf8Str(buff) {\n        return String.fromCharCode.apply(null, new Uint8Array(buff));\n    }\n\n    function concatenateArrayBuffers(first, second, returnUInt8Array) {\n        var result = new Uint8Array(first.byteLength + second.byteLength);\n\n        result.set(new Uint8Array(first));\n        result.set(new Uint8Array(second), first.byteLength);\n\n        return returnUInt8Array ? result : result.buffer;\n    }\n\n    function hexToBinaryString(hex) {\n        var bytes = [],\n            length = hex.length,\n            x;\n\n        for (x = 0; x < length - 1; x += 2) {\n            bytes.push(parseInt(hex.substr(x, 2), 16));\n        }\n\n        return String.fromCharCode.apply(String, bytes);\n    }\n\n    // ---------------------------------------------------\n\n    /**\n     * SparkMD5 OOP implementation.\n     *\n     * Use this class to perform an incremental md5, otherwise use the\n     * static methods instead.\n     */\n\n    function SparkMD5() {\n        // call reset to init the instance\n        this.reset();\n    }\n\n    /**\n     * Appends a string.\n     * A conversion will be applied if an utf8 string is detected.\n     *\n     * @param {String} str The string to be appended\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.append = function (str) {\n        // Converts the string to utf8 bytes if necessary\n        // Then append as binary\n        this.appendBinary(toUtf8(str));\n\n        return this;\n    };\n\n    /**\n     * Appends a binary string.\n     *\n     * @param {String} contents The binary string to be appended\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.appendBinary = function (contents) {\n        this._buff += contents;\n        this._length += contents.length;\n\n        var length = this._buff.length,\n            i;\n\n        for (i = 64; i <= length; i += 64) {\n            md5cycle(this._hash, md5blk(this._buff.substring(i - 64, i)));\n        }\n\n        this._buff = this._buff.substring(i - 64);\n\n        return this;\n    };\n\n    /**\n     * Finishes the incremental computation, reseting the internal state and\n     * returning the result.\n     *\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.prototype.end = function (raw) {\n        var buff = this._buff,\n            length = buff.length,\n            i,\n            tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            ret;\n\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= buff.charCodeAt(i) << ((i % 4) << 3);\n        }\n\n        this._finish(tail, length);\n        ret = hex(this._hash);\n\n        if (raw) {\n            ret = hexToBinaryString(ret);\n        }\n\n        this.reset();\n\n        return ret;\n    };\n\n    /**\n     * Resets the internal state of the computation.\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.reset = function () {\n        this._buff = '';\n        this._length = 0;\n        this._hash = [1732584193, -271733879, -1732584194, 271733878];\n\n        return this;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @return {Object} The state\n     */\n    SparkMD5.prototype.getState = function () {\n        return {\n            buff: this._buff,\n            length: this._length,\n            hash: this._hash\n        };\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @param {Object} state The state\n     *\n     * @return {SparkMD5} The instance itself\n     */\n    SparkMD5.prototype.setState = function (state) {\n        this._buff = state.buff;\n        this._length = state.length;\n        this._hash = state.hash;\n\n        return this;\n    };\n\n    /**\n     * Releases memory used by the incremental buffer and other additional\n     * resources. If you plan to use the instance again, use reset instead.\n     */\n    SparkMD5.prototype.destroy = function () {\n        delete this._hash;\n        delete this._buff;\n        delete this._length;\n    };\n\n    /**\n     * Finish the final calculation based on the tail.\n     *\n     * @param {Array}  tail   The tail (will be modified)\n     * @param {Number} length The length of the remaining buffer\n     */\n    SparkMD5.prototype._finish = function (tail, length) {\n        var i = length,\n            tmp,\n            lo,\n            hi;\n\n        tail[i >> 2] |= 0x80 << ((i % 4) << 3);\n        if (i > 55) {\n            md5cycle(this._hash, tail);\n            for (i = 0; i < 16; i += 1) {\n                tail[i] = 0;\n            }\n        }\n\n        // Do the final computation based on the tail and length\n        // Beware that the final length may not fit in 32 bits so we take care of that\n        tmp = this._length * 8;\n        tmp = tmp.toString(16).match(/(.*?)(.{0,8})$/);\n        lo = parseInt(tmp[2], 16);\n        hi = parseInt(tmp[1], 16) || 0;\n\n        tail[14] = lo;\n        tail[15] = hi;\n        md5cycle(this._hash, tail);\n    };\n\n    /**\n     * Performs the md5 hash on a string.\n     * A conversion will be applied if utf8 string is detected.\n     *\n     * @param {String}  str The string\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.hash = function (str, raw) {\n        // Converts the string to utf8 bytes if necessary\n        // Then compute it using the binary function\n        return SparkMD5.hashBinary(toUtf8(str), raw);\n    };\n\n    /**\n     * Performs the md5 hash on a binary string.\n     *\n     * @param {String}  content The binary string\n     * @param {Boolean} raw     True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.hashBinary = function (content, raw) {\n        var hash = md51(content),\n            ret = hex(hash);\n\n        return raw ? hexToBinaryString(ret) : ret;\n    };\n\n    // ---------------------------------------------------\n\n    /**\n     * SparkMD5 OOP implementation for array buffers.\n     *\n     * Use this class to perform an incremental md5 ONLY for array buffers.\n     */\n    SparkMD5.ArrayBuffer = function () {\n        // call reset to init the instance\n        this.reset();\n    };\n\n    /**\n     * Appends an array buffer.\n     *\n     * @param {ArrayBuffer} arr The array to be appended\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.append = function (arr) {\n        var buff = concatenateArrayBuffers(this._buff.buffer, arr, true),\n            length = buff.length,\n            i;\n\n        this._length += arr.byteLength;\n\n        for (i = 64; i <= length; i += 64) {\n            md5cycle(this._hash, md5blk_array(buff.subarray(i - 64, i)));\n        }\n\n        this._buff = (i - 64) < length ? new Uint8Array(buff.buffer.slice(i - 64)) : new Uint8Array(0);\n\n        return this;\n    };\n\n    /**\n     * Finishes the incremental computation, reseting the internal state and\n     * returning the result.\n     *\n     * @param {Boolean} raw True to get the raw string, false to get the hex string\n     *\n     * @return {String} The result\n     */\n    SparkMD5.ArrayBuffer.prototype.end = function (raw) {\n        var buff = this._buff,\n            length = buff.length,\n            tail = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],\n            i,\n            ret;\n\n        for (i = 0; i < length; i += 1) {\n            tail[i >> 2] |= buff[i] << ((i % 4) << 3);\n        }\n\n        this._finish(tail, length);\n        ret = hex(this._hash);\n\n        if (raw) {\n            ret = hexToBinaryString(ret);\n        }\n\n        this.reset();\n\n        return ret;\n    };\n\n    /**\n     * Resets the internal state of the computation.\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.reset = function () {\n        this._buff = new Uint8Array(0);\n        this._length = 0;\n        this._hash = [1732584193, -271733879, -1732584194, 271733878];\n\n        return this;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @return {Object} The state\n     */\n    SparkMD5.ArrayBuffer.prototype.getState = function () {\n        var state = SparkMD5.prototype.getState.call(this);\n\n        // Convert buffer to a string\n        state.buff = arrayBuffer2Utf8Str(state.buff);\n\n        return state;\n    };\n\n    /**\n     * Gets the internal state of the computation.\n     *\n     * @param {Object} state The state\n     *\n     * @return {SparkMD5.ArrayBuffer} The instance itself\n     */\n    SparkMD5.ArrayBuffer.prototype.setState = function (state) {\n        // Convert string to buffer\n        state.buff = utf8Str2ArrayBuffer(state.buff, true);\n\n        return SparkMD5.prototype.setState.call(this, state);\n    };\n\n    SparkMD5.ArrayBuffer.prototype.destroy = SparkMD5.prototype.destroy;\n\n    SparkMD5.ArrayBuffer.prototype._finish = SparkMD5.prototype._finish;\n\n    /**\n     * Performs the md5 hash on an array buffer.\n     *\n     * @param {ArrayBuffer} arr The array buffer\n     * @param {Boolean}     raw True to get the raw string, false to get the hex one\n     *\n     * @return {String} The result\n     */\n    SparkMD5.ArrayBuffer.hash = function (arr, raw) {\n        var hash = md51_array(new Uint8Array(arr)),\n            ret = hex(hash);\n\n        return raw ? hexToBinaryString(ret) : ret;\n    };\n\n    return SparkMD5;\n}));\n","function uint8ToUuid (data: Uint8Array): string {\n  if (data.length !== 16) {\n    return '';\n  }\n\n  function cb (previous: string, current: number): string {\n    return previous + current.toString(16).padStart(2, '0');\n  }\n\n  return data.slice(0, 4).reduce(cb, '') +\n    '-' + data.slice(4, 6).reduce(cb, '') +\n    '-' + data.slice(6, 8).reduce(cb, '') +\n    '-' + data.slice(8, 10).reduce(cb, '') +\n    '-' + data.slice(10).reduce(cb, '');\n}\n\nexport function uuidv4 (): string {\n  // Check for crypto API\n  if (window.crypto === undefined) {\n    return uint8ToUuid(new Uint8Array(16));\n  }\n\n  // Get 16 octets for UUID\n  const octets = new Uint8Array(16);\n  const modifiers = Uint8Array.from([\n    parseInt('01000000', 2),  // Version bits (4 => 0100)\n    parseInt('10000000', 2),  // Variant bits (10x)\n    parseInt('00001111', 2),  // Mask to zero higher bits, version\n    parseInt('00111111', 2)   // Mask to zero higher bits, variant\n  ]);\n  window.crypto.getRandomValues(octets);\n  // Set version bits and variant bits\n  octets[6] = (octets[6] & modifiers[2]) | modifiers[0];\n  octets[8] = (octets[8] & modifiers[3]) | modifiers[1];\n\n  return uint8ToUuid(octets);\n}\n","var g;\n\n// This works in non-strict mode\ng = (function() {\n\treturn this;\n})();\n\ntry {\n\t// This works if eval is allowed (see CSP)\n\tg = g || new Function(\"return this\")();\n} catch (e) {\n\t// This works if the window reference is available\n\tif (typeof window === \"object\") g = window;\n}\n\n// g can still be undefined, but nothing to do about it...\n// We return undefined, instead of nothing here, so it's\n// easier to handle this case. if(!global) { ...}\n\nmodule.exports = g;\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\nvar punycode = require('punycode');\nvar util = require('./util');\n\nexports.parse = urlParse;\nexports.resolve = urlResolve;\nexports.resolveObject = urlResolveObject;\nexports.format = urlFormat;\n\nexports.Url = Url;\n\nfunction Url() {\n  this.protocol = null;\n  this.slashes = null;\n  this.auth = null;\n  this.host = null;\n  this.port = null;\n  this.hostname = null;\n  this.hash = null;\n  this.search = null;\n  this.query = null;\n  this.pathname = null;\n  this.path = null;\n  this.href = null;\n}\n\n// Reference: RFC 3986, RFC 1808, RFC 2396\n\n// define these here so at least they only have to be\n// compiled once on the first module load.\nvar protocolPattern = /^([a-z0-9.+-]+:)/i,\n    portPattern = /:[0-9]*$/,\n\n    // Special case for a simple path URL\n    simplePathPattern = /^(\\/\\/?(?!\\/)[^\\?\\s]*)(\\?[^\\s]*)?$/,\n\n    // RFC 2396: characters reserved for delimiting URLs.\n    // We actually just auto-escape these.\n    delims = ['<', '>', '\"', '`', ' ', '\\r', '\\n', '\\t'],\n\n    // RFC 2396: characters not allowed for various reasons.\n    unwise = ['{', '}', '|', '\\\\', '^', '`'].concat(delims),\n\n    // Allowed by RFCs, but cause of XSS attacks.  Always escape these.\n    autoEscape = ['\\''].concat(unwise),\n    // Characters that are never ever allowed in a hostname.\n    // Note that any invalid chars are also handled, but these\n    // are the ones that are *expected* to be seen, so we fast-path\n    // them.\n    nonHostChars = ['%', '/', '?', ';', '#'].concat(autoEscape),\n    hostEndingChars = ['/', '?', '#'],\n    hostnameMaxLen = 255,\n    hostnamePartPattern = /^[+a-z0-9A-Z_-]{0,63}$/,\n    hostnamePartStart = /^([+a-z0-9A-Z_-]{0,63})(.*)$/,\n    // protocols that can allow \"unsafe\" and \"unwise\" chars.\n    unsafeProtocol = {\n      'javascript': true,\n      'javascript:': true\n    },\n    // protocols that never have a hostname.\n    hostlessProtocol = {\n      'javascript': true,\n      'javascript:': true\n    },\n    // protocols that always contain a // bit.\n    slashedProtocol = {\n      'http': true,\n      'https': true,\n      'ftp': true,\n      'gopher': true,\n      'file': true,\n      'http:': true,\n      'https:': true,\n      'ftp:': true,\n      'gopher:': true,\n      'file:': true\n    },\n    querystring = require('querystring');\n\nfunction urlParse(url, parseQueryString, slashesDenoteHost) {\n  if (url && util.isObject(url) && url instanceof Url) return url;\n\n  var u = new Url;\n  u.parse(url, parseQueryString, slashesDenoteHost);\n  return u;\n}\n\nUrl.prototype.parse = function(url, parseQueryString, slashesDenoteHost) {\n  if (!util.isString(url)) {\n    throw new TypeError(\"Parameter 'url' must be a string, not \" + typeof url);\n  }\n\n  // Copy chrome, IE, opera backslash-handling behavior.\n  // Back slashes before the query string get converted to forward slashes\n  // See: https://code.google.com/p/chromium/issues/detail?id=25916\n  var queryIndex = url.indexOf('?'),\n      splitter =\n          (queryIndex !== -1 && queryIndex < url.indexOf('#')) ? '?' : '#',\n      uSplit = url.split(splitter),\n      slashRegex = /\\\\/g;\n  uSplit[0] = uSplit[0].replace(slashRegex, '/');\n  url = uSplit.join(splitter);\n\n  var rest = url;\n\n  // trim before proceeding.\n  // This is to support parse stuff like \"  http://foo.com  \\n\"\n  rest = rest.trim();\n\n  if (!slashesDenoteHost && url.split('#').length === 1) {\n    // Try fast path regexp\n    var simplePath = simplePathPattern.exec(rest);\n    if (simplePath) {\n      this.path = rest;\n      this.href = rest;\n      this.pathname = simplePath[1];\n      if (simplePath[2]) {\n        this.search = simplePath[2];\n        if (parseQueryString) {\n          this.query = querystring.parse(this.search.substr(1));\n        } else {\n          this.query = this.search.substr(1);\n        }\n      } else if (parseQueryString) {\n        this.search = '';\n        this.query = {};\n      }\n      return this;\n    }\n  }\n\n  var proto = protocolPattern.exec(rest);\n  if (proto) {\n    proto = proto[0];\n    var lowerProto = proto.toLowerCase();\n    this.protocol = lowerProto;\n    rest = rest.substr(proto.length);\n  }\n\n  // figure out if it's got a host\n  // user@server is *always* interpreted as a hostname, and url\n  // resolution will treat //foo/bar as host=foo,path=bar because that's\n  // how the browser resolves relative URLs.\n  if (slashesDenoteHost || proto || rest.match(/^\\/\\/[^@\\/]+@[^@\\/]+/)) {\n    var slashes = rest.substr(0, 2) === '//';\n    if (slashes && !(proto && hostlessProtocol[proto])) {\n      rest = rest.substr(2);\n      this.slashes = true;\n    }\n  }\n\n  if (!hostlessProtocol[proto] &&\n      (slashes || (proto && !slashedProtocol[proto]))) {\n\n    // there's a hostname.\n    // the first instance of /, ?, ;, or # ends the host.\n    //\n    // If there is an @ in the hostname, then non-host chars *are* allowed\n    // to the left of the last @ sign, unless some host-ending character\n    // comes *before* the @-sign.\n    // URLs are obnoxious.\n    //\n    // ex:\n    // http://a@b@c/ => user:a@b host:c\n    // http://a@b?@c => user:a host:c path:/?@c\n\n    // v0.12 TODO(isaacs): This is not quite how Chrome does things.\n    // Review our test case against browsers more comprehensively.\n\n    // find the first instance of any hostEndingChars\n    var hostEnd = -1;\n    for (var i = 0; i < hostEndingChars.length; i++) {\n      var hec = rest.indexOf(hostEndingChars[i]);\n      if (hec !== -1 && (hostEnd === -1 || hec < hostEnd))\n        hostEnd = hec;\n    }\n\n    // at this point, either we have an explicit point where the\n    // auth portion cannot go past, or the last @ char is the decider.\n    var auth, atSign;\n    if (hostEnd === -1) {\n      // atSign can be anywhere.\n      atSign = rest.lastIndexOf('@');\n    } else {\n      // atSign must be in auth portion.\n      // http://a@b/c@d => host:b auth:a path:/c@d\n      atSign = rest.lastIndexOf('@', hostEnd);\n    }\n\n    // Now we have a portion which is definitely the auth.\n    // Pull that off.\n    if (atSign !== -1) {\n      auth = rest.slice(0, atSign);\n      rest = rest.slice(atSign + 1);\n      this.auth = decodeURIComponent(auth);\n    }\n\n    // the host is the remaining to the left of the first non-host char\n    hostEnd = -1;\n    for (var i = 0; i < nonHostChars.length; i++) {\n      var hec = rest.indexOf(nonHostChars[i]);\n      if (hec !== -1 && (hostEnd === -1 || hec < hostEnd))\n        hostEnd = hec;\n    }\n    // if we still have not hit it, then the entire thing is a host.\n    if (hostEnd === -1)\n      hostEnd = rest.length;\n\n    this.host = rest.slice(0, hostEnd);\n    rest = rest.slice(hostEnd);\n\n    // pull out port.\n    this.parseHost();\n\n    // we've indicated that there is a hostname,\n    // so even if it's empty, it has to be present.\n    this.hostname = this.hostname || '';\n\n    // if hostname begins with [ and ends with ]\n    // assume that it's an IPv6 address.\n    var ipv6Hostname = this.hostname[0] === '[' &&\n        this.hostname[this.hostname.length - 1] === ']';\n\n    // validate a little.\n    if (!ipv6Hostname) {\n      var hostparts = this.hostname.split(/\\./);\n      for (var i = 0, l = hostparts.length; i < l; i++) {\n        var part = hostparts[i];\n        if (!part) continue;\n        if (!part.match(hostnamePartPattern)) {\n          var newpart = '';\n          for (var j = 0, k = part.length; j < k; j++) {\n            if (part.charCodeAt(j) > 127) {\n              // we replace non-ASCII char with a temporary placeholder\n              // we need this to make sure size of hostname is not\n              // broken by replacing non-ASCII by nothing\n              newpart += 'x';\n            } else {\n              newpart += part[j];\n            }\n          }\n          // we test again with ASCII char only\n          if (!newpart.match(hostnamePartPattern)) {\n            var validParts = hostparts.slice(0, i);\n            var notHost = hostparts.slice(i + 1);\n            var bit = part.match(hostnamePartStart);\n            if (bit) {\n              validParts.push(bit[1]);\n              notHost.unshift(bit[2]);\n            }\n            if (notHost.length) {\n              rest = '/' + notHost.join('.') + rest;\n            }\n            this.hostname = validParts.join('.');\n            break;\n          }\n        }\n      }\n    }\n\n    if (this.hostname.length > hostnameMaxLen) {\n      this.hostname = '';\n    } else {\n      // hostnames are always lower case.\n      this.hostname = this.hostname.toLowerCase();\n    }\n\n    if (!ipv6Hostname) {\n      // IDNA Support: Returns a punycoded representation of \"domain\".\n      // It only converts parts of the domain name that\n      // have non-ASCII characters, i.e. it doesn't matter if\n      // you call it with a domain that already is ASCII-only.\n      this.hostname = punycode.toASCII(this.hostname);\n    }\n\n    var p = this.port ? ':' + this.port : '';\n    var h = this.hostname || '';\n    this.host = h + p;\n    this.href += this.host;\n\n    // strip [ and ] from the hostname\n    // the host field still retains them, though\n    if (ipv6Hostname) {\n      this.hostname = this.hostname.substr(1, this.hostname.length - 2);\n      if (rest[0] !== '/') {\n        rest = '/' + rest;\n      }\n    }\n  }\n\n  // now rest is set to the post-host stuff.\n  // chop off any delim chars.\n  if (!unsafeProtocol[lowerProto]) {\n\n    // First, make 100% sure that any \"autoEscape\" chars get\n    // escaped, even if encodeURIComponent doesn't think they\n    // need to be.\n    for (var i = 0, l = autoEscape.length; i < l; i++) {\n      var ae = autoEscape[i];\n      if (rest.indexOf(ae) === -1)\n        continue;\n      var esc = encodeURIComponent(ae);\n      if (esc === ae) {\n        esc = escape(ae);\n      }\n      rest = rest.split(ae).join(esc);\n    }\n  }\n\n\n  // chop off from the tail first.\n  var hash = rest.indexOf('#');\n  if (hash !== -1) {\n    // got a fragment string.\n    this.hash = rest.substr(hash);\n    rest = rest.slice(0, hash);\n  }\n  var qm = rest.indexOf('?');\n  if (qm !== -1) {\n    this.search = rest.substr(qm);\n    this.query = rest.substr(qm + 1);\n    if (parseQueryString) {\n      this.query = querystring.parse(this.query);\n    }\n    rest = rest.slice(0, qm);\n  } else if (parseQueryString) {\n    // no query string, but parseQueryString still requested\n    this.search = '';\n    this.query = {};\n  }\n  if (rest) this.pathname = rest;\n  if (slashedProtocol[lowerProto] &&\n      this.hostname && !this.pathname) {\n    this.pathname = '/';\n  }\n\n  //to support http.request\n  if (this.pathname || this.search) {\n    var p = this.pathname || '';\n    var s = this.search || '';\n    this.path = p + s;\n  }\n\n  // finally, reconstruct the href based on what has been validated.\n  this.href = this.format();\n  return this;\n};\n\n// format a parsed object into a url string\nfunction urlFormat(obj) {\n  // ensure it's an object, and not a string url.\n  // If it's an obj, this is a no-op.\n  // this way, you can call url_format() on strings\n  // to clean up potentially wonky urls.\n  if (util.isString(obj)) obj = urlParse(obj);\n  if (!(obj instanceof Url)) return Url.prototype.format.call(obj);\n  return obj.format();\n}\n\nUrl.prototype.format = function() {\n  var auth = this.auth || '';\n  if (auth) {\n    auth = encodeURIComponent(auth);\n    auth = auth.replace(/%3A/i, ':');\n    auth += '@';\n  }\n\n  var protocol = this.protocol || '',\n      pathname = this.pathname || '',\n      hash = this.hash || '',\n      host = false,\n      query = '';\n\n  if (this.host) {\n    host = auth + this.host;\n  } else if (this.hostname) {\n    host = auth + (this.hostname.indexOf(':') === -1 ?\n        this.hostname :\n        '[' + this.hostname + ']');\n    if (this.port) {\n      host += ':' + this.port;\n    }\n  }\n\n  if (this.query &&\n      util.isObject(this.query) &&\n      Object.keys(this.query).length) {\n    query = querystring.stringify(this.query);\n  }\n\n  var search = this.search || (query && ('?' + query)) || '';\n\n  if (protocol && protocol.substr(-1) !== ':') protocol += ':';\n\n  // only the slashedProtocols get the //.  Not mailto:, xmpp:, etc.\n  // unless they had them to begin with.\n  if (this.slashes ||\n      (!protocol || slashedProtocol[protocol]) && host !== false) {\n    host = '//' + (host || '');\n    if (pathname && pathname.charAt(0) !== '/') pathname = '/' + pathname;\n  } else if (!host) {\n    host = '';\n  }\n\n  if (hash && hash.charAt(0) !== '#') hash = '#' + hash;\n  if (search && search.charAt(0) !== '?') search = '?' + search;\n\n  pathname = pathname.replace(/[?#]/g, function(match) {\n    return encodeURIComponent(match);\n  });\n  search = search.replace('#', '%23');\n\n  return protocol + host + pathname + search + hash;\n};\n\nfunction urlResolve(source, relative) {\n  return urlParse(source, false, true).resolve(relative);\n}\n\nUrl.prototype.resolve = function(relative) {\n  return this.resolveObject(urlParse(relative, false, true)).format();\n};\n\nfunction urlResolveObject(source, relative) {\n  if (!source) return relative;\n  return urlParse(source, false, true).resolveObject(relative);\n}\n\nUrl.prototype.resolveObject = function(relative) {\n  if (util.isString(relative)) {\n    var rel = new Url();\n    rel.parse(relative, false, true);\n    relative = rel;\n  }\n\n  var result = new Url();\n  var tkeys = Object.keys(this);\n  for (var tk = 0; tk < tkeys.length; tk++) {\n    var tkey = tkeys[tk];\n    result[tkey] = this[tkey];\n  }\n\n  // hash is always overridden, no matter what.\n  // even href=\"\" will remove it.\n  result.hash = relative.hash;\n\n  // if the relative url is empty, then there's nothing left to do here.\n  if (relative.href === '') {\n    result.href = result.format();\n    return result;\n  }\n\n  // hrefs like //foo/bar always cut to the protocol.\n  if (relative.slashes && !relative.protocol) {\n    // take everything except the protocol from relative\n    var rkeys = Object.keys(relative);\n    for (var rk = 0; rk < rkeys.length; rk++) {\n      var rkey = rkeys[rk];\n      if (rkey !== 'protocol')\n        result[rkey] = relative[rkey];\n    }\n\n    //urlParse appends trailing / to urls like http://www.example.com\n    if (slashedProtocol[result.protocol] &&\n        result.hostname && !result.pathname) {\n      result.path = result.pathname = '/';\n    }\n\n    result.href = result.format();\n    return result;\n  }\n\n  if (relative.protocol && relative.protocol !== result.protocol) {\n    // if it's a known url protocol, then changing\n    // the protocol does weird things\n    // first, if it's not file:, then we MUST have a host,\n    // and if there was a path\n    // to begin with, then we MUST have a path.\n    // if it is file:, then the host is dropped,\n    // because that's known to be hostless.\n    // anything else is assumed to be absolute.\n    if (!slashedProtocol[relative.protocol]) {\n      var keys = Object.keys(relative);\n      for (var v = 0; v < keys.length; v++) {\n        var k = keys[v];\n        result[k] = relative[k];\n      }\n      result.href = result.format();\n      return result;\n    }\n\n    result.protocol = relative.protocol;\n    if (!relative.host && !hostlessProtocol[relative.protocol]) {\n      var relPath = (relative.pathname || '').split('/');\n      while (relPath.length && !(relative.host = relPath.shift()));\n      if (!relative.host) relative.host = '';\n      if (!relative.hostname) relative.hostname = '';\n      if (relPath[0] !== '') relPath.unshift('');\n      if (relPath.length < 2) relPath.unshift('');\n      result.pathname = relPath.join('/');\n    } else {\n      result.pathname = relative.pathname;\n    }\n    result.search = relative.search;\n    result.query = relative.query;\n    result.host = relative.host || '';\n    result.auth = relative.auth;\n    result.hostname = relative.hostname || relative.host;\n    result.port = relative.port;\n    // to support http.request\n    if (result.pathname || result.search) {\n      var p = result.pathname || '';\n      var s = result.search || '';\n      result.path = p + s;\n    }\n    result.slashes = result.slashes || relative.slashes;\n    result.href = result.format();\n    return result;\n  }\n\n  var isSourceAbs = (result.pathname && result.pathname.charAt(0) === '/'),\n      isRelAbs = (\n          relative.host ||\n          relative.pathname && relative.pathname.charAt(0) === '/'\n      ),\n      mustEndAbs = (isRelAbs || isSourceAbs ||\n                    (result.host && relative.pathname)),\n      removeAllDots = mustEndAbs,\n      srcPath = result.pathname && result.pathname.split('/') || [],\n      relPath = relative.pathname && relative.pathname.split('/') || [],\n      psychotic = result.protocol && !slashedProtocol[result.protocol];\n\n  // if the url is a non-slashed url, then relative\n  // links like ../.. should be able\n  // to crawl up to the hostname, as well.  This is strange.\n  // result.protocol has already been set by now.\n  // Later on, put the first path part into the host field.\n  if (psychotic) {\n    result.hostname = '';\n    result.port = null;\n    if (result.host) {\n      if (srcPath[0] === '') srcPath[0] = result.host;\n      else srcPath.unshift(result.host);\n    }\n    result.host = '';\n    if (relative.protocol) {\n      relative.hostname = null;\n      relative.port = null;\n      if (relative.host) {\n        if (relPath[0] === '') relPath[0] = relative.host;\n        else relPath.unshift(relative.host);\n      }\n      relative.host = null;\n    }\n    mustEndAbs = mustEndAbs && (relPath[0] === '' || srcPath[0] === '');\n  }\n\n  if (isRelAbs) {\n    // it's absolute.\n    result.host = (relative.host || relative.host === '') ?\n                  relative.host : result.host;\n    result.hostname = (relative.hostname || relative.hostname === '') ?\n                      relative.hostname : result.hostname;\n    result.search = relative.search;\n    result.query = relative.query;\n    srcPath = relPath;\n    // fall through to the dot-handling below.\n  } else if (relPath.length) {\n    // it's relative\n    // throw away the existing file, and take the new path instead.\n    if (!srcPath) srcPath = [];\n    srcPath.pop();\n    srcPath = srcPath.concat(relPath);\n    result.search = relative.search;\n    result.query = relative.query;\n  } else if (!util.isNullOrUndefined(relative.search)) {\n    // just pull out the search.\n    // like href='?foo'.\n    // Put this after the other two cases because it simplifies the booleans\n    if (psychotic) {\n      result.hostname = result.host = srcPath.shift();\n      //occationaly the auth can get stuck only in host\n      //this especially happens in cases like\n      //url.resolveObject('mailto:local1@domain1', 'local2@domain2')\n      var authInHost = result.host && result.host.indexOf('@') > 0 ?\n                       result.host.split('@') : false;\n      if (authInHost) {\n        result.auth = authInHost.shift();\n        result.host = result.hostname = authInHost.shift();\n      }\n    }\n    result.search = relative.search;\n    result.query = relative.query;\n    //to support http.request\n    if (!util.isNull(result.pathname) || !util.isNull(result.search)) {\n      result.path = (result.pathname ? result.pathname : '') +\n                    (result.search ? result.search : '');\n    }\n    result.href = result.format();\n    return result;\n  }\n\n  if (!srcPath.length) {\n    // no path at all.  easy.\n    // we've already handled the other stuff above.\n    result.pathname = null;\n    //to support http.request\n    if (result.search) {\n      result.path = '/' + result.search;\n    } else {\n      result.path = null;\n    }\n    result.href = result.format();\n    return result;\n  }\n\n  // if a url ENDs in . or .., then it must get a trailing slash.\n  // however, if it ends in anything else non-slashy,\n  // then it must NOT get a trailing slash.\n  var last = srcPath.slice(-1)[0];\n  var hasTrailingSlash = (\n      (result.host || relative.host || srcPath.length > 1) &&\n      (last === '.' || last === '..') || last === '');\n\n  // strip single dots, resolve double dots to parent dir\n  // if the path tries to go above the root, `up` ends up > 0\n  var up = 0;\n  for (var i = srcPath.length; i >= 0; i--) {\n    last = srcPath[i];\n    if (last === '.') {\n      srcPath.splice(i, 1);\n    } else if (last === '..') {\n      srcPath.splice(i, 1);\n      up++;\n    } else if (up) {\n      srcPath.splice(i, 1);\n      up--;\n    }\n  }\n\n  // if the path is allowed to go above the root, restore leading ..s\n  if (!mustEndAbs && !removeAllDots) {\n    for (; up--; up) {\n      srcPath.unshift('..');\n    }\n  }\n\n  if (mustEndAbs && srcPath[0] !== '' &&\n      (!srcPath[0] || srcPath[0].charAt(0) !== '/')) {\n    srcPath.unshift('');\n  }\n\n  if (hasTrailingSlash && (srcPath.join('/').substr(-1) !== '/')) {\n    srcPath.push('');\n  }\n\n  var isAbsolute = srcPath[0] === '' ||\n      (srcPath[0] && srcPath[0].charAt(0) === '/');\n\n  // put the host back\n  if (psychotic) {\n    result.hostname = result.host = isAbsolute ? '' :\n                                    srcPath.length ? srcPath.shift() : '';\n    //occationaly the auth can get stuck only in host\n    //this especially happens in cases like\n    //url.resolveObject('mailto:local1@domain1', 'local2@domain2')\n    var authInHost = result.host && result.host.indexOf('@') > 0 ?\n                     result.host.split('@') : false;\n    if (authInHost) {\n      result.auth = authInHost.shift();\n      result.host = result.hostname = authInHost.shift();\n    }\n  }\n\n  mustEndAbs = mustEndAbs || (result.host && srcPath.length);\n\n  if (mustEndAbs && !isAbsolute) {\n    srcPath.unshift('');\n  }\n\n  if (!srcPath.length) {\n    result.pathname = null;\n    result.path = null;\n  } else {\n    result.pathname = srcPath.join('/');\n  }\n\n  //to support request.http\n  if (!util.isNull(result.pathname) || !util.isNull(result.search)) {\n    result.path = (result.pathname ? result.pathname : '') +\n                  (result.search ? result.search : '');\n  }\n  result.auth = relative.auth || result.auth;\n  result.slashes = result.slashes || relative.slashes;\n  result.href = result.format();\n  return result;\n};\n\nUrl.prototype.parseHost = function() {\n  var host = this.host;\n  var port = portPattern.exec(host);\n  if (port) {\n    port = port[0];\n    if (port !== ':') {\n      this.port = port.substr(1);\n    }\n    host = host.substr(0, host.length - port.length);\n  }\n  if (host) this.hostname = host;\n};\n","\nvar urilib = require('url');\nvar helpers = require('./helpers');\n\nmodule.exports.SchemaScanResult = SchemaScanResult;\nfunction SchemaScanResult(found, ref){\n  this.id = found;\n  this.ref = ref;\n}\n\n/**\n * Adds a schema with a certain urn to the Validator instance.\n * @param string uri\n * @param object schema\n * @return {Object}\n */\nmodule.exports.scan = function scan(base, schema){\n  function scanSchema(baseuri, schema){\n    if(!schema || typeof schema!='object') return;\n    // Mark all referenced schemas so we can tell later which schemas are referred to, but never defined\n    if(schema.$ref){\n      var resolvedUri = urilib.resolve(baseuri, schema.$ref);\n      ref[resolvedUri] = ref[resolvedUri] ? ref[resolvedUri]+1 : 0;\n      return;\n    }\n    var ourBase = schema.id ? urilib.resolve(baseuri, schema.id) : baseuri;\n    if (ourBase) {\n      // If there's no fragment, append an empty one\n      if(ourBase.indexOf('#')<0) ourBase += '#';\n      if(found[ourBase]){\n        if(!helpers.deepCompareStrict(found[ourBase], schema)){\n          throw new Error('Schema <'+schema+'> already exists with different definition');\n        }\n        return found[ourBase];\n      }\n      found[ourBase] = schema;\n      // strip trailing fragment\n      if(ourBase[ourBase.length-1]=='#'){\n        found[ourBase.substring(0, ourBase.length-1)] = schema;\n      }\n    }\n    scanArray(ourBase+'/items', ((schema.items instanceof Array)?schema.items:[schema.items]));\n    scanArray(ourBase+'/extends', ((schema.extends instanceof Array)?schema.extends:[schema.extends]));\n    scanSchema(ourBase+'/additionalItems', schema.additionalItems);\n    scanObject(ourBase+'/properties', schema.properties);\n    scanSchema(ourBase+'/additionalProperties', schema.additionalProperties);\n    scanObject(ourBase+'/definitions', schema.definitions);\n    scanObject(ourBase+'/patternProperties', schema.patternProperties);\n    scanObject(ourBase+'/dependencies', schema.dependencies);\n    scanArray(ourBase+'/disallow', schema.disallow);\n    scanArray(ourBase+'/allOf', schema.allOf);\n    scanArray(ourBase+'/anyOf', schema.anyOf);\n    scanArray(ourBase+'/oneOf', schema.oneOf);\n    scanSchema(ourBase+'/not', schema.not);\n  }\n  function scanArray(baseuri, schemas){\n    if(!(schemas instanceof Array)) return;\n    for(var i=0; i<schemas.length; i++){\n      scanSchema(baseuri+'/'+i, schemas[i]);\n    }\n  }\n  function scanObject(baseuri, schemas){\n    if(!schemas || typeof schemas!='object') return;\n    for(var p in schemas){\n      scanSchema(baseuri+'/'+p, schemas[p]);\n    }\n  }\n\n  var found = {};\n  var ref = {};\n  var schemaUri = base;\n  scanSchema(base, schema);\n  return new SchemaScanResult(found, ref);\n}\n","/**\n * HTML for each insert tab (neume, grouping, clef, system, and division).\n */\nexport const insertTabHtml: Record<string, string> = {\n  primitiveTab: '<p class=\\'control\\'>' +\n        '<button id=\\'punctum\\' class=\\'button insertel smallel\\' title=\\'punctum\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/punctum.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'virga\\' class=\\'button insertel smallel\\' title=\\'virga\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/virga.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'diamond\\' class=\\'button insertel smallel\\' title=\\'inclinatum\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/diamond.png' + '\\' class=\\'image\\'/></button></p>' +\n  /*  \"<p class='control'>\" +\n        \"<button id='white_punct' class='button insertel smallel' title='white punctum'><img src='\" + White__ASSET_PREFIX__ + 'assets/img/punctum.png' + \"' class='image'/></button></p>\" +\n        \"<p class='control'>\" +\n        \"<button id='quilisma' class='button insertel smallel' title='quilisma'><img src='\" + __ASSET_PREFIX__ + 'assets/img/quilisma.png' + \"' class='image'/></button></p>\" + */\n        '<p class=\\'control\\'>' +\n        '<button id=\\'custos\\' class=\\'button insertel smallel\\' title=\\'custos\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/custos.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'cClef\\' class=\\'button insertel smallel\\' title=\\' C Clef\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/cClef.png' + '\\' class=\\'image\\' /></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'fClef\\' class=\\'button insertel smallel\\' title=\\'F Clef\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/fClef.png' + '\\' class=\\'image\\'/></button></p>',\n  groupingTab: '<p class=\\'control\\'>' +\n        '<button id=\\'pes\\' class=\\'button insertel smallel\\' title=\\'pes\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/pes.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'clivis\\' class=\\'button insertel smallel\\' title=\\'clivis\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/clivis.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'scandicus\\' class=\\'button insertel smallel\\' title=\\'scandicus\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/scandicus.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'climacus\\' class=\\'button insertel smallel\\' title=\\'climacus\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/climacus.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'torculus\\' class=\\'button insertel smallel\\' title=\\'toculus\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/torculus.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'porrectus\\' class=\\'button insertel smallel\\' title=\\'porrectus\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/porrectus.png' + '\\' class=\\'image\\'/></button></p>' +\n        '<p class=\\'control\\'>' +\n        '<button id=\\'pressus\\' class=\\'button insertel smallel\\' title=\\'pressus\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/pressus.png' + '\\' class=\\'image\\'/></button></p>',\n  systemTab: '<p class=\\'control\\'>' +\n        '<button id=\\'staff\\' class=\\'button insertel longel\\' title=\\'system\\'><img src=\\'' + __ASSET_PREFIX__ + 'assets/img/staff.png' + '\\' class=\\'image\\' /></button></p>' +\n        '<p>Click upper left and lower right corners of new staff.</p>'\n  // divisionTab: \"<p class='control'>\" +\n  //     \"<button id='smallDiv' class='button insertel tallel'><img src='\" + __ASSET_PREFIX__ + 'assets/img/smalldiv.png' + \"' class='image'/></button></p>\" +\n  //     \"<p class='control'>\" +\n  //     \"<button id='minorDiv' class='button insertel tallel'><img src='\" + __ASSET_PREFIX__ + 'assets/img/minordiv.png' +\"' class='image'/></button></p>\" +\n  //     \"<p class='control'>\" +\n  //     \"<button id='majorDiv' class='button insertel tallel'><img src='\" + __ASSET_PREFIX__ + 'assets/img/majordiv.png' + \"' class='image'/></button></p>\" +\n  //     \"<p class='control'>\" +\n  //     \"<button id='finalDiv' class='button insertel tallel'><img src='\" + __ASSET_PREFIX__ + 'assets/img/finaldiv.png' + \"' class='image'/></button></p>\"\n};\n\n/**\n * Structure of insert panel with basic grouping tabs.\n */\nexport const insertControlsPanel: string =\n    '<p class=\\'panel-heading\\' id=\\'insertMenu\\'>Insert' +\n    '<svg class=\\'icon is-pulled-right\\'><use id=\\'toggleInsert\\' xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use></svg></p>' +\n    '<div id=\\'insertContents\\' style=\\'overflow-y: hidden;\\'>' +\n    '<p class=\\'panel-tabs\\'>' +\n    '<a id=\\'primitiveTab\\' class=\\'insertTab\\'>Primitive Elements</a>' +\n    '<a id=\\'groupingTab\\' class=\\'insertTab\\'>Grouping</a>' +\n    '<a id=\\'systemTab\\' class=\\'insertTab\\'>System</a></p>' +\n    // \"<a id='divisionTab' class='insertTab'>Division</a></p>\" +\n    '<a class=\\'panel-block has-text-centered\\'>' +\n    '<div id=\\'insert_data\\' class=\\'field is-grouped buttons\\'></div></a></div>';\n\n/**\n * Contents of edit panel with buttons.\n */\nexport const editControlsPanel: string =\n    '<p class=\\'panel-heading\\' id=\\'editMenu\\'>Edit' +\n    '<svg class=\\'icon is-pulled-right\\'><use id=\\'toggleEdit\\' xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use></svg></p>' +\n    '<div id=\\'editContents\\'>' +\n    '<a class=\\'panel-block\\'>' +\n    '<label>Select By:&nbsp;</label>' +\n    '<div class=\\'field has-addons buttons\\' style=\\'overflow-x: auto;\\'>' +\n    '<p class=\\'control\\'>' +\n    '<button class=\\'button sel-by is-active\\' id=\\'selBySyl\\'>Syllable</button></p>' +\n    '<p class=\\'control\\'>' +\n    '<button class=\\'button sel-by\\' id=\\'selByNeume\\'>Neume</button></p>' +\n    '<p class=\\'control\\'>' +\n    '<button class=\\'button sel-by\\' id=\\'selByNc\\'>Neume Component</button></p>' +\n    '<p class=\\'control\\'>' +\n    '<button class=\\'button sel-by\\' id=\\'selByStaff\\'>Staff</button></p></div></a>' +\n    '<div class=\\'field is-grouped buttons\\'>' +\n    '<p class=\\'control\\'>' +\n    '<a id=\\'moreEdit\\' class=\\'panel-block is-invisible\\'>' +\n    '<a id=\\'extraEdit\\' class=\\'panel-block is-invisible\\'>' +\n    /*\n     * The extraEdit panel is added for edit options that have dropdown menus\n     * Like the Neume and Clef menus\n     * This is done because the moreEdit menu needs to have overflow for cases where it has lots of buttons\n     * But overflow ruins dropdown menus\n     */\n    '<a id=\\'neumeEdit\\' class=\\'panel-block is-invisible\\'></div>';\n\n/**\n * Contents of extra nc action menu.\n */\nexport const ncActionContents: string =\n        '<label>Change Head Shape:&nbsp;</label>' +\n        '<div id=\\'drop_select\\' class=\\'dropdown\\'>' +\n        '<div class=\\'dropdown-trigger\\'>' +\n        '<button id=\\'select-options\\' class=\\'button\\' aria-haspopup=\\'true\\' aria-controls=\\'dropdown-menu\\'>' +\n        '<span>Head Shapes</span>' +\n        '<svg class=\\'icon\\'><use xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use></svg></button></div>' +\n        '<div class=\\'dropdown-menu\\' id=\\'dropdown-menu\\' role=\\'menu\\'>' +\n        '<div class=\\'dropdown-content\\'>' +\n        '<a id=\\'Punctum\\' class=\\'dropdown-item\\'>Punctum</a>' +\n        '<a id=\\'Virga\\' class=\\'dropdown-item\\'>Virga</a>' +\n        '<a id=\\'Inclinatum\\' class=\\'dropdown-item\\'>Inclinatum</a></div></div></div>' +\n        '<p class=\\'control\\'></p></div>';\n\n/**\n * Contents of extra neume action menu.\n */\nexport const neumeActionContents: string =\n        '<label>Change Grouping:&nbsp;</label>' +\n        '<div id=\\'drop_select\\' class=\\'dropdown\\'>' +\n        '<div class=\\'dropdown-trigger\\'>' +\n        '<button id=\\'select-options\\' class=\\'button\\' aria-haspopup=\\'true\\' aria-controls=\\'dropdown-menu\\'>' +\n        '<span>Groupings</span>' +\n        '<svg class=\\'icon\\'><use xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use></svg></button></div>' +\n        '<div class=\\'dropdown-menu\\' id=\\'dropdown-menu\\' role=\\'menu\\'>' +\n        '<div class=\\'dropdown-content scrollable-dropdown\\'>' +\n        '<a id=\\'Pes\\' class=\\'dropdown-item grouping\\'>Pes</a>' +\n        '<a id=\\'Pes subpunctis\\' class=\\'dropdown-item grouping\\'>Pes Subpunctis</a>' +\n        '<a id=\\'Clivis\\' class=\\'dropdown-item grouping\\'>Clivis</a>' +\n        '<a id=\\'Scandicus\\' class=\\'dropdown-item grouping\\'>Scandicus</a>' +\n        '<a id=\\'Scandicus flexus\\' class=\\'dropdown-item grouping\\'>Scandicus Flexus</a>' +\n        '<a id=\\'Scandicus subpunctis\\' class=\\'dropdown-item grouping\\'>Scandicus Subpunctis</a>' +\n        '<a id=\\'Climacus\\' class=\\'dropdown-item grouping\\'>Climacus</a>' +\n        '<a id=\\'Climacus resupinus\\' class=\\'dropdown-item grouping\\'>Climacus Resupinus</a>' +\n        '<a id=\\'Torculus\\' class=\\'dropdown-item grouping\\'>Torculus</a>' +\n        '<a id=\\'Torculus resupinus\\' class=\\'dropdown-item grouping\\'>Torculus Resupinus</a>' +\n        '<a id=\\'Porrectus\\' class=\\'dropdown-item grouping\\'>Porrectus</a>' +\n        '<a id=\\'Porrectus flexus\\' class=\\'dropdown-item grouping\\'>Porrectus Flexus</a>' +\n        '<a id=\\'Porrectus subpunctis\\' class=\\'dropdown-item grouping\\'>Porrectus Subpunctis</a>' +\n        '<a id=\\'Pressus\\' class=\\'dropdown-item grouping\\'>Pressus</a>' +\n        '</div></div></div>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'ungroupNcs\\'>Ungroup</button></p></div>';\n\n/**\n * Contents of extra staff action menu.\n */\nexport const staffActionContents: string =\n    '<label>Merge Systems:&nbsp;</label>' +\n    '<div><p class=\\'control\\'>' +\n    '<button id=\\'merge-systems\\' class=\\'button\\'>Merge</button>' +\n    '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div>';\n\n/**\n * Contents of default action menu.\n */\nexport const defaultActionContents: string =\n    '<div><p class=\\'control\\'>' +\n    '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div>';\n\n/**\n * Contents of default action menu when selecting by syllable\n * Same as above except includes re-associate to nearest staff\n */\n export const defaultSylActionContents: string =\n    '<div><p class=\\'control\\'>' +\n    '<button class=\\'button\\' id=\\'delete\\'>Delete</button>' +\n    '<button class=\\'button\\' id=\\'changeStaff\\'>Re-associate to nearest staff</button></p></div>';\n    \n/**\n * Contents of custos action menu.\n */\nexport const custosActionContents: string =\n    '<div><p class=\\'control\\'>' +\n    '<button class=\\'button\\' id=\\'delete\\'>Delete</button>' +\n    '<button class=\\'button\\' id=\\'changeStaff\\'>Re-associate to nearest staff</button></p></div>';\n\n/**\n * Contents of split action menu.\n * @type {string}\n */\nexport const splitActionContents: string=\n    '<label>Split System:&nbsp;</label>' +\n    '<div><p class=\\'control\\'>' +\n    '<button id=\\'split-system\\' class=\\'button\\'>Split</button>' +\n    '<button id=\\'reset-rotate\\' class=\\'button\\'>Reset Rotate</button>' +\n    '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div>';\n\n/**\n * Contents of extra clef action menu.\n */\nexport const clefActionContents: string =\n    '<label>Change Clef Shape:&nbsp;</label>' +\n    '<div id=\\'drop_select\\' class=\\'dropdown\\'>' +\n    '<div class=\\'dropdown-trigger\\'overflow=\\'auto\\'>' +\n    '<button id=\\'select-options\\' class=\\'button\\' aria-haspopup=\\'true\\' aria-controls=\\'dropdown-menu\\'>' +\n    '<span>Clef Shapes</span>' +\n    '<svg class=\\'icon\\'><use xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use></svg></button></div>' +\n    '<div class=\\'dropdown-menu\\' id=\\'dropdown-menu\\' role=\\'menu\\'>' +\n    '<div class=\\'dropdown-content\\'>' +\n    '<a id=\\'CClef\\' class=\\'dropdown-item\\'>C Clef</a>' +\n    '<a id=\\'FClef\\' class=\\'dropdown-item\\'>F Clef</a></div></div></div></div>';\n\n/**\n * HTML for grouping selection menu.\n */\nexport const groupingMenu: object = {\n  'nc': '<div class=\\'field is-grouped\\'>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'groupNcs\\'>Group Neume Components</button>' +\n        '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div>',\n  'neume': '<div class=\\'field is-grouped\\'>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'groupNeumes\\'>Group Neumes</button>' +\n        '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div>',\n  'syl': '<div class=\\'field is-grouped\\'>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'mergeSyls\\'>Merge Syllables</button>' +\n        '<button class=\\'button\\' id=\\'delete\\'>Delete</button>' +\n        '<button class=\\'button\\' id=\\'changeStaff\\'>Re-associate to nearest staff</button></p></div>',\n  'ligatureNc': '<div class=\\'field is-grouped\\'>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'groupNcs\\'>Group Neume Components</button></p></div>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'toggle-ligature\\'>Toggle Ligature</button>' +\n        '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div></div>',\n  'ligature': '<div class=\\'field is-grouped\\'>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'toggle-ligature\\'>Toggle Ligature</button>' +\n        '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div></div>',\n  'splitSyllable': '<div class=\\'field is-grouped\\'>' +\n        '<div><p class=\\'control\\'>' +\n        '<button class=\\'button\\' id=\\'toggle-link\\'>Toggle Linked Syllables</button>' +\n        '<button class=\\'button\\' id=\\'delete\\'>Delete</button></p></div></div>'\n};\n","/** @module utils/Select */\n\nimport {\n  unselect, getStaffBBox, selectStaff, selectAll, getSelectionType\n} from './SelectTools';\nimport { resize } from './Resize';\nimport NeonView from '../NeonView';\nimport DragHandler from './DragHandler';\nimport { InfoInterface } from '../Interfaces';\nimport ZoomHandler from '../SingleView/Zoom';\n\nimport * as d3 from 'd3';\n\nlet dragHandler: DragHandler, neonView: NeonView, info: InfoInterface, zoomHandler: ZoomHandler;\nlet strokeWidth = 7;\n\nexport function setSelectStrokeWidth (width: number): void {\n  strokeWidth = width;\n}\n\n/**\n * Set the objects for this module.\n */\nexport function setSelectHelperObjects (nv: NeonView, dh: DragHandler): void {\n  dragHandler = dh;\n  neonView = nv;\n  info = neonView.info;\n  zoomHandler = neonView.view.zoomHandler;\n}\n\nfunction escapeKeyListener (evt: KeyboardEvent): void {\n  if (evt.key === 'Escape') {\n    if (document.getElementsByClassName('selected').length > 0) {\n      info.infoListeners();\n    }\n    unselect();\n  }\n}\n\nfunction isSelByBBox (): boolean {\n  const selByBBox = document.getElementById('selByBBox');\n  if (selByBBox) {\n    return selByBBox.classList.contains('is-active');\n  }\n  return false;\n}\n\nfunction stopPropHandler (evt): void { evt.stopPropagation(); }\n\n/**\n * Apply listeners for click selection.\n * @param selector - The CSS selector used to choose where listeners are applied.\n */\nexport function clickSelect (selector: string): void {\n  document.querySelectorAll(selector).forEach(sel => {\n    sel.removeEventListener('mousedown', clickHandler);\n    sel.addEventListener('mousedown', clickHandler);\n  });\n\n  // Click away listeners\n  document.body.removeEventListener('keydown', escapeKeyListener);\n  document.body.addEventListener('keydown', escapeKeyListener);\n\n  document.getElementById('container')\n    .addEventListener('contextmenu', (evt) => { evt.preventDefault(); });\n\n  document.querySelectorAll('use,rect,#moreEdit').forEach(sel => {\n    sel.removeEventListener('click', stopPropHandler);\n    sel.addEventListener('click', stopPropHandler);\n  });\n}\n\n/**\n * Handle click events related to element selection.\n */\nfunction clickHandler (evt: MouseEvent): void {\n  if (!neonView) return;\n  const mode = neonView.getUserMode();\n\n  // If in insert mode or panning is active from shift key\n  if (mode === 'insert' || evt.shiftKey) { return; }\n  // Check if the element being clicked on is part of a drag Selection\n  if (this.tagName === 'use' && getSelectionType() !== 'selByBBox') {\n    if (this.closest('.selected') === null) {\n      let selection = [this];\n      // Check if this is part of a ligature and, if so, add all of it to the selection.\n      const firstLigatureHalf = /E9B[45678]/;\n      const secondLigatureHalf = /E9B[9ABC]/;\n      if (this.getAttribute('xlink:href').match(secondLigatureHalf)) {\n        // This is the second part of a ligature\n        const nc = this.closest('.nc');\n        const neume = this.closest('.neume');\n        const ncIndex = Array.from(neume.children).indexOf(nc);\n        const firstUse = neume.children[ncIndex - 1].children[0];\n        console.assert(firstUse.getAttribute('xlink:href').match(firstLigatureHalf), 'First glyph of ligature unexpected!');\n        if (firstUse.closest('.selected') === null) {\n          selection.unshift(firstUse);\n        }\n      } else if (this.getAttribute('xlink:href').match(firstLigatureHalf)) {\n        // This is the first part of a ligature\n        const nc = this.closest('.nc');\n        const neume = this.closest('.neume');\n        const ncIndex = Array.from(neume.children).indexOf(nc);\n        const secondUse = neume.children[ncIndex + 1].children[0];\n        console.assert(secondUse.getAttribute('xlink:href').match(secondLigatureHalf), 'Second glyph of ligature unexpected!');\n        if (secondUse.closest('.selected') === null) {\n          selection.push(secondUse);\n        }\n      }\n      if (window.navigator.userAgent.match(/Mac/) ? evt.metaKey : evt.ctrlKey) {\n        selection = selection.concat(Array.from(document.getElementsByClassName('selected')));\n      }\n      selectAll(selection, neonView, dragHandler);\n      if (dragHandler) {\n        dragHandler.dragInit();\n      }\n    }\n    else {\n      let selection = [];\n      if (window.navigator.userAgent.match(/Mac/) ? evt.metaKey : evt.ctrlKey) {\n        // determine which selection mode we're in\n        const temp = document.querySelector('.sel-by.is-active').id;\n        let mode = '';\n        switch (temp) {\n          case 'selByStaff':\n            mode = '.staff';\n            break;\n          case 'selByNeume':\n            mode = '.neume';\n            break;\n          case 'selByNc':\n            mode = '.nc';\n            break;\n          default:\n            mode = '.syllable'\n            break;\n        }\n        let remove = [this.closest(mode)];\n        selection = Array.from(document.getElementsByClassName('selected'));\n        selection = selection.filter( (el) => {\n          return !remove.includes(el);\n        });\n        selectAll(selection, neonView, dragHandler);\n        if (dragHandler) {\n          dragHandler.dragInit();\n        }\n      }\n    }\n  } else if ((evt.target as HTMLElement).tagName === 'rect' && getSelectionType() === 'selByBBox') {\n    if (this.closest('.selected') === null) {\n      let selection = [evt.target] as SVGGElement[];\n      if (window.navigator.userAgent.match(/Mac/) ? evt.metaKey : evt.ctrlKey) {\n        selection = selection.concat(Array.from(document.getElementsByClassName('selected')) as SVGGElement[]);\n        selection = selection.map( (el) => {\n          if (el.tagName == 'rect') {\n            return el;\n          }\n          return el.querySelector('.sylTextRect-Display');\n        });\n      }\n      selectAll(selection, neonView, dragHandler);\n      if (dragHandler) {\n        dragHandler.dragInit();\n      }\n    } else {\n      let selection = [];\n      if (window.navigator.userAgent.match(/Mac/) ? evt.metaKey : evt.ctrlKey) {\n        let remove = [this];\n        selection = Array.from(document.getElementsByClassName('selected'));\n        selection = selection.map( (el) => {\n          if (el.tagName == 'rect') {\n            return el;\n          }\n          return el.querySelector('.sylTextRect-Display');\n        });\n        selection = selection.filter( (el) => {\n          return !remove.includes(el);\n        });\n        selectAll(selection, neonView, dragHandler);\n        if (dragHandler) {\n          dragHandler.dragInit();\n        }\n      }\n    }\n  } else {\n    // Check if the point being clicked on is a staff selection (if applicable)\n    if (getSelectionType() !== 'selByStaff') {\n      info.infoListeners();\n      return;\n    }\n\n    // Check if the point is in a staff.\n    const container = document.getElementsByClassName('active-page')[0].getElementsByClassName('definition-scale')[0] as SVGSVGElement;\n    let pt = container.createSVGPoint();\n    pt.x = evt.clientX;\n    pt.y = evt.clientY;\n    const transformMatrix = (container.getElementsByClassName('system')[0] as SVGGraphicsElement).getScreenCTM();\n    pt = pt.matrixTransform(transformMatrix.inverse());\n\n    const selectedStaves = Array.from(document.getElementsByClassName('staff'))\n      .filter((staff: SVGGElement) => {\n        const bbox = getStaffBBox(staff);\n        let ulx = bbox.ulx;\n        let uly = bbox.uly;\n        let lrx = bbox.lrx;\n        let lry = bbox.lry;\n        let rotate = bbox.rotate;\n\n        return (pt.x > ulx && pt.x < lrx) && \n          (pt.y > (uly + (pt.x - ulx) * Math.tan(rotate))) && \n          (pt.y < (lry - (lrx - pt.x) * Math.tan(rotate)));\n      });\n\n    unselect();\n    if (selectedStaves.length == 0) {\n      return;\n    }\n    \n    // Select a staff\n    const staff = selectedStaves[0] as SVGGElement;\n    let bbox = getStaffBBox(staff);\n    if (!staff.classList.contains('selected')) {\n      // Select previously unselected staff\n      selectStaff(staff, dragHandler);\n      resize(staff, neonView, dragHandler);\n      if (dragHandler) {\n        dragHandler.dragInit();\n      }\n    }\n    // Trigger mousedown event on the staff\n    staff.dispatchEvent(new MouseEvent('mousedown', {\n      screenX: evt.screenX,\n      screenY: evt.screenY,\n      clientX: evt.clientX,\n      clientY: evt.clientY,\n      ctrlKey: evt.ctrlKey,\n      shiftKey: evt.shiftKey,\n      altKey: evt.altKey,\n      metaKey: evt.metaKey,\n      view: evt.view\n    }));\n  }\n}\n\n/**\n * Apply listeners for drag selection.\n * @param selector - The CSS selector used to choose where listeners are applied.\n */\nexport function dragSelect (selector: string): void {\n  let initialX = 0;\n  let initialY = 0;\n  let panning = false;\n  let dragSelecting = false;\n  // var canvas = d3.select('#svg_group');\n  d3.selectAll(selector.replace('.active-page', '').trim())\n    .on('.drag', null);\n  const canvas = d3.select(selector);\n  const dragSelectAction = d3.drag()\n    .on('start', selStart)\n    .on('drag', selecting)\n    .on('end', selEnd);\n  canvas.call(dragSelectAction);\n  if (dragHandler) {\n    dragHandler.resetTo(dragSelectAction);\n  }\n\n  function selStart (): void {\n    if (!neonView) return;\n    const userMode = neonView.getUserMode();\n    if (d3.event.sourceEvent.target.nodeName !== 'use' && userMode !== 'insert' && d3.event.sourceEvent.target.nodeName !== 'rect') {\n      if (!d3.event.sourceEvent.shiftKey) { // If not holding down shift key to pan\n        if (!document.getElementById('selByStaff').classList.contains('is-active') ||\n          pointNotInStaff(d3.mouse(this))) {\n          unselect();\n          dragSelecting = true;\n          const initialP = d3.mouse(this);\n          initialX = initialP[0];\n          initialY = initialP[1];\n          initRect(initialX, initialY);\n        }\n      } else {\n        panning = true;\n        if (zoomHandler !== undefined) {\n          zoomHandler.startDrag();\n        }\n      }\n    } else if (d3.event.sourceEvent.shiftKey) {\n      panning = true;\n      if (zoomHandler !== undefined) {\n        zoomHandler.startDrag();\n      }\n    }\n  }\n\n  /**\n   * Check if a point is in the bounds of a staff element.\n   * Rotate is not taken into account.\n   */\n  function pointNotInStaff (pt: number[]): boolean {\n    const staves = Array.from(document.getElementsByClassName('staff'));\n    const filtered = staves.filter((staff: SVGGElement) => {\n      const bbox = getStaffBBox(staff);\n        let ulx = bbox.ulx;\n        let uly = bbox.uly;\n        let lrx = bbox.lrx;\n        let lry = bbox.lry;\n        let rotate = bbox.rotate;\n\n        return (pt[0] > ulx && pt[0] < lrx) && \n          (pt[1] > (uly + (pt[0] - ulx) * Math.tan(rotate))) && \n          (pt[1] < (lry - (lrx - pt[0]) * Math.tan(rotate)));\n    });\n    return (filtered.length === 0);\n  }\n\n  function selecting (): void {\n    if (!panning && dragSelecting) {\n      const currentPt = d3.mouse(this);\n      const curX = currentPt[0];\n      const curY = currentPt[1];\n\n      const newX = curX < initialX ? curX : initialX;\n      const newY = curY < initialY ? curY : initialY;\n      const width = curX < initialX ? initialX - curX : curX - initialX;\n      const height = curY < initialY ? initialY - curY : curY - initialY;\n\n      updateRect(newX, newY, width, height);\n    } else if (panning) {\n      if (zoomHandler !== undefined) {\n        zoomHandler.dragging();\n      }\n    }\n  }\n\n  function selEnd (): void {\n    if (!panning && dragSelecting) {\n      const rx = parseInt(document.getElementById('selectRect').getAttribute('x'));\n      const ry = parseInt(document.getElementById('selectRect').getAttribute('y'));\n      const lx = parseInt(document.getElementById('selectRect').getAttribute('x')) +\n        parseInt(document.getElementById('selectRect').getAttribute('width'));\n      const ly = parseInt(document.getElementById('selectRect').getAttribute('y')) +\n        parseInt(document.getElementById('selectRect').getAttribute('height'));\n      // Transform to the correct coordinate system\n      const node = canvas.node() as SVGSVGElement;\n      let ul = node.createSVGPoint();\n      ul.x = rx;\n      ul.y = ry;\n      let lr = node.createSVGPoint();\n      lr.x = lx;\n      lr.y = ly;\n      const transform = node.getScreenCTM().inverse()\n        .multiply((canvas.select('.system').node() as SVGGraphicsElement)\n          .getScreenCTM()).inverse();\n      ul = ul.matrixTransform(transform);\n      lr = lr.matrixTransform(transform);\n\n      let nc;\n      if (document.getElementById('selByStaff').classList.contains('is-active')) {\n        nc = document.querySelectorAll(selector + ' use, ' + selector + ' .staff');\n      } else if (isSelByBBox()) {\n        nc = document.querySelectorAll(selector + ' .sylTextRect-display');\n      } else {\n        nc = document.querySelectorAll(selector + ' use');\n      }\n      const els = Array.from(nc);\n\n      const elements = els.filter(function (d: SVGGraphicsElement): boolean {\n        let ulx, uly, lrx, lry;\n        if (isSelByBBox()) {\n          ulx = Number(d.getAttribute('x'));\n          uly = Number(d.getAttribute('y'));\n          lrx = +ulx + +(d.getAttribute('width').slice(0, -2));\n          lry = +uly + +(d.getAttribute('height').slice(0, -2));\n          return !(((ul.x < ulx && lr.x < ulx) || (ul.x > lrx && lr.x > lrx)) || ((ul.y < uly && lr.y < uly) || (ul.y > lry && lr.y > lry)));\n        } else if (d.tagName === 'use') {\n          const box = (d.parentNode as SVGGElement).getBBox();\n          ulx = box.x;\n          uly = box.y;\n          lrx = box.x + box.width;\n          lry = box.y + box.height;\n          return !(((ul.x < ulx && lr.x < ulx) || (ul.x > lrx && lr.x > lrx)) || ((ul.y < uly && lr.y < uly) || (ul.y > lry && lr.y > lry)));\n        } else {\n          const box = getStaffBBox(d);\n          return !((ul.x < box.ulx && lr.x < box.ulx) || \n                  (ul.x > box.lrx && lr.x > box.lrx) || \n                  (ul.y < (box.uly + Math.abs(box.ulx - ul.x) * Math.tan(box.rotate)) && \n                    lr.y < (box.uly + Math.abs(box.ulx - ul.x) * Math.tan(box.rotate))) || \n                  (ul.y > (box.lry + Math.abs(box.lry - lr.y) * Math.tan(box.rotate)) && \n                    lr.y > (box.lry + Math.abs(box.lry - lr.y) * Math.tan(box.rotate))));\n        }\n      }) as SVGGraphicsElement[];\n\n      // Get other halves of ligatures if only one is selected\n      elements.forEach((element: SVGElement) => {\n        if (element.tagName === 'use' && element.getAttribute('xlink:href').match(/E9B[456789ABC]/)) {\n          const neume = element.closest('.neume');\n          const ncIndex = Array.from(neume.children).indexOf(element.closest('.nc'));\n          if (element.getAttribute('xlink:href').match(/E9B[45678]/)) {\n            // Add second half of ligature to selected list if not already present\n            const secondNc = neume.children[ncIndex + 1];\n            const secondUse = secondNc.querySelector('use');\n            if (elements.indexOf(secondUse) < 0) {\n              elements.push(secondUse);\n            }\n          } else {\n            // Add first half of ligature to selected list if not already present\n            const firstNc = neume.children[ncIndex - 1];\n            const firstUse = firstNc.querySelector('use');\n            if (elements.indexOf(firstUse) < 0) {\n              elements.push(firstUse);\n            }\n          }\n        }\n      });\n      selectAll(elements, neonView, dragHandler);\n\n      if (dragHandler) {\n        dragHandler.dragInit();\n      }\n      d3.selectAll('#selectRect').remove();\n      dragSelecting = false;\n    }\n    panning = false;\n  }\n\n  /**\n     * Create an initial dragging rectangle.\n     * @param ulx - The upper left x-position of the new rectangle.\n     * @param uly - The upper left y-position of the new rectangle.\n     */\n  function initRect (ulx: number, uly: number): void {\n    canvas.append('rect')\n      .attr('x', ulx)\n      .attr('y', uly)\n      .attr('width', 0)\n      .attr('height', 0)\n      .attr('id', 'selectRect')\n      .attr('stroke', 'black')\n      .attr('stroke-width', strokeWidth)\n      .attr('fill', 'none');\n  }\n\n  /**\n     * Update the dragging rectangle.\n     * @param newX - The new ulx.\n     * @param newY - The new uly.\n     * @param currentWidth - The width of the rectangle in pixels.\n     * @param currentHeight - The height of the rectangle in pixels.\n     */\n  function updateRect (newX: number, newY: number, currentWidth: number, currentHeight: number): void {\n    d3.select('#selectRect')\n      .attr('x', newX)\n      .attr('y', newY)\n      .attr('width', currentWidth)\n      .attr('height', currentHeight);\n  }\n}\n","import immediate from 'immediate';\nimport uuidV4 from 'uuid';\nimport Md5 from 'spark-md5';\nimport vuvuzela from 'vuvuzela';\nimport getArguments from 'argsarray';\nimport inherits from 'inherits';\nimport { EventEmitter } from 'events';\n\nfunction mangle(key) {\n  return '$' + key;\n}\nfunction unmangle(key) {\n  return key.substring(1);\n}\nfunction Map$1() {\n  this._store = {};\n}\nMap$1.prototype.get = function (key) {\n  var mangled = mangle(key);\n  return this._store[mangled];\n};\nMap$1.prototype.set = function (key, value) {\n  var mangled = mangle(key);\n  this._store[mangled] = value;\n  return true;\n};\nMap$1.prototype.has = function (key) {\n  var mangled = mangle(key);\n  return mangled in this._store;\n};\nMap$1.prototype.delete = function (key) {\n  var mangled = mangle(key);\n  var res = mangled in this._store;\n  delete this._store[mangled];\n  return res;\n};\nMap$1.prototype.forEach = function (cb) {\n  var keys = Object.keys(this._store);\n  for (var i = 0, len = keys.length; i < len; i++) {\n    var key = keys[i];\n    var value = this._store[key];\n    key = unmangle(key);\n    cb(value, key);\n  }\n};\nObject.defineProperty(Map$1.prototype, 'size', {\n  get: function () {\n    return Object.keys(this._store).length;\n  }\n});\n\nfunction Set$1(array) {\n  this._store = new Map$1();\n\n  // init with an array\n  if (array && Array.isArray(array)) {\n    for (var i = 0, len = array.length; i < len; i++) {\n      this.add(array[i]);\n    }\n  }\n}\nSet$1.prototype.add = function (key) {\n  return this._store.set(key, true);\n};\nSet$1.prototype.has = function (key) {\n  return this._store.has(key);\n};\nSet$1.prototype.forEach = function (cb) {\n  this._store.forEach(function (value, key) {\n    cb(key);\n  });\n};\nObject.defineProperty(Set$1.prototype, 'size', {\n  get: function () {\n    return this._store.size;\n  }\n});\n\n/* global Map,Set,Symbol */\n// Based on https://kangax.github.io/compat-table/es6/ we can sniff out\n// incomplete Map/Set implementations which would otherwise cause our tests to fail.\n// Notably they fail in IE11 and iOS 8.4, which this prevents.\nfunction supportsMapAndSet() {\n  if (typeof Symbol === 'undefined' || typeof Map === 'undefined' || typeof Set === 'undefined') {\n    return false;\n  }\n  var prop = Object.getOwnPropertyDescriptor(Map, Symbol.species);\n  return prop && 'get' in prop && Map[Symbol.species] === Map;\n}\n\n// based on https://github.com/montagejs/collections\n\nvar ExportedSet;\nvar ExportedMap;\n\n{\n  if (supportsMapAndSet()) { // prefer built-in Map/Set\n    ExportedSet = Set;\n    ExportedMap = Map;\n  } else { // fall back to our polyfill\n    ExportedSet = Set$1;\n    ExportedMap = Map$1;\n  }\n}\n\nfunction isBinaryObject(object) {\n  return (typeof ArrayBuffer !== 'undefined' && object instanceof ArrayBuffer) ||\n    (typeof Blob !== 'undefined' && object instanceof Blob);\n}\n\nfunction cloneArrayBuffer(buff) {\n  if (typeof buff.slice === 'function') {\n    return buff.slice(0);\n  }\n  // IE10-11 slice() polyfill\n  var target = new ArrayBuffer(buff.byteLength);\n  var targetArray = new Uint8Array(target);\n  var sourceArray = new Uint8Array(buff);\n  targetArray.set(sourceArray);\n  return target;\n}\n\nfunction cloneBinaryObject(object) {\n  if (object instanceof ArrayBuffer) {\n    return cloneArrayBuffer(object);\n  }\n  var size = object.size;\n  var type = object.type;\n  // Blob\n  if (typeof object.slice === 'function') {\n    return object.slice(0, size, type);\n  }\n  // PhantomJS slice() replacement\n  return object.webkitSlice(0, size, type);\n}\n\n// most of this is borrowed from lodash.isPlainObject:\n// https://github.com/fis-components/lodash.isplainobject/\n// blob/29c358140a74f252aeb08c9eb28bef86f2217d4a/index.js\n\nvar funcToString = Function.prototype.toString;\nvar objectCtorString = funcToString.call(Object);\n\nfunction isPlainObject(value) {\n  var proto = Object.getPrototypeOf(value);\n  /* istanbul ignore if */\n  if (proto === null) { // not sure when this happens, but I guess it can\n    return true;\n  }\n  var Ctor = proto.constructor;\n  return (typeof Ctor == 'function' &&\n    Ctor instanceof Ctor && funcToString.call(Ctor) == objectCtorString);\n}\n\nfunction clone(object) {\n  var newObject;\n  var i;\n  var len;\n\n  if (!object || typeof object !== 'object') {\n    return object;\n  }\n\n  if (Array.isArray(object)) {\n    newObject = [];\n    for (i = 0, len = object.length; i < len; i++) {\n      newObject[i] = clone(object[i]);\n    }\n    return newObject;\n  }\n\n  // special case: to avoid inconsistencies between IndexedDB\n  // and other backends, we automatically stringify Dates\n  if (object instanceof Date) {\n    return object.toISOString();\n  }\n\n  if (isBinaryObject(object)) {\n    return cloneBinaryObject(object);\n  }\n\n  if (!isPlainObject(object)) {\n    return object; // don't clone objects like Workers\n  }\n\n  newObject = {};\n  for (i in object) {\n    /* istanbul ignore else */\n    if (Object.prototype.hasOwnProperty.call(object, i)) {\n      var value = clone(object[i]);\n      if (typeof value !== 'undefined') {\n        newObject[i] = value;\n      }\n    }\n  }\n  return newObject;\n}\n\nfunction once(fun) {\n  var called = false;\n  return getArguments(function (args) {\n    /* istanbul ignore if */\n    if (called) {\n      // this is a smoke test and should never actually happen\n      throw new Error('once called more than once');\n    } else {\n      called = true;\n      fun.apply(this, args);\n    }\n  });\n}\n\nfunction toPromise(func) {\n  //create the function we will be returning\n  return getArguments(function (args) {\n    // Clone arguments\n    args = clone(args);\n    var self = this;\n    // if the last argument is a function, assume its a callback\n    var usedCB = (typeof args[args.length - 1] === 'function') ? args.pop() : false;\n    var promise = new Promise(function (fulfill, reject) {\n      var resp;\n      try {\n        var callback = once(function (err, mesg) {\n          if (err) {\n            reject(err);\n          } else {\n            fulfill(mesg);\n          }\n        });\n        // create a callback for this invocation\n        // apply the function in the orig context\n        args.push(callback);\n        resp = func.apply(self, args);\n        if (resp && typeof resp.then === 'function') {\n          fulfill(resp);\n        }\n      } catch (e) {\n        reject(e);\n      }\n    });\n    // if there is a callback, call it back\n    if (usedCB) {\n      promise.then(function (result) {\n        usedCB(null, result);\n      }, usedCB);\n    }\n    return promise;\n  });\n}\n\nfunction logApiCall(self, name, args) {\n  /* istanbul ignore if */\n  if (self.constructor.listeners('debug').length) {\n    var logArgs = ['api', self.name, name];\n    for (var i = 0; i < args.length - 1; i++) {\n      logArgs.push(args[i]);\n    }\n    self.constructor.emit('debug', logArgs);\n\n    // override the callback itself to log the response\n    var origCallback = args[args.length - 1];\n    args[args.length - 1] = function (err, res) {\n      var responseArgs = ['api', self.name, name];\n      responseArgs = responseArgs.concat(\n        err ? ['error', err] : ['success', res]\n      );\n      self.constructor.emit('debug', responseArgs);\n      origCallback(err, res);\n    };\n  }\n}\n\nfunction adapterFun(name, callback) {\n  return toPromise(getArguments(function (args) {\n    if (this._closed) {\n      return Promise.reject(new Error('database is closed'));\n    }\n    if (this._destroyed) {\n      return Promise.reject(new Error('database is destroyed'));\n    }\n    var self = this;\n    logApiCall(self, name, args);\n    if (!this.taskqueue.isReady) {\n      return new Promise(function (fulfill, reject) {\n        self.taskqueue.addTask(function (failed) {\n          if (failed) {\n            reject(failed);\n          } else {\n            fulfill(self[name].apply(self, args));\n          }\n        });\n      });\n    }\n    return callback.apply(this, args);\n  }));\n}\n\n// like underscore/lodash _.pick()\nfunction pick(obj, arr) {\n  var res = {};\n  for (var i = 0, len = arr.length; i < len; i++) {\n    var prop = arr[i];\n    if (prop in obj) {\n      res[prop] = obj[prop];\n    }\n  }\n  return res;\n}\n\n// Most browsers throttle concurrent requests at 6, so it's silly\n// to shim _bulk_get by trying to launch potentially hundreds of requests\n// and then letting the majority time out. We can handle this ourselves.\nvar MAX_NUM_CONCURRENT_REQUESTS = 6;\n\nfunction identityFunction(x) {\n  return x;\n}\n\nfunction formatResultForOpenRevsGet(result) {\n  return [{\n    ok: result\n  }];\n}\n\n// shim for P/CouchDB adapters that don't directly implement _bulk_get\nfunction bulkGet(db, opts, callback) {\n  var requests = opts.docs;\n\n  // consolidate into one request per doc if possible\n  var requestsById = new ExportedMap();\n  requests.forEach(function (request) {\n    if (requestsById.has(request.id)) {\n      requestsById.get(request.id).push(request);\n    } else {\n      requestsById.set(request.id, [request]);\n    }\n  });\n\n  var numDocs = requestsById.size;\n  var numDone = 0;\n  var perDocResults = new Array(numDocs);\n\n  function collapseResultsAndFinish() {\n    var results = [];\n    perDocResults.forEach(function (res) {\n      res.docs.forEach(function (info) {\n        results.push({\n          id: res.id,\n          docs: [info]\n        });\n      });\n    });\n    callback(null, {results: results});\n  }\n\n  function checkDone() {\n    if (++numDone === numDocs) {\n      collapseResultsAndFinish();\n    }\n  }\n\n  function gotResult(docIndex, id, docs) {\n    perDocResults[docIndex] = {id: id, docs: docs};\n    checkDone();\n  }\n\n  var allRequests = [];\n  requestsById.forEach(function (value, key) {\n    allRequests.push(key);\n  });\n\n  var i = 0;\n\n  function nextBatch() {\n\n    if (i >= allRequests.length) {\n      return;\n    }\n\n    var upTo = Math.min(i + MAX_NUM_CONCURRENT_REQUESTS, allRequests.length);\n    var batch = allRequests.slice(i, upTo);\n    processBatch(batch, i);\n    i += batch.length;\n  }\n\n  function processBatch(batch, offset) {\n    batch.forEach(function (docId, j) {\n      var docIdx = offset + j;\n      var docRequests = requestsById.get(docId);\n\n      // just use the first request as the \"template\"\n      // TODO: The _bulk_get API allows for more subtle use cases than this,\n      // but for now it is unlikely that there will be a mix of different\n      // \"atts_since\" or \"attachments\" in the same request, since it's just\n      // replicate.js that is using this for the moment.\n      // Also, atts_since is aspirational, since we don't support it yet.\n      var docOpts = pick(docRequests[0], ['atts_since', 'attachments']);\n      docOpts.open_revs = docRequests.map(function (request) {\n        // rev is optional, open_revs disallowed\n        return request.rev;\n      });\n\n      // remove falsey / undefined revisions\n      docOpts.open_revs = docOpts.open_revs.filter(identityFunction);\n\n      var formatResult = identityFunction;\n\n      if (docOpts.open_revs.length === 0) {\n        delete docOpts.open_revs;\n\n        // when fetching only the \"winning\" leaf,\n        // transform the result so it looks like an open_revs\n        // request\n        formatResult = formatResultForOpenRevsGet;\n      }\n\n      // globally-supplied options\n      ['revs', 'attachments', 'binary', 'ajax', 'latest'].forEach(function (param) {\n        if (param in opts) {\n          docOpts[param] = opts[param];\n        }\n      });\n      db.get(docId, docOpts, function (err, res) {\n        var result;\n        /* istanbul ignore if */\n        if (err) {\n          result = [{error: err}];\n        } else {\n          result = formatResult(res);\n        }\n        gotResult(docIdx, docId, result);\n        nextBatch();\n      });\n    });\n  }\n\n  nextBatch();\n\n}\n\nvar hasLocal;\n\ntry {\n  localStorage.setItem('_pouch_check_localstorage', 1);\n  hasLocal = !!localStorage.getItem('_pouch_check_localstorage');\n} catch (e) {\n  hasLocal = false;\n}\n\nfunction hasLocalStorage() {\n  return hasLocal;\n}\n\n// Custom nextTick() shim for browsers. In node, this will just be process.nextTick(). We\n\ninherits(Changes, EventEmitter);\n\n/* istanbul ignore next */\nfunction attachBrowserEvents(self) {\n  if (hasLocalStorage()) {\n    addEventListener(\"storage\", function (e) {\n      self.emit(e.key);\n    });\n  }\n}\n\nfunction Changes() {\n  EventEmitter.call(this);\n  this._listeners = {};\n\n  attachBrowserEvents(this);\n}\nChanges.prototype.addListener = function (dbName, id, db, opts) {\n  /* istanbul ignore if */\n  if (this._listeners[id]) {\n    return;\n  }\n  var self = this;\n  var inprogress = false;\n  function eventFunction() {\n    /* istanbul ignore if */\n    if (!self._listeners[id]) {\n      return;\n    }\n    if (inprogress) {\n      inprogress = 'waiting';\n      return;\n    }\n    inprogress = true;\n    var changesOpts = pick(opts, [\n      'style', 'include_docs', 'attachments', 'conflicts', 'filter',\n      'doc_ids', 'view', 'since', 'query_params', 'binary', 'return_docs'\n    ]);\n\n    /* istanbul ignore next */\n    function onError() {\n      inprogress = false;\n    }\n\n    db.changes(changesOpts).on('change', function (c) {\n      if (c.seq > opts.since && !opts.cancelled) {\n        opts.since = c.seq;\n        opts.onChange(c);\n      }\n    }).on('complete', function () {\n      if (inprogress === 'waiting') {\n        immediate(eventFunction);\n      }\n      inprogress = false;\n    }).on('error', onError);\n  }\n  this._listeners[id] = eventFunction;\n  this.on(dbName, eventFunction);\n};\n\nChanges.prototype.removeListener = function (dbName, id) {\n  /* istanbul ignore if */\n  if (!(id in this._listeners)) {\n    return;\n  }\n  EventEmitter.prototype.removeListener.call(this, dbName,\n    this._listeners[id]);\n  delete this._listeners[id];\n};\n\n\n/* istanbul ignore next */\nChanges.prototype.notifyLocalWindows = function (dbName) {\n  //do a useless change on a storage thing\n  //in order to get other windows's listeners to activate\n  if (hasLocalStorage()) {\n    localStorage[dbName] = (localStorage[dbName] === \"a\") ? \"b\" : \"a\";\n  }\n};\n\nChanges.prototype.notify = function (dbName) {\n  this.emit(dbName);\n  this.notifyLocalWindows(dbName);\n};\n\nfunction guardedConsole(method) {\n  /* istanbul ignore else */\n  if (typeof console !== 'undefined' && typeof console[method] === 'function') {\n    var args = Array.prototype.slice.call(arguments, 1);\n    console[method].apply(console, args);\n  }\n}\n\nfunction randomNumber(min, max) {\n  var maxTimeout = 600000; // Hard-coded default of 10 minutes\n  min = parseInt(min, 10) || 0;\n  max = parseInt(max, 10);\n  if (max !== max || max <= min) {\n    max = (min || 1) << 1; //doubling\n  } else {\n    max = max + 1;\n  }\n  // In order to not exceed maxTimeout, pick a random value between half of maxTimeout and maxTimeout\n  if (max > maxTimeout) {\n    min = maxTimeout >> 1; // divide by two\n    max = maxTimeout;\n  }\n  var ratio = Math.random();\n  var range = max - min;\n\n  return ~~(range * ratio + min); // ~~ coerces to an int, but fast.\n}\n\nfunction defaultBackOff(min) {\n  var max = 0;\n  if (!min) {\n    max = 2000;\n  }\n  return randomNumber(min, max);\n}\n\n// designed to give info to browser users, who are disturbed\n// when they see http errors in the console\nfunction explainError(status, str) {\n  guardedConsole('info', 'The above ' + status + ' is totally normal. ' + str);\n}\n\nvar assign;\n{\n  if (typeof Object.assign === 'function') {\n    assign = Object.assign;\n  } else {\n    // lite Object.assign polyfill based on\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object/assign\n    assign = function (target) {\n      var to = Object(target);\n\n      for (var index = 1; index < arguments.length; index++) {\n        var nextSource = arguments[index];\n\n        if (nextSource != null) { // Skip over if undefined or null\n          for (var nextKey in nextSource) {\n            // Avoid bugs when hasOwnProperty is shadowed\n            if (Object.prototype.hasOwnProperty.call(nextSource, nextKey)) {\n              to[nextKey] = nextSource[nextKey];\n            }\n          }\n        }\n      }\n      return to;\n    };\n  }\n}\n\nvar $inject_Object_assign = assign;\n\ninherits(PouchError, Error);\n\nfunction PouchError(status, error, reason) {\n  Error.call(this, reason);\n  this.status = status;\n  this.name = error;\n  this.message = reason;\n  this.error = true;\n}\n\nPouchError.prototype.toString = function () {\n  return JSON.stringify({\n    status: this.status,\n    name: this.name,\n    message: this.message,\n    reason: this.reason\n  });\n};\n\nvar UNAUTHORIZED = new PouchError(401, 'unauthorized', \"Name or password is incorrect.\");\nvar MISSING_BULK_DOCS = new PouchError(400, 'bad_request', \"Missing JSON list of 'docs'\");\nvar MISSING_DOC = new PouchError(404, 'not_found', 'missing');\nvar REV_CONFLICT = new PouchError(409, 'conflict', 'Document update conflict');\nvar INVALID_ID = new PouchError(400, 'bad_request', '_id field must contain a string');\nvar MISSING_ID = new PouchError(412, 'missing_id', '_id is required for puts');\nvar RESERVED_ID = new PouchError(400, 'bad_request', 'Only reserved document ids may start with underscore.');\nvar NOT_OPEN = new PouchError(412, 'precondition_failed', 'Database not open');\nvar UNKNOWN_ERROR = new PouchError(500, 'unknown_error', 'Database encountered an unknown error');\nvar BAD_ARG = new PouchError(500, 'badarg', 'Some query argument is invalid');\nvar INVALID_REQUEST = new PouchError(400, 'invalid_request', 'Request was invalid');\nvar QUERY_PARSE_ERROR = new PouchError(400, 'query_parse_error', 'Some query parameter is invalid');\nvar DOC_VALIDATION = new PouchError(500, 'doc_validation', 'Bad special document member');\nvar BAD_REQUEST = new PouchError(400, 'bad_request', 'Something wrong with the request');\nvar NOT_AN_OBJECT = new PouchError(400, 'bad_request', 'Document must be a JSON object');\nvar DB_MISSING = new PouchError(404, 'not_found', 'Database not found');\nvar IDB_ERROR = new PouchError(500, 'indexed_db_went_bad', 'unknown');\nvar WSQ_ERROR = new PouchError(500, 'web_sql_went_bad', 'unknown');\nvar LDB_ERROR = new PouchError(500, 'levelDB_went_went_bad', 'unknown');\nvar FORBIDDEN = new PouchError(403, 'forbidden', 'Forbidden by design doc validate_doc_update function');\nvar INVALID_REV = new PouchError(400, 'bad_request', 'Invalid rev format');\nvar FILE_EXISTS = new PouchError(412, 'file_exists', 'The database could not be created, the file already exists.');\nvar MISSING_STUB = new PouchError(412, 'missing_stub', 'A pre-existing attachment stub wasn\\'t found');\nvar INVALID_URL = new PouchError(413, 'invalid_url', 'Provided URL is invalid');\n\nfunction createError(error, reason) {\n  function CustomPouchError(reason) {\n    // inherit error properties from our parent error manually\n    // so as to allow proper JSON parsing.\n    /* jshint ignore:start */\n    for (var p in error) {\n      if (typeof error[p] !== 'function') {\n        this[p] = error[p];\n      }\n    }\n    /* jshint ignore:end */\n    if (reason !== undefined) {\n      this.reason = reason;\n    }\n  }\n  CustomPouchError.prototype = PouchError.prototype;\n  return new CustomPouchError(reason);\n}\n\nfunction generateErrorFromResponse(err) {\n\n  if (typeof err !== 'object') {\n    var data = err;\n    err = UNKNOWN_ERROR;\n    err.data = data;\n  }\n\n  if ('error' in err && err.error === 'conflict') {\n    err.name = 'conflict';\n    err.status = 409;\n  }\n\n  if (!('name' in err)) {\n    err.name = err.error || 'unknown';\n  }\n\n  if (!('status' in err)) {\n    err.status = 500;\n  }\n\n  if (!('message' in err)) {\n    err.message = err.message || err.reason;\n  }\n\n  return err;\n}\n\nfunction tryFilter(filter, doc, req) {\n  try {\n    return !filter(doc, req);\n  } catch (err) {\n    var msg = 'Filter function threw: ' + err.toString();\n    return createError(BAD_REQUEST, msg);\n  }\n}\n\nfunction filterChange(opts) {\n  var req = {};\n  var hasFilter = opts.filter && typeof opts.filter === 'function';\n  req.query = opts.query_params;\n\n  return function filter(change) {\n    if (!change.doc) {\n      // CSG sends events on the changes feed that don't have documents,\n      // this hack makes a whole lot of existing code robust.\n      change.doc = {};\n    }\n\n    var filterReturn = hasFilter && tryFilter(opts.filter, change.doc, req);\n\n    if (typeof filterReturn === 'object') {\n      return filterReturn;\n    }\n\n    if (filterReturn) {\n      return false;\n    }\n\n    if (!opts.include_docs) {\n      delete change.doc;\n    } else if (!opts.attachments) {\n      for (var att in change.doc._attachments) {\n        /* istanbul ignore else */\n        if (change.doc._attachments.hasOwnProperty(att)) {\n          change.doc._attachments[att].stub = true;\n        }\n      }\n    }\n    return true;\n  };\n}\n\nfunction flatten(arrs) {\n  var res = [];\n  for (var i = 0, len = arrs.length; i < len; i++) {\n    res = res.concat(arrs[i]);\n  }\n  return res;\n}\n\n// shim for Function.prototype.name,\n\n// Determine id an ID is valid\n//   - invalid IDs begin with an underescore that does not begin '_design' or\n//     '_local'\n//   - any other string value is a valid id\n// Returns the specific error object for each case\nfunction invalidIdError(id) {\n  var err;\n  if (!id) {\n    err = createError(MISSING_ID);\n  } else if (typeof id !== 'string') {\n    err = createError(INVALID_ID);\n  } else if (/^_/.test(id) && !(/^_(design|local)/).test(id)) {\n    err = createError(RESERVED_ID);\n  }\n  if (err) {\n    throw err;\n  }\n}\n\n// Checks if a PouchDB object is \"remote\" or not. This is\n\nfunction isRemote(db) {\n  if (typeof db._remote === 'boolean') {\n    return db._remote;\n  }\n  /* istanbul ignore next */\n  if (typeof db.type === 'function') {\n    guardedConsole('warn',\n      'db.type() is deprecated and will be removed in ' +\n      'a future version of PouchDB');\n    return db.type() === 'http';\n  }\n  /* istanbul ignore next */\n  return false;\n}\n\nfunction listenerCount(ee, type) {\n  return 'listenerCount' in ee ? ee.listenerCount(type) :\n                                 EventEmitter.listenerCount(ee, type);\n}\n\nfunction parseDesignDocFunctionName(s) {\n  if (!s) {\n    return null;\n  }\n  var parts = s.split('/');\n  if (parts.length === 2) {\n    return parts;\n  }\n  if (parts.length === 1) {\n    return [s, s];\n  }\n  return null;\n}\n\nfunction normalizeDesignDocFunctionName(s) {\n  var normalized = parseDesignDocFunctionName(s);\n  return normalized ? normalized.join('/') : null;\n}\n\n// originally parseUri 1.2.2, now patched by us\n// (c) Steven Levithan <stevenlevithan.com>\n// MIT License\nvar keys = [\"source\", \"protocol\", \"authority\", \"userInfo\", \"user\", \"password\",\n    \"host\", \"port\", \"relative\", \"path\", \"directory\", \"file\", \"query\", \"anchor\"];\nvar qName =\"queryKey\";\nvar qParser = /(?:^|&)([^&=]*)=?([^&]*)/g;\n\n// use the \"loose\" parser\n/* eslint maxlen: 0, no-useless-escape: 0 */\nvar parser = /^(?:(?![^:@]+:[^:@\\/]*@)([^:\\/?#.]+):)?(?:\\/\\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\\/?#]*)(?::(\\d*))?)(((\\/(?:[^?#](?![^?#\\/]*\\.[^?#\\/.]+(?:[?#]|$)))*\\/?)?([^?#\\/]*))(?:\\?([^#]*))?(?:#(.*))?)/;\n\nfunction parseUri(str) {\n  var m = parser.exec(str);\n  var uri = {};\n  var i = 14;\n\n  while (i--) {\n    var key = keys[i];\n    var value = m[i] || \"\";\n    var encoded = ['user', 'password'].indexOf(key) !== -1;\n    uri[key] = encoded ? decodeURIComponent(value) : value;\n  }\n\n  uri[qName] = {};\n  uri[keys[12]].replace(qParser, function ($0, $1, $2) {\n    if ($1) {\n      uri[qName][$1] = $2;\n    }\n  });\n\n  return uri;\n}\n\n// Based on https://github.com/alexdavid/scope-eval v0.0.3\n// (source: https://unpkg.com/scope-eval@0.0.3/scope_eval.js)\n// This is basically just a wrapper around new Function()\n\nfunction scopeEval(source, scope) {\n  var keys = [];\n  var values = [];\n  for (var key in scope) {\n    if (scope.hasOwnProperty(key)) {\n      keys.push(key);\n      values.push(scope[key]);\n    }\n  }\n  keys.push(source);\n  return Function.apply(null, keys).apply(null, values);\n}\n\n// this is essentially the \"update sugar\" function from daleharvey/pouchdb#1388\n// the diffFun tells us what delta to apply to the doc.  it either returns\n// the doc, or false if it doesn't need to do an update after all\nfunction upsert(db, docId, diffFun) {\n  return new Promise(function (fulfill, reject) {\n    db.get(docId, function (err, doc) {\n      if (err) {\n        /* istanbul ignore next */\n        if (err.status !== 404) {\n          return reject(err);\n        }\n        doc = {};\n      }\n\n      // the user might change the _rev, so save it for posterity\n      var docRev = doc._rev;\n      var newDoc = diffFun(doc);\n\n      if (!newDoc) {\n        // if the diffFun returns falsy, we short-circuit as\n        // an optimization\n        return fulfill({updated: false, rev: docRev});\n      }\n\n      // users aren't allowed to modify these values,\n      // so reset them here\n      newDoc._id = docId;\n      newDoc._rev = docRev;\n      fulfill(tryAndPut(db, newDoc, diffFun));\n    });\n  });\n}\n\nfunction tryAndPut(db, doc, diffFun) {\n  return db.put(doc).then(function (res) {\n    return {\n      updated: true,\n      rev: res.rev\n    };\n  }, function (err) {\n    /* istanbul ignore next */\n    if (err.status !== 409) {\n      throw err;\n    }\n    return upsert(db, doc._id, diffFun);\n  });\n}\n\nvar thisAtob = function (str) {\n  return atob(str);\n};\n\nvar thisBtoa = function (str) {\n  return btoa(str);\n};\n\n// Abstracts constructing a Blob object, so it also works in older\n// browsers that don't support the native Blob constructor (e.g.\n// old QtWebKit versions, Android < 4.4).\nfunction createBlob(parts, properties) {\n  /* global BlobBuilder,MSBlobBuilder,MozBlobBuilder,WebKitBlobBuilder */\n  parts = parts || [];\n  properties = properties || {};\n  try {\n    return new Blob(parts, properties);\n  } catch (e) {\n    if (e.name !== \"TypeError\") {\n      throw e;\n    }\n    var Builder = typeof BlobBuilder !== 'undefined' ? BlobBuilder :\n                  typeof MSBlobBuilder !== 'undefined' ? MSBlobBuilder :\n                  typeof MozBlobBuilder !== 'undefined' ? MozBlobBuilder :\n                  WebKitBlobBuilder;\n    var builder = new Builder();\n    for (var i = 0; i < parts.length; i += 1) {\n      builder.append(parts[i]);\n    }\n    return builder.getBlob(properties.type);\n  }\n}\n\n// From http://stackoverflow.com/questions/14967647/ (continues on next line)\n// encode-decode-image-with-base64-breaks-image (2013-04-21)\nfunction binaryStringToArrayBuffer(bin) {\n  var length = bin.length;\n  var buf = new ArrayBuffer(length);\n  var arr = new Uint8Array(buf);\n  for (var i = 0; i < length; i++) {\n    arr[i] = bin.charCodeAt(i);\n  }\n  return buf;\n}\n\nfunction binStringToBluffer(binString, type) {\n  return createBlob([binaryStringToArrayBuffer(binString)], {type: type});\n}\n\nfunction b64ToBluffer(b64, type) {\n  return binStringToBluffer(thisAtob(b64), type);\n}\n\n//Can't find original post, but this is close\n//http://stackoverflow.com/questions/6965107/ (continues on next line)\n//converting-between-strings-and-arraybuffers\nfunction arrayBufferToBinaryString(buffer) {\n  var binary = '';\n  var bytes = new Uint8Array(buffer);\n  var length = bytes.byteLength;\n  for (var i = 0; i < length; i++) {\n    binary += String.fromCharCode(bytes[i]);\n  }\n  return binary;\n}\n\n// shim for browsers that don't support it\nfunction readAsBinaryString(blob, callback) {\n  var reader = new FileReader();\n  var hasBinaryString = typeof reader.readAsBinaryString === 'function';\n  reader.onloadend = function (e) {\n    var result = e.target.result || '';\n    if (hasBinaryString) {\n      return callback(result);\n    }\n    callback(arrayBufferToBinaryString(result));\n  };\n  if (hasBinaryString) {\n    reader.readAsBinaryString(blob);\n  } else {\n    reader.readAsArrayBuffer(blob);\n  }\n}\n\nfunction blobToBinaryString(blobOrBuffer, callback) {\n  readAsBinaryString(blobOrBuffer, function (bin) {\n    callback(bin);\n  });\n}\n\nfunction blobToBase64(blobOrBuffer, callback) {\n  blobToBinaryString(blobOrBuffer, function (base64) {\n    callback(thisBtoa(base64));\n  });\n}\n\n// simplified API. universal browser support is assumed\nfunction readAsArrayBuffer(blob, callback) {\n  var reader = new FileReader();\n  reader.onloadend = function (e) {\n    var result = e.target.result || new ArrayBuffer(0);\n    callback(result);\n  };\n  reader.readAsArrayBuffer(blob);\n}\n\n// this is not used in the browser\n\nvar setImmediateShim = global.setImmediate || global.setTimeout;\nvar MD5_CHUNK_SIZE = 32768;\n\nfunction rawToBase64(raw) {\n  return thisBtoa(raw);\n}\n\nfunction sliceBlob(blob, start, end) {\n  if (blob.webkitSlice) {\n    return blob.webkitSlice(start, end);\n  }\n  return blob.slice(start, end);\n}\n\nfunction appendBlob(buffer, blob, start, end, callback) {\n  if (start > 0 || end < blob.size) {\n    // only slice blob if we really need to\n    blob = sliceBlob(blob, start, end);\n  }\n  readAsArrayBuffer(blob, function (arrayBuffer) {\n    buffer.append(arrayBuffer);\n    callback();\n  });\n}\n\nfunction appendString(buffer, string, start, end, callback) {\n  if (start > 0 || end < string.length) {\n    // only create a substring if we really need to\n    string = string.substring(start, end);\n  }\n  buffer.appendBinary(string);\n  callback();\n}\n\nfunction binaryMd5(data, callback) {\n  var inputIsString = typeof data === 'string';\n  var len = inputIsString ? data.length : data.size;\n  var chunkSize = Math.min(MD5_CHUNK_SIZE, len);\n  var chunks = Math.ceil(len / chunkSize);\n  var currentChunk = 0;\n  var buffer = inputIsString ? new Md5() : new Md5.ArrayBuffer();\n\n  var append = inputIsString ? appendString : appendBlob;\n\n  function next() {\n    setImmediateShim(loadNextChunk);\n  }\n\n  function done() {\n    var raw = buffer.end(true);\n    var base64 = rawToBase64(raw);\n    callback(base64);\n    buffer.destroy();\n  }\n\n  function loadNextChunk() {\n    var start = currentChunk * chunkSize;\n    var end = start + chunkSize;\n    currentChunk++;\n    if (currentChunk < chunks) {\n      append(buffer, data, start, end, next);\n    } else {\n      append(buffer, data, start, end, done);\n    }\n  }\n  loadNextChunk();\n}\n\nfunction stringMd5(string) {\n  return Md5.hash(string);\n}\n\nfunction rev(doc, deterministic_revs) {\n  var clonedDoc = clone(doc);\n  if (!deterministic_revs) {\n    return uuidV4.v4().replace(/-/g, '').toLowerCase();\n  }\n\n  delete clonedDoc._rev_tree;\n  return stringMd5(JSON.stringify(clonedDoc));\n}\n\nvar uuid = uuidV4.v4;\n\n// We fetch all leafs of the revision tree, and sort them based on tree length\n// and whether they were deleted, undeleted documents with the longest revision\n// tree (most edits) win\n// The final sort algorithm is slightly documented in a sidebar here:\n// http://guide.couchdb.org/draft/conflicts.html\nfunction winningRev(metadata) {\n  var winningId;\n  var winningPos;\n  var winningDeleted;\n  var toVisit = metadata.rev_tree.slice();\n  var node;\n  while ((node = toVisit.pop())) {\n    var tree = node.ids;\n    var branches = tree[2];\n    var pos = node.pos;\n    if (branches.length) { // non-leaf\n      for (var i = 0, len = branches.length; i < len; i++) {\n        toVisit.push({pos: pos + 1, ids: branches[i]});\n      }\n      continue;\n    }\n    var deleted = !!tree[1].deleted;\n    var id = tree[0];\n    // sort by deleted, then pos, then id\n    if (!winningId || (winningDeleted !== deleted ? winningDeleted :\n        winningPos !== pos ? winningPos < pos : winningId < id)) {\n      winningId = id;\n      winningPos = pos;\n      winningDeleted = deleted;\n    }\n  }\n\n  return winningPos + '-' + winningId;\n}\n\n// Pretty much all below can be combined into a higher order function to\n// traverse revisions\n// The return value from the callback will be passed as context to all\n// children of that node\nfunction traverseRevTree(revs, callback) {\n  var toVisit = revs.slice();\n\n  var node;\n  while ((node = toVisit.pop())) {\n    var pos = node.pos;\n    var tree = node.ids;\n    var branches = tree[2];\n    var newCtx =\n      callback(branches.length === 0, pos, tree[0], node.ctx, tree[1]);\n    for (var i = 0, len = branches.length; i < len; i++) {\n      toVisit.push({pos: pos + 1, ids: branches[i], ctx: newCtx});\n    }\n  }\n}\n\nfunction sortByPos(a, b) {\n  return a.pos - b.pos;\n}\n\nfunction collectLeaves(revs) {\n  var leaves = [];\n  traverseRevTree(revs, function (isLeaf, pos, id, acc, opts) {\n    if (isLeaf) {\n      leaves.push({rev: pos + \"-\" + id, pos: pos, opts: opts});\n    }\n  });\n  leaves.sort(sortByPos).reverse();\n  for (var i = 0, len = leaves.length; i < len; i++) {\n    delete leaves[i].pos;\n  }\n  return leaves;\n}\n\n// returns revs of all conflicts that is leaves such that\n// 1. are not deleted and\n// 2. are different than winning revision\nfunction collectConflicts(metadata) {\n  var win = winningRev(metadata);\n  var leaves = collectLeaves(metadata.rev_tree);\n  var conflicts = [];\n  for (var i = 0, len = leaves.length; i < len; i++) {\n    var leaf = leaves[i];\n    if (leaf.rev !== win && !leaf.opts.deleted) {\n      conflicts.push(leaf.rev);\n    }\n  }\n  return conflicts;\n}\n\n// compact a tree by marking its non-leafs as missing,\n// and return a list of revs to delete\nfunction compactTree(metadata) {\n  var revs = [];\n  traverseRevTree(metadata.rev_tree, function (isLeaf, pos,\n                                               revHash, ctx, opts) {\n    if (opts.status === 'available' && !isLeaf) {\n      revs.push(pos + '-' + revHash);\n      opts.status = 'missing';\n    }\n  });\n  return revs;\n}\n\n// build up a list of all the paths to the leafs in this revision tree\nfunction rootToLeaf(revs) {\n  var paths = [];\n  var toVisit = revs.slice();\n  var node;\n  while ((node = toVisit.pop())) {\n    var pos = node.pos;\n    var tree = node.ids;\n    var id = tree[0];\n    var opts = tree[1];\n    var branches = tree[2];\n    var isLeaf = branches.length === 0;\n\n    var history = node.history ? node.history.slice() : [];\n    history.push({id: id, opts: opts});\n    if (isLeaf) {\n      paths.push({pos: (pos + 1 - history.length), ids: history});\n    }\n    for (var i = 0, len = branches.length; i < len; i++) {\n      toVisit.push({pos: pos + 1, ids: branches[i], history: history});\n    }\n  }\n  return paths.reverse();\n}\n\n// for a better overview of what this is doing, read:\n\nfunction sortByPos$1(a, b) {\n  return a.pos - b.pos;\n}\n\n// classic binary search\nfunction binarySearch(arr, item, comparator) {\n  var low = 0;\n  var high = arr.length;\n  var mid;\n  while (low < high) {\n    mid = (low + high) >>> 1;\n    if (comparator(arr[mid], item) < 0) {\n      low = mid + 1;\n    } else {\n      high = mid;\n    }\n  }\n  return low;\n}\n\n// assuming the arr is sorted, insert the item in the proper place\nfunction insertSorted(arr, item, comparator) {\n  var idx = binarySearch(arr, item, comparator);\n  arr.splice(idx, 0, item);\n}\n\n// Turn a path as a flat array into a tree with a single branch.\n// If any should be stemmed from the beginning of the array, that's passed\n// in as the second argument\nfunction pathToTree(path, numStemmed) {\n  var root;\n  var leaf;\n  for (var i = numStemmed, len = path.length; i < len; i++) {\n    var node = path[i];\n    var currentLeaf = [node.id, node.opts, []];\n    if (leaf) {\n      leaf[2].push(currentLeaf);\n      leaf = currentLeaf;\n    } else {\n      root = leaf = currentLeaf;\n    }\n  }\n  return root;\n}\n\n// compare the IDs of two trees\nfunction compareTree(a, b) {\n  return a[0] < b[0] ? -1 : 1;\n}\n\n// Merge two trees together\n// The roots of tree1 and tree2 must be the same revision\nfunction mergeTree(in_tree1, in_tree2) {\n  var queue = [{tree1: in_tree1, tree2: in_tree2}];\n  var conflicts = false;\n  while (queue.length > 0) {\n    var item = queue.pop();\n    var tree1 = item.tree1;\n    var tree2 = item.tree2;\n\n    if (tree1[1].status || tree2[1].status) {\n      tree1[1].status =\n        (tree1[1].status ===  'available' ||\n        tree2[1].status === 'available') ? 'available' : 'missing';\n    }\n\n    for (var i = 0; i < tree2[2].length; i++) {\n      if (!tree1[2][0]) {\n        conflicts = 'new_leaf';\n        tree1[2][0] = tree2[2][i];\n        continue;\n      }\n\n      var merged = false;\n      for (var j = 0; j < tree1[2].length; j++) {\n        if (tree1[2][j][0] === tree2[2][i][0]) {\n          queue.push({tree1: tree1[2][j], tree2: tree2[2][i]});\n          merged = true;\n        }\n      }\n      if (!merged) {\n        conflicts = 'new_branch';\n        insertSorted(tree1[2], tree2[2][i], compareTree);\n      }\n    }\n  }\n  return {conflicts: conflicts, tree: in_tree1};\n}\n\nfunction doMerge(tree, path, dontExpand) {\n  var restree = [];\n  var conflicts = false;\n  var merged = false;\n  var res;\n\n  if (!tree.length) {\n    return {tree: [path], conflicts: 'new_leaf'};\n  }\n\n  for (var i = 0, len = tree.length; i < len; i++) {\n    var branch = tree[i];\n    if (branch.pos === path.pos && branch.ids[0] === path.ids[0]) {\n      // Paths start at the same position and have the same root, so they need\n      // merged\n      res = mergeTree(branch.ids, path.ids);\n      restree.push({pos: branch.pos, ids: res.tree});\n      conflicts = conflicts || res.conflicts;\n      merged = true;\n    } else if (dontExpand !== true) {\n      // The paths start at a different position, take the earliest path and\n      // traverse up until it as at the same point from root as the path we\n      // want to merge.  If the keys match we return the longer path with the\n      // other merged After stemming we dont want to expand the trees\n\n      var t1 = branch.pos < path.pos ? branch : path;\n      var t2 = branch.pos < path.pos ? path : branch;\n      var diff = t2.pos - t1.pos;\n\n      var candidateParents = [];\n\n      var trees = [];\n      trees.push({ids: t1.ids, diff: diff, parent: null, parentIdx: null});\n      while (trees.length > 0) {\n        var item = trees.pop();\n        if (item.diff === 0) {\n          if (item.ids[0] === t2.ids[0]) {\n            candidateParents.push(item);\n          }\n          continue;\n        }\n        var elements = item.ids[2];\n        for (var j = 0, elementsLen = elements.length; j < elementsLen; j++) {\n          trees.push({\n            ids: elements[j],\n            diff: item.diff - 1,\n            parent: item.ids,\n            parentIdx: j\n          });\n        }\n      }\n\n      var el = candidateParents[0];\n\n      if (!el) {\n        restree.push(branch);\n      } else {\n        res = mergeTree(el.ids, t2.ids);\n        el.parent[2][el.parentIdx] = res.tree;\n        restree.push({pos: t1.pos, ids: t1.ids});\n        conflicts = conflicts || res.conflicts;\n        merged = true;\n      }\n    } else {\n      restree.push(branch);\n    }\n  }\n\n  // We didnt find\n  if (!merged) {\n    restree.push(path);\n  }\n\n  restree.sort(sortByPos$1);\n\n  return {\n    tree: restree,\n    conflicts: conflicts || 'internal_node'\n  };\n}\n\n// To ensure we dont grow the revision tree infinitely, we stem old revisions\nfunction stem(tree, depth) {\n  // First we break out the tree into a complete list of root to leaf paths\n  var paths = rootToLeaf(tree);\n  var stemmedRevs;\n\n  var result;\n  for (var i = 0, len = paths.length; i < len; i++) {\n    // Then for each path, we cut off the start of the path based on the\n    // `depth` to stem to, and generate a new set of flat trees\n    var path = paths[i];\n    var stemmed = path.ids;\n    var node;\n    if (stemmed.length > depth) {\n      // only do the stemming work if we actually need to stem\n      if (!stemmedRevs) {\n        stemmedRevs = {}; // avoid allocating this object unnecessarily\n      }\n      var numStemmed = stemmed.length - depth;\n      node = {\n        pos: path.pos + numStemmed,\n        ids: pathToTree(stemmed, numStemmed)\n      };\n\n      for (var s = 0; s < numStemmed; s++) {\n        var rev = (path.pos + s) + '-' + stemmed[s].id;\n        stemmedRevs[rev] = true;\n      }\n    } else { // no need to actually stem\n      node = {\n        pos: path.pos,\n        ids: pathToTree(stemmed, 0)\n      };\n    }\n\n    // Then we remerge all those flat trees together, ensuring that we dont\n    // connect trees that would go beyond the depth limit\n    if (result) {\n      result = doMerge(result, node, true).tree;\n    } else {\n      result = [node];\n    }\n  }\n\n  // this is memory-heavy per Chrome profiler, avoid unless we actually stemmed\n  if (stemmedRevs) {\n    traverseRevTree(result, function (isLeaf, pos, revHash) {\n      // some revisions may have been removed in a branch but not in another\n      delete stemmedRevs[pos + '-' + revHash];\n    });\n  }\n\n  return {\n    tree: result,\n    revs: stemmedRevs ? Object.keys(stemmedRevs) : []\n  };\n}\n\nfunction merge(tree, path, depth) {\n  var newTree = doMerge(tree, path);\n  var stemmed = stem(newTree.tree, depth);\n  return {\n    tree: stemmed.tree,\n    stemmedRevs: stemmed.revs,\n    conflicts: newTree.conflicts\n  };\n}\n\n// return true if a rev exists in the rev tree, false otherwise\nfunction revExists(revs, rev) {\n  var toVisit = revs.slice();\n  var splitRev = rev.split('-');\n  var targetPos = parseInt(splitRev[0], 10);\n  var targetId = splitRev[1];\n\n  var node;\n  while ((node = toVisit.pop())) {\n    if (node.pos === targetPos && node.ids[0] === targetId) {\n      return true;\n    }\n    var branches = node.ids[2];\n    for (var i = 0, len = branches.length; i < len; i++) {\n      toVisit.push({pos: node.pos + 1, ids: branches[i]});\n    }\n  }\n  return false;\n}\n\nfunction getTrees(node) {\n  return node.ids;\n}\n\n// check if a specific revision of a doc has been deleted\n//  - metadata: the metadata object from the doc store\n//  - rev: (optional) the revision to check. defaults to winning revision\nfunction isDeleted(metadata, rev) {\n  if (!rev) {\n    rev = winningRev(metadata);\n  }\n  var id = rev.substring(rev.indexOf('-') + 1);\n  var toVisit = metadata.rev_tree.map(getTrees);\n\n  var tree;\n  while ((tree = toVisit.pop())) {\n    if (tree[0] === id) {\n      return !!tree[1].deleted;\n    }\n    toVisit = toVisit.concat(tree[2]);\n  }\n}\n\nfunction isLocalId(id) {\n  return (/^_local/).test(id);\n}\n\n// returns the current leaf node for a given revision\nfunction latest(rev, metadata) {\n  var toVisit = metadata.rev_tree.slice();\n  var node;\n  while ((node = toVisit.pop())) {\n    var pos = node.pos;\n    var tree = node.ids;\n    var id = tree[0];\n    var opts = tree[1];\n    var branches = tree[2];\n    var isLeaf = branches.length === 0;\n\n    var history = node.history ? node.history.slice() : [];\n    history.push({id: id, pos: pos, opts: opts});\n\n    if (isLeaf) {\n      for (var i = 0, len = history.length; i < len; i++) {\n        var historyNode = history[i];\n        var historyRev = historyNode.pos + '-' + historyNode.id;\n\n        if (historyRev === rev) {\n          // return the rev of this leaf\n          return pos + '-' + id;\n        }\n      }\n    }\n\n    for (var j = 0, l = branches.length; j < l; j++) {\n      toVisit.push({pos: pos + 1, ids: branches[j], history: history});\n    }\n  }\n\n  /* istanbul ignore next */\n  throw new Error('Unable to resolve latest revision for id ' + metadata.id + ', rev ' + rev);\n}\n\ninherits(Changes$1, EventEmitter);\n\nfunction tryCatchInChangeListener(self, change, pending, lastSeq) {\n  // isolate try/catches to avoid V8 deoptimizations\n  try {\n    self.emit('change', change, pending, lastSeq);\n  } catch (e) {\n    guardedConsole('error', 'Error in .on(\"change\", function):', e);\n  }\n}\n\nfunction Changes$1(db, opts, callback) {\n  EventEmitter.call(this);\n  var self = this;\n  this.db = db;\n  opts = opts ? clone(opts) : {};\n  var complete = opts.complete = once(function (err, resp) {\n    if (err) {\n      if (listenerCount(self, 'error') > 0) {\n        self.emit('error', err);\n      }\n    } else {\n      self.emit('complete', resp);\n    }\n    self.removeAllListeners();\n    db.removeListener('destroyed', onDestroy);\n  });\n  if (callback) {\n    self.on('complete', function (resp) {\n      callback(null, resp);\n    });\n    self.on('error', callback);\n  }\n  function onDestroy() {\n    self.cancel();\n  }\n  db.once('destroyed', onDestroy);\n\n  opts.onChange = function (change, pending, lastSeq) {\n    /* istanbul ignore if */\n    if (self.isCancelled) {\n      return;\n    }\n    tryCatchInChangeListener(self, change, pending, lastSeq);\n  };\n\n  var promise = new Promise(function (fulfill, reject) {\n    opts.complete = function (err, res) {\n      if (err) {\n        reject(err);\n      } else {\n        fulfill(res);\n      }\n    };\n  });\n  self.once('cancel', function () {\n    db.removeListener('destroyed', onDestroy);\n    opts.complete(null, {status: 'cancelled'});\n  });\n  this.then = promise.then.bind(promise);\n  this['catch'] = promise['catch'].bind(promise);\n  this.then(function (result) {\n    complete(null, result);\n  }, complete);\n\n\n\n  if (!db.taskqueue.isReady) {\n    db.taskqueue.addTask(function (failed) {\n      if (failed) {\n        opts.complete(failed);\n      } else if (self.isCancelled) {\n        self.emit('cancel');\n      } else {\n        self.validateChanges(opts);\n      }\n    });\n  } else {\n    self.validateChanges(opts);\n  }\n}\nChanges$1.prototype.cancel = function () {\n  this.isCancelled = true;\n  if (this.db.taskqueue.isReady) {\n    this.emit('cancel');\n  }\n};\nfunction processChange(doc, metadata, opts) {\n  var changeList = [{rev: doc._rev}];\n  if (opts.style === 'all_docs') {\n    changeList = collectLeaves(metadata.rev_tree)\n    .map(function (x) { return {rev: x.rev}; });\n  }\n  var change = {\n    id: metadata.id,\n    changes: changeList,\n    doc: doc\n  };\n\n  if (isDeleted(metadata, doc._rev)) {\n    change.deleted = true;\n  }\n  if (opts.conflicts) {\n    change.doc._conflicts = collectConflicts(metadata);\n    if (!change.doc._conflicts.length) {\n      delete change.doc._conflicts;\n    }\n  }\n  return change;\n}\n\nChanges$1.prototype.validateChanges = function (opts) {\n  var callback = opts.complete;\n  var self = this;\n\n  /* istanbul ignore else */\n  if (PouchDB._changesFilterPlugin) {\n    PouchDB._changesFilterPlugin.validate(opts, function (err) {\n      if (err) {\n        return callback(err);\n      }\n      self.doChanges(opts);\n    });\n  } else {\n    self.doChanges(opts);\n  }\n};\n\nChanges$1.prototype.doChanges = function (opts) {\n  var self = this;\n  var callback = opts.complete;\n\n  opts = clone(opts);\n  if ('live' in opts && !('continuous' in opts)) {\n    opts.continuous = opts.live;\n  }\n  opts.processChange = processChange;\n\n  if (opts.since === 'latest') {\n    opts.since = 'now';\n  }\n  if (!opts.since) {\n    opts.since = 0;\n  }\n  if (opts.since === 'now') {\n    this.db.info().then(function (info) {\n      /* istanbul ignore if */\n      if (self.isCancelled) {\n        callback(null, {status: 'cancelled'});\n        return;\n      }\n      opts.since = info.update_seq;\n      self.doChanges(opts);\n    }, callback);\n    return;\n  }\n\n  /* istanbul ignore else */\n  if (PouchDB._changesFilterPlugin) {\n    PouchDB._changesFilterPlugin.normalize(opts);\n    if (PouchDB._changesFilterPlugin.shouldFilter(this, opts)) {\n      return PouchDB._changesFilterPlugin.filter(this, opts);\n    }\n  } else {\n    ['doc_ids', 'filter', 'selector', 'view'].forEach(function (key) {\n      if (key in opts) {\n        guardedConsole('warn',\n          'The \"' + key + '\" option was passed in to changes/replicate, ' +\n          'but pouchdb-changes-filter plugin is not installed, so it ' +\n          'was ignored. Please install the plugin to enable filtering.'\n        );\n      }\n    });\n  }\n\n  if (!('descending' in opts)) {\n    opts.descending = false;\n  }\n\n  // 0 and 1 should return 1 document\n  opts.limit = opts.limit === 0 ? 1 : opts.limit;\n  opts.complete = callback;\n  var newPromise = this.db._changes(opts);\n  /* istanbul ignore else */\n  if (newPromise && typeof newPromise.cancel === 'function') {\n    var cancel = self.cancel;\n    self.cancel = getArguments(function (args) {\n      newPromise.cancel();\n      cancel.apply(this, args);\n    });\n  }\n};\n\n/*\n * A generic pouch adapter\n */\n\nfunction compare(left, right) {\n  return left < right ? -1 : left > right ? 1 : 0;\n}\n\n// Wrapper for functions that call the bulkdocs api with a single doc,\n// if the first result is an error, return an error\nfunction yankError(callback, docId) {\n  return function (err, results) {\n    if (err || (results[0] && results[0].error)) {\n      err = err || results[0];\n      err.docId = docId;\n      callback(err);\n    } else {\n      callback(null, results.length ? results[0]  : results);\n    }\n  };\n}\n\n// clean docs given to us by the user\nfunction cleanDocs(docs) {\n  for (var i = 0; i < docs.length; i++) {\n    var doc = docs[i];\n    if (doc._deleted) {\n      delete doc._attachments; // ignore atts for deleted docs\n    } else if (doc._attachments) {\n      // filter out extraneous keys from _attachments\n      var atts = Object.keys(doc._attachments);\n      for (var j = 0; j < atts.length; j++) {\n        var att = atts[j];\n        doc._attachments[att] = pick(doc._attachments[att],\n          ['data', 'digest', 'content_type', 'length', 'revpos', 'stub']);\n      }\n    }\n  }\n}\n\n// compare two docs, first by _id then by _rev\nfunction compareByIdThenRev(a, b) {\n  var idCompare = compare(a._id, b._id);\n  if (idCompare !== 0) {\n    return idCompare;\n  }\n  var aStart = a._revisions ? a._revisions.start : 0;\n  var bStart = b._revisions ? b._revisions.start : 0;\n  return compare(aStart, bStart);\n}\n\n// for every node in a revision tree computes its distance from the closest\n// leaf\nfunction computeHeight(revs) {\n  var height = {};\n  var edges = [];\n  traverseRevTree(revs, function (isLeaf, pos, id, prnt) {\n    var rev$$1 = pos + \"-\" + id;\n    if (isLeaf) {\n      height[rev$$1] = 0;\n    }\n    if (prnt !== undefined) {\n      edges.push({from: prnt, to: rev$$1});\n    }\n    return rev$$1;\n  });\n\n  edges.reverse();\n  edges.forEach(function (edge) {\n    if (height[edge.from] === undefined) {\n      height[edge.from] = 1 + height[edge.to];\n    } else {\n      height[edge.from] = Math.min(height[edge.from], 1 + height[edge.to]);\n    }\n  });\n  return height;\n}\n\nfunction allDocsKeysParse(opts) {\n  var keys =  ('limit' in opts) ?\n    opts.keys.slice(opts.skip, opts.limit + opts.skip) :\n    (opts.skip > 0) ? opts.keys.slice(opts.skip) : opts.keys;\n  opts.keys = keys;\n  opts.skip = 0;\n  delete opts.limit;\n  if (opts.descending) {\n    keys.reverse();\n    opts.descending = false;\n  }\n}\n\n// all compaction is done in a queue, to avoid attaching\n// too many listeners at once\nfunction doNextCompaction(self) {\n  var task = self._compactionQueue[0];\n  var opts = task.opts;\n  var callback = task.callback;\n  self.get('_local/compaction').catch(function () {\n    return false;\n  }).then(function (doc) {\n    if (doc && doc.last_seq) {\n      opts.last_seq = doc.last_seq;\n    }\n    self._compact(opts, function (err, res) {\n      /* istanbul ignore if */\n      if (err) {\n        callback(err);\n      } else {\n        callback(null, res);\n      }\n      immediate(function () {\n        self._compactionQueue.shift();\n        if (self._compactionQueue.length) {\n          doNextCompaction(self);\n        }\n      });\n    });\n  });\n}\n\nfunction attachmentNameError(name) {\n  if (name.charAt(0) === '_') {\n    return name + ' is not a valid attachment name, attachment ' +\n      'names cannot start with \\'_\\'';\n  }\n  return false;\n}\n\ninherits(AbstractPouchDB, EventEmitter);\n\nfunction AbstractPouchDB() {\n  EventEmitter.call(this);\n\n  // re-bind prototyped methods\n  for (var p in AbstractPouchDB.prototype) {\n    if (typeof this[p] === 'function') {\n      this[p] = this[p].bind(this);\n    }\n  }\n}\n\nAbstractPouchDB.prototype.post =\n  adapterFun('post', function (doc, opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n  if (typeof doc !== 'object' || Array.isArray(doc)) {\n    return callback(createError(NOT_AN_OBJECT));\n  }\n  this.bulkDocs({docs: [doc]}, opts, yankError(callback, doc._id));\n});\n\nAbstractPouchDB.prototype.put = adapterFun('put', function (doc, opts, cb) {\n  if (typeof opts === 'function') {\n    cb = opts;\n    opts = {};\n  }\n  if (typeof doc !== 'object' || Array.isArray(doc)) {\n    return cb(createError(NOT_AN_OBJECT));\n  }\n  invalidIdError(doc._id);\n  if (isLocalId(doc._id) && typeof this._putLocal === 'function') {\n    if (doc._deleted) {\n      return this._removeLocal(doc, cb);\n    } else {\n      return this._putLocal(doc, cb);\n    }\n  }\n  var self = this;\n  if (opts.force && doc._rev) {\n    transformForceOptionToNewEditsOption();\n    putDoc(function (err) {\n      var result = err ? null : {ok: true, id: doc._id, rev: doc._rev};\n      cb(err, result);\n    });\n  } else {\n    putDoc(cb);\n  }\n\n  function transformForceOptionToNewEditsOption() {\n    var parts = doc._rev.split('-');\n    var oldRevId = parts[1];\n    var oldRevNum = parseInt(parts[0], 10);\n\n    var newRevNum = oldRevNum + 1;\n    var newRevId = rev();\n\n    doc._revisions = {\n      start: newRevNum,\n      ids: [newRevId, oldRevId]\n    };\n    doc._rev = newRevNum + '-' + newRevId;\n    opts.new_edits = false;\n  }\n  function putDoc(next) {\n    if (typeof self._put === 'function' && opts.new_edits !== false) {\n      self._put(doc, opts, next);\n    } else {\n      self.bulkDocs({docs: [doc]}, opts, yankError(next, doc._id));\n    }\n  }\n});\n\nAbstractPouchDB.prototype.putAttachment =\n  adapterFun('putAttachment', function (docId, attachmentId, rev$$1,\n                                              blob, type) {\n  var api = this;\n  if (typeof type === 'function') {\n    type = blob;\n    blob = rev$$1;\n    rev$$1 = null;\n  }\n  // Lets fix in https://github.com/pouchdb/pouchdb/issues/3267\n  /* istanbul ignore if */\n  if (typeof type === 'undefined') {\n    type = blob;\n    blob = rev$$1;\n    rev$$1 = null;\n  }\n  if (!type) {\n    guardedConsole('warn', 'Attachment', attachmentId, 'on document', docId, 'is missing content_type');\n  }\n\n  function createAttachment(doc) {\n    var prevrevpos = '_rev' in doc ? parseInt(doc._rev, 10) : 0;\n    doc._attachments = doc._attachments || {};\n    doc._attachments[attachmentId] = {\n      content_type: type,\n      data: blob,\n      revpos: ++prevrevpos\n    };\n    return api.put(doc);\n  }\n\n  return api.get(docId).then(function (doc) {\n    if (doc._rev !== rev$$1) {\n      throw createError(REV_CONFLICT);\n    }\n\n    return createAttachment(doc);\n  }, function (err) {\n     // create new doc\n    /* istanbul ignore else */\n    if (err.reason === MISSING_DOC.message) {\n      return createAttachment({_id: docId});\n    } else {\n      throw err;\n    }\n  });\n});\n\nAbstractPouchDB.prototype.removeAttachment =\n  adapterFun('removeAttachment', function (docId, attachmentId, rev$$1,\n                                                 callback) {\n  var self = this;\n  self.get(docId, function (err, obj) {\n    /* istanbul ignore if */\n    if (err) {\n      callback(err);\n      return;\n    }\n    if (obj._rev !== rev$$1) {\n      callback(createError(REV_CONFLICT));\n      return;\n    }\n    /* istanbul ignore if */\n    if (!obj._attachments) {\n      return callback();\n    }\n    delete obj._attachments[attachmentId];\n    if (Object.keys(obj._attachments).length === 0) {\n      delete obj._attachments;\n    }\n    self.put(obj, callback);\n  });\n});\n\nAbstractPouchDB.prototype.remove =\n  adapterFun('remove', function (docOrId, optsOrRev, opts, callback) {\n  var doc;\n  if (typeof optsOrRev === 'string') {\n    // id, rev, opts, callback style\n    doc = {\n      _id: docOrId,\n      _rev: optsOrRev\n    };\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n  } else {\n    // doc, opts, callback style\n    doc = docOrId;\n    if (typeof optsOrRev === 'function') {\n      callback = optsOrRev;\n      opts = {};\n    } else {\n      callback = opts;\n      opts = optsOrRev;\n    }\n  }\n  opts = opts || {};\n  opts.was_delete = true;\n  var newDoc = {_id: doc._id, _rev: (doc._rev || opts.rev)};\n  newDoc._deleted = true;\n  if (isLocalId(newDoc._id) && typeof this._removeLocal === 'function') {\n    return this._removeLocal(doc, callback);\n  }\n  this.bulkDocs({docs: [newDoc]}, opts, yankError(callback, newDoc._id));\n});\n\nAbstractPouchDB.prototype.revsDiff =\n  adapterFun('revsDiff', function (req, opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n  var ids = Object.keys(req);\n\n  if (!ids.length) {\n    return callback(null, {});\n  }\n\n  var count = 0;\n  var missing = new ExportedMap();\n\n  function addToMissing(id, revId) {\n    if (!missing.has(id)) {\n      missing.set(id, {missing: []});\n    }\n    missing.get(id).missing.push(revId);\n  }\n\n  function processDoc(id, rev_tree) {\n    // Is this fast enough? Maybe we should switch to a set simulated by a map\n    var missingForId = req[id].slice(0);\n    traverseRevTree(rev_tree, function (isLeaf, pos, revHash, ctx,\n      opts) {\n        var rev$$1 = pos + '-' + revHash;\n        var idx = missingForId.indexOf(rev$$1);\n        if (idx === -1) {\n          return;\n        }\n\n        missingForId.splice(idx, 1);\n        /* istanbul ignore if */\n        if (opts.status !== 'available') {\n          addToMissing(id, rev$$1);\n        }\n      });\n\n    // Traversing the tree is synchronous, so now `missingForId` contains\n    // revisions that were not found in the tree\n    missingForId.forEach(function (rev$$1) {\n      addToMissing(id, rev$$1);\n    });\n  }\n\n  ids.map(function (id) {\n    this._getRevisionTree(id, function (err, rev_tree) {\n      if (err && err.status === 404 && err.message === 'missing') {\n        missing.set(id, {missing: req[id]});\n      } else if (err) {\n        /* istanbul ignore next */\n        return callback(err);\n      } else {\n        processDoc(id, rev_tree);\n      }\n\n      if (++count === ids.length) {\n        // convert LazyMap to object\n        var missingObj = {};\n        missing.forEach(function (value, key) {\n          missingObj[key] = value;\n        });\n        return callback(null, missingObj);\n      }\n    });\n  }, this);\n});\n\n// _bulk_get API for faster replication, as described in\n// https://github.com/apache/couchdb-chttpd/pull/33\n// At the \"abstract\" level, it will just run multiple get()s in\n// parallel, because this isn't much of a performance cost\n// for local databases (except the cost of multiple transactions, which is\n// small). The http adapter overrides this in order\n// to do a more efficient single HTTP request.\nAbstractPouchDB.prototype.bulkGet =\n  adapterFun('bulkGet', function (opts, callback) {\n  bulkGet(this, opts, callback);\n});\n\n// compact one document and fire callback\n// by compacting we mean removing all revisions which\n// are further from the leaf in revision tree than max_height\nAbstractPouchDB.prototype.compactDocument =\n  adapterFun('compactDocument', function (docId, maxHeight, callback) {\n  var self = this;\n  this._getRevisionTree(docId, function (err, revTree) {\n    /* istanbul ignore if */\n    if (err) {\n      return callback(err);\n    }\n    var height = computeHeight(revTree);\n    var candidates = [];\n    var revs = [];\n    Object.keys(height).forEach(function (rev$$1) {\n      if (height[rev$$1] > maxHeight) {\n        candidates.push(rev$$1);\n      }\n    });\n\n    traverseRevTree(revTree, function (isLeaf, pos, revHash, ctx, opts) {\n      var rev$$1 = pos + '-' + revHash;\n      if (opts.status === 'available' && candidates.indexOf(rev$$1) !== -1) {\n        revs.push(rev$$1);\n      }\n    });\n    self._doCompaction(docId, revs, callback);\n  });\n});\n\n// compact the whole database using single document\n// compaction\nAbstractPouchDB.prototype.compact =\n  adapterFun('compact', function (opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n\n  var self = this;\n  opts = opts || {};\n\n  self._compactionQueue = self._compactionQueue || [];\n  self._compactionQueue.push({opts: opts, callback: callback});\n  if (self._compactionQueue.length === 1) {\n    doNextCompaction(self);\n  }\n});\nAbstractPouchDB.prototype._compact = function (opts, callback) {\n  var self = this;\n  var changesOpts = {\n    return_docs: false,\n    last_seq: opts.last_seq || 0\n  };\n  var promises = [];\n\n  function onChange(row) {\n    promises.push(self.compactDocument(row.id, 0));\n  }\n  function onComplete(resp) {\n    var lastSeq = resp.last_seq;\n    Promise.all(promises).then(function () {\n      return upsert(self, '_local/compaction', function deltaFunc(doc) {\n        if (!doc.last_seq || doc.last_seq < lastSeq) {\n          doc.last_seq = lastSeq;\n          return doc;\n        }\n        return false; // somebody else got here first, don't update\n      });\n    }).then(function () {\n      callback(null, {ok: true});\n    }).catch(callback);\n  }\n  self.changes(changesOpts)\n    .on('change', onChange)\n    .on('complete', onComplete)\n    .on('error', callback);\n};\n\n/* Begin api wrappers. Specific functionality to storage belongs in the\n   _[method] */\nAbstractPouchDB.prototype.get = adapterFun('get', function (id, opts, cb) {\n  if (typeof opts === 'function') {\n    cb = opts;\n    opts = {};\n  }\n  if (typeof id !== 'string') {\n    return cb(createError(INVALID_ID));\n  }\n  if (isLocalId(id) && typeof this._getLocal === 'function') {\n    return this._getLocal(id, cb);\n  }\n  var leaves = [], self = this;\n\n  function finishOpenRevs() {\n    var result = [];\n    var count = leaves.length;\n    /* istanbul ignore if */\n    if (!count) {\n      return cb(null, result);\n    }\n\n    // order with open_revs is unspecified\n    leaves.forEach(function (leaf) {\n      self.get(id, {\n        rev: leaf,\n        revs: opts.revs,\n        latest: opts.latest,\n        attachments: opts.attachments,\n        binary: opts.binary\n      }, function (err, doc) {\n        if (!err) {\n          // using latest=true can produce duplicates\n          var existing;\n          for (var i = 0, l = result.length; i < l; i++) {\n            if (result[i].ok && result[i].ok._rev === doc._rev) {\n              existing = true;\n              break;\n            }\n          }\n          if (!existing) {\n            result.push({ok: doc});\n          }\n        } else {\n          result.push({missing: leaf});\n        }\n        count--;\n        if (!count) {\n          cb(null, result);\n        }\n      });\n    });\n  }\n\n  if (opts.open_revs) {\n    if (opts.open_revs === \"all\") {\n      this._getRevisionTree(id, function (err, rev_tree) {\n        /* istanbul ignore if */\n        if (err) {\n          return cb(err);\n        }\n        leaves = collectLeaves(rev_tree).map(function (leaf) {\n          return leaf.rev;\n        });\n        finishOpenRevs();\n      });\n    } else {\n      if (Array.isArray(opts.open_revs)) {\n        leaves = opts.open_revs;\n        for (var i = 0; i < leaves.length; i++) {\n          var l = leaves[i];\n          // looks like it's the only thing couchdb checks\n          if (!(typeof (l) === \"string\" && /^\\d+-/.test(l))) {\n            return cb(createError(INVALID_REV));\n          }\n        }\n        finishOpenRevs();\n      } else {\n        return cb(createError(UNKNOWN_ERROR, 'function_clause'));\n      }\n    }\n    return; // open_revs does not like other options\n  }\n\n  return this._get(id, opts, function (err, result) {\n    if (err) {\n      err.docId = id;\n      return cb(err);\n    }\n\n    var doc = result.doc;\n    var metadata = result.metadata;\n    var ctx = result.ctx;\n\n    if (opts.conflicts) {\n      var conflicts = collectConflicts(metadata);\n      if (conflicts.length) {\n        doc._conflicts = conflicts;\n      }\n    }\n\n    if (isDeleted(metadata, doc._rev)) {\n      doc._deleted = true;\n    }\n\n    if (opts.revs || opts.revs_info) {\n      var splittedRev = doc._rev.split('-');\n      var revNo       = parseInt(splittedRev[0], 10);\n      var revHash     = splittedRev[1];\n\n      var paths = rootToLeaf(metadata.rev_tree);\n      var path = null;\n\n      for (var i = 0; i < paths.length; i++) {\n        var currentPath = paths[i];\n        var hashIndex = currentPath.ids.map(function (x) { return x.id; })\n          .indexOf(revHash);\n        var hashFoundAtRevPos = hashIndex === (revNo - 1);\n\n        if (hashFoundAtRevPos || (!path && hashIndex !== -1)) {\n          path = currentPath;\n        }\n      }\n\n      /* istanbul ignore if */\n      if (!path) {\n        err = new Error('invalid rev tree');\n        err.docId = id;\n        return cb(err);\n      }\n\n      var indexOfRev = path.ids.map(function (x) { return x.id; })\n        .indexOf(doc._rev.split('-')[1]) + 1;\n      var howMany = path.ids.length - indexOfRev;\n      path.ids.splice(indexOfRev, howMany);\n      path.ids.reverse();\n\n      if (opts.revs) {\n        doc._revisions = {\n          start: (path.pos + path.ids.length) - 1,\n          ids: path.ids.map(function (rev$$1) {\n            return rev$$1.id;\n          })\n        };\n      }\n      if (opts.revs_info) {\n        var pos =  path.pos + path.ids.length;\n        doc._revs_info = path.ids.map(function (rev$$1) {\n          pos--;\n          return {\n            rev: pos + '-' + rev$$1.id,\n            status: rev$$1.opts.status\n          };\n        });\n      }\n    }\n\n    if (opts.attachments && doc._attachments) {\n      var attachments = doc._attachments;\n      var count = Object.keys(attachments).length;\n      if (count === 0) {\n        return cb(null, doc);\n      }\n      Object.keys(attachments).forEach(function (key) {\n        this._getAttachment(doc._id, key, attachments[key], {\n          // Previously the revision handling was done in adapter.js\n          // getAttachment, however since idb-next doesnt we need to\n          // pass the rev through\n          rev: doc._rev,\n          binary: opts.binary,\n          ctx: ctx\n        }, function (err, data) {\n          var att = doc._attachments[key];\n          att.data = data;\n          delete att.stub;\n          delete att.length;\n          if (!--count) {\n            cb(null, doc);\n          }\n        });\n      }, self);\n    } else {\n      if (doc._attachments) {\n        for (var key in doc._attachments) {\n          /* istanbul ignore else */\n          if (doc._attachments.hasOwnProperty(key)) {\n            doc._attachments[key].stub = true;\n          }\n        }\n      }\n      cb(null, doc);\n    }\n  });\n});\n\n// TODO: I dont like this, it forces an extra read for every\n// attachment read and enforces a confusing api between\n// adapter.js and the adapter implementation\nAbstractPouchDB.prototype.getAttachment =\n  adapterFun('getAttachment', function (docId, attachmentId, opts, callback) {\n  var self = this;\n  if (opts instanceof Function) {\n    callback = opts;\n    opts = {};\n  }\n  this._get(docId, opts, function (err, res) {\n    if (err) {\n      return callback(err);\n    }\n    if (res.doc._attachments && res.doc._attachments[attachmentId]) {\n      opts.ctx = res.ctx;\n      opts.binary = true;\n      self._getAttachment(docId, attachmentId,\n                          res.doc._attachments[attachmentId], opts, callback);\n    } else {\n      return callback(createError(MISSING_DOC));\n    }\n  });\n});\n\nAbstractPouchDB.prototype.allDocs =\n  adapterFun('allDocs', function (opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n  opts.skip = typeof opts.skip !== 'undefined' ? opts.skip : 0;\n  if (opts.start_key) {\n    opts.startkey = opts.start_key;\n  }\n  if (opts.end_key) {\n    opts.endkey = opts.end_key;\n  }\n  if ('keys' in opts) {\n    if (!Array.isArray(opts.keys)) {\n      return callback(new TypeError('options.keys must be an array'));\n    }\n    var incompatibleOpt =\n      ['startkey', 'endkey', 'key'].filter(function (incompatibleOpt) {\n      return incompatibleOpt in opts;\n    })[0];\n    if (incompatibleOpt) {\n      callback(createError(QUERY_PARSE_ERROR,\n        'Query parameter `' + incompatibleOpt +\n        '` is not compatible with multi-get'\n      ));\n      return;\n    }\n    if (!isRemote(this)) {\n      allDocsKeysParse(opts);\n      if (opts.keys.length === 0) {\n        return this._allDocs({limit: 0}, callback);\n      }\n    }\n  }\n\n  return this._allDocs(opts, callback);\n});\n\nAbstractPouchDB.prototype.changes = function (opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n\n  opts = opts || {};\n\n  // By default set return_docs to false if the caller has opts.live = true,\n  // this will prevent us from collecting the set of changes indefinitely\n  // resulting in growing memory\n  opts.return_docs = ('return_docs' in opts) ? opts.return_docs : !opts.live;\n\n  return new Changes$1(this, opts, callback);\n};\n\nAbstractPouchDB.prototype.close = adapterFun('close', function (callback) {\n  this._closed = true;\n  this.emit('closed');\n  return this._close(callback);\n});\n\nAbstractPouchDB.prototype.info = adapterFun('info', function (callback) {\n  var self = this;\n  this._info(function (err, info) {\n    if (err) {\n      return callback(err);\n    }\n    // assume we know better than the adapter, unless it informs us\n    info.db_name = info.db_name || self.name;\n    info.auto_compaction = !!(self.auto_compaction && !isRemote(self));\n    info.adapter = self.adapter;\n    callback(null, info);\n  });\n});\n\nAbstractPouchDB.prototype.id = adapterFun('id', function (callback) {\n  return this._id(callback);\n});\n\n/* istanbul ignore next */\nAbstractPouchDB.prototype.type = function () {\n  return (typeof this._type === 'function') ? this._type() : this.adapter;\n};\n\nAbstractPouchDB.prototype.bulkDocs =\n  adapterFun('bulkDocs', function (req, opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n\n  opts = opts || {};\n\n  if (Array.isArray(req)) {\n    req = {\n      docs: req\n    };\n  }\n\n  if (!req || !req.docs || !Array.isArray(req.docs)) {\n    return callback(createError(MISSING_BULK_DOCS));\n  }\n\n  for (var i = 0; i < req.docs.length; ++i) {\n    if (typeof req.docs[i] !== 'object' || Array.isArray(req.docs[i])) {\n      return callback(createError(NOT_AN_OBJECT));\n    }\n  }\n\n  var attachmentError;\n  req.docs.forEach(function (doc) {\n    if (doc._attachments) {\n      Object.keys(doc._attachments).forEach(function (name) {\n        attachmentError = attachmentError || attachmentNameError(name);\n        if (!doc._attachments[name].content_type) {\n          guardedConsole('warn', 'Attachment', name, 'on document', doc._id, 'is missing content_type');\n        }\n      });\n    }\n  });\n\n  if (attachmentError) {\n    return callback(createError(BAD_REQUEST, attachmentError));\n  }\n\n  if (!('new_edits' in opts)) {\n    if ('new_edits' in req) {\n      opts.new_edits = req.new_edits;\n    } else {\n      opts.new_edits = true;\n    }\n  }\n\n  var adapter = this;\n  if (!opts.new_edits && !isRemote(adapter)) {\n    // ensure revisions of the same doc are sorted, so that\n    // the local adapter processes them correctly (#2935)\n    req.docs.sort(compareByIdThenRev);\n  }\n\n  cleanDocs(req.docs);\n\n  // in the case of conflicts, we want to return the _ids to the user\n  // however, the underlying adapter may destroy the docs array, so\n  // create a copy here\n  var ids = req.docs.map(function (doc) {\n    return doc._id;\n  });\n\n  return this._bulkDocs(req, opts, function (err, res) {\n    if (err) {\n      return callback(err);\n    }\n    if (!opts.new_edits) {\n      // this is what couch does when new_edits is false\n      res = res.filter(function (x) {\n        return x.error;\n      });\n    }\n    // add ids for error/conflict responses (not required for CouchDB)\n    if (!isRemote(adapter)) {\n      for (var i = 0, l = res.length; i < l; i++) {\n        res[i].id = res[i].id || ids[i];\n      }\n    }\n\n    callback(null, res);\n  });\n});\n\nAbstractPouchDB.prototype.registerDependentDatabase =\n  adapterFun('registerDependentDatabase', function (dependentDb,\n                                                          callback) {\n  var depDB = new this.constructor(dependentDb, this.__opts);\n\n  function diffFun(doc) {\n    doc.dependentDbs = doc.dependentDbs || {};\n    if (doc.dependentDbs[dependentDb]) {\n      return false; // no update required\n    }\n    doc.dependentDbs[dependentDb] = true;\n    return doc;\n  }\n  upsert(this, '_local/_pouch_dependentDbs', diffFun)\n    .then(function () {\n      callback(null, {db: depDB});\n    }).catch(callback);\n});\n\nAbstractPouchDB.prototype.destroy =\n  adapterFun('destroy', function (opts, callback) {\n\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n\n  var self = this;\n  var usePrefix = 'use_prefix' in self ? self.use_prefix : true;\n\n  function destroyDb() {\n    // call destroy method of the particular adaptor\n    self._destroy(opts, function (err, resp) {\n      if (err) {\n        return callback(err);\n      }\n      self._destroyed = true;\n      self.emit('destroyed');\n      callback(null, resp || { 'ok': true });\n    });\n  }\n\n  if (isRemote(self)) {\n    // no need to check for dependent DBs if it's a remote DB\n    return destroyDb();\n  }\n\n  self.get('_local/_pouch_dependentDbs', function (err, localDoc) {\n    if (err) {\n      /* istanbul ignore if */\n      if (err.status !== 404) {\n        return callback(err);\n      } else { // no dependencies\n        return destroyDb();\n      }\n    }\n    var dependentDbs = localDoc.dependentDbs;\n    var PouchDB = self.constructor;\n    var deletedMap = Object.keys(dependentDbs).map(function (name) {\n      // use_prefix is only false in the browser\n      /* istanbul ignore next */\n      var trueName = usePrefix ?\n        name.replace(new RegExp('^' + PouchDB.prefix), '') : name;\n      return new PouchDB(trueName, self.__opts).destroy();\n    });\n    Promise.all(deletedMap).then(destroyDb, callback);\n  });\n});\n\nfunction TaskQueue() {\n  this.isReady = false;\n  this.failed = false;\n  this.queue = [];\n}\n\nTaskQueue.prototype.execute = function () {\n  var fun;\n  if (this.failed) {\n    while ((fun = this.queue.shift())) {\n      fun(this.failed);\n    }\n  } else {\n    while ((fun = this.queue.shift())) {\n      fun();\n    }\n  }\n};\n\nTaskQueue.prototype.fail = function (err) {\n  this.failed = err;\n  this.execute();\n};\n\nTaskQueue.prototype.ready = function (db) {\n  this.isReady = true;\n  this.db = db;\n  this.execute();\n};\n\nTaskQueue.prototype.addTask = function (fun) {\n  this.queue.push(fun);\n  if (this.failed) {\n    this.execute();\n  }\n};\n\nfunction parseAdapter(name, opts) {\n  var match = name.match(/([a-z-]*):\\/\\/(.*)/);\n  if (match) {\n    // the http adapter expects the fully qualified name\n    return {\n      name: /https?/.test(match[1]) ? match[1] + '://' + match[2] : match[2],\n      adapter: match[1]\n    };\n  }\n\n  var adapters = PouchDB.adapters;\n  var preferredAdapters = PouchDB.preferredAdapters;\n  var prefix = PouchDB.prefix;\n  var adapterName = opts.adapter;\n\n  if (!adapterName) { // automatically determine adapter\n    for (var i = 0; i < preferredAdapters.length; ++i) {\n      adapterName = preferredAdapters[i];\n      // check for browsers that have been upgraded from websql-only to websql+idb\n      /* istanbul ignore if */\n      if (adapterName === 'idb' && 'websql' in adapters &&\n          hasLocalStorage() && localStorage['_pouch__websqldb_' + prefix + name]) {\n        // log it, because this can be confusing during development\n        guardedConsole('log', 'PouchDB is downgrading \"' + name + '\" to WebSQL to' +\n          ' avoid data loss, because it was already opened with WebSQL.');\n        continue; // keep using websql to avoid user data loss\n      }\n      break;\n    }\n  }\n\n  var adapter = adapters[adapterName];\n\n  // if adapter is invalid, then an error will be thrown later\n  var usePrefix = (adapter && 'use_prefix' in adapter) ?\n    adapter.use_prefix : true;\n\n  return {\n    name: usePrefix ? (prefix + name) : name,\n    adapter: adapterName\n  };\n}\n\n// OK, so here's the deal. Consider this code:\n//     var db1 = new PouchDB('foo');\n//     var db2 = new PouchDB('foo');\n//     db1.destroy();\n// ^ these two both need to emit 'destroyed' events,\n// as well as the PouchDB constructor itself.\n// So we have one db object (whichever one got destroy() called on it)\n// responsible for emitting the initial event, which then gets emitted\n// by the constructor, which then broadcasts it to any other dbs\n// that may have been created with the same name.\nfunction prepareForDestruction(self) {\n\n  function onDestroyed(from_constructor) {\n    self.removeListener('closed', onClosed);\n    if (!from_constructor) {\n      self.constructor.emit('destroyed', self.name);\n    }\n  }\n\n  function onClosed() {\n    self.removeListener('destroyed', onDestroyed);\n    self.constructor.emit('unref', self);\n  }\n\n  self.once('destroyed', onDestroyed);\n  self.once('closed', onClosed);\n  self.constructor.emit('ref', self);\n}\n\ninherits(PouchDB, AbstractPouchDB);\nfunction PouchDB(name, opts) {\n  // In Node our test suite only tests this for PouchAlt unfortunately\n  /* istanbul ignore if */\n  if (!(this instanceof PouchDB)) {\n    return new PouchDB(name, opts);\n  }\n\n  var self = this;\n  opts = opts || {};\n\n  if (name && typeof name === 'object') {\n    opts = name;\n    name = opts.name;\n    delete opts.name;\n  }\n\n  if (opts.deterministic_revs === undefined) {\n    opts.deterministic_revs = true;\n  }\n\n  this.__opts = opts = clone(opts);\n\n  self.auto_compaction = opts.auto_compaction;\n  self.prefix = PouchDB.prefix;\n\n  if (typeof name !== 'string') {\n    throw new Error('Missing/invalid DB name');\n  }\n\n  var prefixedName = (opts.prefix || '') + name;\n  var backend = parseAdapter(prefixedName, opts);\n\n  opts.name = backend.name;\n  opts.adapter = opts.adapter || backend.adapter;\n\n  self.name = name;\n  self._adapter = opts.adapter;\n  PouchDB.emit('debug', ['adapter', 'Picked adapter: ', opts.adapter]);\n\n  if (!PouchDB.adapters[opts.adapter] ||\n      !PouchDB.adapters[opts.adapter].valid()) {\n    throw new Error('Invalid Adapter: ' + opts.adapter);\n  }\n\n  AbstractPouchDB.call(self);\n  self.taskqueue = new TaskQueue();\n\n  self.adapter = opts.adapter;\n\n  PouchDB.adapters[opts.adapter].call(self, opts, function (err) {\n    if (err) {\n      return self.taskqueue.fail(err);\n    }\n    prepareForDestruction(self);\n\n    self.emit('created', self);\n    PouchDB.emit('created', self.name);\n    self.taskqueue.ready(self);\n  });\n\n}\n\n// AbortController was introduced quite a while after fetch and\n// isnt required for PouchDB to function so polyfill if needed\nvar a = (typeof AbortController !== 'undefined')\n    ? AbortController\n    : function () { return {abort: function () {}}; };\n\nvar f$1 = fetch;\nvar h = Headers;\n\nPouchDB.adapters = {};\nPouchDB.preferredAdapters = [];\n\nPouchDB.prefix = '_pouch_';\n\nvar eventEmitter = new EventEmitter();\n\nfunction setUpEventEmitter(Pouch) {\n  Object.keys(EventEmitter.prototype).forEach(function (key) {\n    if (typeof EventEmitter.prototype[key] === 'function') {\n      Pouch[key] = eventEmitter[key].bind(eventEmitter);\n    }\n  });\n\n  // these are created in constructor.js, and allow us to notify each DB with\n  // the same name that it was destroyed, via the constructor object\n  var destructListeners = Pouch._destructionListeners = new ExportedMap();\n\n  Pouch.on('ref', function onConstructorRef(db) {\n    if (!destructListeners.has(db.name)) {\n      destructListeners.set(db.name, []);\n    }\n    destructListeners.get(db.name).push(db);\n  });\n\n  Pouch.on('unref', function onConstructorUnref(db) {\n    if (!destructListeners.has(db.name)) {\n      return;\n    }\n    var dbList = destructListeners.get(db.name);\n    var pos = dbList.indexOf(db);\n    if (pos < 0) {\n      /* istanbul ignore next */\n      return;\n    }\n    dbList.splice(pos, 1);\n    if (dbList.length > 1) {\n      /* istanbul ignore next */\n      destructListeners.set(db.name, dbList);\n    } else {\n      destructListeners.delete(db.name);\n    }\n  });\n\n  Pouch.on('destroyed', function onConstructorDestroyed(name) {\n    if (!destructListeners.has(name)) {\n      return;\n    }\n    var dbList = destructListeners.get(name);\n    destructListeners.delete(name);\n    dbList.forEach(function (db) {\n      db.emit('destroyed',true);\n    });\n  });\n}\n\nsetUpEventEmitter(PouchDB);\n\nPouchDB.adapter = function (id, obj, addToPreferredAdapters) {\n  /* istanbul ignore else */\n  if (obj.valid()) {\n    PouchDB.adapters[id] = obj;\n    if (addToPreferredAdapters) {\n      PouchDB.preferredAdapters.push(id);\n    }\n  }\n};\n\nPouchDB.plugin = function (obj) {\n  if (typeof obj === 'function') { // function style for plugins\n    obj(PouchDB);\n  } else if (typeof obj !== 'object' || Object.keys(obj).length === 0) {\n    throw new Error('Invalid plugin: got \"' + obj + '\", expected an object or a function');\n  } else {\n    Object.keys(obj).forEach(function (id) { // object style for plugins\n      PouchDB.prototype[id] = obj[id];\n    });\n  }\n  if (this.__defaults) {\n    PouchDB.__defaults = $inject_Object_assign({}, this.__defaults);\n  }\n  return PouchDB;\n};\n\nPouchDB.defaults = function (defaultOpts) {\n  function PouchAlt(name, opts) {\n    if (!(this instanceof PouchAlt)) {\n      return new PouchAlt(name, opts);\n    }\n\n    opts = opts || {};\n\n    if (name && typeof name === 'object') {\n      opts = name;\n      name = opts.name;\n      delete opts.name;\n    }\n\n    opts = $inject_Object_assign({}, PouchAlt.__defaults, opts);\n    PouchDB.call(this, name, opts);\n  }\n\n  inherits(PouchAlt, PouchDB);\n\n  PouchAlt.preferredAdapters = PouchDB.preferredAdapters.slice();\n  Object.keys(PouchDB).forEach(function (key) {\n    if (!(key in PouchAlt)) {\n      PouchAlt[key] = PouchDB[key];\n    }\n  });\n\n  // make default options transitive\n  // https://github.com/pouchdb/pouchdb/issues/5922\n  PouchAlt.__defaults = $inject_Object_assign({}, this.__defaults, defaultOpts);\n\n  return PouchAlt;\n};\n\nPouchDB.fetch = function (url, opts) {\n  return f$1(url, opts);\n};\n\n// managed automatically by set-version.js\nvar version = \"7.1.1\";\n\n// this would just be \"return doc[field]\", but fields\n// can be \"deep\" due to dot notation\nfunction getFieldFromDoc(doc, parsedField) {\n  var value = doc;\n  for (var i = 0, len = parsedField.length; i < len; i++) {\n    var key = parsedField[i];\n    value = value[key];\n    if (!value) {\n      break;\n    }\n  }\n  return value;\n}\n\nfunction compare$1(left, right) {\n  return left < right ? -1 : left > right ? 1 : 0;\n}\n\n// Converts a string in dot notation to an array of its components, with backslash escaping\nfunction parseField(fieldName) {\n  // fields may be deep (e.g. \"foo.bar.baz\"), so parse\n  var fields = [];\n  var current = '';\n  for (var i = 0, len = fieldName.length; i < len; i++) {\n    var ch = fieldName[i];\n    if (ch === '.') {\n      if (i > 0 && fieldName[i - 1] === '\\\\') { // escaped delimiter\n        current = current.substring(0, current.length - 1) + '.';\n      } else { // not escaped, so delimiter\n        fields.push(current);\n        current = '';\n      }\n    } else { // normal character\n      current += ch;\n    }\n  }\n  fields.push(current);\n  return fields;\n}\n\nvar combinationFields = ['$or', '$nor', '$not'];\nfunction isCombinationalField(field) {\n  return combinationFields.indexOf(field) > -1;\n}\n\nfunction getKey(obj) {\n  return Object.keys(obj)[0];\n}\n\nfunction getValue(obj) {\n  return obj[getKey(obj)];\n}\n\n\n// flatten an array of selectors joined by an $and operator\nfunction mergeAndedSelectors(selectors) {\n\n  // sort to ensure that e.g. if the user specified\n  // $and: [{$gt: 'a'}, {$gt: 'b'}], then it's collapsed into\n  // just {$gt: 'b'}\n  var res = {};\n\n  selectors.forEach(function (selector) {\n    Object.keys(selector).forEach(function (field) {\n      var matcher = selector[field];\n      if (typeof matcher !== 'object') {\n        matcher = {$eq: matcher};\n      }\n\n      if (isCombinationalField(field)) {\n        if (matcher instanceof Array) {\n          res[field] = matcher.map(function (m) {\n            return mergeAndedSelectors([m]);\n          });\n        } else {\n          res[field] = mergeAndedSelectors([matcher]);\n        }\n      } else {\n        var fieldMatchers = res[field] = res[field] || {};\n        Object.keys(matcher).forEach(function (operator) {\n          var value = matcher[operator];\n\n          if (operator === '$gt' || operator === '$gte') {\n            return mergeGtGte(operator, value, fieldMatchers);\n          } else if (operator === '$lt' || operator === '$lte') {\n            return mergeLtLte(operator, value, fieldMatchers);\n          } else if (operator === '$ne') {\n            return mergeNe(value, fieldMatchers);\n          } else if (operator === '$eq') {\n            return mergeEq(value, fieldMatchers);\n          }\n          fieldMatchers[operator] = value;\n        });\n      }\n    });\n  });\n\n  return res;\n}\n\n\n\n// collapse logically equivalent gt/gte values\nfunction mergeGtGte(operator, value, fieldMatchers) {\n  if (typeof fieldMatchers.$eq !== 'undefined') {\n    return; // do nothing\n  }\n  if (typeof fieldMatchers.$gte !== 'undefined') {\n    if (operator === '$gte') {\n      if (value > fieldMatchers.$gte) { // more specificity\n        fieldMatchers.$gte = value;\n      }\n    } else { // operator === '$gt'\n      if (value >= fieldMatchers.$gte) { // more specificity\n        delete fieldMatchers.$gte;\n        fieldMatchers.$gt = value;\n      }\n    }\n  } else if (typeof fieldMatchers.$gt !== 'undefined') {\n    if (operator === '$gte') {\n      if (value > fieldMatchers.$gt) { // more specificity\n        delete fieldMatchers.$gt;\n        fieldMatchers.$gte = value;\n      }\n    } else { // operator === '$gt'\n      if (value > fieldMatchers.$gt) { // more specificity\n        fieldMatchers.$gt = value;\n      }\n    }\n  } else {\n    fieldMatchers[operator] = value;\n  }\n}\n\n// collapse logically equivalent lt/lte values\nfunction mergeLtLte(operator, value, fieldMatchers) {\n  if (typeof fieldMatchers.$eq !== 'undefined') {\n    return; // do nothing\n  }\n  if (typeof fieldMatchers.$lte !== 'undefined') {\n    if (operator === '$lte') {\n      if (value < fieldMatchers.$lte) { // more specificity\n        fieldMatchers.$lte = value;\n      }\n    } else { // operator === '$gt'\n      if (value <= fieldMatchers.$lte) { // more specificity\n        delete fieldMatchers.$lte;\n        fieldMatchers.$lt = value;\n      }\n    }\n  } else if (typeof fieldMatchers.$lt !== 'undefined') {\n    if (operator === '$lte') {\n      if (value < fieldMatchers.$lt) { // more specificity\n        delete fieldMatchers.$lt;\n        fieldMatchers.$lte = value;\n      }\n    } else { // operator === '$gt'\n      if (value < fieldMatchers.$lt) { // more specificity\n        fieldMatchers.$lt = value;\n      }\n    }\n  } else {\n    fieldMatchers[operator] = value;\n  }\n}\n\n// combine $ne values into one array\nfunction mergeNe(value, fieldMatchers) {\n  if ('$ne' in fieldMatchers) {\n    // there are many things this could \"not\" be\n    fieldMatchers.$ne.push(value);\n  } else { // doesn't exist yet\n    fieldMatchers.$ne = [value];\n  }\n}\n\n// add $eq into the mix\nfunction mergeEq(value, fieldMatchers) {\n  // these all have less specificity than the $eq\n  // TODO: check for user errors here\n  delete fieldMatchers.$gt;\n  delete fieldMatchers.$gte;\n  delete fieldMatchers.$lt;\n  delete fieldMatchers.$lte;\n  delete fieldMatchers.$ne;\n  fieldMatchers.$eq = value;\n}\n\n//#7458: execute function mergeAndedSelectors on nested $and\nfunction mergeAndedSelectorsNested(obj) {\n    for (var prop in obj) {\n        if (Array.isArray(obj)) {\n            for (var i in obj) {\n                if (obj[i]['$and']) {\n                    obj[i] = mergeAndedSelectors(obj[i]['$and']);\n                }\n            }\n        }\n        var value = obj[prop];\n        if (typeof value === 'object') {\n            mergeAndedSelectorsNested(value); // <- recursive call\n        }\n    }\n    return obj;\n}\n\n//#7458: determine id $and is present in selector (at any level)\nfunction isAndInSelector(obj, isAnd) {\n    for (var prop in obj) {\n        if (prop === '$and') {\n            isAnd = true;\n        }\n        var value = obj[prop];\n        if (typeof value === 'object') {\n            isAnd = isAndInSelector(value, isAnd); // <- recursive call\n        }\n    }\n    return isAnd;\n}\n\n//\n// normalize the selector\n//\nfunction massageSelector(input) {\n  var result = clone(input);\n  var wasAnded = false;\n    //#7458: if $and is present in selector (at any level) merge nested $and\n    if (isAndInSelector(result, false)) {\n        result = mergeAndedSelectorsNested(result);\n        if ('$and' in result) {\n            result = mergeAndedSelectors(result['$and']);\n        }\n        wasAnded = true;\n    }\n\n  ['$or', '$nor'].forEach(function (orOrNor) {\n    if (orOrNor in result) {\n      // message each individual selector\n      // e.g. {foo: 'bar'} becomes {foo: {$eq: 'bar'}}\n      result[orOrNor].forEach(function (subSelector) {\n        var fields = Object.keys(subSelector);\n        for (var i = 0; i < fields.length; i++) {\n          var field = fields[i];\n          var matcher = subSelector[field];\n          if (typeof matcher !== 'object' || matcher === null) {\n            subSelector[field] = {$eq: matcher};\n          }\n        }\n      });\n    }\n  });\n\n  if ('$not' in result) {\n    //This feels a little like forcing, but it will work for now,\n    //I would like to come back to this and make the merging of selectors a little more generic\n    result['$not'] = mergeAndedSelectors([result['$not']]);\n  }\n\n  var fields = Object.keys(result);\n\n  for (var i = 0; i < fields.length; i++) {\n    var field = fields[i];\n    var matcher = result[field];\n\n    if (typeof matcher !== 'object' || matcher === null) {\n      matcher = {$eq: matcher};\n    } else if ('$ne' in matcher && !wasAnded) {\n      // I put these in an array, since there may be more than one\n      // but in the \"mergeAnded\" operation, I already take care of that\n      matcher.$ne = [matcher.$ne];\n    }\n    result[field] = matcher;\n  }\n\n  return result;\n}\n\nfunction pad(str, padWith, upToLength) {\n  var padding = '';\n  var targetLength = upToLength - str.length;\n  /* istanbul ignore next */\n  while (padding.length < targetLength) {\n    padding += padWith;\n  }\n  return padding;\n}\n\nfunction padLeft(str, padWith, upToLength) {\n  var padding = pad(str, padWith, upToLength);\n  return padding + str;\n}\n\nvar MIN_MAGNITUDE = -324; // verified by -Number.MIN_VALUE\nvar MAGNITUDE_DIGITS = 3; // ditto\nvar SEP = ''; // set to '_' for easier debugging \n\nfunction collate(a, b) {\n\n  if (a === b) {\n    return 0;\n  }\n\n  a = normalizeKey(a);\n  b = normalizeKey(b);\n\n  var ai = collationIndex(a);\n  var bi = collationIndex(b);\n  if ((ai - bi) !== 0) {\n    return ai - bi;\n  }\n  switch (typeof a) {\n    case 'number':\n      return a - b;\n    case 'boolean':\n      return a < b ? -1 : 1;\n    case 'string':\n      return stringCollate(a, b);\n  }\n  return Array.isArray(a) ? arrayCollate(a, b) : objectCollate(a, b);\n}\n\n// couch considers null/NaN/Infinity/-Infinity === undefined,\n// for the purposes of mapreduce indexes. also, dates get stringified.\nfunction normalizeKey(key) {\n  switch (typeof key) {\n    case 'undefined':\n      return null;\n    case 'number':\n      if (key === Infinity || key === -Infinity || isNaN(key)) {\n        return null;\n      }\n      return key;\n    case 'object':\n      var origKey = key;\n      if (Array.isArray(key)) {\n        var len = key.length;\n        key = new Array(len);\n        for (var i = 0; i < len; i++) {\n          key[i] = normalizeKey(origKey[i]);\n        }\n      /* istanbul ignore next */\n      } else if (key instanceof Date) {\n        return key.toJSON();\n      } else if (key !== null) { // generic object\n        key = {};\n        for (var k in origKey) {\n          if (origKey.hasOwnProperty(k)) {\n            var val = origKey[k];\n            if (typeof val !== 'undefined') {\n              key[k] = normalizeKey(val);\n            }\n          }\n        }\n      }\n  }\n  return key;\n}\n\nfunction indexify(key) {\n  if (key !== null) {\n    switch (typeof key) {\n      case 'boolean':\n        return key ? 1 : 0;\n      case 'number':\n        return numToIndexableString(key);\n      case 'string':\n        // We've to be sure that key does not contain \\u0000\n        // Do order-preserving replacements:\n        // 0 -> 1, 1\n        // 1 -> 1, 2\n        // 2 -> 2, 2\n        /* eslint-disable no-control-regex */\n        return key\n          .replace(/\\u0002/g, '\\u0002\\u0002')\n          .replace(/\\u0001/g, '\\u0001\\u0002')\n          .replace(/\\u0000/g, '\\u0001\\u0001');\n        /* eslint-enable no-control-regex */\n      case 'object':\n        var isArray = Array.isArray(key);\n        var arr = isArray ? key : Object.keys(key);\n        var i = -1;\n        var len = arr.length;\n        var result = '';\n        if (isArray) {\n          while (++i < len) {\n            result += toIndexableString(arr[i]);\n          }\n        } else {\n          while (++i < len) {\n            var objKey = arr[i];\n            result += toIndexableString(objKey) +\n                toIndexableString(key[objKey]);\n          }\n        }\n        return result;\n    }\n  }\n  return '';\n}\n\n// convert the given key to a string that would be appropriate\n// for lexical sorting, e.g. within a database, where the\n// sorting is the same given by the collate() function.\nfunction toIndexableString(key) {\n  var zero = '\\u0000';\n  key = normalizeKey(key);\n  return collationIndex(key) + SEP + indexify(key) + zero;\n}\n\nfunction parseNumber(str, i) {\n  var originalIdx = i;\n  var num;\n  var zero = str[i] === '1';\n  if (zero) {\n    num = 0;\n    i++;\n  } else {\n    var neg = str[i] === '0';\n    i++;\n    var numAsString = '';\n    var magAsString = str.substring(i, i + MAGNITUDE_DIGITS);\n    var magnitude = parseInt(magAsString, 10) + MIN_MAGNITUDE;\n    /* istanbul ignore next */\n    if (neg) {\n      magnitude = -magnitude;\n    }\n    i += MAGNITUDE_DIGITS;\n    while (true) {\n      var ch = str[i];\n      if (ch === '\\u0000') {\n        break;\n      } else {\n        numAsString += ch;\n      }\n      i++;\n    }\n    numAsString = numAsString.split('.');\n    if (numAsString.length === 1) {\n      num = parseInt(numAsString, 10);\n    } else {\n      /* istanbul ignore next */\n      num = parseFloat(numAsString[0] + '.' + numAsString[1]);\n    }\n    /* istanbul ignore next */\n    if (neg) {\n      num = num - 10;\n    }\n    /* istanbul ignore next */\n    if (magnitude !== 0) {\n      // parseFloat is more reliable than pow due to rounding errors\n      // e.g. Number.MAX_VALUE would return Infinity if we did\n      // num * Math.pow(10, magnitude);\n      num = parseFloat(num + 'e' + magnitude);\n    }\n  }\n  return {num: num, length : i - originalIdx};\n}\n\n// move up the stack while parsing\n// this function moved outside of parseIndexableString for performance\nfunction pop(stack, metaStack) {\n  var obj = stack.pop();\n\n  if (metaStack.length) {\n    var lastMetaElement = metaStack[metaStack.length - 1];\n    if (obj === lastMetaElement.element) {\n      // popping a meta-element, e.g. an object whose value is another object\n      metaStack.pop();\n      lastMetaElement = metaStack[metaStack.length - 1];\n    }\n    var element = lastMetaElement.element;\n    var lastElementIndex = lastMetaElement.index;\n    if (Array.isArray(element)) {\n      element.push(obj);\n    } else if (lastElementIndex === stack.length - 2) { // obj with key+value\n      var key = stack.pop();\n      element[key] = obj;\n    } else {\n      stack.push(obj); // obj with key only\n    }\n  }\n}\n\nfunction parseIndexableString(str) {\n  var stack = [];\n  var metaStack = []; // stack for arrays and objects\n  var i = 0;\n\n  /*eslint no-constant-condition: [\"error\", { \"checkLoops\": false }]*/\n  while (true) {\n    var collationIndex = str[i++];\n    if (collationIndex === '\\u0000') {\n      if (stack.length === 1) {\n        return stack.pop();\n      } else {\n        pop(stack, metaStack);\n        continue;\n      }\n    }\n    switch (collationIndex) {\n      case '1':\n        stack.push(null);\n        break;\n      case '2':\n        stack.push(str[i] === '1');\n        i++;\n        break;\n      case '3':\n        var parsedNum = parseNumber(str, i);\n        stack.push(parsedNum.num);\n        i += parsedNum.length;\n        break;\n      case '4':\n        var parsedStr = '';\n        /*eslint no-constant-condition: [\"error\", { \"checkLoops\": false }]*/\n        while (true) {\n          var ch = str[i];\n          if (ch === '\\u0000') {\n            break;\n          }\n          parsedStr += ch;\n          i++;\n        }\n        // perform the reverse of the order-preserving replacement\n        // algorithm (see above)\n        /* eslint-disable no-control-regex */\n        parsedStr = parsedStr.replace(/\\u0001\\u0001/g, '\\u0000')\n          .replace(/\\u0001\\u0002/g, '\\u0001')\n          .replace(/\\u0002\\u0002/g, '\\u0002');\n        /* eslint-enable no-control-regex */\n        stack.push(parsedStr);\n        break;\n      case '5':\n        var arrayElement = { element: [], index: stack.length };\n        stack.push(arrayElement.element);\n        metaStack.push(arrayElement);\n        break;\n      case '6':\n        var objElement = { element: {}, index: stack.length };\n        stack.push(objElement.element);\n        metaStack.push(objElement);\n        break;\n      /* istanbul ignore next */\n      default:\n        throw new Error(\n          'bad collationIndex or unexpectedly reached end of input: ' +\n            collationIndex);\n    }\n  }\n}\n\nfunction arrayCollate(a, b) {\n  var len = Math.min(a.length, b.length);\n  for (var i = 0; i < len; i++) {\n    var sort = collate(a[i], b[i]);\n    if (sort !== 0) {\n      return sort;\n    }\n  }\n  return (a.length === b.length) ? 0 :\n    (a.length > b.length) ? 1 : -1;\n}\nfunction stringCollate(a, b) {\n  // See: https://github.com/daleharvey/pouchdb/issues/40\n  // This is incompatible with the CouchDB implementation, but its the\n  // best we can do for now\n  return (a === b) ? 0 : ((a > b) ? 1 : -1);\n}\nfunction objectCollate(a, b) {\n  var ak = Object.keys(a), bk = Object.keys(b);\n  var len = Math.min(ak.length, bk.length);\n  for (var i = 0; i < len; i++) {\n    // First sort the keys\n    var sort = collate(ak[i], bk[i]);\n    if (sort !== 0) {\n      return sort;\n    }\n    // if the keys are equal sort the values\n    sort = collate(a[ak[i]], b[bk[i]]);\n    if (sort !== 0) {\n      return sort;\n    }\n\n  }\n  return (ak.length === bk.length) ? 0 :\n    (ak.length > bk.length) ? 1 : -1;\n}\n// The collation is defined by erlangs ordered terms\n// the atoms null, true, false come first, then numbers, strings,\n// arrays, then objects\n// null/undefined/NaN/Infinity/-Infinity are all considered null\nfunction collationIndex(x) {\n  var id = ['boolean', 'number', 'string', 'object'];\n  var idx = id.indexOf(typeof x);\n  //false if -1 otherwise true, but fast!!!!1\n  if (~idx) {\n    if (x === null) {\n      return 1;\n    }\n    if (Array.isArray(x)) {\n      return 5;\n    }\n    return idx < 3 ? (idx + 2) : (idx + 3);\n  }\n  /* istanbul ignore next */\n  if (Array.isArray(x)) {\n    return 5;\n  }\n}\n\n// conversion:\n// x yyy zz...zz\n// x = 0 for negative, 1 for 0, 2 for positive\n// y = exponent (for negative numbers negated) moved so that it's >= 0\n// z = mantisse\nfunction numToIndexableString(num) {\n\n  if (num === 0) {\n    return '1';\n  }\n\n  // convert number to exponential format for easier and\n  // more succinct string sorting\n  var expFormat = num.toExponential().split(/e\\+?/);\n  var magnitude = parseInt(expFormat[1], 10);\n\n  var neg = num < 0;\n\n  var result = neg ? '0' : '2';\n\n  // first sort by magnitude\n  // it's easier if all magnitudes are positive\n  var magForComparison = ((neg ? -magnitude : magnitude) - MIN_MAGNITUDE);\n  var magString = padLeft((magForComparison).toString(), '0', MAGNITUDE_DIGITS);\n\n  result += SEP + magString;\n\n  // then sort by the factor\n  var factor = Math.abs(parseFloat(expFormat[0])); // [1..10)\n  /* istanbul ignore next */\n  if (neg) { // for negative reverse ordering\n    factor = 10 - factor;\n  }\n\n  var factorStr = factor.toFixed(20);\n\n  // strip zeros from the end\n  factorStr = factorStr.replace(/\\.?0+$/, '');\n\n  result += SEP + factorStr;\n\n  return result;\n}\n\n// create a comparator based on the sort object\nfunction createFieldSorter(sort) {\n\n  function getFieldValuesAsArray(doc) {\n    return sort.map(function (sorting) {\n      var fieldName = getKey(sorting);\n      var parsedField = parseField(fieldName);\n      var docFieldValue = getFieldFromDoc(doc, parsedField);\n      return docFieldValue;\n    });\n  }\n\n  return function (aRow, bRow) {\n    var aFieldValues = getFieldValuesAsArray(aRow.doc);\n    var bFieldValues = getFieldValuesAsArray(bRow.doc);\n    var collation = collate(aFieldValues, bFieldValues);\n    if (collation !== 0) {\n      return collation;\n    }\n    // this is what mango seems to do\n    return compare$1(aRow.doc._id, bRow.doc._id);\n  };\n}\n\nfunction filterInMemoryFields(rows, requestDef, inMemoryFields) {\n  rows = rows.filter(function (row) {\n    return rowFilter(row.doc, requestDef.selector, inMemoryFields);\n  });\n\n  if (requestDef.sort) {\n    // in-memory sort\n    var fieldSorter = createFieldSorter(requestDef.sort);\n    rows = rows.sort(fieldSorter);\n    if (typeof requestDef.sort[0] !== 'string' &&\n        getValue(requestDef.sort[0]) === 'desc') {\n      rows = rows.reverse();\n    }\n  }\n\n  if ('limit' in requestDef || 'skip' in requestDef) {\n    // have to do the limit in-memory\n    var skip = requestDef.skip || 0;\n    var limit = ('limit' in requestDef ? requestDef.limit : rows.length) + skip;\n    rows = rows.slice(skip, limit);\n  }\n  return rows;\n}\n\nfunction rowFilter(doc, selector, inMemoryFields) {\n  return inMemoryFields.every(function (field) {\n    var matcher = selector[field];\n    var parsedField = parseField(field);\n    var docFieldValue = getFieldFromDoc(doc, parsedField);\n    if (isCombinationalField(field)) {\n      return matchCominationalSelector(field, matcher, doc);\n    }\n\n    return matchSelector(matcher, doc, parsedField, docFieldValue);\n  });\n}\n\nfunction matchSelector(matcher, doc, parsedField, docFieldValue) {\n  if (!matcher) {\n    // no filtering necessary; this field is just needed for sorting\n    return true;\n  }\n\n  // is matcher an object, if so continue recursion\n  if (typeof matcher === 'object') {\n    return Object.keys(matcher).every(function (userOperator) {\n      var userValue = matcher[userOperator];\n      return match(userOperator, doc, userValue, parsedField, docFieldValue);\n    });\n  }\n\n  // no more depth, No need to recurse further\n  return matcher === docFieldValue;\n}\n\nfunction matchCominationalSelector(field, matcher, doc) {\n\n  if (field === '$or') {\n    return matcher.some(function (orMatchers) {\n      return rowFilter(doc, orMatchers, Object.keys(orMatchers));\n    });\n  }\n\n  if (field === '$not') {\n    return !rowFilter(doc, matcher, Object.keys(matcher));\n  }\n\n  //`$nor`\n  return !matcher.find(function (orMatchers) {\n    return rowFilter(doc, orMatchers, Object.keys(orMatchers));\n  });\n\n}\n\nfunction match(userOperator, doc, userValue, parsedField, docFieldValue) {\n  if (!matchers[userOperator]) {\n    throw new Error('unknown operator \"' + userOperator +\n      '\" - should be one of $eq, $lte, $lt, $gt, $gte, $exists, $ne, $in, ' +\n      '$nin, $size, $mod, $regex, $elemMatch, $type, $allMatch or $all');\n  }\n  return matchers[userOperator](doc, userValue, parsedField, docFieldValue);\n}\n\nfunction fieldExists(docFieldValue) {\n  return typeof docFieldValue !== 'undefined' && docFieldValue !== null;\n}\n\nfunction fieldIsNotUndefined(docFieldValue) {\n  return typeof docFieldValue !== 'undefined';\n}\n\nfunction modField(docFieldValue, userValue) {\n  var divisor = userValue[0];\n  var mod = userValue[1];\n  if (divisor === 0) {\n    throw new Error('Bad divisor, cannot divide by zero');\n  }\n\n  if (parseInt(divisor, 10) !== divisor ) {\n    throw new Error('Divisor is not an integer');\n  }\n\n  if (parseInt(mod, 10) !== mod ) {\n    throw new Error('Modulus is not an integer');\n  }\n\n  if (parseInt(docFieldValue, 10) !== docFieldValue) {\n    return false;\n  }\n\n  return docFieldValue % divisor === mod;\n}\n\nfunction arrayContainsValue(docFieldValue, userValue) {\n  return userValue.some(function (val) {\n    if (docFieldValue instanceof Array) {\n      return docFieldValue.indexOf(val) > -1;\n    }\n\n    return docFieldValue === val;\n  });\n}\n\nfunction arrayContainsAllValues(docFieldValue, userValue) {\n  return userValue.every(function (val) {\n    return docFieldValue.indexOf(val) > -1;\n  });\n}\n\nfunction arraySize(docFieldValue, userValue) {\n  return docFieldValue.length === userValue;\n}\n\nfunction regexMatch(docFieldValue, userValue) {\n  var re = new RegExp(userValue);\n\n  return re.test(docFieldValue);\n}\n\nfunction typeMatch(docFieldValue, userValue) {\n\n  switch (userValue) {\n    case 'null':\n      return docFieldValue === null;\n    case 'boolean':\n      return typeof (docFieldValue) === 'boolean';\n    case 'number':\n      return typeof (docFieldValue) === 'number';\n    case 'string':\n      return typeof (docFieldValue) === 'string';\n    case 'array':\n      return docFieldValue instanceof Array;\n    case 'object':\n      return ({}).toString.call(docFieldValue) === '[object Object]';\n  }\n\n  throw new Error(userValue + ' not supported as a type.' +\n                  'Please use one of object, string, array, number, boolean or null.');\n\n}\n\nvar matchers = {\n\n  '$elemMatch': function (doc, userValue, parsedField, docFieldValue) {\n    if (!Array.isArray(docFieldValue)) {\n      return false;\n    }\n\n    if (docFieldValue.length === 0) {\n      return false;\n    }\n\n    if (typeof docFieldValue[0] === 'object') {\n      return docFieldValue.some(function (val) {\n        return rowFilter(val, userValue, Object.keys(userValue));\n      });\n    }\n\n    return docFieldValue.some(function (val) {\n      return matchSelector(userValue, doc, parsedField, val);\n    });\n  },\n\n  '$allMatch': function (doc, userValue, parsedField, docFieldValue) {\n    if (!Array.isArray(docFieldValue)) {\n      return false;\n    }\n\n    /* istanbul ignore next */\n    if (docFieldValue.length === 0) {\n      return false;\n    }\n\n    if (typeof docFieldValue[0] === 'object') {\n      return docFieldValue.every(function (val) {\n        return rowFilter(val, userValue, Object.keys(userValue));\n      });\n    }\n\n    return docFieldValue.every(function (val) {\n      return matchSelector(userValue, doc, parsedField, val);\n    });\n  },\n\n  '$eq': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldIsNotUndefined(docFieldValue) && collate(docFieldValue, userValue) === 0;\n  },\n\n  '$gte': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldIsNotUndefined(docFieldValue) && collate(docFieldValue, userValue) >= 0;\n  },\n\n  '$gt': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldIsNotUndefined(docFieldValue) && collate(docFieldValue, userValue) > 0;\n  },\n\n  '$lte': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldIsNotUndefined(docFieldValue) && collate(docFieldValue, userValue) <= 0;\n  },\n\n  '$lt': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldIsNotUndefined(docFieldValue) && collate(docFieldValue, userValue) < 0;\n  },\n\n  '$exists': function (doc, userValue, parsedField, docFieldValue) {\n    //a field that is null is still considered to exist\n    if (userValue) {\n      return fieldIsNotUndefined(docFieldValue);\n    }\n\n    return !fieldIsNotUndefined(docFieldValue);\n  },\n\n  '$mod': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldExists(docFieldValue) && modField(docFieldValue, userValue);\n  },\n\n  '$ne': function (doc, userValue, parsedField, docFieldValue) {\n    return userValue.every(function (neValue) {\n      return collate(docFieldValue, neValue) !== 0;\n    });\n  },\n  '$in': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldExists(docFieldValue) && arrayContainsValue(docFieldValue, userValue);\n  },\n\n  '$nin': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldExists(docFieldValue) && !arrayContainsValue(docFieldValue, userValue);\n  },\n\n  '$size': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldExists(docFieldValue) && arraySize(docFieldValue, userValue);\n  },\n\n  '$all': function (doc, userValue, parsedField, docFieldValue) {\n    return Array.isArray(docFieldValue) && arrayContainsAllValues(docFieldValue, userValue);\n  },\n\n  '$regex': function (doc, userValue, parsedField, docFieldValue) {\n    return fieldExists(docFieldValue) && regexMatch(docFieldValue, userValue);\n  },\n\n  '$type': function (doc, userValue, parsedField, docFieldValue) {\n    return typeMatch(docFieldValue, userValue);\n  }\n};\n\n// return true if the given doc matches the supplied selector\nfunction matchesSelector(doc, selector) {\n  /* istanbul ignore if */\n  if (typeof selector !== 'object') {\n    // match the CouchDB error message\n    throw new Error('Selector error: expected a JSON object');\n  }\n\n  selector = massageSelector(selector);\n  var row = {\n    'doc': doc\n  };\n\n  var rowsMatched = filterInMemoryFields([row], { 'selector': selector }, Object.keys(selector));\n  return rowsMatched && rowsMatched.length === 1;\n}\n\nfunction evalFilter(input) {\n  return scopeEval('\"use strict\";\\nreturn ' + input + ';', {});\n}\n\nfunction evalView(input) {\n  var code = [\n    'return function(doc) {',\n    '  \"use strict\";',\n    '  var emitted = false;',\n    '  var emit = function (a, b) {',\n    '    emitted = true;',\n    '  };',\n    '  var view = ' + input + ';',\n    '  view(doc);',\n    '  if (emitted) {',\n    '    return true;',\n    '  }',\n    '};'\n  ].join('\\n');\n\n  return scopeEval(code, {});\n}\n\nfunction validate(opts, callback) {\n  if (opts.selector) {\n    if (opts.filter && opts.filter !== '_selector') {\n      var filterName = typeof opts.filter === 'string' ?\n        opts.filter : 'function';\n      return callback(new Error('selector invalid for filter \"' + filterName + '\"'));\n    }\n  }\n  callback();\n}\n\nfunction normalize(opts) {\n  if (opts.view && !opts.filter) {\n    opts.filter = '_view';\n  }\n\n  if (opts.selector && !opts.filter) {\n    opts.filter = '_selector';\n  }\n\n  if (opts.filter && typeof opts.filter === 'string') {\n    if (opts.filter === '_view') {\n      opts.view = normalizeDesignDocFunctionName(opts.view);\n    } else {\n      opts.filter = normalizeDesignDocFunctionName(opts.filter);\n    }\n  }\n}\n\nfunction shouldFilter(changesHandler, opts) {\n  return opts.filter && typeof opts.filter === 'string' &&\n    !opts.doc_ids && !isRemote(changesHandler.db);\n}\n\nfunction filter(changesHandler, opts) {\n  var callback = opts.complete;\n  if (opts.filter === '_view') {\n    if (!opts.view || typeof opts.view !== 'string') {\n      var err = createError(BAD_REQUEST,\n        '`view` filter parameter not found or invalid.');\n      return callback(err);\n    }\n    // fetch a view from a design doc, make it behave like a filter\n    var viewName = parseDesignDocFunctionName(opts.view);\n    changesHandler.db.get('_design/' + viewName[0], function (err, ddoc) {\n      /* istanbul ignore if */\n      if (changesHandler.isCancelled) {\n        return callback(null, {status: 'cancelled'});\n      }\n      /* istanbul ignore next */\n      if (err) {\n        return callback(generateErrorFromResponse(err));\n      }\n      var mapFun = ddoc && ddoc.views && ddoc.views[viewName[1]] &&\n        ddoc.views[viewName[1]].map;\n      if (!mapFun) {\n        return callback(createError(MISSING_DOC,\n          (ddoc.views ? 'missing json key: ' + viewName[1] :\n            'missing json key: views')));\n      }\n      opts.filter = evalView(mapFun);\n      changesHandler.doChanges(opts);\n    });\n  } else if (opts.selector) {\n    opts.filter = function (doc) {\n      return matchesSelector(doc, opts.selector);\n    };\n    changesHandler.doChanges(opts);\n  } else {\n    // fetch a filter from a design doc\n    var filterName = parseDesignDocFunctionName(opts.filter);\n    changesHandler.db.get('_design/' + filterName[0], function (err, ddoc) {\n      /* istanbul ignore if */\n      if (changesHandler.isCancelled) {\n        return callback(null, {status: 'cancelled'});\n      }\n      /* istanbul ignore next */\n      if (err) {\n        return callback(generateErrorFromResponse(err));\n      }\n      var filterFun = ddoc && ddoc.filters && ddoc.filters[filterName[1]];\n      if (!filterFun) {\n        return callback(createError(MISSING_DOC,\n          ((ddoc && ddoc.filters) ? 'missing json key: ' + filterName[1]\n            : 'missing json key: filters')));\n      }\n      opts.filter = evalFilter(filterFun);\n      changesHandler.doChanges(opts);\n    });\n  }\n}\n\nfunction applyChangesFilterPlugin(PouchDB) {\n  PouchDB._changesFilterPlugin = {\n    validate: validate,\n    normalize: normalize,\n    shouldFilter: shouldFilter,\n    filter: filter\n  };\n}\n\n// TODO: remove from pouchdb-core (breaking)\nPouchDB.plugin(applyChangesFilterPlugin);\n\nPouchDB.version = version;\n\nfunction toObject(array) {\n  return array.reduce(function (obj, item) {\n    obj[item] = true;\n    return obj;\n  }, {});\n}\n// List of top level reserved words for doc\nvar reservedWords = toObject([\n  '_id',\n  '_rev',\n  '_attachments',\n  '_deleted',\n  '_revisions',\n  '_revs_info',\n  '_conflicts',\n  '_deleted_conflicts',\n  '_local_seq',\n  '_rev_tree',\n  //replication documents\n  '_replication_id',\n  '_replication_state',\n  '_replication_state_time',\n  '_replication_state_reason',\n  '_replication_stats',\n  // Specific to Couchbase Sync Gateway\n  '_removed'\n]);\n\n// List of reserved words that should end up the document\nvar dataWords = toObject([\n  '_attachments',\n  //replication documents\n  '_replication_id',\n  '_replication_state',\n  '_replication_state_time',\n  '_replication_state_reason',\n  '_replication_stats'\n]);\n\nfunction parseRevisionInfo(rev$$1) {\n  if (!/^\\d+-./.test(rev$$1)) {\n    return createError(INVALID_REV);\n  }\n  var idx = rev$$1.indexOf('-');\n  var left = rev$$1.substring(0, idx);\n  var right = rev$$1.substring(idx + 1);\n  return {\n    prefix: parseInt(left, 10),\n    id: right\n  };\n}\n\nfunction makeRevTreeFromRevisions(revisions, opts) {\n  var pos = revisions.start - revisions.ids.length + 1;\n\n  var revisionIds = revisions.ids;\n  var ids = [revisionIds[0], opts, []];\n\n  for (var i = 1, len = revisionIds.length; i < len; i++) {\n    ids = [revisionIds[i], {status: 'missing'}, [ids]];\n  }\n\n  return [{\n    pos: pos,\n    ids: ids\n  }];\n}\n\n// Preprocess documents, parse their revisions, assign an id and a\n// revision for new writes that are missing them, etc\nfunction parseDoc(doc, newEdits, dbOpts) {\n  if (!dbOpts) {\n    dbOpts = {\n      deterministic_revs: true\n    };\n  }\n\n  var nRevNum;\n  var newRevId;\n  var revInfo;\n  var opts = {status: 'available'};\n  if (doc._deleted) {\n    opts.deleted = true;\n  }\n\n  if (newEdits) {\n    if (!doc._id) {\n      doc._id = uuid();\n    }\n    newRevId = rev(doc, dbOpts.deterministic_revs);\n    if (doc._rev) {\n      revInfo = parseRevisionInfo(doc._rev);\n      if (revInfo.error) {\n        return revInfo;\n      }\n      doc._rev_tree = [{\n        pos: revInfo.prefix,\n        ids: [revInfo.id, {status: 'missing'}, [[newRevId, opts, []]]]\n      }];\n      nRevNum = revInfo.prefix + 1;\n    } else {\n      doc._rev_tree = [{\n        pos: 1,\n        ids : [newRevId, opts, []]\n      }];\n      nRevNum = 1;\n    }\n  } else {\n    if (doc._revisions) {\n      doc._rev_tree = makeRevTreeFromRevisions(doc._revisions, opts);\n      nRevNum = doc._revisions.start;\n      newRevId = doc._revisions.ids[0];\n    }\n    if (!doc._rev_tree) {\n      revInfo = parseRevisionInfo(doc._rev);\n      if (revInfo.error) {\n        return revInfo;\n      }\n      nRevNum = revInfo.prefix;\n      newRevId = revInfo.id;\n      doc._rev_tree = [{\n        pos: nRevNum,\n        ids: [newRevId, opts, []]\n      }];\n    }\n  }\n\n  invalidIdError(doc._id);\n\n  doc._rev = nRevNum + '-' + newRevId;\n\n  var result = {metadata : {}, data : {}};\n  for (var key in doc) {\n    /* istanbul ignore else */\n    if (Object.prototype.hasOwnProperty.call(doc, key)) {\n      var specialKey = key[0] === '_';\n      if (specialKey && !reservedWords[key]) {\n        var error = createError(DOC_VALIDATION, key);\n        error.message = DOC_VALIDATION.message + ': ' + key;\n        throw error;\n      } else if (specialKey && !dataWords[key]) {\n        result.metadata[key.slice(1)] = doc[key];\n      } else {\n        result.data[key] = doc[key];\n      }\n    }\n  }\n  return result;\n}\n\nfunction parseBase64(data) {\n  try {\n    return thisAtob(data);\n  } catch (e) {\n    var err = createError(BAD_ARG,\n      'Attachment is not a valid base64 string');\n    return {error: err};\n  }\n}\n\nfunction preprocessString(att, blobType, callback) {\n  var asBinary = parseBase64(att.data);\n  if (asBinary.error) {\n    return callback(asBinary.error);\n  }\n\n  att.length = asBinary.length;\n  if (blobType === 'blob') {\n    att.data = binStringToBluffer(asBinary, att.content_type);\n  } else if (blobType === 'base64') {\n    att.data = thisBtoa(asBinary);\n  } else { // binary\n    att.data = asBinary;\n  }\n  binaryMd5(asBinary, function (result) {\n    att.digest = 'md5-' + result;\n    callback();\n  });\n}\n\nfunction preprocessBlob(att, blobType, callback) {\n  binaryMd5(att.data, function (md5) {\n    att.digest = 'md5-' + md5;\n    // size is for blobs (browser), length is for buffers (node)\n    att.length = att.data.size || att.data.length || 0;\n    if (blobType === 'binary') {\n      blobToBinaryString(att.data, function (binString) {\n        att.data = binString;\n        callback();\n      });\n    } else if (blobType === 'base64') {\n      blobToBase64(att.data, function (b64) {\n        att.data = b64;\n        callback();\n      });\n    } else {\n      callback();\n    }\n  });\n}\n\nfunction preprocessAttachment(att, blobType, callback) {\n  if (att.stub) {\n    return callback();\n  }\n  if (typeof att.data === 'string') { // input is a base64 string\n    preprocessString(att, blobType, callback);\n  } else { // input is a blob\n    preprocessBlob(att, blobType, callback);\n  }\n}\n\nfunction preprocessAttachments(docInfos, blobType, callback) {\n\n  if (!docInfos.length) {\n    return callback();\n  }\n\n  var docv = 0;\n  var overallErr;\n\n  docInfos.forEach(function (docInfo) {\n    var attachments = docInfo.data && docInfo.data._attachments ?\n      Object.keys(docInfo.data._attachments) : [];\n    var recv = 0;\n\n    if (!attachments.length) {\n      return done();\n    }\n\n    function processedAttachment(err) {\n      overallErr = err;\n      recv++;\n      if (recv === attachments.length) {\n        done();\n      }\n    }\n\n    for (var key in docInfo.data._attachments) {\n      if (docInfo.data._attachments.hasOwnProperty(key)) {\n        preprocessAttachment(docInfo.data._attachments[key],\n          blobType, processedAttachment);\n      }\n    }\n  });\n\n  function done() {\n    docv++;\n    if (docInfos.length === docv) {\n      if (overallErr) {\n        callback(overallErr);\n      } else {\n        callback();\n      }\n    }\n  }\n}\n\nfunction updateDoc(revLimit, prev, docInfo, results,\n                   i, cb, writeDoc, newEdits) {\n\n  if (revExists(prev.rev_tree, docInfo.metadata.rev) && !newEdits) {\n    results[i] = docInfo;\n    return cb();\n  }\n\n  // sometimes this is pre-calculated. historically not always\n  var previousWinningRev = prev.winningRev || winningRev(prev);\n  var previouslyDeleted = 'deleted' in prev ? prev.deleted :\n    isDeleted(prev, previousWinningRev);\n  var deleted = 'deleted' in docInfo.metadata ? docInfo.metadata.deleted :\n    isDeleted(docInfo.metadata);\n  var isRoot = /^1-/.test(docInfo.metadata.rev);\n\n  if (previouslyDeleted && !deleted && newEdits && isRoot) {\n    var newDoc = docInfo.data;\n    newDoc._rev = previousWinningRev;\n    newDoc._id = docInfo.metadata.id;\n    docInfo = parseDoc(newDoc, newEdits);\n  }\n\n  var merged = merge(prev.rev_tree, docInfo.metadata.rev_tree[0], revLimit);\n\n  var inConflict = newEdits && ((\n    (previouslyDeleted && deleted && merged.conflicts !== 'new_leaf') ||\n    (!previouslyDeleted && merged.conflicts !== 'new_leaf') ||\n    (previouslyDeleted && !deleted && merged.conflicts === 'new_branch')));\n\n  if (inConflict) {\n    var err = createError(REV_CONFLICT);\n    results[i] = err;\n    return cb();\n  }\n\n  var newRev = docInfo.metadata.rev;\n  docInfo.metadata.rev_tree = merged.tree;\n  docInfo.stemmedRevs = merged.stemmedRevs || [];\n  /* istanbul ignore else */\n  if (prev.rev_map) {\n    docInfo.metadata.rev_map = prev.rev_map; // used only by leveldb\n  }\n\n  // recalculate\n  var winningRev$$1 = winningRev(docInfo.metadata);\n  var winningRevIsDeleted = isDeleted(docInfo.metadata, winningRev$$1);\n\n  // calculate the total number of documents that were added/removed,\n  // from the perspective of total_rows/doc_count\n  var delta = (previouslyDeleted === winningRevIsDeleted) ? 0 :\n    previouslyDeleted < winningRevIsDeleted ? -1 : 1;\n\n  var newRevIsDeleted;\n  if (newRev === winningRev$$1) {\n    // if the new rev is the same as the winning rev, we can reuse that value\n    newRevIsDeleted = winningRevIsDeleted;\n  } else {\n    // if they're not the same, then we need to recalculate\n    newRevIsDeleted = isDeleted(docInfo.metadata, newRev);\n  }\n\n  writeDoc(docInfo, winningRev$$1, winningRevIsDeleted, newRevIsDeleted,\n    true, delta, i, cb);\n}\n\nfunction rootIsMissing(docInfo) {\n  return docInfo.metadata.rev_tree[0].ids[1].status === 'missing';\n}\n\nfunction processDocs(revLimit, docInfos, api, fetchedDocs, tx, results,\n                     writeDoc, opts, overallCallback) {\n\n  // Default to 1000 locally\n  revLimit = revLimit || 1000;\n\n  function insertDoc(docInfo, resultsIdx, callback) {\n    // Cant insert new deleted documents\n    var winningRev$$1 = winningRev(docInfo.metadata);\n    var deleted = isDeleted(docInfo.metadata, winningRev$$1);\n    if ('was_delete' in opts && deleted) {\n      results[resultsIdx] = createError(MISSING_DOC, 'deleted');\n      return callback();\n    }\n\n    // 4712 - detect whether a new document was inserted with a _rev\n    var inConflict = newEdits && rootIsMissing(docInfo);\n\n    if (inConflict) {\n      var err = createError(REV_CONFLICT);\n      results[resultsIdx] = err;\n      return callback();\n    }\n\n    var delta = deleted ? 0 : 1;\n\n    writeDoc(docInfo, winningRev$$1, deleted, deleted, false,\n      delta, resultsIdx, callback);\n  }\n\n  var newEdits = opts.new_edits;\n  var idsToDocs = new ExportedMap();\n\n  var docsDone = 0;\n  var docsToDo = docInfos.length;\n\n  function checkAllDocsDone() {\n    if (++docsDone === docsToDo && overallCallback) {\n      overallCallback();\n    }\n  }\n\n  docInfos.forEach(function (currentDoc, resultsIdx) {\n\n    if (currentDoc._id && isLocalId(currentDoc._id)) {\n      var fun = currentDoc._deleted ? '_removeLocal' : '_putLocal';\n      api[fun](currentDoc, {ctx: tx}, function (err, res) {\n        results[resultsIdx] = err || res;\n        checkAllDocsDone();\n      });\n      return;\n    }\n\n    var id = currentDoc.metadata.id;\n    if (idsToDocs.has(id)) {\n      docsToDo--; // duplicate\n      idsToDocs.get(id).push([currentDoc, resultsIdx]);\n    } else {\n      idsToDocs.set(id, [[currentDoc, resultsIdx]]);\n    }\n  });\n\n  // in the case of new_edits, the user can provide multiple docs\n  // with the same id. these need to be processed sequentially\n  idsToDocs.forEach(function (docs, id) {\n    var numDone = 0;\n\n    function docWritten() {\n      if (++numDone < docs.length) {\n        nextDoc();\n      } else {\n        checkAllDocsDone();\n      }\n    }\n    function nextDoc() {\n      var value = docs[numDone];\n      var currentDoc = value[0];\n      var resultsIdx = value[1];\n\n      if (fetchedDocs.has(id)) {\n        updateDoc(revLimit, fetchedDocs.get(id), currentDoc, results,\n          resultsIdx, docWritten, writeDoc, newEdits);\n      } else {\n        // Ensure stemming applies to new writes as well\n        var merged = merge([], currentDoc.metadata.rev_tree[0], revLimit);\n        currentDoc.metadata.rev_tree = merged.tree;\n        currentDoc.stemmedRevs = merged.stemmedRevs || [];\n        insertDoc(currentDoc, resultsIdx, docWritten);\n      }\n    }\n    nextDoc();\n  });\n}\n\n// IndexedDB requires a versioned database structure, so we use the\n// version here to manage migrations.\nvar ADAPTER_VERSION = 5;\n\n// The object stores created for each database\n// DOC_STORE stores the document meta data, its revision history and state\n// Keyed by document id\nvar DOC_STORE = 'document-store';\n// BY_SEQ_STORE stores a particular version of a document, keyed by its\n// sequence id\nvar BY_SEQ_STORE = 'by-sequence';\n// Where we store attachments\nvar ATTACH_STORE = 'attach-store';\n// Where we store many-to-many relations\n// between attachment digests and seqs\nvar ATTACH_AND_SEQ_STORE = 'attach-seq-store';\n\n// Where we store database-wide meta data in a single record\n// keyed by id: META_STORE\nvar META_STORE = 'meta-store';\n// Where we store local documents\nvar LOCAL_STORE = 'local-store';\n// Where we detect blob support\nvar DETECT_BLOB_SUPPORT_STORE = 'detect-blob-support';\n\nfunction safeJsonParse(str) {\n  // This try/catch guards against stack overflow errors.\n  // JSON.parse() is faster than vuvuzela.parse() but vuvuzela\n  // cannot overflow.\n  try {\n    return JSON.parse(str);\n  } catch (e) {\n    /* istanbul ignore next */\n    return vuvuzela.parse(str);\n  }\n}\n\nfunction safeJsonStringify(json) {\n  try {\n    return JSON.stringify(json);\n  } catch (e) {\n    /* istanbul ignore next */\n    return vuvuzela.stringify(json);\n  }\n}\n\nfunction idbError(callback) {\n  return function (evt) {\n    var message = 'unknown_error';\n    if (evt.target && evt.target.error) {\n      message = evt.target.error.name || evt.target.error.message;\n    }\n    callback(createError(IDB_ERROR, message, evt.type));\n  };\n}\n\n// Unfortunately, the metadata has to be stringified\n// when it is put into the database, because otherwise\n// IndexedDB can throw errors for deeply-nested objects.\n// Originally we just used JSON.parse/JSON.stringify; now\n// we use this custom vuvuzela library that avoids recursion.\n// If we could do it all over again, we'd probably use a\n// format for the revision trees other than JSON.\nfunction encodeMetadata(metadata, winningRev, deleted) {\n  return {\n    data: safeJsonStringify(metadata),\n    winningRev: winningRev,\n    deletedOrLocal: deleted ? '1' : '0',\n    seq: metadata.seq, // highest seq for this doc\n    id: metadata.id\n  };\n}\n\nfunction decodeMetadata(storedObject) {\n  if (!storedObject) {\n    return null;\n  }\n  var metadata = safeJsonParse(storedObject.data);\n  metadata.winningRev = storedObject.winningRev;\n  metadata.deleted = storedObject.deletedOrLocal === '1';\n  metadata.seq = storedObject.seq;\n  return metadata;\n}\n\n// read the doc back out from the database. we don't store the\n// _id or _rev because we already have _doc_id_rev.\nfunction decodeDoc(doc) {\n  if (!doc) {\n    return doc;\n  }\n  var idx = doc._doc_id_rev.lastIndexOf(':');\n  doc._id = doc._doc_id_rev.substring(0, idx - 1);\n  doc._rev = doc._doc_id_rev.substring(idx + 1);\n  delete doc._doc_id_rev;\n  return doc;\n}\n\n// Read a blob from the database, encoding as necessary\n// and translating from base64 if the IDB doesn't support\n// native Blobs\nfunction readBlobData(body, type, asBlob, callback) {\n  if (asBlob) {\n    if (!body) {\n      callback(createBlob([''], {type: type}));\n    } else if (typeof body !== 'string') { // we have blob support\n      callback(body);\n    } else { // no blob support\n      callback(b64ToBluffer(body, type));\n    }\n  } else { // as base64 string\n    if (!body) {\n      callback('');\n    } else if (typeof body !== 'string') { // we have blob support\n      readAsBinaryString(body, function (binary) {\n        callback(thisBtoa(binary));\n      });\n    } else { // no blob support\n      callback(body);\n    }\n  }\n}\n\nfunction fetchAttachmentsIfNecessary(doc, opts, txn, cb) {\n  var attachments = Object.keys(doc._attachments || {});\n  if (!attachments.length) {\n    return cb && cb();\n  }\n  var numDone = 0;\n\n  function checkDone() {\n    if (++numDone === attachments.length && cb) {\n      cb();\n    }\n  }\n\n  function fetchAttachment(doc, att) {\n    var attObj = doc._attachments[att];\n    var digest = attObj.digest;\n    var req = txn.objectStore(ATTACH_STORE).get(digest);\n    req.onsuccess = function (e) {\n      attObj.body = e.target.result.body;\n      checkDone();\n    };\n  }\n\n  attachments.forEach(function (att) {\n    if (opts.attachments && opts.include_docs) {\n      fetchAttachment(doc, att);\n    } else {\n      doc._attachments[att].stub = true;\n      checkDone();\n    }\n  });\n}\n\n// IDB-specific postprocessing necessary because\n// we don't know whether we stored a true Blob or\n// a base64-encoded string, and if it's a Blob it\n// needs to be read outside of the transaction context\nfunction postProcessAttachments(results, asBlob) {\n  return Promise.all(results.map(function (row) {\n    if (row.doc && row.doc._attachments) {\n      var attNames = Object.keys(row.doc._attachments);\n      return Promise.all(attNames.map(function (att) {\n        var attObj = row.doc._attachments[att];\n        if (!('body' in attObj)) { // already processed\n          return;\n        }\n        var body = attObj.body;\n        var type = attObj.content_type;\n        return new Promise(function (resolve) {\n          readBlobData(body, type, asBlob, function (data) {\n            row.doc._attachments[att] = $inject_Object_assign(\n              pick(attObj, ['digest', 'content_type']),\n              {data: data}\n            );\n            resolve();\n          });\n        });\n      }));\n    }\n  }));\n}\n\nfunction compactRevs(revs, docId, txn) {\n\n  var possiblyOrphanedDigests = [];\n  var seqStore = txn.objectStore(BY_SEQ_STORE);\n  var attStore = txn.objectStore(ATTACH_STORE);\n  var attAndSeqStore = txn.objectStore(ATTACH_AND_SEQ_STORE);\n  var count = revs.length;\n\n  function checkDone() {\n    count--;\n    if (!count) { // done processing all revs\n      deleteOrphanedAttachments();\n    }\n  }\n\n  function deleteOrphanedAttachments() {\n    if (!possiblyOrphanedDigests.length) {\n      return;\n    }\n    possiblyOrphanedDigests.forEach(function (digest) {\n      var countReq = attAndSeqStore.index('digestSeq').count(\n        IDBKeyRange.bound(\n          digest + '::', digest + '::\\uffff', false, false));\n      countReq.onsuccess = function (e) {\n        var count = e.target.result;\n        if (!count) {\n          // orphaned\n          attStore.delete(digest);\n        }\n      };\n    });\n  }\n\n  revs.forEach(function (rev$$1) {\n    var index = seqStore.index('_doc_id_rev');\n    var key = docId + \"::\" + rev$$1;\n    index.getKey(key).onsuccess = function (e) {\n      var seq = e.target.result;\n      if (typeof seq !== 'number') {\n        return checkDone();\n      }\n      seqStore.delete(seq);\n\n      var cursor = attAndSeqStore.index('seq')\n        .openCursor(IDBKeyRange.only(seq));\n\n      cursor.onsuccess = function (event) {\n        var cursor = event.target.result;\n        if (cursor) {\n          var digest = cursor.value.digestSeq.split('::')[0];\n          possiblyOrphanedDigests.push(digest);\n          attAndSeqStore.delete(cursor.primaryKey);\n          cursor.continue();\n        } else { // done\n          checkDone();\n        }\n      };\n    };\n  });\n}\n\nfunction openTransactionSafely(idb, stores, mode) {\n  try {\n    return {\n      txn: idb.transaction(stores, mode)\n    };\n  } catch (err) {\n    return {\n      error: err\n    };\n  }\n}\n\nvar changesHandler = new Changes();\n\nfunction idbBulkDocs(dbOpts, req, opts, api, idb, callback) {\n  var docInfos = req.docs;\n  var txn;\n  var docStore;\n  var bySeqStore;\n  var attachStore;\n  var attachAndSeqStore;\n  var metaStore;\n  var docInfoError;\n  var metaDoc;\n\n  for (var i = 0, len = docInfos.length; i < len; i++) {\n    var doc = docInfos[i];\n    if (doc._id && isLocalId(doc._id)) {\n      continue;\n    }\n    doc = docInfos[i] = parseDoc(doc, opts.new_edits, dbOpts);\n    if (doc.error && !docInfoError) {\n      docInfoError = doc;\n    }\n  }\n\n  if (docInfoError) {\n    return callback(docInfoError);\n  }\n\n  var allDocsProcessed = false;\n  var docCountDelta = 0;\n  var results = new Array(docInfos.length);\n  var fetchedDocs = new ExportedMap();\n  var preconditionErrored = false;\n  var blobType = api._meta.blobSupport ? 'blob' : 'base64';\n\n  preprocessAttachments(docInfos, blobType, function (err) {\n    if (err) {\n      return callback(err);\n    }\n    startTransaction();\n  });\n\n  function startTransaction() {\n\n    var stores = [\n      DOC_STORE, BY_SEQ_STORE,\n      ATTACH_STORE,\n      LOCAL_STORE, ATTACH_AND_SEQ_STORE,\n      META_STORE\n    ];\n    var txnResult = openTransactionSafely(idb, stores, 'readwrite');\n    if (txnResult.error) {\n      return callback(txnResult.error);\n    }\n    txn = txnResult.txn;\n    txn.onabort = idbError(callback);\n    txn.ontimeout = idbError(callback);\n    txn.oncomplete = complete;\n    docStore = txn.objectStore(DOC_STORE);\n    bySeqStore = txn.objectStore(BY_SEQ_STORE);\n    attachStore = txn.objectStore(ATTACH_STORE);\n    attachAndSeqStore = txn.objectStore(ATTACH_AND_SEQ_STORE);\n    metaStore = txn.objectStore(META_STORE);\n\n    metaStore.get(META_STORE).onsuccess = function (e) {\n      metaDoc = e.target.result;\n      updateDocCountIfReady();\n    };\n\n    verifyAttachments(function (err) {\n      if (err) {\n        preconditionErrored = true;\n        return callback(err);\n      }\n      fetchExistingDocs();\n    });\n  }\n\n  function onAllDocsProcessed() {\n    allDocsProcessed = true;\n    updateDocCountIfReady();\n  }\n\n  function idbProcessDocs() {\n    processDocs(dbOpts.revs_limit, docInfos, api, fetchedDocs,\n                txn, results, writeDoc, opts, onAllDocsProcessed);\n  }\n\n  function updateDocCountIfReady() {\n    if (!metaDoc || !allDocsProcessed) {\n      return;\n    }\n    // caching the docCount saves a lot of time in allDocs() and\n    // info(), which is why we go to all the trouble of doing this\n    metaDoc.docCount += docCountDelta;\n    metaStore.put(metaDoc);\n  }\n\n  function fetchExistingDocs() {\n\n    if (!docInfos.length) {\n      return;\n    }\n\n    var numFetched = 0;\n\n    function checkDone() {\n      if (++numFetched === docInfos.length) {\n        idbProcessDocs();\n      }\n    }\n\n    function readMetadata(event) {\n      var metadata = decodeMetadata(event.target.result);\n\n      if (metadata) {\n        fetchedDocs.set(metadata.id, metadata);\n      }\n      checkDone();\n    }\n\n    for (var i = 0, len = docInfos.length; i < len; i++) {\n      var docInfo = docInfos[i];\n      if (docInfo._id && isLocalId(docInfo._id)) {\n        checkDone(); // skip local docs\n        continue;\n      }\n      var req = docStore.get(docInfo.metadata.id);\n      req.onsuccess = readMetadata;\n    }\n  }\n\n  function complete() {\n    if (preconditionErrored) {\n      return;\n    }\n\n    changesHandler.notify(api._meta.name);\n    callback(null, results);\n  }\n\n  function verifyAttachment(digest, callback) {\n\n    var req = attachStore.get(digest);\n    req.onsuccess = function (e) {\n      if (!e.target.result) {\n        var err = createError(MISSING_STUB,\n          'unknown stub attachment with digest ' +\n          digest);\n        err.status = 412;\n        callback(err);\n      } else {\n        callback();\n      }\n    };\n  }\n\n  function verifyAttachments(finish) {\n\n\n    var digests = [];\n    docInfos.forEach(function (docInfo) {\n      if (docInfo.data && docInfo.data._attachments) {\n        Object.keys(docInfo.data._attachments).forEach(function (filename) {\n          var att = docInfo.data._attachments[filename];\n          if (att.stub) {\n            digests.push(att.digest);\n          }\n        });\n      }\n    });\n    if (!digests.length) {\n      return finish();\n    }\n    var numDone = 0;\n    var err;\n\n    function checkDone() {\n      if (++numDone === digests.length) {\n        finish(err);\n      }\n    }\n    digests.forEach(function (digest) {\n      verifyAttachment(digest, function (attErr) {\n        if (attErr && !err) {\n          err = attErr;\n        }\n        checkDone();\n      });\n    });\n  }\n\n  function writeDoc(docInfo, winningRev$$1, winningRevIsDeleted, newRevIsDeleted,\n                    isUpdate, delta, resultsIdx, callback) {\n\n    docInfo.metadata.winningRev = winningRev$$1;\n    docInfo.metadata.deleted = winningRevIsDeleted;\n\n    var doc = docInfo.data;\n    doc._id = docInfo.metadata.id;\n    doc._rev = docInfo.metadata.rev;\n\n    if (newRevIsDeleted) {\n      doc._deleted = true;\n    }\n\n    var hasAttachments = doc._attachments &&\n      Object.keys(doc._attachments).length;\n    if (hasAttachments) {\n      return writeAttachments(docInfo, winningRev$$1, winningRevIsDeleted,\n        isUpdate, resultsIdx, callback);\n    }\n\n    docCountDelta += delta;\n    updateDocCountIfReady();\n\n    finishDoc(docInfo, winningRev$$1, winningRevIsDeleted,\n      isUpdate, resultsIdx, callback);\n  }\n\n  function finishDoc(docInfo, winningRev$$1, winningRevIsDeleted,\n                     isUpdate, resultsIdx, callback) {\n\n    var doc = docInfo.data;\n    var metadata = docInfo.metadata;\n\n    doc._doc_id_rev = metadata.id + '::' + metadata.rev;\n    delete doc._id;\n    delete doc._rev;\n\n    function afterPutDoc(e) {\n      var revsToDelete = docInfo.stemmedRevs || [];\n\n      if (isUpdate && api.auto_compaction) {\n        revsToDelete = revsToDelete.concat(compactTree(docInfo.metadata));\n      }\n\n      if (revsToDelete && revsToDelete.length) {\n        compactRevs(revsToDelete, docInfo.metadata.id, txn);\n      }\n\n      metadata.seq = e.target.result;\n      // Current _rev is calculated from _rev_tree on read\n      // delete metadata.rev;\n      var metadataToStore = encodeMetadata(metadata, winningRev$$1,\n        winningRevIsDeleted);\n      var metaDataReq = docStore.put(metadataToStore);\n      metaDataReq.onsuccess = afterPutMetadata;\n    }\n\n    function afterPutDocError(e) {\n      // ConstraintError, need to update, not put (see #1638 for details)\n      e.preventDefault(); // avoid transaction abort\n      e.stopPropagation(); // avoid transaction onerror\n      var index = bySeqStore.index('_doc_id_rev');\n      var getKeyReq = index.getKey(doc._doc_id_rev);\n      getKeyReq.onsuccess = function (e) {\n        var putReq = bySeqStore.put(doc, e.target.result);\n        putReq.onsuccess = afterPutDoc;\n      };\n    }\n\n    function afterPutMetadata() {\n      results[resultsIdx] = {\n        ok: true,\n        id: metadata.id,\n        rev: metadata.rev\n      };\n      fetchedDocs.set(docInfo.metadata.id, docInfo.metadata);\n      insertAttachmentMappings(docInfo, metadata.seq, callback);\n    }\n\n    var putReq = bySeqStore.put(doc);\n\n    putReq.onsuccess = afterPutDoc;\n    putReq.onerror = afterPutDocError;\n  }\n\n  function writeAttachments(docInfo, winningRev$$1, winningRevIsDeleted,\n                            isUpdate, resultsIdx, callback) {\n\n\n    var doc = docInfo.data;\n\n    var numDone = 0;\n    var attachments = Object.keys(doc._attachments);\n\n    function collectResults() {\n      if (numDone === attachments.length) {\n        finishDoc(docInfo, winningRev$$1, winningRevIsDeleted,\n          isUpdate, resultsIdx, callback);\n      }\n    }\n\n    function attachmentSaved() {\n      numDone++;\n      collectResults();\n    }\n\n    attachments.forEach(function (key) {\n      var att = docInfo.data._attachments[key];\n      if (!att.stub) {\n        var data = att.data;\n        delete att.data;\n        att.revpos = parseInt(winningRev$$1, 10);\n        var digest = att.digest;\n        saveAttachment(digest, data, attachmentSaved);\n      } else {\n        numDone++;\n        collectResults();\n      }\n    });\n  }\n\n  // map seqs to attachment digests, which\n  // we will need later during compaction\n  function insertAttachmentMappings(docInfo, seq, callback) {\n\n    var attsAdded = 0;\n    var attsToAdd = Object.keys(docInfo.data._attachments || {});\n\n    if (!attsToAdd.length) {\n      return callback();\n    }\n\n    function checkDone() {\n      if (++attsAdded === attsToAdd.length) {\n        callback();\n      }\n    }\n\n    function add(att) {\n      var digest = docInfo.data._attachments[att].digest;\n      var req = attachAndSeqStore.put({\n        seq: seq,\n        digestSeq: digest + '::' + seq\n      });\n\n      req.onsuccess = checkDone;\n      req.onerror = function (e) {\n        // this callback is for a constaint error, which we ignore\n        // because this docid/rev has already been associated with\n        // the digest (e.g. when new_edits == false)\n        e.preventDefault(); // avoid transaction abort\n        e.stopPropagation(); // avoid transaction onerror\n        checkDone();\n      };\n    }\n    for (var i = 0; i < attsToAdd.length; i++) {\n      add(attsToAdd[i]); // do in parallel\n    }\n  }\n\n  function saveAttachment(digest, data, callback) {\n\n\n    var getKeyReq = attachStore.count(digest);\n    getKeyReq.onsuccess = function (e) {\n      var count = e.target.result;\n      if (count) {\n        return callback(); // already exists\n      }\n      var newAtt = {\n        digest: digest,\n        body: data\n      };\n      var putReq = attachStore.put(newAtt);\n      putReq.onsuccess = callback;\n    };\n  }\n}\n\n// Abstraction over IDBCursor and getAll()/getAllKeys() that allows us to batch our operations\n// while falling back to a normal IDBCursor operation on browsers that don't support getAll() or\n// getAllKeys(). This allows for a much faster implementation than just straight-up cursors, because\n// we're not processing each document one-at-a-time.\nfunction runBatchedCursor(objectStore, keyRange, descending, batchSize, onBatch) {\n\n  if (batchSize === -1) {\n    batchSize = 1000;\n  }\n\n  // Bail out of getAll()/getAllKeys() in the following cases:\n  // 1) either method is unsupported - we need both\n  // 2) batchSize is 1 (might as well use IDBCursor)\n  // 3) descending  no real way to do this via getAll()/getAllKeys()\n\n  var useGetAll = typeof objectStore.getAll === 'function' &&\n    typeof objectStore.getAllKeys === 'function' &&\n    batchSize > 1 && !descending;\n\n  var keysBatch;\n  var valuesBatch;\n  var pseudoCursor;\n\n  function onGetAll(e) {\n    valuesBatch = e.target.result;\n    if (keysBatch) {\n      onBatch(keysBatch, valuesBatch, pseudoCursor);\n    }\n  }\n\n  function onGetAllKeys(e) {\n    keysBatch = e.target.result;\n    if (valuesBatch) {\n      onBatch(keysBatch, valuesBatch, pseudoCursor);\n    }\n  }\n\n  function continuePseudoCursor() {\n    if (!keysBatch.length) { // no more results\n      return onBatch();\n    }\n    // fetch next batch, exclusive start\n    var lastKey = keysBatch[keysBatch.length - 1];\n    var newKeyRange;\n    if (keyRange && keyRange.upper) {\n      try {\n        newKeyRange = IDBKeyRange.bound(lastKey, keyRange.upper,\n          true, keyRange.upperOpen);\n      } catch (e) {\n        if (e.name === \"DataError\" && e.code === 0) {\n          return onBatch(); // we're done, startkey and endkey are equal\n        }\n      }\n    } else {\n      newKeyRange = IDBKeyRange.lowerBound(lastKey, true);\n    }\n    keyRange = newKeyRange;\n    keysBatch = null;\n    valuesBatch = null;\n    objectStore.getAll(keyRange, batchSize).onsuccess = onGetAll;\n    objectStore.getAllKeys(keyRange, batchSize).onsuccess = onGetAllKeys;\n  }\n\n  function onCursor(e) {\n    var cursor = e.target.result;\n    if (!cursor) { // done\n      return onBatch();\n    }\n    // regular IDBCursor acts like a batch where batch size is always 1\n    onBatch([cursor.key], [cursor.value], cursor);\n  }\n\n  if (useGetAll) {\n    pseudoCursor = {\"continue\": continuePseudoCursor};\n    objectStore.getAll(keyRange, batchSize).onsuccess = onGetAll;\n    objectStore.getAllKeys(keyRange, batchSize).onsuccess = onGetAllKeys;\n  } else if (descending) {\n    objectStore.openCursor(keyRange, 'prev').onsuccess = onCursor;\n  } else {\n    objectStore.openCursor(keyRange).onsuccess = onCursor;\n  }\n}\n\n// simple shim for objectStore.getAll(), falling back to IDBCursor\nfunction getAll(objectStore, keyRange, onSuccess) {\n  if (typeof objectStore.getAll === 'function') {\n    // use native getAll\n    objectStore.getAll(keyRange).onsuccess = onSuccess;\n    return;\n  }\n  // fall back to cursors\n  var values = [];\n\n  function onCursor(e) {\n    var cursor = e.target.result;\n    if (cursor) {\n      values.push(cursor.value);\n      cursor.continue();\n    } else {\n      onSuccess({\n        target: {\n          result: values\n        }\n      });\n    }\n  }\n\n  objectStore.openCursor(keyRange).onsuccess = onCursor;\n}\n\nfunction allDocsKeys(keys, docStore, onBatch) {\n  // It's not guaranted to be returned in right order  \n  var valuesBatch = new Array(keys.length);\n  var count = 0;\n  keys.forEach(function (key, index) {\n    docStore.get(key).onsuccess = function (event) {\n      if (event.target.result) {\n        valuesBatch[index] = event.target.result;\n      } else {\n        valuesBatch[index] = {key: key, error: 'not_found'};\n      }\n      count++;\n      if (count === keys.length) {\n        onBatch(keys, valuesBatch, {});\n      }\n    };\n  });\n}\n\nfunction createKeyRange(start, end, inclusiveEnd, key, descending) {\n  try {\n    if (start && end) {\n      if (descending) {\n        return IDBKeyRange.bound(end, start, !inclusiveEnd, false);\n      } else {\n        return IDBKeyRange.bound(start, end, false, !inclusiveEnd);\n      }\n    } else if (start) {\n      if (descending) {\n        return IDBKeyRange.upperBound(start);\n      } else {\n        return IDBKeyRange.lowerBound(start);\n      }\n    } else if (end) {\n      if (descending) {\n        return IDBKeyRange.lowerBound(end, !inclusiveEnd);\n      } else {\n        return IDBKeyRange.upperBound(end, !inclusiveEnd);\n      }\n    } else if (key) {\n      return IDBKeyRange.only(key);\n    }\n  } catch (e) {\n    return {error: e};\n  }\n  return null;\n}\n\nfunction idbAllDocs(opts, idb, callback) {\n  var start = 'startkey' in opts ? opts.startkey : false;\n  var end = 'endkey' in opts ? opts.endkey : false;\n  var key = 'key' in opts ? opts.key : false;\n  var keys = 'keys' in opts ? opts.keys : false; \n  var skip = opts.skip || 0;\n  var limit = typeof opts.limit === 'number' ? opts.limit : -1;\n  var inclusiveEnd = opts.inclusive_end !== false;\n\n  var keyRange ; \n  var keyRangeError;\n  if (!keys) {\n    keyRange = createKeyRange(start, end, inclusiveEnd, key, opts.descending);\n    keyRangeError = keyRange && keyRange.error;\n    if (keyRangeError && \n      !(keyRangeError.name === \"DataError\" && keyRangeError.code === 0)) {\n      // DataError with error code 0 indicates start is less than end, so\n      // can just do an empty query. Else need to throw\n      return callback(createError(IDB_ERROR,\n        keyRangeError.name, keyRangeError.message));\n    }\n  }\n\n  var stores = [DOC_STORE, BY_SEQ_STORE, META_STORE];\n\n  if (opts.attachments) {\n    stores.push(ATTACH_STORE);\n  }\n  var txnResult = openTransactionSafely(idb, stores, 'readonly');\n  if (txnResult.error) {\n    return callback(txnResult.error);\n  }\n  var txn = txnResult.txn;\n  txn.oncomplete = onTxnComplete;\n  txn.onabort = idbError(callback);\n  var docStore = txn.objectStore(DOC_STORE);\n  var seqStore = txn.objectStore(BY_SEQ_STORE);\n  var metaStore = txn.objectStore(META_STORE);\n  var docIdRevIndex = seqStore.index('_doc_id_rev');\n  var results = [];\n  var docCount;\n  var updateSeq;\n\n  metaStore.get(META_STORE).onsuccess = function (e) {\n    docCount = e.target.result.docCount;\n  };\n\n  /* istanbul ignore if */\n  if (opts.update_seq) {\n    getMaxUpdateSeq(seqStore, function (e) { \n      if (e.target.result && e.target.result.length > 0) {\n        updateSeq = e.target.result[0];\n      }\n    });\n  }\n\n  function getMaxUpdateSeq(objectStore, onSuccess) {\n    function onCursor(e) {\n      var cursor = e.target.result;\n      var maxKey = undefined;\n      if (cursor && cursor.key) {\n        maxKey = cursor.key;\n      } \n      return onSuccess({\n        target: {\n          result: [maxKey]\n        }\n      });\n    }\n    objectStore.openCursor(null, 'prev').onsuccess = onCursor;\n  }\n\n  // if the user specifies include_docs=true, then we don't\n  // want to block the main cursor while we're fetching the doc\n  function fetchDocAsynchronously(metadata, row, winningRev$$1) {\n    var key = metadata.id + \"::\" + winningRev$$1;\n    docIdRevIndex.get(key).onsuccess =  function onGetDoc(e) {\n      row.doc = decodeDoc(e.target.result) || {};\n      if (opts.conflicts) {\n        var conflicts = collectConflicts(metadata);\n        if (conflicts.length) {\n          row.doc._conflicts = conflicts;\n        }\n      }\n      fetchAttachmentsIfNecessary(row.doc, opts, txn);\n    };\n  }\n\n  function allDocsInner(winningRev$$1, metadata) {\n    var row = {\n      id: metadata.id,\n      key: metadata.id,\n      value: {\n        rev: winningRev$$1\n      }\n    };\n    var deleted = metadata.deleted;\n    if (deleted) {\n      if (keys) {\n        results.push(row);\n        // deleted docs are okay with \"keys\" requests\n        row.value.deleted = true;\n        row.doc = null;\n      }\n    } else if (skip-- <= 0) {\n      results.push(row);\n      if (opts.include_docs) {\n        fetchDocAsynchronously(metadata, row, winningRev$$1);\n      }\n    }\n  }\n\n  function processBatch(batchValues) {\n    for (var i = 0, len = batchValues.length; i < len; i++) {\n      if (results.length === limit) {\n        break;\n      }\n      var batchValue = batchValues[i];\n      if (batchValue.error && keys) {\n        // key was not found with \"keys\" requests\n        results.push(batchValue);\n        continue;\n      }\n      var metadata = decodeMetadata(batchValue);\n      var winningRev$$1 = metadata.winningRev;\n      allDocsInner(winningRev$$1, metadata);\n    }\n  }\n\n  function onBatch(batchKeys, batchValues, cursor) {\n    if (!cursor) {\n      return;\n    }\n    processBatch(batchValues);\n    if (results.length < limit) {\n      cursor.continue();\n    }\n  }\n\n  function onGetAll(e) {\n    var values = e.target.result;\n    if (opts.descending) {\n      values = values.reverse();\n    }\n    processBatch(values);\n  }\n\n  function onResultsReady() {\n    var returnVal = {\n      total_rows: docCount,\n      offset: opts.skip,\n      rows: results\n    };\n    \n    /* istanbul ignore if */\n    if (opts.update_seq && updateSeq !== undefined) {\n      returnVal.update_seq = updateSeq;\n    }\n    callback(null, returnVal);\n  }\n\n  function onTxnComplete() {\n    if (opts.attachments) {\n      postProcessAttachments(results, opts.binary).then(onResultsReady);\n    } else {\n      onResultsReady();\n    }\n  }\n\n  // don't bother doing any requests if start > end or limit === 0\n  if (keyRangeError || limit === 0) {\n    return;\n  }\n  if (keys) {\n    return allDocsKeys(opts.keys, docStore, onBatch);\n  }\n  if (limit === -1) { // just fetch everything\n    return getAll(docStore, keyRange, onGetAll);\n  }\n  // else do a cursor\n  // choose a batch size based on the skip, since we'll need to skip that many\n  runBatchedCursor(docStore, keyRange, opts.descending, limit + skip, onBatch);\n}\n\n//\n// Blobs are not supported in all versions of IndexedDB, notably\n// Chrome <37 and Android <5. In those versions, storing a blob will throw.\n//\n// Various other blob bugs exist in Chrome v37-42 (inclusive).\n// Detecting them is expensive and confusing to users, and Chrome 37-42\n// is at very low usage worldwide, so we do a hacky userAgent check instead.\n//\n// content-type bug: https://code.google.com/p/chromium/issues/detail?id=408120\n// 404 bug: https://code.google.com/p/chromium/issues/detail?id=447916\n// FileReader bug: https://code.google.com/p/chromium/issues/detail?id=447836\n//\nfunction checkBlobSupport(txn) {\n  return new Promise(function (resolve) {\n    var blob$$1 = createBlob(['']);\n    var req = txn.objectStore(DETECT_BLOB_SUPPORT_STORE).put(blob$$1, 'key');\n\n    req.onsuccess = function () {\n      var matchedChrome = navigator.userAgent.match(/Chrome\\/(\\d+)/);\n      var matchedEdge = navigator.userAgent.match(/Edge\\//);\n      // MS Edge pretends to be Chrome 42:\n      // https://msdn.microsoft.com/en-us/library/hh869301%28v=vs.85%29.aspx\n      resolve(matchedEdge || !matchedChrome ||\n        parseInt(matchedChrome[1], 10) >= 43);\n    };\n\n    req.onerror = txn.onabort = function (e) {\n      // If the transaction aborts now its due to not being able to\n      // write to the database, likely due to the disk being full\n      e.preventDefault();\n      e.stopPropagation();\n      resolve(false);\n    };\n  }).catch(function () {\n    return false; // error, so assume unsupported\n  });\n}\n\nfunction countDocs(txn, cb) {\n  var index = txn.objectStore(DOC_STORE).index('deletedOrLocal');\n  index.count(IDBKeyRange.only('0')).onsuccess = function (e) {\n    cb(e.target.result);\n  };\n}\n\n// This task queue ensures that IDB open calls are done in their own tick\n\nvar running = false;\nvar queue = [];\n\nfunction tryCode(fun, err, res, PouchDB) {\n  try {\n    fun(err, res);\n  } catch (err) {\n    // Shouldn't happen, but in some odd cases\n    // IndexedDB implementations might throw a sync\n    // error, in which case this will at least log it.\n    PouchDB.emit('error', err);\n  }\n}\n\nfunction applyNext() {\n  if (running || !queue.length) {\n    return;\n  }\n  running = true;\n  queue.shift()();\n}\n\nfunction enqueueTask(action, callback, PouchDB) {\n  queue.push(function runAction() {\n    action(function runCallback(err, res) {\n      tryCode(callback, err, res, PouchDB);\n      running = false;\n      immediate(function runNext() {\n        applyNext(PouchDB);\n      });\n    });\n  });\n  applyNext();\n}\n\nfunction changes(opts, api, dbName, idb) {\n  opts = clone(opts);\n\n  if (opts.continuous) {\n    var id = dbName + ':' + uuid();\n    changesHandler.addListener(dbName, id, api, opts);\n    changesHandler.notify(dbName);\n    return {\n      cancel: function () {\n        changesHandler.removeListener(dbName, id);\n      }\n    };\n  }\n\n  var docIds = opts.doc_ids && new ExportedSet(opts.doc_ids);\n\n  opts.since = opts.since || 0;\n  var lastSeq = opts.since;\n\n  var limit = 'limit' in opts ? opts.limit : -1;\n  if (limit === 0) {\n    limit = 1; // per CouchDB _changes spec\n  }\n\n  var results = [];\n  var numResults = 0;\n  var filter = filterChange(opts);\n  var docIdsToMetadata = new ExportedMap();\n\n  var txn;\n  var bySeqStore;\n  var docStore;\n  var docIdRevIndex;\n\n  function onBatch(batchKeys, batchValues, cursor) {\n    if (!cursor || !batchKeys.length) { // done\n      return;\n    }\n\n    var winningDocs = new Array(batchKeys.length);\n    var metadatas = new Array(batchKeys.length);\n\n    function processMetadataAndWinningDoc(metadata, winningDoc) {\n      var change = opts.processChange(winningDoc, metadata, opts);\n      lastSeq = change.seq = metadata.seq;\n\n      var filtered = filter(change);\n      if (typeof filtered === 'object') { // anything but true/false indicates error\n        return Promise.reject(filtered);\n      }\n\n      if (!filtered) {\n        return Promise.resolve();\n      }\n      numResults++;\n      if (opts.return_docs) {\n        results.push(change);\n      }\n      // process the attachment immediately\n      // for the benefit of live listeners\n      if (opts.attachments && opts.include_docs) {\n        return new Promise(function (resolve) {\n          fetchAttachmentsIfNecessary(winningDoc, opts, txn, function () {\n            postProcessAttachments([change], opts.binary).then(function () {\n              resolve(change);\n            });\n          });\n        });\n      } else {\n        return Promise.resolve(change);\n      }\n    }\n\n    function onBatchDone() {\n      var promises = [];\n      for (var i = 0, len = winningDocs.length; i < len; i++) {\n        if (numResults === limit) {\n          break;\n        }\n        var winningDoc = winningDocs[i];\n        if (!winningDoc) {\n          continue;\n        }\n        var metadata = metadatas[i];\n        promises.push(processMetadataAndWinningDoc(metadata, winningDoc));\n      }\n\n      Promise.all(promises).then(function (changes) {\n        for (var i = 0, len = changes.length; i < len; i++) {\n          if (changes[i]) {\n            opts.onChange(changes[i]);\n          }\n        }\n      }).catch(opts.complete);\n\n      if (numResults !== limit) {\n        cursor.continue();\n      }\n    }\n\n    // Fetch all metadatas/winningdocs from this batch in parallel, then process\n    // them all only once all data has been collected. This is done in parallel\n    // because it's faster than doing it one-at-a-time.\n    var numDone = 0;\n    batchValues.forEach(function (value, i) {\n      var doc = decodeDoc(value);\n      var seq = batchKeys[i];\n      fetchWinningDocAndMetadata(doc, seq, function (metadata, winningDoc) {\n        metadatas[i] = metadata;\n        winningDocs[i] = winningDoc;\n        if (++numDone === batchKeys.length) {\n          onBatchDone();\n        }\n      });\n    });\n  }\n\n  function onGetMetadata(doc, seq, metadata, cb) {\n    if (metadata.seq !== seq) {\n      // some other seq is later\n      return cb();\n    }\n\n    if (metadata.winningRev === doc._rev) {\n      // this is the winning doc\n      return cb(metadata, doc);\n    }\n\n    // fetch winning doc in separate request\n    var docIdRev = doc._id + '::' + metadata.winningRev;\n    var req = docIdRevIndex.get(docIdRev);\n    req.onsuccess = function (e) {\n      cb(metadata, decodeDoc(e.target.result));\n    };\n  }\n\n  function fetchWinningDocAndMetadata(doc, seq, cb) {\n    if (docIds && !docIds.has(doc._id)) {\n      return cb();\n    }\n\n    var metadata = docIdsToMetadata.get(doc._id);\n    if (metadata) { // cached\n      return onGetMetadata(doc, seq, metadata, cb);\n    }\n    // metadata not cached, have to go fetch it\n    docStore.get(doc._id).onsuccess = function (e) {\n      metadata = decodeMetadata(e.target.result);\n      docIdsToMetadata.set(doc._id, metadata);\n      onGetMetadata(doc, seq, metadata, cb);\n    };\n  }\n\n  function finish() {\n    opts.complete(null, {\n      results: results,\n      last_seq: lastSeq\n    });\n  }\n\n  function onTxnComplete() {\n    if (!opts.continuous && opts.attachments) {\n      // cannot guarantee that postProcessing was already done,\n      // so do it again\n      postProcessAttachments(results).then(finish);\n    } else {\n      finish();\n    }\n  }\n\n  var objectStores = [DOC_STORE, BY_SEQ_STORE];\n  if (opts.attachments) {\n    objectStores.push(ATTACH_STORE);\n  }\n  var txnResult = openTransactionSafely(idb, objectStores, 'readonly');\n  if (txnResult.error) {\n    return opts.complete(txnResult.error);\n  }\n  txn = txnResult.txn;\n  txn.onabort = idbError(opts.complete);\n  txn.oncomplete = onTxnComplete;\n\n  bySeqStore = txn.objectStore(BY_SEQ_STORE);\n  docStore = txn.objectStore(DOC_STORE);\n  docIdRevIndex = bySeqStore.index('_doc_id_rev');\n\n  var keyRange = (opts.since && !opts.descending) ?\n    IDBKeyRange.lowerBound(opts.since, true) : null;\n\n  runBatchedCursor(bySeqStore, keyRange, opts.descending, limit, onBatch);\n}\n\nvar cachedDBs = new ExportedMap();\nvar blobSupportPromise;\nvar openReqList = new ExportedMap();\n\nfunction IdbPouch(opts, callback) {\n  var api = this;\n\n  enqueueTask(function (thisCallback) {\n    init(api, opts, thisCallback);\n  }, callback, api.constructor);\n}\n\nfunction init(api, opts, callback) {\n\n  var dbName = opts.name;\n\n  var idb = null;\n  api._meta = null;\n\n  // called when creating a fresh new database\n  function createSchema(db) {\n    var docStore = db.createObjectStore(DOC_STORE, {keyPath : 'id'});\n    db.createObjectStore(BY_SEQ_STORE, {autoIncrement: true})\n      .createIndex('_doc_id_rev', '_doc_id_rev', {unique: true});\n    db.createObjectStore(ATTACH_STORE, {keyPath: 'digest'});\n    db.createObjectStore(META_STORE, {keyPath: 'id', autoIncrement: false});\n    db.createObjectStore(DETECT_BLOB_SUPPORT_STORE);\n\n    // added in v2\n    docStore.createIndex('deletedOrLocal', 'deletedOrLocal', {unique : false});\n\n    // added in v3\n    db.createObjectStore(LOCAL_STORE, {keyPath: '_id'});\n\n    // added in v4\n    var attAndSeqStore = db.createObjectStore(ATTACH_AND_SEQ_STORE,\n      {autoIncrement: true});\n    attAndSeqStore.createIndex('seq', 'seq');\n    attAndSeqStore.createIndex('digestSeq', 'digestSeq', {unique: true});\n  }\n\n  // migration to version 2\n  // unfortunately \"deletedOrLocal\" is a misnomer now that we no longer\n  // store local docs in the main doc-store, but whaddyagonnado\n  function addDeletedOrLocalIndex(txn, callback) {\n    var docStore = txn.objectStore(DOC_STORE);\n    docStore.createIndex('deletedOrLocal', 'deletedOrLocal', {unique : false});\n\n    docStore.openCursor().onsuccess = function (event) {\n      var cursor = event.target.result;\n      if (cursor) {\n        var metadata = cursor.value;\n        var deleted = isDeleted(metadata);\n        metadata.deletedOrLocal = deleted ? \"1\" : \"0\";\n        docStore.put(metadata);\n        cursor.continue();\n      } else {\n        callback();\n      }\n    };\n  }\n\n  // migration to version 3 (part 1)\n  function createLocalStoreSchema(db) {\n    db.createObjectStore(LOCAL_STORE, {keyPath: '_id'})\n      .createIndex('_doc_id_rev', '_doc_id_rev', {unique: true});\n  }\n\n  // migration to version 3 (part 2)\n  function migrateLocalStore(txn, cb) {\n    var localStore = txn.objectStore(LOCAL_STORE);\n    var docStore = txn.objectStore(DOC_STORE);\n    var seqStore = txn.objectStore(BY_SEQ_STORE);\n\n    var cursor = docStore.openCursor();\n    cursor.onsuccess = function (event) {\n      var cursor = event.target.result;\n      if (cursor) {\n        var metadata = cursor.value;\n        var docId = metadata.id;\n        var local = isLocalId(docId);\n        var rev$$1 = winningRev(metadata);\n        if (local) {\n          var docIdRev = docId + \"::\" + rev$$1;\n          // remove all seq entries\n          // associated with this docId\n          var start = docId + \"::\";\n          var end = docId + \"::~\";\n          var index = seqStore.index('_doc_id_rev');\n          var range = IDBKeyRange.bound(start, end, false, false);\n          var seqCursor = index.openCursor(range);\n          seqCursor.onsuccess = function (e) {\n            seqCursor = e.target.result;\n            if (!seqCursor) {\n              // done\n              docStore.delete(cursor.primaryKey);\n              cursor.continue();\n            } else {\n              var data = seqCursor.value;\n              if (data._doc_id_rev === docIdRev) {\n                localStore.put(data);\n              }\n              seqStore.delete(seqCursor.primaryKey);\n              seqCursor.continue();\n            }\n          };\n        } else {\n          cursor.continue();\n        }\n      } else if (cb) {\n        cb();\n      }\n    };\n  }\n\n  // migration to version 4 (part 1)\n  function addAttachAndSeqStore(db) {\n    var attAndSeqStore = db.createObjectStore(ATTACH_AND_SEQ_STORE,\n      {autoIncrement: true});\n    attAndSeqStore.createIndex('seq', 'seq');\n    attAndSeqStore.createIndex('digestSeq', 'digestSeq', {unique: true});\n  }\n\n  // migration to version 4 (part 2)\n  function migrateAttsAndSeqs(txn, callback) {\n    var seqStore = txn.objectStore(BY_SEQ_STORE);\n    var attStore = txn.objectStore(ATTACH_STORE);\n    var attAndSeqStore = txn.objectStore(ATTACH_AND_SEQ_STORE);\n\n    // need to actually populate the table. this is the expensive part,\n    // so as an optimization, check first that this database even\n    // contains attachments\n    var req = attStore.count();\n    req.onsuccess = function (e) {\n      var count = e.target.result;\n      if (!count) {\n        return callback(); // done\n      }\n\n      seqStore.openCursor().onsuccess = function (e) {\n        var cursor = e.target.result;\n        if (!cursor) {\n          return callback(); // done\n        }\n        var doc = cursor.value;\n        var seq = cursor.primaryKey;\n        var atts = Object.keys(doc._attachments || {});\n        var digestMap = {};\n        for (var j = 0; j < atts.length; j++) {\n          var att = doc._attachments[atts[j]];\n          digestMap[att.digest] = true; // uniq digests, just in case\n        }\n        var digests = Object.keys(digestMap);\n        for (j = 0; j < digests.length; j++) {\n          var digest = digests[j];\n          attAndSeqStore.put({\n            seq: seq,\n            digestSeq: digest + '::' + seq\n          });\n        }\n        cursor.continue();\n      };\n    };\n  }\n\n  // migration to version 5\n  // Instead of relying on on-the-fly migration of metadata,\n  // this brings the doc-store to its modern form:\n  // - metadata.winningrev\n  // - metadata.seq\n  // - stringify the metadata when storing it\n  function migrateMetadata(txn) {\n\n    function decodeMetadataCompat(storedObject) {\n      if (!storedObject.data) {\n        // old format, when we didn't store it stringified\n        storedObject.deleted = storedObject.deletedOrLocal === '1';\n        return storedObject;\n      }\n      return decodeMetadata(storedObject);\n    }\n\n    // ensure that every metadata has a winningRev and seq,\n    // which was previously created on-the-fly but better to migrate\n    var bySeqStore = txn.objectStore(BY_SEQ_STORE);\n    var docStore = txn.objectStore(DOC_STORE);\n    var cursor = docStore.openCursor();\n    cursor.onsuccess = function (e) {\n      var cursor = e.target.result;\n      if (!cursor) {\n        return; // done\n      }\n      var metadata = decodeMetadataCompat(cursor.value);\n\n      metadata.winningRev = metadata.winningRev ||\n        winningRev(metadata);\n\n      function fetchMetadataSeq() {\n        // metadata.seq was added post-3.2.0, so if it's missing,\n        // we need to fetch it manually\n        var start = metadata.id + '::';\n        var end = metadata.id + '::\\uffff';\n        var req = bySeqStore.index('_doc_id_rev').openCursor(\n          IDBKeyRange.bound(start, end));\n\n        var metadataSeq = 0;\n        req.onsuccess = function (e) {\n          var cursor = e.target.result;\n          if (!cursor) {\n            metadata.seq = metadataSeq;\n            return onGetMetadataSeq();\n          }\n          var seq = cursor.primaryKey;\n          if (seq > metadataSeq) {\n            metadataSeq = seq;\n          }\n          cursor.continue();\n        };\n      }\n\n      function onGetMetadataSeq() {\n        var metadataToStore = encodeMetadata(metadata,\n          metadata.winningRev, metadata.deleted);\n\n        var req = docStore.put(metadataToStore);\n        req.onsuccess = function () {\n          cursor.continue();\n        };\n      }\n\n      if (metadata.seq) {\n        return onGetMetadataSeq();\n      }\n\n      fetchMetadataSeq();\n    };\n\n  }\n\n  api._remote = false;\n  api.type = function () {\n    return 'idb';\n  };\n\n  api._id = toPromise(function (callback) {\n    callback(null, api._meta.instanceId);\n  });\n\n  api._bulkDocs = function idb_bulkDocs(req, reqOpts, callback) {\n    idbBulkDocs(opts, req, reqOpts, api, idb, callback);\n  };\n\n  // First we look up the metadata in the ids database, then we fetch the\n  // current revision(s) from the by sequence store\n  api._get = function idb_get(id, opts, callback) {\n    var doc;\n    var metadata;\n    var err;\n    var txn = opts.ctx;\n    if (!txn) {\n      var txnResult = openTransactionSafely(idb,\n        [DOC_STORE, BY_SEQ_STORE, ATTACH_STORE], 'readonly');\n      if (txnResult.error) {\n        return callback(txnResult.error);\n      }\n      txn = txnResult.txn;\n    }\n\n    function finish() {\n      callback(err, {doc: doc, metadata: metadata, ctx: txn});\n    }\n\n    txn.objectStore(DOC_STORE).get(id).onsuccess = function (e) {\n      metadata = decodeMetadata(e.target.result);\n      // we can determine the result here if:\n      // 1. there is no such document\n      // 2. the document is deleted and we don't ask about specific rev\n      // When we ask with opts.rev we expect the answer to be either\n      // doc (possibly with _deleted=true) or missing error\n      if (!metadata) {\n        err = createError(MISSING_DOC, 'missing');\n        return finish();\n      }\n\n      var rev$$1;\n      if (!opts.rev) {\n        rev$$1 = metadata.winningRev;\n        var deleted = isDeleted(metadata);\n        if (deleted) {\n          err = createError(MISSING_DOC, \"deleted\");\n          return finish();\n        }\n      } else {\n        rev$$1 = opts.latest ? latest(opts.rev, metadata) : opts.rev;\n      }\n\n      var objectStore = txn.objectStore(BY_SEQ_STORE);\n      var key = metadata.id + '::' + rev$$1;\n\n      objectStore.index('_doc_id_rev').get(key).onsuccess = function (e) {\n        doc = e.target.result;\n        if (doc) {\n          doc = decodeDoc(doc);\n        }\n        if (!doc) {\n          err = createError(MISSING_DOC, 'missing');\n          return finish();\n        }\n        finish();\n      };\n    };\n  };\n\n  api._getAttachment = function (docId, attachId, attachment, opts, callback) {\n    var txn;\n    if (opts.ctx) {\n      txn = opts.ctx;\n    } else {\n      var txnResult = openTransactionSafely(idb,\n        [DOC_STORE, BY_SEQ_STORE, ATTACH_STORE], 'readonly');\n      if (txnResult.error) {\n        return callback(txnResult.error);\n      }\n      txn = txnResult.txn;\n    }\n    var digest = attachment.digest;\n    var type = attachment.content_type;\n\n    txn.objectStore(ATTACH_STORE).get(digest).onsuccess = function (e) {\n      var body = e.target.result.body;\n      readBlobData(body, type, opts.binary, function (blobData) {\n        callback(null, blobData);\n      });\n    };\n  };\n\n  api._info = function idb_info(callback) {\n    var updateSeq;\n    var docCount;\n\n    var txnResult = openTransactionSafely(idb, [META_STORE, BY_SEQ_STORE], 'readonly');\n    if (txnResult.error) {\n      return callback(txnResult.error);\n    }\n    var txn = txnResult.txn;\n    txn.objectStore(META_STORE).get(META_STORE).onsuccess = function (e) {\n      docCount = e.target.result.docCount;\n    };\n    txn.objectStore(BY_SEQ_STORE).openCursor(null, 'prev').onsuccess = function (e) {\n      var cursor = e.target.result;\n      updateSeq = cursor ? cursor.key : 0;\n    };\n\n    txn.oncomplete = function () {\n      callback(null, {\n        doc_count: docCount,\n        update_seq: updateSeq,\n        // for debugging\n        idb_attachment_format: (api._meta.blobSupport ? 'binary' : 'base64')\n      });\n    };\n  };\n\n  api._allDocs = function idb_allDocs(opts, callback) {\n    idbAllDocs(opts, idb, callback);\n  };\n\n  api._changes = function idbChanges(opts) {\n    return changes(opts, api, dbName, idb);\n  };\n\n  api._close = function (callback) {\n    // https://developer.mozilla.org/en-US/docs/IndexedDB/IDBDatabase#close\n    // \"Returns immediately and closes the connection in a separate thread...\"\n    idb.close();\n    cachedDBs.delete(dbName);\n    callback();\n  };\n\n  api._getRevisionTree = function (docId, callback) {\n    var txnResult = openTransactionSafely(idb, [DOC_STORE], 'readonly');\n    if (txnResult.error) {\n      return callback(txnResult.error);\n    }\n    var txn = txnResult.txn;\n    var req = txn.objectStore(DOC_STORE).get(docId);\n    req.onsuccess = function (event) {\n      var doc = decodeMetadata(event.target.result);\n      if (!doc) {\n        callback(createError(MISSING_DOC));\n      } else {\n        callback(null, doc.rev_tree);\n      }\n    };\n  };\n\n  // This function removes revisions of document docId\n  // which are listed in revs and sets this document\n  // revision to to rev_tree\n  api._doCompaction = function (docId, revs, callback) {\n    var stores = [\n      DOC_STORE,\n      BY_SEQ_STORE,\n      ATTACH_STORE,\n      ATTACH_AND_SEQ_STORE\n    ];\n    var txnResult = openTransactionSafely(idb, stores, 'readwrite');\n    if (txnResult.error) {\n      return callback(txnResult.error);\n    }\n    var txn = txnResult.txn;\n\n    var docStore = txn.objectStore(DOC_STORE);\n\n    docStore.get(docId).onsuccess = function (event) {\n      var metadata = decodeMetadata(event.target.result);\n      traverseRevTree(metadata.rev_tree, function (isLeaf, pos,\n                                                         revHash, ctx, opts) {\n        var rev$$1 = pos + '-' + revHash;\n        if (revs.indexOf(rev$$1) !== -1) {\n          opts.status = 'missing';\n        }\n      });\n      compactRevs(revs, docId, txn);\n      var winningRev$$1 = metadata.winningRev;\n      var deleted = metadata.deleted;\n      txn.objectStore(DOC_STORE).put(\n        encodeMetadata(metadata, winningRev$$1, deleted));\n    };\n    txn.onabort = idbError(callback);\n    txn.oncomplete = function () {\n      callback();\n    };\n  };\n\n\n  api._getLocal = function (id, callback) {\n    var txnResult = openTransactionSafely(idb, [LOCAL_STORE], 'readonly');\n    if (txnResult.error) {\n      return callback(txnResult.error);\n    }\n    var tx = txnResult.txn;\n    var req = tx.objectStore(LOCAL_STORE).get(id);\n\n    req.onerror = idbError(callback);\n    req.onsuccess = function (e) {\n      var doc = e.target.result;\n      if (!doc) {\n        callback(createError(MISSING_DOC));\n      } else {\n        delete doc['_doc_id_rev']; // for backwards compat\n        callback(null, doc);\n      }\n    };\n  };\n\n  api._putLocal = function (doc, opts, callback) {\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    delete doc._revisions; // ignore this, trust the rev\n    var oldRev = doc._rev;\n    var id = doc._id;\n    if (!oldRev) {\n      doc._rev = '0-1';\n    } else {\n      doc._rev = '0-' + (parseInt(oldRev.split('-')[1], 10) + 1);\n    }\n\n    var tx = opts.ctx;\n    var ret;\n    if (!tx) {\n      var txnResult = openTransactionSafely(idb, [LOCAL_STORE], 'readwrite');\n      if (txnResult.error) {\n        return callback(txnResult.error);\n      }\n      tx = txnResult.txn;\n      tx.onerror = idbError(callback);\n      tx.oncomplete = function () {\n        if (ret) {\n          callback(null, ret);\n        }\n      };\n    }\n\n    var oStore = tx.objectStore(LOCAL_STORE);\n    var req;\n    if (oldRev) {\n      req = oStore.get(id);\n      req.onsuccess = function (e) {\n        var oldDoc = e.target.result;\n        if (!oldDoc || oldDoc._rev !== oldRev) {\n          callback(createError(REV_CONFLICT));\n        } else { // update\n          var req = oStore.put(doc);\n          req.onsuccess = function () {\n            ret = {ok: true, id: doc._id, rev: doc._rev};\n            if (opts.ctx) { // return immediately\n              callback(null, ret);\n            }\n          };\n        }\n      };\n    } else { // new doc\n      req = oStore.add(doc);\n      req.onerror = function (e) {\n        // constraint error, already exists\n        callback(createError(REV_CONFLICT));\n        e.preventDefault(); // avoid transaction abort\n        e.stopPropagation(); // avoid transaction onerror\n      };\n      req.onsuccess = function () {\n        ret = {ok: true, id: doc._id, rev: doc._rev};\n        if (opts.ctx) { // return immediately\n          callback(null, ret);\n        }\n      };\n    }\n  };\n\n  api._removeLocal = function (doc, opts, callback) {\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    var tx = opts.ctx;\n    if (!tx) {\n      var txnResult = openTransactionSafely(idb, [LOCAL_STORE], 'readwrite');\n      if (txnResult.error) {\n        return callback(txnResult.error);\n      }\n      tx = txnResult.txn;\n      tx.oncomplete = function () {\n        if (ret) {\n          callback(null, ret);\n        }\n      };\n    }\n    var ret;\n    var id = doc._id;\n    var oStore = tx.objectStore(LOCAL_STORE);\n    var req = oStore.get(id);\n\n    req.onerror = idbError(callback);\n    req.onsuccess = function (e) {\n      var oldDoc = e.target.result;\n      if (!oldDoc || oldDoc._rev !== doc._rev) {\n        callback(createError(MISSING_DOC));\n      } else {\n        oStore.delete(id);\n        ret = {ok: true, id: id, rev: '0-0'};\n        if (opts.ctx) { // return immediately\n          callback(null, ret);\n        }\n      }\n    };\n  };\n\n  api._destroy = function (opts, callback) {\n    changesHandler.removeAllListeners(dbName);\n\n    //Close open request for \"dbName\" database to fix ie delay.\n    var openReq = openReqList.get(dbName);\n    if (openReq && openReq.result) {\n      openReq.result.close();\n      cachedDBs.delete(dbName);\n    }\n    var req = indexedDB.deleteDatabase(dbName);\n\n    req.onsuccess = function () {\n      //Remove open request from the list.\n      openReqList.delete(dbName);\n      if (hasLocalStorage() && (dbName in localStorage)) {\n        delete localStorage[dbName];\n      }\n      callback(null, { 'ok': true });\n    };\n\n    req.onerror = idbError(callback);\n  };\n\n  var cached = cachedDBs.get(dbName);\n\n  if (cached) {\n    idb = cached.idb;\n    api._meta = cached.global;\n    return immediate(function () {\n      callback(null, api);\n    });\n  }\n\n  var req = indexedDB.open(dbName, ADAPTER_VERSION);\n  openReqList.set(dbName, req);\n\n  req.onupgradeneeded = function (e) {\n    var db = e.target.result;\n    if (e.oldVersion < 1) {\n      return createSchema(db); // new db, initial schema\n    }\n    // do migrations\n\n    var txn = e.currentTarget.transaction;\n    // these migrations have to be done in this function, before\n    // control is returned to the event loop, because IndexedDB\n\n    if (e.oldVersion < 3) {\n      createLocalStoreSchema(db); // v2 -> v3\n    }\n    if (e.oldVersion < 4) {\n      addAttachAndSeqStore(db); // v3 -> v4\n    }\n\n    var migrations = [\n      addDeletedOrLocalIndex, // v1 -> v2\n      migrateLocalStore,      // v2 -> v3\n      migrateAttsAndSeqs,     // v3 -> v4\n      migrateMetadata         // v4 -> v5\n    ];\n\n    var i = e.oldVersion;\n\n    function next() {\n      var migration = migrations[i - 1];\n      i++;\n      if (migration) {\n        migration(txn, next);\n      }\n    }\n\n    next();\n  };\n\n  req.onsuccess = function (e) {\n\n    idb = e.target.result;\n\n    idb.onversionchange = function () {\n      idb.close();\n      cachedDBs.delete(dbName);\n    };\n\n    idb.onabort = function (e) {\n      guardedConsole('error', 'Database has a global failure', e.target.error);\n      idb.close();\n      cachedDBs.delete(dbName);\n    };\n\n    // Do a few setup operations (in parallel as much as possible):\n    // 1. Fetch meta doc\n    // 2. Check blob support\n    // 3. Calculate docCount\n    // 4. Generate an instanceId if necessary\n    // 5. Store docCount and instanceId on meta doc\n\n    var txn = idb.transaction([\n      META_STORE,\n      DETECT_BLOB_SUPPORT_STORE,\n      DOC_STORE\n    ], 'readwrite');\n\n    var storedMetaDoc = false;\n    var metaDoc;\n    var docCount;\n    var blobSupport;\n    var instanceId;\n\n    function completeSetup() {\n      if (typeof blobSupport === 'undefined' || !storedMetaDoc) {\n        return;\n      }\n      api._meta = {\n        name: dbName,\n        instanceId: instanceId,\n        blobSupport: blobSupport\n      };\n\n      cachedDBs.set(dbName, {\n        idb: idb,\n        global: api._meta\n      });\n      callback(null, api);\n    }\n\n    function storeMetaDocIfReady() {\n      if (typeof docCount === 'undefined' || typeof metaDoc === 'undefined') {\n        return;\n      }\n      var instanceKey = dbName + '_id';\n      if (instanceKey in metaDoc) {\n        instanceId = metaDoc[instanceKey];\n      } else {\n        metaDoc[instanceKey] = instanceId = uuid();\n      }\n      metaDoc.docCount = docCount;\n      txn.objectStore(META_STORE).put(metaDoc);\n    }\n\n    //\n    // fetch or generate the instanceId\n    //\n    txn.objectStore(META_STORE).get(META_STORE).onsuccess = function (e) {\n      metaDoc = e.target.result || { id: META_STORE };\n      storeMetaDocIfReady();\n    };\n\n    //\n    // countDocs\n    //\n    countDocs(txn, function (count) {\n      docCount = count;\n      storeMetaDocIfReady();\n    });\n\n    //\n    // check blob support\n    //\n    if (!blobSupportPromise) {\n      // make sure blob support is only checked once\n      blobSupportPromise = checkBlobSupport(txn);\n    }\n\n    blobSupportPromise.then(function (val) {\n      blobSupport = val;\n      completeSetup();\n    });\n\n    // only when the metadata put transaction has completed,\n    // consider the setup done\n    txn.oncomplete = function () {\n      storedMetaDoc = true;\n      completeSetup();\n    };\n    txn.onabort = idbError(callback);\n  };\n\n  req.onerror = function () {\n    var msg = 'Failed to open indexedDB, are you in private browsing mode?';\n    guardedConsole('error', msg);\n    callback(createError(IDB_ERROR, msg));\n  };\n}\n\nIdbPouch.valid = function () {\n  // Following #7085 buggy idb versions (typically Safari < 10.1) are\n  // considered valid.\n\n  // On Firefox SecurityError is thrown while referencing indexedDB if cookies\n  // are not allowed. `typeof indexedDB` also triggers the error.\n  try {\n    // some outdated implementations of IDB that appear on Samsung\n    // and HTC Android devices <4.4 are missing IDBKeyRange\n    return typeof indexedDB !== 'undefined' && typeof IDBKeyRange !== 'undefined';\n  } catch (e) {\n    return false;\n  }\n};\n\nfunction IDBPouch (PouchDB) {\n  PouchDB.adapter('idb', IdbPouch, true);\n}\n\n// dead simple promise pool, inspired by https://github.com/timdp/es6-promise-pool\n// but much smaller in code size. limits the number of concurrent promises that are executed\n\n\nfunction pool(promiseFactories, limit) {\n  return new Promise(function (resolve, reject) {\n    var running = 0;\n    var current = 0;\n    var done = 0;\n    var len = promiseFactories.length;\n    var err;\n\n    function runNext() {\n      running++;\n      promiseFactories[current++]().then(onSuccess, onError);\n    }\n\n    function doNext() {\n      if (++done === len) {\n        /* istanbul ignore if */\n        if (err) {\n          reject(err);\n        } else {\n          resolve();\n        }\n      } else {\n        runNextBatch();\n      }\n    }\n\n    function onSuccess() {\n      running--;\n      doNext();\n    }\n\n    /* istanbul ignore next */\n    function onError(thisErr) {\n      running--;\n      err = err || thisErr;\n      doNext();\n    }\n\n    function runNextBatch() {\n      while (running < limit && current < len) {\n        runNext();\n      }\n    }\n\n    runNextBatch();\n  });\n}\n\nvar CHANGES_BATCH_SIZE = 25;\nvar MAX_SIMULTANEOUS_REVS = 50;\nvar CHANGES_TIMEOUT_BUFFER = 5000;\nvar DEFAULT_HEARTBEAT = 10000;\n\nvar supportsBulkGetMap = {};\n\nfunction readAttachmentsAsBlobOrBuffer(row) {\n  var doc = row.doc || row.ok;\n  var atts = doc && doc._attachments;\n  if (!atts) {\n    return;\n  }\n  Object.keys(atts).forEach(function (filename) {\n    var att = atts[filename];\n    att.data = b64ToBluffer(att.data, att.content_type);\n  });\n}\n\nfunction encodeDocId(id) {\n  if (/^_design/.test(id)) {\n    return '_design/' + encodeURIComponent(id.slice(8));\n  }\n  if (/^_local/.test(id)) {\n    return '_local/' + encodeURIComponent(id.slice(7));\n  }\n  return encodeURIComponent(id);\n}\n\nfunction preprocessAttachments$1(doc) {\n  if (!doc._attachments || !Object.keys(doc._attachments)) {\n    return Promise.resolve();\n  }\n\n  return Promise.all(Object.keys(doc._attachments).map(function (key) {\n    var attachment = doc._attachments[key];\n    if (attachment.data && typeof attachment.data !== 'string') {\n      return new Promise(function (resolve) {\n        blobToBase64(attachment.data, resolve);\n      }).then(function (b64) {\n        attachment.data = b64;\n      });\n    }\n  }));\n}\n\nfunction hasUrlPrefix(opts) {\n  if (!opts.prefix) {\n    return false;\n  }\n  var protocol = parseUri(opts.prefix).protocol;\n  return protocol === 'http' || protocol === 'https';\n}\n\n// Get all the information you possibly can about the URI given by name and\n// return it as a suitable object.\nfunction getHost(name, opts) {\n  // encode db name if opts.prefix is a url (#5574)\n  if (hasUrlPrefix(opts)) {\n    var dbName = opts.name.substr(opts.prefix.length);\n    // Ensure prefix has a trailing slash\n    var prefix = opts.prefix.replace(/\\/?$/, '/');\n    name = prefix + encodeURIComponent(dbName);\n  }\n\n  var uri = parseUri(name);\n  if (uri.user || uri.password) {\n    uri.auth = {username: uri.user, password: uri.password};\n  }\n\n  // Split the path part of the URI into parts using '/' as the delimiter\n  // after removing any leading '/' and any trailing '/'\n  var parts = uri.path.replace(/(^\\/|\\/$)/g, '').split('/');\n\n  uri.db = parts.pop();\n  // Prevent double encoding of URI component\n  if (uri.db.indexOf('%') === -1) {\n    uri.db = encodeURIComponent(uri.db);\n  }\n\n  uri.path = parts.join('/');\n\n  return uri;\n}\n\n// Generate a URL with the host data given by opts and the given path\nfunction genDBUrl(opts, path) {\n  return genUrl(opts, opts.db + '/' + path);\n}\n\n// Generate a URL with the host data given by opts and the given path\nfunction genUrl(opts, path) {\n  // If the host already has a path, then we need to have a path delimiter\n  // Otherwise, the path delimiter is the empty string\n  var pathDel = !opts.path ? '' : '/';\n\n  // If the host already has a path, then we need to have a path delimiter\n  // Otherwise, the path delimiter is the empty string\n  return opts.protocol + '://' + opts.host +\n         (opts.port ? (':' + opts.port) : '') +\n         '/' + opts.path + pathDel + path;\n}\n\nfunction paramsToStr(params) {\n  return '?' + Object.keys(params).map(function (k) {\n    return k + '=' + encodeURIComponent(params[k]);\n  }).join('&');\n}\n\nfunction shouldCacheBust(opts) {\n  var ua = (typeof navigator !== 'undefined' && navigator.userAgent) ?\n      navigator.userAgent.toLowerCase() : '';\n  var isIE = ua.indexOf('msie') !== -1;\n  var isTrident = ua.indexOf('trident') !== -1;\n  var isEdge = ua.indexOf('edge') !== -1;\n  var isGET = !('method' in opts) || opts.method === 'GET';\n  return (isIE || isTrident || isEdge) && isGET;\n}\n\n// Implements the PouchDB API for dealing with CouchDB instances over HTTP\nfunction HttpPouch(opts, callback) {\n\n  // The functions that will be publicly available for HttpPouch\n  var api = this;\n\n  var host = getHost(opts.name, opts);\n  var dbUrl = genDBUrl(host, '');\n\n  opts = clone(opts);\n\n  var ourFetch = function (url, options) {\n\n    options = options || {};\n    options.headers = options.headers || new h();\n\n    options.credentials = 'include';\n\n    if (opts.auth || host.auth) {\n      var nAuth = opts.auth || host.auth;\n      var str = nAuth.username + ':' + nAuth.password;\n      var token = thisBtoa(unescape(encodeURIComponent(str)));\n      options.headers.set('Authorization', 'Basic ' + token);\n    }\n\n    var headers = opts.headers || {};\n    Object.keys(headers).forEach(function (key) {\n      options.headers.append(key, headers[key]);\n    });\n\n    /* istanbul ignore if */\n    if (shouldCacheBust(options)) {\n      url += (url.indexOf('?') === -1 ? '?' : '&') + '_nonce=' + Date.now();\n    }\n\n    var fetchFun = opts.fetch || f$1;\n    return fetchFun(url, options);\n  };\n\n  function adapterFun$$1(name, fun) {\n    return adapterFun(name, getArguments(function (args) {\n      setup().then(function () {\n        return fun.apply(this, args);\n      }).catch(function (e) {\n        var callback = args.pop();\n        callback(e);\n      });\n    })).bind(api);\n  }\n\n  function fetchJSON(url, options, callback) {\n\n    var result = {};\n\n    options = options || {};\n    options.headers = options.headers || new h();\n\n    if (!options.headers.get('Content-Type')) {\n      options.headers.set('Content-Type', 'application/json');\n    }\n    if (!options.headers.get('Accept')) {\n      options.headers.set('Accept', 'application/json');\n    }\n\n    return ourFetch(url, options).then(function (response) {\n      result.ok = response.ok;\n      result.status = response.status;\n      return response.json();\n    }).then(function (json) {\n      result.data = json;\n      if (!result.ok) {\n        result.data.status = result.status;\n        var err = generateErrorFromResponse(result.data);\n        if (callback) {\n          return callback(err);\n        } else {\n          throw err;\n        }\n      }\n\n      if (Array.isArray(result.data)) {\n        result.data = result.data.map(function (v) {\n          if (v.error || v.missing) {\n            return generateErrorFromResponse(v);\n          } else {\n            return v;\n          }\n        });\n      }\n\n      if (callback) {\n        callback(null, result.data);\n      } else {\n        return result;\n      }\n    });\n  }\n\n  var setupPromise;\n\n  function setup() {\n    if (opts.skip_setup) {\n      return Promise.resolve();\n    }\n\n    // If there is a setup in process or previous successful setup\n    // done then we will use that\n    // If previous setups have been rejected we will try again\n    if (setupPromise) {\n      return setupPromise;\n    }\n\n    setupPromise = fetchJSON(dbUrl).catch(function (err) {\n      if (err && err.status && err.status === 404) {\n        // Doesnt exist, create it\n        explainError(404, 'PouchDB is just detecting if the remote exists.');\n        return fetchJSON(dbUrl, {method: 'PUT'});\n      } else {\n        return Promise.reject(err);\n      }\n    }).catch(function (err) {\n      // If we try to create a database that already exists, skipped in\n      // istanbul since its catching a race condition.\n      /* istanbul ignore if */\n      if (err && err.status && err.status === 412) {\n        return true;\n      }\n      return Promise.reject(err);\n    });\n\n    setupPromise.catch(function () {\n      setupPromise = null;\n    });\n\n    return setupPromise;\n  }\n\n  immediate(function () {\n    callback(null, api);\n  });\n\n  api._remote = true;\n\n  /* istanbul ignore next */\n  api.type = function () {\n    return 'http';\n  };\n\n  api.id = adapterFun$$1('id', function (callback) {\n    ourFetch(genUrl(host, '')).then(function (response) {\n      return response.json();\n    }).catch(function () {\n      return {};\n    }).then(function (result) {\n      // Bad response or missing `uuid` should not prevent ID generation.\n      var uuid$$1 = (result && result.uuid) ?\n          (result.uuid + host.db) : genDBUrl(host, '');\n      callback(null, uuid$$1);\n    });\n  });\n\n  // Sends a POST request to the host calling the couchdb _compact function\n  //    version: The version of CouchDB it is running\n  api.compact = adapterFun$$1('compact', function (opts, callback) {\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    opts = clone(opts);\n\n    fetchJSON(genDBUrl(host, '_compact'), {method: 'POST'}).then(function () {\n      function ping() {\n        api.info(function (err, res) {\n          // CouchDB may send a \"compact_running:true\" if it's\n          // already compacting. PouchDB Server doesn't.\n          /* istanbul ignore else */\n          if (res && !res.compact_running) {\n            callback(null, {ok: true});\n          } else {\n            setTimeout(ping, opts.interval || 200);\n          }\n        });\n      }\n      // Ping the http if it's finished compaction\n      ping();\n    });\n  });\n\n  api.bulkGet = adapterFun('bulkGet', function (opts, callback) {\n    var self = this;\n\n    function doBulkGet(cb) {\n      var params = {};\n      if (opts.revs) {\n        params.revs = true;\n      }\n      if (opts.attachments) {\n        /* istanbul ignore next */\n        params.attachments = true;\n      }\n      if (opts.latest) {\n        params.latest = true;\n      }\n      fetchJSON(genDBUrl(host, '_bulk_get' + paramsToStr(params)), {\n        method: 'POST',\n        body: JSON.stringify({ docs: opts.docs})\n      }).then(function (result) {\n        if (opts.attachments && opts.binary) {\n          result.data.results.forEach(function (res) {\n            res.docs.forEach(readAttachmentsAsBlobOrBuffer);\n          });\n        }\n        cb(null, result.data);\n      }).catch(cb);\n    }\n\n    /* istanbul ignore next */\n    function doBulkGetShim() {\n      // avoid \"url too long error\" by splitting up into multiple requests\n      var batchSize = MAX_SIMULTANEOUS_REVS;\n      var numBatches = Math.ceil(opts.docs.length / batchSize);\n      var numDone = 0;\n      var results = new Array(numBatches);\n\n      function onResult(batchNum) {\n        return function (err, res) {\n          // err is impossible because shim returns a list of errs in that case\n          results[batchNum] = res.results;\n          if (++numDone === numBatches) {\n            callback(null, {results: flatten(results)});\n          }\n        };\n      }\n\n      for (var i = 0; i < numBatches; i++) {\n        var subOpts = pick(opts, ['revs', 'attachments', 'binary', 'latest']);\n        subOpts.docs = opts.docs.slice(i * batchSize,\n          Math.min(opts.docs.length, (i + 1) * batchSize));\n        bulkGet(self, subOpts, onResult(i));\n      }\n    }\n\n    // mark the whole database as either supporting or not supporting _bulk_get\n    var dbUrl = genUrl(host, '');\n    var supportsBulkGet = supportsBulkGetMap[dbUrl];\n\n    /* istanbul ignore next */\n    if (typeof supportsBulkGet !== 'boolean') {\n      // check if this database supports _bulk_get\n      doBulkGet(function (err, res) {\n        if (err) {\n          supportsBulkGetMap[dbUrl] = false;\n          explainError(\n            err.status,\n            'PouchDB is just detecting if the remote ' +\n            'supports the _bulk_get API.'\n          );\n          doBulkGetShim();\n        } else {\n          supportsBulkGetMap[dbUrl] = true;\n          callback(null, res);\n        }\n      });\n    } else if (supportsBulkGet) {\n      doBulkGet(callback);\n    } else {\n      doBulkGetShim();\n    }\n  });\n\n  // Calls GET on the host, which gets back a JSON string containing\n  //    couchdb: A welcome string\n  //    version: The version of CouchDB it is running\n  api._info = function (callback) {\n    setup().then(function () {\n      return ourFetch(genDBUrl(host, ''));\n    }).then(function (response) {\n      return response.json();\n    }).then(function (info) {\n      info.host = genDBUrl(host, '');\n      callback(null, info);\n    }).catch(callback);\n  };\n\n  api.fetch = function (path, options) {\n    return setup().then(function () {\n      var url = path.substring(0, 1) === '/' ?\n        genUrl(host, path.substring(1)) :\n        genDBUrl(host, path);\n      return ourFetch(url, options);\n    });\n  };\n\n  // Get the document with the given id from the database given by host.\n  // The id could be solely the _id in the database, or it may be a\n  // _design/ID or _local/ID path\n  api.get = adapterFun$$1('get', function (id, opts, callback) {\n    // If no options were given, set the callback to the second parameter\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    opts = clone(opts);\n\n    // List of parameters to add to the GET request\n    var params = {};\n\n    if (opts.revs) {\n      params.revs = true;\n    }\n\n    if (opts.revs_info) {\n      params.revs_info = true;\n    }\n\n    if (opts.latest) {\n      params.latest = true;\n    }\n\n    if (opts.open_revs) {\n      if (opts.open_revs !== \"all\") {\n        opts.open_revs = JSON.stringify(opts.open_revs);\n      }\n      params.open_revs = opts.open_revs;\n    }\n\n    if (opts.rev) {\n      params.rev = opts.rev;\n    }\n\n    if (opts.conflicts) {\n      params.conflicts = opts.conflicts;\n    }\n\n    /* istanbul ignore if */\n    if (opts.update_seq) {\n      params.update_seq = opts.update_seq;\n    }\n\n    id = encodeDocId(id);\n\n    function fetchAttachments(doc) {\n      var atts = doc._attachments;\n      var filenames = atts && Object.keys(atts);\n      if (!atts || !filenames.length) {\n        return;\n      }\n      // we fetch these manually in separate XHRs, because\n      // Sync Gateway would normally send it back as multipart/mixed,\n      // which we cannot parse. Also, this is more efficient than\n      // receiving attachments as base64-encoded strings.\n      function fetchData(filename) {\n        var att = atts[filename];\n        var path = encodeDocId(doc._id) + '/' + encodeAttachmentId(filename) +\n            '?rev=' + doc._rev;\n        return ourFetch(genDBUrl(host, path)).then(function (response) {\n          if (typeof process !== 'undefined' && !process.browser) {\n            return response.buffer();\n          } else {\n            /* istanbul ignore next */\n            return response.blob();\n          }\n        }).then(function (blob) {\n          if (opts.binary) {\n            // TODO: Can we remove this?\n            if (typeof process !== 'undefined' && !process.browser) {\n              blob.type = att.content_type;\n            }\n            return blob;\n          }\n          return new Promise(function (resolve) {\n            blobToBase64(blob, resolve);\n          });\n        }).then(function (data) {\n          delete att.stub;\n          delete att.length;\n          att.data = data;\n        });\n      }\n\n      var promiseFactories = filenames.map(function (filename) {\n        return function () {\n          return fetchData(filename);\n        };\n      });\n\n      // This limits the number of parallel xhr requests to 5 any time\n      // to avoid issues with maximum browser request limits\n      return pool(promiseFactories, 5);\n    }\n\n    function fetchAllAttachments(docOrDocs) {\n      if (Array.isArray(docOrDocs)) {\n        return Promise.all(docOrDocs.map(function (doc) {\n          if (doc.ok) {\n            return fetchAttachments(doc.ok);\n          }\n        }));\n      }\n      return fetchAttachments(docOrDocs);\n    }\n\n    var url = genDBUrl(host, id + paramsToStr(params));\n    fetchJSON(url).then(function (res) {\n      return Promise.resolve().then(function () {\n        if (opts.attachments) {\n          return fetchAllAttachments(res.data);\n        }\n      }).then(function () {\n        callback(null, res.data);\n      });\n    }).catch(function (e) {\n      e.docId = id;\n      callback(e);\n    });\n  });\n\n\n  // Delete the document given by doc from the database given by host.\n  api.remove = adapterFun$$1('remove', function (docOrId, optsOrRev, opts, cb) {\n    var doc;\n    if (typeof optsOrRev === 'string') {\n      // id, rev, opts, callback style\n      doc = {\n        _id: docOrId,\n        _rev: optsOrRev\n      };\n      if (typeof opts === 'function') {\n        cb = opts;\n        opts = {};\n      }\n    } else {\n      // doc, opts, callback style\n      doc = docOrId;\n      if (typeof optsOrRev === 'function') {\n        cb = optsOrRev;\n        opts = {};\n      } else {\n        cb = opts;\n        opts = optsOrRev;\n      }\n    }\n\n    var rev$$1 = (doc._rev || opts.rev);\n    var url = genDBUrl(host, encodeDocId(doc._id)) + '?rev=' + rev$$1;\n\n    fetchJSON(url, {method: 'DELETE'}, cb).catch(cb);\n  });\n\n  function encodeAttachmentId(attachmentId) {\n    return attachmentId.split(\"/\").map(encodeURIComponent).join(\"/\");\n  }\n\n  // Get the attachment\n  api.getAttachment = adapterFun$$1('getAttachment', function (docId, attachmentId,\n                                                            opts, callback) {\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    var params = opts.rev ? ('?rev=' + opts.rev) : '';\n    var url = genDBUrl(host, encodeDocId(docId)) + '/' +\n        encodeAttachmentId(attachmentId) + params;\n    var contentType;\n    ourFetch(url, {method: 'GET'}).then(function (response) {\n      contentType = response.headers.get('content-type');\n      if (!response.ok) {\n        throw response;\n      } else {\n        if (typeof process !== 'undefined' && !process.browser) {\n          return response.buffer();\n        } else {\n          /* istanbul ignore next */\n          return response.blob();\n        }\n      }\n    }).then(function (blob) {\n      // TODO: also remove\n      if (typeof process !== 'undefined' && !process.browser) {\n        blob.type = contentType;\n      }\n      callback(null, blob);\n    }).catch(function (err) {\n      callback(err);\n    });\n  });\n\n  // Remove the attachment given by the id and rev\n  api.removeAttachment =  adapterFun$$1('removeAttachment', function (docId,\n                                                                   attachmentId,\n                                                                   rev$$1,\n                                                                   callback) {\n    var url = genDBUrl(host, encodeDocId(docId) + '/' +\n                       encodeAttachmentId(attachmentId)) + '?rev=' + rev$$1;\n    fetchJSON(url, {method: 'DELETE'}, callback).catch(callback);\n  });\n\n  // Add the attachment given by blob and its contentType property\n  // to the document with the given id, the revision given by rev, and\n  // add it to the database given by host.\n  api.putAttachment = adapterFun$$1('putAttachment', function (docId, attachmentId,\n                                                            rev$$1, blob,\n                                                            type, callback) {\n    if (typeof type === 'function') {\n      callback = type;\n      type = blob;\n      blob = rev$$1;\n      rev$$1 = null;\n    }\n    var id = encodeDocId(docId) + '/' + encodeAttachmentId(attachmentId);\n    var url = genDBUrl(host, id);\n    if (rev$$1) {\n      url += '?rev=' + rev$$1;\n    }\n\n    if (typeof blob === 'string') {\n      // input is assumed to be a base64 string\n      var binary;\n      try {\n        binary = thisAtob(blob);\n      } catch (err) {\n        return callback(createError(BAD_ARG,\n                        'Attachment is not a valid base64 string'));\n      }\n      blob = binary ? binStringToBluffer(binary, type) : '';\n    }\n\n    // Add the attachment\n    fetchJSON(url, {\n      headers: new h({'Content-Type': type}),\n      method: 'PUT',\n      body: blob\n    }, callback).catch(callback);\n  });\n\n  // Update/create multiple documents given by req in the database\n  // given by host.\n  api._bulkDocs = function (req, opts, callback) {\n    // If new_edits=false then it prevents the database from creating\n    // new revision numbers for the documents. Instead it just uses\n    // the old ones. This is used in database replication.\n    req.new_edits = opts.new_edits;\n\n    setup().then(function () {\n      return Promise.all(req.docs.map(preprocessAttachments$1));\n    }).then(function () {\n      // Update/create the documents\n      return fetchJSON(genDBUrl(host, '_bulk_docs'), {\n        method: 'POST',\n        body: JSON.stringify(req)\n      }, callback);\n    }).catch(callback);\n  };\n\n\n  // Update/create document\n  api._put = function (doc, opts, callback) {\n    setup().then(function () {\n      return preprocessAttachments$1(doc);\n    }).then(function () {\n      return fetchJSON(genDBUrl(host, encodeDocId(doc._id)), {\n        method: 'PUT',\n        body: JSON.stringify(doc)\n      });\n    }).then(function (result) {\n      callback(null, result.data);\n    }).catch(function (err) {\n      err.docId = doc && doc._id;\n      callback(err);\n    });\n  };\n\n\n  // Get a listing of the documents in the database given\n  // by host and ordered by increasing id.\n  api.allDocs = adapterFun$$1('allDocs', function (opts, callback) {\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    opts = clone(opts);\n\n    // List of parameters to add to the GET request\n    var params = {};\n    var body;\n    var method = 'GET';\n\n    if (opts.conflicts) {\n      params.conflicts = true;\n    }\n\n    /* istanbul ignore if */\n    if (opts.update_seq) {\n      params.update_seq = true;\n    }\n\n    if (opts.descending) {\n      params.descending = true;\n    }\n\n    if (opts.include_docs) {\n      params.include_docs = true;\n    }\n\n    // added in CouchDB 1.6.0\n    if (opts.attachments) {\n      params.attachments = true;\n    }\n\n    if (opts.key) {\n      params.key = JSON.stringify(opts.key);\n    }\n\n    if (opts.start_key) {\n      opts.startkey = opts.start_key;\n    }\n\n    if (opts.startkey) {\n      params.startkey = JSON.stringify(opts.startkey);\n    }\n\n    if (opts.end_key) {\n      opts.endkey = opts.end_key;\n    }\n\n    if (opts.endkey) {\n      params.endkey = JSON.stringify(opts.endkey);\n    }\n\n    if (typeof opts.inclusive_end !== 'undefined') {\n      params.inclusive_end = !!opts.inclusive_end;\n    }\n\n    if (typeof opts.limit !== 'undefined') {\n      params.limit = opts.limit;\n    }\n\n    if (typeof opts.skip !== 'undefined') {\n      params.skip = opts.skip;\n    }\n\n    var paramStr = paramsToStr(params);\n\n    if (typeof opts.keys !== 'undefined') {\n      method = 'POST';\n      body = {keys: opts.keys};\n    }\n\n    fetchJSON(genDBUrl(host, '_all_docs' + paramStr), {\n       method: method,\n      body: JSON.stringify(body)\n    }).then(function (result) {\n      if (opts.include_docs && opts.attachments && opts.binary) {\n        result.data.rows.forEach(readAttachmentsAsBlobOrBuffer);\n      }\n      callback(null, result.data);\n    }).catch(callback);\n  });\n\n  // Get a list of changes made to documents in the database given by host.\n  // TODO According to the README, there should be two other methods here,\n  // api.changes.addListener and api.changes.removeListener.\n  api._changes = function (opts) {\n\n    // We internally page the results of a changes request, this means\n    // if there is a large set of changes to be returned we can start\n    // processing them quicker instead of waiting on the entire\n    // set of changes to return and attempting to process them at once\n    var batchSize = 'batch_size' in opts ? opts.batch_size : CHANGES_BATCH_SIZE;\n\n    opts = clone(opts);\n\n    if (opts.continuous && !('heartbeat' in opts)) {\n      opts.heartbeat = DEFAULT_HEARTBEAT;\n    }\n\n    var requestTimeout = ('timeout' in opts) ? opts.timeout : 30 * 1000;\n\n    // ensure CHANGES_TIMEOUT_BUFFER applies\n    if ('timeout' in opts && opts.timeout &&\n      (requestTimeout - opts.timeout) < CHANGES_TIMEOUT_BUFFER) {\n        requestTimeout = opts.timeout + CHANGES_TIMEOUT_BUFFER;\n    }\n\n    /* istanbul ignore if */\n    if ('heartbeat' in opts && opts.heartbeat &&\n       (requestTimeout - opts.heartbeat) < CHANGES_TIMEOUT_BUFFER) {\n        requestTimeout = opts.heartbeat + CHANGES_TIMEOUT_BUFFER;\n    }\n\n    var params = {};\n    if ('timeout' in opts && opts.timeout) {\n      params.timeout = opts.timeout;\n    }\n\n    var limit = (typeof opts.limit !== 'undefined') ? opts.limit : false;\n    var leftToFetch = limit;\n\n    if (opts.style) {\n      params.style = opts.style;\n    }\n\n    if (opts.include_docs || opts.filter && typeof opts.filter === 'function') {\n      params.include_docs = true;\n    }\n\n    if (opts.attachments) {\n      params.attachments = true;\n    }\n\n    if (opts.continuous) {\n      params.feed = 'longpoll';\n    }\n\n    if (opts.seq_interval) {\n      params.seq_interval = opts.seq_interval;\n    }\n\n    if (opts.conflicts) {\n      params.conflicts = true;\n    }\n\n    if (opts.descending) {\n      params.descending = true;\n    }\n    \n    /* istanbul ignore if */\n    if (opts.update_seq) {\n      params.update_seq = true;\n    }\n\n    if ('heartbeat' in opts) {\n      // If the heartbeat value is false, it disables the default heartbeat\n      if (opts.heartbeat) {\n        params.heartbeat = opts.heartbeat;\n      }\n    }\n\n    if (opts.filter && typeof opts.filter === 'string') {\n      params.filter = opts.filter;\n    }\n\n    if (opts.view && typeof opts.view === 'string') {\n      params.filter = '_view';\n      params.view = opts.view;\n    }\n\n    // If opts.query_params exists, pass it through to the changes request.\n    // These parameters may be used by the filter on the source database.\n    if (opts.query_params && typeof opts.query_params === 'object') {\n      for (var param_name in opts.query_params) {\n        /* istanbul ignore else */\n        if (opts.query_params.hasOwnProperty(param_name)) {\n          params[param_name] = opts.query_params[param_name];\n        }\n      }\n    }\n\n    var method = 'GET';\n    var body;\n\n    if (opts.doc_ids) {\n      // set this automagically for the user; it's annoying that couchdb\n      // requires both a \"filter\" and a \"doc_ids\" param.\n      params.filter = '_doc_ids';\n      method = 'POST';\n      body = {doc_ids: opts.doc_ids };\n    }\n    /* istanbul ignore next */\n    else if (opts.selector) {\n      // set this automagically for the user, similar to above\n      params.filter = '_selector';\n      method = 'POST';\n      body = {selector: opts.selector };\n    }\n\n    var controller = new a();\n    var lastFetchedSeq;\n\n    // Get all the changes starting wtih the one immediately after the\n    // sequence number given by since.\n    var fetchData = function (since, callback) {\n      if (opts.aborted) {\n        return;\n      }\n      params.since = since;\n      // \"since\" can be any kind of json object in Cloudant/CouchDB 2.x\n      /* istanbul ignore next */\n      if (typeof params.since === \"object\") {\n        params.since = JSON.stringify(params.since);\n      }\n\n      if (opts.descending) {\n        if (limit) {\n          params.limit = leftToFetch;\n        }\n      } else {\n        params.limit = (!limit || leftToFetch > batchSize) ?\n          batchSize : leftToFetch;\n      }\n\n      // Set the options for the ajax call\n      var url = genDBUrl(host, '_changes' + paramsToStr(params));\n      var fetchOpts = {\n        signal: controller.signal,\n        method: method,\n        body: JSON.stringify(body)\n      };\n      lastFetchedSeq = since;\n\n      /* istanbul ignore if */\n      if (opts.aborted) {\n        return;\n      }\n\n      // Get the changes\n      setup().then(function () {\n        return fetchJSON(url, fetchOpts, callback);\n      }).catch(callback);\n    };\n\n    // If opts.since exists, get all the changes from the sequence\n    // number given by opts.since. Otherwise, get all the changes\n    // from the sequence number 0.\n    var results = {results: []};\n\n    var fetched = function (err, res) {\n      if (opts.aborted) {\n        return;\n      }\n      var raw_results_length = 0;\n      // If the result of the ajax call (res) contains changes (res.results)\n      if (res && res.results) {\n        raw_results_length = res.results.length;\n        results.last_seq = res.last_seq;\n        var pending = null;\n        var lastSeq = null;\n        // Attach 'pending' property if server supports it (CouchDB 2.0+)\n        /* istanbul ignore if */\n        if (typeof res.pending === 'number') {\n          pending = res.pending;\n        }\n        if (typeof results.last_seq === 'string' || typeof results.last_seq === 'number') {\n          lastSeq = results.last_seq;\n        }\n        // For each change\n        var req = {};\n        req.query = opts.query_params;\n        res.results = res.results.filter(function (c) {\n          leftToFetch--;\n          var ret = filterChange(opts)(c);\n          if (ret) {\n            if (opts.include_docs && opts.attachments && opts.binary) {\n              readAttachmentsAsBlobOrBuffer(c);\n            }\n            if (opts.return_docs) {\n              results.results.push(c);\n            }\n            opts.onChange(c, pending, lastSeq);\n          }\n          return ret;\n        });\n      } else if (err) {\n        // In case of an error, stop listening for changes and call\n        // opts.complete\n        opts.aborted = true;\n        opts.complete(err);\n        return;\n      }\n\n      // The changes feed may have timed out with no results\n      // if so reuse last update sequence\n      if (res && res.last_seq) {\n        lastFetchedSeq = res.last_seq;\n      }\n\n      var finished = (limit && leftToFetch <= 0) ||\n        (res && raw_results_length < batchSize) ||\n        (opts.descending);\n\n      if ((opts.continuous && !(limit && leftToFetch <= 0)) || !finished) {\n        // Queue a call to fetch again with the newest sequence number\n        immediate(function () { fetchData(lastFetchedSeq, fetched); });\n      } else {\n        // We're done, call the callback\n        opts.complete(null, results);\n      }\n    };\n\n    fetchData(opts.since || 0, fetched);\n\n    // Return a method to cancel this method from processing any more\n    return {\n      cancel: function () {\n        opts.aborted = true;\n        controller.abort();\n      }\n    };\n  };\n\n  // Given a set of document/revision IDs (given by req), tets the subset of\n  // those that do NOT correspond to revisions stored in the database.\n  // See http://wiki.apache.org/couchdb/HttpPostRevsDiff\n  api.revsDiff = adapterFun$$1('revsDiff', function (req, opts, callback) {\n    // If no options were given, set the callback to be the second parameter\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n\n    // Get the missing document/revision IDs\n    fetchJSON(genDBUrl(host, '_revs_diff'), {\n      method: 'POST',\n      body: JSON.stringify(req)\n    }, callback).catch(callback);\n  });\n\n  api._close = function (callback) {\n    callback();\n  };\n\n  api._destroy = function (options, callback) {\n    fetchJSON(genDBUrl(host, ''), {method: 'DELETE'}).then(function (json) {\n      callback(null, json);\n    }).catch(function (err) {\n      /* istanbul ignore if */\n      if (err.status === 404) {\n        callback(null, {ok: true});\n      } else {\n        callback(err);\n      }\n    });\n  };\n}\n\n// HttpPouch is a valid adapter.\nHttpPouch.valid = function () {\n  return true;\n};\n\nfunction HttpPouch$1 (PouchDB) {\n  PouchDB.adapter('http', HttpPouch, false);\n  PouchDB.adapter('https', HttpPouch, false);\n}\n\nfunction QueryParseError(message) {\n  this.status = 400;\n  this.name = 'query_parse_error';\n  this.message = message;\n  this.error = true;\n  try {\n    Error.captureStackTrace(this, QueryParseError);\n  } catch (e) {}\n}\n\ninherits(QueryParseError, Error);\n\nfunction NotFoundError(message) {\n  this.status = 404;\n  this.name = 'not_found';\n  this.message = message;\n  this.error = true;\n  try {\n    Error.captureStackTrace(this, NotFoundError);\n  } catch (e) {}\n}\n\ninherits(NotFoundError, Error);\n\nfunction BuiltInError(message) {\n  this.status = 500;\n  this.name = 'invalid_value';\n  this.message = message;\n  this.error = true;\n  try {\n    Error.captureStackTrace(this, BuiltInError);\n  } catch (e) {}\n}\n\ninherits(BuiltInError, Error);\n\nfunction promisedCallback(promise, callback) {\n  if (callback) {\n    promise.then(function (res) {\n      immediate(function () {\n        callback(null, res);\n      });\n    }, function (reason) {\n      immediate(function () {\n        callback(reason);\n      });\n    });\n  }\n  return promise;\n}\n\nfunction callbackify(fun) {\n  return getArguments(function (args) {\n    var cb = args.pop();\n    var promise = fun.apply(this, args);\n    if (typeof cb === 'function') {\n      promisedCallback(promise, cb);\n    }\n    return promise;\n  });\n}\n\n// Promise finally util similar to Q.finally\nfunction fin(promise, finalPromiseFactory) {\n  return promise.then(function (res) {\n    return finalPromiseFactory().then(function () {\n      return res;\n    });\n  }, function (reason) {\n    return finalPromiseFactory().then(function () {\n      throw reason;\n    });\n  });\n}\n\nfunction sequentialize(queue, promiseFactory) {\n  return function () {\n    var args = arguments;\n    var that = this;\n    return queue.add(function () {\n      return promiseFactory.apply(that, args);\n    });\n  };\n}\n\n// uniq an array of strings, order not guaranteed\n// similar to underscore/lodash _.uniq\nfunction uniq(arr) {\n  var theSet = new ExportedSet(arr);\n  var result = new Array(theSet.size);\n  var index = -1;\n  theSet.forEach(function (value) {\n    result[++index] = value;\n  });\n  return result;\n}\n\nfunction mapToKeysArray(map) {\n  var result = new Array(map.size);\n  var index = -1;\n  map.forEach(function (value, key) {\n    result[++index] = key;\n  });\n  return result;\n}\n\nfunction createBuiltInError(name) {\n  var message = 'builtin ' + name +\n    ' function requires map values to be numbers' +\n    ' or number arrays';\n  return new BuiltInError(message);\n}\n\nfunction sum(values) {\n  var result = 0;\n  for (var i = 0, len = values.length; i < len; i++) {\n    var num = values[i];\n    if (typeof num !== 'number') {\n      if (Array.isArray(num)) {\n        // lists of numbers are also allowed, sum them separately\n        result = typeof result === 'number' ? [result] : result;\n        for (var j = 0, jLen = num.length; j < jLen; j++) {\n          var jNum = num[j];\n          if (typeof jNum !== 'number') {\n            throw createBuiltInError('_sum');\n          } else if (typeof result[j] === 'undefined') {\n            result.push(jNum);\n          } else {\n            result[j] += jNum;\n          }\n        }\n      } else { // not array/number\n        throw createBuiltInError('_sum');\n      }\n    } else if (typeof result === 'number') {\n      result += num;\n    } else { // add number to array\n      result[0] += num;\n    }\n  }\n  return result;\n}\n\nvar log = guardedConsole.bind(null, 'log');\nvar isArray = Array.isArray;\nvar toJSON = JSON.parse;\n\nfunction evalFunctionWithEval(func, emit) {\n  return scopeEval(\n    \"return (\" + func.replace(/;\\s*$/, \"\") + \");\",\n    {\n      emit: emit,\n      sum: sum,\n      log: log,\n      isArray: isArray,\n      toJSON: toJSON\n    }\n  );\n}\n\n/*\n * Simple task queue to sequentialize actions. Assumes\n * callbacks will eventually fire (once).\n */\n\n\nfunction TaskQueue$1() {\n  this.promise = new Promise(function (fulfill) {fulfill(); });\n}\nTaskQueue$1.prototype.add = function (promiseFactory) {\n  this.promise = this.promise.catch(function () {\n    // just recover\n  }).then(function () {\n    return promiseFactory();\n  });\n  return this.promise;\n};\nTaskQueue$1.prototype.finish = function () {\n  return this.promise;\n};\n\nfunction stringify(input) {\n  if (!input) {\n    return 'undefined'; // backwards compat for empty reduce\n  }\n  // for backwards compat with mapreduce, functions/strings are stringified\n  // as-is. everything else is JSON-stringified.\n  switch (typeof input) {\n    case 'function':\n      // e.g. a mapreduce map\n      return input.toString();\n    case 'string':\n      // e.g. a mapreduce built-in _reduce function\n      return input.toString();\n    default:\n      // e.g. a JSON object in the case of mango queries\n      return JSON.stringify(input);\n  }\n}\n\n/* create a string signature for a view so we can cache it and uniq it */\nfunction createViewSignature(mapFun, reduceFun) {\n  // the \"undefined\" part is for backwards compatibility\n  return stringify(mapFun) + stringify(reduceFun) + 'undefined';\n}\n\nfunction createView(sourceDB, viewName, mapFun, reduceFun, temporary, localDocName) {\n  var viewSignature = createViewSignature(mapFun, reduceFun);\n\n  var cachedViews;\n  if (!temporary) {\n    // cache this to ensure we don't try to update the same view twice\n    cachedViews = sourceDB._cachedViews = sourceDB._cachedViews || {};\n    if (cachedViews[viewSignature]) {\n      return cachedViews[viewSignature];\n    }\n  }\n\n  var promiseForView = sourceDB.info().then(function (info) {\n\n    var depDbName = info.db_name + '-mrview-' +\n      (temporary ? 'temp' : stringMd5(viewSignature));\n\n    // save the view name in the source db so it can be cleaned up if necessary\n    // (e.g. when the _design doc is deleted, remove all associated view data)\n    function diffFunction(doc) {\n      doc.views = doc.views || {};\n      var fullViewName = viewName;\n      if (fullViewName.indexOf('/') === -1) {\n        fullViewName = viewName + '/' + viewName;\n      }\n      var depDbs = doc.views[fullViewName] = doc.views[fullViewName] || {};\n      /* istanbul ignore if */\n      if (depDbs[depDbName]) {\n        return; // no update necessary\n      }\n      depDbs[depDbName] = true;\n      return doc;\n    }\n    return upsert(sourceDB, '_local/' + localDocName, diffFunction).then(function () {\n      return sourceDB.registerDependentDatabase(depDbName).then(function (res) {\n        var db = res.db;\n        db.auto_compaction = true;\n        var view = {\n          name: depDbName,\n          db: db,\n          sourceDB: sourceDB,\n          adapter: sourceDB.adapter,\n          mapFun: mapFun,\n          reduceFun: reduceFun\n        };\n        return view.db.get('_local/lastSeq').catch(function (err) {\n          /* istanbul ignore if */\n          if (err.status !== 404) {\n            throw err;\n          }\n        }).then(function (lastSeqDoc) {\n          view.seq = lastSeqDoc ? lastSeqDoc.seq : 0;\n          if (cachedViews) {\n            view.db.once('destroyed', function () {\n              delete cachedViews[viewSignature];\n            });\n          }\n          return view;\n        });\n      });\n    });\n  });\n\n  if (cachedViews) {\n    cachedViews[viewSignature] = promiseForView;\n  }\n  return promiseForView;\n}\n\nvar persistentQueues = {};\nvar tempViewQueue = new TaskQueue$1();\nvar CHANGES_BATCH_SIZE$1 = 50;\n\nfunction parseViewName(name) {\n  // can be either 'ddocname/viewname' or just 'viewname'\n  // (where the ddoc name is the same)\n  return name.indexOf('/') === -1 ? [name, name] : name.split('/');\n}\n\nfunction isGenOne(changes) {\n  // only return true if the current change is 1-\n  // and there are no other leafs\n  return changes.length === 1 && /^1-/.test(changes[0].rev);\n}\n\nfunction emitError(db, e) {\n  try {\n    db.emit('error', e);\n  } catch (err) {\n    guardedConsole('error',\n      'The user\\'s map/reduce function threw an uncaught error.\\n' +\n      'You can debug this error by doing:\\n' +\n      'myDatabase.on(\\'error\\', function (err) { debugger; });\\n' +\n      'Please double-check your map/reduce function.');\n    guardedConsole('error', e);\n  }\n}\n\n/**\n * Returns an \"abstract\" mapreduce object of the form:\n *\n *   {\n *     query: queryFun,\n *     viewCleanup: viewCleanupFun\n *   }\n *\n * Arguments are:\n *\n * localDoc: string\n *   This is for the local doc that gets saved in order to track the\n *   \"dependent\" DBs and clean them up for viewCleanup. It should be\n *   unique, so that indexer plugins don't collide with each other.\n * mapper: function (mapFunDef, emit)\n *   Returns a map function based on the mapFunDef, which in the case of\n *   normal map/reduce is just the de-stringified function, but may be\n *   something else, such as an object in the case of pouchdb-find.\n * reducer: function (reduceFunDef)\n *   Ditto, but for reducing. Modules don't have to support reducing\n *   (e.g. pouchdb-find).\n * ddocValidator: function (ddoc, viewName)\n *   Throws an error if the ddoc or viewName is not valid.\n *   This could be a way to communicate to the user that the configuration for the\n *   indexer is invalid.\n */\nfunction createAbstractMapReduce(localDocName, mapper, reducer, ddocValidator) {\n\n  function tryMap(db, fun, doc) {\n    // emit an event if there was an error thrown by a map function.\n    // putting try/catches in a single function also avoids deoptimizations.\n    try {\n      fun(doc);\n    } catch (e) {\n      emitError(db, e);\n    }\n  }\n\n  function tryReduce(db, fun, keys, values, rereduce) {\n    // same as above, but returning the result or an error. there are two separate\n    // functions to avoid extra memory allocations since the tryCode() case is used\n    // for custom map functions (common) vs this function, which is only used for\n    // custom reduce functions (rare)\n    try {\n      return {output : fun(keys, values, rereduce)};\n    } catch (e) {\n      emitError(db, e);\n      return {error: e};\n    }\n  }\n\n  function sortByKeyThenValue(x, y) {\n    var keyCompare = collate(x.key, y.key);\n    return keyCompare !== 0 ? keyCompare : collate(x.value, y.value);\n  }\n\n  function sliceResults(results, limit, skip) {\n    skip = skip || 0;\n    if (typeof limit === 'number') {\n      return results.slice(skip, limit + skip);\n    } else if (skip > 0) {\n      return results.slice(skip);\n    }\n    return results;\n  }\n\n  function rowToDocId(row) {\n    var val = row.value;\n    // Users can explicitly specify a joined doc _id, or it\n    // defaults to the doc _id that emitted the key/value.\n    var docId = (val && typeof val === 'object' && val._id) || row.id;\n    return docId;\n  }\n\n  function readAttachmentsAsBlobOrBuffer(res) {\n    res.rows.forEach(function (row) {\n      var atts = row.doc && row.doc._attachments;\n      if (!atts) {\n        return;\n      }\n      Object.keys(atts).forEach(function (filename) {\n        var att = atts[filename];\n        atts[filename].data = b64ToBluffer(att.data, att.content_type);\n      });\n    });\n  }\n\n  function postprocessAttachments(opts) {\n    return function (res) {\n      if (opts.include_docs && opts.attachments && opts.binary) {\n        readAttachmentsAsBlobOrBuffer(res);\n      }\n      return res;\n    };\n  }\n\n  function addHttpParam(paramName, opts, params, asJson) {\n    // add an http param from opts to params, optionally json-encoded\n    var val = opts[paramName];\n    if (typeof val !== 'undefined') {\n      if (asJson) {\n        val = encodeURIComponent(JSON.stringify(val));\n      }\n      params.push(paramName + '=' + val);\n    }\n  }\n\n  function coerceInteger(integerCandidate) {\n    if (typeof integerCandidate !== 'undefined') {\n      var asNumber = Number(integerCandidate);\n      // prevents e.g. '1foo' or '1.1' being coerced to 1\n      if (!isNaN(asNumber) && asNumber === parseInt(integerCandidate, 10)) {\n        return asNumber;\n      } else {\n        return integerCandidate;\n      }\n    }\n  }\n\n  function coerceOptions(opts) {\n    opts.group_level = coerceInteger(opts.group_level);\n    opts.limit = coerceInteger(opts.limit);\n    opts.skip = coerceInteger(opts.skip);\n    return opts;\n  }\n\n  function checkPositiveInteger(number) {\n    if (number) {\n      if (typeof number !== 'number') {\n        return  new QueryParseError('Invalid value for integer: \"' +\n          number + '\"');\n      }\n      if (number < 0) {\n        return new QueryParseError('Invalid value for positive integer: ' +\n          '\"' + number + '\"');\n      }\n    }\n  }\n\n  function checkQueryParseError(options, fun) {\n    var startkeyName = options.descending ? 'endkey' : 'startkey';\n    var endkeyName = options.descending ? 'startkey' : 'endkey';\n\n    if (typeof options[startkeyName] !== 'undefined' &&\n      typeof options[endkeyName] !== 'undefined' &&\n      collate(options[startkeyName], options[endkeyName]) > 0) {\n      throw new QueryParseError('No rows can match your key range, ' +\n        'reverse your start_key and end_key or set {descending : true}');\n    } else if (fun.reduce && options.reduce !== false) {\n      if (options.include_docs) {\n        throw new QueryParseError('{include_docs:true} is invalid for reduce');\n      } else if (options.keys && options.keys.length > 1 &&\n        !options.group && !options.group_level) {\n        throw new QueryParseError('Multi-key fetches for reduce views must use ' +\n          '{group: true}');\n      }\n    }\n    ['group_level', 'limit', 'skip'].forEach(function (optionName) {\n      var error = checkPositiveInteger(options[optionName]);\n      if (error) {\n        throw error;\n      }\n    });\n  }\n\n  function httpQuery(db, fun, opts) {\n    // List of parameters to add to the PUT request\n    var params = [];\n    var body;\n    var method = 'GET';\n    var ok, status;\n\n    // If opts.reduce exists and is defined, then add it to the list\n    // of parameters.\n    // If reduce=false then the results are that of only the map function\n    // not the final result of map and reduce.\n    addHttpParam('reduce', opts, params);\n    addHttpParam('include_docs', opts, params);\n    addHttpParam('attachments', opts, params);\n    addHttpParam('limit', opts, params);\n    addHttpParam('descending', opts, params);\n    addHttpParam('group', opts, params);\n    addHttpParam('group_level', opts, params);\n    addHttpParam('skip', opts, params);\n    addHttpParam('stale', opts, params);\n    addHttpParam('conflicts', opts, params);\n    addHttpParam('startkey', opts, params, true);\n    addHttpParam('start_key', opts, params, true);\n    addHttpParam('endkey', opts, params, true);\n    addHttpParam('end_key', opts, params, true);\n    addHttpParam('inclusive_end', opts, params);\n    addHttpParam('key', opts, params, true);\n    addHttpParam('update_seq', opts, params);\n\n    // Format the list of parameters into a valid URI query string\n    params = params.join('&');\n    params = params === '' ? '' : '?' + params;\n\n    // If keys are supplied, issue a POST to circumvent GET query string limits\n    // see http://wiki.apache.org/couchdb/HTTP_view_API#Querying_Options\n    if (typeof opts.keys !== 'undefined') {\n      var MAX_URL_LENGTH = 2000;\n      // according to http://stackoverflow.com/a/417184/680742,\n      // the de facto URL length limit is 2000 characters\n\n      var keysAsString =\n        'keys=' + encodeURIComponent(JSON.stringify(opts.keys));\n      if (keysAsString.length + params.length + 1 <= MAX_URL_LENGTH) {\n        // If the keys are short enough, do a GET. we do this to work around\n        // Safari not understanding 304s on POSTs (see pouchdb/pouchdb#1239)\n        params += (params[0] === '?' ? '&' : '?') + keysAsString;\n      } else {\n        method = 'POST';\n        if (typeof fun === 'string') {\n          body = {keys: opts.keys};\n        } else { // fun is {map : mapfun}, so append to this\n          fun.keys = opts.keys;\n        }\n      }\n    }\n\n    // We are referencing a query defined in the design doc\n    if (typeof fun === 'string') {\n      var parts = parseViewName(fun);\n      return db.fetch('_design/' + parts[0] + '/_view/' + parts[1] + params, {\n        headers: new h({'Content-Type': 'application/json'}),\n        method: method,\n        body: JSON.stringify(body)\n      }).then(function (response) {\n        ok = response.ok;\n        status = response.status;\n        return response.json();\n      }).then(function (result) {\n        if (!ok) {\n          result.status = status;\n          throw generateErrorFromResponse(result);\n        }\n        // fail the entire request if the result contains an error\n        result.rows.forEach(function (row) {\n          /* istanbul ignore if */\n          if (row.value && row.value.error && row.value.error === \"builtin_reduce_error\") {\n            throw new Error(row.reason);\n          }\n        });\n        return result;\n      }).then(postprocessAttachments(opts));\n    }\n\n    // We are using a temporary view, terrible for performance, good for testing\n    body = body || {};\n    Object.keys(fun).forEach(function (key) {\n      if (Array.isArray(fun[key])) {\n        body[key] = fun[key];\n      } else {\n        body[key] = fun[key].toString();\n      }\n    });\n\n    return db.fetch('_temp_view' + params, {\n      headers: new h({'Content-Type': 'application/json'}),\n      method: 'POST',\n      body: JSON.stringify(body)\n    }).then(function (response) {\n        ok = response.ok;\n        status = response.status;\n      return response.json();\n    }).then(function (result) {\n      if (!ok) {\n        result.status = status;\n        throw generateErrorFromResponse(result);\n      }\n      return result;\n    }).then(postprocessAttachments(opts));\n  }\n\n  // custom adapters can define their own api._query\n  // and override the default behavior\n  /* istanbul ignore next */\n  function customQuery(db, fun, opts) {\n    return new Promise(function (resolve, reject) {\n      db._query(fun, opts, function (err, res) {\n        if (err) {\n          return reject(err);\n        }\n        resolve(res);\n      });\n    });\n  }\n\n  // custom adapters can define their own api._viewCleanup\n  // and override the default behavior\n  /* istanbul ignore next */\n  function customViewCleanup(db) {\n    return new Promise(function (resolve, reject) {\n      db._viewCleanup(function (err, res) {\n        if (err) {\n          return reject(err);\n        }\n        resolve(res);\n      });\n    });\n  }\n\n  function defaultsTo(value) {\n    return function (reason) {\n      /* istanbul ignore else */\n      if (reason.status === 404) {\n        return value;\n      } else {\n        throw reason;\n      }\n    };\n  }\n\n  // returns a promise for a list of docs to update, based on the input docId.\n  // the order doesn't matter, because post-3.2.0, bulkDocs\n  // is an atomic operation in all three adapters.\n  function getDocsToPersist(docId, view, docIdsToChangesAndEmits) {\n    var metaDocId = '_local/doc_' + docId;\n    var defaultMetaDoc = {_id: metaDocId, keys: []};\n    var docData = docIdsToChangesAndEmits.get(docId);\n    var indexableKeysToKeyValues = docData[0];\n    var changes = docData[1];\n\n    function getMetaDoc() {\n      if (isGenOne(changes)) {\n        // generation 1, so we can safely assume initial state\n        // for performance reasons (avoids unnecessary GETs)\n        return Promise.resolve(defaultMetaDoc);\n      }\n      return view.db.get(metaDocId).catch(defaultsTo(defaultMetaDoc));\n    }\n\n    function getKeyValueDocs(metaDoc) {\n      if (!metaDoc.keys.length) {\n        // no keys, no need for a lookup\n        return Promise.resolve({rows: []});\n      }\n      return view.db.allDocs({\n        keys: metaDoc.keys,\n        include_docs: true\n      });\n    }\n\n    function processKeyValueDocs(metaDoc, kvDocsRes) {\n      var kvDocs = [];\n      var oldKeys = new ExportedSet();\n\n      for (var i = 0, len = kvDocsRes.rows.length; i < len; i++) {\n        var row = kvDocsRes.rows[i];\n        var doc = row.doc;\n        if (!doc) { // deleted\n          continue;\n        }\n        kvDocs.push(doc);\n        oldKeys.add(doc._id);\n        doc._deleted = !indexableKeysToKeyValues.has(doc._id);\n        if (!doc._deleted) {\n          var keyValue = indexableKeysToKeyValues.get(doc._id);\n          if ('value' in keyValue) {\n            doc.value = keyValue.value;\n          }\n        }\n      }\n      var newKeys = mapToKeysArray(indexableKeysToKeyValues);\n      newKeys.forEach(function (key) {\n        if (!oldKeys.has(key)) {\n          // new doc\n          var kvDoc = {\n            _id: key\n          };\n          var keyValue = indexableKeysToKeyValues.get(key);\n          if ('value' in keyValue) {\n            kvDoc.value = keyValue.value;\n          }\n          kvDocs.push(kvDoc);\n        }\n      });\n      metaDoc.keys = uniq(newKeys.concat(metaDoc.keys));\n      kvDocs.push(metaDoc);\n\n      return kvDocs;\n    }\n\n    return getMetaDoc().then(function (metaDoc) {\n      return getKeyValueDocs(metaDoc).then(function (kvDocsRes) {\n        return processKeyValueDocs(metaDoc, kvDocsRes);\n      });\n    });\n  }\n\n  // updates all emitted key/value docs and metaDocs in the mrview database\n  // for the given batch of documents from the source database\n  function saveKeyValues(view, docIdsToChangesAndEmits, seq) {\n    var seqDocId = '_local/lastSeq';\n    return view.db.get(seqDocId)\n      .catch(defaultsTo({_id: seqDocId, seq: 0}))\n      .then(function (lastSeqDoc) {\n        var docIds = mapToKeysArray(docIdsToChangesAndEmits);\n        return Promise.all(docIds.map(function (docId) {\n          return getDocsToPersist(docId, view, docIdsToChangesAndEmits);\n        })).then(function (listOfDocsToPersist) {\n          var docsToPersist = flatten(listOfDocsToPersist);\n          lastSeqDoc.seq = seq;\n          docsToPersist.push(lastSeqDoc);\n          // write all docs in a single operation, update the seq once\n          return view.db.bulkDocs({docs : docsToPersist});\n        });\n      });\n  }\n\n  function getQueue(view) {\n    var viewName = typeof view === 'string' ? view : view.name;\n    var queue = persistentQueues[viewName];\n    if (!queue) {\n      queue = persistentQueues[viewName] = new TaskQueue$1();\n    }\n    return queue;\n  }\n\n  function updateView(view) {\n    return sequentialize(getQueue(view), function () {\n      return updateViewInQueue(view);\n    })();\n  }\n\n  function updateViewInQueue(view) {\n    // bind the emit function once\n    var mapResults;\n    var doc;\n\n    function emit(key, value) {\n      var output = {id: doc._id, key: normalizeKey(key)};\n      // Don't explicitly store the value unless it's defined and non-null.\n      // This saves on storage space, because often people don't use it.\n      if (typeof value !== 'undefined' && value !== null) {\n        output.value = normalizeKey(value);\n      }\n      mapResults.push(output);\n    }\n\n    var mapFun = mapper(view.mapFun, emit);\n\n    var currentSeq = view.seq || 0;\n\n    function processChange(docIdsToChangesAndEmits, seq) {\n      return function () {\n        return saveKeyValues(view, docIdsToChangesAndEmits, seq);\n      };\n    }\n\n    var queue = new TaskQueue$1();\n\n    function processNextBatch() {\n      return view.sourceDB.changes({\n        return_docs: true,\n        conflicts: true,\n        include_docs: true,\n        style: 'all_docs',\n        since: currentSeq,\n        limit: CHANGES_BATCH_SIZE$1\n      }).then(processBatch);\n    }\n\n    function processBatch(response) {\n      var results = response.results;\n      if (!results.length) {\n        return;\n      }\n      var docIdsToChangesAndEmits = createDocIdsToChangesAndEmits(results);\n      queue.add(processChange(docIdsToChangesAndEmits, currentSeq));\n      if (results.length < CHANGES_BATCH_SIZE$1) {\n        return;\n      }\n      return processNextBatch();\n    }\n\n    function createDocIdsToChangesAndEmits(results) {\n      var docIdsToChangesAndEmits = new ExportedMap();\n      for (var i = 0, len = results.length; i < len; i++) {\n        var change = results[i];\n        if (change.doc._id[0] !== '_') {\n          mapResults = [];\n          doc = change.doc;\n\n          if (!doc._deleted) {\n            tryMap(view.sourceDB, mapFun, doc);\n          }\n          mapResults.sort(sortByKeyThenValue);\n\n          var indexableKeysToKeyValues = createIndexableKeysToKeyValues(mapResults);\n          docIdsToChangesAndEmits.set(change.doc._id, [\n            indexableKeysToKeyValues,\n            change.changes\n          ]);\n        }\n        currentSeq = change.seq;\n      }\n      return docIdsToChangesAndEmits;\n    }\n\n    function createIndexableKeysToKeyValues(mapResults) {\n      var indexableKeysToKeyValues = new ExportedMap();\n      var lastKey;\n      for (var i = 0, len = mapResults.length; i < len; i++) {\n        var emittedKeyValue = mapResults[i];\n        var complexKey = [emittedKeyValue.key, emittedKeyValue.id];\n        if (i > 0 && collate(emittedKeyValue.key, lastKey) === 0) {\n          complexKey.push(i); // dup key+id, so make it unique\n        }\n        indexableKeysToKeyValues.set(toIndexableString(complexKey), emittedKeyValue);\n        lastKey = emittedKeyValue.key;\n      }\n      return indexableKeysToKeyValues;\n    }\n\n    return processNextBatch().then(function () {\n      return queue.finish();\n    }).then(function () {\n      view.seq = currentSeq;\n    });\n  }\n\n  function reduceView(view, results, options) {\n    if (options.group_level === 0) {\n      delete options.group_level;\n    }\n\n    var shouldGroup = options.group || options.group_level;\n\n    var reduceFun = reducer(view.reduceFun);\n\n    var groups = [];\n    var lvl = isNaN(options.group_level) ? Number.POSITIVE_INFINITY :\n      options.group_level;\n    results.forEach(function (e) {\n      var last = groups[groups.length - 1];\n      var groupKey = shouldGroup ? e.key : null;\n\n      // only set group_level for array keys\n      if (shouldGroup && Array.isArray(groupKey)) {\n        groupKey = groupKey.slice(0, lvl);\n      }\n\n      if (last && collate(last.groupKey, groupKey) === 0) {\n        last.keys.push([e.key, e.id]);\n        last.values.push(e.value);\n        return;\n      }\n      groups.push({\n        keys: [[e.key, e.id]],\n        values: [e.value],\n        groupKey: groupKey\n      });\n    });\n    results = [];\n    for (var i = 0, len = groups.length; i < len; i++) {\n      var e = groups[i];\n      var reduceTry = tryReduce(view.sourceDB, reduceFun, e.keys, e.values, false);\n      if (reduceTry.error && reduceTry.error instanceof BuiltInError) {\n        // CouchDB returns an error if a built-in errors out\n        throw reduceTry.error;\n      }\n      results.push({\n        // CouchDB just sets the value to null if a non-built-in errors out\n        value: reduceTry.error ? null : reduceTry.output,\n        key: e.groupKey\n      });\n    }\n    // no total_rows/offset when reducing\n    return {rows: sliceResults(results, options.limit, options.skip)};\n  }\n\n  function queryView(view, opts) {\n    return sequentialize(getQueue(view), function () {\n      return queryViewInQueue(view, opts);\n    })();\n  }\n\n  function queryViewInQueue(view, opts) {\n    var totalRows;\n    var shouldReduce = view.reduceFun && opts.reduce !== false;\n    var skip = opts.skip || 0;\n    if (typeof opts.keys !== 'undefined' && !opts.keys.length) {\n      // equivalent query\n      opts.limit = 0;\n      delete opts.keys;\n    }\n\n    function fetchFromView(viewOpts) {\n      viewOpts.include_docs = true;\n      return view.db.allDocs(viewOpts).then(function (res) {\n        totalRows = res.total_rows;\n        return res.rows.map(function (result) {\n\n          // implicit migration - in older versions of PouchDB,\n          // we explicitly stored the doc as {id: ..., key: ..., value: ...}\n          // this is tested in a migration test\n          /* istanbul ignore next */\n          if ('value' in result.doc && typeof result.doc.value === 'object' &&\n            result.doc.value !== null) {\n            var keys = Object.keys(result.doc.value).sort();\n            // this detection method is not perfect, but it's unlikely the user\n            // emitted a value which was an object with these 3 exact keys\n            var expectedKeys = ['id', 'key', 'value'];\n            if (!(keys < expectedKeys || keys > expectedKeys)) {\n              return result.doc.value;\n            }\n          }\n\n          var parsedKeyAndDocId = parseIndexableString(result.doc._id);\n          return {\n            key: parsedKeyAndDocId[0],\n            id: parsedKeyAndDocId[1],\n            value: ('value' in result.doc ? result.doc.value : null)\n          };\n        });\n      });\n    }\n\n    function onMapResultsReady(rows) {\n      var finalResults;\n      if (shouldReduce) {\n        finalResults = reduceView(view, rows, opts);\n      } else {\n        finalResults = {\n          total_rows: totalRows,\n          offset: skip,\n          rows: rows\n        };\n      }\n      /* istanbul ignore if */\n      if (opts.update_seq) {\n        finalResults.update_seq = view.seq;\n      }\n      if (opts.include_docs) {\n        var docIds = uniq(rows.map(rowToDocId));\n\n        return view.sourceDB.allDocs({\n          keys: docIds,\n          include_docs: true,\n          conflicts: opts.conflicts,\n          attachments: opts.attachments,\n          binary: opts.binary\n        }).then(function (allDocsRes) {\n          var docIdsToDocs = new ExportedMap();\n          allDocsRes.rows.forEach(function (row) {\n            docIdsToDocs.set(row.id, row.doc);\n          });\n          rows.forEach(function (row) {\n            var docId = rowToDocId(row);\n            var doc = docIdsToDocs.get(docId);\n            if (doc) {\n              row.doc = doc;\n            }\n          });\n          return finalResults;\n        });\n      } else {\n        return finalResults;\n      }\n    }\n\n    if (typeof opts.keys !== 'undefined') {\n      var keys = opts.keys;\n      var fetchPromises = keys.map(function (key) {\n        var viewOpts = {\n          startkey : toIndexableString([key]),\n          endkey   : toIndexableString([key, {}])\n        };\n        /* istanbul ignore if */\n        if (opts.update_seq) {\n          viewOpts.update_seq = true;\n        }\n        return fetchFromView(viewOpts);\n      });\n      return Promise.all(fetchPromises).then(flatten).then(onMapResultsReady);\n    } else { // normal query, no 'keys'\n      var viewOpts = {\n        descending : opts.descending\n      };\n      /* istanbul ignore if */\n      if (opts.update_seq) {\n        viewOpts.update_seq = true;\n      }\n      var startkey;\n      var endkey;\n      if ('start_key' in opts) {\n        startkey = opts.start_key;\n      }\n      if ('startkey' in opts) {\n        startkey = opts.startkey;\n      }\n      if ('end_key' in opts) {\n        endkey = opts.end_key;\n      }\n      if ('endkey' in opts) {\n        endkey = opts.endkey;\n      }\n      if (typeof startkey !== 'undefined') {\n        viewOpts.startkey = opts.descending ?\n          toIndexableString([startkey, {}]) :\n          toIndexableString([startkey]);\n      }\n      if (typeof endkey !== 'undefined') {\n        var inclusiveEnd = opts.inclusive_end !== false;\n        if (opts.descending) {\n          inclusiveEnd = !inclusiveEnd;\n        }\n\n        viewOpts.endkey = toIndexableString(\n          inclusiveEnd ? [endkey, {}] : [endkey]);\n      }\n      if (typeof opts.key !== 'undefined') {\n        var keyStart = toIndexableString([opts.key]);\n        var keyEnd = toIndexableString([opts.key, {}]);\n        if (viewOpts.descending) {\n          viewOpts.endkey = keyStart;\n          viewOpts.startkey = keyEnd;\n        } else {\n          viewOpts.startkey = keyStart;\n          viewOpts.endkey = keyEnd;\n        }\n      }\n      if (!shouldReduce) {\n        if (typeof opts.limit === 'number') {\n          viewOpts.limit = opts.limit;\n        }\n        viewOpts.skip = skip;\n      }\n      return fetchFromView(viewOpts).then(onMapResultsReady);\n    }\n  }\n\n  function httpViewCleanup(db) {\n    return db.fetch('_view_cleanup', {\n      headers: new h({'Content-Type': 'application/json'}),\n      method: 'POST'\n    }).then(function (response) {\n      return response.json();\n    });\n  }\n\n  function localViewCleanup(db) {\n    return db.get('_local/' + localDocName).then(function (metaDoc) {\n      var docsToViews = new ExportedMap();\n      Object.keys(metaDoc.views).forEach(function (fullViewName) {\n        var parts = parseViewName(fullViewName);\n        var designDocName = '_design/' + parts[0];\n        var viewName = parts[1];\n        var views = docsToViews.get(designDocName);\n        if (!views) {\n          views = new ExportedSet();\n          docsToViews.set(designDocName, views);\n        }\n        views.add(viewName);\n      });\n      var opts = {\n        keys : mapToKeysArray(docsToViews),\n        include_docs : true\n      };\n      return db.allDocs(opts).then(function (res) {\n        var viewsToStatus = {};\n        res.rows.forEach(function (row) {\n          var ddocName = row.key.substring(8); // cuts off '_design/'\n          docsToViews.get(row.key).forEach(function (viewName) {\n            var fullViewName = ddocName + '/' + viewName;\n            /* istanbul ignore if */\n            if (!metaDoc.views[fullViewName]) {\n              // new format, without slashes, to support PouchDB 2.2.0\n              // migration test in pouchdb's browser.migration.js verifies this\n              fullViewName = viewName;\n            }\n            var viewDBNames = Object.keys(metaDoc.views[fullViewName]);\n            // design doc deleted, or view function nonexistent\n            var statusIsGood = row.doc && row.doc.views &&\n              row.doc.views[viewName];\n            viewDBNames.forEach(function (viewDBName) {\n              viewsToStatus[viewDBName] =\n                viewsToStatus[viewDBName] || statusIsGood;\n            });\n          });\n        });\n        var dbsToDelete = Object.keys(viewsToStatus).filter(\n          function (viewDBName) { return !viewsToStatus[viewDBName]; });\n        var destroyPromises = dbsToDelete.map(function (viewDBName) {\n          return sequentialize(getQueue(viewDBName), function () {\n            return new db.constructor(viewDBName, db.__opts).destroy();\n          })();\n        });\n        return Promise.all(destroyPromises).then(function () {\n          return {ok: true};\n        });\n      });\n    }, defaultsTo({ok: true}));\n  }\n\n  function queryPromised(db, fun, opts) {\n    /* istanbul ignore next */\n    if (typeof db._query === 'function') {\n      return customQuery(db, fun, opts);\n    }\n    if (isRemote(db)) {\n      return httpQuery(db, fun, opts);\n    }\n\n    if (typeof fun !== 'string') {\n      // temp_view\n      checkQueryParseError(opts, fun);\n\n      tempViewQueue.add(function () {\n        var createViewPromise = createView(\n          /* sourceDB */ db,\n          /* viewName */ 'temp_view/temp_view',\n          /* mapFun */ fun.map,\n          /* reduceFun */ fun.reduce,\n          /* temporary */ true,\n          /* localDocName */ localDocName);\n        return createViewPromise.then(function (view) {\n          return fin(updateView(view).then(function () {\n            return queryView(view, opts);\n          }), function () {\n            return view.db.destroy();\n          });\n        });\n      });\n      return tempViewQueue.finish();\n    } else {\n      // persistent view\n      var fullViewName = fun;\n      var parts = parseViewName(fullViewName);\n      var designDocName = parts[0];\n      var viewName = parts[1];\n      return db.get('_design/' + designDocName).then(function (doc) {\n        var fun = doc.views && doc.views[viewName];\n\n        if (!fun) {\n          // basic validator; it's assumed that every subclass would want this\n          throw new NotFoundError('ddoc ' + doc._id + ' has no view named ' +\n            viewName);\n        }\n\n        ddocValidator(doc, viewName);\n        checkQueryParseError(opts, fun);\n\n        var createViewPromise = createView(\n          /* sourceDB */ db,\n          /* viewName */ fullViewName,\n          /* mapFun */ fun.map,\n          /* reduceFun */ fun.reduce,\n          /* temporary */ false,\n          /* localDocName */ localDocName);\n        return createViewPromise.then(function (view) {\n          if (opts.stale === 'ok' || opts.stale === 'update_after') {\n            if (opts.stale === 'update_after') {\n              immediate(function () {\n                updateView(view);\n              });\n            }\n            return queryView(view, opts);\n          } else { // stale not ok\n            return updateView(view).then(function () {\n              return queryView(view, opts);\n            });\n          }\n        });\n      });\n    }\n  }\n\n  function abstractQuery(fun, opts, callback) {\n    var db = this;\n    if (typeof opts === 'function') {\n      callback = opts;\n      opts = {};\n    }\n    opts = opts ? coerceOptions(opts) : {};\n\n    if (typeof fun === 'function') {\n      fun = {map : fun};\n    }\n\n    var promise = Promise.resolve().then(function () {\n      return queryPromised(db, fun, opts);\n    });\n    promisedCallback(promise, callback);\n    return promise;\n  }\n\n  var abstractViewCleanup = callbackify(function () {\n    var db = this;\n    /* istanbul ignore next */\n    if (typeof db._viewCleanup === 'function') {\n      return customViewCleanup(db);\n    }\n    if (isRemote(db)) {\n      return httpViewCleanup(db);\n    }\n    return localViewCleanup(db);\n  });\n\n  return {\n    query: abstractQuery,\n    viewCleanup: abstractViewCleanup\n  };\n}\n\nvar builtInReduce = {\n  _sum: function (keys, values) {\n    return sum(values);\n  },\n\n  _count: function (keys, values) {\n    return values.length;\n  },\n\n  _stats: function (keys, values) {\n    // no need to implement rereduce=true, because Pouch\n    // will never call it\n    function sumsqr(values) {\n      var _sumsqr = 0;\n      for (var i = 0, len = values.length; i < len; i++) {\n        var num = values[i];\n        _sumsqr += (num * num);\n      }\n      return _sumsqr;\n    }\n    return {\n      sum     : sum(values),\n      min     : Math.min.apply(null, values),\n      max     : Math.max.apply(null, values),\n      count   : values.length,\n      sumsqr : sumsqr(values)\n    };\n  }\n};\n\nfunction getBuiltIn(reduceFunString) {\n  if (/^_sum/.test(reduceFunString)) {\n    return builtInReduce._sum;\n  } else if (/^_count/.test(reduceFunString)) {\n    return builtInReduce._count;\n  } else if (/^_stats/.test(reduceFunString)) {\n    return builtInReduce._stats;\n  } else if (/^_/.test(reduceFunString)) {\n    throw new Error(reduceFunString + ' is not a supported reduce function.');\n  }\n}\n\nfunction mapper(mapFun, emit) {\n  // for temp_views one can use emit(doc, emit), see #38\n  if (typeof mapFun === \"function\" && mapFun.length === 2) {\n    var origMap = mapFun;\n    return function (doc) {\n      return origMap(doc, emit);\n    };\n  } else {\n    return evalFunctionWithEval(mapFun.toString(), emit);\n  }\n}\n\nfunction reducer(reduceFun) {\n  var reduceFunString = reduceFun.toString();\n  var builtIn = getBuiltIn(reduceFunString);\n  if (builtIn) {\n    return builtIn;\n  } else {\n    return evalFunctionWithEval(reduceFunString);\n  }\n}\n\nfunction ddocValidator(ddoc, viewName) {\n  var fun = ddoc.views && ddoc.views[viewName];\n  if (typeof fun.map !== 'string') {\n    throw new NotFoundError('ddoc ' + ddoc._id + ' has no string view named ' +\n      viewName + ', instead found object of type: ' + typeof fun.map);\n  }\n}\n\nvar localDocName = 'mrviews';\nvar abstract = createAbstractMapReduce(localDocName, mapper, reducer, ddocValidator);\n\nfunction query(fun, opts, callback) {\n  return abstract.query.call(this, fun, opts, callback);\n}\n\nfunction viewCleanup(callback) {\n  return abstract.viewCleanup.call(this, callback);\n}\n\nvar mapreduce = {\n  query: query,\n  viewCleanup: viewCleanup\n};\n\nfunction isGenOne$1(rev$$1) {\n  return /^1-/.test(rev$$1);\n}\n\nfunction fileHasChanged(localDoc, remoteDoc, filename) {\n  return !localDoc._attachments ||\n         !localDoc._attachments[filename] ||\n         localDoc._attachments[filename].digest !== remoteDoc._attachments[filename].digest;\n}\n\nfunction getDocAttachments(db, doc) {\n  var filenames = Object.keys(doc._attachments);\n  return Promise.all(filenames.map(function (filename) {\n    return db.getAttachment(doc._id, filename, {rev: doc._rev});\n  }));\n}\n\nfunction getDocAttachmentsFromTargetOrSource(target, src, doc) {\n  var doCheckForLocalAttachments = isRemote(src) && !isRemote(target);\n  var filenames = Object.keys(doc._attachments);\n\n  if (!doCheckForLocalAttachments) {\n    return getDocAttachments(src, doc);\n  }\n\n  return target.get(doc._id).then(function (localDoc) {\n    return Promise.all(filenames.map(function (filename) {\n      if (fileHasChanged(localDoc, doc, filename)) {\n        return src.getAttachment(doc._id, filename);\n      }\n\n      return target.getAttachment(localDoc._id, filename);\n    }));\n  }).catch(function (error) {\n    /* istanbul ignore if */\n    if (error.status !== 404) {\n      throw error;\n    }\n\n    return getDocAttachments(src, doc);\n  });\n}\n\nfunction createBulkGetOpts(diffs) {\n  var requests = [];\n  Object.keys(diffs).forEach(function (id) {\n    var missingRevs = diffs[id].missing;\n    missingRevs.forEach(function (missingRev) {\n      requests.push({\n        id: id,\n        rev: missingRev\n      });\n    });\n  });\n\n  return {\n    docs: requests,\n    revs: true,\n    latest: true\n  };\n}\n\n//\n// Fetch all the documents from the src as described in the \"diffs\",\n// which is a mapping of docs IDs to revisions. If the state ever\n// changes to \"cancelled\", then the returned promise will be rejected.\n// Else it will be resolved with a list of fetched documents.\n//\nfunction getDocs(src, target, diffs, state) {\n  diffs = clone(diffs); // we do not need to modify this\n\n  var resultDocs = [],\n      ok = true;\n\n  function getAllDocs() {\n\n    var bulkGetOpts = createBulkGetOpts(diffs);\n\n    if (!bulkGetOpts.docs.length) { // optimization: skip empty requests\n      return;\n    }\n\n    return src.bulkGet(bulkGetOpts).then(function (bulkGetResponse) {\n      /* istanbul ignore if */\n      if (state.cancelled) {\n        throw new Error('cancelled');\n      }\n      return Promise.all(bulkGetResponse.results.map(function (bulkGetInfo) {\n        return Promise.all(bulkGetInfo.docs.map(function (doc) {\n          var remoteDoc = doc.ok;\n\n          if (doc.error) {\n            // when AUTO_COMPACTION is set, docs can be returned which look\n            // like this: {\"missing\":\"1-7c3ac256b693c462af8442f992b83696\"}\n            ok = false;\n          }\n\n          if (!remoteDoc || !remoteDoc._attachments) {\n            return remoteDoc;\n          }\n\n          return getDocAttachmentsFromTargetOrSource(target, src, remoteDoc)\n                   .then(function (attachments) {\n                           var filenames = Object.keys(remoteDoc._attachments);\n                           attachments\n                             .forEach(function (attachment, i) {\n                                        var att = remoteDoc._attachments[filenames[i]];\n                                        delete att.stub;\n                                        delete att.length;\n                                        att.data = attachment;\n                                      });\n\n                                      return remoteDoc;\n                                    });\n        }));\n      }))\n\n      .then(function (results) {\n        resultDocs = resultDocs.concat(flatten(results).filter(Boolean));\n      });\n    });\n  }\n\n  function hasAttachments(doc) {\n    return doc._attachments && Object.keys(doc._attachments).length > 0;\n  }\n\n  function hasConflicts(doc) {\n    return doc._conflicts && doc._conflicts.length > 0;\n  }\n\n  function fetchRevisionOneDocs(ids) {\n    // Optimization: fetch gen-1 docs and attachments in\n    // a single request using _all_docs\n    return src.allDocs({\n      keys: ids,\n      include_docs: true,\n      conflicts: true\n    }).then(function (res) {\n      if (state.cancelled) {\n        throw new Error('cancelled');\n      }\n      res.rows.forEach(function (row) {\n        if (row.deleted || !row.doc || !isGenOne$1(row.value.rev) ||\n            hasAttachments(row.doc) || hasConflicts(row.doc)) {\n          // if any of these conditions apply, we need to fetch using get()\n          return;\n        }\n\n        // strip _conflicts array to appease CSG (#5793)\n        /* istanbul ignore if */\n        if (row.doc._conflicts) {\n          delete row.doc._conflicts;\n        }\n\n        // the doc we got back from allDocs() is sufficient\n        resultDocs.push(row.doc);\n        delete diffs[row.id];\n      });\n    });\n  }\n\n  function getRevisionOneDocs() {\n    // filter out the generation 1 docs and get them\n    // leaving the non-generation one docs to be got otherwise\n    var ids = Object.keys(diffs).filter(function (id) {\n      var missing = diffs[id].missing;\n      return missing.length === 1 && isGenOne$1(missing[0]);\n    });\n    if (ids.length > 0) {\n      return fetchRevisionOneDocs(ids);\n    }\n  }\n\n  function returnResult() {\n    return { ok:ok, docs:resultDocs };\n  }\n\n  return Promise.resolve()\n    .then(getRevisionOneDocs)\n    .then(getAllDocs)\n    .then(returnResult);\n}\n\nvar CHECKPOINT_VERSION = 1;\nvar REPLICATOR = \"pouchdb\";\n// This is an arbitrary number to limit the\n// amount of replication history we save in the checkpoint.\n// If we save too much, the checkpoing docs will become very big,\n// if we save fewer, we'll run a greater risk of having to\n// read all the changes from 0 when checkpoint PUTs fail\n// CouchDB 2.0 has a more involved history pruning,\n// but let's go for the simple version for now.\nvar CHECKPOINT_HISTORY_SIZE = 5;\nvar LOWEST_SEQ = 0;\n\nfunction updateCheckpoint(db, id, checkpoint, session, returnValue) {\n  return db.get(id).catch(function (err) {\n    if (err.status === 404) {\n      if (db.adapter === 'http' || db.adapter === 'https') {\n        explainError(\n          404, 'PouchDB is just checking if a remote checkpoint exists.'\n        );\n      }\n      return {\n        session_id: session,\n        _id: id,\n        history: [],\n        replicator: REPLICATOR,\n        version: CHECKPOINT_VERSION\n      };\n    }\n    throw err;\n  }).then(function (doc) {\n    if (returnValue.cancelled) {\n      return;\n    }\n\n    // if the checkpoint has not changed, do not update\n    if (doc.last_seq === checkpoint) {\n      return;\n    }\n\n    // Filter out current entry for this replication\n    doc.history = (doc.history || []).filter(function (item) {\n      return item.session_id !== session;\n    });\n\n    // Add the latest checkpoint to history\n    doc.history.unshift({\n      last_seq: checkpoint,\n      session_id: session\n    });\n\n    // Just take the last pieces in history, to\n    // avoid really big checkpoint docs.\n    // see comment on history size above\n    doc.history = doc.history.slice(0, CHECKPOINT_HISTORY_SIZE);\n\n    doc.version = CHECKPOINT_VERSION;\n    doc.replicator = REPLICATOR;\n\n    doc.session_id = session;\n    doc.last_seq = checkpoint;\n\n    return db.put(doc).catch(function (err) {\n      if (err.status === 409) {\n        // retry; someone is trying to write a checkpoint simultaneously\n        return updateCheckpoint(db, id, checkpoint, session, returnValue);\n      }\n      throw err;\n    });\n  });\n}\n\nfunction Checkpointer(src, target, id, returnValue, opts) {\n  this.src = src;\n  this.target = target;\n  this.id = id;\n  this.returnValue = returnValue;\n  this.opts = opts || {};\n}\n\nCheckpointer.prototype.writeCheckpoint = function (checkpoint, session) {\n  var self = this;\n  return this.updateTarget(checkpoint, session).then(function () {\n    return self.updateSource(checkpoint, session);\n  });\n};\n\nCheckpointer.prototype.updateTarget = function (checkpoint, session) {\n  if (this.opts.writeTargetCheckpoint) {\n    return updateCheckpoint(this.target, this.id, checkpoint,\n      session, this.returnValue);\n  } else {\n    return Promise.resolve(true);\n  }\n};\n\nCheckpointer.prototype.updateSource = function (checkpoint, session) {\n  if (this.opts.writeSourceCheckpoint) {\n    var self = this;\n    return updateCheckpoint(this.src, this.id, checkpoint,\n      session, this.returnValue)\n      .catch(function (err) {\n        if (isForbiddenError(err)) {\n          self.opts.writeSourceCheckpoint = false;\n          return true;\n        }\n        throw err;\n      });\n  } else {\n    return Promise.resolve(true);\n  }\n};\n\nvar comparisons = {\n  \"undefined\": function (targetDoc, sourceDoc) {\n    // This is the previous comparison function\n    if (collate(targetDoc.last_seq, sourceDoc.last_seq) === 0) {\n      return sourceDoc.last_seq;\n    }\n    /* istanbul ignore next */\n    return 0;\n  },\n  \"1\": function (targetDoc, sourceDoc) {\n    // This is the comparison function ported from CouchDB\n    return compareReplicationLogs(sourceDoc, targetDoc).last_seq;\n  }\n};\n\nCheckpointer.prototype.getCheckpoint = function () {\n  var self = this;\n\n  if (self.opts && self.opts.writeSourceCheckpoint && !self.opts.writeTargetCheckpoint) {\n    return self.src.get(self.id).then(function (sourceDoc) {\n      return sourceDoc.last_seq || LOWEST_SEQ;\n    }).catch(function (err) {\n      /* istanbul ignore if */\n      if (err.status !== 404) {\n        throw err;\n      }\n      return LOWEST_SEQ;\n    });\n  }\n\n  return self.target.get(self.id).then(function (targetDoc) {\n    if (self.opts && self.opts.writeTargetCheckpoint && !self.opts.writeSourceCheckpoint) {\n      return targetDoc.last_seq || LOWEST_SEQ;\n    }\n\n    return self.src.get(self.id).then(function (sourceDoc) {\n      // Since we can't migrate an old version doc to a new one\n      // (no session id), we just go with the lowest seq in this case\n      /* istanbul ignore if */\n      if (targetDoc.version !== sourceDoc.version) {\n        return LOWEST_SEQ;\n      }\n\n      var version;\n      if (targetDoc.version) {\n        version = targetDoc.version.toString();\n      } else {\n        version = \"undefined\";\n      }\n\n      if (version in comparisons) {\n        return comparisons[version](targetDoc, sourceDoc);\n      }\n      /* istanbul ignore next */\n      return LOWEST_SEQ;\n    }, function (err) {\n      if (err.status === 404 && targetDoc.last_seq) {\n        return self.src.put({\n          _id: self.id,\n          last_seq: LOWEST_SEQ\n        }).then(function () {\n          return LOWEST_SEQ;\n        }, function (err) {\n          if (isForbiddenError(err)) {\n            self.opts.writeSourceCheckpoint = false;\n            return targetDoc.last_seq;\n          }\n          /* istanbul ignore next */\n          return LOWEST_SEQ;\n        });\n      }\n      throw err;\n    });\n  }).catch(function (err) {\n    if (err.status !== 404) {\n      throw err;\n    }\n    return LOWEST_SEQ;\n  });\n};\n// This checkpoint comparison is ported from CouchDBs source\n// they come from here:\n// https://github.com/apache/couchdb-couch-replicator/blob/master/src/couch_replicator.erl#L863-L906\n\nfunction compareReplicationLogs(srcDoc, tgtDoc) {\n  if (srcDoc.session_id === tgtDoc.session_id) {\n    return {\n      last_seq: srcDoc.last_seq,\n      history: srcDoc.history\n    };\n  }\n\n  return compareReplicationHistory(srcDoc.history, tgtDoc.history);\n}\n\nfunction compareReplicationHistory(sourceHistory, targetHistory) {\n  // the erlang loop via function arguments is not so easy to repeat in JS\n  // therefore, doing this as recursion\n  var S = sourceHistory[0];\n  var sourceRest = sourceHistory.slice(1);\n  var T = targetHistory[0];\n  var targetRest = targetHistory.slice(1);\n\n  if (!S || targetHistory.length === 0) {\n    return {\n      last_seq: LOWEST_SEQ,\n      history: []\n    };\n  }\n\n  var sourceId = S.session_id;\n  /* istanbul ignore if */\n  if (hasSessionId(sourceId, targetHistory)) {\n    return {\n      last_seq: S.last_seq,\n      history: sourceHistory\n    };\n  }\n\n  var targetId = T.session_id;\n  if (hasSessionId(targetId, sourceRest)) {\n    return {\n      last_seq: T.last_seq,\n      history: targetRest\n    };\n  }\n\n  return compareReplicationHistory(sourceRest, targetRest);\n}\n\nfunction hasSessionId(sessionId, history) {\n  var props = history[0];\n  var rest = history.slice(1);\n\n  if (!sessionId || history.length === 0) {\n    return false;\n  }\n\n  if (sessionId === props.session_id) {\n    return true;\n  }\n\n  return hasSessionId(sessionId, rest);\n}\n\nfunction isForbiddenError(err) {\n  return typeof err.status === 'number' && Math.floor(err.status / 100) === 4;\n}\n\nvar STARTING_BACK_OFF = 0;\n\nfunction backOff(opts, returnValue, error, callback) {\n  if (opts.retry === false) {\n    returnValue.emit('error', error);\n    returnValue.removeAllListeners();\n    return;\n  }\n  /* istanbul ignore if */\n  if (typeof opts.back_off_function !== 'function') {\n    opts.back_off_function = defaultBackOff;\n  }\n  returnValue.emit('requestError', error);\n  if (returnValue.state === 'active' || returnValue.state === 'pending') {\n    returnValue.emit('paused', error);\n    returnValue.state = 'stopped';\n    var backOffSet = function backoffTimeSet() {\n      opts.current_back_off = STARTING_BACK_OFF;\n    };\n    var removeBackOffSetter = function removeBackOffTimeSet() {\n      returnValue.removeListener('active', backOffSet);\n    };\n    returnValue.once('paused', removeBackOffSetter);\n    returnValue.once('active', backOffSet);\n  }\n\n  opts.current_back_off = opts.current_back_off || STARTING_BACK_OFF;\n  opts.current_back_off = opts.back_off_function(opts.current_back_off);\n  setTimeout(callback, opts.current_back_off);\n}\n\nfunction sortObjectPropertiesByKey(queryParams) {\n  return Object.keys(queryParams).sort(collate).reduce(function (result, key) {\n    result[key] = queryParams[key];\n    return result;\n  }, {});\n}\n\n// Generate a unique id particular to this replication.\n// Not guaranteed to align perfectly with CouchDB's rep ids.\nfunction generateReplicationId(src, target, opts) {\n  var docIds = opts.doc_ids ? opts.doc_ids.sort(collate) : '';\n  var filterFun = opts.filter ? opts.filter.toString() : '';\n  var queryParams = '';\n  var filterViewName =  '';\n  var selector = '';\n\n  // possibility for checkpoints to be lost here as behaviour of\n  // JSON.stringify is not stable (see #6226)\n  /* istanbul ignore if */\n  if (opts.selector) {\n    selector = JSON.stringify(opts.selector);\n  }\n\n  if (opts.filter && opts.query_params) {\n    queryParams = JSON.stringify(sortObjectPropertiesByKey(opts.query_params));\n  }\n\n  if (opts.filter && opts.filter === '_view') {\n    filterViewName = opts.view.toString();\n  }\n\n  return Promise.all([src.id(), target.id()]).then(function (res) {\n    var queryData = res[0] + res[1] + filterFun + filterViewName +\n      queryParams + docIds + selector;\n    return new Promise(function (resolve) {\n      binaryMd5(queryData, resolve);\n    });\n  }).then(function (md5sum) {\n    // can't use straight-up md5 alphabet, because\n    // the char '/' is interpreted as being for attachments,\n    // and + is also not url-safe\n    md5sum = md5sum.replace(/\\//g, '.').replace(/\\+/g, '_');\n    return '_local/' + md5sum;\n  });\n}\n\nfunction replicate(src, target, opts, returnValue, result) {\n  var batches = [];               // list of batches to be processed\n  var currentBatch;               // the batch currently being processed\n  var pendingBatch = {\n    seq: 0,\n    changes: [],\n    docs: []\n  }; // next batch, not yet ready to be processed\n  var writingCheckpoint = false;  // true while checkpoint is being written\n  var changesCompleted = false;   // true when all changes received\n  var replicationCompleted = false; // true when replication has completed\n  var last_seq = 0;\n  var continuous = opts.continuous || opts.live || false;\n  var batch_size = opts.batch_size || 100;\n  var batches_limit = opts.batches_limit || 10;\n  var changesPending = false;     // true while src.changes is running\n  var doc_ids = opts.doc_ids;\n  var selector = opts.selector;\n  var repId;\n  var checkpointer;\n  var changedDocs = [];\n  // Like couchdb, every replication gets a unique session id\n  var session = uuid();\n\n  result = result || {\n    ok: true,\n    start_time: new Date().toISOString(),\n    docs_read: 0,\n    docs_written: 0,\n    doc_write_failures: 0,\n    errors: []\n  };\n\n  var changesOpts = {};\n  returnValue.ready(src, target);\n\n  function initCheckpointer() {\n    if (checkpointer) {\n      return Promise.resolve();\n    }\n    return generateReplicationId(src, target, opts).then(function (res) {\n      repId = res;\n\n      var checkpointOpts = {};\n      if (opts.checkpoint === false) {\n        checkpointOpts = { writeSourceCheckpoint: false, writeTargetCheckpoint: false };\n      } else if (opts.checkpoint === 'source') {\n        checkpointOpts = { writeSourceCheckpoint: true, writeTargetCheckpoint: false };\n      } else if (opts.checkpoint === 'target') {\n        checkpointOpts = { writeSourceCheckpoint: false, writeTargetCheckpoint: true };\n      } else {\n        checkpointOpts = { writeSourceCheckpoint: true, writeTargetCheckpoint: true };\n      }\n\n      checkpointer = new Checkpointer(src, target, repId, returnValue, checkpointOpts);\n    });\n  }\n\n  function writeDocs() {\n    changedDocs = [];\n\n    if (currentBatch.docs.length === 0) {\n      return;\n    }\n    var docs = currentBatch.docs;\n    var bulkOpts = {timeout: opts.timeout};\n    return target.bulkDocs({docs: docs, new_edits: false}, bulkOpts).then(function (res) {\n      /* istanbul ignore if */\n      if (returnValue.cancelled) {\n        completeReplication();\n        throw new Error('cancelled');\n      }\n\n      // `res` doesn't include full documents (which live in `docs`), so we create a map of \n      // (id -> error), and check for errors while iterating over `docs`\n      var errorsById = Object.create(null);\n      res.forEach(function (res) {\n        if (res.error) {\n          errorsById[res.id] = res;\n        }\n      });\n\n      var errorsNo = Object.keys(errorsById).length;\n      result.doc_write_failures += errorsNo;\n      result.docs_written += docs.length - errorsNo;\n\n      docs.forEach(function (doc) {\n        var error = errorsById[doc._id];\n        if (error) {\n          result.errors.push(error);\n          // Normalize error name. i.e. 'Unauthorized' -> 'unauthorized' (eg Sync Gateway)\n          var errorName = (error.name || '').toLowerCase();\n          if (errorName === 'unauthorized' || errorName === 'forbidden') {\n            returnValue.emit('denied', clone(error));\n          } else {\n            throw error;\n          }\n        } else {\n          changedDocs.push(doc);\n        }\n      });\n\n    }, function (err) {\n      result.doc_write_failures += docs.length;\n      throw err;\n    });\n  }\n\n  function finishBatch() {\n    if (currentBatch.error) {\n      throw new Error('There was a problem getting docs.');\n    }\n    result.last_seq = last_seq = currentBatch.seq;\n    var outResult = clone(result);\n    if (changedDocs.length) {\n      outResult.docs = changedDocs;\n      // Attach 'pending' property if server supports it (CouchDB 2.0+)\n      /* istanbul ignore if */\n      if (typeof currentBatch.pending === 'number') {\n        outResult.pending = currentBatch.pending;\n        delete currentBatch.pending;\n      }\n      returnValue.emit('change', outResult);\n    }\n    writingCheckpoint = true;\n    return checkpointer.writeCheckpoint(currentBatch.seq,\n        session).then(function () {\n      writingCheckpoint = false;\n      /* istanbul ignore if */\n      if (returnValue.cancelled) {\n        completeReplication();\n        throw new Error('cancelled');\n      }\n      currentBatch = undefined;\n      getChanges();\n    }).catch(function (err) {\n      onCheckpointError(err);\n      throw err;\n    });\n  }\n\n  function getDiffs() {\n    var diff = {};\n    currentBatch.changes.forEach(function (change) {\n      // Couchbase Sync Gateway emits these, but we can ignore them\n      /* istanbul ignore if */\n      if (change.id === \"_user/\") {\n        return;\n      }\n      diff[change.id] = change.changes.map(function (x) {\n        return x.rev;\n      });\n    });\n    return target.revsDiff(diff).then(function (diffs) {\n      /* istanbul ignore if */\n      if (returnValue.cancelled) {\n        completeReplication();\n        throw new Error('cancelled');\n      }\n      // currentBatch.diffs elements are deleted as the documents are written\n      currentBatch.diffs = diffs;\n    });\n  }\n\n  function getBatchDocs() {\n    return getDocs(src, target, currentBatch.diffs, returnValue).then(function (got) {\n      currentBatch.error = !got.ok;\n      got.docs.forEach(function (doc) {\n        delete currentBatch.diffs[doc._id];\n        result.docs_read++;\n        currentBatch.docs.push(doc);\n      });\n    });\n  }\n\n  function startNextBatch() {\n    if (returnValue.cancelled || currentBatch) {\n      return;\n    }\n    if (batches.length === 0) {\n      processPendingBatch(true);\n      return;\n    }\n    currentBatch = batches.shift();\n    getDiffs()\n      .then(getBatchDocs)\n      .then(writeDocs)\n      .then(finishBatch)\n      .then(startNextBatch)\n      .catch(function (err) {\n        abortReplication('batch processing terminated with error', err);\n      });\n  }\n\n\n  function processPendingBatch(immediate$$1) {\n    if (pendingBatch.changes.length === 0) {\n      if (batches.length === 0 && !currentBatch) {\n        if ((continuous && changesOpts.live) || changesCompleted) {\n          returnValue.state = 'pending';\n          returnValue.emit('paused');\n        }\n        if (changesCompleted) {\n          completeReplication();\n        }\n      }\n      return;\n    }\n    if (\n      immediate$$1 ||\n      changesCompleted ||\n      pendingBatch.changes.length >= batch_size\n    ) {\n      batches.push(pendingBatch);\n      pendingBatch = {\n        seq: 0,\n        changes: [],\n        docs: []\n      };\n      if (returnValue.state === 'pending' || returnValue.state === 'stopped') {\n        returnValue.state = 'active';\n        returnValue.emit('active');\n      }\n      startNextBatch();\n    }\n  }\n\n\n  function abortReplication(reason, err) {\n    if (replicationCompleted) {\n      return;\n    }\n    if (!err.message) {\n      err.message = reason;\n    }\n    result.ok = false;\n    result.status = 'aborting';\n    batches = [];\n    pendingBatch = {\n      seq: 0,\n      changes: [],\n      docs: []\n    };\n    completeReplication(err);\n  }\n\n\n  function completeReplication(fatalError) {\n    if (replicationCompleted) {\n      return;\n    }\n    /* istanbul ignore if */\n    if (returnValue.cancelled) {\n      result.status = 'cancelled';\n      if (writingCheckpoint) {\n        return;\n      }\n    }\n    result.status = result.status || 'complete';\n    result.end_time = new Date().toISOString();\n    result.last_seq = last_seq;\n    replicationCompleted = true;\n\n    if (fatalError) {\n      // need to extend the error because Firefox considers \".result\" read-only\n      fatalError = createError(fatalError);\n      fatalError.result = result;\n\n      // Normalize error name. i.e. 'Unauthorized' -> 'unauthorized' (eg Sync Gateway)\n      var errorName = (fatalError.name || '').toLowerCase();\n      if (errorName === 'unauthorized' || errorName === 'forbidden') {\n        returnValue.emit('error', fatalError);\n        returnValue.removeAllListeners();\n      } else {\n        backOff(opts, returnValue, fatalError, function () {\n          replicate(src, target, opts, returnValue);\n        });\n      }\n    } else {\n      returnValue.emit('complete', result);\n      returnValue.removeAllListeners();\n    }\n  }\n\n\n  function onChange(change, pending, lastSeq) {\n    /* istanbul ignore if */\n    if (returnValue.cancelled) {\n      return completeReplication();\n    }\n    // Attach 'pending' property if server supports it (CouchDB 2.0+)\n    /* istanbul ignore if */\n    if (typeof pending === 'number') {\n      pendingBatch.pending = pending;\n    }\n\n    var filter = filterChange(opts)(change);\n    if (!filter) {\n      return;\n    }\n    pendingBatch.seq = change.seq || lastSeq;\n    pendingBatch.changes.push(change);\n    immediate(function () {\n      processPendingBatch(batches.length === 0 && changesOpts.live);\n    });\n  }\n\n\n  function onChangesComplete(changes) {\n    changesPending = false;\n    /* istanbul ignore if */\n    if (returnValue.cancelled) {\n      return completeReplication();\n    }\n\n    // if no results were returned then we're done,\n    // else fetch more\n    if (changes.results.length > 0) {\n      changesOpts.since = changes.results[changes.results.length - 1].seq;\n      getChanges();\n      processPendingBatch(true);\n    } else {\n\n      var complete = function () {\n        if (continuous) {\n          changesOpts.live = true;\n          getChanges();\n        } else {\n          changesCompleted = true;\n        }\n        processPendingBatch(true);\n      };\n\n      // update the checkpoint so we start from the right seq next time\n      if (!currentBatch && changes.results.length === 0) {\n        writingCheckpoint = true;\n        checkpointer.writeCheckpoint(changes.last_seq,\n            session).then(function () {\n          writingCheckpoint = false;\n          result.last_seq = last_seq = changes.last_seq;\n          complete();\n        })\n        .catch(onCheckpointError);\n      } else {\n        complete();\n      }\n    }\n  }\n\n\n  function onChangesError(err) {\n    changesPending = false;\n    /* istanbul ignore if */\n    if (returnValue.cancelled) {\n      return completeReplication();\n    }\n    abortReplication('changes rejected', err);\n  }\n\n\n  function getChanges() {\n    if (!(\n      !changesPending &&\n      !changesCompleted &&\n      batches.length < batches_limit\n      )) {\n      return;\n    }\n    changesPending = true;\n    function abortChanges() {\n      changes.cancel();\n    }\n    function removeListener() {\n      returnValue.removeListener('cancel', abortChanges);\n    }\n\n    if (returnValue._changes) { // remove old changes() and listeners\n      returnValue.removeListener('cancel', returnValue._abortChanges);\n      returnValue._changes.cancel();\n    }\n    returnValue.once('cancel', abortChanges);\n\n    var changes = src.changes(changesOpts)\n      .on('change', onChange);\n    changes.then(removeListener, removeListener);\n    changes.then(onChangesComplete)\n      .catch(onChangesError);\n\n    if (opts.retry) {\n      // save for later so we can cancel if necessary\n      returnValue._changes = changes;\n      returnValue._abortChanges = abortChanges;\n    }\n  }\n\n\n  function startChanges() {\n    initCheckpointer().then(function () {\n      /* istanbul ignore if */\n      if (returnValue.cancelled) {\n        completeReplication();\n        return;\n      }\n      return checkpointer.getCheckpoint().then(function (checkpoint) {\n        last_seq = checkpoint;\n        changesOpts = {\n          since: last_seq,\n          limit: batch_size,\n          batch_size: batch_size,\n          style: 'all_docs',\n          doc_ids: doc_ids,\n          selector: selector,\n          return_docs: true // required so we know when we're done\n        };\n        if (opts.filter) {\n          if (typeof opts.filter !== 'string') {\n            // required for the client-side filter in onChange\n            changesOpts.include_docs = true;\n          } else { // ddoc filter\n            changesOpts.filter = opts.filter;\n          }\n        }\n        if ('heartbeat' in opts) {\n          changesOpts.heartbeat = opts.heartbeat;\n        }\n        if ('timeout' in opts) {\n          changesOpts.timeout = opts.timeout;\n        }\n        if (opts.query_params) {\n          changesOpts.query_params = opts.query_params;\n        }\n        if (opts.view) {\n          changesOpts.view = opts.view;\n        }\n        getChanges();\n      });\n    }).catch(function (err) {\n      abortReplication('getCheckpoint rejected with ', err);\n    });\n  }\n\n  /* istanbul ignore next */\n  function onCheckpointError(err) {\n    writingCheckpoint = false;\n    abortReplication('writeCheckpoint completed with error', err);\n  }\n\n  /* istanbul ignore if */\n  if (returnValue.cancelled) { // cancelled immediately\n    completeReplication();\n    return;\n  }\n\n  if (!returnValue._addedListeners) {\n    returnValue.once('cancel', completeReplication);\n\n    if (typeof opts.complete === 'function') {\n      returnValue.once('error', opts.complete);\n      returnValue.once('complete', function (result) {\n        opts.complete(null, result);\n      });\n    }\n    returnValue._addedListeners = true;\n  }\n\n  if (typeof opts.since === 'undefined') {\n    startChanges();\n  } else {\n    initCheckpointer().then(function () {\n      writingCheckpoint = true;\n      return checkpointer.writeCheckpoint(opts.since, session);\n    }).then(function () {\n      writingCheckpoint = false;\n      /* istanbul ignore if */\n      if (returnValue.cancelled) {\n        completeReplication();\n        return;\n      }\n      last_seq = opts.since;\n      startChanges();\n    }).catch(onCheckpointError);\n  }\n}\n\n// We create a basic promise so the caller can cancel the replication possibly\n// before we have actually started listening to changes etc\ninherits(Replication, EventEmitter);\nfunction Replication() {\n  EventEmitter.call(this);\n  this.cancelled = false;\n  this.state = 'pending';\n  var self = this;\n  var promise = new Promise(function (fulfill, reject) {\n    self.once('complete', fulfill);\n    self.once('error', reject);\n  });\n  self.then = function (resolve, reject) {\n    return promise.then(resolve, reject);\n  };\n  self.catch = function (reject) {\n    return promise.catch(reject);\n  };\n  // As we allow error handling via \"error\" event as well,\n  // put a stub in here so that rejecting never throws UnhandledError.\n  self.catch(function () {});\n}\n\nReplication.prototype.cancel = function () {\n  this.cancelled = true;\n  this.state = 'cancelled';\n  this.emit('cancel');\n};\n\nReplication.prototype.ready = function (src, target) {\n  var self = this;\n  if (self._readyCalled) {\n    return;\n  }\n  self._readyCalled = true;\n\n  function onDestroy() {\n    self.cancel();\n  }\n  src.once('destroyed', onDestroy);\n  target.once('destroyed', onDestroy);\n  function cleanup() {\n    src.removeListener('destroyed', onDestroy);\n    target.removeListener('destroyed', onDestroy);\n  }\n  self.once('complete', cleanup);\n};\n\nfunction toPouch(db, opts) {\n  var PouchConstructor = opts.PouchConstructor;\n  if (typeof db === 'string') {\n    return new PouchConstructor(db, opts);\n  } else {\n    return db;\n  }\n}\n\nfunction replicateWrapper(src, target, opts, callback) {\n\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n  if (typeof opts === 'undefined') {\n    opts = {};\n  }\n\n  if (opts.doc_ids && !Array.isArray(opts.doc_ids)) {\n    throw createError(BAD_REQUEST,\n                       \"`doc_ids` filter parameter is not a list.\");\n  }\n\n  opts.complete = callback;\n  opts = clone(opts);\n  opts.continuous = opts.continuous || opts.live;\n  opts.retry = ('retry' in opts) ? opts.retry : false;\n  /*jshint validthis:true */\n  opts.PouchConstructor = opts.PouchConstructor || this;\n  var replicateRet = new Replication(opts);\n  var srcPouch = toPouch(src, opts);\n  var targetPouch = toPouch(target, opts);\n  replicate(srcPouch, targetPouch, opts, replicateRet);\n  return replicateRet;\n}\n\ninherits(Sync, EventEmitter);\nfunction sync(src, target, opts, callback) {\n  if (typeof opts === 'function') {\n    callback = opts;\n    opts = {};\n  }\n  if (typeof opts === 'undefined') {\n    opts = {};\n  }\n  opts = clone(opts);\n  /*jshint validthis:true */\n  opts.PouchConstructor = opts.PouchConstructor || this;\n  src = toPouch(src, opts);\n  target = toPouch(target, opts);\n  return new Sync(src, target, opts, callback);\n}\n\nfunction Sync(src, target, opts, callback) {\n  var self = this;\n  this.canceled = false;\n\n  var optsPush = opts.push ? $inject_Object_assign({}, opts, opts.push) : opts;\n  var optsPull = opts.pull ? $inject_Object_assign({}, opts, opts.pull) : opts;\n\n  this.push = replicateWrapper(src, target, optsPush);\n  this.pull = replicateWrapper(target, src, optsPull);\n\n  this.pushPaused = true;\n  this.pullPaused = true;\n\n  function pullChange(change) {\n    self.emit('change', {\n      direction: 'pull',\n      change: change\n    });\n  }\n  function pushChange(change) {\n    self.emit('change', {\n      direction: 'push',\n      change: change\n    });\n  }\n  function pushDenied(doc) {\n    self.emit('denied', {\n      direction: 'push',\n      doc: doc\n    });\n  }\n  function pullDenied(doc) {\n    self.emit('denied', {\n      direction: 'pull',\n      doc: doc\n    });\n  }\n  function pushPaused() {\n    self.pushPaused = true;\n    /* istanbul ignore if */\n    if (self.pullPaused) {\n      self.emit('paused');\n    }\n  }\n  function pullPaused() {\n    self.pullPaused = true;\n    /* istanbul ignore if */\n    if (self.pushPaused) {\n      self.emit('paused');\n    }\n  }\n  function pushActive() {\n    self.pushPaused = false;\n    /* istanbul ignore if */\n    if (self.pullPaused) {\n      self.emit('active', {\n        direction: 'push'\n      });\n    }\n  }\n  function pullActive() {\n    self.pullPaused = false;\n    /* istanbul ignore if */\n    if (self.pushPaused) {\n      self.emit('active', {\n        direction: 'pull'\n      });\n    }\n  }\n\n  var removed = {};\n\n  function removeAll(type) { // type is 'push' or 'pull'\n    return function (event, func) {\n      var isChange = event === 'change' &&\n        (func === pullChange || func === pushChange);\n      var isDenied = event === 'denied' &&\n        (func === pullDenied || func === pushDenied);\n      var isPaused = event === 'paused' &&\n        (func === pullPaused || func === pushPaused);\n      var isActive = event === 'active' &&\n        (func === pullActive || func === pushActive);\n\n      if (isChange || isDenied || isPaused || isActive) {\n        if (!(event in removed)) {\n          removed[event] = {};\n        }\n        removed[event][type] = true;\n        if (Object.keys(removed[event]).length === 2) {\n          // both push and pull have asked to be removed\n          self.removeAllListeners(event);\n        }\n      }\n    };\n  }\n\n  if (opts.live) {\n    this.push.on('complete', self.pull.cancel.bind(self.pull));\n    this.pull.on('complete', self.push.cancel.bind(self.push));\n  }\n\n  function addOneListener(ee, event, listener) {\n    if (ee.listeners(event).indexOf(listener) == -1) {\n      ee.on(event, listener);\n    }\n  }\n\n  this.on('newListener', function (event) {\n    if (event === 'change') {\n      addOneListener(self.pull, 'change', pullChange);\n      addOneListener(self.push, 'change', pushChange);\n    } else if (event === 'denied') {\n      addOneListener(self.pull, 'denied', pullDenied);\n      addOneListener(self.push, 'denied', pushDenied);\n    } else if (event === 'active') {\n      addOneListener(self.pull, 'active', pullActive);\n      addOneListener(self.push, 'active', pushActive);\n    } else if (event === 'paused') {\n      addOneListener(self.pull, 'paused', pullPaused);\n      addOneListener(self.push, 'paused', pushPaused);\n    }\n  });\n\n  this.on('removeListener', function (event) {\n    if (event === 'change') {\n      self.pull.removeListener('change', pullChange);\n      self.push.removeListener('change', pushChange);\n    } else if (event === 'denied') {\n      self.pull.removeListener('denied', pullDenied);\n      self.push.removeListener('denied', pushDenied);\n    } else if (event === 'active') {\n      self.pull.removeListener('active', pullActive);\n      self.push.removeListener('active', pushActive);\n    } else if (event === 'paused') {\n      self.pull.removeListener('paused', pullPaused);\n      self.push.removeListener('paused', pushPaused);\n    }\n  });\n\n  this.pull.on('removeListener', removeAll('pull'));\n  this.push.on('removeListener', removeAll('push'));\n\n  var promise = Promise.all([\n    this.push,\n    this.pull\n  ]).then(function (resp) {\n    var out = {\n      push: resp[0],\n      pull: resp[1]\n    };\n    self.emit('complete', out);\n    if (callback) {\n      callback(null, out);\n    }\n    self.removeAllListeners();\n    return out;\n  }, function (err) {\n    self.cancel();\n    if (callback) {\n      // if there's a callback, then the callback can receive\n      // the error event\n      callback(err);\n    } else {\n      // if there's no callback, then we're safe to emit an error\n      // event, which would otherwise throw an unhandled error\n      // due to 'error' being a special event in EventEmitters\n      self.emit('error', err);\n    }\n    self.removeAllListeners();\n    if (callback) {\n      // no sense throwing if we're already emitting an 'error' event\n      throw err;\n    }\n  });\n\n  this.then = function (success, err) {\n    return promise.then(success, err);\n  };\n\n  this.catch = function (err) {\n    return promise.catch(err);\n  };\n}\n\nSync.prototype.cancel = function () {\n  if (!this.canceled) {\n    this.canceled = true;\n    this.push.cancel();\n    this.pull.cancel();\n  }\n};\n\nfunction replication(PouchDB) {\n  PouchDB.replicate = replicateWrapper;\n  PouchDB.sync = sync;\n\n  Object.defineProperty(PouchDB.prototype, 'replicate', {\n    get: function () {\n      var self = this;\n      if (typeof this.replicateMethods === 'undefined') {\n        this.replicateMethods = {\n          from: function (other, opts, callback) {\n            return self.constructor.replicate(other, self, opts, callback);\n          },\n          to: function (other, opts, callback) {\n            return self.constructor.replicate(self, other, opts, callback);\n          }\n        };\n      }\n      return this.replicateMethods;\n    }\n  });\n\n  PouchDB.prototype.sync = function (dbName, opts, callback) {\n    return this.constructor.sync(this, dbName, opts, callback);\n  };\n}\n\nPouchDB.plugin(IDBPouch)\n  .plugin(HttpPouch$1)\n  .plugin(mapreduce)\n  .plugin(replication);\n\n// Pull from src because pouchdb-node/pouchdb-browser themselves\n\nexport default PouchDB;\n","import NeonCore from './NeonCore';\n\nimport { parseManifest } from './utils/NeonManifest';\nimport { prepareEditMode } from './utils/EditControls';\nimport setBody from './utils/template/Template';\nimport * as Types from './Types';\nimport * as Interfaces from './Interfaces';\n\n\n/**\n * NeonView class. Manages the other modules of Neon and communicates with\n * NeonCore.\n */\nclass NeonView {\n  /** The manifest describing what to load and where to find it. */\n  manifest: Types.NeonManifest;\n  /** Module that displays rendered MEI. */\n  view: Interfaces.ViewInterface;\n  /** Name of the document loaded. */\n  name: string;\n  /** Module that handles managing resources, rendering SVGs. */\n  core: NeonCore;\n  /** Module that provides additional information on musical elements. */\n  info: Interfaces.InfoInterface;\n  /** Module that allows editing of musical elements. */\n  NeumeEdit: Interfaces.NeumeEditInterface;\n  /** Module that allows viewing of syllable text. */\n  textView: Interfaces.TextViewInterface;\n  /** Module that allows editing of syllable text. */\n  TextEdit: Interfaces.TextEditInterface;\n\n  params: Interfaces.NeonViewParams;\n\n\n  /**\n   * Constructor for NeonView. Sets mode and passes constructors.\n   */\n  constructor (params: Interfaces.NeonViewParams) {\n    if (!parseManifest(params.manifest)) {\n      console.error('Unable to parse the manifest');\n    }\n\n    this.params = params;\n    this.manifest = params.manifest;\n  }\n\n  /**\n   * Set up Neon for any provided editing modules.\n   */\n  setupEdit(params: Interfaces.NeonViewParams): void {\n    if (params.NeumeEdit !== undefined || (params.TextEdit !== undefined && params.TextView !== undefined)) {\n      // Set up display for edit button\n      prepareEditMode(this);\n    }\n\n    if (params.NeumeEdit !== undefined) {\n      this.NeumeEdit = new params.NeumeEdit(this);\n    }\n    if (params.TextView !== undefined) {\n      this.textView = new params.TextView(this);\n      if (params.TextEdit !== undefined) {\n        this.TextEdit = new params.TextEdit(this);\n      }\n    }\n  }\n\n  /**\n   * Start Neon\n   */\n  start (): void {\n    /* this.core.db.info().then((info) => {\n      if (info.doc_count === 0) {\n        this.core.initDb().then(() => { this.updateForCurrentPage(); });\n      } else {\n        Notification.queueNotification('Existing database found. Revert to start from the beginning.');\n        this.updateForCurrentPage();\n      }\n    }); */\n    setBody().then(() => {\n      this.view = new this.params.View(this, this.params.Display, this.manifest.image);\n      this.name = this.manifest.title;\n\n      this.core = new NeonCore(this.manifest);\n      this.info = new this.params.Info(this);\n\n      window.setTimeout(this.setupEdit.bind(this), 2000, this.params);\n      return this.core.initDb();\n    }).then(() => {\n      this.updateForCurrentPage(true);\n    });\n  }\n\n  /**\n   * Get the current page from the loaded view and then display the\n   * most up to date SVG.\n   */\n  updateForCurrentPage (delay = false): Promise<void> {\n    const pageNo = this.view.getCurrentPage();\n    return this.view.changePage(pageNo, delay);\n  }\n\n  /**\n   * Redo an action performed on the current page (if there is one).\n   */\n  redo (): Promise<boolean> {\n    return this.core.redo(this.view.getCurrentPageURI());\n  }\n\n  /**\n   * Undo the last action performed on the current page (if there is one).\n   */\n  undo (): Promise<boolean> {\n    return this.core.undo(this.view.getCurrentPageURI());\n  }\n\n  /**\n   * Get the mode Neon is in.\n   * @returns Value is \"viewer\", \"insert\", or \"edit\".\n   */\n  getUserMode (): string {\n    if (this.NeumeEdit !== undefined) {\n      return this.NeumeEdit.getUserMode();\n    } else if (this.TextEdit !== undefined) {\n      return 'edit';\n    } else {\n      return 'viewer';\n    }\n  }\n\n  /**\n   * Attempt to perform an editor action.\n   * @param action - The editor toolkit action object.\n   * @param pageURI - The URI of the page to perform the action on\n   */\n  edit (action: Types.EditorAction, pageURI: string): Promise<boolean> {\n    return this.core.edit(action, pageURI);\n  }\n\n  /**\n   * Get the attributes for a specific musical element.\n   * @param elementId - The unique ID of the musical element.\n   * @param pageURI - The URI of the page the element is found on.\n   */\n  getElementAttr (elementID: string, pageURI: string): Promise<Types.Attributes> {\n    return this.core.getElementAttr(elementID, pageURI);\n  }\n\n  /**\n   * Updates browser database and creates JSON-LD save file.\n   * @returns The contents of this file.\n   */\n  export (): Promise<string | ArrayBuffer> {\n    return (new Promise((resolve, reject): void => {\n      this.core.updateDatabase().then(() => {\n        this.manifest['mei_annotations'] = this.core.getAnnotations();\n        this.manifest.timestamp = (new Date()).toISOString();\n        const data = new window.Blob([JSON.stringify(this.manifest, null, 2)], { type: 'application/ld+json' });\n        const reader = new FileReader();\n        reader.addEventListener('load', () => {\n          resolve(reader.result);\n        });\n        reader.readAsDataURL(data);\n      }).catch(err => { reject(err); });\n    }));\n  }\n\n  /**\n   * Save the current state to the browser database.\n   */\n  save (): Promise<void> {\n    return this.core.updateDatabase();\n  }\n\n  /**\n   * Deletes the local database of the loaded MEI file(s).\n   */\n  deleteDb (): Promise<void> {\n    return this.core.deleteDb();\n  }\n\n  /**\n   * Get the page's MEI file encoded as a data URI.\n   * @param pageNo - The URI specifying the page.\n   * @returns A [Data URI](https://en.wikipedia.org/wiki/Data_URI_scheme).\n   */\n  getPageURI (pageNo?: string): Promise<string> {\n    if (pageNo === undefined) {\n      pageNo = this.view.getCurrentPageURI();\n    }\n    return new Promise((resolve): void => {\n      this.core.getMEI(pageNo).then((mei) => {\n        resolve('data:application/mei+xml;charset=utf-8,' + encodeURIComponent(mei));\n      });\n    });\n  }\n\n  /**\n   * Get the page's MEI file as a string.\n   * @param pageNo - The identifying URI of the page.\n   */\n  getPageMEI (pageNo: string): Promise<string> {\n    return this.core.getMEI(pageNo);\n  }\n\n  /**\n   * Get the page's SVG.\n   * @param pageNo - The identifying URI of the page.\n   */\n  getPageSVG (pageNo: string): Promise<SVGSVGElement> {\n    return this.core.getSVG(pageNo);\n  }\n}\n\nexport { NeonView as default };\n","var v1 = require('./v1');\nvar v4 = require('./v4');\n\nvar uuid = v4;\nuuid.v1 = v1;\nuuid.v4 = v4;\n\nmodule.exports = uuid;\n","'use strict';\n\n/**\n * Stringify/parse functions that don't operate\n * recursively, so they avoid call stack exceeded\n * errors.\n */\nexports.stringify = function stringify(input) {\n  var queue = [];\n  queue.push({obj: input});\n\n  var res = '';\n  var next, obj, prefix, val, i, arrayPrefix, keys, k, key, value, objPrefix;\n  while ((next = queue.pop())) {\n    obj = next.obj;\n    prefix = next.prefix || '';\n    val = next.val || '';\n    res += prefix;\n    if (val) {\n      res += val;\n    } else if (typeof obj !== 'object') {\n      res += typeof obj === 'undefined' ? null : JSON.stringify(obj);\n    } else if (obj === null) {\n      res += 'null';\n    } else if (Array.isArray(obj)) {\n      queue.push({val: ']'});\n      for (i = obj.length - 1; i >= 0; i--) {\n        arrayPrefix = i === 0 ? '' : ',';\n        queue.push({obj: obj[i], prefix: arrayPrefix});\n      }\n      queue.push({val: '['});\n    } else { // object\n      keys = [];\n      for (k in obj) {\n        if (obj.hasOwnProperty(k)) {\n          keys.push(k);\n        }\n      }\n      queue.push({val: '}'});\n      for (i = keys.length - 1; i >= 0; i--) {\n        key = keys[i];\n        value = obj[key];\n        objPrefix = (i > 0 ? ',' : '');\n        objPrefix += JSON.stringify(key) + ':';\n        queue.push({obj: value, prefix: objPrefix});\n      }\n      queue.push({val: '{'});\n    }\n  }\n  return res;\n};\n\n// Convenience function for the parse function.\n// This pop function is basically copied from\n// pouchCollate.parseIndexableString\nfunction pop(obj, stack, metaStack) {\n  var lastMetaElement = metaStack[metaStack.length - 1];\n  if (obj === lastMetaElement.element) {\n    // popping a meta-element, e.g. an object whose value is another object\n    metaStack.pop();\n    lastMetaElement = metaStack[metaStack.length - 1];\n  }\n  var element = lastMetaElement.element;\n  var lastElementIndex = lastMetaElement.index;\n  if (Array.isArray(element)) {\n    element.push(obj);\n  } else if (lastElementIndex === stack.length - 2) { // obj with key+value\n    var key = stack.pop();\n    element[key] = obj;\n  } else {\n    stack.push(obj); // obj with key only\n  }\n}\n\nexports.parse = function (str) {\n  var stack = [];\n  var metaStack = []; // stack for arrays and objects\n  var i = 0;\n  var collationIndex,parsedNum,numChar;\n  var parsedString,lastCh,numConsecutiveSlashes,ch;\n  var arrayElement, objElement;\n  while (true) {\n    collationIndex = str[i++];\n    if (collationIndex === '}' ||\n        collationIndex === ']' ||\n        typeof collationIndex === 'undefined') {\n      if (stack.length === 1) {\n        return stack.pop();\n      } else {\n        pop(stack.pop(), stack, metaStack);\n        continue;\n      }\n    }\n    switch (collationIndex) {\n      case ' ':\n      case '\\t':\n      case '\\n':\n      case ':':\n      case ',':\n        break;\n      case 'n':\n        i += 3; // 'ull'\n        pop(null, stack, metaStack);\n        break;\n      case 't':\n        i += 3; // 'rue'\n        pop(true, stack, metaStack);\n        break;\n      case 'f':\n        i += 4; // 'alse'\n        pop(false, stack, metaStack);\n        break;\n      case '0':\n      case '1':\n      case '2':\n      case '3':\n      case '4':\n      case '5':\n      case '6':\n      case '7':\n      case '8':\n      case '9':\n      case '-':\n        parsedNum = '';\n        i--;\n        while (true) {\n          numChar = str[i++];\n          if (/[\\d\\.\\-e\\+]/.test(numChar)) {\n            parsedNum += numChar;\n          } else {\n            i--;\n            break;\n          }\n        }\n        pop(parseFloat(parsedNum), stack, metaStack);\n        break;\n      case '\"':\n        parsedString = '';\n        lastCh = void 0;\n        numConsecutiveSlashes = 0;\n        while (true) {\n          ch = str[i++];\n          if (ch !== '\"' || (lastCh === '\\\\' &&\n              numConsecutiveSlashes % 2 === 1)) {\n            parsedString += ch;\n            lastCh = ch;\n            if (lastCh === '\\\\') {\n              numConsecutiveSlashes++;\n            } else {\n              numConsecutiveSlashes = 0;\n            }\n          } else {\n            break;\n          }\n        }\n        pop(JSON.parse('\"' + parsedString + '\"'), stack, metaStack);\n        break;\n      case '[':\n        arrayElement = { element: [], index: stack.length };\n        stack.push(arrayElement.element);\n        metaStack.push(arrayElement);\n        break;\n      case '{':\n        objElement = { element: {}, index: stack.length };\n        stack.push(objElement.element);\n        metaStack.push(objElement);\n        break;\n      default:\n        throw new Error(\n          'unexpectedly reached end of input: ' + collationIndex);\n    }\n  }\n};\n","import * as DisplayControls from './DisplayControls';\nimport ZoomHandler from '../SingleView/Zoom';\nimport { DisplayInterface, ViewInterface } from '../Interfaces';\n\n/**\n * Return the HTML for the display panel.\n * @param {ZoomHandler} handleZoom - Includes zoom controls if defined.\n * @returns {string}\n */\nfunction displayControlsPanel (handleZoom: ZoomHandler): string {\n  let contents =\n  '<p class=\\'panel-heading\\' id=\\'displayHeader\\'>Display' +\n  '<svg class=\\'icon is-pulled-right\\'><use id=\\'toggleDisplay\\' xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use></svg></p>' +\n  '<div id=\\'displayContents\\'>';\n  if (handleZoom !== undefined) {\n    contents +=\n    '<a class=\\'panel-block has-text-centered\\'><button class=\\'button\\' id=\\'reset-zoom\\'>Zoom</button>' +\n    '<input class=\\'slider is-fullwidth\\' id=\\'zoomSlider\\' step=\\'5\\' min=\\'25\\' max=\\'400\\' value=\\'100\\' type=\\'range\\'/>' +\n    '<output id=\\'zoomOutput\\' for=\\'zoomSlider\\'>100</output></a>';\n  }\n  contents +=\n  '<a class=\\'panel-block has-text-centered\\'><button class=\\'button\\' id=\\'reset-opacity\\'>Glyph Opacity</button>' +\n  '<input class=\\'slider is-fullwidth\\' id=\\'opacitySlider\\' step=\\'5\\' min=\\'0\\' max=\\'100\\' value=\\'100\\' type=\\'range\\'/>' +\n  '<output id=\\'opacityOutput\\' for=\\'opacitySlider\\'>100</output></a>' +\n  '<a class=\\'panel-block has-text-centered\\'><button class=\\'button\\' id=\\'reset-bg-opacity\\'>Image Opacity</button>' +\n  '<input class=\\'slider is-fullwidth\\' id=\\'bgOpacitySlider\\' step=\\'5\\' min=\\'0\\' max=\\'100\\' value=\\'100\\' type=\\'range\\'/>' +\n  '<output id=\\'bgOpacityOutput\\' for=\\'bgOpacitySlider\\'>100</output></a>' +\n  '<div class=\\'panel-block\\' id=\\'extensible-block\\'>' +\n  '<div class=\\'dropdown\\' id=\\'highlight-dropdown\\'><div class=\\'dropdown-trigger\\'>' +\n  '<button class=\\'button\\' id=\\'highlight-button\\' aria-haspopup=\\'true\\' aria-controls=\\'highlight-menu\\' style=\\'width: auto\\'>' +\n  '<span>Highlight</span><span id=\\'highlight-type\\'>&nbsp;- Off</span>' +\n  '<svg class=\\'icon\\'><use id=\\'toggleDisplay\\' xlink:href=\\'' + __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down\\'></use>' +\n  '</svg></button></div><div class=\\'dropdown-menu\\' id=\\'highlight-menu\\' role=\\'menu\\'>' +\n  '<div class=\\'dropdown-content\\'><a class=\\'dropdown-item\\' id=\\'highlight-staff\\'>Staff</a>' +\n  '<a class=\\'dropdown-item\\' id=\\'highlight-syllable\\'>Syllable</a>' +\n  '<a class=\\'dropdown-item\\' id=\\'highlight-neume\\'>Neume</a><hr class=\\'dropdown-divider\\'/>' +\n  '<a class=\\'dropdown-item\\' id=\\'highlight-none\\'>None</a></div></div></div></div></div>';\n  return contents;\n}\n\n/**\n * A class that sets the content of the display panel to the right and\n * manages controls for viewing.\n */\nclass DisplayPanel implements DisplayInterface {\n  view: ViewInterface;\n  className: string;\n  background: string;\n  zoomHandler: ZoomHandler;\n\n  /**\n   * Constructor for DisplayPanel.\n   * @param {SingleView | DivaView} view - The View parent.\n   * @param {string} className - The class name for the rendered SVG object(s).\n   * @param {string} background - The class name associated with the background.\n   * @param {ZoomHandler} [zoomHandler] - The ZoomHandler object, if SingleView.\n   */\n  constructor (view: ViewInterface, className: string,\n    background: string, zoomHandler: ZoomHandler = undefined) {\n    this.view = view;\n    this.className = className;\n    this.background = background;\n    this.zoomHandler = zoomHandler;\n\n    const displayPanel = document.getElementById('display_controls');\n    displayPanel.innerHTML = displayControlsPanel(this.zoomHandler);\n    this.view.addUpdateCallback(this.updateVisualization.bind(this));\n  }\n\n  /**\n   * Apply event listeners related to the DisplayPanel.\n   */\n  setDisplayListeners (): void {\n    if (this.zoomHandler) {\n      // Zoom handler stuff\n      DisplayControls.setZoomControls(this.zoomHandler);\n    }\n    DisplayControls.initDisplayControls(this.className, this.background);\n  }\n\n  /**\n   * Update SVG based on visualization settings\n   */\n  updateVisualization (): void {\n    DisplayControls.setOpacityFromSlider(this.className);\n    DisplayControls.updateHighlight();\n  }\n}\n\nexport { DisplayPanel as default };\n","import NeonView from './NeonView';\nimport DisplayPanel from './DisplayPanel/DisplayPanel';\nimport { DisplayConstructable, ViewInterface } from './Interfaces';\nimport ZoomHandler from './SingleView/Zoom';\n\ndeclare let Diva: any;\n\n/**\n * View module that uses the diva.js viewer to render the pages of a IIIF manifests\n * and then display the rendered MEI files over the proper pages.\n */\nclass DivaView implements ViewInterface {\n  readonly neonView: NeonView;\n  private updateCallbacks: Array<() => void>;\n  divaReady: boolean;\n  private diva: any;\n  private indexMap: Map<number, string>;\n  private displayPanel: DisplayPanel;\n  private loadDelay: number;\n  zoomHandler: ZoomHandler;\n\n  /**\n   * @param manifest - Link to the IIIF manifest.\n   */\n  constructor (neonView: NeonView, Display: DisplayConstructable, manifest: string) {\n    this.neonView = neonView;\n    this.updateCallbacks = [];\n    this.divaReady = false;\n    this.diva = new Diva('container', {\n      objectData: manifest\n    });\n    document.getElementById('container').style.minHeight = '100%';\n    this.indexMap = new Map();\n    this.diva.disableDragScrollable();\n    this.displayPanel = new Display(this, 'neon-container', 'diva-viewer-canvas');\n    this.loadDelay = 500; // in milliseconds\n    this.initDivaEvents();\n    this.setViewEventHandlers();\n\n    window.onresize = (): void => {\n      const height = window.innerHeight;\n      const width = window.innerWidth;\n\n      window.setTimeout((): void => {\n        if ((height === window.innerHeight) && (width === window.innerWidth)) {\n          this.changePage(this.getCurrentPage(), false);\n        }\n      }, this.loadDelay);\n    };\n  }\n\n  /**\n   * Set the listeners for certain events internal to diva.js\n   */\n  initDivaEvents (): void {\n    Diva.Events.subscribe('ManifestDidLoad', this.parseManifest.bind(this), this.diva.settings.ID);\n    Diva.Events.subscribe('ObjectDidLoad', this.didLoad.bind(this), this.diva.settings.ID);\n    Diva.Events.subscribe('ActivePageDidChange', this.changePage.bind(this), this.diva.settings.ID);\n    Diva.Events.subscribe('ZoomLevelDidChange', this.adjustZoom.bind(this), this.diva.settings.ID);\n  }\n\n  /**\n   * Called when the visible page changes in the diva.js viewer.\n   * @param pageIndex - The zero-indexed page that is most visible.\n   * @param delay - Whether to delay the loading of the page so that neon doesn't lag while scrolling.\n   */\n  async changePage (pageIndex: number, delay = true): Promise<void> {\n    function checkAndLoad (page: number): void {\n      if (page === this.getCurrentPage()) {\n        const pageURI = this.indexMap.get(page);\n        this.neonView.getPageSVG(pageURI).then((svg: SVGSVGElement) => {\n          this.updateSVG(svg, page);\n          const containerId = 'neon-container-' + page;\n          const container = document.getElementById(containerId);\n          if (container !== null) {\n            container.classList.add('active-page');\n          }\n          this.updateCallbacks.forEach((callback: Function) => callback());\n        }).catch((err: { name: string }) => {\n          if (err.name !== 'not_found' && err.name !== 'missing_mei') {\n            console.error(err);\n          }\n        });\n      }\n    }\n\n    const pageIndexes = [pageIndex];\n    Array.from(document.getElementsByClassName('active-page')).forEach(elem => {\n      elem.classList.remove('active-page');\n    });\n    for (const page of pageIndexes) {\n      if (delay) {\n        window.setTimeout(checkAndLoad.bind(this), (this.loadDelay), page);\n      } else {\n        checkAndLoad.bind(this)(page);\n      }\n    }\n  }\n\n  /**\n   * Get the active page in the diva.js viewer.\n   */\n  getCurrentPage (): number {\n    return this.diva.getActivePageIndex();\n  }\n\n  /**\n   * Get the active page URI in the diva.js viewer.\n   */\n  getCurrentPageURI (): string {\n    return this.indexMap.get(this.getCurrentPage());\n  }\n\n  /**\n   * Adjust the rendered SVG(s) to be the correct size after zooming.\n   */\n  adjustZoom (): void {\n    (new Promise((resolve): void => {\n      Array.from(document.getElementsByClassName('neon-container'))\n        .forEach((elem: HTMLElement) => { elem.style.display = 'none'; });\n      setTimeout(resolve, this.diva.settings.zoomDuration + 100);\n    })).then(() => {\n      this.changePage(this.diva.getActivePageIndex(), true);\n      Array.from(document.getElementsByClassName('neon-container'))\n        .forEach((elem: HTMLElement) => {\n          const svg = elem.firstChild as SVGSVGElement;\n          const pageNo = parseInt(elem.id.match(/\\d+/)[0]);\n          this.updateSVG(svg, pageNo);\n          elem.style.display = '';\n        });\n    });\n  }\n\n  /**\n   * Update the SVG being displayed for the specified page.\n   * @param pageNo - The zero-indexed page number.\n   */\n  updateSVG (svg: SVGSVGElement, pageNo: number): void {\n    const inner = document.getElementById('diva-1-inner');\n    const dimensions = this.diva.getPageDimensionsAtCurrentZoomLevel(pageNo);\n    const offset = this.diva.settings.viewHandler._viewerCore.getPageRegion(pageNo, {\n      includePadding: true,\n      incorporateViewport: true\n    });\n    const marginLeft = window.getComputedStyle(inner, null)\n      .getPropertyValue('margin-left');\n\n    const containerId = 'neon-container-' + pageNo.toString();\n    let container = document.getElementById(containerId);\n    if (container === null) {\n      container = document.createElement('div');\n      container.id = containerId;\n      container.classList.add('neon-container');\n      inner.appendChild(container);\n    }\n\n    while (container.firstChild) {\n      container.removeChild(container.firstChild);\n    }\n\n    svg.setAttribute('width', dimensions.width);\n    svg.setAttribute('height', dimensions.height);\n    container.style.position = 'absolute';\n    container.style.top = `${offset.top}px`;\n    container.style.left = `${offset.left - parseInt(marginLeft)}px`;\n\n    container.appendChild(svg);\n  }\n\n  /**\n   * Function called when diva.js finishes loading.\n   */\n  didLoad (): void {\n    this.divaReady = true;\n    this.displayPanel.setDisplayListeners();\n    document.getElementById('loading').style.display = 'none';\n    console.log(this.diva);\n  }\n\n  /**\n   * Add a callback function that will be run whenever an SVG is updated.\n   */\n  addUpdateCallback (cb: () => void): void {\n    this.updateCallbacks.push(cb);\n  }\n\n  /**\n   * Remove a callback function previously added to the list of functions to call.\n   */\n  removeUpdateCallback (cb: () => void): void {\n    const index = this.updateCallbacks.findIndex((elem) => {\n      return elem === cb;\n    });\n    if (index !== -1) {\n      this.updateCallbacks.splice(index, 1);\n    }\n  }\n\n  /**\n   * Set listeners on the body element for global events.\n   */\n  setViewEventHandlers (): void {\n    document.body.addEventListener('keydown', (evt) => {\n      switch (evt.key) {\n        case 'h':\n          for (const container of document.getElementsByClassName('neon-container') as HTMLCollectionOf<HTMLElement>) {\n            container.style.visibility = 'hidden';\n          }\n          break;\n        default: break;\n      }\n    });\n\n    document.body.addEventListener('keyup', (evt) => {\n      switch (evt.key) {\n        case 'h':\n          for (const container of document.getElementsByClassName('neon-container') as HTMLCollectionOf<HTMLElement>) {\n            container.style.visibility = '';\n          }\n          break;\n        default: break;\n      }\n    });\n  }\n\n  /**\n   * Use the IIIF manifest to create a map between IIIF canvases and page indexes.\n   * @param manifest - The IIIF manifest object.\n   */\n  parseManifest (manifest: { sequences: { canvases: object[] }[] }): void {\n    this.indexMap.clear();\n    for (const sequence of manifest.sequences) {\n      for (const canvas of sequence.canvases) {\n        this.indexMap.set(sequence.canvases.indexOf(canvas), canvas['@id']);\n      }\n    }\n  }\n\n  /**\n   * Get the name of the active page/canvas combined with the manuscript name.\n   */\n  getPageName (): string {\n    const manuscriptName = this.diva.settings.manifest.itemTitle;\n    const pageName = this.diva.settings.manifest.pages[this.getCurrentPage()].l;\n    return manuscriptName + ' \\u2014 ' + pageName;\n  }\n}\n\nexport { DivaView as default };\n","import { updateHighlight, setOpacityFromSlider } from '../DisplayPanel/DisplayControls';\nimport NeonView from '../NeonView';\nimport DisplayPanel from '../DisplayPanel/DisplayPanel';\nimport ZoomHandler from './Zoom';\nimport { ViewInterface, DisplayConstructable } from '../Interfaces';\n\nimport * as d3 from 'd3';\n\n/**\n * A view module for displaying a single page of a manuscript.\n */\nclass SingleView implements ViewInterface {\n  readonly neonView: NeonView;\n  private container: HTMLElement;\n  private updateCallbacks: Array<() => void>;\n  private group: SVGSVGElement;\n  private bg: SVGImageElement;\n  private mei: SVGSVGElement;\n  zoomHandler: ZoomHandler;\n  private displayPanel: DisplayPanel;\n  readonly pageURI: string;\n  /**\n   * Constructor for SingleView.\n   * @param image - The URI to the background image for the page.\n   */\n  constructor (neonView: NeonView, panel: DisplayConstructable, image: string) {\n    this.neonView = neonView;\n    this.container = document.getElementById('container');\n    this.updateCallbacks = new Array(0);\n    // Group will contain the image and the rendered SVG\n    this.group = document.createElementNS('http://www.w3.org/2000/svg', 'svg');\n    this.group.id = 'svg_group';\n    this.group.setAttribute('height', window.innerHeight.toString());\n    this.group.setAttribute('width', '100%');\n\n    this.bg = document.createElementNS('http://www.w3.org/2000/svg', 'image');\n    this.bg.id = 'bgimg';\n    this.bg.classList.add('background');\n    this.bg.setAttribute('x', '0');\n    this.bg.setAttribute('y', '0');\n\n    const reader = new FileReader();\n    fetch(image).then(result => {\n      if (result.ok) {\n        reader.addEventListener('load', () => {\n          this.bg.setAttributeNS('http://www.w3.org/1999/xlink', 'href', reader.result.toString());\n          const bbox = this.bg.getBBox();\n          if (!this.group.hasAttribute('viewBox')) {\n            this.group.setAttribute('viewBox', '0 0 ' + bbox.width.toString() + ' ' + bbox.height.toString());\n          }\n        });\n        return result.blob();\n      }\n    }).then(blob => {\n      reader.readAsDataURL(blob);\n    });\n\n    this.mei = document.createElementNS('http://www.w3.org/svg', 'svg') as SVGSVGElement;\n    this.mei.id = 'mei_output';\n    this.mei.classList.add('neon-container', 'active-page');\n\n    this.group.appendChild(this.bg);\n    this.group.appendChild(this.mei);\n    this.container.appendChild(this.group);\n\n    this.zoomHandler = new ZoomHandler();\n    this.displayPanel = new panel(this, 'neon-container', 'background', this.zoomHandler);\n\n    this.setViewEventHandlers();\n    this.displayPanel.setDisplayListeners();\n\n    this.pageURI = image;\n\n    document.getElementById('loading').style.display = 'none';\n  }\n\n  /**\n   * Update the SVG being displayed.\n   */\n  updateSVG (svg: SVGSVGElement): void {\n    this.group.replaceChild(svg, this.mei);\n    this.mei = svg;\n    this.mei.id = 'mei_output';\n    this.mei.classList.add('neon-container', 'active-page');\n    const height = parseInt(this.mei.getAttribute('height'));\n    const width = parseInt(this.mei.getAttribute('width'));\n\n    this.bg.setAttribute('height', height.toString());\n    this.bg.setAttribute('width', width.toString());\n    this.group.setAttribute('viewBox', '0 0 ' + width + ' ' + height);\n    updateHighlight();\n    this.resetTransformations();\n    this.updateCallbacks.forEach(callback => callback());\n  }\n\n  /**\n   * Change to a certain page\n   * Since there is only one page, this is essentially a wrapper for updateSVG\n   */\n  async changePage (_page: number, _delay: boolean): Promise<void> {\n    const svg = await this.neonView.getPageSVG(this.getCurrentPageURI());\n    this.updateSVG(svg);\n  }\n\n  /**\n   * Add a callback to the list of those be called when the page updates.\n   */\n  addUpdateCallback (cb: () => void): void {\n    this.updateCallbacks.push(cb);\n  }\n\n  /**\n   * Remove a callback from the list of callbacks if it is part of the list.\n   */\n  removeUpdateCallback (cb: () => void): void {\n    const index = this.updateCallbacks.findIndex((elem) => {\n      return elem === cb;\n    });\n    if (index !== -1) {\n      this.updateCallbacks.splice(index, 1);\n    }\n  }\n\n  /**\n   * Reset the transformations that have been applied to the SVG upon update.\n   */\n  resetTransformations (): void {\n    this.displayPanel.zoomHandler.restoreTransformation();\n    setOpacityFromSlider();\n  }\n\n  /**\n   * Returns the zero-indexed number of the current page. This will always be zero.\n   */\n  getCurrentPage (): number {\n    return 0;\n  }\n\n  /**\n   * Returns the page URI.\n   */\n  getCurrentPageURI (): string {\n    return this.pageURI;\n  }\n\n  /**\n   * Set event handlers for the view and display panel.\n   */\n  setViewEventHandlers (): void {\n    document.body.addEventListener('keydown', (evt) => {\n      switch (evt.key) {\n        case 'Shift':\n          d3.select('#svg_group').on('.drag', null);\n          d3.select('#svg_group').call(\n            d3.drag().on('start', this.displayPanel.zoomHandler.startDrag.bind(this.displayPanel.zoomHandler))\n              .on('drag', this.displayPanel.zoomHandler.dragging.bind(this.displayPanel.zoomHandler))\n          );\n          break;\n        case 'h':\n          document.getElementById('mei_output').setAttribute('visibility', 'hidden');\n          break;\n        default: break;\n      }\n    });\n    document.body.addEventListener('keyup', (evt) => {\n      switch (evt.key) {\n        case 'Shift':\n          d3.select('#svg_group').on('.drag', null);\n          if (this.neonView.getUserMode() !== 'viewer') {\n            this.neonView.NeumeEdit.setSelectListeners();\n          }\n          break;\n        case 'h':\n          document.getElementById('mei_output').setAttribute('visibility', 'visible');\n          break;\n        default: break;\n      }\n    });\n\n    d3.select('#container').on('touchstart', () => {\n      if (d3.event.touches.length === 2) {\n        this.displayPanel.zoomHandler.startDrag();\n        d3.select('#container').on('touchmove', this.displayPanel.zoomHandler.dragging.bind(this.displayPanel.zoomHandler));\n        d3.select('#container').on('touchend', () => {\n          d3.select('#container').on('touchmove', null);\n        });\n      }\n    });\n    d3.select('#container').on('wheel', this.displayPanel.zoomHandler.scrollZoom.bind(this.displayPanel.zoomHandler), false);\n    // Update height of container based on window\n    window.onresize = (): void => {\n      const newHeight = window.innerHeight;\n      const container = document.getElementById('container');\n      if (newHeight > Number(container.getAttribute('height'))) {\n        container.setAttribute('height', newHeight.toString());\n      }\n    };\n  }\n\n  /**\n   * A human readable name for the page. Used for downloads.\n   */\n  getPageName (): string {\n    return this.neonView.name;\n  }\n}\n\nexport { SingleView as default };\n","import { bindInsertTabs, initInsertEditControls, initEditModeControls, initSelectionButtons } from './Controls';\nimport * as Select from '../utils/Select';\nimport InsertHandler from './InsertHandler';\nimport NeonView from '../NeonView';\nimport * as SelectOptions from './SelectOptions';\nimport { setHighlightSelectionControls } from '../DisplayPanel/DisplayControls';\nimport DragHandler from '../utils/DragHandler';\nimport { NeumeEditInterface } from '../Interfaces';\n\nclass DivaEdit implements NeumeEditInterface {\n  neonView: NeonView;\n  dragHandler: DragHandler;\n  insertHandler: InsertHandler;\n  constructor (neonView: NeonView) {\n    this.neonView = neonView;\n    initEditModeControls(this);\n  }\n\n  initEditMode (): void {\n    this.dragHandler = new DragHandler(this.neonView, '.active-page > svg');\n    this.insertHandler = new InsertHandler(this.neonView, '.active-page > svg');\n    bindInsertTabs(this.insertHandler);\n    document.getElementById('primitiveTab').click();\n    Select.setSelectHelperObjects(this.neonView, this.dragHandler);\n    this.setSelectListeners();\n\n    SelectOptions.initNeonView(this.neonView);\n    initInsertEditControls();\n    const editMenu = document.getElementById('editMenu');\n    editMenu.style.backgroundColor = '#ffc7c7';\n    editMenu.style.fontWeight = 'bold';\n\n    Select.setSelectStrokeWidth(1);\n\n    initSelectionButtons();\n\n    setHighlightSelectionControls();\n\n    this.neonView.view.addUpdateCallback(this.setSelectListeners.bind(this));\n  }\n\n  /**\n   * Get the user mode that Neon is in. Either insert, edit, or viewer.\n   * @returns {string}\n   */\n  getUserMode (): string {\n    if (this.insertHandler !== undefined) {\n      if (this.insertHandler.isInsertMode()) {\n        return 'insert';\n      }\n      return 'edit';\n    }\n    return 'viewer';\n  }\n\n  setSelectListeners (): void {\n    Select.clickSelect('.active-page > svg > svg, .active-page > svg > svg use, .active-page > svg > svg rect');\n    Select.dragSelect('.active-page svg');\n  }\n}\n\nexport { DivaEdit as default };\n","import { bindInsertTabs, initInsertEditControls, initEditModeControls, initSelectionButtons } from './Controls';\nimport { setHighlightSelectionControls } from '../DisplayPanel/DisplayControls';\nimport * as Select from '../utils/Select';\nimport InsertHandler from './InsertHandler';\nimport NeonView from '../NeonView';\nimport * as SelectOptions from './SelectOptions';\nimport DragHandler from '../utils/DragHandler';\nimport { NeumeEditInterface } from '../Interfaces';\n\n/**\n * An Edit Module for a single page of a manuscript.\n * Works with the SingleView module.\n */\nclass SingleEditMode implements NeumeEditInterface {\n  neonView: NeonView;\n  dragHandler: DragHandler;\n  insertHandler: InsertHandler;\n  /**\n   * Constructor for an EditMode object.\n   * @param {NeonView} neonView - The NeonView parent.\n   */\n  constructor (neonView: NeonView) {\n    this.neonView = neonView;\n    initEditModeControls(this);\n  }\n\n  /**\n   * Initialize the start of edit mode when first leaving viewer mode.\n   */\n  initEditMode (): void {\n    this.dragHandler = new DragHandler(this.neonView, '#svg_group');\n    this.insertHandler = new InsertHandler(this.neonView, '#svg_group');\n    bindInsertTabs(this.insertHandler);\n    document.getElementById('primitiveTab').click();\n    Select.setSelectHelperObjects(this.neonView, this.dragHandler);\n    this.setSelectListeners();\n\n    SelectOptions.initNeonView(this.neonView);\n    initInsertEditControls();\n    const editMenu = document.getElementById('editMenu');\n    editMenu.style.backgroundColor = '#ffc7c7';\n    editMenu.style.fontWeight = 'bold';\n\n    initSelectionButtons();\n\n    setHighlightSelectionControls();\n\n    this.neonView.view.addUpdateCallback(this.setSelectListeners.bind(this));\n  }\n\n  /**\n   * Get the user mode that Neon is in. Either insert, edit, or viewer.\n   * @returns {string}\n   */\n  getUserMode (): string {\n    if (this.insertHandler !== undefined) {\n      if (this.insertHandler.isInsertMode()) {\n        return 'insert';\n      }\n      return 'edit';\n    }\n    return 'viewer';\n  }\n\n  setSelectListeners (): void {\n    Select.clickSelect('#svg_group, #svg_group use, #svg_group rect');\n    Select.dragSelect('#svg_group');\n  }\n}\n\nexport { SingleEditMode as default };\n","/** @module InfoModule */\n\nimport NeonView from './NeonView';\nimport { InfoInterface } from './Interfaces';\nimport { Attributes } from './Types';\n\n/**\n * Map of contours to neume names.\n */\nconst neumeGroups = new Map(\n  [['', 'Punctum'], ['u', 'Pes'], ['d', 'Clivis'], ['uu', 'Scandicus'], ['ud', 'Torculus'], ['du', 'Porrectus'], ['s', 'Distropha'], ['ss', 'Tristopha'],\n    ['sd', 'Pressus'], ['dd', 'Climacus'], ['ddu', 'Climacus resupinus'], ['udu', 'Torculus resupinus'], ['dud', 'Porrectus flexus'],\n    ['udd', 'Pes subpunctis'], ['uud', 'Scandicus flexus'], ['uudd', 'Scandicus subpunctis'], ['dudd', 'Porrectus subpunctis']]\n);\n\nfunction startInfoVisibility (): void {\n  document.getElementById('neume_info').innerHTML =\n    '<article class=\\'message\\'><div class=\\'message-header\\'><p></p></div>' +\n      '<div class=\\'message-body\\'></div>';\n  document.getElementById('neume_info').setAttribute('style', 'display: none');\n}\n\n/**\n * Update the visibility of infoBox\n */\nfunction updateInfoVisibility (): void {\n  const neumeInfo = document.getElementById('neume_info');\n  if ((document.getElementById('displayInfo') as HTMLInputElement).checked) {\n    neumeInfo.setAttribute('style', '');\n  } else {\n    neumeInfo.setAttribute('style', 'display: none');\n  }\n}\n\n/**\n * Set listener on info visibility checkbox.\n */\nfunction setInfoControls (): void {\n  startInfoVisibility();\n  updateInfoVisibility();\n  document.getElementById('displayInfo').addEventListener('click', updateInfoVisibility);\n}\n\n/**\n * Class that manages getting information for elements in Neon from Verovio.\n */\nclass InfoModule implements InfoInterface {\n  private neonView: NeonView;\n\n  /**\n   * A constructor for an InfoModule.\n   * @param {NeonView} neonView - The NeonView parent.\n   */\n  constructor (neonView: NeonView) {\n    this.neonView = neonView;\n    // Add info box enable/disable check box\n    const block = document.getElementById('extensible-block');\n    const label = document.createElement('label');\n    label.classList.add('checkbox');\n    label.textContent = 'Display Info: ';\n    const input = document.createElement('input');\n    input.classList.add('checkbox');\n    input.id = 'displayInfo';\n    input.type = 'checkbox';\n    input.checked = false;\n    label.appendChild(input);\n    block.prepend(label);\n\n    this.neonView.view.addUpdateCallback(this.resetInfoListeners.bind(this));\n    setInfoControls();\n    this.resetInfoListeners();\n  }\n\n  /**\n   * Set listeners for the InfoModule.\n   */\n  infoListeners (): void {\n    try {\n      document.getElementsByClassName('active-page')[0]\n        .querySelectorAll('.neume,.custos,.clef')\n        .forEach(node => {\n          node.addEventListener('mouseover', this.updateInfo.bind(this));\n        });\n    } catch (e) {}\n  }\n\n  /**\n   * Stop listeners for the InfoModule.\n   */\n  stopListeners (): void {\n    document.querySelectorAll('.neume,.custos,.clef').forEach(node => {\n      node.removeEventListener('mouseover', this.updateInfo.bind(this));\n    });\n  }\n\n  /**\n   * Restart listeners for the InfoModule.\n   */\n  resetInfoListeners (): void {\n    this.stopListeners();\n    this.infoListeners();\n  }\n\n  /**\n   * Get updated info for the calling element based on its element type.\n   * Makes calls to NeonCore to get the information necessary.\n   */\n  async updateInfo (event: MouseEvent): Promise<void> {\n  // For now, since Clefs do not have their own element tag in mei4, there is not a way to select the <g> element\n  // So we will simply return if ID does not exist for now\n    const id = (event.currentTarget as HTMLElement).id;\n    if (id === '') {\n      Array.from(document.getElementById('neume_info').children).forEach(child => {\n        child.remove();\n      });\n      console.log('No id!');\n      return;\n    }\n\n    const element = document.getElementById(id);\n    const classRe = /neume|nc|clef|custos|staff/;\n    const elementClass = element.getAttribute('class').match(classRe)[0];\n    let body = '';\n    let attributes: Attributes;\n\n    // Gets the pitches depending on element type and\n    switch (elementClass) {\n      case 'neume':\n        // Select neume components of selected neume\n        const ncs = element.querySelectorAll('.nc') as NodeListOf<SVGGraphicsElement>;\n        let contour = await this.getContour(ncs);\n        if (contour === 'Clivis') {\n          const attr: Attributes = await this.neonView.getElementAttr(ncs[0].id, this.neonView.view.getCurrentPageURI());\n          if (attr.ligated) {\n            contour = 'Ligature';\n          }\n        }\n        let pitches = await this.getPitches(ncs);\n\n        pitches = pitches.trim().toUpperCase();\n        body = 'Shape: ' + (contour === undefined ? 'Compound' : contour) + '\\r\\n' +\n                'Pitch(es): ' + pitches;\n        break;\n      case 'custos':\n        attributes = await this.neonView.getElementAttr(id, this.neonView.view.getCurrentPageURI());\n        body += 'Pitch: ' + (attributes['pname']).toUpperCase() + attributes['oct'];\n        break;\n      case 'clef':\n        attributes = await this.neonView.getElementAttr(id, this.neonView.view.getCurrentPageURI());\n        body += 'Shape: ' + attributes['shape'] + '\\r\\n' +\n                'Line: ' + attributes['line'];\n        break;\n      default:\n        body += 'nothing';\n        break;\n    }\n    this.updateInfoModule(elementClass, body);\n  }\n\n  /**\n   * Get the individual pitches of a neume.\n   * @param ncs - Neume components in the neume.\n   * @returns Space separated pitches of the neume components in order.\n   */\n  async getPitches (ncs: Iterable<SVGGraphicsElement>): Promise<string> {\n    let pitches = '';\n    for (const nc of ncs) {\n      const attributes: Attributes = await this.neonView.getElementAttr(nc.id, this.neonView.view.getCurrentPageURI());\n      pitches += attributes['pname'] + attributes['oct'] + ' ';\n    }\n    return pitches;\n  }\n\n  /**\n   * Get the contour of a neume.\n   * @param ncs - Neume components in the neume.\n   */\n  async getContour (ncs: Iterable<SVGGraphicsElement>): Promise<string> {\n    let contour = '';\n    let previous: Attributes = null;\n    for (const nc of ncs) {\n      const attributes: Attributes = await this.neonView.getElementAttr(nc.id, this.neonView.view.getCurrentPageURI());\n      if (previous !== null) {\n        if (previous['oct'] > attributes['oct']) {\n          contour += 'd';\n        } else if (previous['oct'] < attributes['oct']) {\n          contour += 'u';\n        } else {\n          if (this.pitchNameToNum(previous['pname']) < this.pitchNameToNum(attributes['pname'])) {\n            contour += 'u';\n          } else if (this.pitchNameToNum(previous['pname']) > this.pitchNameToNum(attributes['pname'])) {\n            contour += 'd';\n          } else {\n            contour += 's';\n          }\n        }\n      }\n      previous = attributes;\n    }\n    if (neumeGroups.get(contour) === undefined) {\n      console.warn('Unknown contour: ' + contour);\n    }\n    return neumeGroups.get(contour);\n  }\n\n  /**\n   * Show and update the info box.\n   * @param title - The info box title.\n   * @param body - The info box contents.\n   */\n  updateInfoModule (title: string, body: string): void {\n    document.getElementsByClassName('message-header')[0].querySelector('p')\n      .textContent = title;\n    (document.getElementsByClassName('message-body')[0] as HTMLElement).innerText = body;\n\n    if ((document.getElementById('displayInfo') as HTMLInputElement).checked) {\n      (document.getElementsByClassName('message')[0] as HTMLElement).style.display = '';\n    }\n  }\n\n  /**\n   * Convert a pitch name (a-g) to a number (where c is 1, d is 2, ...and b is 7).\n   * @param pname - The pitch name.\n   * @returns\n   */\n  pitchNameToNum (pname: string): number {\n    switch (pname) {\n      case 'c':\n        return 1;\n      case 'd':\n        return 2;\n      case 'e':\n        return 3;\n      case 'f':\n        return 4;\n      case 'g':\n        return 5;\n      case 'a':\n        return 6;\n      case 'b':\n        return 7;\n      default:\n        console.log('Unknown pitch name');\n    }\n  }\n\n  /**\n   * Find the contour of an neume grouping based on the grouping name.\n   * @param value - The contour name.\n   */\n  getContourByValue (value: string): string {\n    for (const [cont, v] of neumeGroups.entries()) {\n      if (v === value) {\n        return cont;\n      }\n    }\n  }\n}\n\nexport { InfoModule as default };\n","import * as Notification from './utils/Notification';\nimport NeonView from './NeonView';\nimport { unselect } from './utils/SelectTools';\nimport { updateHighlight } from './DisplayPanel/DisplayControls';\nimport { TextViewInterface } from './Interfaces';\n\n/*\n * Class that manages getting the text for syllables in Neon from the mei file\n */\nclass TextView implements TextViewInterface {\n  private neonView: NeonView;\n  /** Whether or not the user has been notified about blank syllables. */\n  private notificationSent: boolean;\n  /**\n   * A constructor for a TextView.\n   * @param neonView - The calling [[NeonView]] for the instance.\n   */\n  constructor (neonView: NeonView) {\n    this.neonView = neonView;\n    this.notificationSent = false;\n\n    // add checkbox to enable/disable the view\n    const block = document.getElementById('extensible-block');\n    const textLabel = document.createElement('label');\n    const bboxLabel = document.createElement('label');\n    const textButton = document.createElement('input');\n    const bboxButton = document.createElement('input');\n    textLabel.classList.add('checkbox');\n    bboxLabel.classList.add('checkbox');\n    textLabel.textContent = 'Display Text: ';\n    bboxLabel.textContent = 'Display Text BBoxes: ';\n    textButton.classList.add('checkbox');\n    bboxButton.classList.add('checkbox');\n    textButton.id = 'displayText';\n    textButton.type = 'checkbox';\n    bboxButton.id = 'displayBBox';\n    bboxButton.type = 'checkbox';\n    textButton.checked = false;\n    bboxButton.checked = false;\n    textLabel.appendChild(textButton);\n    bboxLabel.appendChild(bboxButton);\n    block.prepend(bboxLabel);\n    block.prepend(textLabel);\n\n    this.setTextViewControls();\n    this.neonView.view.addUpdateCallback(this.updateTextViewVisibility.bind(this));\n    this.neonView.view.addUpdateCallback(this.updateBBoxViewVisibility.bind(this));\n  }\n\n  /**\n  * Set listeners on textview visibility checkbox\n  */\n  setTextViewControls (): void {\n    function textViewVis (): void { this.updateTextViewVisibility(); }\n    function bboxViewVis (): void { this.updateBBoxViewVisibility(); }\n\n    this.updateTextViewVisibility();\n    this.updateBBoxViewVisibility();\n    document.getElementById('displayText')\n      .addEventListener('click', textViewVis.bind(this));\n    document.getElementById('displayBBox')\n      .addEventListener('click', bboxViewVis.bind(this));\n  }\n\n  /**\n   * Update visibility of text bounding boxes\n   */\n  updateBBoxViewVisibility (): void {\n    if ((document.getElementById('displayBBox')as HTMLInputElement).checked) {\n      document.querySelectorAll('.sylTextRect').forEach(rect => {\n        rect.classList.add('sylTextRect-display');\n        rect.classList.remove('sylTextRect');\n      });\n      document.querySelectorAll('.syl.selected .sylTextRect-display')\n        .forEach((rect: HTMLElement) => { rect.style.fill = 'red'; });\n\n      if (this.neonView.getUserMode() !== 'viewer' && this.neonView.TextEdit !== undefined) {\n        this.neonView.TextEdit.initSelectByBBoxButton();\n      }\n    } else {\n      if ((document.getElementById('selByBBox') !== null) &&\n        document.getElementById('selByBBox').classList.contains('is-active')) {\n        unselect();\n        document.getElementById('selByBBox').classList.remove('is-active');\n        document.getElementById('selBySyl').classList.add('is-active');\n      }\n      document.querySelectorAll('.sylTextRect-display').forEach(rect => {\n        rect.classList.add('sylTextRect');\n        rect.classList.remove('sylTextRect-display');\n      });\n      document.querySelectorAll('.syl.selected .sylTextRect').forEach((rect: HTMLElement) => {\n        rect.style.fill = 'none';\n      });\n      try {\n        document.getElementById('selByBBox').style.display = 'none';\n      } catch (e) {}\n    }\n    updateHighlight();\n  }\n\n  /**\n  * Update the visibility of the textview box\n  * and add the event listeners to make sure the syl highlights when moused over\n  */\n  updateTextViewVisibility (): void {\n    if ((document.getElementById('displayText') as HTMLInputElement).checked) {\n      const sylText = document.getElementById('syl_text');\n      sylText.style.display = '';\n      sylText.innerHTML = '<p>' + this.getSylText() + '</p>';\n      const spans = sylText.querySelectorAll('p > span');\n      spans.forEach(span => {\n        const syllable = document.getElementById(span.className);\n        const syl = syllable.querySelector('.syl');\n        const text = syl.querySelector('text');\n        const rect = syl.querySelector('rect');\n        if (text.classList.length === 0) {\n          text.classList.add('text');\n        }\n\n        span.addEventListener('mouseover', () => {\n          syllable.classList.add('selected');\n          syllable.querySelectorAll('.neume').forEach(neume => {\n            neume.classList.add('selected');\n          });\n          if (rect !== null) {\n            rect.style.fill = '#d00';\n          }\n          // syl.attr('fill', '#ffc7c7');\n          // this.highlightBoundingBox(span);\n        });\n\n        span.addEventListener('mouseleave', () => {\n          syllable.classList.remove('selected');\n          syllable.querySelectorAll('.neume').forEach(neume => {\n            neume.classList.remove('selected');\n          });\n          if (rect !== null) {\n            if (syllable.style.fill !== 'rgb(0, 0, 0)') { // syllable.getAttributeNS('http://www.w3.org/2000/SVG', 'fill');\n              rect.style.fill = syllable.getAttribute('fill');\n            } else {\n              rect.style.fill = 'blue';\n            }\n          }\n          // syl.attr('fill', null);\n          // this.removeBoundingBox(span);\n        });\n      });\n      if (this.neonView.getUserMode() !== 'viewer' && this.neonView.TextEdit !== undefined) {\n        this.neonView.TextEdit.initTextEdit();\n      }\n    } else {\n      document.getElementById('syl_text').style.display = 'none';\n    }\n  }\n\n  /**\n   * Get the syllable text of the loaded file\n   */\n  getSylText (): string {\n    let lyrics = '';\n    const uniToDash = /\\ue551/g;\n    const syllables = document.querySelectorAll('.active-page .syllable');\n    syllables.forEach(syllable => {\n      if (syllable.querySelector('.syl') !== null) {\n        const syl = syllable.querySelector('.syl');\n        lyrics += '<span class=\\'' + syllable.id + '\\'>';\n        if (syl.textContent.trim() === '') {\n          lyrics += '&#x25CA; ';\n        } else {\n          Array.from(syl.children[0].children[0].children).forEach(text => {\n            lyrics += text.textContent !== '' ? text.textContent : '&#x25CA; ';\n          });\n        }\n        lyrics += ' </span>';\n      }\n    });\n    if (!this.notificationSent) {\n      Notification.queueNotification('Blank syllables are represented by &#x25CA;!');\n      this.notificationSent = true;\n    }\n    return lyrics.replace(uniToDash, '-');\n  }\n}\n\nexport { TextView as default };\n","import { unselect } from './utils/SelectTools';\nimport DragHandler from './utils/DragHandler';\nimport NeonView from './NeonView';\nimport { setSelectHelperObjects, dragSelect, clickSelect } from './utils/Select';\nimport { setGroupingHighlight } from './utils/Color';\nimport { TextEditInterface } from './Interfaces';\n\n/**\n * Format a string for prompting the user.\n * @param rawString - The unformatted string.\n */\nfunction formatRaw (rawString: string): string {\n  const removeSymbol = /\\u{25CA}/u;\n  return rawString.replace(removeSymbol, '').trim();\n}\n\nfunction selBySylListener (): void {\n  if (!document.getElementById('selByBBox').classList.contains('is-active')) {\n    unselect();\n    try {\n      document.getElementById('moreEdit').innerHTML = '';\n      document.getElementById('extraEdit').innerHTML = '';\n      document.getElementById('extraEdit').classList.add('is-invisible');\n    } catch (e) {}\n    document.getElementById('selByBBox').classList.add('is-active');\n    try {\n      document.getElementById('selByNc').classList.remove('is-active');\n      document.getElementById('selByNeume').classList.remove('is-active');\n      document.getElementById('selByStaff').classList.remove('is-active');\n      document.getElementById('selBySyl').classList.remove('is-active');\n    } catch (e) {}\n    try {\n      if (document.querySelector('.highlight-selected').id === 'highlight-selection') {\n        setGroupingHighlight('syllable');\n      }\n    } catch (e) {}\n  }\n  this.addBBoxListeners();\n}\n\n/**\n * A Text editing module that works with the SingleView and DivaView modules\n */\nexport default class TextEditMode implements TextEditInterface {\n  private dragHandler: DragHandler;\n  private neonView: NeonView;\n\n  /**\n   * Constructor for a TextEdit\n   * @param neonView - The calling [[NeonView]] for the instance.\n   */\n  constructor (neonView: NeonView) {\n    this.neonView = neonView;\n    this.initEditModeControls();\n  }\n\n  /**\n   * Set listener on edit mode button to start editing.\n   */\n  initEditModeControls (): void {\n    document.getElementById('edit_mode').addEventListener('click', () => {\n      this.initTextEdit();\n      if ((document.getElementById('displayBBox') as HTMLInputElement).checked) {\n        this.initSelectByBBoxButton();\n      }\n    });\n  }\n\n  /**\n  * Set text to edit mode\n  */\n  initTextEdit (): void {\n    const spans = document.getElementById('syl_text').querySelectorAll('p > span');\n    spans.forEach(span => {\n      function updateSylText (): void {\n        this.updateSylText(span);\n      }\n\n      span.removeEventListener('click', updateSylText.bind(this));\n      span.addEventListener('click', updateSylText.bind(this));\n    });\n  }\n\n  /**\n  * Add the selectByBBox button.\n  * If neume edit mode is there, add it to the bar with the other select by buttons.\n  * Otherwise add an invisible button\n  * since the only edit mode is selectByRect in that case\n  */\n  initSelectByBBoxButton (): void {\n    if (this.neonView.NeumeEdit !== undefined) {\n      const selByBBox = document.getElementById('selByBBox');\n      if (selByBBox) {\n        selByBBox.style.display = '';\n        return;\n      }\n\n      const block = document.getElementById('selBySyl')\n        .closest('.control')\n        .closest('.field');\n      const p = document.createElement('p');\n      p.classList.add('control');\n      const button = document.createElement('button');\n      button.classList.add('button', 'sel-by');\n      button.id = 'selByBBox';\n      button.textContent = 'BBox';\n      p.appendChild(button);\n      block.appendChild(p);\n      button.addEventListener('click', selBySylListener.bind(this));\n      document.body.addEventListener('keydown', (evt) => {\n        if (evt.key === '5') {\n          if (document.getElementById('selByBBox').style.display === '') {\n            selBySylListener.bind(this)();\n          }\n        }\n      });\n      this.neonView.view.addUpdateCallback(this.addBBoxListeners.bind(this));\n    } else {\n      const block = document.getElementById('undo').closest('.control');\n      const p = document.createElement('p');\n      p.classList.add('control');\n      const button = document.createElement('button');\n      button.classList.add('button', 'sel-by');\n      button.id = 'selByBBox';\n      button.textContent = 'BBox';\n      p.appendChild(button);\n      block.appendChild(p);\n      button.classList.add('is-active');\n      button.style.display = 'none';\n      this.addBBoxListeners();\n      this.neonView.view.addUpdateCallback(this.addBBoxListeners.bind(this));\n    }\n  }\n\n  /**\n   * Initialize select by bbox mode\n   */\n  addBBoxListeners (): void {\n    if (document.getElementById('selByBBox').classList.contains('is-active')) {\n      unselect();\n      if (this.neonView.NeumeEdit === undefined) {\n        // just in case\n        this.dragHandler = new DragHandler(this.neonView, '.sylTextRect-display');\n        setSelectHelperObjects(this.neonView, this.dragHandler);\n        if (this.neonView.view.constructor.name === 'SingleView') {\n          clickSelect('#mei_output, #mei_output rect');\n          dragSelect('#svg_group');\n        } else {\n          clickSelect('.active-page > svg > svg, .active-page > svg > svg rect');\n          dragSelect('.active-page svg');\n        }\n      }\n    }\n  }\n\n  /**\n  * Update the text for a single syl element\n  */\n  updateSylText (span: HTMLSpanElement): void {\n    const orig = formatRaw(span.textContent);\n    const corrected = window.prompt('', orig);\n    if (corrected !== null && corrected !== orig) {\n      const editorAction = {\n        'action': 'setText',\n        'param': {\n          'elementId': [...span.classList.entries()].filter(e => e[1] !== 'text-select')[0][1],\n          'text': corrected\n        }\n      };\n      this.neonView.edit(editorAction, this.neonView.view.getCurrentPageURI()).then((response) => {\n        if (response) {\n          this.neonView.updateForCurrentPage();\n        }\n      });\n    }\n  }\n}\n","import { uuidv4 } from './random';\n\nexport function zip<T> (array1: Array<T>, array2: Array<T>): Array<T> {\n  const result = [];\n  for (let i = 0; i < (array1.length > array2.length ? array2.length : array1.length); i++) {\n    result.push([array1[i], array2[i]]);\n  }\n  return result;\n}\n\nfunction copyAttributes(src: Element, dst: Element): void {\n  for (const attr of src.attributes) {\n    dst.setAttribute(attr.name, attr.value);\n  }\n}\n\nexport function convertStaffToSb(staffBasedMei: string): string {\n  const parser = new DOMParser();\n  const serializer = new XMLSerializer();\n  const meiDoc = parser.parseFromString(staffBasedMei, 'text/xml');\n  const mei = meiDoc.documentElement;\n\n  const precedesSyllables: Set<Element> = new Set();\n\n  for (const section of mei.getElementsByTagName('section')) {\n    const newStaff = meiDoc.createElementNS('http://www.music-encoding.org/ns/mei', 'staff');\n    const newLayer = meiDoc.createElementNS('http://www.music-encoding.org/ns/mei', 'layer');\n    newStaff.setAttribute('n', '1');\n    newLayer.setAttribute('n', '1');\n    newStaff.appendChild(newLayer);\n\n    const staves = Array.from(section.getElementsByTagName('staff'));\n\n    for (const staff of staves) {\n      const layer = staff.getElementsByTagName('layer')[0];\n\n      const sb = meiDoc.createElementNS('http://www.music-encoding.org/ns/mei', 'sb');\n      sb.setAttribute('n', staff.getAttribute('n'));\n      sb.setAttribute('facs', staff.getAttribute('facs'));\n      sb.setAttribute('xml:id', staff.getAttribute('xml:id'));\n\n      // Handle custos\n      let custos: Element = undefined;\n      if ((newLayer.lastElementChild !== null) &&\n        (newLayer.lastElementChild.tagName === 'custos')) {\n        custos = newLayer.removeChild(newLayer.lastElementChild);\n      }\n\n      // Insert sb either as last child of layer or in the last syllable\n      const lastElement = newLayer.lastElementChild;\n      if ((lastElement !== null) && (lastElement.tagName === 'syllable') && lastElement.hasAttribute('precedes')) {\n        if (custos !== undefined) lastElement.appendChild(custos);\n        lastElement.appendChild(sb);\n      }\n      else {\n        if (custos !== undefined) newLayer.appendChild(custos);\n        newLayer.appendChild(sb);\n      }\n\n      // Handle split syllables\n      for (const precedes of precedesSyllables) {\n        const followsId = precedes.getAttribute('precedes');\n        const followsSyllable = Array.from(layer.getElementsByTagName('syllable'))\n          .filter(syllable => { return '#' + syllable.getAttribute('xml:id') === followsId; })\n          .pop();\n        if (followsSyllable !== undefined) {\n          // Check for preceeding clef\n          if ((followsSyllable.previousElementSibling !== null) &&\n          (followsSyllable.previousElementSibling.tagName === 'clef')) {\n            precedes.append(followsSyllable.previousElementSibling);\n          }\n          while (followsSyllable.firstChild !== null) {\n            precedes.append(followsSyllable.firstChild);\n          }\n          followsSyllable.remove();\n          precedes.removeAttribute('precedes');\n          precedesSyllables.delete(precedes);\n        }\n      }\n\n      // Add remaining elements of layer to newLayer\n      while (layer.firstElementChild !== null) {\n        if (layer.firstElementChild.hasAttribute('precedes')) {\n          precedesSyllables.add(layer.firstElementChild);\n        }\n        newLayer.appendChild(layer.firstElementChild);\n      }\n      staff.remove();\n    }\n    section.appendChild(newStaff);\n  }\n\n  return serializer.serializeToString(meiDoc);\n}\n\nexport function convertSbToStaff(sbBasedMei: string): string {\n  const parser = new DOMParser();\n  const meiDoc = parser.parseFromString(sbBasedMei, 'text/xml');\n  const mei = meiDoc.documentElement;\n\n  // Go section by section just in case\n  for (const section of mei.getElementsByTagName('section')) {\n    // In case there are multiple staves here we want to preserve those\n    // A separate array is necessary as the HTMLCollection will update!\n    const originalStaves = Array.from(section.getElementsByTagName('staff'));\n    for (const staff of originalStaves) {\n      const layer = staff.getElementsByTagName('layer')[0];\n      // First pass: get all sb elements as direct children of layer\n      for (const sb of layer.getElementsByTagName('sb')) {\n        if (sb.parentElement.tagName !== 'layer') {\n          const origSyllable: Element = sb.parentElement;\n          if (origSyllable.firstChild.isEqualNode(sb)) {\n            layer.insertBefore(sb, origSyllable);\n          }\n          else if (origSyllable.lastChild.isEqualNode(sb)) {\n            origSyllable.insertAdjacentElement('afterend', sb);\n          }\n          else {\n            // We need to split the syllable here\n            const newSyllable = meiDoc.createElementNS('http://www.music-encoding.org/ns/mei', 'syllable');\n            newSyllable.setAttribute('xml:id', 'm-' + uuidv4());\n            newSyllable.setAttribute('follows', '#' + origSyllable.getAttribute('xml:id'));\n            origSyllable.setAttribute('precedes', '#' + newSyllable.getAttribute('xml:id'));\n\n            const childArray = Array.from(origSyllable.children);\n            const sbIndex = childArray.indexOf(sb);\n            for (const child of origSyllable.children) {\n              const index = childArray.indexOf(child);\n              if (index > sbIndex) {\n                newSyllable.appendChild(child);\n              }\n            }\n\n            origSyllable.insertAdjacentElement('afterend', sb);\n            sb.insertAdjacentElement('afterend', newSyllable);\n\n            // Move any custos in origSyllable out of it\n            for (const custos of origSyllable.getElementsByTagName('custos')) {\n              origSyllable.insertAdjacentElement('afterend', custos);\n            }\n\n            // Move any clef in newSyllable out of it\n            for (const clef of newSyllable.getElementsByTagName('clef')) {\n              newSyllable.insertAdjacentElement('beforebegin', clef);\n            }\n          }\n        }\n      }\n\n      const sbInfo: Array<string> = [];\n      for (const sb of layer.getElementsByTagName('sb')) {\n        sbInfo.push(sb.getAttribute('xml:id'));\n      }\n\n      for (let i = 0; i < sbInfo.length; i++) {\n        const currentSb = Array.from(layer.getElementsByTagName('sb'))\n          .filter(el => { return el.getAttribute('xml:id') === sbInfo[i]; })[0];\n        const nextSb = (i === sbInfo.length - 1) ? undefined :\n          Array.from(layer.getElementsByTagName('sb')).filter(el => {\n            return el.getAttribute('xml:id') === sbInfo[i + 1];\n          })[0];\n\n        const newStaff = meiDoc.createElementNS('http://www.music-encoding.org/ns/mei', 'staff');\n        copyAttributes(currentSb, newStaff);\n        const newLayer = meiDoc.createElementNS('http://www.music-encoding.org/ns/mei', 'layer');\n        newLayer.setAttribute('n', '1');\n        newLayer.setAttribute('xml:id', 'm-' + uuidv4());\n        newStaff.appendChild(newLayer);\n\n        const childrenArray = Array.from(layer.children);\n        const copyArray = childrenArray.slice(childrenArray.indexOf(currentSb) + 1, childrenArray.indexOf(nextSb));\n\n        for (const child of copyArray) {\n          newLayer.appendChild(child);\n        }\n\n        section.insertBefore(newStaff, staff);\n      }\n      staff.remove();\n    }\n  }\n  const serializer = new XMLSerializer();\n  return serializer.serializeToString(meiDoc);\n}\n","// Unique ID creation requires a high quality random # generator.  In the\n// browser this is a little complicated due to unknown quality of Math.random()\n// and inconsistent support for the `crypto` API.  We do the best we can via\n// feature-detection\n\n// getRandomValues needs to be invoked in a context where \"this\" is a Crypto implementation.\nvar getRandomValues = (typeof(crypto) != 'undefined' && crypto.getRandomValues.bind(crypto)) ||\n                      (typeof(msCrypto) != 'undefined' && msCrypto.getRandomValues.bind(msCrypto));\nif (getRandomValues) {\n  // WHATWG crypto RNG - http://wiki.whatwg.org/wiki/Crypto\n  var rnds8 = new Uint8Array(16); // eslint-disable-line no-undef\n\n  module.exports = function whatwgRNG() {\n    getRandomValues(rnds8);\n    return rnds8;\n  };\n} else {\n  // Math.random()-based (RNG)\n  //\n  // If all else fails, use Math.random().  It's fast, but is of unspecified\n  // quality.\n  var rnds = new Array(16);\n\n  module.exports = function mathRNG() {\n    for (var i = 0, r; i < 16; i++) {\n      if ((i & 0x03) === 0) r = Math.random() * 0x100000000;\n      rnds[i] = r >>> ((i & 0x03) << 3) & 0xff;\n    }\n\n    return rnds;\n  };\n}\n","/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\nvar byteToHex = [];\nfor (var i = 0; i < 256; ++i) {\n  byteToHex[i] = (i + 0x100).toString(16).substr(1);\n}\n\nfunction bytesToUuid(buf, offset) {\n  var i = offset || 0;\n  var bth = byteToHex;\n  return bth[buf[i++]] + bth[buf[i++]] +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] + '-' +\n          bth[buf[i++]] + bth[buf[i++]] +\n          bth[buf[i++]] + bth[buf[i++]] +\n          bth[buf[i++]] + bth[buf[i++]];\n}\n\nmodule.exports = bytesToUuid;\n","/** @module SquareEdit/Controls */\n\nimport * as Contents from './Contents';\nimport { setGroupingHighlight } from '../utils/Color';\nimport { unselect } from '../utils/SelectTools';\nimport InsertHandler from './InsertHandler';\nimport { NeumeEditInterface } from '../Interfaces';\n\n/**\n * Set listener on EditMode button.\n */\nexport function initEditModeControls (editMode: NeumeEditInterface) {\n  document.getElementById('edit_mode').addEventListener('click', function () {\n    document.getElementById('insert_controls').innerHTML += Contents.insertControlsPanel;\n    document.getElementById('edit_controls').innerHTML += Contents.editControlsPanel;\n    editMode.initEditMode();\n  });\n}\n\n/**\n * Bind listeners to insert tabs.'\n */\nexport function bindInsertTabs (insertHandler: InsertHandler) {\n  const insertTabs: Element[] = Array.from(document.getElementsByClassName('insertTab'));\n  const tabIds: string[] = insertTabs.map((tab) => { return tab.id; });\n\n  document.body.addEventListener('keydown', (evt: KeyboardEvent) => {\n    if (evt.code.match(/^Digit\\d$/) && evt.shiftKey) {\n      try {\n        const index = Number(evt.code[evt.code.length - 1]) - 1;\n        const insertOptions = document.getElementsByClassName('insertel');\n        const selectedOption = insertOptions[index];\n        deactivate('.insertel');\n        insertHandler.insertDisabled();\n        activate(selectedOption.id, insertHandler);\n      } catch (e) {\n        console.debug(e);\n      }\n    }\n  });\n\n  tabIds.forEach((tab) => {\n    document.getElementById(tab).addEventListener('click', () => {\n      deactivate('.insertTab');\n      activate(tab, insertHandler);\n      document.getElementById('insert_data').innerHTML = Contents.insertTabHtml[tab];\n      bindElements(insertHandler);\n      deactivate('.insertel');\n      const firstOption = document.getElementsByClassName('insertel')[0];\n      activate(firstOption.id, insertHandler);\n    });\n  });\n}\n\n/**\n * Initialize Edit and Insert control panels.\n */\nexport function initInsertEditControls () {\n  const toggleInsert = document.getElementById('toggleInsert');\n  const toggleEdit = document.getElementById('toggleEdit');\n  const insertContents = document.getElementById('insertContents');\n  const editContents = document.getElementById('editContents');\n  toggleInsert.parentElement.addEventListener('click', () => {\n    if (insertContents.style.display === 'none') {\n      insertContents.style.display = '';\n      toggleInsert.setAttribute('xlink:href', __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down');\n    } else {\n      insertContents.style.display = 'none';\n      toggleInsert.setAttribute('xlink:href', __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-side');\n    }\n  });\n\n  toggleEdit.parentElement.addEventListener('click', () => {\n    if (editContents.style.display === 'none') {\n      editContents.style.display = '';\n      toggleEdit.setAttribute('xlink:href', __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-down');\n    } else {\n      editContents.style.display = 'none';\n      toggleEdit.setAttribute('xlink:href', __ASSET_PREFIX__ + 'assets/img/icons.svg' + '#dropdown-side');\n    }\n  });\n}\n\n/**\n * Activate a certain insert action.\n * @param id - The ID of the insert action tab.\n */\nfunction activate (id: string, insertHandler: InsertHandler) {\n  document.getElementById(id).classList.add('is-active');\n  if (document.getElementById(id).classList.contains('insertel')) {\n    insertHandler.insertActive(id);\n  }\n}\n\n/**\n * Deactivate a certain insert action.\n * @param type - A CSS selector for the action tab.\n */\nfunction deactivate (type: string) {\n  const elList = document.querySelectorAll(type);\n  elList.forEach(el => {\n    el.classList.remove('is-active');\n  });\n}\n\n/**\n * Bind listeners to insert tab elements.\n */\nfunction bindElements (insertHandler: InsertHandler) {\n  const insertElements = Array.from(document.getElementsByClassName('insertel'));\n  const elementIds = insertElements.map(el => el.id);\n  elementIds.forEach(el => {\n    document.getElementById(el).addEventListener('click', () => {\n      deactivate('.insertel');\n      activate(el, insertHandler);\n    });\n  });\n}\n\n/**\n * Set listeners on the buttons to change selection modes.\n */\nexport function initSelectionButtons () {\n  const selBySyl = document.getElementById('selBySyl');\n  const selByNeume = document.getElementById('selByNeume');\n  const selByNc = document.getElementById('selByNc');\n  const selByStaff = document.getElementById('selByStaff');\n\n  selBySyl.addEventListener('click', selectBySylHandler);\n  document.body.addEventListener('keydown', (evt) => {\n    if (evt.key === '1') {\n      selectBySylHandler();\n    }\n  });\n\n  selByNeume.addEventListener('click', selectByNeumeHandler);\n  document.body.addEventListener('keydown', (evt) => {\n    if (evt.key === '2') {\n      selectByNeumeHandler();\n    }\n  });\n\n  selByNc.addEventListener('click', selectByNcHandler);\n  document.body.addEventListener('keydown', (evt) => {\n    if (evt.key === '3') {\n      selectByNcHandler();\n    }\n  });\n\n  selByStaff.addEventListener('click', selectByStaffHandler);\n  document.body.addEventListener('keydown', (evt) => {\n    if (evt.key === '4') {\n      selectByStaffHandler();\n    }\n  });\n\n  function selectBySylHandler () {\n    if (!selBySyl.classList.contains('is-active')) {\n      unselect();\n      document.getElementById('moreEdit').innerHTML = '';\n      document.getElementById('extraEdit').innerHTML = '';\n      document.getElementById('extraEdit').classList.add('is-invisible');\n      selBySyl.classList.add('is-active');\n      selByNeume.classList.remove('is-active');\n      selByNc.classList.remove('is-active');\n      selByStaff.classList.remove('is-active');\n      try {\n        document.getElementById('selByBBox').classList.remove('is-active');\n      } catch (e) {}\n      try {\n        if (document.querySelector('.highlight-selected').id === 'highlight-selection') {\n          setGroupingHighlight('syllable');\n        }\n      } catch (e) {}\n    }\n  }\n\n  function selectByNeumeHandler () {\n    if (!selByNeume.classList.contains('is-active')) {\n      unselect();\n      document.getElementById('moreEdit').innerHTML = '';\n      document.getElementById('extraEdit').innerHTML = '';\n      document.getElementById('extraEdit').classList.add('is-invisible');\n      selByNeume.classList.add('is-active');\n      selByNc.classList.remove('is-active');\n      selBySyl.classList.remove('is-active');\n      selByStaff.classList.remove('is-active');\n      try {\n        document.getElementById('selByBBox').classList.remove('is-active');\n      } catch (e) {}\n      try {\n        if (document.querySelector('.highlight-selected').id === 'highlight-selection') {\n          setGroupingHighlight('neume');\n        }\n      } catch (e) {}\n    }\n  }\n\n  function selectByNcHandler () {\n    if (!selByNc.classList.contains('is-active')) {\n      unselect();\n      document.getElementById('moreEdit').innerHTML = '';\n      document.getElementById('extraEdit').innerHTML = '';\n      document.getElementById('extraEdit').classList.add('is-invisible');\n      selByNc.classList.add('is-active');\n      selByNeume.classList.remove('is-active');\n      selBySyl.classList.remove('is-active');\n      selByStaff.classList.remove('is-active');\n      try {\n        document.getElementById('selByBBox').classList.remove('is-active');\n      } catch (e) {}\n      try {\n        if (document.querySelector('.highlight-selected').id === 'highlight-selection') {\n          setGroupingHighlight('neume');\n        }\n      } catch (e) {}\n    }\n  }\n\n  function selectByStaffHandler () {\n    if (!selByStaff.classList.contains('is-active')) {\n      unselect();\n      document.getElementById('moreEdit').innerHTML = '';\n      document.getElementById('extraEdit').innerHTML = '';\n      document.getElementById('extraEdit').classList.add('is-invisible');\n      selByStaff.classList.add('is-active');\n      selByNeume.classList.remove('is-active');\n      selByNc.classList.remove('is-active');\n      selBySyl.classList.remove('is-active');\n      try {\n        document.getElementById('selByBBox').classList.remove('is-active');\n      } catch (e) {}\n      try {\n        if (document.querySelector('.highlight-selected').id === 'highlight-selection') {\n          setGroupingHighlight('staff');\n        }\n      } catch (e) {}\n    }\n  }\n}\n","import * as Contents from './Contents';\nimport * as Warnings from '../Warnings';\nimport * as Notification from '../utils/Notification';\nimport NeonView from '../NeonView';\nimport { EditorAction } from '../Types';\nimport { unsetVirgaAction, unsetInclinatumAction, removeHandler, deleteButtonHandler } from './SelectOptions';\n\n/**\n * The NeonView parent to access editor actions.\n */\nlet neonView: NeonView;\n\n/**\n * Set the neonView member.\n * @param {NeonView} view\n */\nexport function initNeonView (view: NeonView): void {\n  neonView = view;\n}\n\n/**\n * Trigger the grouping selection menu.\n * @param {string} type - The grouping type: nc, neume, syl, ligatureNc, or ligature\n */\nexport function triggerGrouping (type: string): void {\n  const moreEdit = document.getElementById('moreEdit');\n  moreEdit.classList.remove('is-invisible');\n  moreEdit.innerHTML += Contents.groupingMenu[type];\n  initGroupingListeners();\n}\n\n/**\n * Remove the grouping selection menu.\n */\nexport function endGroupingSelection (): void {\n  const moreEdit = document.getElementById('moreEdit');\n  moreEdit.innerHTML = '';\n  moreEdit.classList.add('is-invisible');\n  document.body.removeEventListener('keydown', deleteButtonHandler);\n}\n\n/**\n * The grouping dropdown listener.\n */\nexport function initGroupingListeners (): void {\n  const del = document.getElementById('delete');\n  del.removeEventListener('click', removeHandler);\n  del.addEventListener('click', removeHandler);\n  document.body.addEventListener('keydown', deleteButtonHandler);\n  try {\n    document.getElementById('mergeSyls').addEventListener('click', () => {\n      const elementIds = getChildrenIds().filter(e =>\n        document.getElementById(e).classList.contains('neume')\n      );\n      groupingAction('group', 'neume', elementIds);\n    });\n  } catch (e) {}\n\n  try {\n    document.getElementById('groupNeumes').addEventListener('click', () => {\n      const elementIds = getIds();\n      groupingAction('group', 'neume', elementIds);\n    });\n  } catch (e) {}\n\n  try {\n    document.getElementById('groupNcs').addEventListener('click', () => {\n      const elementIds = getIds();\n      groupingAction('group', 'nc', elementIds);\n    });\n  } catch (e) {}\n\n  try {\n    document.getElementById('ungroupNeumes').addEventListener('click', () => {\n      const elementIds = getChildrenIds();\n      groupingAction('ungroup', 'neume', elementIds);\n    });\n  } catch (e) {}\n\n  try {\n    document.getElementById('ungroupNcs').addEventListener('click', () => {\n      const elementIds = getChildrenIds();\n      groupingAction('ungroup', 'nc', elementIds);\n    });\n  } catch (e) {}\n\n  try {\n    document.getElementById('toggle-ligature').addEventListener('click', async () => {\n      const elementIds = getIds();\n      let isLigature;\n      const ligatureRegex = /#E99[016]/;\n      if (!ligatureRegex.test(document.getElementById(elementIds[0]).children[0].getAttribute('xlink:href'))) { // SMUFL codes for ligature glyphs\n        isLigature = true;\n      } else {\n        isLigature = false;\n        const chainAction: EditorAction = { 'action': 'chain',\n          'param': [\n            unsetInclinatumAction(elementIds[0]), unsetVirgaAction(elementIds[0]),\n            unsetInclinatumAction(elementIds[1]), unsetVirgaAction(elementIds[1])\n          ] };\n        await neonView.edit(chainAction, neonView.view.getCurrentPageURI());\n      }\n\n      const editorAction: EditorAction = {\n        'action': 'toggleLigature',\n        'param': {\n          'elementIds': elementIds,\n          'isLigature': isLigature.toString()\n        }\n      };\n      neonView.edit(editorAction, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Ligature Toggled');\n        } else {\n          Notification.queueNotification('Ligature Toggle Failed');\n        }\n        endGroupingSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n  } catch (e) {}\n\n  try {\n    document.getElementById('toggle-link').addEventListener('click', () => {\n      const elementIds = getIds();\n      const chainAction: EditorAction = {\n        'action': 'chain',\n        'param': []\n      };\n      const param = new Array<EditorAction>();\n      if (document.getElementById(elementIds[0]).getAttribute('mei:precedes')) {\n        param.push({\n          'action': 'set',\n          'param': {\n            'elementId': elementIds[0],\n            'attrType': 'precedes',\n            'attrValue': ''\n          }\n        });\n        param.push({\n          'action': 'set',\n          'param': {\n            'elementId': elementIds[1],\n            'attrType': 'follows',\n            'attrValue': ''\n          }\n        });\n        param.push({\n          'action': 'setText',\n          'param': {\n            'elementId': elementIds[1],\n            'text': ''\n          }\n        });\n      } else if (document.getElementById(elementIds[0]).getAttribute('mei:follows')) {\n        param.push({\n          'action': 'set',\n          'param': {\n            'elementId': elementIds[0],\n            'attrType': 'follows',\n            'attrValue': ''\n          }\n        });\n        param.push({\n          'action': 'set',\n          'param': {\n            'elementId': elementIds[1],\n            'attrType': 'precedes',\n            'attrValue': ''\n          }\n        });\n        param.push({\n          'action': 'setText',\n          'param': {\n            'elementId': elementIds[0],\n            'text': ''\n          }\n        });\n      } else {\n        // Associate syllables. Will need to find which is first. Use staves.\n        const syllable0 = document.getElementById(elementIds[0]);\n        const syllable1 = document.getElementById(elementIds[1]);\n        const staff0 = syllable0.closest('.staff');\n        const staff1 = syllable1.closest('.staff');\n        const staffChildren = Array.from(staff0.parentElement.children).filter((elem: HTMLElement) => elem.classList.contains('staff'));\n\n        let firstSyllable, secondSyllable;\n        // Determine first syllable comes first by staff\n        if (staffChildren.indexOf(staff0) < staffChildren.indexOf(staff1)) {\n          firstSyllable = syllable0;\n          secondSyllable = syllable1;\n        } else {\n          firstSyllable = syllable1;\n          secondSyllable = syllable0;\n        }\n\n        param.push({\n          'action': 'set',\n          'param': {\n            'elementId': firstSyllable.id,\n            'attrType': 'precedes',\n            'attrValue': '#' + secondSyllable.id\n          }\n        });\n        param.push({\n          'action': 'set',\n          'param': {\n            'elementId': secondSyllable.id,\n            'attrType': 'follows',\n            'attrValue': '#' + firstSyllable.id\n          }\n        });\n        // Delete syl on second syllable\n        const syl = secondSyllable.querySelector('.syl');\n        if (syl !== null) {\n          param.push({\n            'action': 'remove',\n            'param': {\n              'elementId': syl.id\n            }\n          });\n        }\n      }\n      chainAction.param = param;\n      neonView.edit(chainAction, neonView.view.getCurrentPageURI()).then((result) => {\n        if (result) {\n          Notification.queueNotification('Toggled Syllable Link');\n        } else {\n          Notification.queueNotification('Failed to Toggle Syllable Link');\n        }\n        endGroupingSelection();\n        neonView.updateForCurrentPage();\n      });\n    });\n  } catch (e) {}\n}\n\n/**\n * Form and execute a group/ungroup action.\n * @param action - The action to execute. Either \"group\" or \"ungroup\".\n * @param groupType - The type of elements to group. Either \"neume\" or \"nc\".\n * @param elementIds - The IDs of the elements.\n */\nfunction groupingAction (action: string, groupType: string, elementIds: string[]): void {\n  const editorAction: EditorAction = {\n    'action': action,\n    'param': {\n      'groupType': groupType,\n      'elementIds': elementIds\n    }\n  };\n  neonView.edit(editorAction, neonView.view.getCurrentPageURI()).then((result) => {\n    if (result) {\n      if (action === 'group') {\n        Notification.queueNotification('Grouping Success');\n      } else {\n        Notification.queueNotification('Ungrouping Success');\n      }\n    } else {\n      if (action === 'group') {\n        Notification.queueNotification('Grouping Failed');\n      } else {\n        Notification.queueNotification('Ungrouping Failed');\n      }\n    }\n    neonView.updateForCurrentPage();\n\n    // Prompt user to confirm if Neon does not re cognize contour\n    if (groupType === 'nc') {\n      const neumeParent = document.getElementById(elementIds[0]).parentElement;\n      const ncs = Array.from(neumeParent.children) as SVGGraphicsElement[];\n      const contour = neonView.info.getContour(ncs);\n      if (contour === undefined) {\n        Warnings.groupingNotRecognized();\n      }\n    }\n    endGroupingSelection();\n  });\n}\n\n/**\n * Get the IDs of selected elements.\n */\nfunction getIds (): string[] {\n  const ids = [];\n  const elements = Array.from(document.getElementsByClassName('selected'));\n  elements.forEach(el => {\n    ids.push(el.id);\n  });\n  return ids;\n}\n\n/**\n * Get the IDs of the selected elements' children.\n */\nfunction getChildrenIds (): string[] {\n  const childrenIds = [];\n  const elements = Array.from(document.getElementsByClassName('selected'));\n  elements.forEach(el => {\n    const children = Array.from(el.children);\n    children.forEach(ch => {\n      childrenIds.push(ch.id);\n    });\n  });\n  return childrenIds;\n}\n","import { getStaffBBox, selectBBox, selectStaff } from './SelectTools';\nimport NeonView from '../NeonView';\nimport DragHandler from './DragHandler';\n\nimport * as d3 from 'd3';\n\n/**\n * Resize a staff or a syllable text bounding box.\n * For staves, this also supports adjusting the rotate.\n */\ntype Point = { x: number; y: number; name: number };\n\n/**\n * The points you can click and drag to resize\n */\nconst PointNames = {\n  TopLeft: 0,\n  Top: 1,\n  TopRight: 2,\n  Right: 3,\n  BottomRight: 4,\n  Bottom: 5,\n  BottomLeft: 6,\n  Left: 7\n};\n\nfunction GetPoints(ulx: number, uly: number, lrx: number, lry: number, rotate: number): Point[] {\n  // Note that arc functions return an angle x in [-pi/2, pi/2].\n  let points: Array<Point>;\n  // ul is ulx, uly, lr is lrx, lry\n  if (rotate >= 0) {\n    points = [\n      { x: ulx, y: uly, name: PointNames.TopLeft },\n      { x: (ulx + lrx) / 2, y: uly + (lrx - ulx) / 2 * Math.sin(rotate), name: PointNames.Top },\n      { x: lrx, y: uly + (lrx - ulx) * Math.sin(rotate), name: PointNames.TopRight },\n      { x: lrx, y: (uly + lry + (lrx - ulx) * Math.sin(rotate)) / 2, name: PointNames.Right },\n      { x: lrx, y: lry, name: PointNames.BottomRight },\n      { x: (ulx + lrx) / 2, y: lry - (lrx - ulx) / 2 * Math.sin(rotate), name: PointNames.Bottom },\n      { x: ulx, y: lry - (lrx - ulx) * Math.sin(rotate), name: PointNames.BottomLeft },\n      { x: ulx, y: (uly + lry - (lrx - ulx) * Math.sin(rotate)) / 2, name: PointNames.Left }\n    ];\n  }\n  // Not that\n  else {\n    const a = (lrx - ulx) * Math.tan(Math.abs(rotate));\n    const b = lry - uly - a;\n    points = [\n      { x: ulx, y: uly + a, name: PointNames.TopLeft },\n      { x: (ulx + lrx) / 2, y: uly + a / 2, name: PointNames.Top },\n      { x: lrx, y: uly, name: PointNames.TopRight },\n      { x: lrx, y: uly + b / 2, name: PointNames.Right },\n      { x: lrx, y: uly + b, name: PointNames.BottomRight },\n      { x: (ulx + lrx) / 2, y: lry - a / 2, name: PointNames.Bottom },\n      { x: ulx, y: lry, name: PointNames.BottomLeft },\n      { x: ulx, y: lry - b / 2, name: PointNames.Left }\n    ];\n  }\n  return points;\n}\n\nexport function resize (element: SVGGraphicsElement, neonView: NeonView, dragHandler: DragHandler): void {\n  /**\n   * The upper-left x-coordinate of the element.\n   */\n  let ulx: number;\n  /**\n   * The upper-left y-coordinate of the element.\n   */\n  let uly: number;\n  /**\n   * The lower-right x-coordinate of the element.\n   */\n  let lrx: number;\n  /**\n   * The lower-right y-coordinate of the element.\n   */\n  let lry: number;\n\n  /**\n   * The rotate of the rect in radians.\n   */\n  let rotate: number;\n\n  let initialPoint: number[], initialUly: number, initialLry: number, whichRotatePoint: string,\n    initialY: number, initialRectY: number, polyLen: number, dy: number, initialRotate: number;\n\n  drawInitialRect();\n  /**\n   * Draw the initial rectangle around the element\n   * and add the listeners to support dragging to resize.\n   */\n  function drawInitialRect (): void {\n    if (element === null) return;\n\n    // if it's a boundingbox just get the coordinates\n    if (element.classList.contains('syl')) {\n      const rect = element.querySelector('.sylTextRect-display');\n      if (rect === null) {\n        console.warn('Tried to draw resize rect for a sylTextRect that doesn\\'t exist (or isn\\'t displaying)');\n        return;\n      }\n      ulx = Number(rect.getAttribute('x'));\n      uly = Number(rect.getAttribute('y'));\n      lrx = +ulx + +rect.getAttribute('width');\n      lry = +uly + +rect.getAttribute('height');\n\n      rotate = 0;\n    }\n\n    // if it's a staff use the paths to get it's boundingbox\n    if (element.classList.contains('staff')) {\n      const bbox = getStaffBBox(element);\n      ulx = bbox.ulx;\n      uly = bbox.uly;\n      lrx = bbox.lrx;\n      lry = bbox.lry;\n\n      const coordinates: number[] = element.querySelector('path')\n        .getAttribute('d')\n        .match(/\\d+/g)\n        .map(element => Number(element));\n      rotate = Math.atan((coordinates[3] - coordinates[1]) /\n        (coordinates[2] - coordinates[0]));\n    }\n\n    let whichPoint: string;\n\n    const points = GetPoints(ulx, uly, lrx, lry, rotate);\n\n    polyLen = points[2].x - points[0].x;\n\n    const pointString = points.filter((_elem, index) => { return index % 2 === 0; })\n      .map(elem => elem.x + ',' + elem.y)\n      .join(' ');\n\n    d3.select('#' + element.id).append('polygon')\n      .attr('points', pointString)\n      .attr('id', 'resizeRect')\n      .attr('stroke', 'black')\n      .attr('stroke-width', 10)\n      .attr('fill', 'none')\n      .style('cursor', 'move')\n      .style('stroke-dasharray', '20 10');\n\n    for (const pointName in PointNames) {\n      const point: Point = points[PointNames[pointName]];\n      d3.select(element.viewportElement).append('circle')\n        .attr('cx', point.x)\n        .attr('cy', point.y)\n        .attr('r', 25)\n        .attr('stroke', 'black')\n        .attr('stroke-width', 4)\n        .attr('fill', '#0099ff')\n        .attr('class', 'resizePoint')\n        .attr('id', 'p-' + pointName);\n    }\n\n    // do it as a loop instead of selectAll so that you can easily know which point was\n    for (const name in PointNames) {\n      d3.select('#p-' + name).filter('.resizePoint').call(\n        d3.drag()\n          .on('start', () => { resizeStart(name); })\n          .on('drag', resizeDrag)\n          .on('end', resizeEnd.bind(this)));\n    }\n\n    if (element.classList.contains('staff')) {\n      let x = points[3].x;\n      let y = points[3].y;\n      const pointStringRight = (x + 100) + ',' + (y + 85) + ' ' +\n        (x + 70) + ',' + (y + 50) + ' ' + (x + 100) + ',' + (y + 15) + ' ' + (x + 130) + ',' + (y + 50);\n      x = points[7].x;\n      y = points[7].y;\n      const pointStringLeft = (x - 100) + ',' + (y - 15) + ' ' +\n        (x - 130) + ',' + (y - 50) + ' ' + (x - 100) + ',' + (y - 85) + ' ' + (x - 70) + ',' + (y - 50);\n\n      d3.select('#' + element.id).append('polygon')\n        .attr('points', pointStringRight)\n        .attr('id', 'rotateRight')\n        .attr('stroke', 'black')\n        .attr('stroke-width', 7)\n        .attr('fill', '#0099ff')\n        .attr('class', 'rotatePoint');\n\n      d3.select('#' + element.id).append('polygon')\n        .attr('points', pointStringLeft)\n        .attr('id', 'rotateLeft')\n        .attr('stroke', 'black')\n        .attr('stroke-width', 7)\n        .attr('fill', '#0099ff')\n        .attr('class', 'rotatePoint');\n\n      d3.select('#rotateLeft').call(\n        d3.drag()\n          .on('start', rotateStart)\n          .on('drag', rotateDragLeft)\n          .on('end', rotateEnd));\n\n      d3.select('#rotateRight').call(\n        d3.drag()\n          .on('start', rotateStart)\n          .on('drag', rotateDragRight)\n          .on('end', rotateEnd));\n    }\n\n    function rotateStart (): void {\n      let which = d3.event.sourceEvent.target.id;\n      const polygon = d3.select('#' + which);\n      const points = polygon.attr('points');\n      whichRotatePoint = which;\n      initialY = d3.mouse(this)[1];\n      initialLry = lry;\n      initialUly = uly;\n      initialRectY = (which === 'rotateRight' ? lry : uly);\n      initialRotate = rotate;\n    }\n\n    function rotateDragLeft (): void {\n      const currentY = d3.mouse(this)[1];\n      const temp = currentY - initialY;\n      const tempRotate = initialRotate - Math.atan(temp / polyLen);\n      if (tempRotate > -0.2 && tempRotate < 0.2) {\n        dy = temp;\n        uly = initialRectY + dy;\n        rotate = tempRotate;\n        if (rotate >= 0) {\n          uly = dy + points.filter(point => point.name === PointNames.TopLeft)[0].y;\n          lry = points.filter(point => point.name === PointNames.BottomRight)[0].y;\n        } else {\n          uly = points.filter(point => point.name === PointNames.TopRight)[0].y;\n          lry = dy + points.filter(point => point.name === PointNames.BottomLeft)[0].y;\n        }\n      }\n      redraw();\n    }\n\n    function rotateDragRight (): void {\n      const currentY = d3.mouse(this)[1];\n      const temp = currentY - initialY;\n      const tempRotate = initialRotate + Math.atan(temp / polyLen);\n      if (tempRotate > -0.2 && tempRotate < 0.2) {\n        dy = temp;\n        rotate = tempRotate;\n        if (rotate >= 0 ) {\n          lry = dy + points.filter(point => point.name === PointNames.BottomRight)[0].y;\n          uly = points.filter(point => point.name === PointNames.TopLeft)[0].y;\n        } else {\n          uly = dy + points.filter(point => point.name === PointNames.TopRight)[0].y;\n          lry = points.filter(point => point.name === PointNames.BottomLeft)[0].y;\n        }\n      }\n      redraw();\n    }\n\n    function rotateEnd (): void {\n      if (dy === undefined) {\n        dy = 0;\n      }\n      const editorAction = {\n        'action': 'resizeRotate',\n        'param': {\n          'elementId': element.id,\n          'ulx': ulx,\n          'uly': uly,\n          'lrx': lrx,\n          'lry': lry,\n          'rotate': rotate * 180 / Math.PI\n        }\n      };\n      neonView.edit(editorAction, neonView.view.getCurrentPageURI()).then(async (result) => {\n        if (result) {\n          await neonView.updateForCurrentPage();\n        }\n        element = document.getElementById(element.id) as unknown as SVGGraphicsElement;\n        ulx = undefined;\n        uly = undefined;\n        lrx = undefined;\n        lry = undefined;\n        dy = undefined;\n        drawInitialRect();\n        if (element.classList.contains('syl')) {\n          selectBBox(element.querySelector('.sylTextRect-display'), dragHandler, this);\n        } else {\n          selectStaff(element, dragHandler);\n        }\n      });\n    }\n\n    function resizeStart (name: string): void {\n      whichPoint = name;\n      const point = points.find(point => { return point.name === PointNames[name]; });\n      initialPoint = [point.x, point.y];\n      initialUly = uly;\n      initialLry = lry;\n    }\n\n    function resizeDrag (): void {\n      const currentPoint = d3.mouse(this);\n      switch (PointNames[whichPoint]) {\n        case PointNames.TopLeft:\n          ulx = currentPoint[0];\n          uly = currentPoint[1];\n          break;\n        case PointNames.Top:\n          uly = currentPoint[1] - (lrx - ulx) * Math.tan(rotate) / 2;\n          break;\n        case PointNames.TopRight:\n          lrx = currentPoint[0];\n          uly = currentPoint[1] - (lrx - ulx) * Math.tan(rotate);\n          break;\n        case PointNames.Right:\n          lrx = currentPoint[0];\n          lry = initialLry + (currentPoint[0] - initialPoint[0]) * Math.tan(rotate);\n          break;\n        case PointNames.BottomRight:\n          lrx = currentPoint[0];\n          lry = currentPoint[1];\n          break;\n        case PointNames.Bottom:\n          lry = currentPoint[1] + (lrx - ulx) * Math.tan(rotate) / 2;\n          break;\n        case PointNames.BottomLeft:\n          ulx = currentPoint[0];\n          lry = currentPoint[1] + (lrx - ulx) * Math.tan(rotate);\n          break;\n        case PointNames.Left:\n          ulx = currentPoint[0];\n          uly = initialUly + (currentPoint[0] - initialPoint[0]) * Math.tan(rotate);\n          break;\n        default:\n          console.error('Something that wasn\\'t a side of the rectangle was dragged. This shouldn\\'t happen.');\n      }\n      redraw();\n    }\n\n    function resizeEnd (): void {\n      const editorAction = {\n        'action': 'resize',\n        'param': {\n          'elementId': element.id,\n          'ulx': ulx,\n          'uly': uly,\n          'lrx': lrx,\n          'lry': lry\n        }\n      };\n      neonView.edit(editorAction, neonView.view.getCurrentPageURI()).then(async (result) => {\n        if (result) {\n          await neonView.updateForCurrentPage();\n        }\n        element = document.getElementById(element.id) as unknown as SVGGraphicsElement;\n        ulx = undefined;\n        uly = undefined;\n        lrx = undefined;\n        lry = undefined;\n        d3.selectAll('.resizePoint').remove();\n        d3.selectAll('#resizeRect').remove();\n        d3.selectAll('.rotatePoint').remove();\n        drawInitialRect();\n        if (element.classList.contains('syl')) {\n          selectBBox(element.querySelector('.sylTextRect-display'), dragHandler, this);\n        } else {\n          try {\n            document.getElementById('moreEdit').innerHTML = '';\n            document.getElementById('moreEdit').classList.add('is-invisible');\n          } catch (e) {}\n        }\n      });\n    }\n  }\n\n  /**\n   * Redraw the rectangle with the new bounds\n   */\n  function redraw (): void {\n    const points: Point[] = GetPoints(ulx, uly, lrx, lry, rotate);\n\n    const pointString: string = points.filter((_elem, index) => { return index % 2 === 0; })\n      .map(elem => elem.x + ',' + elem.y)\n      .join(' ');\n\n    d3.select('#resizeRect').attr('points', pointString);\n\n    for (const pointName in PointNames) {\n      const point: Point = points[PointNames[pointName]];\n      d3.select('#p-' + pointName).filter('.resizePoint')\n        .attr('cx', point.x)\n        .attr('cy', point.y);\n    }\n\n    let x = points[3].x;\n    let y = points[3].y;\n    const pointStringRight = (x + 100) + ',' + (y + 85) + ' ' +\n      (x + 70) + ',' + (y + 50) + ' ' + (x + 100) + ',' + (y + 15) + ' ' + (x + 130) + ',' + (y + 50);\n    x = points[7].x;\n    y = points[7].y;\n    const pointStringLeft = (x - 100) + ',' + (y - 15) + ' ' +\n      (x - 130) + ',' + (y - 50) + ' ' + (x - 100) + ',' + (y - 85) + ' ' + (x - 70) + ',' + (y - 50);\n\n    d3.select('#rotateLeft').attr('points', pointStringLeft);\n    d3.select('#rotateRight').attr('points', pointStringRight);\n  }\n}\n","import NeonView from '../NeonView';\nimport { EditorAction } from '../Types';\nimport * as d3 from 'd3';\n\n/**\n * Class that handles insert mode, events, and actions.\n */\nclass InsertHandler {\n  type: string;\n  firstClick = true;\n  coord: DOMPoint;\n  attributes: object;\n  selector: string;\n  neonView: NeonView;\n\n  constructor (neonView: NeonView, sel: string) {\n    this.neonView = neonView;\n    this.selector = sel;\n  }\n\n  /**\n   * Called when an insert button is clicked.\n   * Triggers the start of insert mode.\n   * @param buttonId - The ID of the button that was clicked.\n   */\n  insertActive (buttonId: string): void {\n    const alreadyInInsertMode = this.isInsertMode();\n    switch (buttonId) {\n      case 'punctum':\n        this.type = 'nc';\n        this.attributes = null;\n        break;\n      case 'diamond':\n        this.type = 'nc';\n        this.attributes = { 'tilt': 'se' };\n        break;\n      case 'virga':\n        this.type = 'nc';\n        this.attributes = { 'tilt': 'n' };\n        break;\n      case 'pes':\n      case 'clivis':\n      case 'scandicus':\n      case 'climacus':\n      case 'torculus':\n      case 'porrectus':\n      case 'pressus':\n        const contour = this.neonView.info.getContourByValue(\n          buttonId.charAt(0).toUpperCase() + buttonId.slice(1)\n        );\n        this.type = 'grouping';\n        this.attributes = { 'contour': contour };\n        break;\n      case 'cClef':\n      case 'fClef':\n        this.type = 'clef';\n        this.attributes = { 'shape': buttonId.charAt(0).toUpperCase() };\n        break;\n      case 'custos':\n        this.type = 'custos';\n        this.attributes = null;\n        break;\n      case 'staff':\n        this.type = 'staff';\n        this.attributes = null;\n        break;\n      default:\n        this.type = '';\n        this.attributes = null;\n        console.error('Invalid button for insertion: ' + buttonId + '.');\n        return;\n    }\n\n    this.removeInsertClickHandlers();\n    if (this.type === 'staff') {\n      document.querySelector(this.selector)\n        .addEventListener('click', this.staffHandler);\n    } else {\n      document.querySelector(this.selector)\n        .addEventListener('click', this.handler);\n    }\n\n    // Disable edit mode listeners\n    document.body.addEventListener('keydown', this.keydownListener);\n    document.body.addEventListener('keyup', this.resetInsertHandler);\n    document.body.addEventListener('click', this.clickawayHandler);\n\n    // Add 'return to edit mode' button\n    if (!alreadyInInsertMode) {\n      const editModeButton = document.createElement('button');\n      editModeButton.id = 'returnToEditMode';\n      editModeButton.classList.add('button');\n      editModeButton.innerHTML = 'Return to Edit Mode';\n      document.getElementById('redo').parentNode.appendChild(editModeButton);\n      editModeButton.addEventListener('click', this.insertDisabled);\n    }\n    const editMenu = document.getElementById('editMenu');\n    editMenu.style.backgroundColor = 'whitesmoke';\n    editMenu.style.fontWeight = '';\n    const insertMenu = document.getElementById('insertMenu');\n    insertMenu.style.backgroundColor = '#ffc7c7';\n    insertMenu.style.fontWeight = 'bold';\n  }\n\n  /**\n   * Disable insert mode and remove event listeners.\n   */\n  insertDisabled = (function insertDisabled (): void {\n    this.type = '';\n    this.removeInsertClickHandlers();\n    document.body.removeEventListener('keydown', this.keydownListener);\n    document.body.removeEventListener('keyup', this.resetInsertHandler);\n    document.body.removeEventListener('click', this.clickawayHandler);\n    const selected = document.querySelector('.insertel.is-active');\n    if (selected !== null) {\n      selected.classList.remove('is-active');\n    }\n    this.firstClick = true;\n    try {\n      document.getElementById('returnToEditMode').remove();\n    } catch (e) {\n      // console.debug(e);\n    }\n    const editMenu = document.getElementById('editMenu');\n    const insertMenu = document.getElementById('insertMenu');\n    editMenu.style.backgroundColor = '#ffc7c7';\n    editMenu.style.fontWeight = 'bold';\n    insertMenu.style.backgroundColor = 'whitesmoke';\n    insertMenu.style.fontWeight = '';\n  }).bind(this);\n\n  /**\n   * Event handler to handle a user clicking away from the active page\n   * causing insert mode to end.\n   */\n  clickawayHandler = (function clickawayHandler (evt: MouseEvent): void {\n    const target = evt.target as HTMLElement;\n    if (target.closest('.active-page') === null &&\n      target.closest('#insert_controls') === null &&\n      target.closest('#svg_group') === null) {\n      this.insertDisabled();\n      document.body.removeEventListener('keydown',\n        this.staffHandler);\n      document.body.removeEventListener('keydown',\n        this.handler);\n    }\n  }).bind(this);\n\n  /**\n   * Resets an insert event listener after temporarily removing it.\n   */\n  resetInsertHandler = (function resetInsertHandler (evt: KeyboardEvent): void {\n    if (evt.key === 'Shift') {\n      document.querySelector(this.selector)\n        .addEventListener('click', this.type === 'staff' ?\n          this.staffHandler : this.handler);\n    }\n  }).bind(this);\n\n  /**\n   * Listens to key presses to either exit edit mode (if Escape) or\n   * temporarily remove insert event listeners (if Shift).\n   */\n  keydownListener = (function keydownListener (evt: KeyboardEvent): void {\n    if (evt.key === 'Escape') {\n      this.insertDisabled();\n      document.body.removeEventListener('keydown', this.staffHandler);\n      document.body.removeEventListener('keydown', this.handler);\n    } else if (evt.key === 'Shift') {\n      this.removeInsertClickHandlers();\n    }\n  }).bind(this);\n\n  /**\n   * Event handler for clicking to insert any element except a staff.\n   */\n  handler = (function handler (evt: MouseEvent): void {\n    evt.stopPropagation();\n    const container = document.getElementsByClassName('active-page')[0].getElementsByClassName('definition-scale')[0] as SVGSVGElement;\n    const pt = container.createSVGPoint();\n    pt.x = evt.clientX;\n    pt.y = evt.clientY;\n    // Transform pt to SVG context\n    const transformMatrix = (container.getElementsByClassName('system')[0] as SVGGraphicsElement).getScreenCTM();\n    const cursorpt = pt.matrixTransform(transformMatrix.inverse());\n\n    const editorAction: EditorAction = {\n      'action': 'insert',\n      'param': {\n        'elementType': this.type,\n        'staffId': 'auto',\n        'ulx': cursorpt.x,\n        'uly': cursorpt.y\n      }\n    };\n\n    if (this.attributes !== null) {\n      editorAction['param']['attributes'] = this.attributes;\n      if (this.attributes['shape'] === 'F') {\n        editorAction['param']['ulx'] -= 50;\n      }\n    }\n\n    this.neonView.edit(editorAction, this.neonView.view.getCurrentPageURI()).then(() => {\n      return this.neonView.updateForCurrentPage();\n    }).then(() => {\n      document.querySelector(this.selector).addEventListener('click', this.handler);\n    });\n  }).bind(this);\n\n  /**\n   * Event handler to insert a staff.\n   */\n  staffHandler = (function staffHandler (evt: MouseEvent): void {\n    const container = document.getElementsByClassName('active-page')[0].getElementsByClassName('definition-scale')[0] as SVGSVGElement;\n    const pt = container.createSVGPoint();\n    pt.x = evt.clientX;\n    pt.y = evt.clientY;\n    const transformMatrix = (container.getElementsByClassName('system')[0] as SVGGraphicsElement).getScreenCTM();\n    const cursorpt = pt.matrixTransform(transformMatrix.inverse());\n\n    if (this.firstClick) {\n      this.coord = cursorpt;\n      d3.select(container).append('circle').attr('cx', cursorpt.x)\n        .attr('cy', cursorpt.y)\n        .attr('r', 10)\n        .attr('id', 'staff-circle')\n        .attr('fill', 'green');\n      this.firstClick = false;\n    } else {\n      let ul, lr;\n      if (cursorpt.x < this.coord.x || cursorpt.y < this.coord.y) { // second point is not lr\n        ul = cursorpt;\n        lr = this.coord;\n      } else {\n        ul = this.coord;\n        lr = cursorpt;\n      }\n      document.getElementById('staff-circle').remove();\n      const action: EditorAction = {\n        'action': 'insert',\n        'param': {\n          'elementType': 'staff',\n          'staffId': 'auto',\n          'ulx': ul.x,\n          'uly': ul.y,\n          'lrx': lr.x,\n          'lry': lr.y\n        }\n      };\n\n      this.neonView.edit(action, this.neonView.view.getCurrentPageURI()).then(() => {\n        this.neonView.updateForCurrentPage();\n        this.firstClick = true;\n      });\n    }\n  }).bind(this);\n\n  /**\n   * Remove the insert listeners while not leaving insert mode entirely.\n   */\n  removeInsertClickHandlers = (function removeInsertClickHandlers (): void {\n    document.querySelector(this.selector).removeEventListener('click', this.staffHandler);\n    document.querySelector(this.selector).removeEventListener('click', this.handler);\n  }).bind(this);\n\n  isInsertMode (): boolean {\n    return (this.type !== '');\n  }\n}\nexport { InsertHandler as default };\n","import NeonView from '../../src/NeonView';\nimport DisplayPanel from '../../src/DisplayPanel/DisplayPanel';\nimport DivaView from '../../src/DivaView';\nimport SingleView from '../../src/SingleView/SingleView';\nimport DivaEdit from '../../src/SquareEdit/DivaEditMode';\nimport SingleEditMode from '../../src/SquareEdit/SingleEditMode';\nimport InfoModule from '../../src/InfoModule';\nimport TextView from '../../src/TextView';\nimport TextEditMode from '../../src/TextEditMode';\n\nimport PouchDB from 'pouchdb';\n\nlet name = getGetParam('manifest');\nlet manifestLocation = 'manifests/' + name + '.jsonld';\nlet storage = getGetParam('storage');\n\nif (name) {\n  window.fetch(manifestLocation).then(response => {\n    if (response.ok) {\n      return response.text();\n    } else {\n      throw new Error(response.statusText);\n    }\n  }).then(async text => {\n    let manifest;\n    try {\n      manifest = JSON.parse(text);\n    } catch (e) {\n      console.error(e);\n      console.debug(text);\n      return;\n    }\n    let params = {\n      manifest: manifest,\n      Display: DisplayPanel,\n      Info: InfoModule,\n      TextView: TextView,\n      TextEdit: TextEditMode\n    };\n    // Determine if it is a single page or multiple by media type\n    let mediaType = await new Promise((resolve, reject) => {\n      window.fetch(manifest.image).then(response => {\n        resolve(response.headers.get('Content-Type'));\n      }).catch(err => {\n        reject(err);\n      });\n    });\n    if (mediaType.match(/image\\/*/)) {\n      params.View = SingleView;\n      params.NeumeEdit = SingleEditMode;\n    } else {\n      params.View = DivaView;\n      params.NeumeEdit = DivaEdit;\n    }\n\n    var view = new NeonView(params);\n    view.start();\n  });\n} else {\n  let db = new PouchDB('Neon-User-Storage');\n  db.getAttachment(storage, 'manifest').then(blob => {\n    return new window.Response(blob).json();\n  }).then(async manifest => {\n    console.log(manifest);\n    let params = {\n      manifest: manifest,\n      Display: DisplayPanel,\n      Info: InfoModule,\n      TextView: TextView,\n      TextEdit: TextEditMode\n    };\n\n    let mediaType = await new Promise((resolve, reject) => {\n      window.fetch(manifest.image).then(response => {\n        resolve(response.headers.get('Content-Type'));\n      }).catch(err => {\n        reject(err);\n      });\n    });\n    if (mediaType.match(/image\\/*/)) {\n      params.View = SingleView;\n      params.NeumeEdit = SingleEditMode;\n    } else {\n      params.View = DivaView;\n      params.NeumeEdit = DivaEdit;\n    }\n\n    var view = new NeonView(params);\n    view.start();\n  });\n}\n\nfunction getGetParam (paramName) {\n  let result = null;\n\n  let tmp = [];\n  window.location.search\n    .substr(1)\n    .split('&')\n    .forEach((item) => {\n      tmp = item.split('=');\n      if (tmp[0] === paramName) {\n        result = decodeURIComponent(tmp[1]);\n      }\n    });\n  return result;\n}\n","import { convertSbToStaff } from './utils/ConvertMei';\nimport * as Validation from './Validation';\nimport VerovioWrapper from './VerovioWrapper';\nimport { WebAnnotation, Attributes, EditorAction, NeonManifest, VerovioMessage } from './Types';\nimport { uuidv4 } from './utils/random';\n\nimport PouchDB from 'pouchdb';\n\ninterface CacheEntry {\n  dirty: boolean;\n  mei: string;\n  svg: SVGSVGElement;\n}\n\n/**\n * The core component of Neon. This manages the database,\n * the verovio toolkit, the cache, and undo/redo stacks.\n */\nclass NeonCore {\n  /** Wrapper for the Verovio WebWorker. */\n  private verovioWrapper: VerovioWrapper;\n  /** Stacks of actions that can be undone per page. */\n  private undoStacks: Map<string, string[]>;\n  /** Stacks of actions that can be redone per page. */\n  private redoStacks: Map<string, string[]>;\n  /** Cache containing entries for each page. */\n  private neonCache: Map<string, CacheEntry>;\n  private db: PouchDB.Database;\n  private parser: DOMParser;\n  /** Pages known not to have any associated MEI. */\n  private blankPages: Array<string>;\n  /** A collection of W3 Web Annotations. */\n  private annotations: WebAnnotation[];\n  private manifest: NeonManifest;\n  private lastPageLoaded: string;\n\n  getAnnotations (): WebAnnotation[] { return this.annotations; }\n\n  /**\n   * Constructor for NeonCore\n   */\n  constructor (manifest: NeonManifest) {\n    this.verovioWrapper = new VerovioWrapper();\n    Validation.init();\n\n    /**\n     * Stacks of previous MEI files representing actions that can be undone for each page.\n     * @type {Map.<string, Array.<string>>}\n     */\n    this.undoStacks = new Map<string, string[]>();\n\n    /**\n     * Stacks of previous MEI files representing actions that can be redone for each page.\n     * @type {Map.<string, Array.<string>>}\n     */\n    this.redoStacks = new Map();\n\n    this.neonCache = new Map();\n\n    this.parser = new DOMParser();\n\n    this.db = new PouchDB('Neon');\n\n    this.blankPages = [];\n\n    // Add each MEI to the database\n    this.manifest = manifest;\n    this.annotations = manifest.mei_annotations;\n    this.lastPageLoaded = '';\n  }\n\n  /**\n   * Initialize the PouchDb database based on the provided manifest.\n   * If a newer version already exists in the database, this will\n   * not update the database unless forced.\n   * @param force - If a database update should be forced.\n   */\n  async initDb (force = false): Promise<{}> {\n    // Check for existing manifest\n    type DbAnnotation = PouchDB.Core.IdMeta & PouchDB.Core.GetMeta & WebAnnotation;\n    type Doc = PouchDB.Core.IdMeta & PouchDB.Core.GetMeta & { timestamp: string; annotations: string[]};\n    const response = await new Promise<{}>((resolve, reject): void => {\n      this.db.get(this.manifest['@id']).catch(err => {\n        if (err.name === 'not_found') {\n          // This is a new document.\n          const doc = {\n            _id: this.manifest['@id'],\n            timestamp: this.manifest.timestamp,\n            image: this.manifest.image,\n            title: this.manifest.title,\n            annotations: []\n          };\n          this.annotations.forEach(annotation => {\n            doc.annotations.push(annotation.id);\n          });\n          return doc;\n        } else {\n          console.error(err);\n          return reject(err);\n        }\n      }).then(async (doc: Doc) => {\n        // Check if doc timestamp is newer than manifest\n        const docTime = (new Date(doc.timestamp)).getTime();\n        const manTime = (new Date(this.manifest.timestamp)).getTime();\n        if (docTime > manTime) {\n          if (!force) {\n            // Fill annotations list with db annotations\n            this.annotations = [];\n            doc.annotations.forEach(async (id: string) => {\n              await this.db.get(id).then((annotation: DbAnnotation) => {\n                this.annotations.push({\n                  id: annotation._id,\n                  type: 'Annotation',\n                  body: annotation.body,\n                  target: annotation.target\n                });\n              }).catch(err => {\n                console.error(err);\n              });\n            });\n            return resolve(false);\n          }\n        }\n        for (const annotation of this.annotations) {\n          // Add annotations to database\n          await this.db.get(annotation.id).catch(err => {\n            if (err.name === 'not_found') {\n              return {\n                _id: annotation.id\n              };\n            } else {\n              console.error(err);\n              return reject(err);\n            }\n          }).then((newAnnotation: DbAnnotation) => {\n            newAnnotation.body = annotation.body;\n            newAnnotation.target = annotation.target;\n            return this.db.put(newAnnotation);\n          }).catch(err => {\n            reject(err);\n            console.error(err);\n          });\n        }\n        return this.db.put(doc);\n      }).then(() => {\n        return resolve(true);\n      }).catch(err => {\n        reject(err);\n        console.error(err);\n      });\n    });\n\n    return response;\n  }\n\n  /**\n   * Load a page into the verovio toolkit. This will fetch the\n   * page from the cache or from the database.\n   * @param pageURI - The URI of the selected page.\n   */\n  loadPage (pageURI: string): Promise<CacheEntry> {\n    return new Promise((resolve, reject): void => {\n      if (this.lastPageLoaded === pageURI && this.neonCache.has(pageURI)) {\n        resolve(this.neonCache.get(pageURI));\n      } else if (this.neonCache.has(pageURI)) {\n        this.loadData(pageURI, this.neonCache.get(pageURI).mei).then(() => {\n          resolve(this.neonCache.get(pageURI));\n        });\n      } else if (this.blankPages.includes(pageURI)) {\n        Validation.blankPage();\n        const e = new Error('No MEI file for page ' + pageURI);\n        e.name = 'missing_mei';\n        reject(e);\n      } else {\n        // Find annotation\n        const annotation = this.annotations.find(elem => {\n          return elem.target === pageURI;\n        });\n        if (annotation) {\n          window.fetch(annotation.body).then(response => {\n            if (response.ok) {\n              return response.text();\n            } else {\n              throw new Error(response.statusText);\n            }\n          }).then(data => {\n            // Check if the MEI file is sb-based. If so, convert to staff-based.\n            if (data.match(/<sb .+>/)) {\n              data = convertSbToStaff(data);\n            }\n            this.loadData(pageURI, data).then(() => {\n              resolve(this.neonCache.get(pageURI));\n            });\n          }).catch(err => {\n            reject(err);\n          });\n        } else {\n          Validation.blankPage();\n          this.blankPages.push(pageURI);\n        }\n      }\n    });\n  }\n\n  /**\n   * Load data into the verovio toolkit and update the cache.\n   * @param pageURI - The URI of the selected page.\n   * @param data - The MEI of the page as a string.\n   * @param dirty - If the cache entry should be marked as dirty.\n   */\n  loadData (pageURI: string, data: string, dirty = false): Promise<void> {\n    Validation.sendForValidation(data);\n    this.lastPageLoaded = pageURI;\n    /* A promise is returned that will resolve to the result of the action.\n     * However the value that is must return comes from the Web Worker and\n     * information passed between the worker and main context much be in a\n     * message. So an event handler is put on verovioWrapper for when a message\n     * is receieved from the worker. Then a message is sent to the worker to\n     * take an action. A response is sent back and the previously mentioned\n     * event handler handles the response. Since it is defined within the\n     * promise it has access to the necessary resolve function.\n     */\n    return new Promise((resolve): void => {\n      const message: VerovioMessage = {\n        id: uuidv4(),\n        action: 'renderData',\n        mei: data\n      };\n      function handle (evt: MessageEvent): void {\n        if (evt.data.id === message.id) {\n          const svg = this.parser.parseFromString(\n            evt.data.svg,\n            'image/svg+xml'\n          ).documentElement;\n          this.neonCache.set(pageURI, {\n            svg: svg,\n            mei: data,\n            dirty: dirty\n          });\n          evt.target.removeEventListener('message', handle);\n          resolve();\n        }\n      }\n      this.verovioWrapper.addEventListener('message', handle.bind(this));\n      this.verovioWrapper.postMessage(message);\n    });\n  }\n\n  /**\n   * Get the SVG for a specific page.\n   * @param pageURI - The URI of the selected page.\n   */\n  getSVG (pageURI: string): Promise<SVGSVGElement> {\n    return new Promise((resolve, reject): void => {\n      this.loadPage(pageURI).then((entry) => {\n        resolve(entry.svg);\n      }).catch((err) => { reject(err); });\n    });\n  }\n\n  /**\n   * Get the MEI for a specific page.\n   * @param pageURI - The URI of the selected page.\n   */\n  getMEI (pageURI: string): Promise<string> {\n    return new Promise((resolve, reject): void => {\n      this.loadPage(pageURI).then((entry) => {\n        resolve(entry.mei);\n      }).catch((err) => { reject(err); });\n    });\n  }\n\n  /**\n   * Get musical element attributes from the verovio toolkit.\n   * @param elementId - The unique ID of the musical element.\n   * @param pageURI - The URI of the selected page.\n   */\n  getElementAttr (elementId: string, pageURI: string): Promise<Attributes> {\n    return new Promise((resolve): void => {\n      this.loadPage(pageURI).then(() => {\n        const message: VerovioMessage = {\n          id: uuidv4(),\n          action: 'getElementAttr',\n          elementId: elementId\n        };\n        this.verovioWrapper.addEventListener('message', function handle (evt: MessageEvent) {\n          if (evt.data.id === message.id) {\n            evt.target.removeEventListener('message', handle);\n            resolve(evt.data.attributes);\n          }\n        });\n        this.verovioWrapper.postMessage(message);\n      });\n    });\n  }\n\n  /**\n   * Perform an editor action on a specific page.\n   * @param action - The editor toolkit action object.\n   * @param pageURI - The URI of the selected page.\n   */\n  edit (editorAction: EditorAction, pageURI: string): Promise<boolean> {\n    let promise: Promise<CacheEntry>;\n    if (this.lastPageLoaded === pageURI) {\n      promise = Promise.resolve(this.neonCache.get(pageURI));\n    } else {\n      promise = this.loadPage(pageURI);\n    }\n    return new Promise((resolve): void => {\n      promise.then(entry => {\n        const currentMEI = entry.mei;\n        const message: VerovioMessage = {\n          id: uuidv4(),\n          action: 'edit',\n          editorAction: editorAction\n        };\n        function handle (evt: MessageEvent): void {\n          if (evt.data.id === message.id) {\n            if (evt.data.result) {\n              if (!this.undoStacks.has(pageURI)) {\n                this.undoStacks.set(pageURI, []);\n              }\n              this.undoStacks.get(pageURI).push(currentMEI);\n              this.redoStacks.set(pageURI, []);\n            }\n            evt.target.removeEventListener('message', handle);\n            this.updateCache(pageURI, true).then(() => { resolve(evt.data.result); });\n          }\n        }\n        this.verovioWrapper.addEventListener('message', handle.bind(this));\n        this.verovioWrapper.postMessage(message);\n      });\n    });\n  }\n\n  /**\n   * Update contents of the cache using information in verovio toolkit.\n   * @param pageURI - Page to be updated in cache.\n   * @param dirty - If the entry should be marked as dirty\n   */\n  updateCache (pageURI: string, dirty: boolean): Promise<void> {\n    return new Promise((resolve): void => {\n      // Must get MEI and then get SVG then finish.\n      let mei: string, svgText: string;\n      const meiPromise = new Promise((resolve): void => {\n        const message: VerovioMessage = {\n          id: uuidv4(),\n          action: 'getMEI'\n        };\n        this.verovioWrapper.addEventListener('message', function handle (evt: MessageEvent) {\n          if (evt.data.id === message.id) {\n            mei = evt.data.mei;\n            evt.target.removeEventListener('message', handle);\n            resolve();\n          }\n        });\n        this.verovioWrapper.postMessage(message);\n      });\n      const svgPromise = new Promise((resolve): void => {\n        const message: VerovioMessage = {\n          id: uuidv4(),\n          action: 'renderToSVG'\n        };\n        this.verovioWrapper.addEventListener('message', function handle (evt: MessageEvent) {\n          if (evt.data.id === message.id) {\n            svgText = evt.data.svg;\n            evt.target.removeEventListener('message', handle);\n            resolve();\n          }\n        });\n        this.verovioWrapper.postMessage(message);\n      });\n\n      meiPromise.then(() => { return svgPromise; }).then(() => {\n        const svg = this.parser.parseFromString(\n          svgText,\n          'image/svg+xml'\n        ).documentElement as unknown as SVGSVGElement;\n        this.neonCache.set(pageURI, {\n          mei: mei,\n          svg: svg,\n          dirty: dirty\n        });\n        resolve();\n      });\n    });\n  }\n\n  /**\n   * Get the edit info string from the verovio toolkit.\n   * @param pageURI - The URI of the page to get the edit info string from.\n   */\n  info (pageURI: string): Promise<string> {\n    let promise: Promise<CacheEntry | void>;\n    if (this.lastPageLoaded === pageURI) {\n      promise = Promise.resolve();\n    } else {\n      promise = this.loadPage(pageURI);\n    }\n    return new Promise((resolve): void => {\n      promise.then(() => {\n        const message: VerovioMessage = {\n          id: uuidv4(),\n          action: 'editInfo'\n        };\n        this.verovioWrapper.addEventListener('message', function handle (evt: MessageEvent) {\n          if (evt.data.id === message.id) {\n            evt.target.removeEventListener('message', handle);\n            resolve(JSON.parse(evt.data.info));\n          }\n        });\n        this.verovioWrapper.postMessage(message);\n      });\n    });\n  }\n\n  /**\n   * Undo the last action performed on a specific page.\n   * @param pageURI - The URI of the selected page.\n   * @returns If the action was undone.\n   */\n  undo (pageURI: string): Promise<boolean> {\n    return new Promise((resolve): void => {\n      if (this.undoStacks.has(pageURI)) {\n        const state = this.undoStacks.get(pageURI).pop();\n        if (state !== undefined) {\n          this.getMEI(pageURI).then(mei => {\n            this.redoStacks.get(pageURI).push(mei);\n            return this.loadData(pageURI, state, true);\n          }).then(() => {\n            resolve(true);\n          });\n          return;\n        }\n      }\n      resolve(false);\n    });\n  }\n\n  /**\n   * Redo the last action performed on a page.\n   * @param pageURI - The page URI.\n   * @returns If the action was redone.\n   */\n  redo (pageURI: string): Promise<boolean> {\n    return new Promise((resolve): void => {\n      if (this.redoStacks.has(pageURI)) {\n        const state = this.redoStacks.get(pageURI).pop();\n        if (state !== undefined) {\n          this.getMEI(pageURI).then((mei) => {\n            this.undoStacks.get(pageURI).push(mei);\n            return this.loadData(pageURI, state, true);\n          }).then(() => {\n            resolve(true);\n          });\n          return;\n        }\n      }\n      resolve(false);\n    });\n  }\n\n  /**\n   * Update the PouchDb database stored in the browser.\n   * This is based on the data stored in the cache. To save time,\n   * only entries marked as dirty will be updated.\n   */\n  async updateDatabase (): Promise<void> {\n    type Doc = PouchDB.Core.GetMeta & PouchDB.Core.IdMeta & { body: string; timestamp: string };\n    let updateTimestamp = false;\n    for (const pair of this.neonCache) {\n      const key = pair[0];\n      const value = pair[1];\n      if (value.dirty) {\n        updateTimestamp = true;\n        const index = this.annotations.findIndex(elem => { return elem.target === key; });\n        // try to update server with PUT (if applicable\n        // only attempt if not a data URI\n        let uri: string;\n        if (!this.annotations[index].body.match(/^data:/)) {\n          await window.fetch(this.annotations[index].body,\n            {\n              method: 'PUT',\n              headers: { 'Content-Type': 'application/mei+xml' },\n              body: value.mei\n            }\n          ).then(response => {\n            if (response.ok) {\n              uri = this.annotations[index].body;\n            } else {\n              uri = 'data:application/mei+xml;base64,' + window.btoa(value.mei);\n            }\n          }).catch(err => {\n            console.error(err);\n            console.warn('Falling back to data URI');\n            uri = 'data:application/mei+xml;base64,' + window.btoa(value.mei);\n          });\n        } else {\n          uri = 'data:application/mei+xml;base64,' + window.btoa(value.mei);\n        }\n        // Update URI in annotations, database\n        this.annotations[index].body = uri;\n        await this.db.get(this.annotations[index].id).then((doc: Doc) => {\n          doc.body = uri;\n          return this.db.put(doc);\n        }).then(() => {\n          value.dirty = false;\n        }).catch(err => {\n          console.error(err);\n        });\n      }\n    }\n\n    if (updateTimestamp) {\n      await this.db.get(this.manifest['@id']).then((doc: Doc) => {\n        doc.timestamp = (new Date()).toISOString();\n        return this.db.put(doc);\n      }).catch(err => {\n        console.error(err);\n      });\n    }\n  }\n\n  /** Completely remove the database. */\n  deleteDb (): Promise<void> {\n    return this.db.destroy();\n  }\n}\n\nexport { NeonCore as default };\n","const schemaResponse = fetch(__ASSET_PREFIX__ + 'assets/mei-all.rng');\nlet worker: Worker, schema: string, statusField: HTMLSpanElement;\n\n/**\n * Update the UI with the validation results. Called when the WebWorker finishes validating.\n */\nfunction updateUI (message: { data: string[] }): void {\n  const errors = message.data;\n  if (errors === null) {\n    statusField.textContent = 'VALID';\n    statusField.style.color = 'green';\n    for (const child of statusField.children) {\n      child.remove();\n    }\n  } else {\n    let log = '';\n    errors.forEach(line => {\n      log += line + '\\n';\n    });\n    statusField.textContent = '';\n    statusField.style.color = 'red';\n    const link = document.createElement('a');\n    link.setAttribute('href', 'data:text/plain;charset=utf-8,' +\n      encodeURIComponent(log));\n    link.setAttribute('download', 'validation.log');\n    link.textContent = 'INVALID';\n    statusField.appendChild(link);\n  }\n}\n\n/**\n * Add the validation information to the display and create the WebWorker\n * for validation MEI.\n */\nexport async function init (): Promise<void> {\n  const displayContents = document.getElementById('displayContents');\n  if (displayContents !== null) {\n    const panelBlock = document.createElement('div');\n    panelBlock.classList.add('panel-block');\n    const pNotif = document.createElement('p');\n    pNotif.textContent = 'MEI Status: ';\n    const span = document.createElement('span');\n    span.id = 'validation_status';\n    span.textContent = 'unknown';\n    pNotif.appendChild(span);\n    panelBlock.appendChild(pNotif);\n    displayContents.appendChild(panelBlock);\n    statusField = document.getElementById('validation_status');\n    worker = new Worker(__ASSET_PREFIX__ + 'workers/Worker.js');\n    worker.onmessage = updateUI;\n  }\n}\n\n/**\n * Send the contents of an MEI file to the WebWorker for validation.\n * @param {string} meiData\n */\nexport async function sendForValidation (meiData: string): Promise<void> {\n  if (statusField === undefined) {\n    return;\n  }\n  if (schema === undefined) {\n    const response = await schemaResponse;\n    schema = await response.text();\n  }\n  statusField.textContent = 'checking...';\n  statusField.style.color = 'gray';\n  worker.postMessage({\n    mei: meiData,\n    schema: schema\n  });\n}\n\n/**\n * Update the message on a blank page when there is no MEI.\n */\nexport function blankPage (): void {\n  for (const child of statusField.children) {\n    child.remove();\n  }\n  statusField.textContent = 'No MEI';\n  statusField.style.color = 'color:gray';\n}\n","import { VerovioMessage } from './Types';\n\n\n/**\n * A wrapper around the verovio web worker to permit mocking in tests.\n */\nexport default class VerovioWrapper {\n  verovioWorker: Worker;\n  constructor () {\n    this.verovioWorker = new Worker(__ASSET_PREFIX__ + 'workers/VerovioWorker.js');\n  }\n\n  /**\n   * Set an event listener onto the actual web worker.\n   */\n  addEventListener (type: string, handler: EventListenerOrEventListenerObject): void {\n    return this.verovioWorker.addEventListener(type, handler);\n  }\n\n  /**\n   * Send a message to the actual web worker.\n   */\n  postMessage (message: VerovioMessage): void {\n    return this.verovioWorker.postMessage(message);\n  }\n}\n","// shim for using process in browser\nvar process = module.exports = {};\n\n// cached from whatever global is present so that test runners that stub it\n// don't break things.  But we need to wrap it in a try catch in case it is\n// wrapped in strict mode code which doesn't define any globals.  It's inside a\n// function because try/catches deoptimize in certain engines.\n\nvar cachedSetTimeout;\nvar cachedClearTimeout;\n\nfunction defaultSetTimout() {\n    throw new Error('setTimeout has not been defined');\n}\nfunction defaultClearTimeout () {\n    throw new Error('clearTimeout has not been defined');\n}\n(function () {\n    try {\n        if (typeof setTimeout === 'function') {\n            cachedSetTimeout = setTimeout;\n        } else {\n            cachedSetTimeout = defaultSetTimout;\n        }\n    } catch (e) {\n        cachedSetTimeout = defaultSetTimout;\n    }\n    try {\n        if (typeof clearTimeout === 'function') {\n            cachedClearTimeout = clearTimeout;\n        } else {\n            cachedClearTimeout = defaultClearTimeout;\n        }\n    } catch (e) {\n        cachedClearTimeout = defaultClearTimeout;\n    }\n} ())\nfunction runTimeout(fun) {\n    if (cachedSetTimeout === setTimeout) {\n        //normal enviroments in sane situations\n        return setTimeout(fun, 0);\n    }\n    // if setTimeout wasn't available but was latter defined\n    if ((cachedSetTimeout === defaultSetTimout || !cachedSetTimeout) && setTimeout) {\n        cachedSetTimeout = setTimeout;\n        return setTimeout(fun, 0);\n    }\n    try {\n        // when when somebody has screwed with setTimeout but no I.E. maddness\n        return cachedSetTimeout(fun, 0);\n    } catch(e){\n        try {\n            // When we are in I.E. but the script has been evaled so I.E. doesn't trust the global object when called normally\n            return cachedSetTimeout.call(null, fun, 0);\n        } catch(e){\n            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error\n            return cachedSetTimeout.call(this, fun, 0);\n        }\n    }\n\n\n}\nfunction runClearTimeout(marker) {\n    if (cachedClearTimeout === clearTimeout) {\n        //normal enviroments in sane situations\n        return clearTimeout(marker);\n    }\n    // if clearTimeout wasn't available but was latter defined\n    if ((cachedClearTimeout === defaultClearTimeout || !cachedClearTimeout) && clearTimeout) {\n        cachedClearTimeout = clearTimeout;\n        return clearTimeout(marker);\n    }\n    try {\n        // when when somebody has screwed with setTimeout but no I.E. maddness\n        return cachedClearTimeout(marker);\n    } catch (e){\n        try {\n            // When we are in I.E. but the script has been evaled so I.E. doesn't  trust the global object when called normally\n            return cachedClearTimeout.call(null, marker);\n        } catch (e){\n            // same as above but when it's a version of I.E. that must have the global object for 'this', hopfully our context correct otherwise it will throw a global error.\n            // Some versions of I.E. have different rules for clearTimeout vs setTimeout\n            return cachedClearTimeout.call(this, marker);\n        }\n    }\n\n\n\n}\nvar queue = [];\nvar draining = false;\nvar currentQueue;\nvar queueIndex = -1;\n\nfunction cleanUpNextTick() {\n    if (!draining || !currentQueue) {\n        return;\n    }\n    draining = false;\n    if (currentQueue.length) {\n        queue = currentQueue.concat(queue);\n    } else {\n        queueIndex = -1;\n    }\n    if (queue.length) {\n        drainQueue();\n    }\n}\n\nfunction drainQueue() {\n    if (draining) {\n        return;\n    }\n    var timeout = runTimeout(cleanUpNextTick);\n    draining = true;\n\n    var len = queue.length;\n    while(len) {\n        currentQueue = queue;\n        queue = [];\n        while (++queueIndex < len) {\n            if (currentQueue) {\n                currentQueue[queueIndex].run();\n            }\n        }\n        queueIndex = -1;\n        len = queue.length;\n    }\n    currentQueue = null;\n    draining = false;\n    runClearTimeout(timeout);\n}\n\nprocess.nextTick = function (fun) {\n    var args = new Array(arguments.length - 1);\n    if (arguments.length > 1) {\n        for (var i = 1; i < arguments.length; i++) {\n            args[i - 1] = arguments[i];\n        }\n    }\n    queue.push(new Item(fun, args));\n    if (queue.length === 1 && !draining) {\n        runTimeout(drainQueue);\n    }\n};\n\n// v8 likes predictible objects\nfunction Item(fun, array) {\n    this.fun = fun;\n    this.array = array;\n}\nItem.prototype.run = function () {\n    this.fun.apply(null, this.array);\n};\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\nprocess.version = ''; // empty string to avoid regexp issues\nprocess.versions = {};\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\nprocess.prependListener = noop;\nprocess.prependOnceListener = noop;\n\nprocess.listeners = function (name) { return [] }\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n};\n\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\nprocess.umask = function() { return 0; };\n","var rng = require('./lib/rng');\nvar bytesToUuid = require('./lib/bytesToUuid');\n\n// **`v1()` - Generate time-based UUID**\n//\n// Inspired by https://github.com/LiosK/UUID.js\n// and http://docs.python.org/library/uuid.html\n\nvar _nodeId;\nvar _clockseq;\n\n// Previous uuid creation time\nvar _lastMSecs = 0;\nvar _lastNSecs = 0;\n\n// See https://github.com/broofa/node-uuid for API details\nfunction v1(options, buf, offset) {\n  var i = buf && offset || 0;\n  var b = buf || [];\n\n  options = options || {};\n  var node = options.node || _nodeId;\n  var clockseq = options.clockseq !== undefined ? options.clockseq : _clockseq;\n\n  // node and clockseq need to be initialized to random values if they're not\n  // specified.  We do this lazily to minimize issues related to insufficient\n  // system entropy.  See #189\n  if (node == null || clockseq == null) {\n    var seedBytes = rng();\n    if (node == null) {\n      // Per 4.5, create and 48-bit node id, (47 random bits + multicast bit = 1)\n      node = _nodeId = [\n        seedBytes[0] | 0x01,\n        seedBytes[1], seedBytes[2], seedBytes[3], seedBytes[4], seedBytes[5]\n      ];\n    }\n    if (clockseq == null) {\n      // Per 4.2.2, randomize (14 bit) clockseq\n      clockseq = _clockseq = (seedBytes[6] << 8 | seedBytes[7]) & 0x3fff;\n    }\n  }\n\n  // UUID timestamps are 100 nano-second units since the Gregorian epoch,\n  // (1582-10-15 00:00).  JSNumbers aren't precise enough for this, so\n  // time is handled internally as 'msecs' (integer milliseconds) and 'nsecs'\n  // (100-nanoseconds offset from msecs) since unix epoch, 1970-01-01 00:00.\n  var msecs = options.msecs !== undefined ? options.msecs : new Date().getTime();\n\n  // Per 4.2.1.2, use count of uuid's generated during the current clock\n  // cycle to simulate higher resolution clock\n  var nsecs = options.nsecs !== undefined ? options.nsecs : _lastNSecs + 1;\n\n  // Time since last uuid creation (in msecs)\n  var dt = (msecs - _lastMSecs) + (nsecs - _lastNSecs)/10000;\n\n  // Per 4.2.1.2, Bump clockseq on clock regression\n  if (dt < 0 && options.clockseq === undefined) {\n    clockseq = clockseq + 1 & 0x3fff;\n  }\n\n  // Reset nsecs if clock regresses (new clockseq) or we've moved onto a new\n  // time interval\n  if ((dt < 0 || msecs > _lastMSecs) && options.nsecs === undefined) {\n    nsecs = 0;\n  }\n\n  // Per 4.2.1.2 Throw error if too many uuids are requested\n  if (nsecs >= 10000) {\n    throw new Error('uuid.v1(): Can\\'t create more than 10M uuids/sec');\n  }\n\n  _lastMSecs = msecs;\n  _lastNSecs = nsecs;\n  _clockseq = clockseq;\n\n  // Per 4.1.4 - Convert from unix epoch to Gregorian epoch\n  msecs += 12219292800000;\n\n  // `time_low`\n  var tl = ((msecs & 0xfffffff) * 10000 + nsecs) % 0x100000000;\n  b[i++] = tl >>> 24 & 0xff;\n  b[i++] = tl >>> 16 & 0xff;\n  b[i++] = tl >>> 8 & 0xff;\n  b[i++] = tl & 0xff;\n\n  // `time_mid`\n  var tmh = (msecs / 0x100000000 * 10000) & 0xfffffff;\n  b[i++] = tmh >>> 8 & 0xff;\n  b[i++] = tmh & 0xff;\n\n  // `time_high_and_version`\n  b[i++] = tmh >>> 24 & 0xf | 0x10; // include version\n  b[i++] = tmh >>> 16 & 0xff;\n\n  // `clock_seq_hi_and_reserved` (Per 4.2.2 - include variant)\n  b[i++] = clockseq >>> 8 | 0x80;\n\n  // `clock_seq_low`\n  b[i++] = clockseq & 0xff;\n\n  // `node`\n  for (var n = 0; n < 6; ++n) {\n    b[i + n] = node[n];\n  }\n\n  return buf ? buf : bytesToUuid(b);\n}\n\nmodule.exports = v1;\n","var rng = require('./lib/rng');\nvar bytesToUuid = require('./lib/bytesToUuid');\n\nfunction v4(options, buf, offset) {\n  var i = buf && offset || 0;\n\n  if (typeof(options) == 'string') {\n    buf = options === 'binary' ? new Array(16) : null;\n    options = null;\n  }\n  options = options || {};\n\n  var rnds = options.random || (options.rng || rng)();\n\n  // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n  rnds[6] = (rnds[6] & 0x0f) | 0x40;\n  rnds[8] = (rnds[8] & 0x3f) | 0x80;\n\n  // Copy bytes to buffer, if provided\n  if (buf) {\n    for (var ii = 0; ii < 16; ++ii) {\n      buf[i + ii] = rnds[ii];\n    }\n  }\n\n  return buf || bytesToUuid(rnds);\n}\n\nmodule.exports = v4;\n","import { NeonManifest } from '../Types';\nconst NeonSchema = require('./manifest/NeonSchema.json');\nconst NeonContext = require('./manifest/context.json');\n\nimport { validate } from 'jsonschema';\n/**\n * Check if the provided Neon manifest is parseable.\n * @param {string} manifestString - The Neon manifest as a string.\n */\nexport function parseManifest (manifestString: NeonManifest): boolean {\n  const results = validate(manifestString, NeonSchema);\n  const instance = results.instance;\n  if (results.errors.length > 0) {\n    console.error(results.errors);\n    return false;\n  }\n  const context = instance['@context'];\n  if (context === 'https://ddmal.music.mcgill.ca/Neon/contexts/1/manifest.jsonld') {\n    return true;\n  }\n  if ((context[0] === NeonContext[0]) &&\n      (context[1]['schema'] === NeonContext[1]['schema']) &&\n      (context[1]['title'] === NeonContext[1]['title']) &&\n      (context[1]['timestamp'] === NeonContext[1]['timestamp']) &&\n      (context[1]['image']['@id'] === NeonContext[1]['image']['@id']) &&\n      (context[1]['image']['@type'] === NeonContext[1]['image']['@type']) &&\n      (context[1]['mei_annotations']['@id'] === NeonContext[1]['mei_annotations']['@id']) &&\n      (context[1]['mei_annotations']['@type'] === NeonContext[1]['mei_annotations']['@type']) &&\n      (context[1]['mei_annotations']['@container'] === NeonContext[1]['mei_annotations']['@container'])) {\n    return true;\n  } else {\n    console.error('Context mismatch');\n    console.error(context);\n    console.error(NeonContext);\n    return false;\n  }\n}\n","'use strict';\n\nvar Validator = module.exports.Validator = require('./validator');\n\nmodule.exports.ValidatorResult = require('./helpers').ValidatorResult;\nmodule.exports.ValidationError = require('./helpers').ValidationError;\nmodule.exports.SchemaError = require('./helpers').SchemaError;\nmodule.exports.SchemaScanResult = require('./scan').SchemaScanResult;\nmodule.exports.scan = require('./scan').scan;\n\nmodule.exports.validate = function (instance, schema, options) {\n  var v = new Validator();\n  return v.validate(instance, schema, options);\n};\n","'use strict';\n\nvar urilib = require('url');\n\nvar attribute = require('./attribute');\nvar helpers = require('./helpers');\nvar scanSchema = require('./scan').scan;\nvar ValidatorResult = helpers.ValidatorResult;\nvar SchemaError = helpers.SchemaError;\nvar SchemaContext = helpers.SchemaContext;\n//var anonymousBase = 'vnd.jsonschema:///';\nvar anonymousBase = '/';\n\n/**\n * Creates a new Validator object\n * @name Validator\n * @constructor\n */\nvar Validator = function Validator () {\n  // Allow a validator instance to override global custom formats or to have their\n  // own custom formats.\n  this.customFormats = Object.create(Validator.prototype.customFormats);\n  this.schemas = {};\n  this.unresolvedRefs = [];\n\n  // Use Object.create to make this extensible without Validator instances stepping on each other's toes.\n  this.types = Object.create(types);\n  this.attributes = Object.create(attribute.validators);\n};\n\n// Allow formats to be registered globally.\nValidator.prototype.customFormats = {};\n\n// Hint at the presence of a property\nValidator.prototype.schemas = null;\nValidator.prototype.types = null;\nValidator.prototype.attributes = null;\nValidator.prototype.unresolvedRefs = null;\n\n/**\n * Adds a schema with a certain urn to the Validator instance.\n * @param schema\n * @param urn\n * @return {Object}\n */\nValidator.prototype.addSchema = function addSchema (schema, base) {\n  var self = this;\n  if (!schema) {\n    return null;\n  }\n  var scan = scanSchema(base||anonymousBase, schema);\n  var ourUri = base || schema.id;\n  for(var uri in scan.id){\n    this.schemas[uri] = scan.id[uri];\n  }\n  for(var uri in scan.ref){\n    this.unresolvedRefs.push(uri);\n  }\n  this.unresolvedRefs = this.unresolvedRefs.filter(function(uri){\n    return typeof self.schemas[uri]==='undefined';\n  });\n  return this.schemas[ourUri];\n};\n\nValidator.prototype.addSubSchemaArray = function addSubSchemaArray(baseuri, schemas) {\n  if(!(schemas instanceof Array)) return;\n  for(var i=0; i<schemas.length; i++){\n    this.addSubSchema(baseuri, schemas[i]);\n  }\n};\n\nValidator.prototype.addSubSchemaObject = function addSubSchemaArray(baseuri, schemas) {\n  if(!schemas || typeof schemas!='object') return;\n  for(var p in schemas){\n    this.addSubSchema(baseuri, schemas[p]);\n  }\n};\n\n\n\n/**\n * Sets all the schemas of the Validator instance.\n * @param schemas\n */\nValidator.prototype.setSchemas = function setSchemas (schemas) {\n  this.schemas = schemas;\n};\n\n/**\n * Returns the schema of a certain urn\n * @param urn\n */\nValidator.prototype.getSchema = function getSchema (urn) {\n  return this.schemas[urn];\n};\n\n/**\n * Validates instance against the provided schema\n * @param instance\n * @param schema\n * @param [options]\n * @param [ctx]\n * @return {Array}\n */\nValidator.prototype.validate = function validate (instance, schema, options, ctx) {\n  if (!options) {\n    options = {};\n  }\n  var propertyName = options.propertyName || 'instance';\n  // This will work so long as the function at uri.resolve() will resolve a relative URI to a relative URI\n  var base = urilib.resolve(options.base||anonymousBase, schema.id||'');\n  if(!ctx){\n    ctx = new SchemaContext(schema, options, propertyName, base, Object.create(this.schemas));\n    if (!ctx.schemas[base]) {\n      ctx.schemas[base] = schema;\n    }\n    var found = scanSchema(base, schema);\n    for(var n in found.id){\n      var sch = found.id[n];\n      ctx.schemas[n] = sch;\n    }\n  }\n  if (schema) {\n    var result = this.validateSchema(instance, schema, options, ctx);\n    if (!result) {\n      throw new Error('Result undefined');\n    }\n    return result;\n  }\n  throw new SchemaError('no schema specified', schema);\n};\n\n/**\n* @param Object schema\n* @return mixed schema uri or false\n*/\nfunction shouldResolve(schema) {\n  var ref = (typeof schema === 'string') ? schema : schema.$ref;\n  if (typeof ref=='string') return ref;\n  return false;\n}\n\n/**\n * Validates an instance against the schema (the actual work horse)\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @private\n * @return {ValidatorResult}\n */\nValidator.prototype.validateSchema = function validateSchema (instance, schema, options, ctx) {\n  var result = new ValidatorResult(instance, schema, options, ctx);\n\n    // Support for the true/false schemas\n  if(typeof schema==='boolean') {\n    if(schema===true){\n      // `true` is always valid\n      schema = {};\n    }else if(schema===false){\n      // `false` is always invalid\n      schema = {type: []};\n    }\n  }else if(!schema){\n    // This might be a string\n    throw new Error(\"schema is undefined\");\n  }\n\n  if (schema['extends']) {\n    if (schema['extends'] instanceof Array) {\n      var schemaobj = {schema: schema, ctx: ctx};\n      schema['extends'].forEach(this.schemaTraverser.bind(this, schemaobj));\n      schema = schemaobj.schema;\n      schemaobj.schema = null;\n      schemaobj.ctx = null;\n      schemaobj = null;\n    } else {\n      schema = helpers.deepMerge(schema, this.superResolve(schema['extends'], ctx));\n    }\n  }\n\n  // If passed a string argument, load that schema URI\n  var switchSchema;\n  if (switchSchema = shouldResolve(schema)) {\n    var resolved = this.resolve(schema, switchSchema, ctx);\n    var subctx = new SchemaContext(resolved.subschema, options, ctx.propertyPath, resolved.switchSchema, ctx.schemas);\n    return this.validateSchema(instance, resolved.subschema, options, subctx);\n  }\n\n  var skipAttributes = options && options.skipAttributes || [];\n  // Validate each schema attribute against the instance\n  for (var key in schema) {\n    if (!attribute.ignoreProperties[key] && skipAttributes.indexOf(key) < 0) {\n      var validatorErr = null;\n      var validator = this.attributes[key];\n      if (validator) {\n        validatorErr = validator.call(this, instance, schema, options, ctx);\n      } else if (options.allowUnknownAttributes === false) {\n        // This represents an error with the schema itself, not an invalid instance\n        throw new SchemaError(\"Unsupported attribute: \" + key, schema);\n      }\n      if (validatorErr) {\n        result.importErrors(validatorErr);\n      }\n    }\n  }\n\n  if (typeof options.rewrite == 'function') {\n    var value = options.rewrite.call(this, instance, schema, options, ctx);\n    result.instance = value;\n  }\n  return result;\n};\n\n/**\n* @private\n* @param Object schema\n* @param SchemaContext ctx\n* @returns Object schema or resolved schema\n*/\nValidator.prototype.schemaTraverser = function schemaTraverser (schemaobj, s) {\n  schemaobj.schema = helpers.deepMerge(schemaobj.schema, this.superResolve(s, schemaobj.ctx));\n}\n\n/**\n* @private\n* @param Object schema\n* @param SchemaContext ctx\n* @returns Object schema or resolved schema\n*/\nValidator.prototype.superResolve = function superResolve (schema, ctx) {\n  var ref;\n  if(ref = shouldResolve(schema)) {\n    return this.resolve(schema, ref, ctx).subschema;\n  }\n  return schema;\n}\n\n/**\n* @private\n* @param Object schema\n* @param Object switchSchema\n* @param SchemaContext ctx\n* @return Object resolved schemas {subschema:String, switchSchema: String}\n* @throws SchemaError\n*/\nValidator.prototype.resolve = function resolve (schema, switchSchema, ctx) {\n  switchSchema = ctx.resolve(switchSchema);\n  // First see if the schema exists under the provided URI\n  if (ctx.schemas[switchSchema]) {\n    return {subschema: ctx.schemas[switchSchema], switchSchema: switchSchema};\n  }\n  // Else try walking the property pointer\n  var parsed = urilib.parse(switchSchema);\n  var fragment = parsed && parsed.hash;\n  var document = fragment && fragment.length && switchSchema.substr(0, switchSchema.length - fragment.length);\n  if (!document || !ctx.schemas[document]) {\n    throw new SchemaError(\"no such schema <\" + switchSchema + \">\", schema);\n  }\n  var subschema = helpers.objectGetPath(ctx.schemas[document], fragment.substr(1));\n  if(subschema===undefined){\n    throw new SchemaError(\"no such schema \" + fragment + \" located in <\" + document + \">\", schema);\n  }\n  return {subschema: subschema, switchSchema: switchSchema};\n};\n\n/**\n * Tests whether the instance if of a certain type.\n * @private\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @param type\n * @return {boolean}\n */\nValidator.prototype.testType = function validateType (instance, schema, options, ctx, type) {\n  if (typeof this.types[type] == 'function') {\n    return this.types[type].call(this, instance);\n  }\n  if (type && typeof type == 'object') {\n    var res = this.validateSchema(instance, type, options, ctx);\n    return res === undefined || !(res && res.errors.length);\n  }\n  // Undefined or properties not on the list are acceptable, same as not being defined\n  return true;\n};\n\nvar types = Validator.prototype.types = {};\ntypes.string = function testString (instance) {\n  return typeof instance == 'string';\n};\ntypes.number = function testNumber (instance) {\n  // isFinite returns false for NaN, Infinity, and -Infinity\n  return typeof instance == 'number' && isFinite(instance);\n};\ntypes.integer = function testInteger (instance) {\n  return (typeof instance == 'number') && instance % 1 === 0;\n};\ntypes.boolean = function testBoolean (instance) {\n  return typeof instance == 'boolean';\n};\ntypes.array = function testArray (instance) {\n  return Array.isArray(instance);\n};\ntypes['null'] = function testNull (instance) {\n  return instance === null;\n};\ntypes.date = function testDate (instance) {\n  return instance instanceof Date;\n};\ntypes.any = function testAny (instance) {\n  return true;\n};\ntypes.object = function testObject (instance) {\n  // TODO: fix this - see #15\n  return instance && (typeof instance) === 'object' && !(instance instanceof Array) && !(instance instanceof Date);\n};\n\nmodule.exports = Validator;\n","/*! https://mths.be/punycode v1.4.1 by @mathias */\n;(function(root) {\n\n\t/** Detect free variables */\n\tvar freeExports = typeof exports == 'object' && exports &&\n\t\t!exports.nodeType && exports;\n\tvar freeModule = typeof module == 'object' && module &&\n\t\t!module.nodeType && module;\n\tvar freeGlobal = typeof global == 'object' && global;\n\tif (\n\t\tfreeGlobal.global === freeGlobal ||\n\t\tfreeGlobal.window === freeGlobal ||\n\t\tfreeGlobal.self === freeGlobal\n\t) {\n\t\troot = freeGlobal;\n\t}\n\n\t/**\n\t * The `punycode` object.\n\t * @name punycode\n\t * @type Object\n\t */\n\tvar punycode,\n\n\t/** Highest positive signed 32-bit float value */\n\tmaxInt = 2147483647, // aka. 0x7FFFFFFF or 2^31-1\n\n\t/** Bootstring parameters */\n\tbase = 36,\n\ttMin = 1,\n\ttMax = 26,\n\tskew = 38,\n\tdamp = 700,\n\tinitialBias = 72,\n\tinitialN = 128, // 0x80\n\tdelimiter = '-', // '\\x2D'\n\n\t/** Regular expressions */\n\tregexPunycode = /^xn--/,\n\tregexNonASCII = /[^\\x20-\\x7E]/, // unprintable ASCII chars + non-ASCII chars\n\tregexSeparators = /[\\x2E\\u3002\\uFF0E\\uFF61]/g, // RFC 3490 separators\n\n\t/** Error messages */\n\terrors = {\n\t\t'overflow': 'Overflow: input needs wider integers to process',\n\t\t'not-basic': 'Illegal input >= 0x80 (not a basic code point)',\n\t\t'invalid-input': 'Invalid input'\n\t},\n\n\t/** Convenience shortcuts */\n\tbaseMinusTMin = base - tMin,\n\tfloor = Math.floor,\n\tstringFromCharCode = String.fromCharCode,\n\n\t/** Temporary variable */\n\tkey;\n\n\t/*--------------------------------------------------------------------------*/\n\n\t/**\n\t * A generic error utility function.\n\t * @private\n\t * @param {String} type The error type.\n\t * @returns {Error} Throws a `RangeError` with the applicable error message.\n\t */\n\tfunction error(type) {\n\t\tthrow new RangeError(errors[type]);\n\t}\n\n\t/**\n\t * A generic `Array#map` utility function.\n\t * @private\n\t * @param {Array} array The array to iterate over.\n\t * @param {Function} callback The function that gets called for every array\n\t * item.\n\t * @returns {Array} A new array of values returned by the callback function.\n\t */\n\tfunction map(array, fn) {\n\t\tvar length = array.length;\n\t\tvar result = [];\n\t\twhile (length--) {\n\t\t\tresult[length] = fn(array[length]);\n\t\t}\n\t\treturn result;\n\t}\n\n\t/**\n\t * A simple `Array#map`-like wrapper to work with domain name strings or email\n\t * addresses.\n\t * @private\n\t * @param {String} domain The domain name or email address.\n\t * @param {Function} callback The function that gets called for every\n\t * character.\n\t * @returns {Array} A new string of characters returned by the callback\n\t * function.\n\t */\n\tfunction mapDomain(string, fn) {\n\t\tvar parts = string.split('@');\n\t\tvar result = '';\n\t\tif (parts.length > 1) {\n\t\t\t// In email addresses, only the domain name should be punycoded. Leave\n\t\t\t// the local part (i.e. everything up to `@`) intact.\n\t\t\tresult = parts[0] + '@';\n\t\t\tstring = parts[1];\n\t\t}\n\t\t// Avoid `split(regex)` for IE8 compatibility. See #17.\n\t\tstring = string.replace(regexSeparators, '\\x2E');\n\t\tvar labels = string.split('.');\n\t\tvar encoded = map(labels, fn).join('.');\n\t\treturn result + encoded;\n\t}\n\n\t/**\n\t * Creates an array containing the numeric code points of each Unicode\n\t * character in the string. While JavaScript uses UCS-2 internally,\n\t * this function will convert a pair of surrogate halves (each of which\n\t * UCS-2 exposes as separate characters) into a single code point,\n\t * matching UTF-16.\n\t * @see `punycode.ucs2.encode`\n\t * @see <https://mathiasbynens.be/notes/javascript-encoding>\n\t * @memberOf punycode.ucs2\n\t * @name decode\n\t * @param {String} string The Unicode input string (UCS-2).\n\t * @returns {Array} The new array of code points.\n\t */\n\tfunction ucs2decode(string) {\n\t\tvar output = [],\n\t\t    counter = 0,\n\t\t    length = string.length,\n\t\t    value,\n\t\t    extra;\n\t\twhile (counter < length) {\n\t\t\tvalue = string.charCodeAt(counter++);\n\t\t\tif (value >= 0xD800 && value <= 0xDBFF && counter < length) {\n\t\t\t\t// high surrogate, and there is a next character\n\t\t\t\textra = string.charCodeAt(counter++);\n\t\t\t\tif ((extra & 0xFC00) == 0xDC00) { // low surrogate\n\t\t\t\t\toutput.push(((value & 0x3FF) << 10) + (extra & 0x3FF) + 0x10000);\n\t\t\t\t} else {\n\t\t\t\t\t// unmatched surrogate; only append this code unit, in case the next\n\t\t\t\t\t// code unit is the high surrogate of a surrogate pair\n\t\t\t\t\toutput.push(value);\n\t\t\t\t\tcounter--;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\toutput.push(value);\n\t\t\t}\n\t\t}\n\t\treturn output;\n\t}\n\n\t/**\n\t * Creates a string based on an array of numeric code points.\n\t * @see `punycode.ucs2.decode`\n\t * @memberOf punycode.ucs2\n\t * @name encode\n\t * @param {Array} codePoints The array of numeric code points.\n\t * @returns {String} The new Unicode string (UCS-2).\n\t */\n\tfunction ucs2encode(array) {\n\t\treturn map(array, function(value) {\n\t\t\tvar output = '';\n\t\t\tif (value > 0xFFFF) {\n\t\t\t\tvalue -= 0x10000;\n\t\t\t\toutput += stringFromCharCode(value >>> 10 & 0x3FF | 0xD800);\n\t\t\t\tvalue = 0xDC00 | value & 0x3FF;\n\t\t\t}\n\t\t\toutput += stringFromCharCode(value);\n\t\t\treturn output;\n\t\t}).join('');\n\t}\n\n\t/**\n\t * Converts a basic code point into a digit/integer.\n\t * @see `digitToBasic()`\n\t * @private\n\t * @param {Number} codePoint The basic numeric code point value.\n\t * @returns {Number} The numeric value of a basic code point (for use in\n\t * representing integers) in the range `0` to `base - 1`, or `base` if\n\t * the code point does not represent a value.\n\t */\n\tfunction basicToDigit(codePoint) {\n\t\tif (codePoint - 48 < 10) {\n\t\t\treturn codePoint - 22;\n\t\t}\n\t\tif (codePoint - 65 < 26) {\n\t\t\treturn codePoint - 65;\n\t\t}\n\t\tif (codePoint - 97 < 26) {\n\t\t\treturn codePoint - 97;\n\t\t}\n\t\treturn base;\n\t}\n\n\t/**\n\t * Converts a digit/integer into a basic code point.\n\t * @see `basicToDigit()`\n\t * @private\n\t * @param {Number} digit The numeric value of a basic code point.\n\t * @returns {Number} The basic code point whose value (when used for\n\t * representing integers) is `digit`, which needs to be in the range\n\t * `0` to `base - 1`. If `flag` is non-zero, the uppercase form is\n\t * used; else, the lowercase form is used. The behavior is undefined\n\t * if `flag` is non-zero and `digit` has no uppercase form.\n\t */\n\tfunction digitToBasic(digit, flag) {\n\t\t//  0..25 map to ASCII a..z or A..Z\n\t\t// 26..35 map to ASCII 0..9\n\t\treturn digit + 22 + 75 * (digit < 26) - ((flag != 0) << 5);\n\t}\n\n\t/**\n\t * Bias adaptation function as per section 3.4 of RFC 3492.\n\t * https://tools.ietf.org/html/rfc3492#section-3.4\n\t * @private\n\t */\n\tfunction adapt(delta, numPoints, firstTime) {\n\t\tvar k = 0;\n\t\tdelta = firstTime ? floor(delta / damp) : delta >> 1;\n\t\tdelta += floor(delta / numPoints);\n\t\tfor (/* no initialization */; delta > baseMinusTMin * tMax >> 1; k += base) {\n\t\t\tdelta = floor(delta / baseMinusTMin);\n\t\t}\n\t\treturn floor(k + (baseMinusTMin + 1) * delta / (delta + skew));\n\t}\n\n\t/**\n\t * Converts a Punycode string of ASCII-only symbols to a string of Unicode\n\t * symbols.\n\t * @memberOf punycode\n\t * @param {String} input The Punycode string of ASCII-only symbols.\n\t * @returns {String} The resulting string of Unicode symbols.\n\t */\n\tfunction decode(input) {\n\t\t// Don't use UCS-2\n\t\tvar output = [],\n\t\t    inputLength = input.length,\n\t\t    out,\n\t\t    i = 0,\n\t\t    n = initialN,\n\t\t    bias = initialBias,\n\t\t    basic,\n\t\t    j,\n\t\t    index,\n\t\t    oldi,\n\t\t    w,\n\t\t    k,\n\t\t    digit,\n\t\t    t,\n\t\t    /** Cached calculation results */\n\t\t    baseMinusT;\n\n\t\t// Handle the basic code points: let `basic` be the number of input code\n\t\t// points before the last delimiter, or `0` if there is none, then copy\n\t\t// the first basic code points to the output.\n\n\t\tbasic = input.lastIndexOf(delimiter);\n\t\tif (basic < 0) {\n\t\t\tbasic = 0;\n\t\t}\n\n\t\tfor (j = 0; j < basic; ++j) {\n\t\t\t// if it's not a basic code point\n\t\t\tif (input.charCodeAt(j) >= 0x80) {\n\t\t\t\terror('not-basic');\n\t\t\t}\n\t\t\toutput.push(input.charCodeAt(j));\n\t\t}\n\n\t\t// Main decoding loop: start just after the last delimiter if any basic code\n\t\t// points were copied; start at the beginning otherwise.\n\n\t\tfor (index = basic > 0 ? basic + 1 : 0; index < inputLength; /* no final expression */) {\n\n\t\t\t// `index` is the index of the next character to be consumed.\n\t\t\t// Decode a generalized variable-length integer into `delta`,\n\t\t\t// which gets added to `i`. The overflow checking is easier\n\t\t\t// if we increase `i` as we go, then subtract off its starting\n\t\t\t// value at the end to obtain `delta`.\n\t\t\tfor (oldi = i, w = 1, k = base; /* no condition */; k += base) {\n\n\t\t\t\tif (index >= inputLength) {\n\t\t\t\t\terror('invalid-input');\n\t\t\t\t}\n\n\t\t\t\tdigit = basicToDigit(input.charCodeAt(index++));\n\n\t\t\t\tif (digit >= base || digit > floor((maxInt - i) / w)) {\n\t\t\t\t\terror('overflow');\n\t\t\t\t}\n\n\t\t\t\ti += digit * w;\n\t\t\t\tt = k <= bias ? tMin : (k >= bias + tMax ? tMax : k - bias);\n\n\t\t\t\tif (digit < t) {\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\n\t\t\t\tbaseMinusT = base - t;\n\t\t\t\tif (w > floor(maxInt / baseMinusT)) {\n\t\t\t\t\terror('overflow');\n\t\t\t\t}\n\n\t\t\t\tw *= baseMinusT;\n\n\t\t\t}\n\n\t\t\tout = output.length + 1;\n\t\t\tbias = adapt(i - oldi, out, oldi == 0);\n\n\t\t\t// `i` was supposed to wrap around from `out` to `0`,\n\t\t\t// incrementing `n` each time, so we'll fix that now:\n\t\t\tif (floor(i / out) > maxInt - n) {\n\t\t\t\terror('overflow');\n\t\t\t}\n\n\t\t\tn += floor(i / out);\n\t\t\ti %= out;\n\n\t\t\t// Insert `n` at position `i` of the output\n\t\t\toutput.splice(i++, 0, n);\n\n\t\t}\n\n\t\treturn ucs2encode(output);\n\t}\n\n\t/**\n\t * Converts a string of Unicode symbols (e.g. a domain name label) to a\n\t * Punycode string of ASCII-only symbols.\n\t * @memberOf punycode\n\t * @param {String} input The string of Unicode symbols.\n\t * @returns {String} The resulting Punycode string of ASCII-only symbols.\n\t */\n\tfunction encode(input) {\n\t\tvar n,\n\t\t    delta,\n\t\t    handledCPCount,\n\t\t    basicLength,\n\t\t    bias,\n\t\t    j,\n\t\t    m,\n\t\t    q,\n\t\t    k,\n\t\t    t,\n\t\t    currentValue,\n\t\t    output = [],\n\t\t    /** `inputLength` will hold the number of code points in `input`. */\n\t\t    inputLength,\n\t\t    /** Cached calculation results */\n\t\t    handledCPCountPlusOne,\n\t\t    baseMinusT,\n\t\t    qMinusT;\n\n\t\t// Convert the input in UCS-2 to Unicode\n\t\tinput = ucs2decode(input);\n\n\t\t// Cache the length\n\t\tinputLength = input.length;\n\n\t\t// Initialize the state\n\t\tn = initialN;\n\t\tdelta = 0;\n\t\tbias = initialBias;\n\n\t\t// Handle the basic code points\n\t\tfor (j = 0; j < inputLength; ++j) {\n\t\t\tcurrentValue = input[j];\n\t\t\tif (currentValue < 0x80) {\n\t\t\t\toutput.push(stringFromCharCode(currentValue));\n\t\t\t}\n\t\t}\n\n\t\thandledCPCount = basicLength = output.length;\n\n\t\t// `handledCPCount` is the number of code points that have been handled;\n\t\t// `basicLength` is the number of basic code points.\n\n\t\t// Finish the basic string - if it is not empty - with a delimiter\n\t\tif (basicLength) {\n\t\t\toutput.push(delimiter);\n\t\t}\n\n\t\t// Main encoding loop:\n\t\twhile (handledCPCount < inputLength) {\n\n\t\t\t// All non-basic code points < n have been handled already. Find the next\n\t\t\t// larger one:\n\t\t\tfor (m = maxInt, j = 0; j < inputLength; ++j) {\n\t\t\t\tcurrentValue = input[j];\n\t\t\t\tif (currentValue >= n && currentValue < m) {\n\t\t\t\t\tm = currentValue;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Increase `delta` enough to advance the decoder's <n,i> state to <m,0>,\n\t\t\t// but guard against overflow\n\t\t\thandledCPCountPlusOne = handledCPCount + 1;\n\t\t\tif (m - n > floor((maxInt - delta) / handledCPCountPlusOne)) {\n\t\t\t\terror('overflow');\n\t\t\t}\n\n\t\t\tdelta += (m - n) * handledCPCountPlusOne;\n\t\t\tn = m;\n\n\t\t\tfor (j = 0; j < inputLength; ++j) {\n\t\t\t\tcurrentValue = input[j];\n\n\t\t\t\tif (currentValue < n && ++delta > maxInt) {\n\t\t\t\t\terror('overflow');\n\t\t\t\t}\n\n\t\t\t\tif (currentValue == n) {\n\t\t\t\t\t// Represent delta as a generalized variable-length integer\n\t\t\t\t\tfor (q = delta, k = base; /* no condition */; k += base) {\n\t\t\t\t\t\tt = k <= bias ? tMin : (k >= bias + tMax ? tMax : k - bias);\n\t\t\t\t\t\tif (q < t) {\n\t\t\t\t\t\t\tbreak;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tqMinusT = q - t;\n\t\t\t\t\t\tbaseMinusT = base - t;\n\t\t\t\t\t\toutput.push(\n\t\t\t\t\t\t\tstringFromCharCode(digitToBasic(t + qMinusT % baseMinusT, 0))\n\t\t\t\t\t\t);\n\t\t\t\t\t\tq = floor(qMinusT / baseMinusT);\n\t\t\t\t\t}\n\n\t\t\t\t\toutput.push(stringFromCharCode(digitToBasic(q, 0)));\n\t\t\t\t\tbias = adapt(delta, handledCPCountPlusOne, handledCPCount == basicLength);\n\t\t\t\t\tdelta = 0;\n\t\t\t\t\t++handledCPCount;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t++delta;\n\t\t\t++n;\n\n\t\t}\n\t\treturn output.join('');\n\t}\n\n\t/**\n\t * Converts a Punycode string representing a domain name or an email address\n\t * to Unicode. Only the Punycoded parts of the input will be converted, i.e.\n\t * it doesn't matter if you call it on a string that has already been\n\t * converted to Unicode.\n\t * @memberOf punycode\n\t * @param {String} input The Punycoded domain name or email address to\n\t * convert to Unicode.\n\t * @returns {String} The Unicode representation of the given Punycode\n\t * string.\n\t */\n\tfunction toUnicode(input) {\n\t\treturn mapDomain(input, function(string) {\n\t\t\treturn regexPunycode.test(string)\n\t\t\t\t? decode(string.slice(4).toLowerCase())\n\t\t\t\t: string;\n\t\t});\n\t}\n\n\t/**\n\t * Converts a Unicode string representing a domain name or an email address to\n\t * Punycode. Only the non-ASCII parts of the domain name will be converted,\n\t * i.e. it doesn't matter if you call it with a domain that's already in\n\t * ASCII.\n\t * @memberOf punycode\n\t * @param {String} input The domain name or email address to convert, as a\n\t * Unicode string.\n\t * @returns {String} The Punycode representation of the given domain name or\n\t * email address.\n\t */\n\tfunction toASCII(input) {\n\t\treturn mapDomain(input, function(string) {\n\t\t\treturn regexNonASCII.test(string)\n\t\t\t\t? 'xn--' + encode(string)\n\t\t\t\t: string;\n\t\t});\n\t}\n\n\t/*--------------------------------------------------------------------------*/\n\n\t/** Define the public API */\n\tpunycode = {\n\t\t/**\n\t\t * A string representing the current Punycode.js version number.\n\t\t * @memberOf punycode\n\t\t * @type String\n\t\t */\n\t\t'version': '1.4.1',\n\t\t/**\n\t\t * An object of methods to convert from JavaScript's internal character\n\t\t * representation (UCS-2) to Unicode code points, and back.\n\t\t * @see <https://mathiasbynens.be/notes/javascript-encoding>\n\t\t * @memberOf punycode\n\t\t * @type Object\n\t\t */\n\t\t'ucs2': {\n\t\t\t'decode': ucs2decode,\n\t\t\t'encode': ucs2encode\n\t\t},\n\t\t'decode': decode,\n\t\t'encode': encode,\n\t\t'toASCII': toASCII,\n\t\t'toUnicode': toUnicode\n\t};\n\n\t/** Expose `punycode` */\n\t// Some AMD build optimizers, like r.js, check for specific condition patterns\n\t// like the following:\n\tif (\n\t\ttypeof define == 'function' &&\n\t\ttypeof define.amd == 'object' &&\n\t\tdefine.amd\n\t) {\n\t\tdefine('punycode', function() {\n\t\t\treturn punycode;\n\t\t});\n\t} else if (freeExports && freeModule) {\n\t\tif (module.exports == freeExports) {\n\t\t\t// in Node.js, io.js, or RingoJS v0.8.0+\n\t\t\tfreeModule.exports = punycode;\n\t\t} else {\n\t\t\t// in Narwhal or RingoJS v0.7.0-\n\t\t\tfor (key in punycode) {\n\t\t\t\tpunycode.hasOwnProperty(key) && (freeExports[key] = punycode[key]);\n\t\t\t}\n\t\t}\n\t} else {\n\t\t// in Rhino or a web browser\n\t\troot.punycode = punycode;\n\t}\n\n}(this));\n","module.exports = function(module) {\n\tif (!module.webpackPolyfill) {\n\t\tmodule.deprecate = function() {};\n\t\tmodule.paths = [];\n\t\t// module.parent = undefined by default\n\t\tif (!module.children) module.children = [];\n\t\tObject.defineProperty(module, \"loaded\", {\n\t\t\tenumerable: true,\n\t\t\tget: function() {\n\t\t\t\treturn module.l;\n\t\t\t}\n\t\t});\n\t\tObject.defineProperty(module, \"id\", {\n\t\t\tenumerable: true,\n\t\t\tget: function() {\n\t\t\t\treturn module.i;\n\t\t\t}\n\t\t});\n\t\tmodule.webpackPolyfill = 1;\n\t}\n\treturn module;\n};\n","'use strict';\n\nmodule.exports = {\n  isString: function(arg) {\n    return typeof(arg) === 'string';\n  },\n  isObject: function(arg) {\n    return typeof(arg) === 'object' && arg !== null;\n  },\n  isNull: function(arg) {\n    return arg === null;\n  },\n  isNullOrUndefined: function(arg) {\n    return arg == null;\n  }\n};\n","'use strict';\n\nexports.decode = exports.parse = require('./decode');\nexports.encode = exports.stringify = require('./encode');\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\n// If obj.hasOwnProperty has been overridden, then calling\n// obj.hasOwnProperty(prop) will break.\n// See: https://github.com/joyent/node/issues/1707\nfunction hasOwnProperty(obj, prop) {\n  return Object.prototype.hasOwnProperty.call(obj, prop);\n}\n\nmodule.exports = function(qs, sep, eq, options) {\n  sep = sep || '&';\n  eq = eq || '=';\n  var obj = {};\n\n  if (typeof qs !== 'string' || qs.length === 0) {\n    return obj;\n  }\n\n  var regexp = /\\+/g;\n  qs = qs.split(sep);\n\n  var maxKeys = 1000;\n  if (options && typeof options.maxKeys === 'number') {\n    maxKeys = options.maxKeys;\n  }\n\n  var len = qs.length;\n  // maxKeys <= 0 means that we should not limit keys count\n  if (maxKeys > 0 && len > maxKeys) {\n    len = maxKeys;\n  }\n\n  for (var i = 0; i < len; ++i) {\n    var x = qs[i].replace(regexp, '%20'),\n        idx = x.indexOf(eq),\n        kstr, vstr, k, v;\n\n    if (idx >= 0) {\n      kstr = x.substr(0, idx);\n      vstr = x.substr(idx + 1);\n    } else {\n      kstr = x;\n      vstr = '';\n    }\n\n    k = decodeURIComponent(kstr);\n    v = decodeURIComponent(vstr);\n\n    if (!hasOwnProperty(obj, k)) {\n      obj[k] = v;\n    } else if (isArray(obj[k])) {\n      obj[k].push(v);\n    } else {\n      obj[k] = [obj[k], v];\n    }\n  }\n\n  return obj;\n};\n\nvar isArray = Array.isArray || function (xs) {\n  return Object.prototype.toString.call(xs) === '[object Array]';\n};\n","// Copyright Joyent, Inc. and other Node contributors.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a\n// copy of this software and associated documentation files (the\n// \"Software\"), to deal in the Software without restriction, including\n// without limitation the rights to use, copy, modify, merge, publish,\n// distribute, sublicense, and/or sell copies of the Software, and to permit\n// persons to whom the Software is furnished to do so, subject to the\n// following conditions:\n//\n// The above copyright notice and this permission notice shall be included\n// in all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS\n// OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF\n// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN\n// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,\n// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR\n// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE\n// USE OR OTHER DEALINGS IN THE SOFTWARE.\n\n'use strict';\n\nvar stringifyPrimitive = function(v) {\n  switch (typeof v) {\n    case 'string':\n      return v;\n\n    case 'boolean':\n      return v ? 'true' : 'false';\n\n    case 'number':\n      return isFinite(v) ? v : '';\n\n    default:\n      return '';\n  }\n};\n\nmodule.exports = function(obj, sep, eq, name) {\n  sep = sep || '&';\n  eq = eq || '=';\n  if (obj === null) {\n    obj = undefined;\n  }\n\n  if (typeof obj === 'object') {\n    return map(objectKeys(obj), function(k) {\n      var ks = encodeURIComponent(stringifyPrimitive(k)) + eq;\n      if (isArray(obj[k])) {\n        return map(obj[k], function(v) {\n          return ks + encodeURIComponent(stringifyPrimitive(v));\n        }).join(sep);\n      } else {\n        return ks + encodeURIComponent(stringifyPrimitive(obj[k]));\n      }\n    }).join(sep);\n\n  }\n\n  if (!name) return '';\n  return encodeURIComponent(stringifyPrimitive(name)) + eq +\n         encodeURIComponent(stringifyPrimitive(obj));\n};\n\nvar isArray = Array.isArray || function (xs) {\n  return Object.prototype.toString.call(xs) === '[object Array]';\n};\n\nfunction map (xs, f) {\n  if (xs.map) return xs.map(f);\n  var res = [];\n  for (var i = 0; i < xs.length; i++) {\n    res.push(f(xs[i], i));\n  }\n  return res;\n}\n\nvar objectKeys = Object.keys || function (obj) {\n  var res = [];\n  for (var key in obj) {\n    if (Object.prototype.hasOwnProperty.call(obj, key)) res.push(key);\n  }\n  return res;\n};\n","'use strict';\n\nvar helpers = require('./helpers');\n\n/** @type ValidatorResult */\nvar ValidatorResult = helpers.ValidatorResult;\n/** @type SchemaError */\nvar SchemaError = helpers.SchemaError;\n\nvar attribute = {};\n\nattribute.ignoreProperties = {\n  // informative properties\n  'id': true,\n  'default': true,\n  'description': true,\n  'title': true,\n  // arguments to other properties\n  'exclusiveMinimum': true,\n  'exclusiveMaximum': true,\n  'additionalItems': true,\n  // special-handled properties\n  '$schema': true,\n  '$ref': true,\n  'extends': true\n};\n\n/**\n * @name validators\n */\nvar validators = attribute.validators = {};\n\n/**\n * Validates whether the instance if of a certain type\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {ValidatorResult|null}\n */\nvalidators.type = function validateType (instance, schema, options, ctx) {\n  // Ignore undefined instances\n  if (instance === undefined) {\n    return null;\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var types = Array.isArray(schema.type) ? schema.type : [schema.type];\n  if (!types.some(this.testType.bind(this, instance, schema, options, ctx))) {\n    var list = types.map(function (v) {\n      return v.id && ('<' + v.id + '>') || (v+'');\n    });\n    result.addError({\n      name: 'type',\n      argument: list,\n      message: \"is not of a type(s) \" + list,\n    });\n  }\n  return result;\n};\n\nfunction testSchemaNoThrow(instance, options, ctx, callback, schema){\n  var throwError = options.throwError;\n  options.throwError = false;\n  var res = this.validateSchema(instance, schema, options, ctx);\n  options.throwError = throwError;\n\n  if (! res.valid && callback instanceof Function) {\n    callback(res);\n  }\n  return res.valid;\n}\n\n/**\n * Validates whether the instance matches some of the given schemas\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {ValidatorResult|null}\n */\nvalidators.anyOf = function validateAnyOf (instance, schema, options, ctx) {\n  // Ignore undefined instances\n  if (instance === undefined) {\n    return null;\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var inner = new ValidatorResult(instance, schema, options, ctx);\n  if (!Array.isArray(schema.anyOf)){\n    throw new SchemaError(\"anyOf must be an array\");\n  }\n  if (!schema.anyOf.some(\n    testSchemaNoThrow.bind(\n      this, instance, options, ctx, function(res){inner.importErrors(res);}\n      ))) {\n    var list = schema.anyOf.map(function (v, i) {\n      return (v.id && ('<' + v.id + '>')) || (v.title && JSON.stringify(v.title)) || (v['$ref'] && ('<' + v['$ref'] + '>')) || '[subschema '+i+']';\n    });\n    if (options.nestedErrors) {\n      result.importErrors(inner);\n    }\n    result.addError({\n      name: 'anyOf',\n      argument: list,\n      message: \"is not any of \" + list.join(','),\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance matches every given schema\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null}\n */\nvalidators.allOf = function validateAllOf (instance, schema, options, ctx) {\n  // Ignore undefined instances\n  if (instance === undefined) {\n    return null;\n  }\n  if (!Array.isArray(schema.allOf)){\n    throw new SchemaError(\"allOf must be an array\");\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var self = this;\n  schema.allOf.forEach(function(v, i){\n    var valid = self.validateSchema(instance, v, options, ctx);\n    if(!valid.valid){\n      var msg = (v.id && ('<' + v.id + '>')) || (v.title && JSON.stringify(v.title)) || (v['$ref'] && ('<' + v['$ref'] + '>')) || '[subschema '+i+']';\n      result.addError({\n        name: 'allOf',\n        argument: { id: msg, length: valid.errors.length, valid: valid },\n        message: 'does not match allOf schema ' + msg + ' with ' + valid.errors.length + ' error[s]:',\n      });\n      result.importErrors(valid);\n    }\n  });\n  return result;\n};\n\n/**\n * Validates whether the instance matches exactly one of the given schemas\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null}\n */\nvalidators.oneOf = function validateOneOf (instance, schema, options, ctx) {\n  // Ignore undefined instances\n  if (instance === undefined) {\n    return null;\n  }\n  if (!Array.isArray(schema.oneOf)){\n    throw new SchemaError(\"oneOf must be an array\");\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var inner = new ValidatorResult(instance, schema, options, ctx);\n  var count = schema.oneOf.filter(\n    testSchemaNoThrow.bind(\n      this, instance, options, ctx, function(res) {inner.importErrors(res);}\n      ) ).length;\n  var list = schema.oneOf.map(function (v, i) {\n    return (v.id && ('<' + v.id + '>')) || (v.title && JSON.stringify(v.title)) || (v['$ref'] && ('<' + v['$ref'] + '>')) || '[subschema '+i+']';\n  });\n  if (count!==1) {\n    if (options.nestedErrors) {\n      result.importErrors(inner);\n    }\n    result.addError({\n      name: 'oneOf',\n      argument: list,\n      message: \"is not exactly one from \" + list.join(','),\n    });\n  }\n  return result;\n};\n\n/**\n * Validates properties\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null|ValidatorResult}\n */\nvalidators.properties = function validateProperties (instance, schema, options, ctx) {\n  if(!this.types.object(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var properties = schema.properties || {};\n  for (var property in properties) {\n    if (typeof options.preValidateProperty == 'function') {\n      options.preValidateProperty(instance, property, properties[property], options, ctx);\n    }\n\n    var prop = Object.hasOwnProperty.call(instance, property) ? instance[property] : undefined;\n    var res = this.validateSchema(prop, properties[property], options, ctx.makeChild(properties[property], property));\n    if(res.instance !== result.instance[property]) result.instance[property] = res.instance;\n    result.importErrors(res);\n  }\n  return result;\n};\n\n/**\n * Test a specific property within in instance against the additionalProperties schema attribute\n * This ignores properties with definitions in the properties schema attribute, but no other attributes.\n * If too many more types of property-existance tests pop up they may need their own class of tests (like `type` has)\n * @private\n * @return {boolean}\n */\nfunction testAdditionalProperty (instance, schema, options, ctx, property, result) {\n  if(!this.types.object(instance)) return;\n  if (schema.properties && schema.properties[property] !== undefined) {\n    return;\n  }\n  if (schema.additionalProperties === false) {\n    result.addError({\n      name: 'additionalProperties',\n      argument: property,\n      message: \"additionalProperty \" + JSON.stringify(property) + \" exists in instance when not allowed\",\n    });\n  } else {\n    var additionalProperties = schema.additionalProperties || {};\n\n    if (typeof options.preValidateProperty == 'function') {\n      options.preValidateProperty(instance, property, additionalProperties, options, ctx);\n    }\n\n    var res = this.validateSchema(instance[property], additionalProperties, options, ctx.makeChild(additionalProperties, property));\n    if(res.instance !== result.instance[property]) result.instance[property] = res.instance;\n    result.importErrors(res);\n  }\n}\n\n/**\n * Validates patternProperties\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null|ValidatorResult}\n */\nvalidators.patternProperties = function validatePatternProperties (instance, schema, options, ctx) {\n  if(!this.types.object(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var patternProperties = schema.patternProperties || {};\n\n  for (var property in instance) {\n    var test = true;\n    for (var pattern in patternProperties) {\n      var expr = new RegExp(pattern);\n      if (!expr.test(property)) {\n        continue;\n      }\n      test = false;\n\n      if (typeof options.preValidateProperty == 'function') {\n        options.preValidateProperty(instance, property, patternProperties[pattern], options, ctx);\n      }\n\n      var res = this.validateSchema(instance[property], patternProperties[pattern], options, ctx.makeChild(patternProperties[pattern], property));\n      if(res.instance !== result.instance[property]) result.instance[property] = res.instance;\n      result.importErrors(res);\n    }\n    if (test) {\n      testAdditionalProperty.call(this, instance, schema, options, ctx, property, result);\n    }\n  }\n\n  return result;\n};\n\n/**\n * Validates additionalProperties\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null|ValidatorResult}\n */\nvalidators.additionalProperties = function validateAdditionalProperties (instance, schema, options, ctx) {\n  if(!this.types.object(instance)) return;\n  // if patternProperties is defined then we'll test when that one is called instead\n  if (schema.patternProperties) {\n    return null;\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  for (var property in instance) {\n    testAdditionalProperty.call(this, instance, schema, options, ctx, property, result);\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value is at least of a certain length, when the instance value is a string.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.minProperties = function validateMinProperties (instance, schema, options, ctx) {\n  if (!this.types.object(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var keys = Object.keys(instance);\n  if (!(keys.length >= schema.minProperties)) {\n    result.addError({\n      name: 'minProperties',\n      argument: schema.minProperties,\n      message: \"does not meet minimum property length of \" + schema.minProperties,\n    })\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value is at most of a certain length, when the instance value is a string.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.maxProperties = function validateMaxProperties (instance, schema, options, ctx) {\n  if (!this.types.object(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var keys = Object.keys(instance);\n  if (!(keys.length <= schema.maxProperties)) {\n    result.addError({\n      name: 'maxProperties',\n      argument: schema.maxProperties,\n      message: \"does not meet maximum property length of \" + schema.maxProperties,\n    });\n  }\n  return result;\n};\n\n/**\n * Validates items when instance is an array\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null|ValidatorResult}\n */\nvalidators.items = function validateItems (instance, schema, options, ctx) {\n  var self = this;\n  if (!this.types.array(instance)) return;\n  if (!schema.items) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  instance.every(function (value, i) {\n    var items = Array.isArray(schema.items) ? (schema.items[i] || schema.additionalItems) : schema.items;\n    if (items === undefined) {\n      return true;\n    }\n    if (items === false) {\n      result.addError({\n        name: 'items',\n        message: \"additionalItems not permitted\",\n      });\n      return false;\n    }\n    var res = self.validateSchema(value, items, options, ctx.makeChild(items, i));\n    if(res.instance !== result.instance[i]) result.instance[i] = res.instance;\n    result.importErrors(res);\n    return true;\n  });\n  return result;\n};\n\n/**\n * Validates minimum and exclusiveMinimum when the type of the instance value is a number.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.minimum = function validateMinimum (instance, schema, options, ctx) {\n  if (!this.types.number(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var valid = true;\n  if (schema.exclusiveMinimum && schema.exclusiveMinimum === true) {\n    valid = instance > schema.minimum;\n  } else {\n    valid = instance >= schema.minimum;\n  }\n  if (!valid) {\n    result.addError({\n      name: 'minimum',\n      argument: schema.minimum,\n      message: \"must have a minimum value of \" + schema.minimum,\n    });\n  }\n  return result;\n};\n\n/**\n * Validates maximum and exclusiveMaximum when the type of the instance value is a number.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.maximum = function validateMaximum (instance, schema, options, ctx) {\n  if (!this.types.number(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var valid;\n  if (schema.exclusiveMaximum && schema.exclusiveMaximum === true) {\n    valid = instance < schema.maximum;\n  } else {\n    valid = instance <= schema.maximum;\n  }\n  if (!valid) {\n    result.addError({\n      name: 'maximum',\n      argument: schema.maximum,\n      message: \"must have a maximum value of \" + schema.maximum,\n    });\n  }\n  return result;\n};\n\n/**\n * Perform validation for multipleOf and divisibleBy, which are essentially the same.\n * @param instance\n * @param schema\n * @param validationType\n * @param errorMessage\n * @returns {String|null}\n */\nvar validateMultipleOfOrDivisbleBy = function validateMultipleOfOrDivisbleBy (instance, schema, options, ctx, validationType, errorMessage) {\n  if (!this.types.number(instance)) return;\n\n  var validationArgument = schema[validationType];\n  if (validationArgument == 0) {\n    throw new SchemaError(validationType + \" cannot be zero\");\n  }\n\n  var result = new ValidatorResult(instance, schema, options, ctx);\n\n  var instanceDecimals = helpers.getDecimalPlaces(instance);\n  var divisorDecimals = helpers.getDecimalPlaces(validationArgument);\n\n  var maxDecimals = Math.max(instanceDecimals , divisorDecimals);\n  var multiplier = Math.pow(10, maxDecimals);\n\n  if (Math.round(instance * multiplier) % Math.round(validationArgument * multiplier) !== 0) {\n    result.addError({\n      name: validationType,\n      argument:  validationArgument,\n      message: errorMessage + JSON.stringify(validationArgument)\n    });\n  }\n\n  return result;\n};\n\n/**\n * Validates divisibleBy when the type of the instance value is a number.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.multipleOf = function validateMultipleOf (instance, schema, options, ctx) {\n return validateMultipleOfOrDivisbleBy.call(this, instance, schema, options, ctx, \"multipleOf\", \"is not a multiple of (divisible by) \");\n};\n\n/**\n * Validates multipleOf when the type of the instance value is a number.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.divisibleBy = function validateDivisibleBy (instance, schema, options, ctx) {\n  return validateMultipleOfOrDivisbleBy.call(this, instance, schema, options, ctx, \"divisibleBy\", \"is not divisible by (multiple of) \");\n};\n\n/**\n * Validates whether the instance value is present.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.required = function validateRequired (instance, schema, options, ctx) {\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (instance === undefined && schema.required === true) {\n    // A boolean form is implemented for reverse-compatability with schemas written against older drafts\n    result.addError({\n      name: 'required',\n      message: \"is required\"\n    });\n  } else if (this.types.object(instance) && Array.isArray(schema.required)) {\n    schema.required.forEach(function(n){\n      if(instance[n]===undefined){\n        result.addError({\n          name: 'required',\n          argument: n,\n          message: \"requires property \" + JSON.stringify(n),\n        });\n      }\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value matches the regular expression, when the instance value is a string.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.pattern = function validatePattern (instance, schema, options, ctx) {\n  if (!this.types.string(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!instance.match(schema.pattern)) {\n    result.addError({\n      name: 'pattern',\n      argument: schema.pattern,\n      message: \"does not match pattern \" + JSON.stringify(schema.pattern),\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value is of a certain defined format or a custom\n * format.\n * The following formats are supported for string types:\n *   - date-time\n *   - date\n *   - time\n *   - ip-address\n *   - ipv6\n *   - uri\n *   - color\n *   - host-name\n *   - alpha\n *   - alpha-numeric\n *   - utc-millisec\n * @param instance\n * @param schema\n * @param [options]\n * @param [ctx]\n * @return {String|null}\n */\nvalidators.format = function validateFormat (instance, schema, options, ctx) {\n  if (instance===undefined) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!result.disableFormat && !helpers.isFormat(instance, schema.format, this)) {\n    result.addError({\n      name: 'format',\n      argument: schema.format,\n      message: \"does not conform to the \" + JSON.stringify(schema.format) + \" format\",\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value is at least of a certain length, when the instance value is a string.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.minLength = function validateMinLength (instance, schema, options, ctx) {\n  if (!this.types.string(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var hsp = instance.match(/[\\uDC00-\\uDFFF]/g);\n  var length = instance.length - (hsp ? hsp.length : 0);\n  if (!(length >= schema.minLength)) {\n    result.addError({\n      name: 'minLength',\n      argument: schema.minLength,\n      message: \"does not meet minimum length of \" + schema.minLength,\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value is at most of a certain length, when the instance value is a string.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.maxLength = function validateMaxLength (instance, schema, options, ctx) {\n  if (!this.types.string(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  // TODO if this was already computed in \"minLength\", use that value instead of re-computing\n  var hsp = instance.match(/[\\uDC00-\\uDFFF]/g);\n  var length = instance.length - (hsp ? hsp.length : 0);\n  if (!(length <= schema.maxLength)) {\n    result.addError({\n      name: 'maxLength',\n      argument: schema.maxLength,\n      message: \"does not meet maximum length of \" + schema.maxLength,\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether instance contains at least a minimum number of items, when the instance is an Array.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.minItems = function validateMinItems (instance, schema, options, ctx) {\n  if (!this.types.array(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!(instance.length >= schema.minItems)) {\n    result.addError({\n      name: 'minItems',\n      argument: schema.minItems,\n      message: \"does not meet minimum length of \" + schema.minItems,\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether instance contains no more than a maximum number of items, when the instance is an Array.\n * @param instance\n * @param schema\n * @return {String|null}\n */\nvalidators.maxItems = function validateMaxItems (instance, schema, options, ctx) {\n  if (!this.types.array(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!(instance.length <= schema.maxItems)) {\n    result.addError({\n      name: 'maxItems',\n      argument: schema.maxItems,\n      message: \"does not meet maximum length of \" + schema.maxItems,\n    });\n  }\n  return result;\n};\n\n/**\n * Validates that every item in an instance array is unique, when instance is an array\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {String|null|ValidatorResult}\n */\nvalidators.uniqueItems = function validateUniqueItems (instance, schema, options, ctx) {\n  if (!this.types.array(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  function testArrays (v, i, a) {\n    for (var j = i + 1; j < a.length; j++) if (helpers.deepCompareStrict(v, a[j])) {\n      return false;\n    }\n    return true;\n  }\n  if (!instance.every(testArrays)) {\n    result.addError({\n      name: 'uniqueItems',\n      message: \"contains duplicate item\",\n    });\n  }\n  return result;\n};\n\n/**\n * Deep compares arrays for duplicates\n * @param v\n * @param i\n * @param a\n * @private\n * @return {boolean}\n */\nfunction testArrays (v, i, a) {\n  var j, len = a.length;\n  for (j = i + 1, len; j < len; j++) {\n    if (helpers.deepCompareStrict(v, a[j])) {\n      return false;\n    }\n  }\n  return true;\n}\n\n/**\n * Validates whether there are no duplicates, when the instance is an Array.\n * @param instance\n * @return {String|null}\n */\nvalidators.uniqueItems = function validateUniqueItems (instance, schema, options, ctx) {\n  if (!this.types.array(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!instance.every(testArrays)) {\n    result.addError({\n      name: 'uniqueItems',\n      message: \"contains duplicate item\",\n    });\n  }\n  return result;\n};\n\n/**\n * Validate for the presence of dependency properties, if the instance is an object.\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {null|ValidatorResult}\n */\nvalidators.dependencies = function validateDependencies (instance, schema, options, ctx) {\n  if (!this.types.object(instance)) return;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  for (var property in schema.dependencies) {\n    if (instance[property] === undefined) {\n      continue;\n    }\n    var dep = schema.dependencies[property];\n    var childContext = ctx.makeChild(dep, property);\n    if (typeof dep == 'string') {\n      dep = [dep];\n    }\n    if (Array.isArray(dep)) {\n      dep.forEach(function (prop) {\n        if (instance[prop] === undefined) {\n          result.addError({\n            // FIXME there's two different \"dependencies\" errors here with slightly different outputs\n            // Can we make these the same? Or should we create different error types?\n            name: 'dependencies',\n            argument: childContext.propertyPath,\n            message: \"property \" + prop + \" not found, required by \" + childContext.propertyPath,\n          });\n        }\n      });\n    } else {\n      var res = this.validateSchema(instance, dep, options, childContext);\n      if(result.instance !== res.instance) result.instance = res.instance;\n      if (res && res.errors.length) {\n        result.addError({\n          name: 'dependencies',\n          argument: childContext.propertyPath,\n          message: \"does not meet dependency required by \" + childContext.propertyPath,\n        });\n        result.importErrors(res);\n      }\n    }\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance value is one of the enumerated values.\n *\n * @param instance\n * @param schema\n * @return {ValidatorResult|null}\n */\nvalidators['enum'] = function validateEnum (instance, schema, options, ctx) {\n  if (instance === undefined) {\n    return null;\n  }\n  if (!Array.isArray(schema['enum'])) {\n    throw new SchemaError(\"enum expects an array\", schema);\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!schema['enum'].some(helpers.deepCompareStrict.bind(null, instance))) {\n    result.addError({\n      name: 'enum',\n      argument: schema['enum'],\n      message: \"is not one of enum values: \" + schema['enum'].map(String).join(','),\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance exactly matches a given value\n *\n * @param instance\n * @param schema\n * @return {ValidatorResult|null}\n */\nvalidators['const'] = function validateEnum (instance, schema, options, ctx) {\n  if (instance === undefined) {\n    return null;\n  }\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  if (!helpers.deepCompareStrict(schema['const'], instance)) {\n    result.addError({\n      name: 'const',\n      argument: schema['const'],\n      message: \"does not exactly match expected constant: \" + schema['const'],\n    });\n  }\n  return result;\n};\n\n/**\n * Validates whether the instance if of a prohibited type.\n * @param instance\n * @param schema\n * @param options\n * @param ctx\n * @return {null|ValidatorResult}\n */\nvalidators.not = validators.disallow = function validateNot (instance, schema, options, ctx) {\n  var self = this;\n  if(instance===undefined) return null;\n  var result = new ValidatorResult(instance, schema, options, ctx);\n  var notTypes = schema.not || schema.disallow;\n  if(!notTypes) return null;\n  if(!Array.isArray(notTypes)) notTypes=[notTypes];\n  notTypes.forEach(function (type) {\n    if (self.testType(instance, schema, options, ctx, type)) {\n      var schemaId = type && type.id && ('<' + type.id + '>') || type;\n      result.addError({\n        name: 'not',\n        argument: schemaId,\n        message: \"is of prohibited type \" + schemaId,\n      });\n    }\n  });\n  return result;\n};\n\nmodule.exports = attribute;\n","import * as Notification from './Notification';\nimport NeonView from '../NeonView';\nimport { navbarDropdownMenu, undoRedoPanel } from './EditContents';\nimport { convertStaffToSb } from './ConvertMei';\n\n/**\n * prepare the edit mode button\n */\nexport function prepareEditMode (neonView: NeonView): void {\n  const parent = document.getElementById('dropdown_toggle');\n  const editItem = document.createElement('a');\n  editItem.classList.add('navbar-item');\n  const editButton = document.createElement('button');\n  editButton.classList.add('button');\n  editButton.id = 'edit_mode';\n  editButton.textContent = 'Edit MEI';\n  editItem.appendChild(editButton);\n  parent.appendChild(editItem);\n\n  editButton.addEventListener('click', () => {\n    startEditMode(neonView);\n  });\n}\n\n/**\n * start the basic edit mode features\n * is called when the edit mode button is clicked\n */\nexport function startEditMode (neonView: NeonView): void {\n  const parent: HTMLElement = document.getElementById('dropdown_toggle').parentElement;\n  document.getElementById('dropdown_toggle').remove();\n  parent.prepend(navbarDropdownMenu);\n  document.getElementById('undoRedo_controls').innerHTML = undoRedoPanel;\n  initNavbar(neonView);\n  initUndoRedoPanel(neonView);\n\n  const selectionHighlight = document.createElement('a');\n  const divider = document.createElement('hr');\n  divider.classList.add('dropdown-divider');\n  selectionHighlight.classList.add('dropdown-item');\n  selectionHighlight.id = 'highlight-selection';\n  selectionHighlight.textContent = 'By Selection Mode';\n  (document.getElementsByClassName('dropdown-content'))[0].appendChild(divider);\n  (document.getElementsByClassName('dropdown-content'))[0].appendChild(selectionHighlight);\n}\n\n/**\n * Set listener on switching EditMode button to File dropdown in the navbar.\n */\nexport function initNavbar (neonView: NeonView): void {\n  // setup navbar listeners\n  document.getElementById('save').addEventListener('click', () => {\n    neonView.save().then(() => {\n      Notification.queueNotification('Saved');\n    });\n  });\n  document.body.addEventListener('keydown', (evt) => {\n    if (evt.key === 's') {\n      neonView.save().then(() => {\n        Notification.queueNotification('Saved');\n      });\n    }\n  });\n\n  document.getElementById('export').addEventListener('click', () => {\n    neonView.export().then(manifest => {\n      const link: HTMLAnchorElement = document.createElement('a');\n      link.href = manifest as string;\n      link.download = neonView.name + '.jsonld';\n      document.body.appendChild(link);\n      link.click();\n      link.remove();\n      Notification.queueNotification('Saved');\n    });\n  });\n\n  document.getElementById('revert').addEventListener('click', function () {\n    if (window.confirm('Reverting will cause all changes to be lost. Press OK to continue.')) {\n      neonView.deleteDb().then(() => {\n        window.location.reload();\n      });\n    }\n  });\n  // Download link for MEI\n  // Is an actual file with a valid URI except in local mode where it must be generated.\n  document.getElementById('getmei').addEventListener('click', () => {\n    const uri = neonView.view.getCurrentPageURI();\n    neonView.getPageMEI(uri).then(mei => {\n      const data = 'data:application/mei+xml;base64,' + window.btoa(convertStaffToSb(mei));\n      document.getElementById('getmei').setAttribute('href', data);\n      document.getElementById('getmei').setAttribute('download', neonView.view.getPageName() + '.mei');\n    });\n  });\n}\n\n/**\n * Initialize the undo/redo panel\n */\nexport function initUndoRedoPanel (neonView: NeonView): void {\n  document.getElementById('undo').addEventListener('click', undoHandler);\n  document.body.addEventListener('keydown', (evt) => {\n    if (evt.key === 'z' && (evt.ctrlKey || evt.metaKey)) {\n      undoHandler();\n    }\n  });\n\n  document.getElementById('redo').addEventListener('click', redoHandler);\n  document.body.addEventListener('keydown', (evt) => {\n    if ((evt.key === 'Z' || (evt.key === 'z' && evt.shiftKey)) && (evt.ctrlKey || evt.metaKey)) {\n      redoHandler();\n    }\n  });\n\n  /**\n   * Tries to undo an action and update the page if it succeeds.\n   */\n  function undoHandler (): void {\n    neonView.undo().then((result: boolean) => {\n      if (result) {\n        neonView.updateForCurrentPage();\n      } else {\n        console.error('Failed to undo action');\n      }\n    });\n  }\n\n  /**\n   * Tries to redo an action and update the page if it succeeds.\n   */\n  function redoHandler (): void {\n    neonView.redo().then((result: boolean) => {\n      if (result) {\n        neonView.updateForCurrentPage();\n      } else {\n        console.error('Failed to redo action');\n      }\n    });\n  }\n}\n","/**\n * Contents of navbar menu after switching to edit mode.\n */\nexport const navbarDropdownMenu: HTMLDivElement = document.createElement('div');\nnavbarDropdownMenu.classList.add('navbar-item', 'has-dropdown', 'is-hoverable');\nconst fileLink = document.createElement('a');\nfileLink.classList.add('navbar-link');\nfileLink.textContent = 'File';\nconst navbarContents = document.createElement('div');\nnavbarContents.classList.add('navbar-dropdown');\nnavbarContents.id = 'navbar-dropdown-options';\nconst contents = [['save', 'Save'], ['export', 'Save and Export to File'],\n  ['getmei', 'Download MEI'], ['revert', 'Revert']];\ncontents.forEach(content => {\n  const item = document.createElement('a');\n  item.id = content[0];\n  item.classList.add('navbar-item');\n  item.textContent = content[1];\n  navbarContents.appendChild(item);\n});\nnavbarDropdownMenu.appendChild(fileLink);\nnavbarDropdownMenu.appendChild(navbarContents);\n\n/**\n * Finalize option in the navbar for rodan\n */\nexport const navbarFinalize =\n    '<a id=\\'finalize\\' class=\\'navbar-item\\'> Finalize MEI </a>';\n\n/**\n * Contents of the undo/redo panel with buttons\n */\nexport const undoRedoPanel: string =\n    '<div class=\\'field has-addons buttons\\' style=\\'overflow-x: auto;\\'>' +\n    '<p class=\\'control\\'>' +\n    '<button class=\\'button\\' id=\\'undo\\'>Undo</button>' +\n    '<button class=\\'button\\' id=\\'redo\\'>Redo</button></p></a></div>';\n","async function setBody (): Promise<void> {\n  const response = await fetch(__ASSET_PREFIX__ + 'assets/template.html');\n  document.body.innerHTML = await response.text();\n  (document.getElementById('home-link') as HTMLAnchorElement)\n    .href = __LINK_LOCATION__;\n  document.getElementById('neon-version').textContent = __NEON_VERSION__;\n}\n\nexport { setBody as default };\n","import * as d3 from 'd3';\n\nexport class ViewBox {\n  a: number;\n  b: number;\n  c: number;\n  d: number;\n\n  imageHeight: number;\n  imageWidth: number;\n\n  constructor (imageWidth: number, imageHeight: number) {\n    this.a = 0;\n    this.b = 0;\n    this.c = imageWidth;\n    this.d = imageHeight;\n\n    this.imageWidth = imageWidth;\n    this.imageHeight = imageHeight;\n  }\n\n  set (w: number, x: number, y: number, z: number): void {\n    this.a = w;\n    this.b = x;\n    this.c = y;\n    this.d = z;\n  }\n\n  get (): string {\n    return this.a.toString() + ' ' + this.b.toString() + ' ' +\n      this.c + ' ' + this.d;\n  }\n\n  zoomTo (k: number): void {\n    const zoomHeight = (this.imageHeight / k);\n    const zoomWidth = (this.imageWidth / k);\n\n    this.c = zoomWidth;\n    this.d = zoomHeight;\n  }\n\n  getZoom (): number {\n    return this.imageWidth / this.c;\n  }\n\n  translate (xDiff: number, yDiff: number): void {\n    this.a += xDiff;\n    this.b += yDiff;\n  }\n}\n\nexport class ZoomHandler {\n  dragCoordinates: DOMPoint;\n  viewBox: ViewBox;\n  matrix: DOMMatrix;\n\n  /**\n   * reset the zoom and pan of the SVG viewbox\n   */\n  resetZoomAndPan (): void {\n    const bgimg = document.getElementById('bgimg') as HTMLImageElement;\n    this.viewBox = new ViewBox(parseInt(bgimg.getAttribute('width')), parseInt(bgimg.getAttribute('height')));\n\n    this.updateViewBox();\n  }\n\n  /**\n   * Zoom to a certain factor.\n   */\n  zoomTo (k: number): void {\n    this.getViewBox();\n    this.viewBox.zoomTo(k);\n    this.updateViewBox();\n  }\n\n  /**\n   * Translate the view box by relative coordinates.\n   */\n  translate (xDiff: number, yDiff: number): void {\n    this.getViewBox();\n    this.viewBox.translate(xDiff, yDiff);\n    this.updateViewBox();\n  }\n\n  /**\n   * Restore the view box to its position before the editor action.\n   */\n  restoreTransformation (): void {\n    if (this.viewBox === undefined) {\n      this.resetZoomAndPan();\n    } else {\n      this.updateViewBox();\n    }\n  }\n\n  /**\n   * Get the view box from the SVG in the page.\n   */\n  getViewBox (): void {\n    if (this.viewBox === undefined) {\n      const bgimg = document.getElementById('bgimg') as HTMLImageElement;\n      this.viewBox = new ViewBox(parseInt(bgimg.getAttribute('width')), parseInt(bgimg.getAttribute('height')));\n    }\n    const rawViewBox = document.getElementById('svg_group')\n      .getAttribute('viewBox')\n      .split(' ');\n    this.viewBox.set(\n      parseInt(rawViewBox[0]),\n      parseInt(rawViewBox[1]),\n      parseInt(rawViewBox[2]),\n      parseInt(rawViewBox[3])\n    );\n  }\n\n  /**\n   * Update the viewBox attribute of svg_group\n   */\n  updateViewBox (): void {\n    document.getElementById('svg_group').setAttribute('viewBox', this.viewBox.get());\n  }\n\n  startDrag (): void {\n    const group = document.getElementById('svg_group') as unknown as SVGSVGElement;\n    this.dragCoordinates = group.createSVGPoint();\n    if (d3.event.type === 'touchstart') {\n      // If drag is triggered by a touch event\n      this.dragCoordinates.x = d3.event.touches[0].screenX;\n      this.dragCoordinates.y = d3.event.touches[0].screenY;\n    } else {\n      // Otherwise triggered by a mouse click\n      this.dragCoordinates.x = d3.event.x;\n      this.dragCoordinates.y = d3.event.y;\n    }\n\n    this.matrix = group.getScreenCTM().inverse();\n  }\n\n  dragging (): void {\n    const group = document.getElementById('svg_group') as unknown as SVGSVGElement;\n    const newCoordinates = group.createSVGPoint();\n    // Same kind of checking as in startDrag\n    if (d3.event.type === 'touchmove') {\n      newCoordinates.x = d3.event.touches[0].screenX;\n      newCoordinates.y = d3.event.touches[0].screenY;\n    } else if (d3.event.type === 'wheel' && d3.event.shiftKey === false) {\n      if (this.matrix === undefined) {\n        this.matrix = group.getScreenCTM().inverse();\n      }\n      if (this.dragCoordinates === undefined) {\n        this.dragCoordinates = group.createSVGPoint();\n      }\n      this.dragCoordinates.x = d3.event.x;\n      this.dragCoordinates.y = d3.event.y;\n      newCoordinates.x = this.dragCoordinates.x - d3.event.deltaX;\n      newCoordinates.y = this.dragCoordinates.y - d3.event.deltaY;\n      d3.event.preventDefault();\n    } else {\n      newCoordinates.x = d3.event.x;\n      newCoordinates.y = d3.event.y;\n    }\n    const newTransform = newCoordinates.matrixTransform(this.matrix);\n    const dragTransform = this.dragCoordinates.matrixTransform(this.matrix);\n    this.translate(-newTransform.x + dragTransform.x, -newTransform.y + dragTransform.y);\n    this.dragCoordinates = newCoordinates;\n  }\n\n  scrollZoom (): void {\n    if (d3.event.type !== 'wheel') return;\n    if (!d3.event.shiftKey) {\n      this.dragging();\n      return;\n    }\n    const slider = document.getElementById('zoomSlider') as HTMLInputElement;\n    this.getViewBox();\n    const k = this.viewBox.getZoom();\n    let newK = k - d3.event.deltaX / 100;\n    if (newK < parseInt(slider.getAttribute('min')) / 100) newK = 0.25;\n    if (newK > parseInt(slider.getAttribute('max')) / 100) newK = 4;\n    this.zoomTo(newK);\n\n    // Update zoom slider\n    slider.value = (newK * 100).toString();\n    (document.getElementById('zoomOutput') as HTMLOutputElement).value = String(Math.round(newK * 100));\n  }\n}\n\nexport { ZoomHandler as default };\n","/** @module Warnings */\n\n/**\n * Warn when grouped neume components form an unrecognized neume.\n */\nexport function groupingNotRecognized () {\n  if (!(window.confirm('Neon does not recognize this neume grouping. Would you like to create a compound neume?'))) {\n    document.getElementById('undo').click();\n  }\n}\n","import * as Notification from '../utils/Notification';\nimport NeonView from '../NeonView';\nimport { EditorAction } from '../Types';\nimport { selectAll } from '../utils/SelectTools';\nimport DragHandler from '../utils/DragHandler';\n\n/** Handle splitting a staff into two staves through Verovio. */\nexport class SplitHandler {\n  readonly neonView: NeonView;\n  readonly staff: SVGGElement;\n\n  constructor (neonView: NeonView, staff: SVGGElement) {\n    this.neonView = neonView;\n    this.staff = staff;\n  }\n\n  startSplit (): void {\n    this.splitDisable();\n\n    document.body.addEventListener('click', this.handler, { capture: true });\n\n    // Handle keypresses\n    document.body.addEventListener('keydown', this.keydownListener);\n    document.body.addEventListener('keyup', this.resetHandler);\n    document.body.addEventListener('click', this.clickawayHandler);\n\n    Notification.queueNotification('Click Where to Split');\n  }\n\n  splitDisable (): void {\n    document.body.removeEventListener('keydown', this.keydownListener);\n    document.body.removeEventListener('keyup', this.resetHandler);\n    document.body.removeEventListener('click', this.clickawayHandler);\n    document.body.removeEventListener('click', this.handler, { capture: true });\n  }\n\n  /** Handle input to split a staff. */\n  handler = ((evt: MouseEvent): void => {\n    const id = this.staff.id;\n\n    const container = this.staff.closest('.definition-scale') as SVGSVGElement;\n    const pt = container.createSVGPoint();\n    pt.x = evt.clientX;\n    pt.y = evt.clientY;\n\n    // Transform to SVG coordinate system.\n    const transformMatrix = (container.getElementsByClassName('system')[0] as SVGGElement)\n      .getScreenCTM().inverse();\n    const cursorPt = pt.matrixTransform(transformMatrix);\n    // Find staff point corresponds to if one exists\n    // TODO\n\n    const editorAction: EditorAction = {\n      'action': 'split',\n      'param': {\n        'elementId': id,\n        'x': cursorPt.x\n      }\n    };\n\n    this.neonView.edit(editorAction, this.neonView.view.getCurrentPageURI()).then(async (result) => {\n      if (result) {\n        await this.neonView.updateForCurrentPage(); \n        Notification.queueNotification('Split action successful');\n      }\n      let dragHandler = new DragHandler(this.neonView, '.staff');\n      this.splitDisable();\n      selectAll([document.querySelector('#' + id) as SVGGElement], this.neonView, dragHandler);\n      try {\n        document.getElementById('moreEdit').innerHTML = '';\n        document.getElementById('moreEdit').classList.add('is-invisible');\n      } catch (e) {}\n    });\n  }).bind(this);\n\n  /** Exits split on Escape press, disables on Shift. */\n  keydownListener = ((evt: KeyboardEvent): void => {\n    if (evt.key === 'Escape') {\n      this.splitDisable();\n    } else if (evt.key === 'Shift') {\n      document.body.removeEventListener('click', this.handler, { capture: true });\n    }\n  }).bind(this);\n\n  /** Exit split if user clicks off of active page. */\n  clickawayHandler = ((evt: MouseEvent): void => {\n    const target = evt.target as HTMLElement;\n    if (target.closest('.active-page') === null) {\n      this.splitDisable();\n      document.body.removeEventListener('click', this.handler, { capture: true });\n    }\n  }).bind(this);\n\n  /** Called to reapply the event listener if necessary. */\n  resetHandler = ((evt: KeyboardEvent): void => {\n    if (evt.key === 'Shift') {\n      document.body.addEventListener('click', this.handler, { capture: true });\n    }\n  }).bind(this);\n}\n"],"sourceRoot":""}